/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./Opa','./OpaPlugin','./PageObjectFactory','sap/ui/qunit/QUnitUtils','sap/ui/base/Object','./matchers/Matcher','./matchers/AggregationFilled','./matchers/PropertyStrictEquals','./matchers/Properties','./matchers/Ancestor','./matchers/AggregationContainsPropertyEqual','./everyPolyfill','sap/ui/thirdparty/URI'],function($,O,a,P,U,b,M,A,c){var p=new a(),f=null,F=null,o=null,d=null,e=null,g=false,u=false,h=null;var j=b.extend("sap.ui.test.Opa5",jQuery.extend({},O.prototype,{constructor:function(){O.apply(this,arguments);}}));function s(S,T){e=$("#OpaFrame");var i=jQuery.sap.getModulePath("sap.ui.test.OpaFrame",".css");jQuery.sap.includeStyleSheet(i);if(!e.length){e=$('<iframe id="OpaFrame" class="opaFrame" src="'+S+'"></iframe>');$("body").append(e);}if(e[0].contentDocument&&e[0].contentDocument.readyState==="complete"){l();}else{e.on("load",l);}return this.waitFor({check:function(){if(!g){return;}return m();},timeout:T||90,errorMessage:"unable to load the iframe with the url: "+S});}j.iStartMyAppInAFrame=s;j.prototype.iStartMyAppInAFrame=s;function t(){return this.waitFor({success:function(){v();g=false;u=false;}});}j.iTeardownMyAppFrame=t;j.prototype.iTeardownMyAppFrame=t;j.prototype.waitFor=function(i){i=$.extend({},O.config,i);var w=i.check,C=null,x,y=i.success,z,R;i.check=function(){if(!this._modifyControlType(i)){return false;}C=j.getPlugin().getMatchingControls(i);if((i.viewName||i.searchOpenDialogs)&&!i.id&&!C||(C&&C.length===0)){jQuery.sap.log.debug("found no controls in view: "+i.viewName+" with controlType "+i.sOriginalControlType,"","Opa");return false;}if(typeof i.id==="string"&&!C){jQuery.sap.log.debug("found no control with the id "+i.id,"","Opa");return false;}if(i.id instanceof RegExp&&!C.length){jQuery.sap.log.debug("found no control with the id regex"+i.id);return false;}if($.isArray(i.id)&&(!C||C.length!==i.id.length)){if(C&&C.length){jQuery.sap.log.debug("found not all controls with the ids "+i.id+" onlyFound the controls: "+C.map(function(D){return D.sId;}));}else{jQuery.sap.log.debug("found no control with the id  "+i.id);}return false;}if(i.sOriginalControlType&&!C.length){jQuery.sap.log.debug("found no controls with the type  "+i.sOriginalControlType,"","Opa");return false;}x=this._checkMatchers(i.matchers);var E;if(x&&x.length){if(!$.isArray(C)){E=1;z=[C];}else{z=C;}var B=[];z.forEach(function(D){var G=this._doesValueMatch(x,D);if(G){if(G===true){B.push(D);}else{B.push(G);}}},this);if(!B.length){jQuery.sap.log.debug("all results were filtered out by the matchers - skipping the check");return false;}if(E===1){R=B[0];}else{R=B;}}else{R=C;}if(w){return this._executeCheck(w,R);}return true;};if(y){i.success=function(){y.call(this,R);};}return O.prototype.waitFor.call(this,i);};j.getPlugin=function(){return o||p;};j.getJQuery=function(){return F;};j.getWindow=function(){return f;};j.getUtils=function(){return d;};j.getHashChanger=function(){return h;};j.extendConfig=O.extendConfig;j.resetConfig=function(){O.resetConfig();O.extendConfig({viewNamespace:"",arrangements:new j(),actions:new j(),assertions:new j(),visible:true,_stackDropCount:1});};j.emptyQueue=O.emptyQueue;j.matchers={};j.matchers.Matcher=M;j.matchers.AggregationFilled=A;j.matchers.PropertyStrictEquals=c;j.createPageObjects=function(i){return P.create(i,j);};j.prototype._doesValueMatch=function(w,V){var x=V;var I=true;jQuery.each(w,function(i,y){var z=y.isMatching(V);if(z){if(z!==true){V=z;}}else{I=false;return false;}});if(I){return(x===V)?true:V;}else{return false;}};j.prototype._checkMatchers=function(i){var w=[];if($.isArray(i)){w=i;}else if(i){w=[i];}w=w.map(function(x){if(x instanceof j.matchers.Matcher){return x;}else if(typeof x=="function"){return{isMatching:x};}jQuery.sap.log.error("Matchers where defined, but they where neither an array nor a single matcher: "+i);return undefined;}).filter(function(x){return!!x;});return w;};j.prototype._modifyControlType=function(i){var C=i.controlType;if(typeof C!=="string"){return true;}i.sOriginalControlType=C;var w=f||window;var x=w.jQuery.sap.getObject(C);if(!x){jQuery.sap.log.debug("The control type "+C+" is undefined. Skipped check and will wait until it is required",this);return false;}if(x._sapUiLazyLoader){jQuery.sap.log.debug("The control type "+C+" is currently a lazy stub. Skipped check and will wait until it is invoked",this);return false;}i.controlType=x;return true;};j.prototype._executeCheck=function(C,i){jQuery.sap.log.debug("Opa is executing the check: "+C);var R=C.call(this,i);jQuery.sap.log.debug("Opa check was "+R);return R;};j.resetConfig();function k(){F=f.jQuery;r("sap.ui.test");F.sap.require("sap.ui.test.OpaPlugin");o=new f.sap.ui.test.OpaPlugin();r("sap.ui.qunit.QUnitUtils");f.jQuery.sap.require("sap.ui.qunit.QUnitUtils");d=f.sap.ui.qunit.QUnitUtils;f.jQuery.sap.require("sap.ui.core.routing.HashChanger");q(f.sap.ui.core.routing.HashChanger.getInstance());}function r(i){var w=jQuery.sap.getModulePath(i);var x=new URI(w).absoluteTo(document.baseURI).search("").toString();F.sap.registerModulePath(i,x);}function l(){f=e[0].contentWindow;var i=f.onerror;f.onerror=function(E,w,L){if(i){i.apply(this,arguments);}throw"OpaFrame error message: "+E+" url: "+w+" line: "+L;};g=true;m();}function m(){if(u){return true;}if(f&&f.sap&&f.sap.ui&&f.sap.ui.getCore){u=true;n();}return false;}function n(){k();f.jQuery.sap.require("sap.ui.core.routing.History");var H=f.sap.ui.core.routing.History.getInstance(),i=f.history.go,w=f.sap.ui.core.routing.HashChanger.replaceHashChanger;f.sap.ui.core.routing.HashChanger.replaceHashChanger=function(N){q(N);w.apply(this,arguments);};h.init();function x(){var C=H.aHistory[H.iHistoryPosition];h._sCurrentHash=H.getPreviousHash();h.fireEvent("hashChanged",{newHash:H.getPreviousHash(),oldHash:C});}function y(){var N=H.aHistory[H.iHistoryPosition+1],C=H.aHistory[H.iHistoryPosition];if(N===undefined){jQuery.sap.log.info("Could not navigate forwards, there is no history entry in the forwards direction",this);return;}h._sCurrentHash=N;h.fireEvent("hashChanged",{newHash:N,oldHash:C});}f.history.back=x;f.history.forward=y;f.history.go=function(S){if(S===-1){x();return;}else if(S===1){y();return;}jQuery.sap.log.warning("Using history.go with a number greater than 1 is not supported by OPA5",this);return i.apply(this,arguments);};}function q(N){h=N;var i=f.hasher,w=h.setHash;h.replaceHash=function(H){var x=h.getHash();this.fireEvent("hashReplaced",{sHash:H});this._sCurrentHash=H;h.fireEvent("hashChanged",{newHash:H,oldHash:x});};h.setHash=function(H){this._sCurrentHash=H;w.apply(this,arguments);};h.getHash=function(){if(this._sCurrentHash===undefined){return i.getHash();}return this._sCurrentHash;};}function v(){e.remove();f=null;F=null;o=null;d=null;h=null;}$(function(){e=$("#OpaFrame");e.on("load",l);$("body").height("100%");$("html").height("100%");});return j;},true);
