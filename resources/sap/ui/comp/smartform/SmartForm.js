/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/ui/core/Control','sap/ui/fl/registry/ChangeRegistry','sap/ui/fl/registry/SimpleChanges','sap/ui/layout/form/Form','sap/ui/fl/Utils','sap/ui/fl/registry/Settings','sap/m/Label','sap/m/Button','sap/m/ButtonType','sap/m/Panel','sap/m/Toolbar','sap/m/ToolbarSpacer','sap/m/ToolbarSeparator'],function(q,l,C,a,S,F,U,b,L,B,c,P,T,d,e){"use strict";var f=C.extend("sap.ui.comp.smartform.SmartForm",{metadata:{library:"sap.ui.comp",properties:{title:{type:"string",group:"Misc",defaultValue:null},useHorizontalLayout:{type:"boolean",group:"Misc",defaultValue:null},checkButton:{type:"boolean",group:"Misc",defaultValue:false},entityType:{type:"string",group:"Misc",defaultValue:null},expandable:{type:"boolean",group:"Misc",defaultValue:false},expanded:{type:"boolean",group:"Misc",defaultValue:null},editTogglable:{type:"boolean",group:"Misc",defaultValue:false},editable:{type:"boolean",group:"Misc",defaultValue:false},ignoredFields:{type:"string",group:"Misc",defaultValue:null}},defaultAggregation:"groups",aggregations:{groups:{type:"sap.ui.comp.smartform.Group",multiple:true,singularName:"group"},content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},layout:{type:"sap.ui.comp.smartform.Layout",multiple:false},semanticObjectController:{type:"sap.ui.comp.navpopover.SemanticObjectController",multiple:false},customToolbar:{type:"sap.m.Toolbar",multiple:false},toolbar:{type:"sap.m.Toolbar",multiple:false,visibility:"hidden"}},events:{editToggled:{},checked:{}}}});f.prototype.init=function(){if(!f._bHasRegisteredToFlexibilityServices){var o=a.getInstance();o.registerControlForSimpleChange(this.getMetadata().getElementName(),S.removeGroup);o.registerControlForSimpleChange(this.getMetadata().getElementName(),S.addGroup);o.registerControlForSimpleChange(this.getMetadata().getElementName(),S.moveGroups);o.registerControlForSimpleChange(this.getMetadata().getElementName(),S.renameField);f._bHasRegisteredToFlexibilityServices=true;}this._sEditToggleId="";this._oForm=null;this._oPanel=null;this._oTitle=new L(this.getId()+"-title-sfmain").addStyleClass("title");this._bUpdateToolbar=true;this._sResizeListenerId="";this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");};f._bHasRegisteredToFlexibilityServices=false;f.prototype.onBeforeRendering=function(){var g=null;var o=null;var h=[];var G=[];var t=null;var i=0;var j=this;if(this._bUpdateToolbar){if(this._oCustomToolbar){this._cleanToolbar();this._addHeaderToToolbar();this._addSeparatorToToolbar();this._addEditTogglableToToolbar();this._addCheckToToolbar();this._addChangeModeToToolbar();this._removeSeparatorFromToolbar();}else{this._createToolbar();this._oToolbar.addStyleClass("titleBar");this._addHeaderToToolbar();this._addEditTogglableToToolbar();this._addCheckToToolbar();this._addChangeModeToToolbar();if(this._oToolbar.getContent().length===1&&!this.getExpandable()){this._oToolbar.destroyContent();this._oToolbar.destroy();this._oToolbar=null;this.setAggregation("toolbar",null);}}this._bUpdateToolbar=false;}var k=null;if(!this._oForm){if(this.mProperties["useHorizontalLayout"]){k=new sap.ui.layout.form.ResponsiveLayout();}else{k=this._getLayout();}o=new F({"editable":this.getEditable(),"layout":[k]});this._oForm=o;}G=this.getAggregation("groups");if(G){for(i;i<G.length;i++){g=G[i];this._oForm.insertFormContainer(g.getFormContainer(),i);}}h=this.getCustomData();if(h.length>0){G.forEach(function(g){h.forEach(function(m){g.addCustomData(m.clone());});});}G.forEach(function(g){g.setEditMode(j.mProperties["editable"]);});t=this._oCustomToolbar||this._oToolbar;if(this.mProperties["expandable"]){this._oPanel=new P({"expanded":this.mProperties["expanded"],"expandable":true,"headerText":this.getTitle(),"headerToolbar":t});this._oPanel.attachExpand(function(E){j.setProperty("expanded",E.getParameters()["expand"],false);});this._oPanel.addContent(this._oForm);this.setAggregation("content",this._oPanel);}else{if(t){t.addStyleClass("titleBar");}this.setAggregation("content",this._oForm);}};f.prototype.onAfterRendering=function(){var i=0,I,g;var s="",v="";var t=this;if(this._sResizeListenerId){sap.ui.core.ResizeHandler.deregister(this._sResizeListenerId);}this._sResizeListenerId=sap.ui.core.ResizeHandler.register(this._oForm.getDomRef(),function(o){t.onAfterRendering();});var E=window.document.getElementsByClassName("sapUiRFLContainer");for(i=0;i<E.length;i++){if(E[i].id.indexOf("element")!=-1&&E[i].id.indexOf("cont")!=-1){I=E[i].style.cssText.indexOf("width");g=E[i].style.cssText.indexOf("%",I);if((g-I)>10){I=E[i].style.cssText.indexOf("width",I+1);g=E[i].style.cssText.indexOf("%",I);}if((g-I)<=10){v=E[i].style.cssText.substring(I+6,g);if(parseInt(v,10)>25){s=E[i].style.cssText.substring(0,I-1);s=s+E[i].style.cssText.substring(g+2);E[i].style.cssText=s;}}}}};f.prototype._getLayout=function(){var o=this.getAggregation("layout");var g=null;var G=this.getGroups();if(o){g=new sap.ui.layout.form.ResponsiveGridLayout({"labelSpanL":o.mProperties["labelSpanL"]?o.mProperties["labelSpanL"]:4,"labelSpanM":o.mProperties["labelSpanM"]?o.mProperties["labelSpanM"]:4,"emptySpanL":o.mProperties["emptySpanL"]?o.mProperties["emptySpanL"]:0,"emptySpanM":o.mProperties["emptySpanM"]?o.mProperties["emptySpanM"]:0,"columnsL":o.mProperties["columnsL"]?o.mProperties["columnsL"]:3,"columnsM":o.mProperties["columnsM"]?o.mProperties["columnsM"]:2,"breakpointL":o.mProperties["breakpointL"]?o.mProperties["breakpointL"]:1024,"breakpointM":o.mProperties["breakpointL"]?o.mProperties["breakpointL"]:600});}else{g=new sap.ui.layout.form.ResponsiveGridLayout({"labelSpanL":4,"labelSpanM":4,"emptySpanL":0,"emptySpanM":0,"columnsL":3,"columnsM":2,"breakpointL":1024,"breakpointM":600});}if(G&&G.length<g.getColumnsL()){g.setColumnsL(G.length);}return g;};f.prototype._createToolbar=function(){if(this._oToolbar){var o=this._oToolbar.removeContent(this.getId()+"-button-sfmain-editToggle");if(o){o.destroy();}o=this._oToolbar.removeContent(this.getId()+"-button-sfmain-check");if(o){o.destroy();}o=this._oToolbar.removeContent(this.getId()+"-AdaptationButton");if(o){o.destroy();}this._oToolbar.removeContent(this.getId()+"-title-sfmain");}this._oToolbar=new T({"height":"3rem"});this.setAggregation("toolbar",this._oToolbar);};f.prototype._cleanToolbar=function(){var o=this._oCustomToolbar.removeContent(this.getId()+"-button-sfmain-editToggle");if(o){o.destroy();}o=this._oCustomToolbar.removeContent(this.getId()+"-button-sfmain-check");if(o){o.destroy();}o=this._oCustomToolbar.removeContent(this.getId()+"-AdaptationButton");if(o){o.destroy();}this._oCustomToolbar.removeContent(this.getId()+"-title-sfmain");};f.prototype._addHeaderToToolbar=function(){var t=this._oCustomToolbar||this._oToolbar;var g=[];var i=0;var o=null;if(this.getProperty("title")||this.mBindingInfos['title']){t.insertContent(this._oTitle,0);}if(this._oToolbar){t.insertContent(new d(),1);}else{g=t.getContent();for(i;i<g.length;i++){if(g[i].getMetadata().getName()==="sap.m.ToolbarSpacer"){o=g[i];}}if(!o){t.addContent(new d());}}};f.prototype._addEditTogglableToToolbar=function(){var t=this._oCustomToolbar||this._oToolbar;var g=this;var o=null;var i=this.getProperty("editable")?"sap-icon://display":"sap-icon://edit";if(this.getEditTogglable()){o=new B(this.getId()+"-button-sfmain-editToggle",{type:c.Default,icon:i,press:function(){f.prototype._toggleEditMode(g);}});this._sEditToggleId=o.getId();t.addContent(o);}};f.prototype._toggleEditMode=function(s){var t=s._oCustomToolbar||s._oToolbar;s.setEditable(!s.mProperties["editable"]);s.fireEditToggled({editable:s.mProperties["editable"]});var i=s.getProperty("editable")?"sap-icon://display":"sap-icon://edit";t.getContent().forEach(function(I){if(I.sId===s._sEditToggleId){I.setIcon(i);}});var g=s.getGroups();g.forEach(function(G){G.setEditMode(s.mProperties["editable"]);});};f.prototype._addChangeModeToToolbar=function(){var t=this;var s=U.getComponentClassName(this);var g=b.getInstance(s).then(function(o){var h=t._oCustomToolbar||t._oToolbar;if(o.isFlexChangeMode()&&o.isKeyUser()&&U.checkControlId(t)){if(!h){t._createToolbar();t._oToolbar.addStyleClass("titleBar");t._addHeaderToToolbar();h=t._oToolbar;t.invalidate();}h.addContent(new sap.m.Button(t.getId()+"-AdaptationButton",{type:sap.m.ButtonType.Default,icon:"sap-icon://action-settings",press:function(){q.sap.require('sap.ui.comp.smartform.flexibility.FormP13nHandler');var i=new sap.ui.comp.smartform.flexibility.FormP13nHandler();i.init(t);i.show();}}));}},function(E){});return g||Promise.resolve();};f.prototype._addCheckToToolbar=function(){if(!this.getEditable()){return;}var t=this._oCustomToolbar||this._oToolbar;var g=this;if(this.getCheckButton()){t.addContent(new sap.m.Button(this.getId()+"-button-sfmain-check",{type:sap.m.ButtonType.Default,text:this._oRb.getText("SMART_FORM_CHECK"),press:function(){var E=[];E=g.check();g.fireChecked({erroneousFields:E});}}));}};f.prototype.check=function(){var E=this._checkClientError();return E;};f.prototype._checkClientError=function(){var g=this.getSmartFields();var E=[];g.forEach(function(o){if(o.checkClientError()){E.push(o.getId());}});return E;};f.prototype._addSeparatorToToolbar=function(){var t=this._oCustomToolbar||this._oToolbar;t.addContent(new e());};f.prototype._removeSeparatorFromToolbar=function(){var t=this._oCustomToolbar||this._oToolbar;var o=t.getContent();var g=null;var r=[];var i=0;g=o[o.length-1];if(g.getMetadata().getName()==="sap.m.ToolbarSeparator"){t.removeContent(g);}g=null;for(i;i<o.length;i++){if(o[i].getMetadata().getName()==="sap.m.ToolbarSeparator"&&g.getMetadata().getName()!="sap.m.Button"){r.push(o[i]);}g=o[i];}for(i=0;i<r.length;i++){t.removeContent(r[i]);}};f.prototype.setEditable=function(E){C.prototype.setProperty.apply(this,["editable",E]);if(this._oForm){this._oForm.setEditable(E);}this._bUpdateToolbar=true;return this;};f.prototype.setEditTogglable=function(t){C.prototype.setProperty.apply(this,["editTogglable",t]);this._bUpdateToolbar=true;return this;};f.prototype.setTitle=function(t){C.prototype.setProperty.apply(this,["title",t]);this._oTitle.setText(t);return this;};f.prototype.getVisibleProperties=function(){var p=[];var g=this.getGroups();g.forEach(function(G){var h=G.getGroupElements();h.forEach(function(o){var i=o.getFormElement().getFields();i.forEach(function(j){if(j.getVisible()){var s=j.getBindingPath("value");if(s){p.push(s);}}});});});return p;};f.prototype.setCustomToolbar=function(o){this._oCustomToolbar=o;this._bUpdateToolbar=true;return this;};f.prototype.getCustomToolbar=function(){return this._oCustomToolbar;};f.prototype.insertGroup=function(g,i){var h=[];var o=g.getFormContainer();if(o){h=o.getFormElements();}var D={"expanded":o?o.getExpanded():true,"expandable":g.getExpandable(),"visible":g.getVisible(),"formElements":h,"title":g.getLabel()};g.setFormContainer(new sap.ui.layout.form.FormContainer(D));this.insertAggregation("groups",g,i);return this;};f.prototype.removeAllGroups=function(){if(this._oForm){this._oForm.removeAllFormContainers();}return this.removeAllAggregation("groups");};f.prototype.getSmartFields=function(){var s=[];var g=this.getGroups();g.forEach(function(G){var h=G.getGroupElements();h.forEach(function(o){var i=o.getFormElement().getFields();i.forEach(function(j){if(j.getMetadata().getName()==="sap.ui.comp.smartfield.SmartField"){s.push(j);}});});});return s;};f.prototype.exit=function(){if(this._oForm){this._oForm.destroy();}if(this._oPanel){this._oPanel.destroy();}if(this._oTitle){this._oTitle.destroy();}this._sEditToggleId="";this._oForm=null;this._oPanel=null;this._oTitle=null;this._bUpdateToolbar=true;this._sResizeListenerId="";this._oRb=null;};return f;},true);
