/*
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/m/CheckBox","sap/m/ComboBox","sap/m/DatePicker","sap/m/FlexItemData","sap/m/HBox","sap/m/Input","sap/m/Text","sap/ui/comp/navpopover/SmartLink","sap/ui/comp/smartfield/ControlFactoryBase","sap/ui/comp/smartfield/FieldControl","sap/ui/comp/smartfield/ODataHelper","sap/ui/comp/smartfield/ODataTypes"],function(q,C,a,D,F,H,I,T,S,b,c,O,d){"use strict";var f=b.extend("sap.ui.comp.smartfield.ODataControlFactory",{constructor:function(m,p,M){b.apply(this,[m,p]);this.sName="ODataControlFactory";this._oMetaData={annotations:{}};if(m){this._oHelper=new O(m);}this._oFieldControl=new c(p);this._oTypes=new d(p);this._init(M);this._bInitialized=false;this._bMetaData=!m;}});f.prototype._init=function(m){var t,p,e=this;this._oMetaData.model=m.model;this._oMetaData.path=m.path;this._oMetaData.namespace=m.namespace||this._oHelper.getNameSpace();this._oMetaData.entitySet=m.entitySetObject||this._oHelper.getEntitySet(m.entitySet.replace(this._oMetaData.namespace+".",""));t=m.entityType||this._oHelper.getEntityType(this._oMetaData.entitySet.entityType.replace(this._oMetaData.namespace+".",""));this._oMetaData.entityType=t.type;this._oMetaData.typecount=t.count;if(this._oHelper){if(!this._oHelper.checkNavigationProperty(this._oMetaData)){this._oMetaData.property=this._oHelper.getProperty(m.path,this._oMetaData.namespace,t.count);}if(this._oMetaData.navigationPath){p=this._oMetaData.path.replace(this._oMetaData.navigationPath,"");}else{p=e._oMetaData.path;}this._oMetaData.annotations.text=this._oHelper.getTextProperty(this._oMetaData.property,p,this._oMetaData.namespace,this._oMetaData.typecount);this._oMetaData.annotations.uom=this._oHelper.getUnitOfMeasure(this._oMetaData.property,p,this._oMetaData.namespace,t.count);this._oMetaData.annotations.valuelist=this._oHelper.getValueListAnnotation(this._oMetaData.namespace,this._oMetaData.entityType,this._oMetaData.property,this._oMetaData.property.typePath);this._oMetaData.annotations.lineitem=this._oHelper.oAnalyzer.getLineItemAnnotation(this._oMetaData.entitySet.entityType);this._oMetaData.annotations.semantic=this._oHelper.oAnalyzer.getSemanticObjectAnnotation(this._oMetaData.namespace+"."+this._oMetaData.entityType.name+"/"+this._oMetaData.property.property.name);this._oHelper.getUOMValueListAnnotation(this._oMetaData);this._oHelper.geValueListEntitySet(this._oMetaData);}else{this._oMetaData.modelObject=m.modelObject;this._oMetaData.property=m.property;this._oMetaData.annotations.text=m.annotations.text;this._oMetaData.annotations.uom=m.annotations.uom;this._oMetaData.annotations.valuelist=m.annotations.valuelist;this._oMetaData.annotations.lineitem=m.annotations.lineitem;this._oMetaData.annotations.semantic=m.annotations.semantic;this._oMetaData.annotations.valuelistuom=m.annotations.valuelistuom;this._oMetaData.annotations.valuelistentityset=m.annotations.valuelistentityset;}};f.prototype._createEdmDisplay=function(){var A,o,n={width:true,textAlign:true};if(this._checkCheckBox()){return this._createCheckBox();}A=this.createAttributes(null,this._oMetaData.property,n);if(this._checkDatePicker()){o=this.getFormatSettings("dateFormatSettings");A.text={model:this._oMetaData.model,path:this._oMetaData.path,type:this._oTypes.getType(this._oMetaData.property,o,{displayFormat:"Date"})};}else{A.text={model:this._oMetaData.model,path:this._getEdmDisplayPath(),type:this._oTypes.getType(this._oMetaData.property)};}return{control:new T(A),onCreate:"_onCreate",params:{noValidations:true}};};f.prototype._getEdmDisplayPath=function(){if(this._oMetaData.annotations.text){return this._oMetaData.path.replace(this._oMetaData.property.property.name,this._oMetaData.annotations.text.property.name);}return this._oMetaData.path;};f.prototype._createEdmString=function(){var n,N,A,o,e,m={width:true,textAlign:true,placeholder:true,name:true};o=this._checkComboBox("input");if(o.combobox){return this._createComboBox({annotation:o.annotation,noDialog:true,noTypeAhead:true});}if(this._checkCheckBox()){return this._createCheckBox();}n=!this._oParent.getShowValueHelp();N=!this._oParent.getShowSuggestion();A=this.createAttributes("value",this._oMetaData.property,m);e=new I(A);this._handleEventingForEdmString(e);return{control:e,onCreate:"_onCreate",params:{valuehelp:{annotation:o.annotation,noDialog:n,noTypeAhead:N,aggregation:"suggestionRows"},getValue:"getValue",type:{type:A.value.type,property:this._oMetaData.property}}};};f.prototype._checkConfig=function(t){var o=this._oParent.getConfiguration();if(o&&o.getControlType()===t){return true;}return false;};f.prototype._handleEventingForEdmString=function(o){var u,t=this,g=false,v=false,h;var k=false;if(o){u=this._oTypes.isDisplayFormatUpperCase(this._oMetaData.property);h=u?false:true;o.attachBrowserEvent("focusout",function(){if(v){o._lastValue="";g=true;}else{if(u){g=false;}else{g=(k)?false:true;}}}).attachBrowserEvent("keydown",function(e){if(e.which===13){h=true;k=true;}}).attachBrowserEvent("keyup",function(e){var V=o.getValue();k=false;if(e.which===13){v=false;if(h){try{t._oParent.fireChange({value:V,newValue:V});}catch(i){q.sap.log.warning(i);}}}else if(u){o.setValue(V.toUpperCase());v=true;}h=false;}).attachChange(function(e){try{if(e.mParameters.validated||g){h=false;g=false;v=false;t._oParent.fireChange({value:e.mParameters.value,newValue:e.mParameters.value,validated:e.mParameters.validated});}else{h=true;}}catch(i){q.sap.log.warning(i);}});}};f.prototype._createComboBox=function(v){var A,t=this,n={width:true,textAlign:true,placeholder:true,name:true};A=this.createAttributes(null,this._oMetaData.property,n);A.selectionChange=function(p){var k,i;try{i=p.getParameter("selectedItem");if(i&&i.getKey){k=i.getKey();}t._oParent.fireChange({value:k,newValue:k});}catch(e){q.sap.log.warning(e);}};A.selectedKey={model:this._oMetaData.model,path:this._oMetaData.path,type:this._oTypes.getType(this._oMetaData.property)};if(A.width===""){A.width="100%";}return{control:new a(A),onCreate:"_onCreate",params:{valuehelp:{annotation:v.annotation,aggregation:"items",noDialog:v.noDialog,noTypeAhead:v.noTypeAhead},getValue:"getSelectedKey",type:{type:A.selectedKey.type,property:this._oMetaData.property}}};};f.prototype._createCheckBox=function(){var A=this.createAttributes("selected",null,{},{event:"select",parameter:"selected"});A.enabled=(this._oParent.getEditable()&&this._oParent.getEnabled());A.selected.type=this._oTypes.getAbapBoolean();return{control:new C(A),onCreate:"_onCreate",params:{getValue:"getSelected"}};};f.prototype._createEdmDateTime=function(){var A,o,n={width:true,textAlign:true,placeholder:true,name:true};A=this.createAttributes(null,this._oMetaData.property,n,{event:"change",parameter:"value"});o=this.getFormatSettings("dateFormatSettings");if(this._checkDatePicker()){A.value={path:this._oMetaData.path,type:this._oTypes.getType(this._oMetaData.property,o,{displayFormat:"Date"}),model:this._oMetaData.model};if(o&&o.style){A.displayFormat=o.style;}return{control:new D(A),onCreate:"_onCreate",params:{getValue:"getValue",type:{type:A.value.type,property:this._oMetaData.property}}};}A.value={path:this._oMetaData.path,model:this._oMetaData.model,type:this._oTypes.getType(this._oMetaData.property,o)};return{control:new I(A),onCreate:"_onCreate",params:{getValue:"getValue",type:{type:A.value.type,property:this._oMetaData.property}}};};f.prototype._checkDatePicker=function(){if(this._oMetaData.property.extensions["sap:display-format"]==="Date"){return true;}return this._checkConfig("datePicker");};f.prototype._createEdmDateTimeOffset=function(){var o,A,n={width:true,textAlign:true,placeholder:true,name:true};o=this.getFormatSettings("dateFormatSettings");A=this.createAttributes(null,this._oMetaData.property,n,{event:"change",parameter:"value"});A.value={model:this._oMetaData.model,path:this._oMetaData.path,type:this._oTypes.getType(this._oMetaData.property,o)};return{control:new I(A),onCreate:"_onCreate",params:{getValue:"getValue",type:{type:A.value.type,property:this._oMetaData.property}}};};f.prototype._createEdmNumeric=function(){var A,n={width:true,textAlign:true,placeholder:true,name:true};A=this.createAttributes(null,this._oMetaData.property,n,{event:"change",parameter:"value"});A.value={model:this._oMetaData.model,path:this._oMetaData.path,type:this._oTypes.getType(this._oMetaData.property)};return{control:new I(A),onCreate:"_onCreate",params:{getValue:"getValue",type:{type:A.value.type,property:this._oMetaData.property}}};};f.prototype._createEdmUOM=function(){var n,i,t,A,o,p,e=this,g=function(P){try{e._oParent.fireChange({value:P.mParameters.value,newValue:P.mParameters.value});}catch(h){q.sap.log.warning(h);}};A=this._createEdmUOMAttributes(g);o=this._oParent.getObjectBinding(this._oMetaData.model);this.addObjectBinding(A,o);i=new I(A);n=this._oParent.data("suppressUnit");if(n&&n==="true"){p={getValue:"getValue"};if(!this._oMetaData.annotations.uom||this._oMetaData.annotations.uom.semantics!=="currency-code"){p.type={type:A.value.type,property:this._oMetaData.property};}return{control:i,onCreate:"_onCreate",params:p};}A={value:{model:this._oMetaData.model,path:this._getUOMPath(this._oMetaData.path,this._oMetaData.property.property.name,this._oMetaData.annotations.uom),type:this._oTypes.getType(this._oMetaData.annotations.uom.property)},change:g,width:"5rem",textAlign:sap.ui.core.TextAlign.End};this.addObjectBinding(A,o);t=new I(A);this._handleEventingForEdmString(t);i.addStyleClass("smartFieldPaddingRight");i.setLayoutData(new F({growFactor:10}));t.setLayoutData(new F({shrinkFactor:0}));return{control:new H({justifyContent:sap.m.FlexJustifyContent.End,items:[i,t],fitContainer:true,width:this._oParent.getWidth()}),onCreate:"_onCreateUOM",params:{getValue:true,valuehelp:true,type:{type:A.value.type,property:this._oMetaData.annotations.uom}}};};f.prototype._createEdmUOMAttributes=function(e){var A={textAlign:sap.ui.core.TextAlign.End,placeholder:this.getAttribute("placeholder"),name:this.getAttribute("name"),change:e};if(this._oMetaData.annotations.uom&&this._oMetaData.annotations.uom.semantics==="currency-code"){A.value={parts:[{path:this._oMetaData.path},{path:this._getUOMPath(this._oMetaData.path,this._oMetaData.property.property.name,this._oMetaData.annotations.uom)}],model:this._oMetaData.model,type:this._oTypes.getCurrencyType(this._oMetaData.property)};}else{A.value={model:this._oMetaData.model,path:this._oMetaData.path,type:this._oTypes.getType(this._oMetaData.property)};}return A;};f.prototype._createEdmUOMDisplay=function(){var n,v,o,p,e,A;n=this._oParent.data("suppressUnit");if(n&&n==="true"){return this._createEdmDisplay();}p=this._getUOMPath(this._oMetaData.path,this._oMetaData.property.property.name,this._oMetaData.annotations.uom);A={text:{parts:[{path:this._oMetaData.path,type:this._oTypes.getType(this._oMetaData.property)},{path:p}],model:this._oMetaData.model,formatter:this._oTypes.getCurrencyDisplayFormatter(),useRawValues:true},textAlign:sap.ui.core.TextAlign.End};e=this._oParent.getObjectBinding(this._oMetaData.model);this.addObjectBinding(A,e);v=new T(A);A={text:{path:p},textAlign:sap.ui.core.TextAlign.End};this.addObjectBinding(A,e);o=new T(A);return{control:new H({justifyContent:sap.m.FlexJustifyContent.Left,items:[v,o],width:this._oParent.getWidth()})};};f.prototype._getUOMPath=function(p,P,u){var s=(u.text&&u.text.name)?u.text.name:u.unit;if(s){return p.replace(P,s);}return null;};f.prototype._createEdmSemantic=function(){var p,i=this._oParent.getBindingInfo("value");p=i.parts[0].path;var l=this._oMetaData.property.property.fieldLabel;if(this._oMetaData.annotations.lineitem&&this._oMetaData.annotations.lineitem.labels&&this._oMetaData.annotations.lineitem.labels[p]){l=this._oMetaData.annotations.lineitem.labels[p];}return{control:new S({semanticObject:this._oMetaData.annotations.semantic.semanticObject,semanticObjectLabel:l,fieldName:p,text:{path:p,model:this._oMetaData.model},width:this.getAttribute("width"),createControlCallback:q.proxy(function(){var o=this.createControl(true);if(o){return o.control;}return null;},this)}),onCreate:"_onCreate",params:{getValue:"getInnerControlValue"}};};f.prototype._createEdmBoolean=function(){var A,o;o=this._checkComboBox();if(o.combobox){return this._createComboBox({annotation:o.annotation,noDialog:true,noTypeAhead:true});}A=this.createAttributes("selected",this._oMetaData.property,{},{event:"select",parameter:"selected"});A.enabled=(this._oParent.getEditable()&&this._oParent.getEnabled());return{control:new C(A),onCreate:"_onCreate",params:{getValue:"getSelected"}};};f.prototype._checkComboBox=function(t){var A,r={};if(this._oMetaData.annotations.valuelist&&this._oMetaData.annotations.valuelist.primaryValueListAnnotation){r.annotation=this._oMetaData.annotations.valuelist;}if(!r.annotation){return r;}if(t&&this._checkConfig(t)){return r;}if(this._oHelper&&this._oMetaData.annotations.valuelistentityset){A=this._oHelper.getAttributes(this._oMetaData.annotations.valuelistentityset,"extensions",{"semantics":"http://www.sap.com/Protocols/SAPData"});}if(A&&A.semantics==="fixed-values"){r.combobox=true;}if(!r.combobox){r.annotation=this._oMetaData.annotations.valuelist;r.combobox=this._checkConfig("dropDownList");}return r;};f.prototype._checkCheckBox=function(){var B,m;if(this._oMetaData.property.property.type==="Edm.String"){B=this._oParent.getBindingInfo("value");m=this._oTypes.getMaxLength(this._oMetaData.property,B);if(m===1){if(this._checkConfig("checkBox")){return true;}}}return false;};f.prototype._getCreator=function(B){var m={"Edm.Decimal":"_createEdmNumeric","Edm.Double":"_createEdmNumeric","Edm.Float":"_createEdmNumeric","Edm.Single":"_createEdmNumeric","Edm.Int16":"_createEdmNumeric","Edm.Int32":"_createEdmNumeric","Edm.Int64":"_createEdmNumeric","Edm.Byte":"_createEdmNumeric","Edm.DateTimeOffset":"_createEdmDateTimeOffset","Edm.DateTime":"_createEdmDateTime","Edm.Boolean":"_createEdmBoolean","Edm.String":"_createEdmString"};if(this._oMetaData.annotations&&this._oMetaData.annotations.semantic&&!B){return"_createEdmSemantic";}if(!this._oParent.getEditable()||!this._oParent.getEnabled()){if(this._oMetaData.annotations&&this._oMetaData.annotations.uom){return"_createEdmUOMDisplay";}return(this._oMetaData.property.property.type==="Edm.Boolean")?"_createEdmBoolean":"_createEdmDisplay";}if(this._oMetaData.annotations&&this._oMetaData.annotations.uom){return"_createEdmUOM";}return m[this._oMetaData.property.property.type]||"_createEdmString";};f.prototype._onCreate=function(o,p){var g,e,v=true;if(p){if(p.noValidation){v=false;}if(p.valuehelp){this._getValueHelpDialogTitle(p.valuehelp);this.addValueHelp(o,this._oMetaData.property.property,p.valuehelp,this._oModel||this._oMetaData.modelObject);}if(p.getValue){g=p.getValue;p.getValue=function(){return o[g]();};}if(p.type){e=this._oFieldControl.getMandatoryCheck(p.type.property);if(e){p.type.type.oFieldControl=e;}}}if(v){this.addValidations(o,"setSimpleClientError");}};f.prototype._getValueHelpDialogTitle=function(v){var A,l;l=this._oParent.getTextLabel();if(l){v.dialogtitle=l;}else{if(this._oHelper){A=this._oHelper.getAttributes(this._oMetaData.property.property,"extensions",{"label":"http://www.sap.com/Protocols/SAPData"});}if(A&&A.label){v.dialogtitle=A.label;}else{v.dialogtitle=this._oMetaData.property.property.name;}}};f.prototype._onCreateUOM=function(o,p){var i,v,e,m,l;i=o.getItems();l=i.length;while(l--){if(l===0){m="setComplexClientErrorFirstOperand";}else{m="setComplexClientErrorSecondOperand";}this.addValidations(i[l],m);}if(p.valuehelp){v={annotation:this._oMetaData.annotations.valuelistuom,aggregation:"suggestionRows"};this._getValueHelpDialogTitle(v);this.addValueHelp(i[1],this._oMetaData.annotations.uom.property.property,v,this._oModel||this._oMetaData.modelObject);}if(p&&p.getValue){p.getValue=function(){return i[0].getValue();};}p.uom=function(){return i[1].getValue();};p.uomset=function(V){i[1].setValue(V);};if(p.type){e=this._oFieldControl.getMandatoryCheck(p.type.property.property);if(e){p.type.type.oFieldControl=e;}}};f.prototype.bind=function(){var t=this,n;if(this._oParent.data("configdata")){n={enabled:true};}else{n={enabled:true,visible:true,mandatory:true};}if(!this._bInitialized){this._bInitialized=true;if(this._bMetaData||this._oModel.oMetadata.bLoaded){this._bind(n);}else{this._oModel.getMetaModel().loaded().then(function(){t._bind(n);});}}};f.prototype._bind=function(B){var n,o,m,p;m=this._oFieldControl.getControlProperties(this._oMetaData,B);for(n in m){o=m[n];if(o){p=o.path();if(p.length>0){this._oParent.bindProperty(n,{parts:p,model:this._oMetaData.model,formatter:o.formatter});}else{this._oParent.bindProperty(n,{path:"",model:this._oMetaData.model,formatter:o.formatter});}}}this._oParent.fireInitialise();};f.prototype.getDataProperty=function(){return this._oMetaData.property;};f.prototype.destroy=function(){this._oFieldControl.destroy();this._oTypes.destroy();if(!this._bMetaData){this._oHelper.destroy();}this._oHelper=null;this._oFieldControl=null;this._oTypes=null;this._oMetaData=null;b.prototype.destroy.apply(this,[]);};return f;},true);
