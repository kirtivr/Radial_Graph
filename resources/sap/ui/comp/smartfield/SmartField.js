/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/comp/library","./JSONControlFactory","./ODataControlFactory","sap/ui/core/Control","sap/ui/model/ParseException","sap/ui/model/ValidateException"],function(q,l,J,O,C,P,V){"use strict";var S=C.extend("sap.ui.comp.smartfield.SmartField",{metadata:{library:"sap.ui.comp",properties:{value:{type:"any",group:"Misc",defaultValue:null},enabled:{type:"boolean",group:"Misc",defaultValue:true},entitySet:{type:"string",group:"Misc",defaultValue:null},editable:{type:"boolean",group:"Misc",defaultValue:true},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null},textAlign:{type:"sap.ui.core.TextAlign",group:"Misc",defaultValue:null},placeholder:{type:"string",group:"Misc",defaultValue:null},name:{type:"string",group:"Misc",defaultValue:null},valueState:{type:"sap.ui.core.ValueState",group:"Appearance",defaultValue:sap.ui.core.ValueState.None},valueStateText:{type:"string",group:"Appearance",defaultValue:null},showValueStateMessage:{type:"boolean",group:"Appearance",defaultValue:true},jsontype:{type:"sap.ui.comp.smartfield.JSONType",group:"Misc",defaultValue:null},mandatory:{type:"boolean",group:"Misc",defaultValue:false},maxLength:{type:"int",group:"Misc",defaultValue:0},showSuggestion:{type:"boolean",group:"Misc",defaultValue:true},showValueHelp:{type:"boolean",group:"Misc",defaultValue:true},showLabel:{type:"boolean",group:"Appearance",defaultValue:true},textLabel:{type:"string",group:"Misc",defaultValue:null},tooltipLabel:{type:"string",group:"Misc",defaultValue:null}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},configuration:{type:"sap.ui.comp.smartfield.Configuration",multiple:false}},events:{entitySetFound:{},change:{},initialise:{},visibleChanged:{}}}});S.prototype.init=function(){this._oFactory=null;this._oControl={display:null,edit:null,current:null};this._oValue={display:null,edit:null,uom:null,uomset:null};this._oError={bComplex:false,bFirst:false,bSecond:false};this._oValueBind=null;};S.prototype.setVisible=function(v,s){C.prototype.setVisible.apply(this,arguments);this.fireVisibleChanged({visible:v});return this;};S.prototype.setEditable=function(v){this.setProperty("editable",v,true);this._toggleControl();return this;};S.prototype.setEntitySet=function(v){this.setProperty("entitySet",v,true);this.fireEntitySetFound({entitySet:v});return this;};S.prototype.setEnabled=function(v){this.setProperty("enabled",v,true);this._toggleControl();return this;};S.prototype.getValue=function(){var p,f;p=this._getMode();f=this._oValue[p];if(f){return f();}return this.getProperty("value");};S.prototype.updateBindingContext=function(s,b,m,u){this._init(m);if(this._oFactory){if(this._oFactory.bind){this._oFactory.bind();}else{this._toggleControl();}}C.prototype.updateBindingContext.apply(this,[s,b,m,u]);};S.prototype._getMode=function(){return this.getEditable()&&this.getEnabled()?"edit":"display";};S.prototype._toggleControl=function(){var m,v,c=true;m=this._getMode();if(m==="edit"){this._createControl(m);}else{v=this.getValue();if(this.data("configdata")){if(v===null||v===""){c=false;}}if(c){this._createControl(m);}else{this.setAggregation("_content",null);this._oControl.current="display";}}};S.prototype.setValue=function(v){var r=this.setProperty("value",v);this._toggleControl();return r;};S.prototype._createControl=function(m){var c;if(this._oFactory){if(m!==this._oControl.current||!this._oControl[m]){if(!this._oControl[m]){c=this._oFactory.createControl();this._oControl[m]=c.control;if(c.params&&c.params.getValue){this._oValue[m]=c.params.getValue;}if(c.params&&c.params.uom){this._oValue.uom=c.params.uom;}if(c.params&&c.params.uomset){this._oValue.uomset=c.params.uomset;}}this._oControl.current=m;this.setAggregation("_content",this._oControl[m]);}}};S.prototype._init=function(m){var M,b,c;if(!this._oFactory){b=this._getBindingInfo(m,"value");if(b){c=this.data("configdata");if(!c){M=this.getModel(m);}if(c||M){this._oFactory=this._createFactory(m,M,b,c);}}}};S.prototype._createFactory=function(m,M,b,c){var e,p;if(M&&M instanceof sap.ui.model.json.JSONModel){return new J(M,this,{model:m,path:b.path});}if(!c){e=this._getEntitySet(m);}if(e||c){if(c){p=c.configdata;}else{p={entitySet:e,model:m,path:b.path};}return new O(M,this,p);}return null;};S.prototype._getEntitySet=function(m){var b,e;e=this.getEntitySet();if(e&&!m){return e;}b=this.getBindingContext(m);if(b){if(!b.sPath||(b.sPath&&b.sPath==="/undefined")){return null;}e=this._parseEntity(b);this.fireEntitySetFound({entitySet:e});return e;}return null;};S.prototype._parseEntity=function(c){var r,m,e;r=/\((.+)\)/;m=r.exec(c.sPath);if(m){e=c.sPath.replace(m[0],"");}else{e=c.sPath;}return e.replace("/","");};S.prototype._getBindingInfo=function(m,n){if(!this._oValueBind){this._oValueBind=this.getBindingInfo(n);try{this._oValueBind=this._oValueBind.parts[0];}catch(e){}}if(this._oValueBind){if(!this._oValueBind.model&&!m){return this._oValueBind;}if(this._oValueBind.model===m){return this._oValueBind;}}return null;};S.prototype.updateMessages=function(n,m){if(m&&m.length>0){this.setValueState(m[0].type);this.setValueStateText(m[0].message);}else{this.setValueState(sap.ui.core.ValueState.None);this.setValueStateText("");}};S.prototype.getDataType=function(){var p;if(this._oFactory){if(this._oFactory.getDataProperty){p=this._oFactory.getDataProperty();if(p){return p.property.type;}}return this.getJsonType();}return null;};S.prototype.getDataProperty=function(){if(this._oFactory){if(this._oFactory.getDataProperty){return this._oFactory.getDataProperty();}return null;}return null;};S.prototype.getUnitOfMeasure=function(){if(this._oValue.uom){return this._oValue.uom();}return null;};S.prototype.setUnitOfMeasure=function(u){if(u&&this._oValue.uomset){this._oValue.uomset(u);}};S.prototype.setSimpleClientError=function(e){this._oError.bFirst=e;};S.prototype.setComplexClientErrorFirstOperand=function(e){this._oError.bComplex=true;this._oError.bFirst=e;};S.prototype.setComplexClientErrorSecondOperand=function(e){this._oError.bComplex=true;this._oError.bSecond=e;};S.prototype._hasClientError=function(){if(this._oError.bComplex){return this._oError.bFirst||this._oError.bSecond;}return this._oError.bFirst;};S.prototype.checkClientError=function(){var c,a;if(this._getMode()==="display"){return false;}if(this._hasClientError()){return true;}c=this.getInnerControls();a=c.length;while(a--){this._checkClientError(c[a]);}return this._hasClientError();};S.prototype._checkClientError=function(c){var b,m,p,a={"sap.m.Input":"value","sap.m.DatePicker":"value","sap.m.ComboBox":"selectedKey"};p=a[c.getMetadata()._sClassName];if(p){b=c.getBinding(p);}if(b){try{m="get"+p.substring(0,1).toUpperCase()+p.substring(1);b.setExternalValue(c[m]());}catch(e){if(e instanceof P){c.fireParseError({exception:e});}if(e instanceof V){c.fireValidationError({exception:e});}}}};S.prototype.getInnerControls=function(){var c,f,m={"sap.m.HBox":function(o){return o.getItems();},"sap.ui.comp.navpopover.SmartLink":function(o){var i=o.getAggregation("innerControl");if(!i){return[];}return i;}};c=this.getAggregation("_content");f=m[c.getMetadata()._sClassName];if(f){return f(c);}return[c];};S.prototype.exit=function(){var i=null;if(this._oFactory){this._oFactory.destroy();}if(this._getMode()==="edit"){i=this._oControl["display"];}else{i=this._oControl["edit"];}if(i&&i.destroy){i.destroy();}this._oError=null;this._oValue=null;this._oFactory=null;this._oControl=null;this._oValueBind=null;};return S;},true);
