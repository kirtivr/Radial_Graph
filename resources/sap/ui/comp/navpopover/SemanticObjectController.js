/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/ui/core/Element'],function(q,l,E){"use strict";var S=E.extend("sap.ui.comp.navpopover.SemanticObjectController",{metadata:{library:"sap.ui.comp",properties:{ignoredFields:{type:"string",group:"Misc",defaultValue:null},prefetchNavigationTargets:{type:"boolean",group:"Misc",defaultValue:false},fieldSemanticObjectMap:{type:"object",group:"Misc",defaultValue:null},entitySet:{type:"string",group:"Misc",defaultValue:null}},events:{navigationTargetsObtained:{},beforePopoverOpens:{},navigate:{},prefetchDone:{}}}});S.prototype.init=function(){this._proxyOnBeforePopoverOpens=q.proxy(this._onBeforePopoverOpens,this);this._proxyOnTargetsObtained=q.proxy(this._onTargetsObtained,this);this._proxyOnNavigate=q.proxy(this._onNavigate,this);this._aRegisteredControls=[];};S.prototype.registerControl=function(s){if(s.attachBeforePopoverOpens&&!s.hasListeners("beforePopoverOpens")){s.attachBeforePopoverOpens(this._proxyOnBeforePopoverOpens);}if(s.attachNavigationTargetsObtained&&!s.hasListeners("navigationTargetsObtained")){s.attachNavigationTargetsObtained(this._proxyOnTargetsObtained);}if(s.attachInnerNavigate&&!s.hasListeners("innerNavigate")){s.attachInnerNavigate(this._proxyOnNavigate);}this.setIgnoredState(s);this._aRegisteredControls.push(s);};S.prototype.unregisterControl=function(s){if(s.detachBeforePopoverOpens){s.detachBeforePopoverOpens(this._proxyOnBeforePopoverOpens);}if(s.detachNavigationTargetsObtained){s.detachNavigationTargetsObtained(this._proxyOnTargetsObtained);}if(s.detachInnerNavigate){s.detachInnerNavigate(this._proxyOnNavigate);}this._aRegisteredControls.pop(s);};S.prototype._onBeforePopoverOpens=function(e){var p=e.getParameters();if(this.hasListeners("beforePopoverOpens")){this.fireBeforePopoverOpens({semanticObject:p.semanticObject,semanticAttributes:p.semanticAttributes,setSemanticAttributes:p.setSemanticAttributes,setAppStateKey:p.setAppStateKey,originalId:p.originalId,open:p.open});}else{p.open();}};S.prototype._onTargetsObtained=function(e){var p=e.getParameters();if(this.hasListeners("navigationTargetsObtained")){var s=e.getSource();this.fireNavigationTargetsObtained({semanticObject:s.getSemanticObject(),semanticAttributes:s.getSemanticAttributes(),actions:p.actions,mainNavigation:p.mainNavigation,ownNavigation:p.ownNavigation,originalId:p.originalId,show:p.show});}else{p.show();}};S.prototype._onNavigate=function(e){var p=e.getParameters();this.fireNavigate({text:p.text,href:p.href,originalId:p.originalId,semanticObject:p.semanticObject,semanticAttributes:p.semanticAttributes});};S.prototype.setIgnoredState=function(s){var i=this._fieldIsIgnored(s.getFieldName())||!this._linkIsAvailable(s.getSemanticObject());s.setIgnoreLinkRendering(i);};S.prototype._fieldIsIgnored=function(f){if(this._aIgnoredSegmanticObjects){return this._aIgnoredSegmanticObjects.indexOf(f)>-1;}return false;};S.prototype._linkIsAvailable=function(s){if(this._oAvailableLinks){if(!this._oAvailableLinks[s]){return false;}}return true;};S.prototype.setIgnoredFields=function(i){if(i){this._aIgnoredSegmanticObjects=i.split(",");}else{this._aIgnoredSegmanticObjects=null;}this.setProperty("ignoredFields",i);this._evaluateEnableState();};S.prototype.setPrefetchNavigationTargets=function(p){this.setProperty("prefetchNavigationTargets",p);if(p){this._prefetchNavigationTargets();}else{this._oAvailableLinks=null;this._evaluateEnableState();}};S.prototype.getFieldSemanticObjectMap=function(){var m=this.getProperty("fieldSemanticObjectMap");if(!m){var e=this.getEntitySet();if(!e){q.sap.log.warning("FieldSemanticObjectMap is not set on SemanticObjectController, retrieval without EntitySet not possible");return null;}var M=this.getModel();q.sap.require("sap.ui.comp.odata.MetadataAnalyser");var o=new sap.ui.comp.odata.MetadataAnalyser(M);m=o.getFieldSemanticObjectMap(e);if(m){this.setProperty("fieldSemanticObjectMap",m,true);}}return m;};S.prototype.getEntitySet=function(){var e=this.getProperty("entitySet");if(!e){var p=this.getParent();while(p){if(p.getEntitySet){e=p.getEntitySet();if(e){this.setProperty("entitySet",e,true);break;}}p=p.getParent();}}return e;};S.prototype._prefetchNavigationTargets=function(){var g=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;if(!g){return;}this._oAvailableLinks={};var c=g("CrossApplicationNavigation");var u=g("URLParsing");var p=c.getSemanticObjectLinks('');p.fail(q.proxy(function(){this._oAvailableLinks=null;q.sap.log.error("'getSemanticObjectLinks' failed");this._evaluateEnableState();},this));p.done(q.proxy(function(L){var i,a;a=L.length;for(i=0;i<a;i++){var I=L[i].intent;var s=u.parseShellHash(I);if(s&&s.semanticObject){this._addActionToSemanticObject(s.semanticObject,s.action);}}this._evaluateEnableState();this.firePrefetchDone({semanticObjects:this._oAvailableLinks});},this));};S.prototype._addActionToSemanticObject=function(s,a){if(!this._oAvailableLinks[s]){this._oAvailableLinks[s]=[];}this._oAvailableLinks[s].push(a);};S.prototype._evaluateEnableState=function(){var i;var L=this._aRegisteredControls.length;for(i=0;i<L;i++){this.setIgnoredState(this._aRegisteredControls[i]);}};return S;},true);
