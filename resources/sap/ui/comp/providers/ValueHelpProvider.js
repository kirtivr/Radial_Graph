/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/List','sap/m/PlacementType','sap/m/ResponsivePopover','sap/m/StandardListItem','./BaseValueListProvider','sap/ui/comp/valuehelpdialog/ValueHelpDialog','sap/ui/model/json/JSONModel'],function(q,L,P,R,S,B,V,J){"use strict";var a=function(p){if(p){this.preventInitialDataFetchInValueHelpDialog=p.preventInitialDataFetchInValueHelpDialog;this.isRangeOnlyDialog=!p.annotation;this.sTitle=p.title;this.sFieldName=p.fieldName;this.bSupportMultiselect=p.supportMultiSelect;this.bSupportRanges=p.supportRanges;this.bIsSingleIntervalRange=p.isSingleIntervalRange;this.bTakeOverInputValue=(p.takeOverInputValue===false)?false:true;if(this.bIsSingleIntervalRange){this.isRangeOnlyDialog=true;this.bSupportRanges=true;}if(p.type==="Edm.Decimal"){this._sType="numeric";}else if(p.type==="Edm.DateTime"&&p.displayFormat==="Date"){this._sType="date";}this._sMaxLength=p.maxLength;this.additionalAnnotations=p.additionalAnnotations;}B.apply(this,arguments);this._onInitialise();};a.prototype=q.sap.newObject(B.prototype);a.prototype._onInitialise=function(){if(this.oControl.attachValueHelpRequest){this._fVHRequested=q.proxy(function(e){this.oControl=e.getSource();this.bForceTriggerDataRetreival=e.getParameter("fromSuggestions");if(this.bTakeOverInputValue||this.bForceTriggerDataRetreival){this.sBasicSearchText=e.getSource().getValue();}this._createValueHelpDialog();},this);this.oControl.attachValueHelpRequest(this._fVHRequested);}};a.prototype._createValueHelpDialog=function(){if(!this.bCreated){this.bCreated=true;this.oValueHelpDialog=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({basicSearchText:this.sBasicSearchText,supportRangesOnly:this.isRangeOnlyDialog,supportMultiselect:this.bSupportMultiselect,title:this.sTitle,supportRanges:this.bSupportRanges,displayFormat:this.sDisplayFormat,ok:q.proxy(this._onOK,this),cancel:q.proxy(this._onCancel,this),afterClose:q.proxy(function(){if(this.oPrimaryValueListAnnotation){this._resolveAnnotationData(this.oPrimaryValueListAnnotation);}this.oValueHelpDialog.destroy();this.bCreated=false;if(this.oControl&&this.oControl.focus){this.oControl.focus();}},this)});if(this.bIsSingleIntervalRange){this.oValueHelpDialog.setIncludeRangeOperations([sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.BT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ]);this.oValueHelpDialog.setMaxIncludeRanges(1);this.oValueHelpDialog.setMaxExcludeRanges(0);this._updateInitialInterval();}if(this.oControl.$()&&this.oControl.$().closest(".sapUiSizeCompact").length>0){this.oValueHelpDialog.addStyleClass("sapUiSizeCompact");}if(this.bSupportRanges){this.oValueHelpDialog.setRangeKeyFields([{label:this.sTitle,key:this.sFieldName,type:this._sType,maxLength:this._sMaxLength}]);}if(!this.isRangeOnlyDialog){this._createAdditionalValueHelpControls();this._createCollectiveSearchControls();this.oValueHelpDialog.setModel(this.oODataModel);}if(this.oControl.getTokens){var t=this.oControl.getTokens();this.oValueHelpDialog.setTokens(t);}if(this.bForceTriggerDataRetreival){this._rebindTable();this.bForceTriggerDataRetreival=false;}this.oValueHelpDialog.open();}};a.prototype._updateInitialInterval=function(){var i=this.oControl.getValue(),t,r,v;if(i){t=new sap.m.Token();r={exclude:false,keyField:this.sKey};v=i.split("-");if(v&&v.length===2){r.operation="BT";r.value1=v[0];r.value2=v[1];}else{r.operation="EQ";r.value1=i;}t.data("range",r);}if(t){this.oValueHelpDialog.setTokens([t]);}};a.prototype._createCollectiveSearchControls=function(){var p,l,I,i=0,b=0,o,A,r;if(this.additionalAnnotations&&this.additionalAnnotations.length){o=q.proxy(function(e){var s=e.getParameter("listItem"),c;p.close();if(s){c=s.data("_annotation");if(c){this._triggerAnnotationChange(c);}}},this);l=new L({mode:sap.m.ListMode.SingleSelectMaster,selectionChange:o});r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");p=new R({placement:P.Bottom,showHeader:true,title:r.getText("COLLECTIVE_SEARCH_SELECTION_TITLE"),content:[l]});I=new S({title:this.oPrimaryValueListAnnotation.valueListTitle});I.data("_annotation",this.oPrimaryValueListAnnotation);l.addItem(I);l.setSelectedItem(I);this.oValueHelpDialog.oSelectionTitle.setText(" - "+this.oPrimaryValueListAnnotation.valueListTitle);b=this.additionalAnnotations.length;for(i=0;i<b;i++){A=this.additionalAnnotations[i];I=new S({title:A.valueListTitle});I.data("_annotation",A);l.addItem(I);}this.oValueHelpDialog.oSelectionButton.setVisible(true);this.oValueHelpDialog.oSelectionTitle.setVisible(true);this.oValueHelpDialog.oSelectionButton.attachPress(function(){p.openBy(this);});}};a.prototype._triggerAnnotationChange=function(A){this.oValueHelpDialog.oSelectionTitle.setText(" - "+A.valueListTitle);this.oValueHelpDialog.resetTableState();this._resolveAnnotationData(A);this._createAdditionalValueHelpControls();};a.prototype._createAdditionalValueHelpControls=function(){var b=null;this.oValueHelpDialog.setKey(this.sKey);this.oValueHelpDialog.setKeys(this._aKeys);this.oValueHelpDialog.setDescriptionKey(this.sDescription);this.oValueHelpDialog.setTokenDisplayBehaviour(this.sTokenDisplayBehaviour);var c=new J();c.setData({cols:this._aCols});this.oValueHelpDialog.setModel(c,"columns");if(this.bSupportBasicSearch){b=this.sKey;}this.oSmartFilterBar=new sap.ui.comp.smartfilterbar.SmartFilterBar({entityType:this.sValueListEntityName,basicSearchFieldName:b,advancedMode:true,expandAdvancedArea:!this.bForceTriggerDataRetreival,search:this._onFilterBarSearchPressed.bind(this),reset:this._onFilterBarResetPressed.bind(this),filterChange:q.proxy(this._onFilterBarFilterChange,this),initialise:q.proxy(this._onFilterBarInitialise,this)});if(this.oFilterProvider){this.oSmartFilterBar.data("dateFormatSettings",this.oFilterProvider._oDateFormatSettings);}this.oSmartFilterBar.isRunningInValueHelpDialog=true;this.oValueHelpDialog.setFilterBar(this.oSmartFilterBar);};a.prototype._onFilterBarFilterChange=function(){var t=this.oValueHelpDialog.theTable;if(t){t.setShowOverlay(true);}this.oValueHelpDialog.TableStateSearchData();};a.prototype._onFilterBarSearchPressed=function(){this._rebindTable();};a.prototype._rebindTable=function(){var f,p,t;f=this.oSmartFilterBar.getFilters();p=this.oSmartFilterBar.getParameters()||{};if(this.aSelect&&this.aSelect.length){p["select"]=this.aSelect.toString();}t=this.oValueHelpDialog.theTable;t.setShowOverlay(false);this.oValueHelpDialog.TableStateDataSearching();t.setBusy(true);t.bindRows({path:"/"+this.sValueListEntitySetName,filters:f,parameters:p,sorter:new sap.ui.model.Sorter(this.sKey),events:{dataReceived:q.proxy(function(e){this.oValueHelpDialog.TableStateDataFilled();t.setBusy(false);var b=e.getSource(),i;if(b&&this.oValueHelpDialog&&this.oValueHelpDialog.isOpen()){i=b.getLength();if(i){this.oValueHelpDialog.update();}}},this)}});};a.prototype._onFilterBarResetPressed=function(){this._calculateFilterInputData();if(this.oSmartFilterBar){this.oSmartFilterBar.setFilterData(this.mFilterInputData);}};a.prototype._onFilterBarInitialise=function(){var b=null;this._onFilterBarResetPressed();if(this.oSmartFilterBar&&this.oSmartFilterBar.getBasicSearchControl){b=this.oSmartFilterBar.getBasicSearchControl();if(b){b.setValue(this.sBasicSearchText);}}if(!this.preventInitialDataFetchInValueHelpDialog){this._rebindTable();}};a.prototype._onOK=function(c){var t=c.getParameter("tokens"),r,k,i=0,b=[],o=null;if(this.oControl instanceof sap.m.MultiInput){this.oControl.setTokens(t);i=t.length;while(i--){o=t[i].data("row");if(o){b.push(o);}}}else{if(t[0]){if(this.bIsSingleIntervalRange){r=t[0].data("range");if(r){if(r.operation==="BT"){k=r.value1+"-"+r.value2;}else{k=r.value1;}}}else{k=t[0].getKey();}o=t[0].data("row");if(o){b.push(o);}}this.oControl.setValue(k);this.oControl.fireChange({value:k,validated:true});}this._calculateAndSetFilterOutputData(b);this.oValueHelpDialog.close();this.oValueHelpDialog.setModel(null);};a.prototype._onCancel=function(){this.oValueHelpDialog.close();this.oValueHelpDialog.setModel(null);};a.prototype.destroy=function(){if(this.oControl&&this.oControl.detachValueHelpRequest){this.oControl.detachValueHelpRequest(this._fVHRequested);this._fVHRequested=null;}B.prototype.destroy.apply(this,arguments);if(this.oValueHelpDialog){this.oValueHelpDialog.destroy();this.oValueHelpDialog=null;}if(this.oSmartFilterBar){this.oSmartFilterBar.destroy();this.oSmartFilterBar=null;}this.additionalAnnotations=null;this.sTitle=null;this.sFieldName=null;};return a;},true);
