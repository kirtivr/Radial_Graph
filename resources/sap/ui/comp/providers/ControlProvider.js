/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/CheckBox','sap/m/ComboBox','sap/m/DatePicker','sap/m/HBox','sap/m/Input','sap/m/Text','sap/ui/comp/navpopover/SmartLink','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/smartfield/ODataHelper','sap/ui/comp/smartfield/SmartField','sap/ui/model/type/Date','sap/ui/model/type/DateTime','sap/ui/model/type/Float'],function(q,C,a,D,H,I,T,S,M,O,b,c,d,F){"use strict";var e=function(p){if(p){this._oParentODataModel=p.model;this._oMetadataAnalyser=p.metadataAnalyser;this._aODataFieldMetadata=p.fieldsMetadata;this._oDateFormatSettings=p.dateFormatSettings;this._oCurrencyFormatSettings=p.currencyFormatSettings;this._oDefaultDropDownDisplayBehaviour=p.defaultDropDownDisplayBehaviour;this.useSmartField=p.useSmartField==="true";this._sEntitySet=p.entitySet;}if(!this._oMetadataAnalyser&&this._oParentODataModel){this._oMetadataAnalyser=new M(this._oParentODataModel);this._intialiseMetadata();}this._mSmartField={};this._oHelper=new O(this._oMetadataAnalyser.oModel);this._aValueListProvider=[];this._aValueHelpProvider=[];};e.prototype._intialiseMetadata=function(){if(!this._aODataFieldMetadata){this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntity);}};e.prototype.getFieldViewMetadata=function(f,i){var o=this._createFieldMetadata(f);this._createFieldTemplate(o,i);return o;};e.prototype._createFieldTemplate=function(v,i){if(this.useSmartField){v.template=new b({value:{path:v.name},entitySet:this._sEntitySet,editable:{path:"sm4rtM0d3l>/editable",mode:"OneWay"}});this._completeSmartField(v);}else{if(i){v.template=this._createEditableTemplate(v);}else{v.template=this._createDisplayOnlyTemplate(v);}}};e.prototype._completeSmartField=function(v){var o={annotations:{},path:v.name,namespace:this._oMetadataAnalyser.getNamespace()};if(!this._mSmartField.entitySetObject){this._mSmartField.entitySetObject=this._oHelper.getEntitySet(this._sEntitySet);this._mSmartField.entityType=this._oHelper.getEntityType(this._mSmartField.entitySetObject.entityType.replace(o.namespace+".",""));}o.modelObject=this._oParentODataModel;o.entitySetObject=this._mSmartField.entitySetObject;o.entityType=this._mSmartField.entityType;o.property=this._oHelper.getProperty(o.path,o.namespace,o.entityType.count);o.annotations.uom=this._oHelper.getUnitOfMeasure(o.property,o.path,o.namespace,o.entityType.count);o.annotations.text=this._oHelper.getTextProperty(o.property,o.path,o.namespace,o.entityType.count);o.annotations.lineitem=this._oMetadataAnalyser.getLineItemAnnotation(o.entitySetObject.entityType);o.annotations.semantic=this._oMetadataAnalyser.getSemanticObjectAnnotation(o.namespace+"."+o.entityType.type.name+"/"+o.property.property.name);o.annotations.valuelist=this._oHelper.getValueListAnnotation(o.namespace,o.entityType.type,o.property,o.property.typePath);this._oHelper.getUOMValueListAnnotation(o);this._oHelper.geValueListEntitySet(o);v.template.data("configdata",{"configdata":o});v.template.data("dateFormatSettings",this._oDateFormatSettings);v.template.data("currencyFormatSettings",this._oCurrencyFormatSettings);v.template.data("defaultDropDownDisplayBehaviour",this._oDefaultDropDownDisplayBehaviour);};e.prototype._createEditableTemplate=function(v,B){var t=null,o;if(v.type==="Edm.DateTime"||v.type==="Edm.DateTimeOffset"){if(v.displayFormat==="Date"){t=new D({dateValue:{path:v.name}});}else{o=new d();}}else if(v.type==="Edm.Decimal"){o=new F();}else if(v.type==="Edm.Boolean"){t=new C({selected:{path:v.name}});}if(v.semanticObject&&(!B)){t=this._createSmartLinkFieldTemplate(v,o,q.proxy(function(){return this._createEditableTemplate(v,true);},this));}if(!t){t=new I({value:{path:v.name,type:o}});if(v.isCurrencyField){t.bindProperty("description",{path:v.unit});t.setTextAlign("End");t.setFieldWidth("80%");}if(v.oValueListAnnotation){this._associateValueHelpAndSuggest(t,v);}}return t;};e.prototype._associateValueHelpAndSuggest=function(o,f){o.setShowValueHelp(true);this._aValueHelpProvider.push(new sap.ui.comp.providers.ValueHelpProvider({annotation:f.oValueListAnnotation,additionalAnnotations:f.additionalAnnotations,control:o,model:this._oParentODataModel,preventInitialDataFetchInValueHelpDialog:true,takeOverInputValue:false,fieldName:f.fieldName,type:f.type,maxLength:f.maxLength,displayFormat:f.displayFormat,displayBehaviour:f.displayBehaviour,title:f.label}));o.setShowSuggestion(true);o.setFilterSuggests(false);this._aValueListProvider.push(new sap.ui.comp.providers.ValueListProvider({annotation:f.oValueListAnnotation,control:o,model:this._oParentODataModel,typeAheadEnabled:true,aggregation:"suggestionRows",displayFormat:f.displayFormat}));};e.prototype._createDisplayOnlyTemplate=function(v,B){var t=null,o=null,A;if(v.type==="Edm.DateTime"||v.type==="Edm.DateTimeOffset"){if(v.displayFormat==="Date"){o=new c(this._oDateFormatSettings);}else{o=new d();}}else if(v.type==="Edm.Decimal"){o=new F();A="End";}if(v.isCurrencyField){t=this._createCurrencyFieldTemplate(v);}else if(v.semanticObject&&(!B)){t=this._createSmartLinkFieldTemplate(v,o,q.proxy(function(){return this._createDisplayOnlyTemplate(v,true);},this));}else{t=new T({wrapping:false,textAlign:A,text:{path:v.name,type:o}});}v.align=A;return t;};e.prototype._createSmartLinkFieldTemplate=function(v,t,f){var o=new S({semanticObject:v.semanticObject,semanticObjectLabel:v.label,fieldName:v.name,text:{path:v.name,type:t}});o.setCreateControlCallback(f);return o;};e.prototype._createCurrencyFieldTemplate=function(v){var t,V,o;if(!this._oCurrencyFormatter){q.sap.require("sap.ui.core.format.NumberFormat");this._oCurrencyFormatter=sap.ui.core.format.NumberFormat.getCurrencyInstance({showMeasure:false});this._FIGURE_SPACE='\u2007';this._PUNCTUATION_SPACE='\u2008';this._iMaxCurrencyDigits=3;this._fCurrencyFormatter=q.proxy(function(A,s){var f,i,p;if(A===undefined||A===null||!s||s==="*"){return"";}i=this._oCurrencyFormatter.oLocaleData.getCurrencyDigits(s);f=this._oCurrencyFormatter.format(A,s);if(i===0){f+=this._PUNCTUATION_SPACE;}p=this._iMaxCurrencyDigits-i;if(p){f=q.sap.padRight(f,this._FIGURE_SPACE,f.length+p);}return f;},this);if(this._oCurrencyFormatSettings&&this._oCurrencyFormatSettings.showCurrencySymbol){this._fCurrencySymbolFormatter=q.proxy(function(s){if(!s||s==="*"){return"";}return this._oCurrencyFormatter.oLocaleData.getCurrencySymbol(s);},this);}}V=new T({wrapping:false,textAlign:"End",text:{parts:[{path:v.name,type:new F()},{path:v.unit}],formatter:this._fCurrencyFormatter,useRawValues:true}});o=new T({wrapping:false,textAlign:"Begin",width:"2.5em",text:{path:v.unit,formatter:this._fCurrencySymbolFormatter}});t=new H({justifyContent:"End",items:[V,o]});return t;};e.prototype._createFieldMetadata=function(f){var o={};o.fullName=f.fullName;o.type=f.type;o.name=f.name;o.displayFormat=f.displayFormat;o.maxLength=f.maxLength;o.precision=f.precision;o.scale=f.scale;o.sortable=f.sortable;o.filterable=f.filterable;o.label=f.fieldLabel||f.name;o.quickInfo=f.quickInfo||o.label;o.aggregationRole=f.aggregationRole;o.unit=f.unit;o.isCurrencyField=this._isCurrencyField(f);o.filterType=this._getFilterType(f);o.entityName=f.entityName;this._setAnnotationMetadata(o);return o;};e.prototype._setAnnotationMetadata=function(f){var A=null;if(!this.useSmartField&&f&&f.fullName){A=this._oMetadataAnalyser.getValueListAnnotation(f.fullName);if(A){f.oValueListAnnotation=A.primaryValueListAnnotation;f.additionalAnnotations=A.additionalAnnotations;}A=this._oMetadataAnalyser.getSemanticObjectAnnotation(f.fullName);if(A){f.semanticObject=A.semanticObject;}}};e.prototype._isCurrencyField=function(f){var i=false,o,l,u;if(!this.useSmartField&&this._aODataFieldMetadata){l=this._aODataFieldMetadata.length;while(l--){o=this._aODataFieldMetadata[l];if(o.name===f.unit){u=o;break;}}if(u&&u.semantics==="currency-code"){i=true;}}return i;};e.prototype._getFilterType=function(f){if(f.type==="Edm.Decimal"){return"numeric";}else if(f.type==="Edm.DateTime"&&f.displayFormat==="Date"){return"date";}return undefined;};e.prototype.destroy=function(){var i;if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;if(this._aValueHelpProvider){i=this._aValueHelpProvider.length;while(i--){this._aValueHelpProvider[i].destroy();}}this._aValueHelpProvider=null;if(this._aValueListProvider){i=this._aValueListProvider.length;while(i--){this._aValueListProvider[i].destroy();}}if(this._oHelper){this._oHelper.destroy();}this._oHelper=null;this._mSmartField=null;this._aValueListProvider=null;this._aODataFieldMetadata=null;this._oCurrencyFormatter=null;this.bIsDestroyed=true;};return e;},true);
