/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/odata/MetadataAnalyser','./ControlProvider'],function(q,M,C){"use strict";var T=function(p){if(p){this._oParentODataModel=p.model;this.sEntitySet=p.entitySet;this._sIgnoredFields=p.ignoredFields;this.isEditableTable=p.isEditableTable;this.useSmartField=p.useSmartField;try{this._oDateFormatSettings=p.dateFormatSettings?JSON.parse(p.dateFormatSettings):undefined;this._oCurrencyFormatSettings=p.currencyFormatSettings?JSON.parse(p.currencyFormatSettings):undefined;this._oDefaultDropDownDisplayBehaviour=p.defaultDropDownDisplayBehaviour;}catch(e){}}this._aODataFieldMetadata=[];this._aTableViewMetadata=[];this._aIgnoredFields=[];this._oMetadataAnalyser=new M(this._oParentODataModel);this._intialiseMetadata();};T.prototype._intialiseMetadata=function(){var t=[],i,l=0,f,o,s,S;this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntitySet);this._oLineItemAnnotation=this._oMetadataAnalyser.getLineItemAnnotation(this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.sEntitySet));S=this._oMetadataAnalyser.getEntityContainerAttribute("supported-formats");if(S){this._bSupportsExcelExport=S.indexOf("xlsx")>-1;}this._generateIgnoredFieldsArray();if(this._aODataFieldMetadata){l=this._aODataFieldMetadata.length;}this._oControlProvider=new C({metadataAnalyser:this._oMetadataAnalyser,model:this._oParentODataModel,fieldsMetadata:this._aODataFieldMetadata,dateFormatSettings:this._oDateFormatSettings,currencyFormatSettings:this._oCurrencyFormatSettings,defaultDropDownDisplayBehaviour:this._oDefaultDropDownDisplayBehaviour,useSmartField:this.useSmartField,entitySet:this.sEntitySet});this._oFieldSemanticObjectMap={};for(i=0;i<l;i++){f=this._aODataFieldMetadata[i];if(this._aIgnoredFields.indexOf(f.name)>-1||!f.visible){continue;}o=this._oControlProvider.getFieldViewMetadata(f,this.isEditableTable);this._enrichWithTableViewMetadata(f,o);t.push(o);if(o.semanticObject){this._oFieldSemanticObjectMap[o.name]=o.semanticObject;}}s=function(a,b){if(a.index||a.index===0){if(b.index||b.index===0){return a.index-b.index;}return-1;}if(b.index||b.index===0){return 1;}return 0;};this._aTableViewMetadata=t.sort(s);};T.prototype.getFieldSemanticObjectMap=function(){return this._oFieldSemanticObjectMap;};T.prototype.getTableViewMetadata=function(){return this._aTableViewMetadata;};T.prototype.getSupportsExcelExport=function(){return this._bSupportsExcelExport;};T.prototype.getIsUTCDateHandlingEnabled=function(){return this._oDateFormatSettings?this._oDateFormatSettings.UTC:false;};T.prototype._generateIgnoredFieldsArray=function(){if(this._sIgnoredFields){this._aIgnoredFields=this._sIgnoredFields.split(",");}};T.prototype._enrichWithTableViewMetadata=function(f,F){this._updateLabel(F);F.isInitiallyVisible=this._isInitiallyVisible(f);F.index=this._getIndex(f);F.width=this._getWidth(f);F.summed=f.aggregationRole==="measure";};T.prototype._isInitiallyVisible=function(f){var i=false;if(this._oLineItemAnnotation&&this._oLineItemAnnotation.fields){i=this._oLineItemAnnotation.fields.indexOf(f.name)>-1;}return i;};T.prototype._getIndex=function(f){var i;if(this._oLineItemAnnotation&&this._oLineItemAnnotation.fields){i=this._oLineItemAnnotation.fields.indexOf(f.name);}if(i>-1){return i;}return undefined;};T.prototype._updateLabel=function(f){var l;if(this._oLineItemAnnotation&&this._oLineItemAnnotation.labels){l=this._oLineItemAnnotation.labels[f.name];}if(l){f.label=l;if(f.template&&f.template.setSemanticObjectLabel){f.template.setSemanticObjectLabel(f.label);}}};T.prototype._getWidth=function(f){var w=f.maxLength||f.precision,W;if(f.type==="Edm.DateTime"&&f.displayFormat==="Date"){w="9em";}else if(w){W=parseInt(w,10);if(!isNaN(W)){if(W>50){W=50;}if(W<=1){W=1.5;}w=W+0.75+"em";}}return w;};T.prototype.destroy=function(){if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;this._aODataFieldMetadata=null;this._aTableViewMetadata=null;this._aIgnoredFields=null;this.bIsDestroyed=true;};return T;},true);
