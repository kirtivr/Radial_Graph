/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/MessageBox','sap/ui/comp/filterbar/FilterBar','sap/ui/comp/filterbar/FilterGroupItem','sap/ui/comp/filterbar/FilterItem','sap/ui/comp/library','./AdditionalConfigurationHelper','./ControlConfiguration','./FilterProvider','./GroupConfiguration','sap/ui/comp/smartvariants/PersonalizableInfo','sap/ui/comp/smartvariants/SmartVariantManagement'],function(q,M,F,a,b,l,A,C,c,G,P,S){"use strict";var d=F.extend("sap.ui.comp.smartfilterbar.SmartFilterBar",{metadata:{library:"sap.ui.comp",properties:{entityType:{type:"string",group:"Misc",defaultValue:null},resourceUri:{type:"string",group:"Misc",defaultValue:null},basicSearchFieldName:{type:"string",group:"Misc",defaultValue:null}},aggregations:{controlConfiguration:{type:"sap.ui.comp.smartfilterbar.ControlConfiguration",multiple:true,singularName:"controlConfiguration"},groupConfiguration:{type:"sap.ui.comp.smartfilterbar.GroupConfiguration",multiple:true,singularName:"groupConfiguration"}}}});d.prototype.init=function(){this._aFilterBarViewMetadata=null;this.isRunningInValueHelpDialog=false;F.prototype.init.apply(this);};d.prototype._initializeMetadata=function(){if(!this.isInitialised){this._createFilterProvider();if(this._oFilterProvider){this._aFilterBarViewMetadata=this._oFilterProvider.getFilterBarViewMetadata();if(this._aFilterBarViewMetadata){this._attachAdditionalConfigurationChanged();this.isInitialised=true;this.setModel(this._oFilterProvider.oModel,this._oFilterProvider.sFilterModelName);this._createFilterBar();this.registerGetFiltersWithValues(q.proxy(this.getFiltersWithValues,this));this.registerFetchData(q.proxy(this.getFilterDataAsString,this,true));this.registerApplyData(q.proxy(function(j){this.setFilterDataAsString(j,true);},this));this._initializeVariantManagement();}}}};d.prototype.getFilterBarViewMetadata=function(){return this._aFilterBarViewMetadata;};d.prototype._createFilterProvider=function(){var r,m,e,B,o;B=this.getBasicSearchFieldName();r=this.getResourceUri();e=this.getEntityType();o=this.getAdditionalConfiguration();m=this.getModel();if(m&&m.bLoadMetadataAsync&&!m.oMetadata.isLoaded()){if(!this._bMetadataLoadAttached){m.attachMetadataLoaded(q.proxy(this._initializeMetadata,this));this._bMetadataLoadAttached=true;}return;}if((m||r)&&e){this._oFilterProvider=new sap.ui.comp.smartfilterbar.FilterProvider({basicSearchFieldName:B,entityType:e,serviceUrl:r,isRunningInValueHelpDialog:this.isRunningInValueHelpDialog,model:m,additionalConfiguration:o,defaultDropDownDisplayBehaviour:this.data("defaultDropDownDisplayBehaviour"),defaultTokenDisplayBehaviour:this.data("defaultTokenDisplayBehaviour"),dateFormatSettings:this.data("dateFormatSettings"),smartFilter:this});}};d.prototype._attachAdditionalConfigurationChanged=function(){var e,g,i,f;g=this.getGroupConfiguration();f=g.length;for(i=0;i<f;i++){g[i].attachChange(this._handleGroupConfigurationChanged.bind(this));}e=this.getControlConfiguration();f=e.length;for(i=0;i<f;i++){e[i].attachChange(this._handleControlConfigurationChanged.bind(this));}};d.prototype._handleControlConfigurationChanged=function(e){var p,o,f,k,v;p=e.getParameter("propertyName");o=e.oSource;if(!o){return;}k=o.getKey();f=this._getFilterItemByName(k);if(!f){return;}if(p==="visible"){v=o.getVisible();f.setVisible(v);}else if(p==="label"){v=o.getLabel();f.setLabel(v);}else if(p==="visibleInAdvancedArea"){v=o.getVisibleInAdvancedArea();if(f.setVisibleInAdvancedArea){f.setVisibleInAdvancedArea(v);}}};d.prototype._handleGroupConfigurationChanged=function(e){var p,g;p=e.getParameter("propertyName");g=e.oSource;if(p==="label"){this._handleGroupConfigurationLabelChanged(g);}};d.prototype._handleGroupConfigurationLabelChanged=function(g){var f,k,L;if(!g){return;}L=g.getLabel();k=g.getKey();f=this._getFilterGroupItemByGroupName(k);if(f){f.setGroupTitle(L);}};d.prototype._getFilterItemByName=function(n){var f,e,i;f=this.getFilterItems();f.push.apply(f,this.getFilterGroupItems());e=f.length;for(i=0;i<e;i++){if(f[i].getName()===n){return f[i];}}};d.prototype._getFilterGroupItemByGroupName=function(n){var f,e,i;f=this.getFilterGroupItems();e=f.length;for(i=0;i<e;i++){if(f[i].getGroupName()===n){return f[i];}}};d.prototype.getAdditionalConfiguration=function(){return new A(this.getControlConfiguration(),this.getGroupConfiguration());};d.prototype.setEntityType=function(e){this.setProperty("entityType",e);this._initializeMetadata();};d.prototype.setResourceUri=function(r){this.setProperty("resourceUri",r);this._initializeMetadata();};d.prototype.updateBindingContext=function(){F.prototype.updateBindingContext.apply(this,arguments);this._initializeMetadata();};d.prototype._createFilterBar=function(){var f,i,j,L=0,e=0,g,o;if(!this._aFilterBarViewMetadata){return this;}L=this._aFilterBarViewMetadata.length;for(i=0;i<L;i++){f=this._aFilterBarViewMetadata[i];g=f.fields;e=g.length;for(j=0;j<e;j++){o=g[j];if(f.groupName===c.BASIC_FILTER_AREA_ID){this._createFieldInBasicArea(o);}else{this._createFieldInAdvancedArea(f.groupName,f.groupLabel,o);}if(o.name!==c.BASIC_SEARCH_FIELD_ID){this._handleEnter(o.control);this._handleChange(o.control);this._handleError(o.control);}else{this._attachToBasicSearch(o.control);}}}return this;};d.prototype._handleError=function(o){if(o){var O=q.proxy(function(){this._bInError=false;if(o&&o.getValueState&&o.getValueState()===sap.ui.core.ValueState.Error){this._bInError=true;}this.setSearchEnabled(!this._bInError);},this);o.attachParseError(O);o.attachFormatError(O);o.attachValidationError(O);o.attachValidationSuccess(q.proxy(function(){this._bInError=false;this.setSearchEnabled(true);},this));}};d.prototype._attachToBasicSearch=function(B){if(B){B.attachSearch(q.proxy(function(){this.search();},this));B.attachLiveChange(q.proxy(this._onChange,this));}};d.prototype._onChange=function(e){var o=e.getSource();if(!this._bInError&&(!o||(o&&!o.__bValidatingToken))){this.setSearchEnabled(true);this.fireFilterChange(e);}};d.prototype._handleChange=function(o){if(o){if(o.attachChange){o.attachChange(q.proxy(this._onChange,this));}}};d.prototype._handleEnter=function(o){o.attachBrowserEvent("keydown",function(e){if(e.which===13){o.__bSuggestInProgress=(o._oSuggestionPopup&&o._oSuggestionPopup.isOpen());}});o.attachBrowserEvent("keyup",q.proxy(function(e){if(!this._bInError&&(e.which===13&&!o.__bSuggestInProgress&&!o.__bValidatingToken)){this.search();}},this));};d.prototype._createFieldInBasicArea=function(f){var o;o=new b({labelTooltip:f.quickInfo,label:f.label,name:f.fieldName,control:f.control,mandatory:f.isMandatory,visible:f.isVisible});if(f.isCustomFilterField){o.data("isCustomField",true);}this.addFilterItem(o);};d.prototype._createFieldInAdvancedArea=function(g,s,f){var o;o=new a({labelTooltip:f.quickInfo,label:f.label,name:f.fieldName,groupName:g,groupTitle:s,mandatory:f.isMandatory,visible:f.isVisible,visibleInAdvancedArea:f.visibleInAdvancedArea,control:f.control});if(f.isCustomFilterField){o.data("isCustomField",true);}this.addFilterGroupItem(o);};d.prototype.getFilters=function(){var f=this._getVisibleFieldNames();return this._oFilterProvider?this._oFilterProvider.getFilters(f):[];};d.prototype.getParameters=function(){return this._oFilterProvider?this._oFilterProvider.getParameters():{};};d.prototype.getControlByKey=function(k){var f;f=this._getFilterItemByName(k);if(f){return this.determineControlByFilterItem(f);}};d.prototype._getVisibleFieldNames=function(){var f=[],v=this.getAllFilterItems(true),L=v.length,i;L=v.length;while(L--){i=v[L];if(i){f.push(i.getName());}}return f;};d.prototype.getFilterData=function(e){var D=null;if(this._oFilterProvider){if(e){D=this._oFilterProvider.getFilterData();}else{D=this._oFilterProvider.getFilledFilterData(this._getVisibleFieldNames());}}return D;};d.prototype._checkHasValueData=function(o){if(o){if(typeof o==="boolean"){return o;}else if(typeof o==="string"){if(o.toLowerCase()==="true"){return true;}}}return false;};d.prototype._checkForValues=function(D,f,o){var v=null;if(D&&f&&o){if(!f.data("isCustomField")){v=D[f.getName()];}else{var e=o.data("hasValue");if((e!==undefined)&&(e!=null)){return this._checkHasValueData(e);}else{if(o.getValue){v=o.getValue();}else if(o.getSelectedKey){v=o.getSelectedKey();}}}}return v?true:false;};d.prototype.getFiltersWithValues=function(){var f=[];var e=this.getAllFilterItems(),o,D=this.getFilterData(),L=0,g;if(e&&D){L=e.length;while(L--){o=e[L];g=this.determineControlByFilterItem(o);if(this._checkForValues(D,o,g)){f.push(o);}}}return f;};d.prototype.getFilterDataAsString=function(e){var D=null;if(this._oFilterProvider){if(e){D=this._oFilterProvider.getFilterDataAsString();}else{D=this._oFilterProvider.getFilledFilterDataAsString(this._getVisibleFieldNames());}}return D;};d.prototype.setFilterData=function(j,r){if(this._oFilterProvider){this._oFilterProvider.setFilterData(j,r);}};d.prototype.setFilterDataAsString=function(j,r){if(this._oFilterProvider){this._oFilterProvider.setFilterDataAsString(j,r);}};d.prototype.fireClear=function(){this._clearFilterFields();this.fireEvent("clear",arguments);};d.prototype._clearFilterFields=function(){if(this._oFilterProvider){this._oFilterProvider.clear();}};d.prototype.fireReset=function(){this._resetFilterFields();this.fireEvent("reset",arguments);};d.prototype._resetFilterFields=function(){if(this._oFilterProvider){this._oFilterProvider.reset();}};d.prototype.search=function(){var p=[];var o={};o.selectionSet=this._retrieveCurrentSelectionSet();p.push(o);var e=this._validateMandatoryFields();if(e){o.selectionSet=this._retrieveCurrentSelectionSet();p.push(o);this.fireSearch(p);}else{if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");}if(!this._sMandatoryErrorMessage){this._sMandatoryErrorMessage=this._oResourceBundle.getText("EMPTY_MANDATORY_MESSAGE");this._sMandatoryTitle=this._oResourceBundle.getText("EMPTY_MANDATORY_CHECK_TITLE");}M.show(this._sMandatoryErrorMessage,{icon:M.Icon.ERROR,title:this._sMandatoryTitle,styleClass:!!(this.$()&&this.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact":""});if(this._bExpandAdvancedFilterArea&&this.rerenderFilters){this.rerenderFilters(true);}}return e;};d.prototype._validateMandatoryFields=function(){var f=true,e=this.determineMandatoryFilterItems(),o,D=this.getFilterData(),L=0,g;this._bExpandAdvancedFilterArea=false;if(e&&D){L=e.length;while(L--){o=e[L];g=this.determineControlByFilterItem(o);if(g&&g.setValueState){if(this._checkForValues(D,o,g)){g.setValueState(sap.ui.core.ValueState.None);}else{f=false;g.setValueState(sap.ui.core.ValueState.Error);if(o.getGroupName){this._bExpandAdvancedFilterArea=true;}}}}}return f;};d.prototype._createVariantManagement=function(){this._oSmartVariantManagement=null;if(this.getAdvancedMode()){return F.prototype._createVariantManagement.apply(this);}this._oSmartVariantManagement=new S({showExecuteOnSelection:true,showShare:false});return this._oSmartVariantManagement;};d.prototype._initializeVariantManagement=function(){if(!this.isRunningInValueHelpDialog&&this._oSmartVariantManagement&&this.getPersistencyKey()){var p=new P({type:"filterBar",keyName:"persistencyKey",dataSource:this.getEntityType()});p.setControl(this);this._oSmartVariantManagement.addPersonalizableControl(p);var v=this._checkHasValueData(this.data("executeStandardVariantOnSelect"));if(v){this._oSmartVariantManagement._executeOnSelectForStandardVariant(v);}F.prototype._initializeVariantManagement.apply(this,arguments);}else{this.fireInitialise();}};d.prototype.getBasicSearchControl=function(){return this.getControlByKey(c.BASIC_SEARCH_FIELD_ID);};d.prototype.addFieldToAdvancedArea=function(k){var f;f=this._getFilterItemByName(k);if(f&&f.setVisibleInAdvancedArea){f.setVisibleInAdvancedArea(true);}};d.prototype.destroy=function(){F.prototype.destroy.apply(this,arguments);if(this._oFilterProvider&&this._oFilterProvider.destroy){this._oFilterProvider.destroy();}this._oFilterProvider=null;this._aFilterBarViewMetadata=null;this._bExpandAdvancedFilterArea=null;this._oResourceBundle=null;this._sMandatoryErrorMessage=null;this._sMandatoryTitle=null;this._oSmartVariantManagement=null;};return d;},true);
