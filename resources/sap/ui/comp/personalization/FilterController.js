/*
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/P13nFilterItem','sap/m/P13nFilterPanel','./BaseController'],function(q,P,c,B){"use strict";var F=B.extend("sap.ui.comp.personalization.FilterController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.filter);},metadata:{events:{afterFilterModelDataChange:{}}}});F.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(t instanceof sap.ui.table.Table){t.detachFilter(this._onFilter,this);t.attachFilter(this._onFilter,this);}};F.prototype.getTitleText=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("PERSODIALOG_TAB_FILTER");};F.prototype.createTableRestoreJson=function(){this.setPersistentDataRestore(this.createPersistentStructure());};F.prototype.syncTable2PersistentModel=function(){};F.prototype.syncTable2TransientModel=function(){var t=this.getTable();var i=[];if(t){if(t instanceof sap.ui.table.Table){t.getColumns().forEach(function(C){if(sap.ui.comp.personalization.Util.isFilterable(C)){i.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(C),text:C.getLabel().getText(),tooltip:(C.getTooltip()instanceof sap.ui.core.TooltipBase)?C.getTooltip().getTooltip_Text():C.getTooltip_Text(),maxLength:sap.ui.comp.personalization.Util._getCustomProperty(C,"maxLength"),type:sap.ui.comp.personalization.Util.getColumnType(C)});}},this);}if(t instanceof sap.m.Table){t.getColumns().forEach(function(C){if(sap.ui.comp.personalization.Util.isFilterable(C)){i.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(C),text:C.getHeader().getText(),tooltip:(C.getHeader().getTooltip()instanceof sap.ui.core.TooltipBase)?C.getHeader().getTooltip().getTooltip_Text():C.getHeader().getTooltip_Text(),maxLength:sap.ui.comp.personalization.Util._getCustomProperty(C,"maxLength"),type:sap.ui.comp.personalization.Util.getColumnType(C)});}},this);}}var l;try{l=sap.ui.getCore().getConfiguration().getLocale().toString();}catch(e){l=null;}if(l){i.sort(function(a,b){return a.text.localeCompare(b.text,l,{numeric:true});});}var I=this.getModel().getData().transientData.filter.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel().getData().transientData.filter.items=i;}};F.prototype._onFilter=function(e){};F.prototype._hasTableFilterableColumns=function(){var t=this.getTable();if(!t){return false;}var h=false;t.getColumns().some(function(C){if(sap.ui.comp.personalization.Util.isFilterable(C)){h=true;return true;}});return h;};F.prototype.getPanel=function(p){if(!this._hasTableFilterableColumns()){return null;}if(p&&p.column){var C=sap.ui.comp.personalization.Util.getColumnKey(p.column);if(C){var i=this.getModel().getData().transientData.filter.items;i.forEach(function(I,a){I["isDefault"]=I.columnKey===C;},this);}}var t=this;var o=new c({containerQuery:true,layoutMode:"Desktop",type:sap.m.P13nPanelType.filter,title:this.getTitleText(),items:{path:"/transientData/filter/items",template:new sap.m.P13nItem({columnKey:"{columnKey}",text:"{text}",tooltip:"{tooltip}",maxLength:"{maxLength}",type:"{type}",isDefault:"{isDefault}"})},filterItems:{path:"/persistentData/filter/filterItems",factory:function(I,a){var f=a.getProperty(a.sPath);var v,V,b;v=f.value1;V=f.value2;if(v instanceof Date){b=sap.ui.core.format.DateFormat.getDateInstance();}else if(typeof v==="number"){b=sap.ui.core.format.NumberFormat.getFloatInstance();}if(b){v=v?b.format(v):v;V=V?b.format(V):V;}return new P({key:f.key,columnKey:f.columnKey,exclude:f.exclude,operation:f.operation,value1:v,value2:V});}},beforeNavigationTo:t.setModelFunction(t.getModel())});o.attachUpdateFilterItem(function(e){var d=this.getModel().getData();var a=e.getParameters();var f=a.filterItemData;d.persistentData.filter.filterItems.some(function(b,I){if(b.key===a.key){d.persistentData.filter.filterItems[I]=f;return true;}return false;},this);},this);o.attachAddFilterItem(function(e){var d=this.getModel().getData();var a=e.getParameters();var f=a.filterItemData;d.persistentData.filter.filterItems.forEach(function(b,I){if(b.key===a.key){d.persistentData.filter.filterItems[I]=f;f=null;}},this);if(f){d.persistentData.filter.filterItems.push(f);}this.getModel().setData(d,true);},this);o.attachRemoveFilterItem(function(e){var a=e.getParameters();var d=this.getModel().getData();d.persistentData.filter.filterItems.some(function(f,I){if(f.key===a.key){d.persistentData.filter.filterItems.splice(I,1);this.getModel().setData(d,true);return true;}return false;},this);},this);return o;};F.prototype.syncJsonModel2Table=function(j){var t=this.getTable();var C=t.getColumns();var a=q.extend(true,[],C);this.fireBeforePotentialTableChange();if(t instanceof sap.ui.table.Table){j.filter.filterItems.forEach(function(f){var o=sap.ui.comp.personalization.Util.getColumn(f.columnKey,C);if(o){if(!o.getFiltered()){o.setFiltered(true);}a.splice(a.indexOf(o),1);}});a.forEach(function(o){if(o&&o.getFiltered()){o.setFiltered(false);}});}this.fireAfterPotentialTableChange();};F.prototype.getChangeType=function(p,o){if(!o||!o.filter||!o.filter.filterItems){return sap.ui.comp.personalization.Controller.ChangeType.Unchanged;}var i=JSON.stringify(p.filter.filterItems)!==JSON.stringify(o.filter.filterItems);return i?sap.ui.comp.personalization.Controller.ChangeType.ModelChanged:sap.ui.comp.personalization.Controller.ChangeType.Unchanged;};F.prototype.getChangeData=function(p,o){if(!p||!p.filter||!p.filter.filterItems){return this.createPersistentStructure();}if(!o||!o.filter||!o.filter.filterItems){return{filter:sap.ui.comp.personalization.Util.copy(p.filter)};}if(JSON.stringify(p.filter.filterItems)!==JSON.stringify(o.filter.filterItems)){return{filter:sap.ui.comp.personalization.Util.copy(p.filter)};}return null;};F.prototype.getUnionData=function(p,o){if(!p||!p.filter||!p.filter.filterItems){return this.createPersistentStructure();}if(!o||!o.filter||!o.filter.filterItems){return{filter:sap.ui.comp.personalization.Util.copy(p.filter)};}return{filter:sap.ui.comp.personalization.Util.copy(o.filter)};};F.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(t&&t instanceof sap.ui.table.Table){t.detachFilter(this._onFilter,this);}};return F;},true);
