/*
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/P13nColumnsPanel','./BaseController'],function(q,P,B){"use strict";var C=B.extend("sap.ui.comp.personalization.ColumnsController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.columns);},metadata:{events:{afterColumnsModelDataChange:{}}}});C.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(t instanceof sap.ui.table.Table){t.detachColumnMove(this._onColumnMove,this);t.detachColumnVisibility(this._onColumnVisibility,this);t.detachColumnResize(this._onColumnResize,this);t.attachColumnMove(this._onColumnMove,this);t.attachColumnVisibility(this._onColumnVisibility,this);t.attachColumnResize(this._onColumnResize,this);}};C.prototype.getTitleText=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("PERSODIALOG_TAB_COLUMNS");};C.prototype.reducePersistentModel=function(){this.syncTable2PersistentModel();};C.prototype._getTable2Json=function(){var j=this.createPersistentStructure();var t=this.getTable();if(t){t.getColumns().forEach(function(c,i){j.columns.columnsItems.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(c),index:(c.getOrder?c.getOrder():i),visible:c.getVisible(),width:c.getWidth()});},this);}return j;};C.prototype.syncTable2PersistentModel=function(){B.prototype.syncTable2PersistentModel.apply(this,arguments);var d=this.getModel().getData();var D=this.getChangeData(d.persistentData,this.getTableRestoreJson());if(D){d.persistentData.columns=D.columns;}else{d.persistentData.columns.columnsItems=[];}};C.prototype.syncTable2TransientModel=function(){this._syncTable2TransientModel();};C.prototype._syncTable2TransientModel=function(){var t=this.getTable();var i=[];if(t){if(t instanceof sap.ui.table.Table){t.getColumns().forEach(function(o){if(sap.ui.comp.personalization.Util.getColumnKey(o)){i.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(o),text:o.getLabel().getText(),tooltip:(o.getTooltip()instanceof sap.ui.core.TooltipBase)?o.getTooltip().getTooltip_Text():o.getTooltip_Text(),visible:o.getVisible(),width:o.getWidth()});}},this);}else{if(t instanceof sap.m.Table){var c=t.getColumns();c.sort(function(a,b){var d=a.getOrder();var e=b.getOrder();if(d<e){return-1;}if(d>e){return 1;}return 0;});c.forEach(function(o){if(sap.ui.comp.personalization.Util.getColumnKey(o)){i.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(o),text:o.getHeader().getText(),tooltip:(o.getHeader().getTooltip()instanceof sap.ui.core.TooltipBase)?o.getHeader().getTooltip().getTooltip_Text():o.getHeader().getTooltip_Text(),visible:o.getVisible(),width:o.getWidth()});}});}}}var I=this.getModel().getData().transientData.columns.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel().getData().transientData.columns.items=i;}};C.prototype._setNewColumnItemIndex=function(d,c,n){var i=-1;if(c&&n!==null&&n!==undefined&&n>-1){i=sap.ui.comp.personalization.Util.getIndexByKey(d.persistentData.columns.columnsItems,sap.ui.comp.personalization.Util.getColumnKey(c));if(i>-1){d.persistentData.columns.columnsItems[i].index=n;}else{d.persistentData.columns.columnsItems.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(c),index:n});}}};C.prototype._onColumnMove=function(e){var i=0,n=null,t=null;var T=null,d=null,c=null;var N=null,o=null;c=e.getParameter("column");N=e.getParameter("newPos");this.fireBeforePotentialTableChange();if(c){T=this.getTable();o=T.indexOfColumn(c);}if(o!==null&&N!==null){d=this.getModel().getData();if(o>N){for(i=N;i<=o;i++){if(i<o){t=T.getColumns()[i];n=i+1;}else{t=c;n=e.getParameter("newPos");}this._setNewColumnItemIndex(d,t,n);}}else{for(i=o;i<=N;i++){if(i===o){t=c;n=e.getParameter("newPos");}else{t=T.getColumns()[i];n=i-1;}this._setNewColumnItemIndex(d,t,n);}}this.getModel().setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();}};C.prototype._onColumnVisibility=function(e){var d=this.getModel().getData();var c=e.getParameter("column");var v=e.getParameter("newVisible");this.fireBeforePotentialTableChange();var i=sap.ui.comp.personalization.Util.getIndexByKey(d.persistentData.columns.columnsItems,sap.ui.comp.personalization.Util.getColumnKey(c));if(i>-1){d.persistentData.columns.columnsItems[i].visible=v;}else{d.persistentData.columns.columnsItems.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(c),visible:v});}this.getModel().setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnResize=function(e){var c=e.getParameter("column");var d=this.getModel().getData();this.fireBeforePotentialTableChange();var i=sap.ui.comp.personalization.Util.getIndexByKey(d.persistentData.columns.columnsItems,sap.ui.comp.personalization.Util.getColumnKey(c));if(i>-1){d.persistentData.columns.columnsItems[i].width=e.getParameter("width");}else{d.persistentData.columns.columnsItems.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(c),width:e.getParameter("width")});}this.getModel().setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype.getPanel=function(p){var t=this;var v=-1;if(p&&p.visibleItemsThreshold){v=p.visibleItemsThreshold;}var o=new P({title:this.getTitleText(),type:sap.m.P13nPanelType.columns,visibleItemsThreshold:v,items:{path:'/transientData/columns/items',template:new sap.m.P13nItem({columnKey:"{columnKey}",text:'{text}',visible:'{visible}',tooltip:'{tooltip}',width:"{width}"})},columnsItems:{path:"/persistentData/columns/columnsItems",template:new sap.m.P13nColumnsItem({columnKey:"{columnKey}",index:"{index}",visible:"{visible}",width:"{width}"})},beforeNavigationTo:t.setModelFunction(t.getModel())});o.attachChangeColumnsItems(function(e){var d=this.getModel().getData();var n=e.getParameter('newItems');var E=e.getParameter('existingItems');var c=null,s=null;if(n){n.forEach(function(N){c={columnKey:N.getColumnKey()};if(N.getIndex()!==undefined){c.index=N.getIndex();}if(N.getVisible()!==undefined){c.visible=N.getVisible();}if(N.getWidth()!==undefined){c.width=N.getWidth();}d.persistentData.columns.columnsItems.push(c);});}if(E){E.forEach(function(a){c=null;s=a.getColumnKey();c=sap.ui.comp.personalization.Util.getArrayElementByKey("columnKey",s,d.persistentData.columns.columnsItems);if(c){if(a.getIndex()!==undefined){c.index=a.getIndex();}if(a.getVisible()!==undefined){c.visible=a.getVisible();}if(a.getWidth()!==undefined){c.width=a.getWidth();}}});}},this);o.attachSetData(function(){var d=this.getModel().getData();this.getModel().setData(d);},this);this._correctColumnsItemsInPersistentData();return o;};C.prototype.onAfterReset=function(p){var o=null;if(p&&p.columns&&p.columns.oPanel){o=p.columns.oPanel;o.reInitialize();}};C.prototype.onAfterSubmit=function(p){this._correctColumnsItemsInPersistentData(p);B.prototype.onAfterSubmit.apply(this,arguments);};C.prototype._correctColumnsItemsInPersistentData=function(p){this._removeIndexFromInvisibleColumnsItems();this._removeEmptyColumnsItems();if(p){this._correctColumnsItemIndexesBasedOnPayload(p);}};C.prototype._correctColumnsItemIndexesBasedOnPayload=function(p){var c=this.getModel().getData().persistentData.columns.columnsItems;var o=null,i=null,s=null,r=-1;if(c&&c.length>0){if(p&&p.columns&&p.columns.tableItemsChanged){p.columns.selectedItems.forEach(function(S,a){i=o=null;s=S.columnKey;o=sap.ui.comp.personalization.Util.getArrayElementByKey("columnKey",s,c);if(o&&o.index!==undefined&&o.index!==null){i=o.index;}if(i===null||i===undefined){i=a;}if(i<=r){i=r+1;}if(Math.abs(i-r)>1){i=r+1;}if(o){o.index=i;}else{o={"columnKey":s,"index":i};c.push(o);}r=i;});}}};C.prototype._removeEmptyColumnsItems=function(){var c=this.getModel().getData().persistentData.columns.columnsItems;var i=0,l=0,o=null;if(c&&c.length){l=c.length;for(i=0;i<l;i++){o=c[i];if(o){if(o.index!==null&&o.index!==undefined){continue;}if(o.visible!==null&&o.visible!==undefined){continue;}if(o.width!==null&&o.width!==undefined){continue;}c.splice(i,1);i-=1;}}}};C.prototype._removeIndexFromInvisibleColumnsItems=function(){var c=null,i=null,I=null,a=0;var p=this.getModel().getData().persistentData;var t=this.getModel().getData().transientData;var v=null;if(p&&p.columns&&p.columns.columnsItems){c=p.columns.columnsItems;this._sortArrayByPropertyName(c,"index");}if(t&&t.columns&&t.columns.items){i=t.columns.items;}if(c&&c.length){c.forEach(function(o){I=v=null;if(o.index!==undefined){v=o.visible;if(v===undefined||v===null){I=sap.ui.comp.personalization.Util.getArrayElementByKey("columnKey",o.columnKey,i);if(I&&I.visible!==undefined){v=I.visible;}}if(v===false){delete o.index;a+=1;}else{if(o.index>0&&o.index>=a){o.index-=a;}}}});}};C.prototype.syncJsonModel2Table=function(j){var t=this.getTable();var i=j.columns.columnsItems;this.fireBeforePotentialTableChange();if(t instanceof sap.ui.table.Table){this._applyChangesToUiTableType(t,i);}else if(t instanceof sap.m.Table){this._applyChangesToMTableType(t,i);}this.fireAfterPotentialTableChange();};C.prototype._applyChangesToUiTableType=function(t,c){var d=null,T=null;var f=t.getFixedColumnCount();var F=f===0?f:f-1;var s=function(o,T){var i=t.indexOfColumn(T);var m=o.index;if(m!==undefined&&i!==m){t.removeColumn(T);t.insertColumn(T,m);if(!(i>F&&m>F)){t.setFixedColumnCount(0);}}};var S=function(o,T){if(o.visible!==undefined&&T.getVisible()!==o.visible){T.setVisible(o.visible);}};var e=function(o,T){if(o.width!==undefined&&T.getWidth()!==o.width){T.setWidth(o.width);}};if(c.length){d=t.getColumns();c.sort(function(a,b){if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;});c.forEach(function(o){T=sap.ui.comp.personalization.Util.getColumn(o.columnKey,d);if(T){s(o,T);S(o,T);e(o,T);}});}};C.prototype._applyChangesToMTableType=function(t,c){var T=null,d=false;var e=t.getColumns();var s=function(o,T){var m=o.index;if(m!==undefined){T.setOrder(m);d=true;}};var S=function(o,T){if(o.visible!==undefined&&T.getVisible()!==o.visible){T.setVisible(o.visible);}};if(c.length){e=t.getColumns();c.sort(function(a,b){if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;});c.forEach(function(o){T=sap.ui.comp.personalization.Util.getColumn(o.columnKey,e);if(T){s(o,T);S(o,T);}});}if(d){t.rerender();}};C.prototype.getChangeType=function(p,o){var c=this.getChangeData(p,o);if(c){var a=sap.ui.comp.personalization.Controller.ChangeType.TableChanged;c.columns.columnsItems.some(function(i){if(i.visible||i.visible===false){a=sap.ui.comp.personalization.Controller.ChangeType.ModelChanged;return true;}});return a;}return sap.ui.comp.personalization.Controller.ChangeType.Unchanged;};C.prototype.getChangeData=function(p,o){if(!o||!o.columns||!o.columns.columnsItems){return null;}var c={columns:sap.ui.comp.personalization.Util.copy(p.columns)};var i=true;p.columns.columnsItems.some(function(I){var a=sap.ui.comp.personalization.Util.getArrayElementByKey("columnKey",I.columnKey,o.columns.columnsItems);if(!sap.ui.comp.personalization.Util.semanticEqual(I,a)){i=false;return true;}});if(i){return null;}var t=[];c.columns.columnsItems.forEach(function(I,a){var b=sap.ui.comp.personalization.Util.getArrayElementByKey("columnKey",I.columnKey,o.columns.columnsItems);if(sap.ui.comp.personalization.Util.semanticEqual(I,b)){t.push(I);return;}for(var d in I){if(d==="columnKey"||!b){if(b&&b[d]===undefined){delete I[d];}else{continue;}}if(I[d]===b[d]){delete I[d];}}if(Object.keys(I).length<2){t.push(I);}});t.forEach(function(I){var a=sap.ui.comp.personalization.Util.getIndexByKey(c.columns.columnsItems,I.columnKey);c.columns.columnsItems.splice(a,1);});return c;};C.prototype._sortArrayByPropertyName=function(A,p,t){var s=[];if(t===null||t===undefined){t=false;}if(A&&A.length>0&&p!==undefined&&p!==null&&p!==""){if(t){s=q.extend(true,[],A);}else{s=A;}s.sort(function(a,b){var c=a[p];var d=b[p];if(c<d||(c!==undefined&&d===undefined)){return-1;}if(c>d||(c===undefined&&d!==undefined)){return 1;}return 0;});}return s;};C.prototype._recalculateIndexes=function(o,s,e){var m=null,M=null,i=null;if(!o||!o.length){return;}i=o.length-1;if(s===null||s===undefined||s<0||e===null||e===undefined||e<0||e>i||s===e){return;}m=Math.min(s,e);M=Math.max(s,e);o.forEach(function(O,I){if(I<m||I>M||I>i){return;}if(s>e){O.index+=1;}else{O.index-=1;}});};C.prototype.getUnionData=function(p,o){if(!o||!o.columns||!o.columns.columnsItems||o.columns.columnsItems.length===0){return p.columns?{columns:q.extend(true,{},p.columns)}:null;}if(!p||!p.columns||!p.columns.columnsItems){return{columns:q.extend(true,{},o.columns)};}var d=[];var u=this.createPersistentStructure();p.columns.columnsItems.forEach(function(c,i){var a=sap.ui.comp.personalization.Util.getArrayElementByKey("columnKey",c.columnKey,o.columns.columnsItems);if(a){if(a.visible!==undefined){c.visible=a.visible;}if(a.width!==undefined){c.width=a.width;}if(a.index!==undefined){c.index=a.index;d.push(c);return;}}u.columns.columnsItems.push(c);});if(d&&d.length>0){this._sortArrayByPropertyName(d,"index");d.forEach(function(D){u.columns.columnsItems.splice(D.index,0,D);});}u.columns.columnsItems.forEach(function(c,i){c.index=i;});return u;};C.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(t&&t instanceof sap.ui.table.Table){t.detachColumnMove(this._onColumnMove,this);t.detachColumnVisibility(this._onColumnVisibility,this);t.detachColumnResize(this._onColumnResize,this);}};return C;},true);
