/*
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','./ColumnsController','./FilterController','./GroupController','./SortController','./Util'],function(q,M,C,F,G,S,U){"use strict";var a=M.extend("sap.ui.comp.personalization.Controller",{constructor:function(i,s){M.apply(this,arguments);},metadata:{publicMethods:["setPersonalizationData"],properties:{setting:{type:"object",defaultValue:null},resetToInitialTableState:{type:"boolean",defaultValue:true}},associations:{table:{type:"sap.ui.core.Control",multiple:false}},events:{beforePotentialTableChange:{},afterPotentialTableChange:{},afterP13nModelDataChange:{parameters:{changeReason:{type:"sap.ui.comp.personalization.Controller.ChangeReason"},persistentData:{type:"object"},changeData:{type:"object"},changeType:{type:"sap.ui.comp.personalization.Controller.ChangeType"},changeTypeVariant:{type:"sap.ui.comp.personalization.Controller.ChangeType"}}}},library:"sap.ui.comp"}});a.prototype.setSetting=function(s){s=this.validateProperty("setting",s);this.setProperty("setting",s,true);if(!s){return this;}this._checkIfGroupingAllowed();this._oSettingCurrent=U.copy(this._oSettingOriginal);for(var t in s){if(s[t].visible===false){delete this._oSettingCurrent[t];continue;}if(s[t].visible&&this._oSettingCurrent[t]&&this._oSettingCurrent[t].visible){this._oSettingCurrent[t].controller=s[t].controller?s[t].controller:this._oSettingCurrent[t].controller;if(s[t].payload){this._oSettingCurrent[t].payload=s[t].payload;}}}this._masterSync(a.SyncReason.NewSetting,null);return this;};a.prototype.setTable=function(t){this.setAssociation("table",t);if(!t){return this;}this._checkIfGroupingAllowed();var c=this.getTable().getColumns();if(!U.isConsistent(c)){throw"The table instance provided contain some columns for which a columnKey is provided, some for which a columnKey is not provided. This is not allowed ! ";}this._masterSync(a.SyncReason.NewTable,null);return this;};a.prototype.getTable=function(){var t=this.getAssociation("table");if(typeof t==="string"){t=sap.ui.getCore().byId(t);}return t;};a.prototype.getModel=function(){return this._oModel;};a.prototype.init=function(){var t=this;this._oDialog=null;this._oPayload=null;this._oPersistentDataRestore=null;this._oPersistentDataCurrentVariant=null;this._oPersistentDataAlreadyKnown=null;this._oPersistentDataBeforeOpen=null;this._oModel=null;this._oSettingOriginal={columns:{controller:new C({afterColumnsModelDataChange:function(e){t._fireChangeEvent();},beforePotentialTableChange:function(e){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(e){t.fireAfterPotentialTableChange();}}),visible:true},sort:{controller:new S({afterSortModelDataChange:function(e){t._fireChangeEvent();},beforePotentialTableChange:function(e){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(e){t.fireAfterPotentialTableChange();}}),visible:true},filter:{controller:new F({afterFilterModelDataChange:function(e){t._fireChangeEvent();},beforePotentialTableChange:function(e){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(e){t.fireAfterPotentialTableChange();}}),visible:true},group:{controller:new G({afterGroupModelDataChange:function(e){t._fireChangeEvent();},beforePotentialTableChange:function(e){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(e){t.fireAfterPotentialTableChange();}}),visible:true}};this._oSettingCurrent=U.copy(this._oSettingOriginal);this._oInitialVisiblePanelType=this._getInitialVisiblePanelType();};a.prototype._checkIfGroupingAllowed=function(){var t=this.getTable();if(t&&t instanceof sap.ui.table.Table&&!(t instanceof sap.ui.table.AnalyticalTable)){delete this._oSettingCurrent.group;}};a.prototype.openDialog=function(s){this._oDialog=new sap.m.P13nDialog({stretch:sap.ui.Device.system.phone,showReset:true,initialVisiblePanelType:this._oInitialVisiblePanelType});this._oDialog.toggleStyleClass("sapUiSizeCompact",!!q(this.getTable().getDomRef()).closest(".sapUiSizeCompact").length);var o=this._mixSetting(this._oSettingCurrent,s);var p=this._callControllers(o,"getPanel");for(var t in o){if(p[t]){this._oDialog.addPanel(p[t]);}}this._oPersistentDataBeforeOpen=this._getPersistentDataCopy();this._oDialog.attachOk(this._handleDialogOk,this);this._oDialog.attachCancel(this._handleDialogCancel,this);this._oDialog.attachReset(this._handleDialogReset,this);this._oDialog.attachAfterClose(this._handleDialogAfterClose,this);this._oDialog.open();};a.prototype._mixSetting=function(s,o){if(!o){return s;}for(var t in o){if(o[t].visible&&s[t]&&s[t].visible){o[t].controller=s[t].controller;if(!o[t].payload){o[t].payload=s[t].payload;}}}return o;};sap.ui.comp.personalization.Controller.prototype._getSettingOfVisiblePanels=function(){if(!this._oDialog){return;}var s={};this._oDialog.getPanels().forEach(function(p){var t=p.getType();s[t]={controller:this._oSettingCurrent[t].controller,visible:p.getVisible()};},this);return s;};a.prototype._getPersistentDataCopy=function(){var p={};if(this.getModel()&&this.getModel().getData().persistentData){p=U.copy(this.getModel().getData().persistentData);}return p;};a.prototype.setPersonalizationData=function(n){if(!this._sanityCheck(n)){return;}var c=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(n));this._masterSync(a.SyncReason.NewModelData,c);if(this.getTable()&&this.getTable().setFixedColumnCount){this.getTable().setFixedColumnCount(0);}this._fireChangeEvent();};a.prototype._handleDialogReset=function(e){if(this.getResetToInitialTableState()){this._masterSync(a.SyncReason.ResetModelData,null);}else{this._masterSync(a.SyncReason.ResetModelDataVariant,null);}this._callControllers(this._getSettingOfVisiblePanels(),"onAfterReset",e.getParameter("payload"));};a.prototype._handleDialogCancel=function(e){this._oDialog.detachCancel(this._handleDialogCancel,this);this._oInitialVisiblePanelType=this._oDialog.getVisiblePanel()?this._oDialog.getVisiblePanel().getType():this._getInitialVisiblePanelType();this._oDialog.close();};a.prototype._handleDialogOk=function(e){this._oDialog.detachOk(this._handleDialogOk,this);this._oPayload={trigger:"ok",payload:e.getParameter("payload")};this._oInitialVisiblePanelType=this._oDialog.getVisiblePanel()?this._oDialog.getVisiblePanel().getType():this._getInitialVisiblePanelType();this._oDialog.close();};a.prototype._getInitialVisiblePanelType=function(){for(var t in this._oSettingCurrent){return t;}};a.prototype._handleDialogAfterClose=function(){var t=this;var _=this._oPayload;if(_&&_.trigger==="ok"){setTimeout(function(){var s=t._getSettingOfVisiblePanels();if(t._oDialog){t._oDialog.destroy();t._oDialog=null;}t._callControllers(s,"onAfterSubmit",t._oPayload.payload);t._oPayload=null;t._fireChangeEvent();t._oPersistentDataBeforeOpen=null;},0);}else{setTimeout(function(){if(t._oDialog){t._oDialog.destroy();t._oDialog=null;}t._masterSync(a.SyncReason.NewModelData,t._oPersistentDataBeforeOpen);t._oPersistentDataBeforeOpen=null;},0);}};a.prototype._masterSync=function(u,n){var t=null,j=null;switch(u){case a.SyncReason.NewTable:this.initializeModel();this._callControllers(this._oSettingCurrent,"setTable",this.getTable());this._callControllers(this._oSettingCurrent,"createTableRestoreJson");this.getModel().setSizeLimit(this.getTable().getColumns().length+1000);this._callControllers(this._oSettingCurrent,"syncTable2PersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");j=this._callControllers(this._oSettingCurrent,"getTableRestoreJson");this._oPersistentDataRestore=U.copy(j);this._oPersistentDataCurrentVariant=this._getPersistentDataCopy();this._oPersistentDataAlreadyKnown=U.copy(this._oPersistentDataRestore);break;case a.SyncReason.NewSetting:this.initializeModel();if(this.getTable()){this._callControllers(this._oSettingCurrent,"setTable",this.getTable());this.getModel().setSizeLimit(this.getTable().getColumns().length+1000);}this._callControllers(this._oSettingCurrent,"createTableRestoreJson");this._callControllers(this._oSettingCurrent,"syncTable2PersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");j=this._callControllers(this._oSettingCurrent,"getTableRestoreJson");this._oPersistentDataRestore=U.copy(j);this._oPersistentDataCurrentVariant=this._getPersistentDataCopy();this._oPersistentDataAlreadyKnown=U.copy(this._oPersistentDataRestore);for(t in this._oPersistentDataRestore){if(!this._oSettingCurrent[t]){delete this._oPersistentDataRestore[t];}}for(t in this._oPersistentDataAlreadyKnown){if(!this._oSettingCurrent[t]){delete this._oPersistentDataAlreadyKnown[t];}}for(t in this._oPersistentDataCurrentVariant){if(!this._oSettingCurrent[t]){delete this._oPersistentDataCurrentVariant[t];}}break;case a.SyncReason.NewModelData:this.initializeModel(n);var p=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(n));this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",p);this._callControllers(this._oSettingCurrent,"reducePersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");this._oPersistentDataCurrentVariant=this._getPersistentDataCopy();break;case a.SyncReason.ResetModelData:this.initializeModel(this._oPersistentDataRestore);this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",U.copy(this._oPersistentDataRestore));this._callControllers(this._oSettingCurrent,"reducePersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");this._oPersistentDataCurrentVariant=this._getPersistentDataCopy();break;case a.SyncReason.ResetModelDataVariant:this.initializeModel(this._oPersistentDataCurrentVariant);var P=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(this._oPersistentDataCurrentVariant));this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",P);this._callControllers(this._oSettingCurrent,"reducePersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");break;}this.getModel().refresh();};a.prototype.initializeModel=function(n){if(!this.getModel()){this._oModel=new sap.ui.model.json.JSONModel();this._oModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);}var N=null;if(n){N=U.copy(n);}var c=N||((this.getModel().getData()&&this.getModel().getData().persistentData)?this.getModel().getData().persistentData:{});for(var t in c){if(!this._oSettingCurrent[t]){delete c[t];}}this.getModel().setData({transientData:{},persistentData:c});this._callControllers(this._oSettingCurrent,"initializeModel",this.getModel());};a.prototype._fireChangeEvent=function(c){var o={};var p=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),this._getPersistentDataCopy());var b=this._callControllers(this._oSettingCurrent,"getChangeType",p,U.copy(this._oPersistentDataAlreadyKnown));if(!U.hasChangedType(b)){return;}if(c===a.ChangeReason.ResetFull||c===a.ChangeReason.ResetPartial){o.changeReason=c;}var P=U.copy(this._oPersistentDataAlreadyKnown);o.changeType=this._callControllers(this._oSettingCurrent,"getChangeType",p,P);o.changeData=this._callControllers(this._oSettingCurrent,"getChangeData",p,P);var d=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(this._oPersistentDataCurrentVariant));o.changeTypeVariant=this._callControllers(this._oSettingCurrent,"getChangeType",p,d);var e=U.copy(this._oPersistentDataRestore);o.persistentData=this._callControllers(this._oSettingCurrent,"getChangeData",p,e);this.fireAfterP13nModelDataChange(o);this._oPersistentDataAlreadyKnown=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataAlreadyKnown),U.copy(o.changeData));};a.prototype.resetPersonalization=function(){if(this.getResetToInitialTableState()){this._masterSync(a.SyncReason.ResetModelData,null);this._fireChangeEvent(sap.ui.comp.personalization.Controller.ChangeReason.ResetFull);}else{this._masterSync(a.SyncReason.ResetModelDataVariant,null);this._fireChangeEvent(sap.ui.comp.personalization.Controller.ChangeReason.ResetPartial);}};a.prototype._getArgumentsByType=function(A,t){var r=[],o=null;if(A&&A.length&&t){A.forEach(function(b){if(b&&b[t]&&typeof b[t]!=="function"){o={};o[t]=b[t];r.push(o);}else{r.push(b);}});}return r;};a.prototype._callControllers=function(s,m){var t=null,o=null,c=null,A=null;var r={},b=Array.prototype.slice.call(arguments,2);for(t in s){o=c=A=null;o=s[t];c=o.controller;if(!c||!o.visible||!c[m]){continue;}A=this._getArgumentsByType(b,t);if(m==="getPanel"){A.push(o.payload);}var R=c[m].apply(c,A);if(R!==null&&R!==undefined){if(R[t]!==undefined){r[t]=R[t];}else{r[t]=R;}}}return r;};a.prototype._sanityCheck=function(n){if(!n){return false;}return true;};a.prototype.exit=function(){var t;if(this._oDialog){this._oDialog.destroy();this._oDialog=null;}this._callControllers(this._oSettingCurrent,"destroy");for(t in this._oSettingCurrent){this._oSettingCurrent[t]=null;}this._oSettingCurrent=null;for(t in this._oSettingOriginal){this._oSettingOriginal[t]=null;}this._oSettingOriginal=null;if(this.getModel()){this.getModel().destroy();this._oModel=null;}this._oPersistentDataRestore=null;this._oPersistentDataCurrentVariant=null;this._oPersistentDataAlreadyKnown=null;this._oPersistentDataBeforeOpen=null;this._oPayload=null;};a.ChangeType={Unchanged:0,ModelChanged:1,TableChanged:2};a.SyncReason={NewTable:0,NewSetting:1,NewModelData:2,ResetModelData:3,ResetModelDataVariant:4};a.ChangeReason={ResetFull:0,ResetPartial:1};return a;},true);
