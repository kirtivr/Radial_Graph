/*
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/P13nGroupItem','sap/m/P13nGroupPanel','./BaseController'],function(q,P,c,B){"use strict";var G=B.extend("sap.ui.comp.personalization.GroupController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.group);},metadata:{events:{afterGroupModelDataChange:{}}}});G.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(t instanceof sap.ui.table.AnalyticalTable||t instanceof sap.ui.table.Table){t.detachGroup(this._onGroup,this);t.attachGroup(this._onGroup,this);}};G.prototype.getTitleText=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("PERSODIALOG_TAB_GROUP");};G.prototype._getTable2Json=function(){var j=this.createPersistentStructure();var t=this.getTable();if(t){var C=[];if(t instanceof sap.ui.table.Table&&t.getGroupBy){C=t.getGroupBy()||[];if(typeof C==="string"){C=[C];}}if(t instanceof sap.ui.table.AnalyticalTable&&t.getGroupedColumns){C=t.getGroupedColumns()||[];}C.forEach(function(o,i){if(typeof o==="string"){o=sap.ui.getCore().byId(o);}if(o.getGrouped()){j.group.groupItems.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(o),operation:o.getSortOrder&&o.getSortOrder()===sap.ui.table.SortOrder.Ascending?sap.m.P13nConditionOperation.GroupAscending:sap.m.P13nConditionOperation.GroupDescending,showIfGrouped:o.getShowIfGrouped?o.getShowIfGrouped():false});}},this);}return j;};G.prototype.syncTable2TransientModel=function(){var t=this.getTable();var i=[];if(t){if(t instanceof sap.ui.table.AnalyticalTable||t instanceof sap.ui.table.Table){t.getColumns().forEach(function(C){if(sap.ui.comp.personalization.Util.isGroupable(C)){i.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(C),text:C.getLabel().getText(),tooltip:(C.getTooltip()instanceof sap.ui.core.TooltipBase)?C.getTooltip().getTooltip_Text():C.getTooltip_Text()});}},this);}if(t instanceof sap.m.Table){t.getColumns().forEach(function(C){if(sap.ui.comp.personalization.Util.isGroupable(C)){i.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(C),text:C.getHeader().getText(),tooltip:(C.getHeader().getTooltip()instanceof sap.ui.core.TooltipBase)?C.getHeader().getTooltip().getTooltip_Text():C.getHeader().getTooltip_Text()});}},this);}}var l;try{l=sap.ui.getCore().getConfiguration().getLocale().toString();}catch(e){l=null;}if(l){i.sort(function(a,b){return a.text.localeCompare(b.text,l,{numeric:true});});}i.splice(0,0,{key:null,text:"(none)"});var g=this.getModel().getData().transientData.group.items;if(q(i).not(g).length!==0||q(g).not(i).length!==0){this.getModel().getData().transientData.group.items=i;}};G.prototype._onGroup=function(e){var t=this.getTable();var g=e.mParameters.groupedColumns;this.fireBeforePotentialTableChange();var d=this.getModel().getData();d.persistentData.group.groupItems=[];g.forEach(function(C,i){if(typeof C==="string"){C=sap.ui.getCore().byId(C);}if(t&&t instanceof sap.ui.table.AnalyticalTable){if(C.getGrouped()){d.persistentData.group.groupItems.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(C),showIfGrouped:C.getShowIfGrouped?C.getShowIfGrouped():false});}}else if(t&&t instanceof sap.ui.table.Table){d.persistentData.group.groupItems.push({columnKey:sap.ui.comp.personalization.Util.getColumnKey(C),showIfGrouped:false});}},this);this.fireAfterPotentialTableChange();this.fireAfterGroupModelDataChange();};G.prototype._hasTableGroupableColumns=function(){var t=this.getTable();if(!t){return false;}var h=false;t.getColumns().some(function(C){if(sap.ui.comp.personalization.Util.isGroupable(C)){h=true;return true;}});return h;};G.prototype.getPanel=function(){if(!this._hasTableGroupableColumns()){return null;}var t=this;var p=new c({maxGroups:this.getTable()instanceof sap.ui.table.AnalyticalTable?"-1":"1",type:sap.m.P13nPanelType.group,title:this.getTitleText(),containerQuery:true,layoutMode:"Desktop",items:{path:"/transientData/group/items",template:new sap.m.P13nItem({columnKey:"{columnKey}",text:"{text}",tooltip:"{tooltip}"})},groupItems:{path:"/persistentData/group/groupItems",template:new P({columnKey:"{columnKey}",operation:"{operation}",showIfGrouped:"{showIfGrouped}"})},beforeNavigationTo:t.setModelFunction(t.getModel())});p.attachAddGroupItem(function(e){var d=this.getModel().getData();var a=e.getParameters();var g={columnKey:a.groupItemData.getColumnKey(),operation:a.groupItemData.getOperation(),showIfGrouped:a.groupItemData.getShowIfGrouped()};if(a.index>=0){d.persistentData.group.groupItems.splice(a.index,0,g);}else{d.persistentData.group.groupItems.push(g);}this.getModel().setData(d,true);},this);p.attachRemoveGroupItem(function(e){var a=e.getParameters();var d=this.getModel().getData();d.persistentData.group.groupItems.splice(a.index,1);},this);return p;};G.prototype.syncJsonModel2Table=function(j){var t=this.getTable();var C=t.getColumns();var a=q.extend(true,[],C);this.fireBeforePotentialTableChange();if(t instanceof sap.ui.table.AnalyticalTable){j.group.groupItems.forEach(function(g){var o=sap.ui.comp.personalization.Util.getColumn(g.columnKey,C);if(!o){return;}if(!o.getGrouped()){o.setGrouped(true);}if(o.setShowIfGrouped()!==g.showIfGrouped){o.setShowIfGrouped(g.showIfGrouped);}a.splice(a.indexOf(o),1);});a.forEach(function(o){if(o&&o.getGrouped()){o.setGrouped(false);o.setShowIfGrouped(false);}});}else if(t instanceof sap.ui.table.Table){if(j.group.groupItems.length>0){j.group.groupItems.some(function(g){var o=sap.ui.comp.personalization.Util.getColumn(g.columnKey,C);if(o){t.setGroupBy(o);return true;}return false;},this);}else{t.setGroupBy(null);}}this.fireAfterPotentialTableChange();};G.prototype.getChangeType=function(p,o){if(!o||!o.group||!o.group.groupItems){return sap.ui.comp.personalization.Controller.ChangeType.Unchanged;}var i=JSON.stringify(p.group.groupItems)!==JSON.stringify(o.group.groupItems);return i?sap.ui.comp.personalization.Controller.ChangeType.ModelChanged:sap.ui.comp.personalization.Controller.ChangeType.Unchanged;};G.prototype.getChangeData=function(p,o){if(!p||!p.group||!p.group.groupItems){return this.createPersistentStructure();}if(!o||!o.group||!o.group.groupItems){return{group:sap.ui.comp.personalization.Util.copy(p.group)};}if(JSON.stringify(p.group.groupItems)!==JSON.stringify(o.group.groupItems)){return{group:sap.ui.comp.personalization.Util.copy(p.group)};}return null;};G.prototype.getUnionData=function(p,o){if(!o||!o.group||!o.group.groupItems){return{group:sap.ui.comp.personalization.Util.copy(p.group)};}return{group:sap.ui.comp.personalization.Util.copy(o.group)};};G.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(t&&(t instanceof sap.ui.table.AnalyticalTable||t instanceof sap.ui.table.Table)){t.detachGroup(this._onGroup,this);}};return G;},true);
