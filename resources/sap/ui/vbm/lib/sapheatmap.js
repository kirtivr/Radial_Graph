VBI.Tex=null;VBI.Shader=null;VBI.FB=null;VBI.Vals=null;VBI.Ro=null;VBI.Hm=null;VBI.Hook=function(){if(window.WebGLRenderingContext){var g=WebGLRenderingContext.prototype.getExtension;WebGLRenderingContext.prototype.getExtension=function(n){var v=['MS','WEBKIT','MOZ','O'];var e,a;if((e=g.call(this,n))===null){for(var b=0,l=v.length;b<l;++b){a=v[b];if((e=g.call(this,a+'_'+n))!==null)return e;}return null;}else{return e;}};WebGLRenderingContext.prototype.getExtensions=function(s){var a=this.getExtension('OES_texture_float');var h=this.getExtension('OES_texture_half_float');var b=this.getExtension('OES_texture_half_floatnLLinear');var c=this.getExtension('WEBGL_color_buffer_float');return;};}}();VBI.Shader=(function(){function S(g,v,f){this.m_GL=g;this.m_UL={};this.m_Prog=this.m_GL.createProgram();this.m_VS=this.m_GL.createShader(this.m_GL.VERTEX_SHADER);this.m_FS=this.m_GL.createShader(this.m_GL.FRAGMENT_SHADER);this.m_GL.attachShader(this.m_Prog,this.m_VS);this.Compile(this.m_VS,v);this.m_GL.attachShader(this.m_Prog,this.m_FS);this.Compile(this.m_FS,f);this.Link();};S.prototype.getShaderVar=function(n){return this.m_GL.getAttribLocation(this.m_Prog,n);};S.prototype.Compile=function(s,a){this.m_GL.shaderSource(s,a);this.m_GL.compileShader(s);if(!this.m_GL.getShaderParameter(s,this.m_GL.COMPILE_STATUS))VBI.m_bTrace&&VBI.Trace("Shader Compilation Error");};S.prototype.Link=function(){this.m_GL.linkProgram(this.m_Prog);if(!this.m_GL.getProgramParameter(this.m_Prog,this.m_GL.LINK_STATUS))VBI.m_bTrace&&VBI.Trace("Shader Link Error");};S.prototype.Apply=function(){this.m_GL.useProgram(this.m_Prog);return this;};S.prototype.getLoc=function(n){var l=this.m_UL[n];if(typeof(l)==="undefined")l=this.m_UL[n]=this.m_GL.getUniformLocation(this.m_Prog,n);return l;};S.prototype.SetInt=function(n,v){this.m_GL.uniform1i(this.getLoc(n),v);return this;};S.prototype.SetV2=function(n,v){this.m_GL.uniform2f(this.getLoc(n),v[0],v[1]);};return S;})();VBI.FB=(function(){function F(g){this.m_GL=g;this.m_FB=this.m_GL.createFramebuffer();}F.prototype.destroy=function(){return this.m_GL.deleteFramebuffer(this.m_FB);};F.prototype.BindFB=function(){this.m_GL.bindFramebuffer(this.m_GL.FRAMEBUFFER,this.m_FB);return this;};F.prototype.UnBindFB=function(){this.m_GL.bindFramebuffer(this.m_GL.FRAMEBUFFER,null);return this;};F.prototype.SetTex=function(t){this.m_GL.framebufferTexture2D(this.m_GL.FRAMEBUFFER,this.m_GL.COLOR_ATTACHMENT0,this.m_GL.TEXTURE_2D,t.m_Tex,0);return this;};return F;})();VBI.Tex=(function(){function T(g,p){var t;this.m_GL=g;p=p?p:{};this.m_colFmt=this.m_GL[((t=p.colfmt)!=null?t:'rgba').toUpperCase()];if(typeof p.type==='number')this.type=p.type;else this.type=this.m_GL[((t=p.type)!=null?t:'unsigned_byte').toUpperCase()];this.m_Tex=this.m_GL.createTexture();}T.prototype.destroy=function(){return this.m_GL.deleteTexture(this.m_Tex);};T.prototype.BindTex=function(s){if(s==null)s=0;this.m_GL.activeTexture(this.m_GL.TEXTURE0+s);this.m_GL.bindTexture(this.m_GL.TEXTURE_2D,this.m_Tex);return this;};T.prototype.AdjustSize=function(w,h){this.m_W=w;this.m_H=h;this.m_GL.texImage2D(this.m_GL.TEXTURE_2D,0,this.m_colFmt,w,h,0,this.m_colFmt,this.type,null);return this;};T.prototype.SetImage=function(d){this.m_W=d.width;this.m_H=d.height;this.m_GL.texImage2D(this.m_GL.TEXTURE_2D,0,this.m_colFmt,this.m_colFmt,this.type,d);return this;};T.prototype.SetFilterNearest=function(){this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_MAG_FILTER,this.m_GL.NEAREST);this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_MIN_FILTER,this.m_GL.NEAREST);return this;};T.prototype.SetWrapEdge=function(){this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_WRAP_S,this.m_GL.CLAMP_TO_EDGE);this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_WRAP_T,this.m_GL.CLAMP_TO_EDGE);return this;};return T;})();VBI.Ro=(function(){function R(g,w,h){this.m_GL=g;this.m_W=w;this.m_H=h;this.m_GL.getExtensions();this.m_Tex=new VBI.Tex(this.m_GL,{type:36193});this.m_Tex.BindTex(0);this.m_Tex.AdjustSize(w,h);this.m_Tex.SetFilterNearest();this.m_Tex.SetWrapEdge();this.m_FB=new VBI.FB(this.m_GL);this.m_FB.BindFB();this.m_FB.SetTex(this.m_Tex);this.m_FB.UnBindFB();}R.prototype.Apply=function(){return this.m_FB.BindFB();};R.prototype.BindRo=function(s){return this.m_Tex.BindTex(s);};R.prototype.UnBindRo=function(){this.m_FB.UnBindFB();};R.prototype.AdjustSize=function(w,h){this.m_W=w;this.m_H=h;return this.m_Tex.BindTex(0).AdjustSize(w,h);};return R;})();VBI.Vals=(function(){function V(g,w,h){this.m_GL=g;this.m_nPointChunk=10240;this.m_vBufs=[];this.m_nVertexSize=8;this.m_W=w;this.m_H=h;this.m_Shader=new VBI.Shader(this.m_GL,"attribute vec4 pos, value;\nvarying vec2 off, dim;\nuniform vec2 size;\nvarying float val;\n void main(){ off = pos.zw; dim = abs(pos.zw); vec2 pos = pos.xy + pos.zw; val=value.x; gl_Position=vec4((pos/size)*2.0-1.0, 0.0, 1.0);}\n","#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp int;\n precision highp float;\n#else\n precision mediump int;\n precision mediump float;\n#endif\nvarying vec2 off, dim;\nvarying float val;\nvoid main(){ float f = (1.0-smoothstep(0.0,1.0,length(off/dim))); float tmp = f*val; gl_FragColor=vec4(tmp);}\n");this.m_Ro=new VBI.Ro(this.m_GL,this.m_W,this.m_H);this.m_VB=this.m_GL.createBuffer();this.m_vBuf=new Float32Array(this.m_nPointChunk*this.m_nVertexSize*6);for(var n=0,a=0,t=this.m_nPointChunk;0<=t?a<t:a>t;n=0<=t?++a:--a)this.m_vBufs.push(new Float32Array(this.m_vBuf.buffer,0,n*this.m_nVertexSize*6));this.m_nIdx=0;this.m_nPoints=0;};V.prototype.AdjustSize=function(w,h){this.m_W=w;this.m_H=h;this.m_Ro.AdjustSize(this.m_W,this.m_H);return;};V.prototype.Render=function(){if(this.m_nPoints>0){this.m_GL.enable(this.m_GL.BLEND);this.m_Ro.Apply();this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,this.m_VB);this.m_GL.bufferData(this.m_GL.ARRAY_BUFFER,this.m_vBufs[this.m_nPoints],this.m_GL.STREAM_DRAW);var s=this.m_Shader.getShaderVar('pos');var a=this.m_Shader.getShaderVar('value');this.m_GL.enableVertexAttribArray(1);this.m_GL.vertexAttribPointer(s,4,this.m_GL.FLOAT,false,32,0);this.m_GL.vertexAttribPointer(a,4,this.m_GL.FLOAT,false,32,16);this.m_Shader.Apply();this.m_Shader.SetV2('size',[this.m_W,this.m_H]);this.m_GL.drawArrays(this.m_GL.TRIANGLES,0,this.m_nPoints*6);this.m_GL.disableVertexAttribArray(1);this.m_Ro.UnBindRo();this.m_GL.disable(this.m_GL.BLEND);this.m_nPoints=0;this.m_nIdx=0;}};V.prototype.Clear=function(){this.m_Ro.Apply();this.m_GL.clearColor(0.0,0.0,0.0,0.0);this.m_GL.clear(this.m_GL.COLOR_BUFFER_BIT);return this.m_Ro.UnBindRo();};V.prototype.AddPoint=function(x,y,v,a){if((this.m_nPoints+1)>=this.m_nPointChunk)this.Render();y=this.m_H-y;var s=a/2;var b=this.PushVertex.bind(this);b(x,y,-s,-s,v);b(x,y,+s,-s,v);b(x,y,-s,+s,v);b(x,y,-s,+s,v);b(x,y,+s,-s,v);b(x,y,+s,+s,v);return this.m_nPoints+=1;};V.prototype.PushVertex=function(x,y,b,c,v){var a=this.m_vBuf;a[this.m_nIdx++]=x;a[this.m_nIdx++]=y;a[this.m_nIdx++]=b;a[this.m_nIdx++]=c;a[this.m_nIdx++]=a[this.m_nIdx++]=a[this.m_nIdx++]=a[this.m_nIdx++]=v;};return V;})();VBI.Hm=(function(){function H(a){var c;var b;var e,i,t;if(typeof(a.alphaBounds=='undefined'))a.alphaBounds=[0.0,1.0];if(typeof(a.alpha=='undefined'))a.alpha=true;this.m_Canv=a.canvas;this.m_W=a.width;this.m_H=a.height;if(!this.m_Canv)this.m_Canv=document.createElement("canvas");var A={depth:false,antialias:false,alpha:true};if(!this.m_GL)this.m_GL=this.m_Canv.getContext("experimental-webgl",A);if(!this.m_GL)this.m_GL=this.m_Canv.getContext("webgl",A);if(!this.m_GL){VBI.m_bTrace&&VBI.Trace("Error: WebGL not supported");return;}this.m_GL.blendFunc(this.m_GL.ONE,this.m_GL.ONE);this.m_GL.enableVertexAttribArray(0);if(a.colorTexture){this.m_ColorTexture=new VBI.Tex(this.m_GL,{colfmt:"rgba"});this.m_ColorTexture.BindTex(0);this.m_ColorTexture.SetFilterNearest();this.m_ColorTexture.SetWrapEdge();this.m_ColorTexture.AdjustSize(2,2);if(typeof(a.colorTexture)==="string"){i=new Image();i.onload=function(){this.m_ColorTexture.BindTex(0);this.m_ColorTexture.SetImage(i);}.bind(this);i.src=a.colorTexture;}b="uniform sampler2D colTex; vec3 calcCol( float g ){ return texture2D( colTex, vec2( g, 0.5 )).rgb; }\n";}else{b="vec3 calcCol( float g ){ return smoothstep( vec3( 0.0, 0.0, 1.0 ), vec3( 1.0, 1.0, 0.0 ), vec3( g ) ); }";}if(a.alpha)c=" vec4 calcAlpha(vec3 c,float i){ float a = smoothstep("+(a.alphaBounds[0].toFixed(8))+","+(a.alphaBounds[1].toFixed(8))+",i); return vec4( c*a, a); }\n";else c=" vec4 calcAlpha(vec3 c, float i){ return vec4(c,1.0);}\n";var f="#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp int;\n precision highp float;\n#else\n precision mediump int;\n precision mediump float;\n#endif\nuniform sampler2D src;\nvarying vec2 txy;\n";var d="\nvoid main(){ float f = smoothstep( 0.0, 1.0, texture2D(src, txy).b ); vec3 color = calcCol(f); gl_FragColor = calcAlpha( color, f ); }\n";this.m_Shader=new VBI.Shader(this.m_GL,"attribute vec4 pos; varying vec2 txy; void main(){ txy = pos.xy*0.5+0.5; gl_Position = pos; }",f+b+"\n"+c+d);if(this.m_W==null)this.m_W=this.m_Canv.offsetWidth||2;if(this.m_H==null)this.m_H=this.m_Canv.offsetHeight||2;this.m_Canv.width=this.m_W;this.m_Canv.height=this.m_H;var g=new Float32Array([-1,-1,0,1,1,-1,0,1,-1,1,0,1,-1,1,0,1,1,-1,0,1,1,1,0,1]);this.m_Geo=this.m_GL.createBuffer();this.m_GL.viewport(0,0,this.m_W,this.m_H);this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,this.m_Geo);this.m_GL.bufferData(this.m_GL.ARRAY_BUFFER,g,this.m_GL.STATIC_DRAW);this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,null);this.m_V=new VBI.Vals(this.m_GL,this.m_W,this.m_H);};H.prototype.AdjustSize=function(){if(!this.m_GL)return;var c=this.m_Canv.offsetHeight||2;var a=this.m_Canv.offsetWidth||2;if(this.m_W!==a||this.m_H!==c){this.m_GL.viewport(0,0,a,c);this.m_Canv.width=a;this.m_Canv.height=c;this.m_W=a;this.m_H=c;this.m_V.AdjustSize(this.m_W,this.m_H);}};H.prototype.RenderColors=function(){if(!this.m_GL)return;this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,this.m_Geo);this.m_GL.vertexAttribPointer(0,4,this.m_GL.FLOAT,false,0,0);this.m_V.m_Ro.BindRo(0);if(this.m_ColorTexture)this.m_ColorTexture.BindTex(1);this.m_Shader.Apply();this.m_Shader.SetInt("src",0);this.m_Shader.SetInt("colTex",1);return this.m_GL.drawArrays(this.m_GL.TRIANGLES,0,6);};H.prototype.RenderValues=function(){if(!this.m_GL)return;this.m_V&&this.m_V.Render();};H.prototype.Render=function(){this.RenderValues();this.RenderColors();};H.prototype.Clear=function(){return this.m_V?this.m_V.Clear():null;};H.prototype.AddPoint=function(x,y,v,s){return this.m_V?this.m_V.AddPoint(x,y,v,s):null;};return H;})();
VBI.CreateHM=function(p){return new VBI.Hm(p);};
