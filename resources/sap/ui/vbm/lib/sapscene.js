VBI.InputModeDefault=0;VBI.InputModeTrackObject=1;VBI.InputModeTrackMap=2;VBI.InputModeTrackDesign=3;VBI.InputModeRectSelect=4;
VBI.SceneManager=function(){var s={};s.vbiclass="SceneManager";s.m_SceneArray=[];s.find=function(n){for(var a=0;a<s.m_SceneArray.length;++a)if(s.m_SceneArray[a].m_ID==n)return s.m_SceneArray[a];return null;};s.clear=function(){for(var n=0;n<s.m_SceneArray.length;++n)s.m_SceneArray[n].clear();s.m_SceneArray=[];};s.load=function(d,c){if(d.Set)s.loadScenes(d.Set,false,d,c);if(d.Merge)s.loadScenes(d.Merge,true,d,c);};s.loadScenes=function(a,i,d,c){if(jQuery.type(a)=='array'){for(var n=0;n<a.length;++n)s.loadScene(a[n],i,d,c);}else{s.loadScene(a,i,d,c);}};s.loadScene=function(m,i,d,c){var a;if(m.name){if(a=s.find(m.name)){if(!i)a.clear();if(m.SceneGeo)a.load(m.SceneGeo,c,i);else a.load(m.Scene,c,i);if(i)a.ReAwake();return;}}else{if(!i)s.clear();}if(m.SceneGeo)s.loadNewScene(m.SceneGeo,true,c);if(m.Scene)s.loadNewScene(m.Scene,false,c);};s.loadNewScene=function(a,i,c){if(jQuery.type(a)=='object'){var b=i?new VBI.GeoScene(null,null,null):new VBI.Scene(null,null,null);b.load(a,c);s.Add(b);}else{if(jQuery.type(a)=='array'){for(var n=0;n<a.length;++n){var b=i?new VBI.GeoScene(null,null,null):new VBI.Scene(null,null,null);b.load(a[n],c);s.Add(b);}}}};s.Add=function(a){s.m_SceneArray.push(a);};s.GetScene=function(t){for(var i=0;i<s.m_SceneArray.length;++i){if(s.m_SceneArray[i].m_TargetName==t)return s.m_SceneArray[i];}return null;};s.GetSceneByName=function(n){for(var i=0;i<s.m_SceneArray.length;++i){if(s.m_SceneArray[i].m_ID==n)return s.m_SceneArray[i];}return null;};return s;};
VBI.Scene=function(t){var s={};s.vbiclass="Scene";s.m_TargetName=t;s.m_EvtCont=new VBI.Events();s.m_ID="";s.m_Ctx=null;s.m_Div=null;s.m_Parent=null;s.m_CaptureVO=null;s.m_DesignVO=null;s.m_VOS=[];s.m_Events=null;s.m_Proj=null;s.m_LastDefinedCenterPos=s.m_LastZoomArea=undefined;s.m_HotItem={m_VO:null,m_Index:null,m_Design:null,m_HitObj:null};s.m_DragInfo=null;s.m_Target=t;s.LoadSingleVO=function(e,v,c,I){if(jQuery.type(e)=='object'){var a=v.Factory.CreateInstance(e.type);a.m_Scene=s;a.load(e,c);if(I){var n=a.m_ID;for(var i=s.m_VOS.length;i--;){if(s.m_VOS[i].m_ID==n){s.m_VOS[i]=a;return;}}}s.m_VOS.push(a);}};s.BaseLoad=function(d,c,i){if(!i){VBI.RegisterKeyboardHook();s.m_Ctx=c;if(d.id)s.m_ID=d.id;}if(d.VO){var v=new VBI.VisualObjects();if(jQuery.type(d.VO)=='array'){for(var n=0;n<d.VO.length;++n)s.LoadSingleVO(d.VO[n],v,c,i);}else{s.LoadSingleVO(d.VO,v,c,i);}}};s.BaseClear=function(){for(var n=0,a=s.m_VOS.length;n<a;++n)s.m_VOS[n].clear();s.m_VOS=[];s.m_Ctx=null;s.m_CaptureVO=null;s.m_DesignVO=null;if(s.m_Parent)s.m_Parent.m_refSceneInstance=null;s.m_HotItem=null;if(s.m_Events){s.m_Events.clear();s.m_Events=null;}VBI.UnRegisterKeyboardHook();};s.BaseGetVO=function(i){for(var n=0,a=s.m_VOS.length;n<a;++n)if(s.m_VOS[n].m_ID==i)return s.m_VOS[n];return null;};s.load=function(d,c,i){s.BaseLoad(d,c,i);};s.clear=function(){s.BaseClear();s.m_Div=null;};s.InternalSetHotItem=function(v,h){var a=s.m_HotItem;var m=false;var o=a.m_Index;var b=a.m_VO;if(h){if(a.m_Index!=h.m_Index){a.m_Index=h.m_Index;m=true;}if(a.m_Design!=h.m_Design){a.m_Design=h.m_Design;m=true;}if(a.m_Entity!=h.m_Entity){a.m_Entity=h.m_Entity;m=true;}}else{if(a.m_Entity||a.m_Detail){m=true;a.m_Entity=null;a.m_Detail=null;}}if(a.m_VO!=v){a.m_VO=v;m=true;}if(!m){var c;if(h&&(c=a.m_HitObj)){if(!jQuery.sap.equal(c,h,2))m=true;}else{if(h!=null||a.m_HitObj!=null)m=true;}}a.m_HitObj=h;if(m){if(b)b.InternalChangeHotItem(o,false);if(v)v.InternalChangeHotItem(a.m_Index,true);s.RenderAsync(false);}return m;};s.InternalRenderVisualObjects=function(c,a){var b=Date.now();var v=s.m_VOS;VBI.Utilities.BackupFont(a);for(var n=0;n<s.m_VOS.length;++n)v[n].Render(c,a);VBI.Utilities.RestoreFont(a);s.m_nLastRenderingTime=Date.now()-b;};s.Render=function(){};s.Awake=function(t){s.InternalRenderVisualObjects(null,s.m_Ctx);};s.NotifyDataChange=function(){for(var n=0;n<s.m_VOS.length;++n)s.m_VOS[n].NotifyDataChange(s.m_Ctx);s.m_PreassembledData=undefined;};s.GetPointArrayFromPosArray=function(p,a){return p;};s.GetPosFromPoint=function(p){return p;};s.GetPointFromPos=function(p,a){return s.GetPointArrayFromPosArray(p,a);};s.GetEventVPCoords=function(e){if(!e)return[0,0];var r=s.m_Div.getBoundingClientRect();return[e.clientX-r.left,e.clientY-r.top];};s.GetEventVPCoordsObj=function(e){var p=s.GetEventVPCoords(e);return{x:p[0].toString(),y:p[1].toString()};};s.GetEventVPCoordsObjWithScene=function(e){var p=s.GetEventVPCoords(e);return{x:p[0].toString(),y:p[1].toString(),scene:s.m_ID};};s.GetEventDropObjWithScene=function(e){return{strSource:s.m_DragInfo.strScene+"|"+s.m_DragInfo.strID+"|"+s.m_DragInfo.strInstance,scene:s.m_ID};};s.SetCapture=function(v){m_CaptureVO=v;};s.DispatchEvent=function(e,a){VBI.m_bTrace&&VBI.Trace("DispatchEvent "+e.type+" as "+a+" mode:"+s.m_nInputMode+(s.m_Gesture?" gesture active":""));if(s.m_nInputMode==VBI.InputModeTrackMap)return false;var f,b=e.type;if(a)e.m_evName=b=a;e.m_Scene=s;if(e.offsetX==undefined||e.offsetY==undefined){var r;if(e.clientX!==undefined&&e.clientY!==undefined){r=e.target.getBoundingClientRect();e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top;}else if(e.changedTouches!==undefined&&(e.changedTouches.length>0)){r=e.target.getBoundingClientRect();e.clientX=e.changedTouches[0].clientX;e.clientY=e.changedTouches[0].clientY;e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top;}}if(e.shiftKey==undefined)e.shiftKey=VBI.m_shiftKey;if(e.ctrlKey==undefined)e.ctrlKey=VBI.m_ctrlKey;var v=s.m_VOS;for(var n=0,l=v.length;n<l;++n){var L=v[n].getLabelData(false);for(var c=0;c<L.length;++c){var d=L[c];var g=VBI.Types.string2rgba(d.m_BgColor);if(g[3]<0.1&&g[4]==1)continue;var z=s.GetCurrentZoomFactors();var h=e.offsetX/z[0];var i=e.offsetY/z[1];for(var j=0;j<d.m_Pos.length;++j){for(var k=0;k<d.m_Pos[j].length;k++){var x=d.m_Pos[j][k][0];var y=d.m_Pos[j][k][1];var r=[x,y,x+d.m_Width,y+d.m_Height];var p=[h,i];if(VBI.Utilities.PtInRect(p,r))return true;}}}}if(s.m_DesignVO){VBI.m_bTrace&&VBI.Trace("DispatchEvent to Design VO");if((f=s.m_DesignVO["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_DesignVO))(e)==true)return true;}}if(s.m_CaptureVO){if((f=s.m_CaptureVO["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_CaptureVO))(e)==true)return true;}}var m;for(var c=0,l=s.m_VOS.length;c<l;++c){m=l-c-1;if((f=s.m_VOS[m]["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_VOS[m]))(e)==true)return true;}}return false;};return s;};
VBI.GeoScene=function(t,m,c){var s=new VBI.Scene(t);s.vbiclass="GeoScene";s.m_RefMapLayerStack="";s.m_DivCopyright=null;s.m_Canvas=[];s.m_cvObjImg=null;s.m_ZoomFactors=[1.0,1.0];s.m_MapManager=m;s.m_MapLayerStack=c;s.m_nMaxCanvasDimension=8192;if(VBI.m_bIsMobile)s.m_nMaxCanvasDimension=6144;s.Click=null;s.m_nOverlayIndex=2;s.m_nTapCount=0;s.GetHomeLocation=null;s.m_Touches=[];s.m_currentMouseX=0;s.m_currentMouseY=0;s.m_oldMouseX=0;s.m_oldMouseY=0;s.m_currentMouseDownX=0;s.m_currentTouchCount=0;s.m_currentMouseDownY=0;s.m_midPointX=0;s.m_midPointY=0;s.m_currentTouchDistance=0;s.m_nInputMode=VBI.InputModeDefault;s.m_BlendTimer=null;s.m_AnimZoomTimer=null;s.m_startPointLonLat=[0.0,0.0];s.m_startLOD=0;s.m_bNavControlVisible=true;s.m_NavControl=null;s.m_RenderTimer=null;s.m_SuppressedNavigation={zoom:false,move:false};s.m_bScaleVisible=true;s.m_Scale=null;s.m_OverlayImage=null;s.m_nCanvasXOversize=2.2;s.m_nCanvasYOversize=2.2;s.m_nCanvasStdXPos=s.m_nCanvasXOversize/4;s.m_nCanvasStdYPos=s.m_nCanvasYOversize/4;s.m_nTicksInALod=5;s.m_nLodFactorZoomIn=Math.pow(2,1/s.m_nTicksInALod);s.m_nLodFactorZoomOut=1/s.m_nLodFactorZoomIn;s.m_nLodFactorZoomInHalf=Math.pow(2,1/(2*s.m_nTicksInALod));s.m_nLodFactorZoomOutHalf=1/s.m_nLodFactorZoomInHalf;s.m_nMaxAnimLodDiff=3;s.m_nZoomMode=1;s.m_nLastRenderingTime=0;s.m_nRenderTimeTarget=250;s.m_nNumOfScalingVOInst=0;s.m_nLastClusteringTime=0;s.onTileLoaded=null;s.clear=function(){s.BaseClear();s.m_Touches=[];if(s.m_NavControl){s.m_NavControl.clear();s.m_NavControl=null;}if(s.m_Scale){s.m_Scale.clear();s.m_Scale=null;}s.clearTimers();s.clearCanvases();s.SetInputMode(VBI.InputModeDefault);s.Remove();s.m_RefMapLayerStack="";s.m_MapManager=null;s.m_MapLayerStack=null;s.m_TargetName=null;s.m_OverlayImage=null;s.m_Proj=null;s.m_DivCopyright=null;s.m_Target=null;};s.loadSingleRemoveOnScene=function(r,a){if(jQuery.type(r)=='object'){switch(r.type){case"VO":var i=r.id;for(var j=s.m_VOS.length;j--;){if(s.m_VOS[j].m_ID==i){s.m_VOS.splice(j,1);return;}}break;};}};s.loadRemoveOnScene=function(r,a){if(jQuery.type(r)=='array')for(j=0;j<r.length;++j)s.loadSingleRemoveOnScene(r[j],a);else s.loadSingleRemoveOnScene(r,a);};s.load=function(d,a,i){if(i&&d.Remove)s.loadRemoveOnScene(d.Remove,a);s.BaseLoad(d,a,i);if(d.refMapLayerStack)s.m_RefMapLayerStack=a.m_MapLayerStackManager.GetMapLayerStack(d.refMapLayerStack);else VBI.m_bTrace&&VBI.Trace("no map layer specified in geo scene");if(i)return;var b=-1000,e=1000;var f=-90,g=90;s.m_nMinLodVisualBorder=0;s.m_nMaxLodVisualBorder=99;s.m_nOffsetMinLod=0;s.m_bYBorderExists=false;if(d.VisualFrame){if(d.VisualFrame.minX!=undefined)b=d.VisualFrame.minX;if(d.VisualFrame.maxX!=undefined)e=d.VisualFrame.maxX;if(d.VisualFrame.minY!=undefined)f=d.VisualFrame.minY;if(d.VisualFrame.maxY!=undefined)g=d.VisualFrame.maxY;if(d.VisualFrame.minY!=undefined||d.VisualFrame.maxY!=undefined)s.m_bYBorderExist=true;if(d.VisualFrame.minLOD!=undefined)s.m_nMinLodVisualBorder=d.VisualFrame.minLOD;if(d.VisualFrame.maxLOD!=undefined)s.m_nMaxLodVisualBorder=d.VisualFrame.maxLOD;if(d.VisualFrame.offsetMinLOD!=undefined)s.m_nOffsetMinLod=d.VisualFrame.offsetMinLOD;}s.m_bXBorderExists=(b!=-1000)||(e!=1000);s.m_nBorderMinPoint=VBI.MathLib.DegToRad([b,g]);s.m_nBorderMaxPoint=VBI.MathLib.DegToRad([e,f]);s.m_Proj=s.setProjection();var u=[1.0,1.0],h=[1.0,1.0];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,u);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,h);s.m_nXSizeVisualBorder=Math.max(0.0,Math.min(1.0,h[0]-u[0]));s.m_nYSizeVisualBorder=Math.max(0.0,Math.min(1.0,h[1]-u[1]));if(d.initialStartPosition){var k=d.initialStartPosition.split(';');s.m_startPointLonLat=VBI.MathLib.DegToRad([parseFloat(k[0]),parseFloat(k[1])]);}if(d.initialZoom){s.m_startLOD=parseInt(d.initialZoom);}var S={zoom:false,move:false,fade:false};if(d.NavigationDisablement){if(d.NavigationDisablement.zoom)s.m_SuppressedNavigation.zoom=VBI.Types.string2bool(d.NavigationDisablement.zoom);if(d.NavigationDisablement.move)s.m_SuppressedNavigation.move=VBI.Types.string2bool(d.NavigationDisablement.move);}if(d.navControlVisible)s.m_bNavControlVisible=VBI.Types.string2bool(d.navControlVisible);S.zoom=s.m_SuppressedNavigation.zoom;S.move=s.m_SuppressedNavigation.move;if(s.m_SuppressedNavigation.zoom&&s.m_SuppressedNavigation.move)s.m_bNavControlVisible=false;else{if(s.m_bNavControlVisible){if(d.SuppressedNavControlVisibility){if(!S.zoom&&d.SuppressedNavControlVisibility.zoom)S.zoom=VBI.Types.string2bool(d.SuppressedNavControlVisibility.zoom);if(!S.move&&d.SuppressedNavControlVisibility.move)S.move=VBI.Types.string2bool(d.SuppressedNavControlVisibility.move);if(d.SuppressedNavControlVisibility.fade)S.fade=VBI.Types.string2bool(d.SuppressedNavControlVisibility.fade);}if(S.move&&S.zoom)s.m_bNavControlVisible=false;}}if(s.m_bNavControlVisible)s.m_NavControl=new VBI.NavigationControl(S);if(d.scaleVisible)s.m_bScaleVisible=VBI.Types.string2bool(d.scaleVisible);if(s.m_bScaleVisible)s.m_Scale=new VBI.Scale(s);};s.SetInputMode=function(v){VBI.m_bTrace&&VBI.Trace("SetInputMode: "+this.m_nInputMode);if(this.m_nInputMode==v)return;switch(this.m_nInputMode){case VBI.InputModeTrackMap:s.SetInputModeTrackMap(false);break;};switch(v){case VBI.InputModeTrackMap:s.SetInputModeTrackMap(true);break;}this.m_nInputMode=v;};s.SetToolTip=function(a){var C=s.m_Canvas[s.m_nOverlayIndex];if(C.title!=a)C.title=a;};s.SetCursor=function(a){var C=s.m_Canvas[s.m_nOverlayIndex];if(C.style.cursor!=a)C.style.cursor=a;};s.RenderAsync=function(f){if(f!=false)s.bForceRecluster=true;if(s.m_RenderTimer)return;s.m_RenderTimer=window.setInterval(s.DoRender,20);};s.DoRender=function(){s.Render(!s.bForceRecluster);};s.Render=function(a){s.bForceRecluster=false;if(s.m_RenderTimer){window.clearInterval(s.m_RenderTimer);s.m_RenderTimer=null;}if(s.m_Canvas.length)s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,a!=true,s.m_Canvas[0].m_nExactLOD);};s.GoToInitialStart=function(){if(!s.ZoomToGeoPosition(s.m_startPointLonLat,s.m_startLOD,true,false,true)){var a=VBI.MathLib.RadToDeg(s.m_nBorderMinPoint);var b=VBI.MathLib.RadToDeg(s.m_nBorderMaxPoint);var l=[a[0],b[0]];var d=[a[1],b[1]];s.ZoomToMultiplePositions(l,d,1.1,true);}s.RenderAsync(true);};s.GetDistance=function(p,a){var G=s.GetPosFromVPPoint(p);var b=s.GetPosFromVPPoint(a);return VBI.MathLib.Distance(VBI.MathLib.DegToRad(G),VBI.MathLib.DegToRad(b));};s.GetTargetPointForDistance=function(d,p){var a=s.GetPosFromVPPoint(p);var b=a.slice(0);a=VBI.MathLib.DegToRad(a);var e=90*Math.PI/180;var l=Math.asin(Math.sin(a[1])*Math.cos(d/VBI.MathLib.earthradius)+Math.cos(a[1])*Math.sin(d/VBI.MathLib.earthradius)*Math.cos(e));var f=a[0]+Math.atan2(Math.sin(e)*Math.sin(d/VBI.MathLib.earthradius)*Math.cos(a[1]),Math.cos(d/VBI.MathLib.earthradius)-Math.sin(a[1])*Math.sin(l));var g=VBI.MathLib.RadToDeg([f,l]);return(s.GetPointFromGeo([f,l],true));};s.ZoomToMultiplePositions=function(l,d,e,S){var f=[];var g=[];if(l.length!=d.length)return;for(var n=0;n<l.length;n++){var L=(parseFloat(l[n]));if(L<0)L+=360;f.push(L);g.push(parseFloat(d[n]));}if(f.length!=g.length||!f.length)return;f.sort(function(a,b){return a-b;});g.sort(function(a,b){return a-b;});var h=0,i=0,k,o;k=g[0];o=g[g.length-1];var p=undefined,q,r,u;q=f[f.length-1];for(var n=0;n<f.length;n++){r=f[n];u=(r<q?(r+360-q):(r-q));if(p==undefined||u>p){p=u;h=(r<q?r+360:r);i=q;}q=r;}s.ZoomToArea(h,i,k,o,e?e:0.9,false,S);};s.ZoomToAreas=function(a,b){var x=Math.log(s.m_nDivWidth/(s.m_MapManager.m_tileWidth*s.m_nXSizeVisualBorder))*Math.LOG2E;var d=VBI.MathLib.GetSurroundingBox(a,0,x,s.CalculateYMinLod);s.ZoomToArea(d[0],d[1],d[2],d[3],b,true);var e=new Date().getTime();s.m_LastZoomArea=[e,"Areas",a,b];return true;};s.CalculateYMinLod=function(a,b){if(a==b)return 1000;var u=[256,256];var d=[256,256];s.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad([0,a]),u);s.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad([0,b]),d);lodY=s.m_nDivHeight/Math.abs(d[1]-u[1]);lodY=Math.log(lodY)*Math.LOG2E;return lodY;};s.ZoomToArea=function(a,b,d,e,f,r,S){var n=256,g=256;if(s.m_MapManager){n=s.m_MapManager.m_tileWidth;nTileHeigth=s.m_MapManager.m_tileHeight;}var h=s.m_nDivHeight?s.m_nDivHeight:g;var i=s.m_nDivWidth?s.m_nDivWidth:n;var I;var p;if(jQuery.type(f)=='array'){if(f.length>=4){var x=f[0]+f[2];var y=f[1]+f[3];if((x<i)&&(y<h)){if((f[0]!=f[2])||(f[1]!=f[3]))p=[(f[2]-f[0])/2,(f[3]-f[1])/2];i-=x;h-=y;I=((x<0)||(y<0));}}}else{h*=f;i*=f;I=(f>1.0);}if(b<a)b+=360;while(a>180)a-=360;while(b>180)b-=360;var k=[a,d];var l=[b,e];k=VBI.MathLib.DegToRad(k);l=VBI.MathLib.DegToRad(l);var u=[n,g];var o=[n,g];s.m_Proj.LonLatToUCS(k,u);s.m_Proj.LonLatToUCS(l,o);var q=u[0]+o[0]+(o[0]<=u[0])*n;var v=u[1]+o[1];var w=[q/n-1,v/g-1];var z=[1,1];s.m_Proj.UCSToLonLat(w,z);var A=14,B=14;if(e!=d){A=h/Math.abs(o[1]-u[1]);A=Math.log(A)*Math.LOG2E;}if(b!=a){B=i/Math.abs((o[0]-u[0])+(o[0]<=u[0])*n);B=Math.log(B)*Math.LOG2E;}var C=(I)?Math.max(B,A):Math.min(B,A);if(r)C=Math.floor(C);s.ZoomToGeoPosition(z,C,false,false,S,p);if(C!=Math.floor(C)){setTimeout(function(){s.AnimateZoomToGeo(z,Math.floor(C),40);},600);}var D=new Date().getTime();s.m_LastZoomArea=[D,"Area",a,b,d,e,f];};s.AdaptOtherCanvas=function(u,l,a,n){var b=a?1:0;var o=s.m_Canvas[1-b];if((a<=1)&&(a>=-2)){var d=l-o.m_nCurrentLOD;var e=Math.pow(2,-d);var p=Math.max(1,e);var f=o.getPixelLeft(),g=o.getPixelTop();var h=o.getPixelWidth(),i=o.getPixelHeight();var k=h/s.m_nWidthCanvas;var q=[(this.m_MapManager.m_tileWidth*o.m_nCurrentX+(s.m_nDivWidth/2-f)/k),(this.m_MapManager.m_tileHeight*o.m_nCurrentY+(s.m_nDivHeight/2-g)/k)];var r=[q[0]-e*u[0],q[1]-e*u[1]];if((Math.abs(r[0])<p*s.m_nWidthCanvas)&&(Math.abs(r[1])<p*s.m_nHeightCanvas)){var v=Math.pow(2,n);var w=v*(f-s.m_nDivWidth/2+k*r[0])+s.m_nDivWidth/2;var x=v*(g-s.m_nDivHeight/2+k*r[1])+s.m_nDivHeight/2;this.MoveCanvas(o,w,x,h*v,i*v);return b;}}return 0;};s.ZoomToGeoPosition=function(l,a,d,S,b,p){if((l.pixelShift!=undefined)&&(p==undefined))p=l.pixelShift;if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive();}var x=0,y=0;var e=s.m_Canvas[0];var o=e.m_nExactLOD;var n=s.m_MapManager.m_tileWidth;var f=s.m_MapManager.m_tileHeight;var g=Math.min(Math.max(a,s.GetMinLOD()),s.GetMaxLOD());a=Math.floor(g);var h=Math.pow(2,g-a);var i=(1<<a);if(p!=undefined){x=p[0]/h;y=p[1]/h;}var u=[i*n,i*f];s.m_Proj.LonLatToUCS(l,u);var k=[u[0]-s.m_nDivWidth/2+x,u[1]-s.m_nDivHeight/2+y];var q=s.m_Proj.m_nUCSMin*i;nTargetCanvas=s.AdaptOtherCanvas(u,a,a-e.m_nCurrentLOD,g-e.m_nExactLOD);var r=Math.round(k[0]/n-s.m_nCanvasStdXPos-q);var v=Math.round(k[1]/f-s.m_nCanvasStdYPos);var w=-Math.floor(k[0]-(r+q)*n);var z=-Math.floor(k[1]-v*f);var A=Math.round(w+((h-1)*(w-s.m_nDivWidth/2)));var B=Math.round(z+((h-1)*(z-s.m_nDivHeight/2)));var C=Math.round(s.m_nWidthCanvas*h);var D=Math.round(s.m_nHeightCanvas*h);var E=[i,i];var F=[i,i];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,E);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,F);var G=D/s.m_nHeightCanvas;var H=f*(v-E[1])*G-B;var I=f*(v-F[1])*G+s.m_nDivHeight-B;var T=true;if(H<-s.m_nMaxPixelBeyondPoles)B=f*(v-E[1])*G+s.m_nMaxPixelBeyondPoles;else if(I>s.m_nMaxPixelBeyondPoles)B=f*(v-F[1])*G+s.m_nDivHeight-s.m_nMaxPixelBeyondPoles;else T=false;if(T){if(d)return false;var J=(B+(h-1)*s.m_nDivHeight/2)/h;var K=-Math.round(s.m_nCanvasStdYPos+J/f);v+=K;B+=h*K*f;}if(s.m_bXBorderExists){var L=n*(r-E[0])*G-A;var M=n*(r-F[0])*G+s.m_nDivWidth-A;var N=true;if(L<-s.m_nMaxPixelBeyondPoles)A=n*(r-E[0])*G+s.m_nMaxPixelBeyondPoles;else if(M>s.m_nMaxPixelBeyondPoles)A=n*(r-F[0])*G+s.m_nDivWidth-s.m_nMaxPixelBeyondPoles;else N=false;if(N){if(d)return false;var O=(A+(h-1)*s.m_nDivWidth/2)/h;var K=-Math.round(s.m_nCanvasStdXPos+O/f);r+=K;A+=h*K*n;}}var P=((e.m_nCurrentX==r)&&(e.m_nCurrentY==v)&&(e.m_nCurrentLOD==a));if(P){s.MoveCanvas(e,A,B,C,D);e.m_nExactLOD=g;}else{s.InvalidateCanvas(s.m_Canvas[1]);if(nTargetCanvas==0){var Q=e.getContext("2d");Q.clearRect(0,0,e.width,e.height);}var R=s.m_Canvas[nTargetCanvas];s.MoveCanvas(R,A,B,C,D);s.m_MapManager.RequestTiles(R,s.m_MapLayerStack,r,v,s.m_nTilesX,s.m_nTilesY,0,0,0,0,a,false);R.m_nExactLOD=g;if(nTargetCanvas==1)s.ToggleCanvas(s);}if(b!=true)s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,!P,!P,g);s.m_LastDefinedCenterPos=p?undefined:l;s.InternalOnMoveLayer(e,S);if(g!=o)s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],S);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(g);}return true;};s.SetMapLayerStack=function(n){var i=VBI.GetMapLayerStack(n);if(i==null)return;if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive();}s.m_MapLayerStack=i;var a=s.m_Canvas[0];s.m_MapManager.RequestTiles(a,s.m_MapLayerStack,a.m_nCurrentX,a.m_nCurrentY,s.m_nTilesX,s.m_nTilesY,0,0,0,0,a.m_nCurrentLOD,false);s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,a.m_nCurrentLOD);};s.ZoomToZoomlevel=function(l,n,S){var r=s.m_Div.getBoundingClientRect();if((r.width!=s.m_nDivWidth)||(r.height!=s.m_nDivHeight))s.resizeCanvas(0);s.ZoomToGeoPosition(l,n,false,S);};s.GetMapLayerStack=function(){return s.m_MapLayerStack;};s.GetMinLOD=function(){var n=Math.max(s.m_nDivWidth/(s.m_MapManager.m_tileWidth*s.m_nXSizeVisualBorder),s.m_nDivHeight/(s.m_MapManager.m_tileHeight*s.m_nYSizeVisualBorder));var a=Math.log(n)*Math.LOG2E;var b=s.m_MapLayerStack;var d=Math.max(s.m_nMinLodVisualBorder-s.m_nOffsetMinLod,b?b.GetMinLOD():0);return Math.max(a,d);};s.GetMinLODForWidth=function(w){var n=w/s.m_MapManager.m_tileWidth;var a=Math.log(n)*Math.LOG2E;var b=s.m_MapLayerStack;var d=Math.max(s.m_nMinLodVisualBorder,b?b.GetMinLOD():0)-s.m_nOffsetMinLod;return Math.max(a,d);};s.GetMaxLOD=function(){var a=s.m_MapLayerStack;return Math.min(a?a.GetMaxLOD():20,s.m_nMaxLodVisualBorder);};s.GetCurrentZoomlevel=function(){return s.m_Canvas[0].m_nExactLOD;};s.GetCenterPos=function(){if(s.m_LastDefinedCenterPos!=undefined){return s.m_LastDefinedCenterPos;}var a=s.getCanvas();var p=[s.m_nDivWidth/2-a.getPixelLeft(),s.m_nDivHeight/2-a.getPixelTop()];return(s.GetGeoFromPoint(p));};s.InternalRenderVisualObjects=function(a,d,b){var e=Date.now();var v=s.m_VOS;var V=v.length;var f;s.m_nNumOfScalingVOInst=0;VBI.Utilities.BackupFont(d);for(var n=0;n<V;++n){if(b){v[n].m_nPreDataIndex=n;f=v[n].Render(a,d,b[n]);}else f=v[n].Render(a,d);if(f!=undefined)s.m_nNumOfScalingVOInst+=f;}if(s.m_DesignVO)s.m_DesignVO.Render(a,d);if(!s.m_cvObjImg){s.m_cvObjImg=document.createElement('canvas');}s.m_cvObjImg.width=a.width;s.m_cvObjImg.height=a.height;var l=s.m_cvObjImg.getContext('2d');l.clearRect(0,0,s.m_cvObjImg.width,s.m_cvObjImg.height);l.drawImage(a,0,0,a.width,a.height);s.InternalRenderLabels(a,d);VBI.Utilities.RestoreFont(d);s.m_nLastRenderingTime=Date.now()-e;};s.UpdatePreData4Selected=function(V,I){var a=s.m_Ctx.m_Clustering;if((V!=undefined)&&a)a.UpdatePreData4Selected(V,I,s.m_PreassembledData,s.m_VOS,s.m_Ctx);};s.InternalRenderLabels=function(a,d){VBI.Utilities.SetTextAttributes(d,VBI.Utilities.RemToPixel(0.75)+"px Lucida Sans Unicode",undefined,undefined,"left","middle");var v=s.m_VOS;for(var n=0,l=v.length;n<l;++n){var L=v[n].getLabelData(true);for(var b=0;b<L.length;++b){var e=L[b];e.SetDimensions(d);e.AlignLabel();var f=e.GetLabelTextColor();var g=e.m_Text.split(/\r\n/);for(var h=0;h<e.m_Pos.length;++h){for(var i=0;i<e.m_Pos[h].length;i++){var p=e.m_Pos[h][i][0];var k=e.m_Pos[h][i][1];d.fillStyle=e.m_BgColor;var o=f.length==1?VBI.Utilities.RemToPixel(0.75):VBI.Utilities.RemToPixel(0.75)+1;d.fillRect(p,k,e.m_Width,e.m_Height);var q=0;for(var r=0;r<f.length;++r){d.fillStyle=f[r];var u=0;for(var w=0;w<g.length;w++){u=e.m_Padding+o*w;d.fillText(g[w],p+e.m_Padding+q,k+u+q+7);}q++;}}}}}};s.InvalidatePreassembledData=function(a,l){var h=s.m_HotItem.m_VO;var b;if(h!=undefined&&h.IsClusterable())b=h.SwitchHotItemToStandard();a.InvalidatePreassembledData(s,l);return b;};s.ValidatePreassembledData=function(){var n=s.m_PreassembledData.HotItemBBIndex;s.m_HotItem.m_Index=n;if(s.m_HotItem.m_HitObj)s.m_HotItem.m_HitObj.m_Index=n;};s.InternalRenderLayer=function(a,C,f,F,n){var b=s.m_Canvas[0];var l;var d=s.m_Ctx.m_Clustering;var e=((d!=undefined)&&d.m_Clusters.length);if((s.m_PreassembledData!=undefined)&&((d==undefined)||(d.m_loadCount!=s.m_PreassembledData.m_version)))l=s.InvalidatePreassembledData(d,b.m_nCurrentLOD);var r=false;if((f==false)&&(n!=undefined)){var g=Math.floor(n);if(n==s.m_nLastRenderLOD)return;if((g==Math.floor(s.m_nLastRenderLOD))&&(n!=g&&(n>(s.GetMinLOD()+0.00001)))){var h=Math.abs(n-s.m_nLastRenderLOD);if(h<s.m_nLastRenderingTime/s.m_nRenderTimeTarget)return;if(h<(s.m_nLastRenderingTime+s.m_nLastClusteringTime)/s.m_nRenderTimeTarget)r=true;}}else{r=!F;}s.m_OverlayImage=null;s.m_nLastRenderLOD=(n==undefined)?-1:n;var o=a.getPixelWidth();var i=a.getPixelHeight();a.setPixelWidth(s.m_nWidthCanvas);a.setPixelHeight(s.m_nHeightCanvas);s.m_ZoomFactors[0]=o/s.m_nWidthCanvas;s.m_ZoomFactors[1]=i/s.m_nHeightCanvas;var k=a.getContext('2d');if(C){k.clearRect(0,0,a.width,a.height);a.setPixelWidth(o);a.setPixelHeight(i);return;}if((!r||s.m_PreassembledData==undefined)&&e){var p=Date.now();if(s.m_PreassembledData)l=s.InvalidatePreassembledData(d,b.m_nCurrentLOD);s.m_PreassembledData=d.DoClustering(this,b.m_nCurrentLOD,b.m_nCurrentX,b.m_nCurrentY,s.m_nTilesX,s.m_nTilesY,s.m_VOS,s.m_Ctx,l);s.ValidatePreassembledData();s.m_nLastClusteringTime=Date.now()-p;}if(r&&s.m_PreassembledData!=undefined)s.m_PreassembledData.m_bAlreadyRendered=false;k.clearRect(0,0,a.width,a.height);s.InternalRenderVisualObjects(a,k,s.m_PreassembledData);a.setPixelWidth(o);a.setPixelHeight(i);s.InternalOnRenderLayer(a);if(s.m_Scale)s.m_Scale.Update();};s.InternalOnMoveLayer=function(a,S){s.m_Ctx.m_Windows.NotifySceneMove(this);var b;if((b=s.m_Ctx.m_Actions)&&(S!=true)){var d;if(d=b.findAction("CenterChanged",s,"Map")){var e=s.m_Canvas[s.m_nOverlayIndex];var n=e.getPixelWidth();var f=e.getPixelHeight();var l=s.GetPosFromPoint([0,0]);var r=s.GetPosFromPoint([n,f]);if(!s.m_Proj.m_bIsIsogonal){var g=s.GetPosFromPoint([n,0]);var h=s.GetPosFromPoint([0,f]);l=[Math.min(l[0],h[0]),Math.min(l[1],g[1])];r=[Math.max(g[0],r[0]),Math.max(h[1],r[1])];}var i=s.m_Div.getBoundingClientRect();var v=-e.getPixelLeft();var k=-e.getPixelTop();var o=s.GetPosFromPoint([v,k]);var p=s.GetPosFromPoint([v+i.width,k+i.height]);var q={level:s.GetCurrentZoomlevel().toString(),min:l[0].toString()+";"+l[1].toString()+";0",max:r[0].toString()+";"+r[1].toString()+";0",vpmin:o[0].toString()+";"+o[1].toString()+";0",vpmax:p[0].toString()+";"+p[1].toString()+";0",};s.m_Ctx.FireAction(d,s,this,null,q);}}this.m_EvtCont.fire("onMove",{canvas:a});s.m_Ctx.onMoveLayer(a);};s.InternalOnZoomLayer=function(a,b){s.m_Ctx.m_Windows.NotifySceneZoom(this);if(b!=true){var d;if(d=s.m_Ctx.m_Actions){var e;if(e=d.findAction("ZoomChanged",s,"Map")){var f=s.m_Canvas[s.m_nOverlayIndex];var n=f.getPixelWidth();var g=f.getPixelHeight();var l=s.GetPosFromPoint([0,0]);var r=s.GetPosFromPoint([n,0]);var h=s.GetPosFromPoint([0,g]);var i=s.GetPosFromPoint([n,g]);var k=s.m_Div.getBoundingClientRect();var v=-f.getPixelLeft();var o=-f.getPixelTop();var p=s.GetPosFromPoint([v,o]);var q=s.GetPosFromPoint([v+k.width,o+k.height]);var u={level:s.GetCurrentZoomlevel().toString(),min:Math.min(l[0],h[0]).toString()+";"+Math.min(l[1],r[1]).toString()+";0",max:Math.max(i[0],r[0]).toString()+";"+Math.max(h[1],i[1]).toString()+";0",vpmin:p[0].toString()+";"+p[1].toString()+";0",vpmax:q[0].toString()+";"+q[1].toString()+";0",};if(b!=undefined&&b!=false){var k=s.m_Div.getBoundingClientRect();u.x=b.x.toString()-k.left;u.y=b.y.toString()-k.top;}s.m_Ctx.FireAction(e,s,this,null,u);}}}this.m_EvtCont.fire("onZoom",{canvas:a});s.m_Ctx.onZoomLayer(a);};s.InternalOnRenderLayer=function(a){s.m_Ctx.onRenderLayer(a);if(s.GetHomeLocation){var o=a.getPixelWidth();var b=a.getPixelHeight();var l=[0,0];var h=s.GetHomeLocation();l[0]=h[0];l[1]=h[1];var x=s.GetPointFromGeo(l);a.setPixelWidth(s.m_nWidthCanvas);a.setPixelHeight(s.m_nHeightCanvas);var d=a.getContext('2d');d.clearRect(0,0,a.width,a.height);d.fillStyle='yellow';d.beginPath();d.arc(x[0],x[1],5,0,Math.PI*2,true);d.closePath();d.fill();var i=null;if(s.m_Ctx)i=s.m_Ctx.GetImage("dummy",s.RenderAsync.bind());if(i)d.drawImage(i,x[0]-i.naturalWidth/2,x[1]-i.naturalHeight);a.setPixelWidth(o);a.setPixelHeight(b);}};s.MoveObject=function(o,x,y,w,h){o.m_pixelLeft=Math.round(x);o.m_pixelTop=Math.round(y);o.style.left=o.m_pixelLeft.toString()+"px";o.style.top=o.m_pixelTop.toString()+"px";if(w!==undefined){o.m_pixelWidth=Math.round(w);o.style.width=o.m_pixelWidth.toString()+"px";}if(h!==undefined){o.m_pixelHeight=Math.round(h);o.style.height=o.m_pixelHeight.toString()+"px";}};s.InvalidateCanvas=function(a){var b=a.getContext("2d");b.fillStyle='white';b.clearRect(0,0,a.width,a.height);a.m_bInvalid=true;};s.MoveCanvas=function(a,x,y,w,h){s.MoveObject(s.m_Canvas[s.m_nOverlayIndex],x,y,w,h);s.MoveObject(a,x,y,w,h);};s.MoveOnlyThisCanvas=function(a,x,y,w,h){s.MoveObject(a,x,y,w,h);};s.MoveMap=function(d,a){VBI.m_bTrace&&VBI.Trace("MoveMap"+" DX:"+d+" DY:"+a);var b=s.m_Canvas[3];var e=s.m_Canvas[0];var f=(b.m_bCanvasValid?b:e);var g=s.m_MapManager;var n=f.getPixelWidth();var h=f.getPixelHeight();var i=f.getPixelLeft()+d;var k=f.getPixelTop()+a;var l=g.m_tileWidth,o=g.m_tileHeight;var p=n/s.m_nTilesX;var q=h/s.m_nTilesY;var r=h/s.m_nHeightCanvas;var u=(1<<e.m_nCurrentLOD);var v=[u,u];var w=[u,u];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,v);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,w);if((a>0&&((o*r*(f.m_nCurrentY-v[1])-k)<-s.m_nMaxPixelBeyondPoles))||(a<0&&((o*r*(f.m_nCurrentY-w[1])+s.m_nDivHeight-k)>s.m_nMaxPixelBeyondPoles))){if(d==0)return;a=0;k=f.getPixelTop();}if(s.m_bXBorderExists&&((d>0&&((l*r*(f.m_nCurrentX-v[0])-i)<-s.m_nMaxPixelBeyondPoles))||(d<0&&((l*r*(f.m_nCurrentX-w[0])+s.m_nDivWidth-i)>s.m_nMaxPixelBeyondPoles)))){if(a==0)return;d=0;i=f.getPixelLeft();}var x=0;var y=0;var z;if((d>0)&&(z=i+s.m_nMapMoveXPreLoad)>0){x=Math.ceil(z/p);}else if((d<0)&&((z=s.m_nMapMoveXPreLoad+s.m_nDivWidth-(i+n))>0)){x=-Math.ceil(z/p);}var A=f.m_nCurrentX-x;if((a>0)&&(z=k+s.m_nMapMoveYPreLoad)>0){y=Math.ceil(z/q);}else if((a<0)&&(z=(s.m_nMapMoveYPreLoad+s.m_nDivHeight-(k+h)))>0){y=-Math.ceil(z/q);}var B=f.m_nCurrentY-y;var C=s.m_MapLayerStack;var S=C?C.m_bSingleBMP:false;if(x||y){var D=nPendingOffsetY=0;if(!s.m_Canvas[1].m_bInvalid){s.InvalidateCanvas(s.m_Canvas[1]);}s.MoveCanvas(e,e.getPixelLeft()+d,e.getPixelTop()+a);if(b.m_bCanvasValid){if(b.m_nTilesBefSwitch<b.m_nForceSwitchLimit){s.SwitchTmpCanvasToActive();}else{D=b.m_nOffsetX;nPendingOffsetY=b.m_nOffsetY;}}b.m_nTilesBefSwitch=(S||Math.abs(x)>=s.m_nTilesX||Math.abs(y)>=s.m_nTilesY)?1:(s.m_nTilesX-Math.abs(x))*(s.m_nTilesY-Math.abs(y));b.m_nForceSwitchLimit=Math.ceil(b.m_nTilesBefSwitch/2);b.m_nOffsetX=x+D;b.m_nOffsetY=y+nPendingOffsetY;s.MoveOnlyThisCanvas(b,i-x*p,k-y*q,n,h);var E=b.getContext("2d");E.clearRect(0,0,e.getPixelWidth(),e.getPixelHeight());if(g.RequestTiles(b,s.m_MapLayerStack,A,B,s.m_nTilesX,s.m_nTilesY,0,0,0,0,e.m_nCurrentLOD,false))b.m_bCanvasValid=true;else s.SwitchTmpCanvasToActive();}else{s.MoveCanvas(e,e.getPixelLeft()+d,e.getPixelTop()+a);s.MoveObject(s.m_Canvas[1],s.m_Canvas[1].getPixelLeft()+d,s.m_Canvas[1].getPixelTop()+a);if(b.m_bCanvasValid)s.MoveOnlyThisCanvas(b,i,k);}var V=s.m_VOS;var R=false;for(var F=0,G=V.length;F<G;++F){if(V[F].m_Label.length>0&&V[F].CalculateLabelPos){R=true;break;}}if(R){if(s.m_cvObjImg){var H=s.m_Canvas[s.m_nOverlayIndex].getContext("2d");H.clearRect(0,0,s.m_Canvas[s.m_nOverlayIndex].width,s.m_Canvas[s.m_nOverlayIndex].height);H.drawImage(s.m_cvObjImg,0,0,s.m_cvObjImg.width,s.m_cvObjImg.height);}VBI.Utilities.BackupFont(H);s.InternalRenderLabels(s.m_Canvas[s.m_nOverlayIndex],H);VBI.Utilities.RestoreFont(H);}s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex]);s.m_LastDefinedCenterPos=undefined;};s.AdaptZoomFactor=function(a,f,x,y,b){var r={};r.bZoomNotPossible=true;var n=(1<<a.m_nCurrentLOD);if((a.m_nCurrentY<0)&&(y<-a.m_nCurrentY*(a.getPixelHeight()/s.m_nTilesY)))return r;if(((a.m_nCurrentY+s.m_nTilesY)>n)&&(y>(n-a.m_nCurrentY)*(a.getPixelHeight()/s.m_nTilesY)))return r;if(f<1){var d=Math.max((s.m_nDivWidth/(a.getPixelWidth()*s.m_nXSizeVisualBorder))*(s.m_nTilesX/n),(s.m_nDivHeight/(a.getPixelHeight()*s.m_nYSizeVisualBorder))*(s.m_nTilesY/n));if(f<d){if((d>=1)&&(f!=0))return r;f=d;A=false;}}var A=b&&(s.m_nZoomMode||(f==s.m_nLodFactorZoomIn)||(f==s.m_nLodFactorZoomOut));var e=a.m_nExactLOD+Math.log(f)*Math.LOG2E;var g=s.GetMinLOD();if((g!=Math.round(g))&&(f!=1.0)&&(a.m_nExactLOD<=Math.ceil(g))&&(Math.round(b*e)==Math.round(b*g)))A=false;if(A&&Math.round(b*e)!=b*e){e=Math.round(b*e)/b;f=Math.pow(2,e-a.m_nExactLOD);}else{if(e<g){e=g;f=Math.pow(2,e-a.m_nExactLOD);}}r.factor=f;r.nNewLod=Math.floor(e);r.lodFallsOnInteger=(Math.round(e)==e);r.bZoomNotPossible=((e>s.GetMaxLOD())||(e<g));return r;};s.ZoomMap=function(f,x,y,a,S){if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive();}var b=s.m_Canvas[0];var o=s.m_Canvas[1];var d=s.m_MapManager;var e=d.m_tileWidth,g=d.m_tileHeight;var n,h,i=0,k=0;var l=b.getPixelLeft(),p=b.getPixelTop();var q=b.getPixelWidth(),r=b.getPixelHeight();var u=o.getPixelWidth();var z=s.AdaptZoomFactor(b,f,x,y,a);if(z.bZoomNotPossible)return;f=z.factor;var v=z.nNewLod;VBI.m_bTrace&&VBI.Trace("Zoom by "+f+" to "+x+"/"+y);var w=Math.round(q*f);var A=Math.round(r*f);var B=Math.round(l-((f-1)*x));var C=Math.round(p-((f-1)*y));if(f<1){var D=(1<<b.m_nCurrentLOD);var E=[D,D];var F=[D,D];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,E);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,F);var G=A/s.m_nHeightCanvas;var H=(b.m_nCurrentY-E[1])*g*G-C;if(H<-s.m_nMaxPixelBeyondPoles){C=Math.round(g*(b.m_nCurrentY-E[1])*G+s.m_nMaxPixelBeyondPoles);y=(p-C)/(f-1);}else{var I=g*(b.m_nCurrentY-F[1])*G+s.m_nDivHeight-C;if(I>s.m_nMaxPixelBeyondPoles){C=Math.round(g*(b.m_nCurrentY-F[1])*G+s.m_nDivHeight-s.m_nMaxPixelBeyondPoles);y=(p-C)/(f-1);}}if(s.m_bXBorderExists){var J=(b.m_nCurrentX-E[0])*e*G-B;if(J<-s.m_nMaxPixelBeyondPoles){B=Math.round(e*(b.m_nCurrentX-E[0])*G+s.m_nMaxPixelBeyondPoles);x=(l-B)/(f-1);}var K=(b.m_nCurrentX-F[0])*e*G+s.m_nDivWidth-B;if(K>s.m_nMaxPixelBeyondPoles){B=Math.round(e*(b.m_nCurrentX-F[0])*G+s.m_nDivWidth-s.m_nMaxPixelBeyondPoles);x=(l-B)/(f-1);}}}s.MoveCanvas(b,B,C,w,A);var L=w/s.m_nTilesX;var M=A/s.m_nTilesY;var R=false;if(v==b.m_nCurrentLOD){if(!o.m_bInvalid){var N=Math.round(u*f);var O=Math.round(o.getPixelHeight()*f);if((N<=s.m_nMaxCanvasDimension)&&(O<=s.m_nMaxCanvasDimension)){var P=o.getPixelLeft();var Q=o.getPixelTop();var T=Math.round(P-((f-1)*(x+l-P)));var U=Math.round(Q-((f-1)*(y+p-Q)));s.MoveObject(o,T,U,Math.round(u*f),Math.round(o.getPixelHeight()*f));}else{s.InvalidateCanvas(s.m_Canvas[1]);}}b.m_nExactLOD=b.m_nCurrentLOD+Math.log(L/e)*Math.LOG2E;if(B>0||C>0||(B+w<s.m_nDivWidth)||(C+A<s.m_nDivHeight)){R=true;n=-Math.ceil(B/L);h=-Math.ceil(C/M);i=B+n*L;k=C+h*M;B=b.m_nCurrentX+n;C=b.m_nCurrentY+h;VBI.m_bTrace&&VBI.Trace("run out viewport newTop="+C+" nTilesY="+h+" nPosY="+k+" yOffset="+y+"\n");}}else{R=true;var V=Math.pow(2,b.m_nCurrentLOD-v);var W=r/s.m_nHeightCanvas;var X=x/W+(V*(s.m_nDivWidth/2-l-x));var Y=y/W+(V*(s.m_nDivHeight/2-p-y));if(v>b.m_nCurrentLOD){n=Math.round(X/V/e-s.m_nTilesX/2);h=Math.round(Y/V/g-s.m_nTilesY/2);i=Math.ceil(B+n*L*V);k=Math.ceil(C+h*M*V);}else{var Z=((b.m_nCurrentX%V)+V)%V;var $=((b.m_nCurrentY%V)+V)%V;n=Math.round((X/e+Z)/V-s.m_nTilesX/2);h=Math.round((Y/g+$)/V-s.m_nTilesY/2);i=B+L*(n*V-Z);k=C+M*(h*V-$);}B=Math.floor(b.m_nCurrentX/V+n);C=Math.floor(b.m_nCurrentY/V+h);w=z.lodFallsOnInteger?(e*s.m_nTilesX):Math.ceil(w*V);A=z.lodFallsOnInteger?(g*s.m_nTilesY):Math.ceil(A*V);}var _=v+Math.log(w/s.m_nWidthCanvas)*Math.LOG2E;if(R){o.m_nExactLOD=_;s.MoveCanvas(o,i,k,w,A);var a1=o.getContext("2d");a1.fillStyle='white';a1.clearRect(0,0,a1.canvas.width,a1.canvas.height);s.m_MapManager.RequestTiles(s.m_Canvas[1],s.m_MapLayerStack,B,C,s.m_nTilesX,s.m_nTilesY,0,0,0,0,v,true);b.m_Scene.ToggleCanvas(b.m_Scene);}s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,R,R,_);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(v);}s.InternalOnMoveLayer(b,S);s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],S);s.m_LastDefinedCenterPos=s.m_LastZoomArea=undefined;};s.ZoomOtherCanvas=function(o,a,f,x,y){var n=Math.round(o.getPixelLeft()-((f-1)*x));var b=Math.round(o.getPixelTop()-((f-1)*y));var d=Math.round(o.getPixelWidth()*f);var e=Math.round(o.getPixelHeight()*f);s.MoveObject(o,n,b,d,e);};s.AnimateZoom=function(z,a,b,i,e){var Z=false;var d=((e!=undefined&&e.clientX!=undefined)?{x:e.clientX,y:e.clientY}:undefined);var n=s.m_Canvas[0].m_nExactLOD;var f=2*s.m_nTicksInALod;if(s.m_AnimZoomTimer&&(s.m_nAnimDirection==z)){if(s.m_nAnimOpenTicks>22)return;window.clearInterval(s.m_AnimZoomTimer);s.m_nAnimOpenTicks+=f;s.m_nAnimTicks+=f;}else{if(n!=Math.round(n)){var g=Math.round((n-Math.floor(n))*f);s.m_nAnimTicks=1+(z?f-g:g);}else s.m_nAnimTicks=1+f;if(s.m_nAnimTicks==1){Z=true;s.m_nAnimTicks++;}s.m_nAnimOpenTicks=s.m_nAnimTicks;s.m_nAnimDirection=z;if(s.m_AnimZoomTimer)window.clearInterval(s.m_AnimZoomTimer);}var h=i*f/Math.max(5,(s.m_nAnimOpenTicks-1));s.AnimZoomTarget=Math.min(s.GetMaxLOD(),Math.max(s.GetMinLOD(),n+(s.m_nAnimDirection?1:-1)*(s.m_nAnimOpenTicks-1)/f));s.m_AnimZoomTimer=window.setInterval(function(){if(--s.m_nAnimOpenTicks){var r=s.m_Canvas[0].getBoundingClientRect();var o=s.m_Canvas[0].m_nExactLOD;var k=Z?1.0:(s.m_nAnimDirection?s.m_nLodFactorZoomInHalf:s.m_nLodFactorZoomOutHalf);s.ZoomMap(k,a-r.left,b-r.top,f,true);if((s.m_Canvas[0].m_nExactLOD!=o)||(Math.abs(s.AnimZoomTarget-o)>s.m_nMaxAnimLodDiff))return;}s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex],d);s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],d);if(s.m_AnimZoomTimer){s.m_nAnimOpenTicks=s.m_nAnimationTicks=s.m_nAnimationDirection=s.AnimZoomTarget=undefined;window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;}},h);};s.AnimateZoomToGeo=function(l,G,i){var n=s.m_Canvas[0].m_nExactLOD;if(n==G)return;var a=2*s.m_nTicksInALod;if(s.m_AnimZoomTimer){window.clearInterval(s.m_AnimZoomTimer);}s.m_nAnimTicks=2+Math.abs(Math.round((n-G)*a));s.m_nAnimOpenTicks=s.m_nAnimTicks;var b=n;var d=G;var e=i*a/s.m_nAnimTicks;s.m_AnimZoomTimer=window.setInterval(function(){if(--s.m_nAnimOpenTicks){s.ZoomToZoomlevel(l,d-(s.m_nAnimOpenTicks-1)*(d-b)/(s.m_nAnimTicks-1),true);return;}s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex]);if(s.m_AnimZoomTimer){s.m_nAnimOpenTicks=s.m_nAnimationTicks=undefined;window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,false,false,s.m_Canvas[0].m_nExactLOD);}},e);};s.IsTransparent=function(a,b){var C=s.m_Canvas[s.m_nOverlayIndex];if(!C)return false;var r=C.getBoundingClientRect();var n=Math.round((a-r.left)/s.m_ZoomFactors[0]);var d=Math.round((b-r.top)/s.m_ZoomFactors[1]);if(!s.m_OverlayImage){var e=C.getContext("2d");s.m_OverlayImage=e.getImageData(0,0,s.m_nWidthCanvas,s.m_nHeightCanvas);}var f=(d*s.m_nWidthCanvas+n)*4+3;if((f<0)||(f>=(s.m_nWidthCanvas*s.m_nHeightCanvas*4))){VBI.m_bTrace&&VBI.Trace("GeoScene::IsTransparent coordinate out of bounds");return true;}var I=s.m_OverlayImage.data;var g=I[f];return g?false:true;};s.GetCurrentZoomFactors=function(){return s.m_ZoomFactors;};s.ToggleCanvas=function(s){var a=s.m_Canvas[0];s.m_Canvas[0]=s.m_Canvas[1];s.m_Canvas[1]=a;s.m_Canvas[0].style.opacity=0.0;s.m_Canvas[1].style.opacity=1.0;a=s.m_Canvas[0].style.zIndex;s.m_Canvas[0].style.zIndex=s.m_Canvas[1].style.zIndex;s.m_Canvas[1].style.zIndex=a;s.BlendCanvas();};s.BlendCanvas=function(){if(s.m_BlendTimer!=null)window.clearInterval(s.m_BlendTimer);var n=parseFloat(s.m_Canvas[0].style.opacity);if(n<1.0){s.m_BlendTimer=window.setInterval(s.BlendCanvas,40);s.m_Canvas[0].style.opacity=Math.min(n+0.1,1.0);if(VBI.m_bIsMyChromeTest){s.m_Canvas[0].style.display='none';s.m_Canvas[0].offsetHeight;s.m_Canvas[0].style.display='block';}}else{window.clearInterval(s.m_BlendTimer);}};s.GetNearestPosArray=function(p){var a=p.slice();var n=Math.floor(a.length/3)*3;var b=a[0];var d=a[1];var e=b,f=b;var g=d,h=d;for(var i=3;i<n;i+=3){while(a[i]-b>180)a[i]-=360;while(b-a[i]>180)a[i]+=360;b=a[i];d=a[i+1];if(e>b)e=b;if(f<b)f=b;if(g>d)g=d;if(h<d)h=d;}a.m_MinX=e;a.m_MaxX=f;a.m_MinY=g;a.m_MaxY=h;return a;};s.GetNearestPos=function(a,n){var p=a.slice();var b=n[0];while(p[0]-b>180)p[0]-=360;while(b-p[0]>180)p[0]+=360;return p;};s.GetPointArrayFromPosArray=function(p,a){var l=[0.0,0.0],r=[];var b=s.m_Canvas[0];var n=(1<<b.m_nCurrentLOD);var d=s.m_nWidthCanvas/s.m_nTilesX;var e=s.m_nHeightCanvas/s.m_nTilesY;var f=n*d;var g=n*e;var h=s.m_Canvas[s.m_nOverlayIndex];var i=h.getPixelWidth()/s.m_nWidthCanvas;var k=h.getPixelHeight()/s.m_nHeightCanvas;var o=s.m_Proj.LonLatToUCS;var u=[0,0],q=Math.PI/180.0;var v=s.m_Proj;var w=v.m_nUCSMin*f;var z=v.m_nUCSMax*f;var A=v.m_nXYRatio*f;var B=b.m_nCurrentX*d+w;var C=b.m_nCurrentY*e;for(var D=0,E=p.length/3;D<E;++D){l[0]=q*p[D*3];l[1]=q*p[D*3+1];u[0]=f;u[1]=g;u=o(l,u);u[0]=u[0]-B;u[1]=u[1]-C;if(a){while(u[0]<w)u[0]+=A;while(u[0]>z)u[0]-=A;}r.push(u[0]*i,u[1]*k,0.0);}if(D==1&&u){var x,y;r.m_bVisible=(((x=u[0])>0)&&((y=u[1])>0)&&(x<s.m_nWidthCanvas)&&(y<s.m_nHeightCanvas));}return r;};s.GetPointFromGeo=function(l,a){return s.GetPointArrayFromPosArray(VBI.MathLib.RadToDeg(l),a);};s.GetInstanceOffsets=function(r){var a=r.slice();var b=s.m_Canvas[0];var d=s.m_nWidthCanvas/s.m_nTilesX;var e=(1<<b.m_nCurrentLOD)*d*s.m_Proj.m_nXYRatio;var f=[0,0,s.m_nWidthCanvas,s.m_nHeightCanvas];var n=0;while(a[2]>0){--n;VBI.Utilities.RectOffset(a,-e,0);}var o=[];while(a[0]<s.m_nWidthCanvas){n++;VBI.Utilities.RectOffset(a,e,0);if(VBI.Utilities.RectIntersect(a,f))o.push(n*e);}return o;};s.GetPosFromVPPoint=function(p){var a=s.m_Canvas[s.m_nOverlayIndex];var b=[p[0]-a.getPixelLeft(),p[1]-a.getPixelTop(),0];var d=this.GetGeoFromPoint(b);return VBI.MathLib.RadToDeg(d);};s.GetPosFromPoint=function(p){var a=this.GetGeoFromPoint(p);return VBI.MathLib.RadToDeg(a);};s.GetGeoFromPoint=function(p){var a=s.m_Canvas[0];var n=a.m_nCurrentLOD;var b=(1<<n);var d=p[0]*s.m_nWidthCanvas/a.getPixelWidth();var e=p[1]*s.m_nHeightCanvas/a.getPixelHeight();var f=s.m_nWidthCanvas/s.m_nTilesX;var g=s.m_nHeightCanvas/s.m_nTilesY;var h=a.m_nCurrentX*f;var i=a.m_nCurrentY*g;var k=h+d;var l=i+e;var o=b*f;var q=b*g;var r=[0,0];var u=[k/o*2.0-1.0,l/q*2.0-1.0];return s.m_Proj.UCSToLonLat(u,r);};s.getCanvas=function(){return s.m_Canvas[0];};s.clearTimers=function(){if(s.m_BlendTimer){window.clearInterval(s.m_BlendTimer);s.m_BlendTimer=null;}if(s.m_AnimZoomTimer){window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;}};s.clearCanvases=function(){for(var n=0,a=s.m_Canvas.length;n<a;++n){s.m_Canvas[n].m_Scene=null;s.m_Canvas[n]=null;}s.m_Canvas=[];};s.Remove=function(){if(s.m_Div){s.SetInputMode(VBI.InputModeDefault);while(s.m_Div.firstChild)s.m_Div.removeChild(s.m_Div.firstChild);s.m_Div.parentElement.removeChild(s.m_Div);s.m_Div=null;s.clearTimers();s.clearCanvases();}if(s.m_Target){while(s.m_Target.firstChild)s.m_Target.removeChild(s.m_Target.firstChild);s.m_Target=null;}};s.AddCopyright=function(){if(!s.m_MapLayerStack)return;if(!s.m_DivCopyright){var C=VBI.Utilities.CreateGeoSceneDivCSS(s.m_Target.id+"-copyright","vbi-copyright");s.m_Div.appendChild(C);s.m_DivCopyright=C;}var a=s.m_MapLayerStack.GetCopyright();if(a){s.m_DivCopyright.innerHTML=a;}else{s.m_DivCopyright.style.paddingRight=0;s.m_DivCopyright.style.paddingLeft=0;}};s.ReAwake=function(){s.m_MapLayerStack=s.m_RefMapLayerStack;s.AddCopyright();s.resizeCanvas(0,true);};s.Awake=function(t,m,c){if(!(s.m_Target=VBI.Utilities.GetDOMElement(t)))s.m_Target=VBI.Utilities.CreateDOMElement(t,"1px","1px");if(s.m_Div){if(s.m_Div.parentNode==s.m_Target)return;s.m_Target.appendChild(s.m_Div);if(s.m_bNavControlVisible&&s.m_NavControl)s.m_NavControl.AttachEvents();return;}s.m_TargetName=t;s.m_MapManager=typeof m!=='undefined'?m:VBI.MapManager;s.m_MapLayerStack=typeof c!=='undefined'?c:s.m_RefMapLayerStack;s.m_Div=VBI.Utilities.CreateGeoSceneDiv(t+"-geoscene");s.m_Target.appendChild(s.m_Div);s.DoAwake(t);};s.setProjection=function(){if(!s.m_RefMapLayerStack||!s.m_RefMapLayerStack.m_MapLayerArray||!s.m_RefMapLayerStack.m_MapLayerArray.length)return new VBI.MercatorProjection;var l=s.m_RefMapLayerStack.m_MapLayerArray;var n=l[0].GetMapProvider().m_nProjection;for(var i=2;i<l.length;++i){if(l[i].GetMapProvider().m_nProjection!=n){VBI.m_bTrace&&VBI.Trace("projection of layer "+i+" is inconsistent to base layer. Choosing projection of base layer");}}switch(n){case 1:return new VBI.MercatorProjection;case 2:return new VBI.LinearProjection;default:return new VBI.MercatorProjection;}};s.DoAwake=function(t){s.CalculateCanvasDimensions();s.CreateCanvases();
// append copyright 
s.AddCopyright();var C=s.m_Canvas[s.m_nOverlayIndex];C.draggable="true";if(s.m_Events)s.m_Events.clear();s.m_Events=new VBI.SceneEvent(this,C);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.Awake(s,t);}if(s.m_bScaleVisible&&s.m_Scale){s.m_Scale.Awake(s,t);}var e=s.GetMinLOD();if(s.m_startLOD<e){var f=Math.ceil(e);s.m_startLOD=(f-e)<0.6?f:e;}s.GoToInitialStart();};s.CalcCanvasWidth=function(w,a){return(Math.floor(w/a+s.m_nCanvasXOversize))*a;};s.CalcCanvasHeight=function(h,a){return(Math.floor(h/a+s.m_nCanvasYOversize))*a;};s.CalculateCanvasDimensions=function(){var n=s.m_Target.offsetWidth;var r=s.m_Div.getBoundingClientRect();var a=s.m_MapManager;var d=r.width?r.width:s.m_Div.clientWidth;var b=r.height?r.height:s.m_Div.clientHeight;if((d==s.m_nDivWidth)&&(b==s.m_nDivHeight))return;s.m_nDivWidth=d;s.m_nDivHeight=b;s.m_nWidthCanvas=s.CalcCanvasWidth(d,a.m_tileWidth);s.m_nHeightCanvas=s.CalcCanvasHeight(b,a.m_tileHeight);s.m_nTilesX=s.m_nWidthCanvas/a.m_tileWidth;s.m_nTilesY=s.m_nHeightCanvas/a.m_tileHeight;a.m_requestTileWidth=a.m_tileWidth;a.m_requestTileHeight=a.m_tileHeight;var l=s.m_MapLayerStack;if(l.m_nMaxSquare&&l.m_MapLayerArray.length){var e=0;for(var i=0;i<l.m_MapLayerArray.length;++i){if(!i||(l.m_MapLayerArray[i].m_refMapProvider.m_nResolution<e)){e=parseInt(l.m_MapLayerArray[i].m_refMapProvider.m_nResolution);}}var f=l.m_nMaxSquare*e;if((s.m_nTilesX*a.m_tileWidth>f)||(s.m_nTilesY*a.m_tileHeight>f)){var g=Math.floor(f/Math.max(s.m_nTilesX,s.m_nTilesY));a.m_requestTileWidth=g;a.m_requestTileHeight=g;}}VBI.m_bTrace&&VBI.Trace("Setting Canvas Size to ("+s.m_nWidthCanvas+","+s.m_nHeightCanvas+") on div with size ("+d+","+b+")");s.m_nMapMoveXPreLoad=Math.min(120,a.m_tileWidth*(s.m_nTilesX-1)-d);s.m_nMapMoveYPreLoad=Math.min(120,a.m_tileHeight*(s.m_nTilesY-1)-b);s.m_nCanvasStdXPos=(s.m_nWidthCanvas-s.m_nDivWidth)/a.m_tileWidth/2;s.m_nCanvasStdYPos=(s.m_nHeightCanvas-s.m_nDivHeight)/a.m_tileHeight/2;s.m_nMaxPixelBeyondPoles=0;};s.SwitchTmpCanvasToActive=function(){var d=s.m_Canvas[0],a=s.m_Canvas[3];var b=d.getContext('2d');b.clearRect(0,0,d.getPixelWidth(),d.getPixelHeight());b.drawImage(s.m_Canvas[3],0,0);s.MoveCanvas(d,d.getPixelLeft()-a.m_nOffsetX*d.getPixelWidth()/s.m_nTilesX,d.getPixelTop()-a.m_nOffsetY*d.getPixelHeight()/s.m_nTilesY);d.m_nCurrentX=a.m_nCurrentX;d.m_nCurrentY=a.m_nCurrentY;a.m_bCanvasValid=false;a.m_CanvasRedirect=d;a.m_CanvasRedirRequest=a.m_nRequest;a.m_nOffsetX=a.m_nOffsetY=0;a.m_nTilesBefSwitch=undefined;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,d.m_nExactLOD);};s.CreateCanvases=function(){var i=s.m_TargetName+"-"+s.m_ID+"-";s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"layer1",s.m_nWidthCanvas,s.m_nHeightCanvas,2));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"layer2",s.m_nWidthCanvas,s.m_nHeightCanvas,1));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"objectlayer",s.m_nWidthCanvas,s.m_nHeightCanvas,3,0));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"nondomlayer",s.m_nWidthCanvas,s.m_nHeightCanvas,4,0,true));for(var n=0;n<s.m_Canvas.length;++n){s.m_Canvas[n].m_Scene=s;s.m_Canvas[n].m_nCurrentLOD=2;s.m_Canvas[n].m_nExactLOD=2;s.m_Canvas[n].m_nCurrentX=undefined;s.m_Canvas[n].m_nCurrentY=undefined;s.m_Canvas[n].m_nAppliedRequest=0;s.m_Canvas[n].m_bInvalid=false;if(!s.m_Canvas[n].m_bNotInDOM)s.m_Div.appendChild(s.m_Canvas[n]);}};s.resizeCanvas=function(e,f){if(!s.m_Canvas.length){s.DoAwake();return;}if(s.m_Canvas[3].m_bCanvasValid)s.SwitchTmpCanvasToActive();var a=s.m_MapManager;var b=s.m_Canvas[0];var o=s.m_nDivWidth;var d=s.m_nDivHeight;var g=s.GetMinLODForWidth(o);var h=b.getPixelWidth()/s.m_nWidthCanvas;s.m_nLastRenderLOD=-1;s.CalculateCanvasDimensions();if((!f)&&(s.m_nDivWidth==o)&&(s.m_nDivHeight==d))return;VBI.m_bTrace&&VBI.Trace("Resizing ("+(o)+","+(d)+") to ("+(s.m_nDivWidth)+","+(s.m_nDivHeight)+")");var k=b.m_nCurrentX;var l=b.m_nCurrentY;var n=b.m_nCurrentLOD;var p=b.getPixelLeft()+(s.m_nDivWidth-o)/2;var x=Math.round((-p/a.m_tileWidth-s.m_nCanvasStdXPos)/h);p+=h*x*a.m_tileWidth;var q=b.getPixelTop()+(s.m_nDivHeight-d)/2;var y=Math.round((-q/a.m_tileHeight-s.m_nCanvasStdYPos)/h);q+=h*y*a.m_tileHeight;for(var i=0;i<s.m_Canvas.length;++i){s.m_Canvas[i].width=s.m_nWidthCanvas;s.m_Canvas[i].height=s.m_nHeightCanvas;}s.InvalidateCanvas(s.m_Canvas[1]);s.MoveCanvas(b,p,q,h*s.m_nWidthCanvas,h*s.m_nHeightCanvas);s.m_MapManager.RequestTiles(b,s.m_MapLayerStack,k+x,l+y,s.m_nTilesX,s.m_nTilesY,0,0,0,0,n,false);var r=s.m_LastZoomArea;if(r==undefined){var u=s.GetMinLOD();if(b.m_nExactLOD<u){s.ZoomMap(Math.pow(2,u-b.m_nExactLOD)*1.000001,s.m_nDivWidth/2-p,s.m_nDivHeight/2-q);}else{if(b.m_nExactLOD!=Math.floor(b.m_nExactLOD)){s.AnimateZoomToGeo(s.GetCenterPos(),Math.floor(b.m_nExactLOD),33);}else{s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,b.m_nExactLOD);s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex]);}}var v=s.GetMaxLOD();if(b.m_nExactLOD>v){s.ZoomMap(Math.pow(2,v-b.m_nExactLOD),s.m_nDivWidth/2-p,s.m_nDivHeight/2-q);}}else{var w=new Date().getTime();if((w-r[0])<3000){switch(r[1]){case"Area":s.ZoomToArea(r[2],r[3],r[4],r[5],r[6]);break;case"Areas":s.ZoomToAreas(r[2],r[3]);break;}}}if((f||(s.GetMinLOD()!=g))&&s.m_NavControl)s.m_NavControl.AdaptMinMaxLOD(s);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(s.m_Canvas[0].m_nCurrentLOD);}s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,false,true,s.m_Canvas[0].m_nExactLOD);};if(t)s.Awake(t,m,c);return s;};
