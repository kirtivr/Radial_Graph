VBI.Clustering=
function(t){var f={};var D={};var E=1.0/1048576.0;f.m_Clusters=[];f.m_Clustergroups=[];f.m_loadCount=0;f.m_Parser=VBI.Parser();f.clear=function(){f.m_Clusters=[];};f.load=function(d,c){if(d.Set){f.clear();f.m_Parser.clear();f.m_loadCount++;var r=d.Set.Cluster;f.m_cellColor=d.Set.cellColor;f.m_bDelaunay=(d.Set.delaunay!=undefined);f.m_bShowGrid=(f.m_cellColor!=undefined);if(jQuery.type(r)=='object'){var a=new VBI.Clustering.Cluster();a.load(r,c,f.m_Clusters.length);f.m_Clusters.push(a);f.UpdateAutomaticClusterGroup(a.m_groupID);}else if(jQuery.type(r)=='array'){var b=f.m_Clusters.length;for(var n=0,l=r.length;n<l;++n){var a=new VBI.Clustering.Cluster();a.load(r[n],c,b++);f.m_Clusters.push(a);f.UpdateAutomaticClusterGroup(a.m_groupID);}}for(var n=0,l=f.m_Clustergroups.length;n<l;++n)f.m_Clusters.push(f.m_Clustergroups.shift());}};f.InvalidatePreassembledData=function(s,n){if(!s.m_PreassembledData)return;var p=s.m_PreassembledData;var a=p.m_ClusterColumns['distance'].length;var b=p.m_ClusterColumns['tree'].length;if((a==0)||(b==0)||(p.m_lod!=n)||(p.m_version!=f.m_loadCount))s.m_PreassembledData=undefined;else p.bGridDataInvalidated=true;};f.UpdateAutomaticClusterGroup=function(g){if(g=="")return;var a=f.m_Clusters[f.m_Clusters.length-1];var n,b;for(var c=0,l=f.m_Clustergroups.length;c<l;++c){var d=f.m_Clustergroups[c];if(d.m_id==g)n=c;}if(n!=undefined){var h=f.m_Clustergroups[n];h.m_limit=Math.min(a.m_limitOnSum,h.m_limit);a.m_bPartOfGrp=true;}else{for(var c=0,l=f.m_Clusters.length-1;c<l;++c){var d=f.m_Clusters[c];if((d.m_type=="grid")&&(d.m_groupID==g))b=c;}if(b!=undefined){var o=f.m_Clusters[b];var h=new VBI.Clustering.Cluster();h.m_type="clustergroup";h.m_id=g;h.m_dividerX=o.m_dividerX;h.m_dividerY=o.m_dividerY;h.m_limit=Math.min(a.m_limitOnSum,o.m_limitOnSum);h.initializeFunctions();f.m_Clustergroups.push(h);a.m_bPartOfGrp=o.m_bPartOfGrp=true;}}};f.PreassembleDataForVO=function(s,r,a,v,c){if(node=v.m_DataSource.GetCurrentNode(c)){var I=v.m_ID;for(nL=0;nL<node.m_dataelements.length;++nL){v.m_DataSource.Select(nL);var o=v.m_Pos.GetValueVector(c);var u=s.GetPointFromPos(o,true);var n=f.m_Parser.evaluate(v,a,c);var b=(n>=0)&&(f.m_Clusters[n].m_type=="distance");var d=(n>=0)&&(f.m_Clusters[n].m_type=="tree");if(u.m_bVisible||b||d){u.orgPos=o;u.h=v.BaseIsHot(nL,c);u.hscale=v.GetHotScale(c);u.hcol=v.m_HotDeltaColor.GetValueString(c);if(u.s=v.IsSelected(c)){u.scol=v.m_SelectColor.GetValueString(c);u.simag=v.m_ImageSelected.GetValueString(c);}if(u.im==undefined)u.im=v.m_Image.GetValueString(c);u.tx=v.m_Text.GetValueString(c);u.sc=v.m_Scale.GetValueVector(c);u.m_ID=I;u.nI=nL;u.b2Ignore=false;u.cl=n;if(b)r[a].containsDistClust=true;else if(d)r[a].containsTreeClust=true;else r[a].containsGridClust=true;r[a].push(u);}}}};f.InitializeResultVector=function(o,n,l){var R;if(true){R=[];for(var i=0;i<n;++i){var a=[];R.push(a);}R.bShowGrid=f.m_bShowGrid;R.m_version=f.m_loadCount;R.m_lod=l;R.m_SelectedVOs=[];R.m_ClusterColumns=[];R.m_ClusterColumns['grid']=[];R.m_ClusterColumns['distance']=[];R.m_ClusterColumns['tree']=[];}return R;};f.CheckNonClusteredVOs=function(R,C){for(var n=0;n<R.length;++n){var v=R[n];var c=0;for(nJ=0,vl=v.length;nJ<vl;++nJ){var a=v[nJ];if(a.isCl!=true){if((a.cl!=undefined)&&(a.sq!=undefined)&&(C[a.cl])[a.sq].b2Cluster)a.b2Ignore=true;if(!a.b2Ignore){a.bbInd=c;if(a.h)R.HotItemBBIndex=c;if(a.s)R.m_SelectedVOs.push({m_vo:n,m_index:nJ,m_dataIndex:nL,m_BBIndex:c});c++;}}}v.m_NumVisVOs=c;}};f.FetchClusterVOData=function(r,v,c){var a=f.m_Clusters;var b=a.length;var d=[];for(var j=0;j<b;++j)d.push({});var n=v.length;for(var i=0;i<n;++i)for(var j=0;j<b;++j)if(v[i].m_ID==a[j].m_VO){d[j].m_index=i;d[j].m_image=v[i].m_Image.GetValueString(c);d[j].m_scale=v[i].m_Scale.GetValueVector(c);d[j].m_hotscale=v[i].m_HotScale.GetValueVector(c);d[j].m_hotcol=v[i].m_HotDeltaColor.GetValueString(c);r.m_ClusterColumns[a[j].m_type].push(i);if(a[j].m_type=='grid')d[j].m_isGridType=r[i].containsGridClust=true;if(a[j].m_type=='distance')d[j].m_isDistType=r[i].containsDistClust=true;if(a[j].m_type=='tree')d[j].m_isDistType=r[i].containsTreeClust=true;}return d;};f.FetchClusterGroupData=function(){var c=f.m_Clusters;var a=c.length;var r=[];for(var i=0;i<a;++i){var s=[];if(c[i].m_type=="clustergroup")for(var j=0;j<a;++j)if((i!=j)&&(c[i].m_id==c[j].m_groupID))s.push({index:j,limit:c[j].m_limit});r.push(s);}return r;};f.RecalculatePositions=function(s,r){for(i=0;i<r.length;++i){var a=r[i];for(j=0;j<a.length;++j){var m=a[j];var u=s.GetPointFromPos(m.orgPos,true);m[0]=u[0];m[1]=u[1];}}return r;};f.DoClustering=function(s,l,x,y,n,a,v,c,b){var o=s.m_PreassembledData;if(o&&(o.m_version==f.m_loadCount)&&(o.m_ClusterColumns['grid'].length==0))return f.RecalculatePositions(s,o);var d;var R=f.InitializeResultVector(o,v.length,l);var g=f.FetchClusterVOData(R,v,c);var h=f.FetchClusterGroupData();f.m_Parser.verifyAttributes(v,c);for(d=0;d<v.length;++d){var k=v[d];if(k.IsClusterable())f.PreassembleDataForVO(s,R,d,k,c);}var C=f.InitializeClusterData(s,l,n,a);for(d=0;d<f.m_Clusters.length;++d)f.m_Clusters[d].ClusterPass1(d,R,C);for(d=0;d<f.m_Clusters.length;++d)f.m_Clusters[d].ClusterPass2(d,R,C,h);var m=(C.gridBase==undefined)?undefined:C[C.gridBase];for(d=0;d<f.m_Clusters.length;++d)f.m_Clusters[d].DecisionPass(s,d,R,C,m,g,h);f.CheckNonClusteredVOs(R,C);return R;};f.InitializeClusterData=function(s,l,n,a){var C=[];var b=(1<<l);C.numTiles=b;C.completeX=b*s.m_nWidthCanvas/s.m_nTilesX;C.completeY=b*s.m_nHeightCanvas/s.m_nTilesY;var S=f.m_bShowGrid;for(nJ=0;nJ<f.m_Clusters.length;++nJ){var c=false;var d=f.m_Clusters[nJ];var g=(n+2)*d.m_dividerX;var h=(a+2)*d.m_dividerY;if(S&&(d.m_type=="grid"||d.m_type=="clustergroup")){S=false;c=true;C.gridBase=nJ;C.bGridClustering=true;}C.push(d.InitializeClusterData(s,g,h,c));}return C;};f.UpdatePreData4Selected=function(v,a,R,b,c){var d,s;if(R.m_SelectedVOs.length){var g=R.m_SelectedVOs[0];while((R.m_SelectedVOs.length)&&(g.m_index==a)&&(g.m_vo==v)){R.m_SelectedVOs.shift();g=R.m_SelectedVOs[0];}if(R.m_SelectedVOs.length){d=b[g.m_vo];d.m_DataSource.Select(g.m_dataIndex);if(!d.IsSelected(c)){for(var i=0,l=R.m_SelectedVOs.length;i<l;++i){g=R.m_SelectedVOs[0];(R[g.m_vo])[g.m_index].s=false;R.m_SelectedVOs.shift();}}}}var h=(R[v])[a];d=b[v];d.m_DataSource.Select(h.nI);if((s=d.IsSelected(c))){R.m_SelectedVOs.unshift({m_vo:v,m_index:a,m_dataIndex:h.nI,m_BBIndex:h.bbInd});h.scol=d.m_SelectColor.GetValueString(c);h.simag=d.m_ImageSelected.GetValueString(c);}h.s=s;};VBI.Clustering.Cluster=function(){var c={};c.m_additionalProperties=[];c.clear=function(){c.m_addProperties=null;};c.load=function(d,a,b){c.m_id=d.id;c.m_type=d.type;c.m_type2=d.type2;c.m_switch=parseInt(d.typeswitch);c.m_bPartOfGrp=false;c.m_VO=d.VO;c.m_order=parseInt(d.order);c.m_dispOffsetX=parseInt(d.offsetX);if(isNaN(c.m_dispOffsetX))c.m_dispOffsetX=0;c.m_dispOffsetY=parseInt(d.offsetY);if(isNaN(c.m_dispOffsetY))c.m_dispOffsetY=0;f.m_Parser.addFormula(b,d.rule==undefined?"":d.rule);c.m_textcolor=d.textcolor;if(c.m_textcolor==undefined)c.m_textcolor="rgba(0,0,0,0.7)";c.m_textfont=d.textfont;c.m_textfontscale=d.textfontscale;if(isNaN(c.m_textfontscale))c.m_textfontscale=2.0;c.m_textoffset=parseInt(d.textoffset);if(isNaN(c.m_textoffset))c.m_textoffset=0;if(c.m_type=="grid"){c.m_distanceX=((d.distanceX==undefined)||(d.distanceX<=0))?256:d.distanceX;c.m_dividerX=Math.max(1,Math.round(256/c.m_distanceX));c.m_distanceY=((d.distanceY==undefined)||(d.distanceY<=0))?256:d.distanceY;c.m_dividerY=Math.max(1,Math.round(256/c.m_distanceY));c.m_groupID=(d.groupID==undefined?"&":d.groupID)+c.m_dividerX+"_"+c.m_dividerY;c.m_omitEmpties=(d.showEmpties!="true");}if(c.m_type=="distance"){c.m_distance=d.distance;if(c.m_distance==undefined||c.m_distance<=0)c.m_distance=128;}if(c.m_type=="tree"){c.m_distance=d.distance;if(c.m_distance==undefined||c.m_distance<=0)c.m_distance=128;}c.m_limit=parseInt(d.limit);c.m_limitOnSum=d.limitOnSum==undefined?999999:parseInt(d.limitOnSum);c.initializeFunctions();};c.initializeFunctions=function(){switch(c.m_type){case"grid":c.InitializeClusterData=c.InitializeGridClusterData;c.ClusterPass1=c.gridClusteringCounting;c.ClusterPass2=c.NothingToDo;c.DecisionPass=c.gridBasedDecision;c.CheckClusterData=c.CheckSingleClusterData;break;case"clustergroup":c.InitializeClusterData=c.InitializeGridClusterData;c.ClusterPass1=c.NothingToDo;c.ClusterPass2=c.gridClustergroupCounting;c.DecisionPass=c.gridBasedDecision;c.CheckClusterData=c.CheckGroupClusterData;break;case"distance":c.InitializeClusterData=c.InitializeDistClusterData;c.ClusterPass1=c.NothingToDo;c.ClusterPass2=c.NothingToDo;c.DecisionPass=c.distanceBasedDecision;c.CheckClusterData=c.NothingToDo;break;case"tree":c.InitializeClusterData=c.InitializeTreeClusterData;c.ClusterPass1=c.NothingToDo;c.ClusterPass2=c.NothingToDo;c.DecisionPass=c.treeBasedDecision;c.CheckClusterData=c.NothingToDo;break;}};c.gridClusteringCounting=function(n,R,C){var m=C[n];var x=m.nX;var y=m.nY;var a=x*y;var b=c.m_dividerX*C.numTiles/C.completeX;var d=c.m_dividerY*C.numTiles/C.completeX;var g,h,k;var l,o,p;for(var q=0;q<R.length;++q){o=R[q];for(nJ=0;nJ<o.length;++nJ){p=o[nJ];if(p.cl==n){g=Math.floor((p[0])*b);h=Math.floor((p[1])*d);k=g+x*h;if((k>=0)&&(k<a)){p.sq=k;m[k].numInst++;}}}}};c.gridClustergroupCounting=function(n,R,C,g){var a,b;var m=g[n];var d=m.length;var h=C[n];for(nK=0;nK<h.length;++nK){var k=0;a=h[nK];a.bLimitExceeded=false;for(nL=0;nL<d;++nL){var l=m[nL].index;var o=C[l];var p=o[nK].numInst;k+=p;if(p>=m[nL].limit)a.bLimitExceeded=true;}a.numInst=k;}};c.distanceBasedDecision=function(s,n,R,C,b,a,g){var d=f.m_Clusters[n];distance=d.m_distance;var h=c.doDistClustering(n,R,distance,C.completeX);c.distFillClusterData(s,h,R,a[n]);};c.treeBasedDecision=function(s,n,R,C,b,a,g){var d=f.m_Clusters[n];distance=d.m_distance;var h=c.doTreeClustering(n,R,distance,C.completeX);c.treeFillClusterData(s,h,R,a[n]);};c.gridBasedDecision=function(s,n,R,C,b,a,g){var d=f.m_Clusters[n];if(!d.m_bPartOfGrp){clustsq=C[n];for(var x=0;x<clustsq.nX;++x){for(var y=0;y<clustsq.nY;++y){nJ=x+clustsq.nX*y;var S=(b!=undefined)?b[nJ].bShowGrid:false;S=d.CheckClusterData(R,C,clustsq[nJ],n,nJ,x,y,a,g[n],S);if(b)b[nJ].bShowGrid=S;}}}};c.NothingToDo=function(){};c.ReturnFalse=function(){return false;};c.CheckSingleClusterData=function(R,C,a,n,b,x,y,v,d,s){if(a.numInst>=c.m_limit){var t=C[n];f.m_Clusters[n].FillClusterData(R,t[b],x,y,C[n].XPerTile,C[n].YPerTile,v[n],s);return false;}a.b2Cluster=false;return s;};c.CheckGroupClusterData=function(R,C,a,n,b,x,y,v,d,s){if(a.bLimitExceeded||(a.numInst>=c.m_limit)){for(var i=0;i<d.length;++i){var g=d[i].index;var t=C[g];s=f.m_Clusters[g].FillClusterData(R,t[b],x,y,C[n].XPerTile,C[n].YPerTile,v[g],s);}}else{a.b2Cluster=false;for(var i=0;i<d.length;++i){var t=C[d[i].index];t[b].b2Cluster=false;}}return s;};c.InitializeGrid=function(m,n,a,b){m=[];for(var x=0;x<n;++x)for(var y=0;y<a;++y){var d=[];if(bShowGrid)d.bShowGrid=true;myGrid.push(d);}};c.InitializeGridClusterData=function(s,n,a,S){var m=[];m.nX=n;m.nY=a;m.XPerTile=s.m_nWidthCanvas/(s.m_nTilesX*c.m_dividerX);m.YPerTile=s.m_nHeightCanvas/(s.m_nTilesY*c.m_dividerY);for(var x=0;x<n;++x)for(var y=0;y<a;++y){var b={};b.numInst=0;if(S)b.bShowGrid=true;m.push(b);}return m;};c.InitializeDistClusterData=function(s,n,a,S){var b={};b.numInst=0;b.type=c.m_type;return b;};c.InitializeTreeClusterData=function(s,n,a,S){var b={};b.numInst=0;b.type=c.m_type;return b;};c.FillClusterData=function(R,a,x,y,b,d,v,s){if(c.m_omitEmpties&&!a.numInst){a.b2Cluster=false;return s;}a.b2Cluster=true;var g=y*d;var h=g+d;var k=x*b;var l=k+b;var m=b/2;var n=d/2;var o=[k+m+c.m_dispOffsetX,g+n+c.m_dispOffsetY,0,0];o.h=o.s=false;o.im=v.m_image;o.sc=v.m_scale;o.hscale=v.m_hotscale;o.hcol=v.m_hotcol;if(c.m_textfont!=undefined){o.ct=""+a.numInst;o.f=c.m_textfont;o.fc=c.m_textcolor;o.fs=c.m_textfontscale;o.fo=c.m_textoffset;}if(s){o.centX=k+m;o.centY=g+n;o.halfxSize=m;o.halfySize=n;o.cellColor=f.m_cellColor;}o.isCl=true;o.nI=-1;R[v.m_index].push(o);return false;};c.doDistClustering=function(n,R,d,g){var T=[];var h={};for(var i=0;i<R.length;++i){h=R[i];for(var j=0;j<h.length;++j){if(h[j].cl==n)T.push(h[j]);}}var k=new Array(T.length);var a,l,b;for(var i=0;i<T.length;++i){a=T[i];k[i]=[a[0],a[1]];}var m=[];if(f.m_bDelaunay){m=D.triangulate(k);m.sort(function(a,b){var B=a.l-b.l;if(B)return B;B=a.s-b.s;return B?B:a.d-b.d;});}T.sort(function(a,b){return a[0]-b[0]});var o=T.length-1;var G=0;for(var i=0;i<o;++i){a=T[i];b=T[i+1];l=b[0]-a[0];if(l>d){G=i+1;break;}}var p=[];var q,r,x,s,u,v;var w=T.length+G;var y=T.length;for(var i=G;i<w;++i){u=i%y;var a=T[u];if(a.isGrouped)continue;x=a[0];if(i>y-1)x+=g;for(var j=i+1;j<w;++j){v=j%y;var b=T[v];if(b.isGrouped)continue;s=b[0];if(j>y-1)s+=g;if(s-x<=d){if(p.length<=0){q=a[1];r=a[1];}else{if(a.isGrouped){q=p[a.nGrp].minY;r=p[a.nGrp].maxY;}else{q=a[1];r=a[1];}}if(Math.abs(b[1]-q)<=d&&Math.abs(b[1]-r)<=d){if(a.isGrouped){p[a.nGrp].push(b);b.isGrouped=true;b.nGrp=a.nGrp;b.b2Ignore=true;if(b.objRef!=undefined)b.objRef.b2Ignore=true;if(b[1]<p[a.nGrp].minY)p[a.nGrp].minY=b[1];if(b[1]>p[a.nGrp].maxY)p[a.nGrp].maxY=b[1];if(s<p[a.nGrp].minX)p[a.nGrp].minX=s;if(s>p[a.nGrp].maxX)p[a.nGrp].maxX=s;if(p[a.nGrp].sumX==undefined)p[a.nGrp].sumX=s;else p[a.nGrp].sumX+=s;if(p[a.nGrp].sumY==undefined)p[a.nGrp].sumY=b[1];else p[a.nGrp].sumY+=b[1];}else{var z=[];z.push(a);z.push(b);p.push(z);var A=p.length-1;a.isGrouped=true;a.nGrp=A;a.b2Ignore=true;b.isGrouped=true;b.nGrp=A;b.b2Ignore=true;if(a.objRef!=undefined)a.objRef.b2Ignore=true;if(b.objRef!=undefined)b.objRef.b2Ignore=true;if(a[1]<b[1]){p[A].minY=a[1];p[A].maxY=b[1];}else{p[A].minY=b[1];p[A].maxY=a[1];}if(x<s){p[A].minX=x;p[A].maxX=s;}else{p[A].minX=s;p[A].maxX=x;}if(p[A].sumX==undefined)p[A].sumX=x+s;else p[A].sumX+=x+s;if(p[A].sumY==undefined)p[A].sumY=a[1]+b[1];else p[A].sumY+=a[1]+b[1];}}}else break;}}return p;};c.distFillClusterData=function(s,d,R,v){var L=s.m_Canvas[0].m_nExactLOD-s.m_Canvas[0].m_nCurrentLOD;var a=Math.pow(2,L);for(var i=0;i<d.length;++i){var l=d[i].length;var x=d[i].sumX/l+c.m_dispOffsetX;var y=d[i].sumY/l+c.m_dispOffsetY;var b=[x,y,0,0];b.orgPos=s.GetPosFromPoint([x*a,y*a]);b.h=false;b.hscale=v.m_hotscale;b.hcol=v.m_hotcol;b.s=false;b.im=v.m_image;b.sc=v.m_scale;if(c.m_textfont!=undefined){b.ct=""+l;b.f=c.m_textfont;b.fc=c.m_textcolor;b.fs=c.m_textfontscale;b.fo=c.m_textoffset;}b.cobjs=d[i];b.isCl=true;R[v.m_index].push(b);}return true;};c.doTreeClustering=function(n,R,d,g){var T=[];var h={};for(var i=0;i<R.length;++i){h=R[i];for(var j=0;j<h.length;++j){if(h[j].cl==n){h[j].lod=20;T.push(h[j]);}}}var a,k,b;T.sort(function(a,b){return a[0]!=b[0]?a[0]-b[0]:a[1]-b[1]});var l=T.length-1;var G=0;var m=[];var o=T[0];lastP=T[l];if(l<2)return[];var p=o[0]-lastP[0]+g;if(p<d){for(var i=0;i<l;++i){a=T[i];b=T[i+1];k=b[0]-a[0];if(k>p){G=i+1;p=k;if(p>d)break;}}}var q=T.length;var r=G+q;var s=0;var u=-1,v;var z=[];for(var i=G;i<r;++i){if(i>=q){j=i-q;s=g;}else{j=i;}a=T[j];if(u!=-1&&a[0]===v[0]&&a[1]===v[1]){z.push({s:u,d:j,l:0});}else{m.push([a[0]+s,a[1],j]);u=j;v=a;}}VBI.Trace("clustering "+l+" elements with "+z.length+" zero edges.");var w=D.triangulate(m);w.sort(function(a,b){var A=a.l-b.l;if(A)return A;A=a.s-b.s;return A?A:a.d-b.d;});var x=z.concat(w);c.buildTree(T,x,d,g);var y=[];return y;};c.buildTree=function(n,a,d,b){var l=Math.log2(b);var g=0;var p=undefined;var h,k,m,o,q,r,s;for(e=0;e<a.length;++e){var u=a[e];if(p&&(u.s==p.s)&&(u.d==p.d))continue;p=u;m=h=n[u.s];o=k=n[u.d];while(m.c!=undefined)m=m.c;while(o.c!=undefined)o=o.c;var v=Math.floor(u.l?Math.min(22,l+Math.log2(d/u.l)):22);if(!m.bCluster){if(!o.bCluster){var w={lod:v,ident:++g,bCluster:true,cnt:2};w.bw=[m,o];m.c=w;o.c=w;}else{if(o.lod==v){h.c=o;o.bw.push(h);o.cnt++;}else{var w={lod:v,ident:++g,bCluster:true,cnt:2};w.bw=[m,o];m.c=w;o.c=w;}}}else{if(!o.bCluster){if(m.lod==v){k.c=m;m.bw.push(k);m.cnt++;}else{var w={lod:v,ident:++g,bCluster:true,cnt:2};w.bw=[m,o];m.c=w;o.c=w;}}else{if(v<Math.min(o.lod,m.lod)){var w={lod:v,ident:++g,bCluster:true,cnt:2};w.bw=[m,o];m.c=w;o.c=w;}else{if(m.ident==o.ident)continue;if((o.lod<m.lod)||((o.lod==m.lod)&&(o.cnt>m.cnt))){q=m;r=o;}else{q=o;r=m;}for(i=q.bw.length;i--;){s=q.bw[i];if(s==undefined)debugger;s.c=r;r.bw.push(s);r.cnt++;q.bw[i]=undefined;}}}}}};c.treeFillClusterData=function(s,a,R,v){var L=s.m_Canvas[0].m_nExactLOD-s.m_Canvas[0].m_nCurrentLOD;var b=Math.pow(2,L);for(var i=0;i<a.length;++i){var l=a[i].length;var x=a[i].sumX/l+c.m_dispOffsetX;var y=a[i].sumY/l+c.m_dispOffsetY;var d=[x,y,0,0];d.orgPos=s.GetPosFromPoint([x*b,y*b]);d.h=false;d.hscale=v.m_hotscale;d.hcol=v.m_hotcol;d.s=false;d.im=v.m_image;d.sc=v.m_scale;if(c.m_textfont!=undefined){d.ct=""+l;d.f=c.m_textfont;d.fc=c.m_textcolor;d.fs=c.m_textfontscale;d.fo=c.m_textoffset;}d.isCl=true;R[v.m_index].push(d);}return true;};return c;};D={supertriangle:function(v){var x=Number.POSITIVE_INFINITY,y=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,b=Number.NEGATIVE_INFINITY,i,d,c,g,h,k;for(i=v.length;i--;){if(v[i][0]<x)x=v[i][0];if(v[i][0]>a)a=v[i][0];if(v[i][1]<y)y=v[i][1];if(v[i][1]>b)b=v[i][1];}d=a-x;c=b-y;g=Math.max(d,c);h=x+d*0.5;k=y+c*0.5;return[[h-20*g,k-g,-1],[h,k+20*g,-2],[h+20*g,k-g,-3]];},circumcircle:function(v,i,j,k){var x=v[i][0],y=v[i][1],a=v[j][0],b=v[j][1],c=v[k][0],d=v[k][1],g=Math.abs(y-b),h=Math.abs(b-d),l,m,n,o,p,q,r,s,u,w;if(g<E&&h<E)throw new Error("Eek! Coincident points!");if(g<E){o=-((c-a)/(d-b));q=(a+c)/2.0;s=(b+d)/2.0;l=(a+x)/2.0;m=o*(l-q)+s;}else if(h<E){n=-((a-x)/(b-y));p=(x+a)/2.0;r=(y+b)/2.0;l=(c+a)/2.0;m=n*(l-p)+r;}else{n=-((a-x)/(b-y));o=-((c-a)/(d-b));p=(x+a)/2.0;q=(a+c)/2.0;r=(y+b)/2.0;s=(b+d)/2.0;l=(n*p-o*q+s-r)/(n-o);m=(g>h)?n*(l-p)+r:o*(l-q)+s;}u=a-l;w=b-m;return{i:i,j:j,k:k,x:l,y:m,r:u*u+w*w};},dedup:function(c){var i,j,a,b,m,n;for(j=c.length;j;){b=c[--j];a=c[--j];for(i=j;i;){n=c[--i];m=c[--i];if((a===m&&b===n)||(a===n&&b===m)){c.splice(j,2);c.splice(i,2);break;}}}},triangulate:function(v,k){var n=v.length,i,j,d,s,o,g,h,l,m,a,b,c;if(n<3)return[];v=v.slice(0);if(k)for(i=n;i--;)v[i]=v[i][k];d=new Array(n);for(i=n;i--;)d[i]=i;d.sort(function(i,j){return v[j][0]-v[i][0];});s=this.supertriangle(v);v.push(s[0],s[1],s[2]);o=[this.circumcircle(v,n+0,n+1,n+2)];g=[];h=[];for(i=d.length;i--;h.length=0){c=d[i];for(j=o.length;j--;){l=v[c][0]-o[j].x;if(l>0.0&&l*l>o[j].r){g.push(o[j]);o.splice(j,1);continue;}m=v[c][1]-o[j].y;if(l*l+m*m-o[j].r>E)continue;h.push(o[j].i,o[j].j,o[j].j,o[j].k,o[j].k,o[j].i);o.splice(j,1);}this.dedup(h);for(j=h.length;j;){b=h[--j];a=h[--j];o.push(this.circumcircle(v,a,b,c));}}for(i=o.length;i--;)g.push(o[i]);o.length=0;for(i=g.length;i--;)if(g[i].i<n&&g[i].j<n&&g[i].k<n){var p=[g[i].i,g[i].j,g[i].k];p.sort();var q=v[p[0]],r=v[p[1]],u=v[p[2]];var w=((q[0]-r[0])*(q[0]-r[0])+(q[1]-r[1])*(q[1]-r[1]));var x=((q[0]-u[0])*(q[0]-u[0])+(q[1]-u[1])*(q[1]-u[1]));var y=((u[0]-r[0])*(u[0]-r[0])+(u[1]-r[1])*(u[1]-r[1]));o.push({s:(v[p[0]])[2],d:(v[p[1]])[2],l:w});o.push({s:(v[p[0]])[2],d:(v[p[2]])[2],l:x});o.push({s:(v[p[1]])[2],d:(v[p[2]])[2],l:y});}return o;},contains:function(g,p){if((p[0]<g[0][0]&&p[0]<g[1][0]&&p[0]<g[2][0])||(p[0]>g[0][0]&&p[0]>g[1][0]&&p[0]>g[2][0])||(p[1]<g[0][1]&&p[1]<g[1][1]&&p[1]<g[2][1])||(p[1]>g[0][1]&&p[1]>g[1][1]&&p[1]>g[2][1]))return null;var a=g[1][0]-g[0][0],b=g[2][0]-g[0][0],c=g[1][1]-g[0][1],d=g[2][1]-g[0][1],i=a*d-b*c;if(i===0.0)return null;var u=(d*(p[0]-g[0][0])-b*(p[1]-g[0][1]))/i,v=(a*(p[1]-g[0][1])-c*(p[0]-g[0][0]))/i;if(u<0.0||v<0.0||(u+v)>1.0)return null;return[u,v];}};return f;}
;
