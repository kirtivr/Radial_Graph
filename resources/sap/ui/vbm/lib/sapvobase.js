
VBI.Utilities.SceneBindDesignSpotBoxSize=function(o){var s=this.m_Scene;if(o.m_Design&&(o.m_Hit==VBI.HTBOXHANDLE)&&this.m_Scale.IsChangeable(s.m_Ctx)){if(o.m_Handle>6)return;var z=s.GetCurrentZoomFactors();var n=o.m_ClientX/z[0];var a=o.m_ClientY/z[1];var b=o.m_DhOrig[0];var m=(b[0]+b[2])/2.0;var w=(b[2]-b[0])/2.0;var h=(b[3]-b[1]);var f=1.0,c=1.0;switch(o.m_Handle){case 1:c=Math.abs(a-b[3])/h;break;case 2:c=Math.abs(a-b[3])/h;case 5:f=Math.abs(n-m)/w;break;case 0:c=Math.abs(a-b[3])/h;case 3:f=Math.abs(n-m)/w;break;}var d=o.m_ScaleOrig.slice(0);d[0]*=f;d[1]*=c;this.m_Scale.SetValueVector(s.m_Ctx,d);}};
VBI.Utilities.SceneBindDesignBoxBoxSize=function(k,o){var s=this.m_Scene;if(o.m_Design&&(o.m_Hit==VBI.HTBOXHANDLE)&&this.m_Scale.IsChangeable(s.m_Ctx)){var z=s.GetCurrentZoomFactors();var n=o.m_ClientX/z[0];var a=o.m_ClientY/z[1];var b=o.m_DhOrig[0];var m=(b[0]+b[2])/2.0;var c=(b[1]+b[3])/2.0;var w=(b[2]-b[0])/2.0;var h=(b[3]-b[1])/2.0;var f=1.0,d=1.0;switch(o.m_Handle){case 0:case 2:case 6:case 8:f=Math.abs(n-m)/w;d=Math.abs(a-c)/h;if(k)f=d=Math.max(f,d);break;case 1:case 7:d=Math.abs(a-c)/h;if(k)f=d;break;case 3:case 5:f=Math.abs(n-m)/w;if(k)d=f;break;}var e=o.m_ScaleOrig.slice(0);e[0]*=f;e[1]*=d;this.m_Scale.SetValueVector(s.m_Ctx,e);}};
VBI.Utilities.SceneBindMeterRadiusDesignBoxSize=function(o){var s=this.m_Scene;if(o.m_Design){var c=this.m_Pos.GetValueVector(s.m_Ctx);var a=s.GetPosFromPoint([o.m_ClientX,o.m_ClientY,0]);var r=0;switch(o.m_Handle){case 1:case 7:r=VBI.MathLib.Distance(VBI.MathLib.DegToRad(c),VBI.MathLib.DegToRad([c[0],a[1]]));break;case 3:case 5:r=VBI.MathLib.Distance(VBI.MathLib.DegToRad(c),VBI.MathLib.DegToRad([a[0],c[1]]));break;}this.m_Radius.SetValueFloat(s.m_Ctx,Math.abs(r));}};
VBI.Utilities.SceneBindRadiusDesignBoxSize=function(o){var s=this.m_Scene;if(o.m_Design){var c=this.m_Pos.GetValueVector(s.m_Ctx);var a=s.GetPointFromPos(c);var r=0;switch(o.m_Handle){case 1:case 7:r=(a[1]-o.m_ClientY);break;case 3:case 5:r=(a[0]-o.m_ClientX);break;}this.m_Radius.SetValueFloat(s.m_Ctx,Math.abs(r));}};
VBI.Utilities.SceneBindPosArrayDesignBoxSize=function(o){var s=this.m_Scene;if(o.m_Design){var p=s.GetPosFromPoint([o.m_ClientX,o.m_ClientY,0]);var m=Number.MAX_VALUE;var a=-Number.MAX_VALUE;var b=Number.MAX_VALUE;var c=-Number.MAX_VALUE;var d=o.m_PosOrig.slice(0);var n,l=d.length/3,i;for(n=0;n<l;++n){i=n*3;if(m>d[i])m=d[i];if(a<d[i])a=d[i];if(b>d[i+1])b=d[i+1];if(c<d[i+1])c=d[i+1];}var e=0,f=1;var g=0,h=1;switch(o.m_Handle){case 0:e=a;f=(p[0]-a)/(m-a);case 1:g=b;h=(p[1]-b)/(c-b);break;case 2:g=b;h=(p[1]-b)/(c-b);case 5:e=m;f=(p[0]-m)/(a-m);break;case 6:g=c;h=(p[1]-c)/(b-c);case 3:e=a;f=(p[0]-a)/(m-a);break;case 8:e=m;f=(p[0]-m)/(a-m);case 7:g=c;h=(p[1]-c)/(b-c);break;}for(n=0;n<l;++n){var i=n*3;d[i]=e+(d[i]-e)*f;d[i+1]=g+(d[i+1]-g)*h;}this.m_Pos.SetValueVector(s.m_Ctx,d);}};
VBI.Utilities.BackupFont=function(d){d.m_BackupFont=[];d.m_BackupFont.m_font=d.m_font=d.font;d.m_BackupFont.m_fillStyle=d.fillStyle;d.m_BackupFont.m_strokeStyle=d.strokeStyle;d.m_BackupFont.m_textAlign=d.textAlign;d.m_BackupFont.m_textBaseline=d.textBaseline;};
VBI.Utilities.RestoreFont=function(d){d.m_font=d.font=d.m_BackupFont.m_font;d.fillStyle=d.m_BackupFont.m_fillStyle;d.strokeStyle=d.m_BackupFont.m_strokeStyle;d.textAlign=d.m_BackupFont.m_textAlign;d.textBaseline=d.m_BackupFont.m_textBaseline;};
VBI.Utilities.SetTextAttributes=function(d,n,a,b,c,e){if((n!=undefined)&&(d.m_font!=n)){d.m_font=d.font=n;}d.fillStyle=a;d.strokeStyle=b;d.textAlign=c;d.textBaseline=e;};
VBI.Utilities.SetFont=function(d,n){if((n!=undefined)&&(d.m_font!=n)){d.m_font=d.font=n;}};
VBI.Label=function(l,r,p,a,i){this.m_bAligned=false;this.m_aIO=i;this.m_rcBox=a;this.m_Text=l.labeltext;this.m_BgColor=l.bgColor;this.m_Align=l.Align;this.m_Padding=2;this.m_PosArray=p;this.m_Pos=[];this.m_Width=0;this.m_Height=0;this.m_LabelTextColor=[];if(!r){var n=Math.floor(this.m_PosArray.pa.length/3)*3;for(var b=0;b<i.length;b++){var t=[];for(var c=0;c<n;c+=3){var d=[this.m_PosArray.pa[c]+i[b],this.m_PosArray.pa[c+1]];t.push(d);}this.m_Pos.push(t);}}this.CalculateLabelPos=r;this.GetLabelTextColor=function(){if(!this.m_LabelTextColor.length){var e=VBI.Types.string2rgba(this.m_BgColor);if(e[3]==0&&e[4]==1){this.m_LabelTextColor[0]="#FFFFFF";this.m_LabelTextColor[1]="#000000";}else{var f=(299*250+587*250+114*250)/1000.0;var g=(299*e[0]+587*e[1]+114*e[2])/1000.0;if(Math.abs(g-f)<=125.0)this.m_LabelTextColor[0]="#000000";else this.m_LabelTextColor[0]="#FAFAFA";}}return this.m_LabelTextColor;};this.SetDimensions=function(e){if(!this.m_Width||!this.m_Height){var s=this.m_Text.split(/\r\n/);var f=0;var g=0;var h=VBI.Utilities.RemToPixel(0.75);for(var j=0;j<s.length;j++){var k=s[j].length;if(k>f){f=k;g=j;}}this.m_Width=e.measureText(s[g]).width+this.m_Padding*2;this.m_Height=h*s.length+this.m_Padding*2;}};this.AlignLabel=function(){if(!this.m_bAligned&&this.m_rcBox){for(var c=0;c<this.m_Pos.length;c++){for(var e=0;e<this.m_Pos[c].length;e++){var d=this.m_Pos[c][e];switch(this.m_Align){case 0:d[0]-=this.m_Width/2;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])/2+this.m_Height/2;break;case 1:d[0]-=this.m_Width/2;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])+this.m_Height;break;case 2:d[0]+=(this.m_rcBox[2]-this.m_rcBox[0])/2;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])+this.m_Height;break;case 3:d[0]+=(this.m_rcBox[2]-this.m_rcBox[0])/2;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])/2+this.m_Height/2;break;case 4:d[0]+=(this.m_rcBox[2]-this.m_rcBox[0])/2;break;case 5:d[0]-=(this.m_Width/2);break;case 6:d[0]-=(this.m_rcBox[2]-this.m_rcBox[0])/2+this.m_Width;break;case 7:d[0]-=(this.m_rcBox[2]-this.m_rcBox[0])/2+this.m_Width;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])/2+this.m_Height/2;break;case 8:d[0]-=(this.m_rcBox[2]-this.m_rcBox[0])/2+this.m_Width;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])+this.m_Height;break;default:break;}if(!this.CalculateLabelPos)d[0]+=this.m_aIO[e];}}}this.m_bAligned=true;};this.clear=function(){this.CalculateLabelPos=null;this.m_Pos=null;this.m_PosArray=null;this.m_rcBox=null;this.m_aIO=null;this.m_LabelTextColor=null;};return this;};
VBI.DnDInfo=function(){var d={};d.m_datasource=null;d.m_boundtype=null;d.m_type=[];d.clear=function(){for(var n=0;n<d.m_type.length;++n)d.m_type[n].clear();if(d.m_boundtype)d.m_boundtype.clear();if(d.m_datasource)d.m_datasource.clear();d.m_datasource=null;d.m_boundtype=null;d.m_type=[];};d.load=function(a,c,i){if(a){if(jQuery.type(a)=='array'){for(var n=0;n<a.length;++n){if(jQuery.type(a[n])=='object'){if(a[n].datasource){d.m_datasource=new VBI.NodeProperty(a[n],'datasource',i.m_DataSource,c);d.m_boundtype=new VBI.AttributeProperty(a[n],'type',d.m_datasource,c);}else d.m_type.push(new VBI.AttributeProperty(a[n],'type',null,c));}}}else if(jQuery.type(a)=='object'){if(a.datasource){d.m_datasource=new VBI.NodeProperty(a,'datasource',i.m_DataSource,c);d.m_boundtype=new VBI.AttributeProperty(a,'type',d.m_datasource,c);}else d.m_type.push(new VBI.AttributeProperty(a,'type',null,c));}}};d.getItemArray=function(c){var v=[];if(d.m_datasource){var a=d.m_datasource;var n;if(n=a.GetCurrentNode(c)){for(var b=0;b<n.m_dataelements.length;++b){a.Select(b);v.push(d.m_boundtype.GetValueString(c));}}}if(d.m_type.length){for(var b=0;b<d.m_type.length;++b)v.push(d.m_type[b].GetValueString(c));}return v;};return d;};
VBI.NodeProperty=function(d,n,p,c){var a=null;if(!(a=d[n]))a=d[n+".bind"];this.m_NPath=a.split(".");this.m_Path=a.split(".");this.m_PNP=p;this.m_nCurElement=0;this.m_CurElement=null;this.m_DTN=c.m_DataTypeProvider.FindTypeNodeFromPath(this.m_Path);var t=this;while(t=t.m_PNP){if(c.m_DataTypeProvider.isParentOf(t.m_DTN,this.m_DTN)){var b,e=t.m_DTN.GetPath();for(b=0;b<e.length;++b){if(this.m_NPath[0]==e[b])this.m_NPath.splice(0,1);else break;}break;}}this.m_PNP=t;this.NotifyDataChange=function(c){this.m_CurElement=null;this.m_DTN=c.m_DataTypeProvider.FindTypeNodeFromPath(this.m_Path);};this.clear=function(){this.m_PNP=null;this.m_CurElement=null;this.m_DTN=null;this.m_NPath=null;this.m_Path=null;};this.GetCurrentElement=function(c){if(this.m_CurElement)return this.m_CurElement;var f=this.GetCurrentNode(c);if(!f)return null;return(this.m_CurElement=f.m_dataelements[this.m_nCurElement]);};this.GetIndexedElement=function(c,i){var f=this.GetCurrentNode(c);if(!f)return null;return f.m_dataelements[i];};this.GetCurrentNode=function(c){var f=null;if(this.m_PNP){var g=this.m_PNP.GetCurrentElement(c);f=g.FindNodeFromPath(this.m_NPath);}else{f=c.m_DataProvider.FindNodeFromPath(this.m_NPath);}return f;};this.Select=function(i){this.m_CurElement=null;this.m_nCurElement=i;};this.SetEditMode=function(c,m){var f;if(f=this.GetCurrentElement(c))f.m_EditMode=m;};this.GetEditMode=function(c){var f;if((f=this.GetCurrentElement(c))&&(f.m_EditMode!=undefined))return f.m_EditMode;return VBI.EMHandle;};this.IsElementSelected=function(c){var f;if(f=this.GetCurrentElement(c))return f.IsSelected();return false;};this.SetSelected=function(c,s){return;};return this;};
VBI.AttributeProperty=function(d,n,p,c,a){var v;this.m_DefaultValue=a;if(v=d[n]){this.m_Name=n;this.m_Value=v;}else if(v=d[n+".bind"]){this.m_PNP=p;this.m_Name=n;this.m_RelBind=v.split(".");this.m_AbsBind=v.split(".");this.m_DTA=c.m_DataTypeProvider.FindTypeAttributeFromPath(this.m_AbsBind);var t=this;while(t=t.m_PNP){if(c.m_DataTypeProvider.isParentOf(t.m_DTN,this.m_DTA)){var b,e=t.m_DTN.GetPath();for(b=0;b<e.length;++b){if(this.m_RelBind[0]==e[b])this.m_RelBind.splice(0,1);else break;}break;}}this.m_PNP=t;}this.NotifyDataChange=function(c){if(this.m_AbsBind)this.m_DTA=c.m_DataTypeProvider.FindTypeAttributeFromPath(this.m_AbsBind);};this.clear=function(){this.m_PNP=null;this.m_DTA=null;this.m_DefaultValue=null;if(this.m_Name)this.m_Name=null;if(this.m_Value)this.m_Value=null;if(this.m_PNP)this.m_PNP=null;if(this.m_RelBind)this.m_RelBind=null;if(this.m_AbsBind)this.m_AbsBind=null;};this.IsChangeable=function(c){var f;if(f=this.GetAttributeObject(c))return f.IsChangeable();return false;};this.GetAttributeObject=function(c){if(this.m_RelBind){if(this.m_PNP)return this.m_PNP.GetCurrentElement(c).FindAttributeFromPath(this.m_RelBind);else return c.m_DataProvider.FindAttributeFromPath(this.m_RelBind);}return null;};this.GetValueFloat=function(c){if(this.m_Value)return VBI.Types.string2float(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if(f.m_dta.m_Type==VBI.Types.st_float)return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2float(f.m_Value);if(f.m_dta.m_Type==VBI.Types.st_long)return VBI.Types.long2float(f.m_Value);if(f.m_dta.m_Type==VBI.Types.st_bool)return f.m_Value?1.0:0.0;}}return this.m_DefaultValue;};this.GetValueString=function(c){if(this.m_Value)return this.m_Value;if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if(f.m_dta.m_Type==VBI.Types.st_string)return f.m_Value;else return f.GetStringValue();}};return this.m_DefaultValue;};this.GetValueLong=function(c){if(this.m_Value)return VBI.Types.string2long(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if(f.m_dta.m_Type==VBI.Types.st_long)return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_bool)return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2long(f.m_Value);if(f.m_dta.m_Type==VBI.Types.st_float)return VBI.Types.float2long(f.m_Value);}};return this.m_DefaultValue;};this.GetValueBool=function(c){if(this.m_Value)return VBI.Types.string2bool(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if(f.m_dta.m_Type==VBI.Types.st_bool)return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2bool(f.m_Value);}};return this.m_DefaultValue;};this.GetValueVector=function(c){if(this.m_Value)return VBI.Types.string2vector(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if((f.m_dta.m_Type==VBI.Types.st_vector)||(f.m_dta.m_Type==VBI.Types.st_vectorarray))return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2vector(f.m_Value);}}return this.m_DefaultValue;};this.GetValueColor=function(c){if(this.m_Value)return VBI.Types.string2color(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if((f.m_dta.m_Type==VBI.Types.st_color))return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2color(f.m_Value);}}return this.m_DefaultValue;};this.SetValueVector=function(c,v){if(this.m_Value)return null;if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if((f.m_dta.m_Type==VBI.Types.st_vector)||(f.m_dta.m_Type==VBI.Types.st_vectorarray))f.set(v);if(f.m_dta.m_Type==VBI.Types.st_string)f.set(VBI.Types.float2string(v));}}return null;};this.SetValueFloat=function(c,v){if(this.m_Value)return null;if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if((f.m_dta.m_Type==VBI.Types.st_float))f.set(v);else if((f.m_dta.m_Type==VBI.Types.st_long))f.set(VBI.Types.float2long(v));else if(f.m_dta.m_Type==VBI.Types.st_string)f.set(VBI.Types.float2string(v));}}return null;};this.IsBound=function(){return this.m_RelBind?true:false;};return this;};
VBI.VisualObjects=function(){VBI.EMHandle=0;VBI.EMBox=1;VBI.HTHANDLE=0;VBI.HTBOX=1;VBI.HTBOXHANDLE=2;var v={};v.vbiclass="VisualObjects";v.Factory={"{00100000-2012-0004-B001-64592B8DB964}":function(){return new VBI.VisualObjects.Spot();},"{00100000-2012-0004-B001-C46BD7336A1A}":function(){return new VBI.VisualObjects.Route();},"{00100000-2013-0004-B001-7EB3CCC039C4}":function(){return new VBI.VisualObjects.Circle();},"{00100000-2013-0004-B001-686F01B57873}":function(){return new VBI.VisualObjects.CircleDist();},"{00100000-2012-0004-B001-383477EA1DEB}":function(){return new VBI.VisualObjects.Pie();},"{00100000-2012-0004-B001-BFED458C3076}":function(){return new VBI.VisualObjects.Box();},"{00100000-2012-0004-B001-F311DE491C77}":function(){return new VBI.VisualObjects.Area();},"{00100000-2012-0004-B001-E180770E8A12}":function(){return new VBI.VisualObjects.HeatMap();},"{00100000-2012-0070-1000-35762CF28B6B}":function(){return new VBI.VisualObjects.Dummy();},"{00100000-2014-0004-B001-9F1B43BE944A}":function(){return new VBI.VisualObjects.Route();},"{00100000-2014-0004-BDA8-87B904609063}":function(){return new VBI.VisualObjects.Area();},"{00100000-2012-0004-B001-2297943F0CE6}":function(){return new VBI.VisualObjects.Container();},"{00100000-2013-1000-1100-50059A6A47FA}":function(){return new VBI.VisualObjects.Caption();},"{00100000-2013-1000-3700-AD84DDBBB31B}":function(){return new VBI.VisualObjects.Label();},"{00100000-2013-1000-2400-D305F7942B98}":function(){return new VBI.VisualObjects.Link();},"{00100000-2013-1000-2200-6B060A330B2C}":function(){return new VBI.VisualObjects.Image();},"{00100000-2013-1000-1200-855B919BB0E9}":function(){return new VBI.VisualObjects.Button();},};v.Factory.CreateInstance=function(c){return v.Factory[c]();};VBI.VisualObjects.Base={m_Props:null,m_Scene:null,m_BB:[],m_IO:[],m_colorHot:'rgba( 240, 171, 0, 0.5 )',m_defaultColor:'rgba( 255, 0, 0, 1.0 )',m_defaultTooltip:'',m_defaultLabeltext:'',m_defaultLabelBgCol:'RGBA(200,200,200,200)',m_Label:[],m_DH:[],m_szHandle:8,m_Track:null,m_DragSourceInfo:null,m_DropTargetInfo:null,LoadDragDropInfo:function(d,c,i){if(d.DragSource&&d.DragSource.DragItem){i.m_DragSourceInfo=new VBI.DnDInfo;i.m_DragSourceInfo.load(d.DragSource.DragItem,c,i);}if(d.DropTarget&&d.DropTarget.DropItem){i.m_DropTargetInfo=new VBI.DnDInfo;i.m_DropTargetInfo.load(d.DropTarget.DropItem,c,i);}},BaseLoad:function(d,c,i){VBI.m_bTrace&&VBI.Trace("BaseLoad");i.m_Props.push(i.m_HotScale=new VBI.AttributeProperty(d,'hotScale',i.m_DataSource,c,[1.0,1.0,1.0]));i.m_Props.push(i.m_HotDeltaColor=new VBI.AttributeProperty(d,'hotDeltaColor',i.m_DataSource,c,null));i.m_Props.push(i.m_SelectColor=new VBI.AttributeProperty(d,'selectColor',i.m_DataSource,c,null));i.m_Props.push(i.m_FxSize=new VBI.AttributeProperty(d,'fxsize',i.m_DataSource,c,true));i.m_Props.push(i.m_FxDir=new VBI.AttributeProperty(d,'fxdir',i.m_DataSource,c));i.m_Props.push(i.m_Entity=new VBI.AttributeProperty(d,'entity',i.m_DataSource,c,null));i.m_Props.push(i.m_Labeltext=new VBI.AttributeProperty(d,'labelText',i.m_DataSource,c,i.m_defaultLabeltext));i.m_Props.push(i.m_LabelBgCol=new VBI.AttributeProperty(d,'labelBgColor',i.m_DataSource,c,i.m_defaultLabelBgCol));i.m_Props.push(i.m_LabelPos=new VBI.AttributeProperty(d,'labelPos',i.m_DataSource,c));i.m_Props.push(i.m_DragData=new VBI.AttributeProperty(d,'dragdata',i.m_DataSource,c,null));this.LoadDragDropInfo(d,c,i);},BaseMousemove:function(e){VBI.m_bTrace&&VBI.Trace("BaseMousemove");if(this.m_Track)return false;if(!this.GetHitArray)return false;var h=this.GetHitArray(e.offsetX,e.offsetY);if(h.length>0){var s=this.m_Scene;if(s.InternalSetHotItem(this,h[0])){if(!h[0].m_Design&&this.m_Tooltip){s.SetToolTip(this.getTooltip(s.m_Ctx,h[0]));}var c;if(c=this.DetailCursor(e,h[0]))s.SetCursor(c);}}return h.length>0?true:false;},BaseContextmenu:function(e){VBI.m_bTrace&&VBI.Trace("BaseContextmenu");if(!this.GetHitArray)return false;var h=this.GetHitArray(e.offsetX,e.offsetY);if(h.length>0){var s=this.m_Scene,a=h[0];var m=this.GetDataIndex(a.m_Index);var b=this.m_DataSource.GetIndexedElement(s.m_Ctx,m);var c,d=s.m_Ctx.m_Actions;if(d&&a.m_Design&&(a.m_Hit==VBI.HTHANDLE)){if(c=d.findAction("HandleContextMenu",s,this)){var p=s.GetEventVPCoordsObj(e);p.handle=a.m_Handle.toString();this.m_Scene.m_Ctx.FireAction(c,s,this,b,p);e.preventDefault();return true;}}if(this.DetailContextmenu(e,b,h[0])){e.preventDefault();return true;}if(d){if(c=d.findAction("ContextMenu",s,this)){this.m_Scene.m_Ctx.FireAction(c,s,this,b,s.GetEventVPCoordsObjWithScene(e));e.preventDefault();return true;}}e.preventDefault();}return false;},BaseFindAction:function(n){var s=this.m_Scene,a=s.m_Ctx.m_Actions;return a?a.findAction(n,s,this):null;},BaseClick:function(e){VBI.m_bTrace&&VBI.Trace("BaseClick");if(!this.GetHitArray)return false;var s=this.m_Scene;var h=this.GetHitArray(e.offsetX,e.offsetY);if(!h.length)return false;var m=this.GetDataIndex(h[0].m_Index);this.m_DataSource.Select(m);s.RenderAsync(false);var a;if(a=this.m_DataSource.GetIndexedElement(s.m_Ctx,m)){if((e.type.indexOf("touch")>=0)||(e.type.indexOf("pointer")>=0))a.Select(this.IsSelected(s.m_Ctx)?false:true);else if(e.shiftKey==true)a.Select(true);else if(e.ctrlKey==true)a.Select(this.IsSelected(s.m_Ctx)?false:true);else{a.GlobalSingleSelect();}if(s.m_PreassembledData)s.UpdatePreData4Selected(this.m_nPreDataIndex,this.GetInternalIndex(h[0].m_Index));}if(this.IsPosChangeable(s.m_Ctx)){var b=this.m_DataSource.GetEditMode(s.m_Ctx)==VBI.EMHandle?VBI.EMBox:VBI.EMHandle;VBI.m_bTrace&&VBI.Trace("SetEditMode: "+b);this.m_DataSource.SetEditMode(s.m_Ctx,b);e.preventDefault();return true;}if(this.DetailClick(e,a,h[0])){e.preventDefault();return true;}var c;if(c=s.m_Ctx.m_Actions){var d;if(d=c.findAction("Click",s,this)){this.m_Scene.m_Ctx.FireAction(d,s,this,a,s.GetEventVPCoordsObj(e));e.preventDefault();return true;}}return false;},BaseHitTest:function(n,a,o){var t,h=[];var p=VBI.Utilities.PtInRect;var b={};if(this.BaseDesignHitTest(n,a,b)){h.push(b);return h;}for(var c=this.m_BB.length-1;c>=0;--c){if(t=this.m_BB[c])for(var d=this.m_IO[c].length-1;d>=0;--d){var e=this.m_IO[c][d];if(!p([n-e,a],t))continue;if(o){var r=o.m_cb(o,c,n-e,a);if(r&&r.m_hit>0){h.push({m_Index:c,m_Entity:this.GetEntity(c,this.m_Scene.m_Ctx),m_Detail:r});if(r.m_hit==1)return h;}}}}return h;},clear:function(){if(this.m_Props){for(var n=0;n<this.m_Props.length;++n)this.m_Props[n].clear();this.m_Props=null;}if(this.m_DragSourceInfo){this.m_DragSourceInfo.clear();this.m_DragSourceInfo=null;}if(this.m_DropTargetInfo){this.m_DropTargetInfo.clear();this.m_DropTargetInfo=null;}this.m_Scene=null;this.m_Track=null;this.m_BB=null;this.m_IO=null;this.m_DH=null;if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}},load:function(i,d,c){if(d.id)i.m_ID=d.id;this.m_Props=[];this.m_DragSourceInfo=null;this.m_DropTargetInfo=null;},NotifyDataChange:function(c){if(this.m_Props){for(var n=0,l=this.m_Props.length;n<l;++n)this.m_Props[n].NotifyDataChange(c);}this.m_bChanged=true;},IsPosChangeable:function(c){if(this.m_Pos)return this.m_Pos.IsChangeable(c);return false;},IsSelected:function(c){if(this.m_DataSource)return this.m_DataSource.IsElementSelected(c);return false;},IsHandleMode:function(){return this.m_DataSource.GetEditMode(this.m_Scene.m_Ctx)==VBI.EMHandle?true:false;},IsBoxMode:function(){return this.m_DataSource.GetEditMode(this.m_Scene.m_Ctx)==VBI.EMBox?true:false;},IsDataAccepted:function(e){var s=this.m_Scene;if(this.m_Track){VBI.m_bTrace&&VBI.Trace("Error: Track object should be already gone");return false;}if(!this.GetHitArray)return false;var h,a=this.GetHitArray(e.offsetX,e.offsetY);if(a.length&&(h=a[0]).m_Design){return false;}if(a.length&&s.m_DragInfo){this.m_DataSource.Select(h.m_Index);if(this.m_DropTargetInfo){var c=s.m_Ctx;var d=this.m_DropTargetInfo.getItemArray(c);var D=s.m_DragInfo.aItems;for(var n=0;n<d.length;++n){if(D.indexOf(d[n])!=-1){try{e.dataTransfer.dropEffect='copy';e.stopPropagation();e.preventDefault();}catch(b){VBI.m_bTrace&&VBI.Trace("Warning: sapvobase.IsDataAccepted exception occured: "+b.message);}return h;}}}}return false;},GetEntity:function(n,c){this.m_DataSource.Select(n);return this.m_Entity.GetValueString(c);},IsHot:function(i){var s=this.m_Scene,h=s.m_HotItem;if(h.m_Entity&&h.m_Entity==this.m_Entity.GetValueString(s.m_Ctx))return true;if(!h.m_HitObj||h.m_Index!=i)return false;if(h.m_Design)return false;if(h.m_VO!=this)return false;return true;},InternalChangeHotItem:function(o,n){},IsClusterable:function(){return false;},GetDataIndex:function(B){return B;},GetInternalIndex:function(B){return B;},ShowGrid:function(c,d,p){},getTooltip:function(c,h){this.m_DataSource.Select(h.m_Index);return this.m_Tooltip.GetValueString(c);},getLabelData:function(r){if(r){for(var n=0;n<this.m_Label.length;n++){var l=this.m_Label[n];if(l.CalculateLabelPos&&l.m_PosArray.pa.length>0){l.m_Pos=[];for(var a=0;a<l.m_aIO.length;a++){var p=this.CalculateLabelPos(this.m_Scene,l.m_PosArray,l.m_aIO[a]);if(p&&p.length>0)l.m_Pos.push(p);}l.m_bAligned=false;}}}return this.m_Label;},BaseRender:function(c,d){var l=this.m_DH.length;if(!l)return;var t,a,b;var s=this.m_szHandle,h=s/2,e=1.5*s*s;var f=d.fillStyle;var g='rgba(255,132,0,1.0)';var i='rgba(188,54,24,1.0)';var j='rgba( 240, 171, 0, 1.0 )';var k=this.m_Scene.m_HotItem;var H,x,S=false;for(var n=0;n<l;++n){if(!(H=this.m_DH[n]))continue;for(var m=0,o=this.m_IO[n].length;m<o;++m){d.setTransform(1.0,0.0,0.0,1.0,this.m_IO[n][m],0.0);if(H.m_EditMode==VBI.EMBox){if(H.length==1){x=H[0];VBI.Utilities.DrawDesignRect(d,this.DesignGetActiveBoxHandles(n),x);}}else{d.fillStyle=i;d.lineWidth=1;t=null;if(S){d.fillStyle=i;S=false;}for(var p=0,q=H.length;p<q;++p){x=H[p];var r=(k.m_VO==this&&k.m_Index==n&&k.m_Design&&k.m_HitObj&&k.m_HitObj.m_Handle==p);if(t&&(((a=(t[0]-x[0]))*a)+((b=(t[1]-x[1]))*b))<e){if(!S){S=true;d.fillStyle=r?g:j;d.fill();}continue;}if(S){d.fillStyle=i;S=false;}if(r)d.fillStyle=j;d.beginPath();d.rect(x[0]-h,x[1]-h,s,s);d.closePath();d.fill();if(r)d.fillStyle=i;t=x;}}}}d.fillStyle=f;d.setTransform(1.0,0.0,0.0,1.0,0.0,0.0);},BaseDesignHitTest:function(n,a,b){VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest nsx:"+n+" nsy:"+a+" instance:"+this.m_ID);var l=this.m_DH.length;if(!l)return false;var s=this.m_szHandle,c=s/2.0;var P=VBI.Utilities.PtInRect;if(b.m_Handle)delete b.m_Handle;var H,d;for(var e=l;e>=0;--e){if(!(H=this.m_DH[e]))continue;for(var f=0;f<this.m_IO[e].length;++f){var g=this.m_IO[e][f];if(H.m_EditMode==VBI.EMHandle){VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest Handle");for(var i=0,j=H.length;i<j;++i){d=H[i];if(P([n-g,a],[d[0]-c,d[1]-c,d[0]+c,d[1]+c])){VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest Handle Hit! Index:"+e+" Handle: "+i);b.m_Index=e;b.m_Design=true;b.m_Hit=VBI.HTHANDLE;b.m_Handle=i;b.m_NsX=n;b.m_NsY=a;return true;}}}else if(H.m_EditMode==VBI.EMBox){VBI.m_bTrace&&(H.length>1||H.length==0)&&VBI.Trace("Error: Box edit mode must fill one rectangle only");d=H[0];VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest Box");var r=9;var w=d[2]-d[0];var h=d[3]-d[1];var k=w/2;var m=h/2;var o=this.DesignGetActiveBoxHandles(e);for(var x=0;x<3;++x)for(var y=0;y<3;++y){if(x==1&&y==1)continue;if(!o[y*3+x])continue;var p=d[0]+x*k-(n-g);var q=d[1]+y*m-(a);if((p*p+q*q)<r){b.m_Index=e;b.m_Handle=y*3+x;b.m_Design=true;b.m_Hit=VBI.HTBOXHANDLE;b.m_NsX=n;b.m_NsY=a;return true;}}if(P([n-g,a],d)){VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest Box Hit! Index:"+e);b.m_Index=e;b.m_Handle=-1;b.m_Design=true;b.m_Hit=VBI.HTBOX;b.m_NsX=n;b.m_NsY=a;return true;}}}}return false;},DesignHandleDrag:function(o,e){var s=this.m_Scene;VBI.m_bTrace&&VBI.Trace("DesignHandleDrag");VBI.m_bTrace&&(s.m_nInputMode!=VBI.InputModeTrackObject)&&VBI.Trace("Error: DesignHandleDrag wrong input mode: "+s.m_nInputMode);this.m_DataSource.Select(o.m_Index);var p=s.GetPosFromPoint([o.m_ClientX,o.m_ClientY,0]);var a=s.GetPosFromPoint([o.m_ClientStartX,o.m_ClientStartY,0]);if(this.IsPosChangeable(s.m_Ctx)){var b=this.m_Pos.GetValueVector(s.m_Ctx).slice(0);var c=o.m_PosOrig;if(o.hasOwnProperty('m_Handle')){VBI.m_bTrace&&VBI.Trace("DesignHandleDrag Handle");if(o.m_Hit==VBI.HTHANDLE){var i=o.m_Handle*3;b[i]=p[0];b[i+1]=p[1];this.m_Pos.SetValueVector(s.m_Ctx,b);}else if(o.m_Hit==VBI.HTBOXHANDLE){if(this.DesignBoxSize)this.DesignBoxSize(o);}else if(o.m_Hit==VBI.HTBOX){VBI.m_bTrace&&VBI.Trace("DesignHandleDrag Box");var d=(p[0]-a[0]);var f=(p[1]-a[1]);for(var n=0,l=b.length/3;n<l;++n){var i=n*3;b[i]=c[i]+d;b[i+1]=c[i+1]+f;}this.m_Pos.SetValueVector(s.m_Ctx,b);}}}s.RenderAsync(true);},DesignHandleDrop:function(o,e){var s=this.m_Scene;VBI.m_bTrace&&(s.m_nInputMode!=VBI.InputModeTrackObject)&&VBI.Trace("Error: DesignHandleDrop wrong input mode: "+s.m_nInputMode);var a,b=s.m_Ctx.m_Actions;if(b&&o.m_Design){if(a=b.findAction("HandleMoved",s,this)){var c;if(c=this.m_DataSource.GetIndexedElement(s.m_Ctx,o.m_Index)){var p=s.GetEventVPCoordsObj(e);p.handle=o.m_Handle.toString();p.mode=o.m_Hit.toString();s.m_Ctx.FireAction(a,s,this,c,p);}}}s.SetInputMode(VBI.InputModeDefault);s.RenderAsync(true);return true;},DesignHandleEnd:function(o,e){this.m_Track.UnHook();this.m_Track=null;},DesignGetActiveBoxHandles:function(i){return[1,1,1,1,0,1,1,1,1];},onsapsecclick:function(e){return this.BaseContextmenu(e);},onsapclick:function(e){return this.BaseClick(e);},onsapmove:function(e){return this.BaseMousemove(e);},onsapup:function(e){if(!this.m_Track)return false;this.m_Track.UnHook();this.m_Track=null;},onsapdrop:function(e){VBI.m_bTrace&&VBI.Trace("onsapdrop in base "+e.type);var h;if(h=this.IsDataAccepted(e)){var s=this.m_Scene;var m=this.GetDataIndex(h.m_Index);var a=this.m_DataSource.GetIndexedElement(s.m_Ctx,m);var b,c=s.m_Ctx.m_Actions;if(c){if(b=c.findAction("Drop",s,this)){this.m_Scene.m_Ctx.FireAction(b,s,this,a,s.GetEventDropObjWithScene(e));e.preventDefault();return true;}}return false;}return false;},onsapdrag:function(e){VBI.m_bTrace&&VBI.Trace("onsapdrag in base "+e.type);if(this.IsDataAccepted(e)){return true;}return false;},onsapdown:function(e){VBI.m_bTrace&&VBI.Trace("onsapdown in base "+e.type);var s=this.m_Scene;if(this.m_Track){VBI.m_bTrace&&VBI.Trace("Error: Track object should be already gone");return true;}if(!this.GetHitArray)return false;var h,a=this.GetHitArray(e.offsetX,e.offsetY);if(a.length&&(h=a[0]).m_Design){VBI.m_bTrace&&VBI.Trace("Start Tracking on "+this.m_ID+" caused by "+e.type);this.m_DataSource.Select(h.m_Index);h.m_CBDrag=this.DesignHandleDrag.bind(this);h.m_CBDrop=this.DesignHandleDrop.bind(this);h.m_CBEnd=this.DesignHandleEnd.bind(this);h.m_ClientStartX=e.offsetX;h.m_ClientStartY=e.offsetY;h.m_PosOrig=this.m_Pos.GetValueVector(s.m_Ctx).slice(0);s.SetInputMode(VBI.InputModeTrackObject);s.SetCursor(this.DetailCursor(e,h));if(this.DesignBeginDrag)this.DesignBeginDrag(h);this.m_Track=new s.DesignTrack(h);e.stopPropagation();e.preventDefault();return true;}if(a.length){this.m_DataSource.Select(h.m_Index);if(this.m_DragSourceInfo){var c=s.m_Ctx;var d=this.m_DragSourceInfo.getItemArray(c);if(d.length){s.m_DragInfo={};s.m_DragInfo.aItems=d;s.m_DragInfo.strInstance=this.m_DataSource.m_Path+"."+this.m_DataSource.m_nCurElement;s.m_DragInfo.strScene=this.m_Scene.m_ID;s.m_DragInfo.strID=this.m_ID;s.m_DragInfo.strExtData=this.m_DragData.GetValueString(s.m_Ctx);s.m_DragInfo.bDragStart=false;return true;}}}return false;},DetailClick:function(e,a,h){return false;},DetailContextmenu:function(e,a,h){return false;},DetailCursor:function(e,h){if(h.m_Design){if(h.m_Hit==VBI.HTBOXHANDLE){var c=['nw-resize','n-resize','ne-resize','w-resize','','e-resize','sw-resize','s-resize','se-resize'];return c[h.m_Handle];}else if(h.m_Hit==VBI.HTBOX){return'move';}}return'pointer';},GetSelectColor:function(c,o){var r,a;if(a=this.m_SelectColor.GetValueString(c)){if(r=VBI.Types.string2rhls(a)){var b;if(b=VBI.Types.color2array(o)){var h=VBI.Utilities.RGB2HLS(b[0],b[1],b[2]);var d=VBI.Utilities.HLS2RGB(h[0]+r[0],h[1]*r[1],h[2]*r[2]);return'rgba('+Math.min(Math.round(d[0]),255)+","+Math.min(Math.round(d[1]),255)+","+Math.min(Math.round(d[2]),255)+","+Math.min((r[3]*b[3]).toString(),1.0)+')';}}else if(r=VBI.Types.string2color(a)){return r;}}return o;},GetHotColor:function(c,o){var r,a;if(a=this.m_HotDeltaColor.GetValueString(c)){if(r=VBI.Types.string2rhls(a)){var b;if(b=VBI.Types.color2array(o)){var h=VBI.Utilities.RGB2HLS(b[0],b[1],b[2]);var d=VBI.Utilities.HLS2RGB(h[0]+r[0],h[1]*r[1],h[2]*r[2]);return'rgba('+Math.min(Math.round(d[0]),255)+","+Math.min(Math.round(d[1]),255)+","+Math.min(Math.round(d[2]),255)+","+Math.min((r[3]*b[3]).toString(),1.0)+')';}}else if(r=VBI.Types.string2color(a)){return r;}}return this.m_colorHot;},GetHotScale:function(c){var r;if(r=this.m_HotScale.GetValueVector(c))return r;return[1.0,1.0,1.0];},RectSelect:function(s){var t,o,h=[];for(var n=this.m_BB.length-1;n>=0;--n){if(t=this.m_BB[n])for(var a=this.m_IO[n].length-1;a>=0;--a){var b=this.m_IO[n][a];o=[s[0]-b,s[1],s[2]-b,s[3]];if(t[0]>=o[0]&&t[1]>=o[1]&&t[2]<=o[2]&&t[3]<=o[3])h.push(n);}}return h;},GetLabel:function(c){var l={};var t=this.m_Labeltext.GetValueString(c);if(t){l.labeltext=t;l.bgColor=this.m_LabelBgCol.GetValueColor(c);l.Align=this.m_LabelPos.GetValueLong(c);return l;}else return null;},};VBI.VisualObjects.Spot=function(){this.m_fHotScale=1.2;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_Image=new VBI.AttributeProperty(d,'image',this.m_DataSource,c));this.m_Props.push(this.m_ImageSelected=new VBI.AttributeProperty(d,'imageSelected',this.m_DataSource,c,null));this.m_Props.push(this.m_Icon=new VBI.AttributeProperty(d,'icon',this.m_DataSource,c));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',this.m_DataSource,c));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c,[1.0,1.0,1.0]));this.m_Props.push(this.m_Alignment=new VBI.AttributeProperty(d,'alignment',this.m_DataSource,c,"5"));this.BaseLoad(d,c,this);};this.DetailHitTest=function(o,n,a,b){var i,h,s;var c=o.m_Ctx;var m=n;var d=null;var e=null;h=this.IsHot(m,c);if(this.bUsePreData){m=this.m_BBRefs[n];var I=this.m_Scene.m_PreassembledData[this.m_nPreDataIndex];var f=I[m];i=f.im;if(h)d=f.hcol;s=f.s;}else{this.m_DataSource.Select(m);i=this.m_Image.GetValueString(c);if(h)d=this.m_HotDeltaColor.GetValueString(c);s=this.IsSelected(c);if(s)e=this.m_HotDeltaColor.GetValueString(c);}var g,j=0;if(g=c.GetResources().GetImageBits(i,d,e)){var k=g[0];var r=this.m_BB[n];var w=r[2]-r[0];var l=r[3]-r[1];var p=Math.floor((a-r[0])/w*g[1]);var q=Math.floor((b-r[1])/l*g[2]);j=k[(q*g[1]+p)*4+3];}return(j>0)?{m_hit:(j==255?1:2)}:null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this),m_Ctx:this.m_Scene.m_Ctx};return this.BaseHitTest(n,a,o);};this.ShowGrid=function(c,d,p){if(p!=undefined){var s=this.m_Scene;var a=s.m_Ctx;var b=0;var n=p.length;for(var e=0;e<n;++e){var f=p[e];if(f.cellColor!=undefined)this.ShowGridCell(c,s,d,f);}}};this.RenderThisInstance=function(e,n,a,d){VBI.m_bTrace&&VBI.Trace("Spot: RenderInstance");var s=this.m_Scene;var i=s.m_Ctx.GetResources().GetImage((e.s&&e.simag)?e.simag:e.im,e.s?e.scol:null,e.h?e.hcol:null,s.RenderAsync.bind(s));var b=e.sc;var t=e.tx;var c=e.ct;if(!i)return false;var x=[e[0],e[1]];var z=s.GetCurrentZoomFactors();var w=i.naturalWidth/z[0]*b[0];var h=i.naturalHeight/z[1]*b[1],o=h;if(e.h){if(e.hscale!=undefined){w=w*e.hscale[0];h=h*e.hscale[1];}}var l=x[0]-w/2;var f=x[1]-h;var I=this.m_IO[n]=s.GetInstanceOffsets(this.m_BB[n]=[l,f,l+w,f+h]);this.m_BBRefs.push(a);this.m_BB[n].nI=a;if(this.IsPosChangeable(s.m_Ctx)){var D=this.m_DH[n]=[];if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(this.m_BB[n]);}}if(t)VBI.Utilities.SetTextAttributes(d,(Math.floor(h/2.8)).toString()+"px Arial","rgba( 0, 0, 0, 1.0 )","rgba( 0, 0, 0, 1.0 )","center");for(var g=0;g<I.length;++g){var j=I[g];d.drawImage(i,l+j,f,w,h);if(t)d.fillText(t,l+j+w/2,f+h/2.2);}if(c){var k=Math.floor(o/e.fs);VBI.Utilities.SetTextAttributes(d,(k).toString()+"px "+e.f,e.fc,e.fc,"left");for(var g=0;g<I.length;++g){var j=I[g];d.fillText(c,w+l+j+e.fo,f+(h+k/1.5)/2.0);}}return true;};this.RenderInstance=function(n,d,p,i,t,s,h,l){VBI.m_bTrace&&VBI.Trace("Spot: RenderInstance");if(!i)return;var a=this.m_Scene;var x=a.GetPointFromPos(p,true);var z=a.GetCurrentZoomFactors();var w=i.naturalWidth/z[0]*s[0];var b=i.naturalHeight/z[1]*s[1];if(h){var c=this.GetHotScale(a.m_Ctx);w=Math.round(w*c[0]);b=Math.round(b*c[1]);}var e;var f;var g=parseInt(this.m_Alignment.GetValueString(a.m_Ctx));switch(g){case 0:e=x[0]-w/2;f=x[1]-b/2;break;case 8:e=x[0];f=x[1];break;case 1:e=x[0]-w/2;f=x[1];break;case 2:e=x[0]-w;f=x[1];break;case 3:e=x[0]-w;f=x[1]-b/2;break;case 4:e=x[0]-w;f=x[1]-b;break;case 6:e=x[0];f=x[1]-b;break;case 7:e=x[0];f=x[1]-b/2;break;case 5:default:e=x[0]-w/2;f=x[1]-b;break;}var I=this.m_IO[n]=a.GetInstanceOffsets(this.m_BB[n]=[e,f,e+w,f+b]);if(this.IsPosChangeable(a.m_Ctx)){var D=this.m_DH[n]=[];if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(this.m_BB[n]);}}if(t)VBI.Utilities.SetTextAttributes(d,(Math.floor(b/2.8)).toString()+"px Arial","rgba( 0, 0, 0, 1.0 )","rgba( 0, 0, 0, 1.0 )","center");for(var j=0;j<I.length;++j){var o=I[j];d.drawImage(i,e+o,f,w,b);if(t)d.fillText(t,e+o+w/2,f+b/2.2);}if(l&&I.length){var L={pa:[x[0],x[1],x[2]],bb:null};this.m_Label.push(new VBI.Label(l,null,L,this.m_BB[n],I));}};this.Render=function(c,d,p){this.m_BB=[];this.m_BBRefs=[];this.m_IO=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var s=this.m_Scene;var a=s.m_Ctx;var b=0;this.SwitchPreDataRendering(p!=undefined);if(this.bUsePreData){var e=p.length;for(var n=0;n<e;++n){var f=p[n];if(!f.b2Ignore){if(this.RenderThisInstance(f,b,n,d))b++;}}}else{var g,t;if(g=this.m_DataSource.GetCurrentNode(a)){b=g.m_dataelements.length;for(var n=0;n<b;++n){this.m_DataSource.Select(n);var h=this.IsHot(n);var S=this.IsSelected(a);var i=this.m_Pos.GetValueVector(a);var j=this.m_Image.GetValueString(a);if(S&&(t=this.m_ImageSelected.GetValueString(a)))j=t;var k=this.m_Text.GetValueString(a);var l=this.m_Scale.GetValueVector(a);var m=a.GetResources().GetImage(j,S?this.m_SelectColor.GetValueString(a):null,h?this.m_HotDeltaColor.GetValueString(a):null,s.RenderAsync.bind(s));this.RenderInstance(n,d,i,m,k,l,h,this.GetLabel(a));}}else{}}this.BaseRender(c,d);return b;};this.SwitchPreDataRendering=function(s){if(this.bUsePreData!=s){this.bUsePreData=s;if(s){this.IsHot=this.PreDataIsHot;this.GetEntity=this.PreDataGetEntity;}else{this.IsHot=this.BaseIsHot;this.GetEntity=this.BaseGetEntity;}}};this.DesignBeginDrag=function(o){o.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);o.m_DhOrig=this.m_DH[o.m_Index].slice(0);};this.DesignGetActiveBoxHandles=function(i){return[1,1,1,1,0,1,0,0,0];};this.InternalChangeHotItem=function(n,a){if(this.bUsePreData){var b=this.m_BBRefs[n];if(b!=undefined){var I=this.m_Scene.m_PreassembledData[this.m_nPreDataIndex];if(I[b]!=undefined){I[b].h=a;this.m_HotClusterVO=((a&&I[b].isCl)?I[b]:undefined);}}}};this.BaseIsHot=this.IsHot;this.PreDataIsHot=function(n,c){var a=this.m_BBRefs[n];var I=this.m_Scene.m_PreassembledData[this.m_nPreDataIndex];return I[a].h;};this.BaseGetEntity=this.GetEntity;this.PreDataGetEntity=function(n,c){this.m_DataSource.Select(n);return this.m_Entity.GetValueString(c);};this.SwitchHotItemToStandard=function(){var s=this.m_Scene;var n=this.m_BBRefs[s.m_HotItem.m_Index];var e=(s.m_PreassembledData[this.m_nPreDataIndex])[n];if(e)if(e.isCl==true){s.InternalSetHotItem(null,null);return e;}else{s.m_HotItem.m_Index=e.nI;if(s.m_HotItem.m_HitObj)s.m_HotItem.m_HitObj.m_Index=e.nI;return undefined;}};this.IsClusterable=function(){return true;};this.GetDataIndex=function(B){if(this.bUsePreData){var p=this.m_BBRefs[B];if(p!=undefined){var e=(this.m_Scene.m_PreassembledData[this.m_nPreDataIndex])[p];if(e!=undefined)return e.nI;}}return B;};this.GetInternalIndex=function(B){if(this.bUsePreData)return this.m_BBRefs[B];return B;};this.getTooltip=function(c,h){this.m_DataSource.Select(this.GetDataIndex(h.m_Index));var t=this.m_DataSource.GetIndexedElement(c,this.GetDataIndex(h.m_Index));return this.m_Tooltip.GetValueString(c);};this.DesignBoxSize=VBI.Utilities.SceneBindDesignSpotBoxSize.bind(this);};VBI.VisualObjects.Spot.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Route=function(){this.m_LP=[];this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'posarray',this.m_DataSource,c));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Start=new VBI.AttributeProperty(d,'start',this.m_DataSource,c,0));this.m_Props.push(this.m_End=new VBI.AttributeProperty(d,'end',this.m_DataSource,c,0));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_LineWidth=new VBI.AttributeProperty(d,'linewidth',this.m_DataSource,c,6.0));this.m_Props.push(this.m_DotColor=new VBI.AttributeProperty(d,'dotcolor',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_DotBorderColor=new VBI.AttributeProperty(d,'dotbordercolor',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_DotWidth=new VBI.AttributeProperty(d,'dotwidth',this.m_DataSource,c,0.0));this.BaseLoad(d,c,this);};this.DrawArrow=function(c,a,b){if(a.length<3)return;c.beginPath();c.moveTo(a[0][0],a[0][1]);c.lineTo(a[1][0],a[1][1]);c.lineTo(a[2][0],a[2][1]);c.lineTo(a[0][0],a[0][1]);c.closePath();c.fillStyle=b;c.fill();};this.CalcArrow=function(s,p,a,r,b){var n=p.length/3;var d=2*a*a;var c,e;var t,f,g,h,x=[0,0,0];var F=false;e=r?n-1:0;h=g=[p[e*3],p[e*3+1],0.0];for(c=1;c<n;c++){e=r?n-1-c:c;x=[p[e*3],p[e*3+1],0.0];if(((t=(h[0]-x[0]))*t+(f=(h[1]-x[1]))*f)>d){F=true;break;}}if(!F)return false;var i=x[0]-g[0];var j=x[1]-g[1];while((Math.abs(i)>1000.0)&&(Math.abs(j)>1000.0)){i/=1000.0;j/=1000.0;}var l=Math.sqrt(i*i+j*j);i=(i*a)/l;j=(j*a)/l;var k=g[0]+i;var m=g[1]+j;b.idx=r?n-c-1:c;b.ta=[[g[0],g[1]],[k+j,m-i],[k-j,m+i]];b.pt=[k,m];return true;};this.CalculateLabelPos=function(s,p,o){var z=s.GetCurrentZoomFactors();var r=s.m_Div.getBoundingClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var c=s.m_Canvas[0].getPixelTop()/z[1];var d=[-P,-c,-P+a,-c+b];var e=VBI.Utilities.GetMidpointsForLine(p.pa,o,d);return e.aPos;};this.RenderInstance=function(n,d,p,c,s,e,l,a,b,f,g){var h=this.m_Scene;var i=h.GetNearestPosArray(p);var j=h.GetPointFromPos([i.m_MinX,i.m_MaxY,0.0],false);var r=h.GetPointFromPos([i.m_MaxX,i.m_MinY,0.0],false);var k=Math.max(l,f/2);var I=this.m_IO[n]=h.GetInstanceOffsets(this.m_BB[n]=[j[0]-k,j[1]-k,r[0]+k,r[1]+k]);var m=I.length?h.GetPointArrayFromPosArray(i,false):null;for(var o=0,q=I.length;o<q;++o){d.setTransform(1,0,0,1,I[o],0);this.RenderRoute(n,d,m,c,s,e,l,a,b,f);VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);if(g&&I.length){var t=[0,0,0,0];var u={pa:m,bb:[j,r]};this.m_Label.push(new VBI.Label(g,this.CalculateLabelPos,u,t,I));}};this.RenderRoute=function(n,d,p,c,s,e,l,a,b,f){var g=this.m_Scene;var h=l*l/2;var i=p.length/3;if(i<2)return;var t,j,k=1;var m=i-1;var L=this.m_LP[n];var H=this.m_DH[n];var D=f?[]:null;if(L.length)L=null;if(H&&H.length)H=null;if(H){if(H.m_EditMode==VBI.EMHandle){for(var o=0;o<i;++o)H.push([p[o*3],p[o*3+1]]);}else if(H.m_EditMode==VBI.EMBox){H.push(this.m_BB[n]);}}var r={};var q={};if(l&&s&&this.CalcArrow(g,p,l+5,false,r)){this.DrawArrow(d,r.ta,c);k=r.idx;if(L)L.m_RS=r;}if(l&&e&&this.CalcArrow(g,p,l+5,true,q)){this.DrawArrow(d,q.ta,c);m=q.idx;if(L)L.m_RE=q;}d.strokeStyle=c;d.lineWidth=l;d.lineCap='round';var u=r.pt?[r.pt[0],r.pt[1]]:[p[0],p[1],0.0];if(L)L.push(u);if(D&&!s)D.push(u);d.beginPath();d.moveTo(u[0],u[1]);for(var o=k;o<=m;++o){var x=[p[o*3],p[o*3+1],0.0];if(((t=(u[0]-x[0]))*t+(j=(u[1]-x[1]))*j)<h)continue;if(l)d.lineTo(x[0],x[1]);if(L)L.push(x);if(D)D.push(x);u=x;}if(q.pt){if(l)d.lineTo(q.pt[0],q.pt[1]);if(L)L.push(q.pt);}d.stroke();if(D){d.fillStyle=a;d.strokeStyle=b;d.lineWidth=1;for(var o=0,w=D.length;o<w;++o){var x=D[o];d.beginPath();d.arc(x[0],x[1],f/2.0,0,2.0*Math.PI);d.closePath();d.fill();d.stroke();}}};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_LP=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var b=this.m_Scene.m_Ctx;var e;if(e=this.m_DataSource.GetCurrentNode(b)){for(var n=0,l=e.m_dataelements.length;n<l;++n){this.m_DataSource.Select(n);this.m_LP[n]=[];if(this.IsPosChangeable(b)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode())D.m_EditMode=VBI.EMHandle;else if(this.IsBoxMode())D.m_EditMode=VBI.EMBox;}var h=this.IsHot(n);var s=this.IsSelected(b);var p=this.m_Pos.GetValueVector(b);var f=this.m_Color.GetValueColor(b);if(s)f=this.GetSelectColor(b,f);if(h)f=this.GetHotColor(b,f);var g=this.m_Start.GetValueLong(b);var i=this.m_End.GetValueLong(b);var j=this.m_LineWidth.GetValueFloat(b);if(h)j*=(this.GetHotScale(b))[0];var k=this.m_DotColor.GetValueColor(b);if(s)k=this.GetSelectColor(b,k);if(h)k=this.GetHotColor(b,k);var m=this.m_DotBorderColor.GetValueColor(b);if(s)m=this.GetSelectColor(b,m);if(h)m=this.GetHotColor(b,m);var o=this.m_DotWidth.GetValueFloat(b);this.RenderInstance(n,d,p,f,g,i,j,k,m,o,this.GetLabel(b));}}else{}this.BaseRender(c,d);};this.DetailHitDot=function(n,a,x,y,s){var t,b;return(((t=(x-n))*t+(b=(y-a))*b)<s)?true:false;};this.DetailHitTest=function(o,n,a,b){var x,y,c,d;this.m_DataSource.Select(n);var l=this.m_LineWidth.GetValueLong(this.m_Scene.m_Ctx)/2;var e=this.m_DotWidth.GetValueLong(this.m_Scene.m_Ctx)/2;var s=l*l;var f=e*e;var L=this.m_LP[n];x=L[0][0];y=L[0][1];if(f&&this.DetailHitDot(a,b,x,y,f))return{m_hit:1,m_dot:0};var g=L.length;for(var h=1;h<g;++h){c=L[h][0];d=L[h][1];if(l&&!((a<(Math.min(x,c)-l))||(a>(Math.max(x,c)+l))||(b<(Math.min(y,d)-l))||(b>(Math.max(y,d)+l)))&&(s>VBI.Utilities.sqDistance(x,y,c,d,a,b))){VBI.m_bTrace&&VBI.Trace("VBI.VisualObjects.Route hit line "+n);return{m_hit:1};}if(f&&this.DetailHitDot(a,b,c,d,f)){VBI.m_bTrace&&VBI.Trace("VBI.VisualObjects.Route hit dot "+n);return{m_hit:1,m_dot:h};}x=c;y=d;}if(L.m_RS&&VBI.Utilities.pointInTriangle(L.m_RS.ta,[a,b]))return{m_hit:1,m_arrow:0};if(L.m_RE&&VBI.Utilities.pointInTriangle(L.m_RE.ta,[a,b]))return{m_hit:1,m_arrow:1};return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.DesignBoxSize=VBI.Utilities.SceneBindPosArrayDesignBoxSize.bind(this);};VBI.VisualObjects.Route.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Circle=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(d,'colorBorder',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Radius=new VBI.AttributeProperty(d,'radius',this.m_DataSource,c,5));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Slices=new VBI.AttributeProperty(d,'slices',this.m_DataSource,c,10));this.BaseLoad(d,c,this);};this.CalculateLabelPos=function(s,p,o){var z=s.GetCurrentZoomFactors();var r=s.m_Div.getBoundingClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var c=s.m_Canvas[0].getPixelTop()/z[1];var d=[-P,-c,-P+a,-c+b];var e=VBI.Utilities.GetMidpointForPolygon(p.pa,p.bb,o,d);if(e&&e.aPos){return e.aPos;}return null;};this.RenderInstance=function(n,d,p,c,a,b,s,l){var e=this.m_Scene;var z=e.GetCurrentZoomFactors();var r=b/z[0];var x=e.GetPointFromPos(p,false);var f;var i=this.m_IO[n]=e.GetInstanceOffsets(f=this.m_BB[n]=[x[0]-r,x[1]-r,x[0]+r,x[1]+r]);f.m_Radius=r;f.m_Pos=x;if(this.IsPosChangeable(e.m_Ctx)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(f);}}d.lineWidth=1;d.fillStyle=c;for(var g=0;g<i.length;++g){d.setTransform(1,0,0,1,i[g],0);d.beginPath();d.arc(x[0],x[1],r,0,2*Math.PI);d.closePath();d.fill();d.strokeStyle=a;d.stroke();VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);if(l&&i.length){var h=[0,0,0,0];var j=[];var k=20;for(var g=0;g<k;++g){var t=g*2*Math.PI/k;var m=x[0]+r*Math.sin(t);var o=x[1]+r*Math.cos(t);j.push(m,o);}var q={pa:j,bb:[[f[0],f[1]],[f[2],f[3]]]};this.m_Label.push(new VBI.Label(l,this.CalculateLabelPos,q,h,i));}};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var b=this.m_Scene.m_Ctx;var e=0;var f;if(f=this.m_DataSource.GetCurrentNode(b)){e=f.m_dataelements.length;for(var n=0;n<e;++n){this.m_DataSource.Select(n);var h=this.IsHot(n);var S=this.IsSelected(b);var p=this.m_Pos.GetValueVector(b);var g=this.m_Color.GetValueColor(b);if(S)g=this.GetSelectColor(b,g);if(h)g=this.GetHotColor(b,g);var i=this.m_ColorBorder.GetValueColor(b);if(S)i=this.GetSelectColor(b,i);if(h)i=this.GetHotColor(b,i);var r=this.m_Radius.GetValueFloat(b);if(h)r=(this.GetHotScale(b))[0]*r;var s=this.m_Slices.GetValueLong(b);this.RenderInstance(n,d,p,g,i,r,s,this.GetLabel(b));}}else{}this.BaseRender(c,d);return e;};this.DetailHitTest=function(o,n,a,b){var c=this.m_BB[n];var r=c.m_Radius;var x=c.m_Pos;var t,d;if(((t=(x[0]-a))*t+(d=(x[1]-b))*d)<r*r)return{m_hit:1};return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this),m_zf:z};return this.BaseHitTest(n,a,o);};this.DesignGetActiveBoxHandles=function(i){var s=this.m_Scene;this.m_DataSource.Select(i);return this.m_Radius.IsChangeable(s.m_Ctx)?[0,1,0,1,0,1,0,1,0]:[0,0,0,0,0,0,0,0,0];};this.DesignBoxSize=VBI.Utilities.SceneBindRadiusDesignBoxSize.bind(this);};VBI.VisualObjects.Circle.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.CircleDist=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'midpoint',this.m_DataSource,c));this.m_Props.push(this.m_ColBorder=new VBI.AttributeProperty(d,'colorBorder',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Radius=new VBI.AttributeProperty(d,'radius',this.m_DataSource,c,10));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_ColFill=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Slices=new VBI.AttributeProperty(d,'slices',this.m_DataSource,c,10));this.BaseLoad(d,c,this);};this.CalculateLabelPos=function(s,p,o){var z=s.GetCurrentZoomFactors();var r=s.m_Div.getBoundingClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var c=s.m_Canvas[0].getPixelTop()/z[1];var d=[-P,-c,-P+a,-c+b];var e=VBI.Utilities.GetMidpointForPolygon(p.pa,p.bb,o,d);if(e&&e.aPos){return e.aPos;}return null;};this.RenderCircleDist=function(n,d,a,c,b){var s=this.m_Scene;var l=this.m_LP[n];if(l.length)l=null;var t,e,x,f=s.GetPointFromGeo(a[0],false);d.strokeStyle=b;d.fillStyle=c;d.lineWidth=1;d.beginPath();d.moveTo(f[0],f[1]);l&&l.push(f);for(var g=1;g<a.length;++g){x=s.GetPointFromGeo(a[g],false);if(((t=(f[0]-x[0]))*t+(e=(f[1]-x[1]))*e)<5.0)continue;l&&l.push(x);d.lineTo(x[0],x[1]);f=x;}d.closePath();d.stroke();d.fill();};this.RenderInstance=function(n,d,p,c,a,r,s,l){var b,e=this.m_Scene;var f=VBI.MathLib.EquidistantLonLat(VBI.MathLib.DegToRad(p),r,s);this.m_Pos.IsChangeable(e.m_Ctx)&&(this.m_DH[n]=[e.GetPointFromPos(p,false)]);var g=e.GetPointFromGeo([f.m_MinX,f.m_MaxY,0.0],false);var h=e.GetPointFromGeo([f.m_MaxX,f.m_MinY,0.0],false);var i=this.m_IO[n]=e.GetInstanceOffsets(b=this.m_BB[n]=[g[0],g[1],h[0],h[1]]);if(this.IsPosChangeable(e.m_Ctx)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(e.GetPointFromPos(p,false));}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(b);}}for(var j=0;j<i.length;++j){d.setTransform(1,0,0,1,i[j],0);this.RenderCircleDist(n,d,f,c,a);VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);if(l&&i.length){var k=[0,0,0,0];var m=[];for(var o=0;o<this.m_LP[n].length;++o){m.push(this.m_LP[n][o][0],this.m_LP[n][o][1]);}var q={pa:m,bb:[g,h]};this.m_Label.push(new VBI.Label(l,this.CalculateLabelPos,q,k,i));}};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_LP=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var b=this.m_Scene.m_Ctx;var e;if(e=this.m_DataSource.GetCurrentNode(b)){for(var n=0,l=e.m_dataelements.length;n<l;++n){this.m_DataSource.Select(n);var h=this.IsHot(n);var S=this.IsSelected(b);var p=this.m_Pos.GetValueVector(b);var f=this.m_ColBorder.GetValueColor(b);if(S)f=this.GetSelectColor(b,f);if(h)f=this.GetHotColor(b,f);var r=this.m_Radius.GetValueFloat(b);if(h)r=(this.GetHotScale(b))[0]*r;var s=this.m_Slices.GetValueLong(b);var g=this.m_ColFill.GetValueColor(b);if(S)g=this.GetSelectColor(b,g);if(h)g=this.GetHotColor(b,g);this.m_LP[n]=[];this.RenderInstance(n,d,p,g,f,r,s,this.GetLabel(b));}}else{}this.BaseRender(c,d);};this.DetailHitTest=function(o,n,a,b){return VBI.Utilities.pointInPolygon(this.m_LP[n],a,b)?{m_hit:1}:null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this),m_zf:z};return this.BaseHitTest(n,a,o);};this.DesignGetActiveBoxHandles=function(i){var s=this.m_Scene;this.m_DataSource.Select(i);return this.m_Radius.IsChangeable(s.m_Ctx)?[0,1,0,1,0,1,0,1,0]:[0,0,0,0,0,0,0,0,0];};this.DesignBoxSize=VBI.Utilities.SceneBindMeterRadiusDesignBoxSize.bind(this);};VBI.VisualObjects.CircleDist.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.m_AC=["rgba(0,143,211,1.0)","rgba(153,209,1,1.0)","rgba(243,155,2,1.0)","rgba(159,207,236,1.0)","rgba(75,167,7,1.0)","rgba(246,209,51,1.0)","rgba(203,77,44,1.0)","rgba(202,199,186,1.0)","rgba(13,134,156,1.0)","rgba(205,215,46,1.0)","rgba(36,114,48,1.0)","rgba(108,222,220,1.0)","rgba(235,115,0,1.0)","rgba(185,187,209,1.0)","rgba(0,109,211,1.0)","rgba(61,185,127,1.0)","rgba(165,84,148,1.0)","rgba(1,88,43,1.0)","rgba(77,182,239,1.0)","rgba(175,43,23,1.0)","rgba(212,153,18,1.0)","rgba(187,204,210,1.0)","rgba(48,146,13,1.0)","rgba(29,169,193,1.0)","rgba(42,71,201,1.0)","rgba(209,153,194,1.0)","rgba(204,88,38,1.0)","rgba(114,191,68,1.0)","rgba(10,72,157,1.0)","rgba(151,156,163,1.0)","rgba(14,145,144,1.0)","rgba(97,32,154,1.0)"];VBI.VisualObjects.Pie=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Series=new VBI.NodeProperty(d,'series',this.m_DataSource,c));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c,[1.0,1.0,1.0]));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_Values=new VBI.AttributeProperty(d,'value',this.m_Series,c));this.m_Props.push(this.m_Texts=new VBI.AttributeProperty(d,'text',this.m_Series,c));this.m_Props.push(this.m_SliceColor=new VBI.AttributeProperty(d,'slicecolor',this.m_Series,c));this.m_Props.push(this.m_Tooltips=new VBI.AttributeProperty(d,'extooltip',this.m_Series,c,this.m_defaultTooltip));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_StartColor=new VBI.AttributeProperty(d,'startcolor',this.m_DataSource,c,0));this.BaseLoad(d,c,this);};this.RenderInstance=function(n,d,p,r,a,t,c,b,s){var e=this.m_Scene;var f=e.m_Ctx;var g=0;for(var h=0;h<a.length;++h)g+=a[h];this.m_SUM[n]=g;var x=e.GetPointFromPos(p,false);var z=e.GetCurrentZoomFactors();r/=z[0];var i;var I=this.m_IO[n]=e.GetInstanceOffsets(i=this.m_BB[n]=[x[0]-r,x[1]-r,x[0]+r,x[1]+r]);i.m_Radius=r;i.m_Pos=x;if(this.IsPosChangeable(f)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(i);}}this.m_ARC[n]=[3*Math.PI/2];var j=this.m_StartColor.GetValueLong(f);var k=VBI.VisualObjects.m_AC.length;for(var l=0;l<I.length;++l){d.setTransform(1,0,0,1,I[l],0);var m=3*Math.PI/2;for(var h=0;h<a.length;++h){var o=d.createRadialGradient(x[0],x[1],0,x[0],x[1],r);var q=c[h];if(!q)q=VBI.VisualObjects.m_AC[(h+j)%k];if(s)q=this.GetSelectColor(f,q);if(h==b)q=this.GetHotColor(f,q);o.addColorStop(0,q);o.addColorStop(0.95,q);o.addColorStop(1.0,'rgba(255,255,255,0.0 )');d.fillStyle=o;d.beginPath();d.moveTo(x[0],x[1]);var u=Math.PI*2*(a[h]/g);d.arc(x[0],x[1],r,m,m+u,false);d.lineTo(x[0],x[1]);d.closePath();d.fill();m+=u;if(!l)this.m_ARC[n].push(m);}}d.setTransform(1,0,0,1,0,0);};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_DH=[];this.m_ARC=[];this.m_SUM=[];var s=this.m_Scene;var b=s.m_Ctx;var e=0;var n,f;if(n=this.m_DataSource.GetCurrentNode(b)){e=n.m_dataelements.length;for(var g=0;g<e;++g){this.m_DataSource.Select(g);var p=this.m_Pos.GetValueVector(b);var S=this.m_Scale.GetValueVector(b);var r=16*S[0];var h=this.IsHot(g);var i=this.IsSelected(b);if(h)r=(this.GetHotScale(b))[0]*r;var V=[],t=[],j=[];if(f=this.m_Series.GetCurrentNode(b)){for(var k=0;k<f.m_dataelements.length;++k){this.m_Series.Select(k);V.push(this.m_Values.GetValueFloat(b));t.push(this.m_Texts.GetValueString(b));j.push(this.m_SliceColor.GetValueColor(b));}}var l,m=(h&&(l=s.m_HotItem.m_HitObj)&&(l=l.m_Detail))?l.m_slice:-1;this.RenderInstance(g,d,p,r,V,t,j,m,i);}}else{}this.BaseRender(c,d);return e;};this.DetailHitTest=function(o,n,a,b){var c=this.m_BB[n];var r=c.m_Radius;var p=c.m_Pos;var t,d;if(((t=(p[0]-a))*t+(d=(p[1]-b))*d)<(r*r)){var e=Math.acos(d/Math.sqrt(t*t+d*d));var f=(t<=0?3*Math.PI/2+e:7*Math.PI/2-e);var m=this.m_ARC[n];var l=0,h=m.length-1,g;while(h>l+1){g=Math.round((l+h)/2);if(m[g]>f)h=g;else l=g;}return{m_hit:1,m_slice:l};}return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.doFormatedReplaces=function(m,s,e,a){var l=s.length;while((nIndex=m.indexOf(s))>=0){var n=nIndex+m.substring(nIndex+l).indexOf(e)+l+1;var f=m.substring(nIndex+l,n-1);var u=false,b;if((b=f.indexOf(","))>=0)u=true;else b=f.indexOf(".");var c=Math.min(10,(b>=0?parseInt(f.substring(b+1)):0));var d=m.substring(nIndex,n);var g=""+a.toFixed(c);if(u)g=g.replace(".",",");m=m.replace(d,g);}return m;};this.getTooltip=function(c,h){var p=h.m_Index;var i=h.m_Detail.m_slice;this.m_DataSource.Select(p);this.m_Series.Select(i);var t=this.m_Tooltips.GetValueString(c);if(t=="")t=this.m_Tooltip.GetValueString(c);if((t===null)||(t===""))return"";t=t.replace(/%MAIN%/,this.m_Tooltip.GetValueString(c));t=t.replace(/%NUM%/g,i+1);t=t.replace(/%ONUM%/g,i+1);t=t.replace(/%NAME%/g,this.m_Texts.GetValueString(c));var a=parseFloat(this.m_Values.GetValueString(c));t=this.doFormatedReplaces(t,"%VALUE","%",a);t=this.doFormatedReplaces(t,"%PERCENTAGE","%",100*a/this.m_SUM[p]);return t;};this.DesignBeginDrag=function(o){o.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);o.m_DhOrig=this.m_DH[o.m_Index].slice(0);};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,true);};VBI.VisualObjects.Pie.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Box=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c,[0.0,0.0,0.0]));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c,[1.0,1.0,1.0]));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(d,'colorBorder',this.m_DataSource,c,this.m_defaultColor));this.BaseLoad(d,c,this);};this.RenderInstance=function(n,d,p,s,c,a,e){var g,h=this.m_Scene;if(!s)s=[1.0,1.0,1.0];if(!c)c="#6f6f7a";var x=h.GetPointFromPos(p,false);var z=h.GetCurrentZoomFactors();var i=1.0;sy=1.0;if(this.IsHot(n)){var j=this.GetHotScale(h.m_Ctx);i=j[0];sy=j[1];}var k=370;var m=k*s[0]*i/z[0];var o=k*s[1]*sy/z[1];if(!e){var f=Math.pow(2,h.GetCurrentZoomlevel())/14.6;m*=f;o*=f;}var l=x[0]-m/2;var t=x[1]-o/2;var r=x[0]+m/2;var b=x[1]+o/2;var I=this.m_IO[n]=h.GetInstanceOffsets(g=this.m_BB[n]=[l,t,r,b]);if(this.IsPosChangeable(h.m_Ctx)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(g);}}for(var q=0;q<I.length;++q){d.setTransform(1,0,0,1,I[q],0);d.fillStyle=c;d.fillRect(l,t,m,o);d.lineWidth=1;d.strokeStyle=a;d.strokeRect(l,t,m,o);VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_DH=[];var s=this.m_Scene,b=s.m_Ctx;var e=0;var n;if(n=this.m_DataSource.GetCurrentNode(b)){e=n.m_dataelements.length;for(var f=0;f<e;++f){this.m_DataSource.Select(f);var h=this.IsHot(f);var S=this.IsSelected(b);var p=this.m_Pos.GetValueVector(b);var g=this.m_Scale.GetValueVector(b);var C=this.m_Color.GetValueColor(b);if(S)C=this.GetSelectColor(b,C);if(h)C=this.GetHotColor(b,C);var i=this.m_ColorBorder.GetValueColor(b);if(S)i=this.GetSelectColor(b,i);if(h)i=this.GetHotColor(b,i);var F=this.m_FxSize.GetValueBool(b);this.RenderInstance(f,d,p,g,C,i,F);}}else{}this.BaseRender(c,d);return e;};this.DetailHitTest=function(o,n,a,b){return{m_hit:1};};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.DesignBeginDrag=function(o){o.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);o.m_DhOrig=this.m_DH[o.m_Index].slice(0);};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,false);};VBI.VisualObjects.Box.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Area=function(){this.m_LineWidth=1;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'posarray',this.m_DataSource,c));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(d,'colorBorder',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.BaseLoad(d,c,this);};this.RenderArea=function(n,d,p,c,a,l,h){var s=l*l/2;var i,x,t,b;var e=p.length/3;if(e<2)return;var L=this.m_LP[n];if(L.length)L=null;d.strokeStyle=a;d.fillStyle=c;d.lineWidth=h>0?2:l;d.lineCap='round';d.beginPath();var f=[p[0],p[1]];if(L)L.push(f);d.moveTo(f[0],f[1]);for(var g=1;g<e;++g){i=g*3;x=[p[i],p[i+1],0.0];if(((t=(f[0]-x[0]))*t+(b=(f[1]-x[1]))*b)<s)continue;d.lineTo(x[0],x[1]);if(L)L.push(x);f=x;}d.closePath();d.fill();d.stroke();};this.CalculateLabelPos=function(s,p,o){var z=s.GetCurrentZoomFactors();var r=s.m_Div.getBoundingClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var c=s.m_Canvas[0].getPixelTop()/z[1];var d=[-P,-c,-P+a,-c+b];var e=VBI.Utilities.GetMidpointsForPolygon(p.pa,p.bb,o,d);if(e&&e.aPos){return e.aPos;}return null;};this.RenderInstance=function(n,d,p,c,a,l,h,b){var s=this.m_Scene;var e=s.GetNearestPosArray(p);var f=s.GetPointFromPos([e.m_MinX,e.m_MaxY,0.0],false);var r=s.GetPointFromPos([e.m_MaxX,e.m_MinY,0.0],false);var i=this.m_IO[n]=s.GetInstanceOffsets(this.m_BB[n]=[f[0]-l,f[1]-l,r[0]+l,r[1]+l]);var g=i.length?s.GetPointArrayFromPosArray(e,false):null;if(this.IsPosChangeable(s.m_Ctx)&&g){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;for(var j=0,k=g.length/3;j<k;++j)D.push([g[j*3],g[j*3+1]]);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(this.m_BB[n]);}}for(var j=0;j<i.length;++j){d.setTransform(1,0,0,1,i[j],0);this.RenderArea(n,d,g,c,a,l,h);VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);if(b&&i.length){var m=[0,0,0,0];var o=[];for(var j=0;j<=g.length-3;j+=3){o.push(g[j],g[j+1]);}var q={pa:o,bb:[f,r]};this.m_Label.push(new VBI.Label(b,this.CalculateLabelPos,q,m,i));}};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_LP=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var s=this.m_Scene;var b=s.m_Ctx;var e;if(e=this.m_DataSource.GetCurrentNode(b)){for(var n=0,l=e.m_dataelements.length;n<l;++n){this.m_DataSource.Select(n);this.m_LP[n]=[];var h=this.IsHot(n);var S=this.IsSelected(b);var f=-1;var p=this.m_Pos.GetValueVector(b);var g=this.m_Color.GetValueColor(b);if(S)g=this.GetSelectColor(b,g);var i=this.m_ColorBorder.GetValueColor(b);if(S)i=this.GetSelectColor(b,i);if(h){var j=s.m_HotItem.m_HitObj.m_Detail;if(j&&j.m_edge>=0&&(this.BaseFindAction("EdgeClick")||this.BaseFindAction("EdgeContextMenu"))){f=j.m_edge;i=this.GetHotColor(b,i);}else{g=this.GetHotColor(b,g);i=this.GetHotColor(b,i);}}this.RenderInstance(n,d,p,g,i,this.m_LineWidth,f,this.GetLabel(b));}}else{}this.BaseRender(c,d);};this.DetailHitTest=function(a,n,b,c){if(VBI.Utilities.pointInPolygon(this.m_LP[n],b,c)){var h={m_hit:1};var o;if((o=VBI.Utilities.pointOnLine(this.m_LP[n],b,c,5,true))&&o.m_edge>=0){h.m_edge=o.m_edge;h.m_node=o.m_node;}return h;}return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.ProcessDetailNodeEdgeEvent=function(e,a,h,n){var s=this.m_Scene,b=s.m_Ctx.m_Actions;if(b){var c;if(c=b.findAction(n,s,this)){var p=s.GetEventVPCoordsObj(e);p.edge=h.m_Detail.m_edge.toString();p.node=h.m_Detail.m_node.toString();this.m_Scene.m_Ctx.FireAction(c,s,this,a,p);return true;}}return false;};this.DetailClick=function(e,a,h){if(h.m_Detail&&(h.m_Detail.m_edge>=0))return this.ProcessDetailNodeEdgeEvent(e,a,h,'EdgeClick');return false;};this.DetailContextmenu=function(e,a,h){if(h.m_Detail&&(h.m_Detail.m_edge>=0))return this.ProcessDetailNodeEdgeEvent(e,a,h,'EdgeContextMenu');return false;};this.DesignBoxSize=VBI.Utilities.SceneBindPosArrayDesignBoxSize.bind(this);};VBI.VisualObjects.Area.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.HeatMap=function(){this.load=function(d,c){jQuery.sap.require("sap.ui.vbm.lib."+"sapheatmap");Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_Value=new VBI.AttributeProperty(d,'value',this.m_DataSource,c,1));this.m_Props.push(this.m_Opacity=new VBI.AttributeProperty(d,'opacity',this.m_DataSource,c,0.5));this.m_Props.push(this.m_Gradient=new VBI.AttributeProperty(d,'gradient',this.m_DataSource,c,""));this.BaseLoad(d,c,this);};this.CollectData=function(c){var s=this.m_Scene;var n,a,b,p=[],V=[],m=Number.MAX_VALUE,d=Number.MAX_VALUE,e=-Number.MAX_VALUE,f=-Number.MAX_VALUE;if(b=this.m_DataSource.GetCurrentNode(c)){for(var g=0,l=b.m_dataelements.length;g<l;++g){this.m_DataSource.Select(g);var h=this.m_Pos.GetValueVector(c);n=h[0];a=h[1];if(m>n)m=n;if(e<n)e=n;if(d>a)d=a;if(f<a)f=a;V.push(this.m_Value.GetValueFloat(c));p.push(h[0],h[1],0);}}var i=s.GetPointFromPos([m,f,0.0],false);var r=s.GetPointFromPos([e,d,0.0],false);this.m_IO[0]=s.GetInstanceOffsets([i[0],i[1],r[0],r[1]]);return{pos:this.m_Scene.GetPointArrayFromPosArray(p,false),val:V};};this.Render=function(c,d){this.m_IO=[];var s=this.m_Scene;var b=s.m_Ctx;var w=s.m_nWidthCanvas;var h=s.m_nHeightCanvas;if(!this.Heatmap){var e=document.createElement("canvas");e.width=w;e.height=h;this.Heatmap=VBI.CreateHM({canvas:e,colorTexture:b.GetResources().GetData(this.m_Gradient.GetValueString(b)),alpha:true,width:w,height:h});}var f=this.Heatmap;var V=this.CollectData(b);f.Clear();for(var n=this.m_IO[0].length-1;n>=0;--n){var o=this.m_IO[0][n];for(var g=0,l=V.pos.length/3;g<l;++g)f.AddPoint(V.pos[3*g]+o,V.pos[3*g+1],(V.val[g]+20)/100,70);}f.Render();var a=d.globalAlpha;d.globalAlpha=this.m_Opacity.GetValueFloat(b);d.drawImage(f.m_Canv,0,0);d.globalAlpha=a;};this.DetailHitTest=function(o,n,a,b){return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.DesignBeginDrag=function(o){o.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);o.m_DhOrig=this.m_DH[o.m_Index].slice(0);};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,true);};VBI.VisualObjects.HeatMap.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Container=function(){this.m_ContHash={};this.m_Cont=[];this.m_Sub=[];this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_Key=new VBI.AttributeProperty(d,'key',this.m_DataSource,c,""));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,""));this.m_Props.push(this.m_Alignment=new VBI.AttributeProperty(d,'alignment',this.m_DataSource,c,"0"));this.m_Sub.push(this.m_Scene.m_EvtCont.subscribe("onMove",this.onLayout.bind(this)));this.m_Sub.push(this.m_Scene.m_EvtCont.subscribe("onZoom",this.onLayout.bind(this)));};this.clear=function(){Object.getPrototypeOf(this).clear();for(var n=0,l=this.m_Sub.lenght;n<l;++n)this.m_Sub[n].unsubscribe();this.m_Sub=[];};this.getParentDiv=function(){return this.m_Scene.m_Div;};this.findContainer=function(i){return this.m_ContHash[i];};this.markContainer=function(c,a){c.m_Mark=a;};this.markContainers=function(a){for(var n=0,l=this.m_Cont.length;n<l;++n)this.m_Cont[n].m_Mark=a;};this.sweepContainers=function(a,c){var p=this.getParentDiv();for(var l=this.m_Cont.length,n=l-1;n>=0;--n){var b=this.m_Cont[n];if(b.m_Mark==a){this.m_Cont.splice(n,1);c.onCloseWindow(b.id,b);p.removeChild(b);}}};this.updateContainers=function(c,s,a){this.markContainers(true);var d=this.getParentDiv();var x=c.getPixelLeft();var y=c.getPixelTop();var t=[];var z=this.m_Scene.GetCurrentZoomFactors();if(node=this.m_DataSource.GetCurrentNode(a)){var b,l=node.m_dataelements.length;for(var n=0,l=node.m_dataelements.length;n<l;++n){this.m_DataSource.Select(n);var p=this.m_Pos.GetValueVector(a);var k=this.m_Key.GetValueString(a);var e=this.m_Tooltip.GetValueString(a);var f=this.m_Alignment.GetValueString(a);var g=s.GetPointFromPos(p,false);if(b=this.findContainer(k)){this.markContainer(b,false);t.push(b);if(!b.children.length)a.onOpenWindow(k,b);}else{b=VBI.Utilities.CreateContainer("vbi_"+k,k,x+(g[0]|0),y+(g[1]|0),"50px","30px",e,500);b.m_ID=this.m_ID;this.markContainer(b,false);t.push(b);d.appendChild(b);a.onOpenWindow(k,b);}}}this.sweepContainers(true,a);this.m_ContHash={};this.m_Cont=t;for(var n=0,l=t.length;n<l;++n)this.m_ContHash[t[n].m_Key]=t[n];};this.onLayout=function(o){this.RenderInstances(o.canvas,[1.0,1.0]);};this.RenderInstances=function(c,z){var s=this.m_Scene;var a=s.m_Ctx;if(this.m_bChanged){this.updateContainers(c,s,a);this.m_bChanged=false;}var x=c.getPixelLeft();var y=c.getPixelTop();if(node=this.m_DataSource.GetCurrentNode(a)){var l=node.m_dataelements.length;for(var n=0,l=node.m_dataelements.length;n<l;++n){var b=this.m_Cont[n];this.m_DataSource.Select(n);var p=this.m_Pos.GetValueVector(a);var d=s.GetPointFromPos(p,true);b.style.left=(x+(d[0]|0)/z[0])+"px";b.style.top=(y+(d[1]|0)/z[1])+"px";var e=this.m_Alignment.GetValueString(a);switch(e){case"0":b.style.msTransform=b.style.transform="translate(-50%, -50%)";break;case"1":b.style.msTransform=b.style.transform="translate(-50%, 0%)";break;case"2":b.style.msTransform=b.style.transform="translate(-100%, 0%)";break;case"3":b.style.msTransform=b.style.transform="translate(-100%, -50%)";break;case"4":b.style.msTransform=b.style.transform="translate(-100%, -100%)";break;case"5":b.style.msTransform=b.style.transform="translate(-50%, -100%)";break;case"6":b.style.msTransform=b.style.transform="translate(0%, -100%)";break;case"7":b.style.msTransform=b.style.transform="translate(0%, -50%)";break;default:case"8":b.style.msTransform=b.style.transform="translate(0%, 0%)";break;}}}};this.Render=function(c,d){var z=this.m_Scene.GetCurrentZoomFactors();if(z[0]!=1.0)return;this.RenderInstances(c,[1.0,1.0]);};this.onclick=function(e){return this.BaseClick(e);};};VBI.VisualObjects.Container.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Base2D=function(){this.m_DOMElement=null;this.m_paddingLeft=5;this.m_paddingTop=5;this.m_paddingRight=5;this.m_paddingBottom=5;this.IsValid=function(){if(this.m_DOMElement&&this.m_Scene.m_Div){if(this.m_DOMElement.parentNode==this.m_Scene.m_Div)return true;}return false;};this.load=function(i,d,c){Object.getPrototypeOf(this).load(i,d,c);i.m_Props.push(i.m_Left=new VBI.AttributeProperty(d,'left',null,c));i.m_Props.push(i.m_Top=new VBI.AttributeProperty(d,'top',null,c));i.m_Props.push(i.m_Right=new VBI.AttributeProperty(d,'right',null,c));i.m_Props.push(i.m_Bottom=new VBI.AttributeProperty(d,'bottom',null,c));i.m_Props.push(i.m_Align=new VBI.AttributeProperty(d,'align',null,c,1));};this.clear=function(){Object.getPrototypeOf(this).clear();this.m_DOMElement=null;};this.BaseClick=function(e){var s=this.m_Scene;var a;if(a=s.m_Ctx.m_Actions){var b;if(b=a.findAction("Click",s,this)){s.m_Ctx.FireAction(b,s,this,null,s.GetEventVPCoordsObj(e));e.preventDefault();return true;}}return false;};};VBI.VisualObjects.Base2D.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Caption=function(){this.m_LineWidth=1;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',null,c,""));this.m_Props.push(this.m_Design=new VBI.AttributeProperty(d,'design',null,c,"0"));this.m_Props.push(this.m_Level=new VBI.AttributeProperty(d,'level',null,c,0));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',null,c,""));};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var f=this.m_Align.GetValueLong(e);var g=this.m_Text.GetValueString(e);var h=this.m_Design.GetValueLong(e);var i=this.m_Level.GetValueLong(e);var j=this.m_Tooltip.GetValueString(e);this.m_DOMElement=VBI.Utilities.CreateCaption(this.m_ID,g,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,j,h,i,f);this.m_Scene.m_Div.appendChild(this.m_DOMElement);};};VBI.VisualObjects.Caption.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Label=function(){this.m_LineWidth=1;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',null,c,""));this.m_Props.push(this.m_Design=new VBI.AttributeProperty(d,'design',null,c,"0"));};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var f=this.m_Align.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var g=this.m_Text.GetValueString(e);this.m_DOMElement=VBI.Utilities.CreateLabel(this.m_ID,g,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,0,f);this.m_Scene.m_Div.appendChild(this.m_DOMElement);};};VBI.VisualObjects.Label.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Link=function(){this.m_LineWidth=1;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Reference=new VBI.AttributeProperty(d,'reference',null,""));this.m_Props.push(this.m_Autoexecute=new VBI.AttributeProperty(d,'autoexecute',null,c,false));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',null,c,""));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',null,c,""));};this.clear=function(){if(this.m_DOMElement)this.m_DOMElement.onclick=null;Object.getPrototypeOf(this).clear();};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var f=this.m_Align.GetValueLong(e);var g=this.m_Text.GetValueString(e);var h=this.m_Reference.GetValueString(e);var i=this.m_Autoexecute.GetValueBool(e);var j=this.m_Tooltip.GetValueString(e);this.m_DOMElement=VBI.Utilities.CreateLink(this.m_ID,g,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,i?h:null,j,f);this.m_Scene.m_Div.appendChild(this.m_DOMElement);this.m_DOMElement.onclick=this.onclick.bind(this);};this.onclick=function(e){return this.BaseClick(e);};};VBI.VisualObjects.Link.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Image=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Image=new VBI.AttributeProperty(d,'image',null,c));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',null,c,""));};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var f=this.m_Align.GetValueLong(e);var i=this.m_Image.GetValueString(e);var g=this.m_Tooltip.GetValueString(e);var h;if(h=e.GetResources().GetImage(i)){this.m_DOMElement=VBI.Utilities.CreateImage(this.m_ID,h,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,g,f);this.m_Scene.m_Div.appendChild(this.m_DOMElement);}};};VBI.VisualObjects.Image.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Button=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',null,c,""));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',null,c,""));};this.clear=function(){if(this.m_DOMElement)this.m_DOMElement.onclick=null;Object.getPrototypeOf(this).clear();};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var f=this.m_Text.GetValueString(e);var g=this.m_Tooltip.GetValueString(e);this.m_DOMElement=VBI.Utilities.CreateButton(this.m_ID,f,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,g);this.m_Scene.m_Div.appendChild(this.m_DOMElement);this.m_DOMElement.onclick=this.onclick.bind(this);};this.onclick=function(e){return this.BaseClick(e);};};VBI.VisualObjects.Button.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.DetailWindowProxy=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));};this.DetailHitTest=function(o,n,a,b){return{m_hit:1};};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this),m_Ctx:this.m_Scene.m_Ctx};return this.BaseHitTest(n,a,o);};this.Render=function(c,d,a){var s=this.m_Scene;var x=s.GetPointFromPos(pos,true);this.IsPosChangeable(s.m_Ctx)&&this.IsHandleMode()&&(this.m_DH[nIndex]=[x]);this.BaseRender(c,d);};};VBI.VisualObjects.DetailWindowProxy.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Dummy=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);};this.RenderInstance=function(n,d,x,s,c){};this.Render=function(c,d,a){this.BaseRender(c,d);};};VBI.VisualObjects.Dummy.prototype=VBI.VisualObjects.Base;return v;};
