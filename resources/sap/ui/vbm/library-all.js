
VBI.Actions=function(){var b={};b.m_actions=[];b.clear=function(){for(var n=0;n<b.m_actions.length;++n)b.m_actions[n].clear();b.m_actions=[];};b.Set=function(d,i,c){if(i){var a;if(a=b.findById(i)){a.load(d,c);}else{a=new VBI.Actions.Action();a.load(d,c);b.m_actions.push(a);}return;}};b.Remove=function(d,i,c){if(i){var a;if(a=b.findById(i))b.m_actions.splice(a.m_nArrayIndex,1);return;}};b.load=function(d,c){if(d.Remove){if(jQuery.type(d.Remove)=='array'){for(var n=0,l=d.Remove.length;n<l;++n)b.Remove(d.Remove[n],d.Remove[n].id,c);}}if(d.Set){if(jQuery.type(d.Set)=='array'){for(var n=0,l=d.Set.length;n<l;++n)b.Set(d.Set[n].Action,d.Set[n].id,c);return;}if(jQuery.type(d.Set)==''){for(var n=0,l=d.Set.length;n<l;++n)b.Set(d.Set[n].Action,d.Set[n].id,c);return;}if(!d.Set.id)b.clear();if(jQuery.type(d.Set.Action)=='object'){b.Set(d.Set.Action,d.Set.Action.id,c);}else if(jQuery.type(d.Set.Action)=='array'){for(var n=0;n<d.Set.Action.length;++n)b.Set(d.Set.Action[n],d.Set.Action[n].id,c);}}};b.findById=function(i){var A=b.m_actions,l=A.length;for(var n=0;n<l;++n){var a=A[n];if(a&&(a.m_id==i)){a.m_nArrayIndex=n;return a;}}};b.findAction=function(e,s,v,a){var i=null;if(jQuery.type(v)=='object')i=v.m_ID;else if(jQuery.type(v)=='string')i=v;var t,l=b.m_actions.length;for(var n=0;n<l;++n){t=b.m_actions[n];if((e?(t.m_refEvent==e):true)&&(s?(t.m_refScene==s.m_ID):true)&&(v?(t.m_refVO==i):true)&&(a?(t.m_id==a):true))return t;}return null;};VBI.Actions.Action=function(){var a={};a.m_id=0;a.m_name=null;a.m_refScene=null;a.m_refVO=null;a.m_refEvent=null;a.m_additionalProperties=[];a.clear=function(){a.m_addProperties=null;};a.load=function(d,c){a.m_id=d.id;a.m_name=d.name;a.m_refScene=d.refScene;a.m_refVO=d.refVO;a.m_refEvent=d.refEvent;a.m_additionalProperties=[];if(d.AddActionProperty){if(jQuery.type(d.AddActionProperty)=='object'){a.m_additionalProperties.push(d.AddActionProperty.name);}else if(jQuery.type(d.AddActionProperty)=='array'){for(var n=0;n<d.AddActionProperty.length;++n)a.m_additionalProperties.push(d.AddActionProperty[n].name);}}};return a;};return b;};
VBI.Automations=function(){var a={};a.m_automations=[];a.clear=function(){for(var n=0;n<a.m_automations.length;++n){a.m_automations[n].clear();}a.m_automations=[];};a.load=function(d,c){if(d.Call){if(jQuery.type(d.Call)=='object'){var b=new VBI.Automations.Automation();b.load(d.Call,c);a.m_automations.push(b);}else if(jQuery.type(d.Call)=='array'){for(var n=0;n<d.Call.length;++n){var b=new VBI.Automations.Automation();b.load(d.Call[n],c);a.m_automations.push(b);}}}};VBI.Automations.Automation=function(){var b={};b.m_additionalProperties=[];b.clear=function(){b.m_addProperties=null;};b.createHandler=function(d,h){switch(h){case"CONTEXTMENUHANDLER":return new VBI.ContextMenuHandler(d);case"FLYTOHANDLER":return new VBI.FlyToHandler(d);case"OBJECTCREATIONHANDLER":return new VBI.ObjectCreationHandler(d);case"LOOPBACKHANDLER":return new VBI.LoopBackHandler(d);default:return undefined;}};b.getMainScene=function(c){if(c.m_SceneManager.m_SceneArray.length==1)return c.m_SceneManager.m_SceneArray[0].m_ID;return undefined;};b.load=function(d,c){b.m_handlerName=d.handler;b.m_handler=b.createHandler(d.Param,d.handler);if(!b.m_handler)return;b.m_handler.m_Ctx=c;b.m_name=d.name;if(b.m_handler.m_scene==undefined)b.m_handler.m_scene=(d.scene==undefined?b.getMainScene(c):d.scene);b.m_delay=(d.delay==undefined?1:d.delay);b.m_earliest=(d.earliest==undefined?1:d.earliest);b.m_retryAfterMS=(d.retryAfterMS==undefined?0:d.retryAfterMS);b.m_reattempts=(d.reattempts==undefined?-1:d.reattempts);b.m_handler.m_refID=(d.refID==undefined?"":d.refID);b.m_handler.m_refObj=(d.object==undefined?"":d.object);b.m_handler.m_refInstance=(d.object==undefined?"":d.instance);b.m_handler.m_Name=d.name;b.m_nAttempts=0;var n=new Date();var r=n.getTime()-c.m_StartupTime;var e=b.m_delay;if(r<b.m_earliest)e=Math.max(e,b.m_earliest-r);b.m_AnimZoomTimer=window.setInterval(b.startAutomation,e);};b.startAutomation=function(){window.clearInterval(b.m_AnimZoomTimer);if(!b.m_handler.start()&&b.m_retryAfterMS){b.m_nAttempts++;if((b.m_reattempts==-1)||(b.m_nAttempts<b.m_reattempts)){b.m_AnimZoomTimer=window.setInterval(b.startAutomation,b.m_retryAfterMS);}}};return b;};return a;};
VBI.FlyToHandler=function(d){var f={};f.cnt=0;for(var i=0;i<d.length;++i){if(d[i].name==="x")f.m_x=d[i]["#"];if(d[i].name==="y")f.m_y=d[i]["#"];if(d[i].name==="lod")f.m_lod=d[i]["#"];if(d[i].name==="mode")f.m_mode=d[i]["#"];if(d[i].name==="velocity")f.m_velocity=d[i]["#"];if(d[i].name==="basetime")f.m_basetime=d[i]["#"];if(d[i].name==="scene")f.m_scene=d[i]["#"];}f.start=function(){VBI.m_bTrace&&VBI.Trace("FlyTo triggered to "+f.m_x+","+f.m_y+","+f.m_lod+" on scene "+f.m_scene);if(f.m_scene==undefined||f.m_x==undefined||f.m_y==undefined||f.m_lod==undefined)return true;var l=VBI.MathLib.DegToRad([parseFloat(f.m_x),parseFloat(f.m_y)]);var s=f.m_Ctx.m_SceneManager.GetSceneByName(f.m_scene);if(s){var a=f.m_lod;s.ZoomToGeoPosition(l,a);if(a!=Math.floor(a)){setTimeout(function(){s.AnimateZoomToGeo(l,Math.floor(a),40);},600);}}return true;};return f;};
VBI.ContextMenuHandler=function(d){var c={};c.cnt=0;for(var i=0;i<d.length;++i){if(d[i].name==="x")c.m_x=parseInt(d[i]["#"]);if(d[i].name==="y")c.m_y=parseInt(d[i]["#"]);if(d[i].name==="scene")c.m_scene=d[i]["#"];}c.start=function(){var s=c.m_Ctx.m_SceneManager.GetSceneByName(c.m_scene);var m=c.m_Ctx.m_Menus.findMenuByID(c.m_refID);if(!s)return true;m.vbi_data.scene=c.m_scene;m.vbi_data.object=c.m_refObj;m.vbi_data.instance=c.m_refInstance;m.open(true,0,"begin top","begin top",s.m_Div,""+c.m_x+" "+c.m_y+"","fit");};return c;};
VBI.ObjectCreationHandler=function(d){var h={};h.cnt=0;h.m_Ctx=null;h.m_Name=null;if(jQuery.type(d)=='object'){if(d.name==="data")h.m_data=d["#"];}else if(jQuery.type(d)=='array'){for(var i=0,l=d.length;i<l;++i)if(d[i].name==="data")h.m_data=d[i]["#"];}h.start=function(){var s=null;if(s=h.m_Ctx.m_SceneManager.GetSceneByName(h.m_scene)){if(h.m_Name=="CreateObject"){var a=null,b=s.m_Ctx.m_Actions;if(b)a=s.m_Ctx.m_Actions.findAction("CreateComplete",s,"General");var f=null;if(a){f=function(c){var p={data:c};s.m_Ctx.FireAction(a,s,"General",null,p);};}else{f=s.m_Ctx.m_Control.load.bind(s.m_Ctx.m_Control);}s.DesignCreateObject(h.m_data,null,f);}}};return h;};
VBI.LoopBackHandler=function(d){var h={};h.cnt=0;h.m_Ctx=null;h.m_Name=null;if(jQuery.type(d)=='object'){if(d.name==="ActionID")h.m_ActionID=d["#"];}else if(jQuery.type(d)=='array'){for(var i=0,l=d.length;i<l;++i)if(d[i].name==="ActionID")h.m_ActionID=d[i]["#"];}h.start=function(){if(h.m_Name=="TriggerAction"){var a;if(a=h.m_Ctx.m_Actions){var b;if(b=a.findAction(null,null,null,h.m_ActionID)){var s;if(s=h.m_Ctx.m_SceneManager.GetSceneByName(b.m_refScene)){var v=s.BaseGetVO(b.m_refVO);h.m_Ctx.FireAction(b,s,v?v:b.m_refVO,null,null);}}}}};return h;};
VBI.Configurations=function(){var c={};c.m_configdata=[];c.clear=function(){c.m_configdata=[];};c.load=function(d,a){if(d.Set){c.clear();var r=d.Set.P;if(jQuery.type(r)=='object'){c.m_configdata[r.name]=r.value;}else if(jQuery.type(r)=='array'){for(var n=0,l=r.length;n<l;++n)c.m_configdata[r[n].name]=r[n].value;}}};c.GetData=function(n){return c.m_configdata[n];};return c;};
VBI.isInt=function(i){return((i-0)==i&&i%1==0);};
VBI.IndexOf=function(a,e){var l=a.length;for(var n=0;n<l;++n)if(e==a[n])return n;return-1;};
VBI.Types={st_unknown:0,st_vector:1,st_string:2,st_vectorarray:3,st_float:4,st_color:5,st_long:6,st_bool:7,string2bool:function(a){if(typeof a=="boolean")return a;if(typeof a=="number")return a?true:false;var t=a.slice(0,1);return(t=='t'||t=='1'||t=='X')?true:false;},string2vector:function(a){var b=a.split(';');for(var n=0,l=b.length;n<l;++n)b[n]=parseFloat(b[n]);return b;},string2rgba:function(a){var c,r;if(c=/^RGBA\(([\d]+)[,;]([\d]+)[,;]([\d]+)[,;]([\d]+|[\d]*.[\d]+)\)/.exec(a)){return[+c[1],+c[2],+c[3],parseFloat(+c[4])/255.0,1];}else if(c=/^RGB\(([\d]+)[,;]([\d]+)[,;]([\d]+)\)/.exec(a)){return[+c[1],+c[2],+c[3],1.0,0];}else if(c=/^ARGB\((0[xX][0-9A-Fa-f]+)[,;](0[xX][0-9A-Fa-f]+)[,;](0[xX][0-9A-Fa-f]+)[,;](0[xX][0-9A-Fa-f]+)\)/.exec(a)){return[parseInt(c[2]),parseInt(c[3]),parseInt(c[4]),parseFloat(+c[1])/255.0,1];}else if(c=/^ARGB\(([\d]+)[,;]([\d]+)[,;]([\d]+)[,;]([\d]+)\)/.exec(a)){return[+c[2],+c[3],+c[4],parseFloat(+c[1])/255.0,1];}else if(c=/^HLSA\(([\d]+)[,;]([\d]+)[,;]([\d]+)[,;]([\d]+)\)/.exec(a)){c=[+c[1],+c[2],+c[3],+c[4]];r=VBI.Utilities.HLS2RGB(c[0]/600.0,c[1]/600.0,c[2]/600.0);return[r[0],r[1],r[2],c[3]/255,1];}else if(c=/^HLS\(([\d]+)[,;]([\d]+)[,;]([\d]+)\)/.exec(a)){c=[+c[1],+c[2],+c[3]];r=VBI.Utilities.HLS2RGB(c[0]/600.0,c[1]/600.0,c[2]/600.0);return[r[0],r[1],r[2],1.0,0];}else if(c=/^rgba\(([\d]+)[,;]([\d]+)[,;]([\d]+)[,;]([\d]+|[\d]*.[\d]+)\)/.exec(a)){return[+c[1],+c[2],+c[3],+c[4],1];}else if(c=/^rgb\(([\d]+)[,;]([\d]+)[,;]([\d]+)\)/.exec(a)){return[+c[1],+c[2],+c[3],1.0,0];}else if(c=/^hsla\(([\d]+)[,]([\d]+)\%[,]([\d]+)\%[,]([\d]+|[\d]*.[\d]+)\)/.exec(a)){c=[+c[1],+c[2],+c[3],+c[4]];r=VBI.Utilities.HLS2RGB(c[0]/360.0,c[1]/100.0,c[2]/100.0);return[r[0],r[1],r[2],c[3],1];}else if(c=/^hsl\(([\d]+)[,]([\d]+)\%[,]([\d]+)\%\)/.exec(a)){c=[+c[1],+c[2],+c[3]];r=VBI.Utilities.HLS2RGB(c[0]/360.0,c[1]/100.0,c[2]/100.0);return[r[0],r[1],r[2],1.0,0];}else if(a.charAt(0)==="#"){var C;if(a.length<7)C=a.substring(0,2)+a.substring(1,2)+a.substring(2,3)+a.substring(2,3)+a.substring(3,4)+a.substring(3,4);else C=a;return[parseInt(C.substring(1,3),16),parseInt(C.substring(3,5),16),parseInt(C.substring(5,7),16),1.0,1];}return[255,0,0,1.0,0];},string2color:function(a){var r=this.string2rgba(a);return"rgba("+r[0]+","+r[1]+","+r[2]+","+r[3]+")";},string2rhls:function(a){var c;if(c=/^RHLS\(([\d]+|[\d]*.[\d]+)[,;]([\d]+|[\d]*.[\d]+)[,;]([\d]+|[\d]*.[\d]+)\)/.exec(a))return[parseFloat(+c[1])/360.0,parseFloat(+c[2]),parseFloat(+c[3]),1.0];else if(c=/^RHLSA\(([\d]+|[\d]*.[\d]+)[,;]([\d]+|[\d]*.[\d]+)[,;]([\d]+|[\d]*.[\d]+)[,;]([\d]+|[\d]*.[\d]+)\)/.exec(a))return[parseFloat(+c[1])/360.0,parseFloat(+c[2]),parseFloat(+c[3]),parseFloat(+c[4])];return null;},color2array:function(a){var c;if(c=/^rgba\(([\d]+)[,]([\d]+)[,]([\d]+)[,]([\d]+|[\d]*.[\d]+)\)/.exec(a)){c=[parseInt(+c[1],10),parseInt(+c[2],10),parseInt(+c[3],10),parseFloat(+c[4])];return c;}return null;},string2long:function(a){if(typeof a=="boolean")return a?1:0;return parseInt(a,10);},string2float:function(a){if(typeof a=="boolean")return a?1.0:0.0;return parseFloat(a);},float2string:function(a){return a.toString();},vector2string:function(a){tmp="";for(var n=0;n<a.length;++n){tmp+=a[n];if((n+1)<a.length)tmp+=";";}return tmp;},color2string:function(a){var r;if(r=/^rgba\(([\d]+),([\d]+),([\d]+),([\d]+|[\d]*.[\d]+)\)/.exec(a)){r=[+r[1],+r[2],+r[3],parseInt(parseFloat(+r[4])*255.0)];return"RGBA("+r[0]+","+r[1]+","+r[2]+","+r[3]+")";}return null;},long2float:function(a){return parseFloat(a);},float2long:function(a){return parseInt(a);},};
VBI.DataTypeProvider=function(){var d={};d.m_datatypenodes=[];d.vbiclass="DataTypeProvider";d.isParentOf=function(p,c){if(!c)return false;var t=c;while(t=t.m_Parent){if(t==p)return true;}return false;};d.clear=function(){var o,n=this.m_datatypenodes.length;for(var a=0;a<n;++a)if(o=this.m_datatypenodes[a])o.clear();this.m_datatypenodes=[];};d.set=function(a,c){if(a.type&&a.name){if((a.type=="N")){if(jQuery.type(a.N)=='object'){var b;if(b=d.GetTypeNode(a.name,true)){b.load(a.N);return;}}else if(jQuery.type(a.N)=='array'){}}}else{this.clear();}var e;if(jQuery.type(a.N)=='object'){this.m_datatypenodes.push(e=new VBI.DataTypeProvider.DataTypeNode(this,this.m_datatypenodes.length));if(a.name)e.m_Name=a.name;if(a.N.key)e.m_Key=a.N.key;e.load(a.N);}else if(jQuery.type(a.N)=='array'){for(var i=0,l=a.N.length;i<l;++i){this.m_datatypenodes.push(e=new VBI.DataTypeProvider.DataTypeNode(this,this.m_datatypenodes.length));if(a.N[i].name)e.m_Name=a.N[i].name;if(a.N[i].key)e.m_Key=a.N[i].key;e.load(a.N[i]);}}};d.load=function(a,c){if(a.Set){if(jQuery.type(a.Set)=='object'){d.set(a.Set,c);}else if(jQuery.type(a.Set)=='array'){for(var i=0,l=a.Set.length;i<l;++i)d.set(a.Set[i],c);}}};d.GetTypeNode=function(n,b){for(var i=0;i<this.m_datatypenodes.length;++i){if(this.m_datatypenodes[i].m_Name==n)return this.m_datatypenodes[i];}if(!b)return null;var a;this.m_datatypenodes.push(a=new VBI.DataTypeProvider.DataTypeNode(null,this.m_datatypenodes.length));a.m_Name=n;return a;};d.FindTypeRefs=function(){var r=[];for(var i=0,l=this.m_datatypenodes.length;i<l;++i){var a=this.m_datatypenodes[i].m_Ref;if(a)r.push({m_Ref:a,m_DTN:this.m_datatypenodes[i]});}return r;};d.FindTypeNodeFromPath=function(p){var n,a=this.GetTypeNode(p[0],false);for(var b=1;b<p.length;++b){if(!(n=a.GetTypeNode(p[b],false)))continue;a=n;}return a;};d.FindTypeAttributeFromPath=function(p){var n=[];for(var a=0;a<(p.length-1);++a)n.push(p[a]);var b=this.FindTypeNodeFromPath(n);return b?b.GetTypeAttribute(p[a]):null;};VBI.DataTypeProvider.DataTypeNode=function(p,a){var b={};b.m_datatypenodes=[];b.m_datatypeattributes=[];b.m_nArrayIndex=a;b.m_Name="";b.m_Key=null;b.m_Ref=null;b.m_Parent=p;b.m_MinSelect=1;b.m_MaxSelect=1;b.clear=function(){var o,n,c;b.m_Parent=null;c=b.m_datatypenodes.length;for(n=0;n<c;++n)if(o=b.m_datatypenodes[n])o.clear();b.m_datatypenodes=[];c=b.m_datatypeattributes.length;for(n=0;n<c;++n)if(o=b.m_datatypeattributes[n])o.clear();b.m_datatypeattributes=[];};b.load=function(c){if(c.name)b.m_Name=c.name;if(c.key)b.m_Key=c.key;if(c.ref)b.m_Ref=c.ref;if(c.minSel)b.m_MinSelect=parseInt(c.minSel,10);if(c.maxSel)b.m_MaxSelect=parseInt(c.maxSel,10);if(c.A){var t;if(jQuery.type(c.A)=='array'){for(var i=0,l=c.A.length;i<l;++i){t=b.GetTypeAttribute(c.A[i].name,true);t.load(c.A[i]);}}else if(jQuery.type(c.A)=='object'){t=b.GetTypeAttribute(c.A.name,true);t.load(c.A);}}if(c.N){if(jQuery.type(c.N)=='array'){for(var i=0,l=c.N.length;i<l;++i){var e;b.m_datatypenodes.push(e=new VBI.DataTypeProvider.DataTypeNode(this,b.m_datatypenodes.length));e.load(c.N[i]);}}else if(jQuery.type(c.N)=='object'){var e;b.m_datatypenodes.push(e=new VBI.DataTypeProvider.DataTypeNode(this,b.m_datatypenodes.length));e.load(c.N);}}};b.GetTypeNode=function(n,c){var e=b.m_datatypenodes;for(var i=0,l=e.length;i<l;++i){if(e[i].m_Name==n)return e[i];}if(!c)return null;var f;e.push(f=new VBI.DataTypeProvider.DataTypeNode(this,e.length));f.m_Name=n;return f;};b.GetKeyTypeAttribute=function(){if(b.m_Key)return b.GetTypeAttribute(b.m_Key,true);else return b.GetTypeAttribute("VB:ix",true);return null;};b.GetSelectTypeAttribute=function(c){return b.GetTypeAttribute("VB:s",c);};b.GetPath=function(){var n=[];var c=this;do{n.splice(0,0,c.m_Name);}while((c=c.m_Parent)&&c['m_Name']);return n;};b.GetTypeAttribute=function(n,c){var e=b.m_datatypeattributes;for(var i=0,l=e.length;i<l;++i){var f=e[i];if(f.m_Alias==n||f.m_Name==n)return f;}if(c){var g;e.push(g=new VBI.DataTypeProvider.DataTypeAttribute(e.length));g.m_Name=n;g.m_Parent=this;g.m_Type=(n=="VB:s")?VBI.Types.st_bool:VBI.Types.st_string;return g;}return null;};return b;};VBI.DataTypeProvider.DataTypeAttribute=function(a){var b={};b.m_Name="";b.m_Alias="";b.m_bChangeable=false;b.m_Type=VBI.Types.st_unknown;b.m_nArrayIndex=a;b.m_Parent=null;b.clear=function(){b.m_Parent=null;};b.load=function(c){if(c.name)b.m_Name=c.name;if(c.alias)b.m_Alias=c.alias;if(c.changeable)b.m_bChangeable=VBI.Types.string2bool(c.changeable);if(c.type){switch(c.type){case"vectorarray":b.m_Type=VBI.Types.st_vectorarray;break;case"vector":b.m_Type=VBI.Types.st_vector;break;case"long":b.m_Type=VBI.Types.st_long;break;case"string":b.m_Type=VBI.Types.st_string;break;case"color":b.m_Type=VBI.Types.st_color;break;case"boolean":b.m_Type=VBI.Types.st_bool;break;case"float":b.m_Type=VBI.Types.st_float;break;default:b.m_Type=VBI.Types.st_string;break;}}};return b;};return d;};
VBI.DataProvider=function(){var d={};var N=0,E=1,A=2;d.vbiclass="DataProvider";d.m_datanodes=[];d.m_dtp=null;d.m_Ctx=null;d.clear=function(){var o,n=d.m_datanodes.length;for(var a=0;a<n;++a)if(o=d.m_datanodes[a])o.clear();d.m_datanodes=[];d.m_Ctx=null;d.m_dtp=null;};d.set=function(a,c){var b=c.m_DataTypeProvider;if(!b){VBI.m_bTrace&&VBI.Trace("Error: data types are not available");return;}if(a.type&&a.name){if((a.type=="N")){if(jQuery.type(a.N)=='object'){var e;var p=a.name.split(".");if(e=this.FindNodeFromPath(p)){if(a.name!=a.N.name){VBI.m_bTrace&&VBI.Trace("Error: node loading delta operation failed");return;}e.load(a.N,b.FindTypeNodeFromPath(p));return;}}else if(jQuery.type(a.N)=='array'){}}else if((a.type=="E")){}}else{this.clear();}if(a.N){var f,n,g;if(jQuery.type(a.N)=='object'){f=b.GetTypeNode(g=a.N.name,true);this.m_datanodes[f.m_nArrayIndex]=(n=new VBI.DataProvider.DataNode());n.m_Parent=this;n.m_Name=g;n.load(a.N,f);}else if(jQuery.type(a.N)=='array'){for(var i=0;i<a.N.length;++i){f=b.GetTypeNode(g=a.N[i].name,true);this.m_datanodes[f.m_nArrayIndex]=(n=new VBI.DataProvider.DataNode());n.m_Parent=this;n.m_Name=g;n.load(a.N[i],f);}}}};d.remove=function(i,c){var a,n;if(i.type=="N"&&(n=i.name)){if(a=this.FindNodeFromPath(n.split("."))){a.m_Parent.RemoveNode(a);}}else if(i.type=="E"&&(n=i.name)){if(a=this.FindNodeFromPath(n.split("."))){a.RemoveElements(i.N);}}};d.load=function(a,c){var b=c.m_DataTypeProvider;if(a.Remove){if(jQuery.type(a.Remove)=='object'){this.remove(a.Remove,c);}else if(jQuery.type(a.Remove)=='array'){for(var n=0,l=a.Remove.length;n<l;++n)this.remove(a.Remove[n],c);}}if(a.Set){if(jQuery.type(a.Set)=='object'){d.set(a.Set,c);}else if(jQuery.type(a.Set)=='array'){for(var i=0,l=a.Set.length;i<l;++i)d.set(a.Set[i],c);}}d.m_dtp=b;d.m_Ctx=c;};d.store=function(a){if(this.IsModified()){a.Data={};a.Data.Merge={};var n=a.Data.Merge.N=[];var t;for(var b=0;b<this.m_datanodes.length;++b){if((t=this.m_datanodes[b])&&t.IsModified()){var c={};n.push(c);t.store(c);}}}};d.OnAttributeChanged=function(a){var b;if(b=d.m_Ctx.m_Actions){var c;if(c=b.findAction("AttributeChanged",null,null)){var i=a.m_Parent.GetPath()+"."+a.m_dta.m_Name;d.m_Ctx.FireAction(c,null,null,null,null,i);}}};d.OnNodeChanged=function(n){var a;if(a=d.m_Ctx.m_Actions){var b;if(b=a.findAction("NodeChanged",null,null)){var p=null;if(n.m_Parent&&n.m_Parent.GetPath)p=n.m_Parent.GetPath()+".";else p="";d.m_Ctx.FireAction(b,null,null,null,null,p+n.m_dtn.m_Name);}}};d.OnElementChanged=function(e){var a;if(a=d.m_Ctx.m_Actions){var b;if(b=a.findAction("ElementChanged",null,null))d.m_Ctx.FireAction(b,null,null,null,null,e.GetPath());}};d.IsModified=function(){var t;for(var n=0;n<this.m_datanodes.length;++n){if((t=this.m_datanodes[n])&&t.IsModified())return true;}return false;};d.RemoveNode=function(n){var a=n.m_dtn.m_nArrayIndex;this.m_datanodes[a].clear();this.m_datanodes[a]=null;};d.FindFromPathEx=function(p,s,t,e,n){var P=false,c=null,a=null,b=null;if(n){P=true;b=n;c=n.m_dtn;}else if(e){a=e;c=e.m_Parent.m_dtn;}for(var f=s,l=p.length;f<l;++f){if(P){if(c.m_Key){if(a=b.FindElementByKey(p[f])){P=false;continue;}}else if(VBI.isInt(p[f])){a=b.m_dataelements[parseInt(p[f])];P=false;continue;}else{if((a=b.GetLeadSelectedElement())===null)if(b.m_dataelements.length)a=b.m_dataelements[0];if(!a){VBI.m_bTrace&&VBI.Trace("Error: invalid lead selected element");}}}if(t==A&&(f+1)==l){var g;if(g=c.GetTypeAttribute(p[f],false))return a.m_dataattributes[g.m_nArrayIndex];}c=c.GetTypeNode(p[f],true);if(!a){VBI.m_bTrace&&VBI.Trace("Error: Invalid Binding Path "+p);return false;}b=a.m_datanodes[c.m_nArrayIndex];P=true;}if(t==A||t==E)return null;return b;};d.FindFromPath=function(p,t){if(!d.m_dtp)return null;var c=d.m_dtp.GetTypeNode(p[0],false);if(!c)return null;var a=d.m_datanodes[c.m_nArrayIndex];if(!a)return null;return d.FindFromPathEx(p,1,t,null,a);};d.FindAttributeFromPath=function(p){return d.FindFromPath(p,A);};d.FindNodeFromPath=function(p){return d.FindFromPath(p,N);};d.SetSelection=function(s,c){var t,n=d.m_datanodes;for(var a=0,l=n.length;a<l;++a)if(t=n[a])t.SetSelection(s,c);};VBI.DataProvider.DataNode=function(){var a={};a.m_Name="";a.m_sLeadSelection=null;a.m_dataelements=[];a.m_Parent=null;a.m_dtn=null;a.m_bModified=false;a.clear=function(){a.m_dtn=null;for(var n=0;n<a.m_dataelements.length;++n){a.m_dataelements[n].clear();a.m_dataelements[n].m_Parent=null;}a.m_dataelements=[];a.m_Parent=null;};a.IsModifiedSelection=function(){return a.m_bModified?true:false;};a.IsModifiedElements=function(){var e=a.m_dataelements;for(var n=0;n<e.length;++n){if(e[n].IsModified())return true;}return false;};a.IsModified=function(){if(a.IsModifiedSelection()||a.IsModifiedElements())return true;return false;};a.store=function(b){b.name=a.m_dtn.m_Name;if((this.m_sLeadSelection!==null)&&a.IsModifiedSelection())b["VB:s"]=this.m_sLeadSelection;if(a.IsModifiedElements()){b.E=[];for(var n=0;n<a.m_dataelements.length;++n){if(a.m_dataelements[n].IsModified()){var e={};b.E.push(e);a.m_dataelements[n].store(e);}}}};a.RemoveNode=function(n){var b=n.m_dtn.m_nArrayIndex;a.m_datanodes[b].clear();a.m_datanodes[b]=null;};a.RemoveElements=function(b){var k=a.m_dtn.GetKeyTypeAttribute();var c=a.GetElementKeyMap(k);if(b.E){if(jQuery.type(b.E)=='object'){a.InternalFindAndRemoveExistingElement(b.E,0,k,c);}else if(jQuery.type(b.E)=='array'){for(var i=0;i<b.E.length;++i)a.InternalFindAndRemoveExistingElement(b.E[i],i,k,c);}}};a.GetElementKeyMap=function(k){var t,b=[];var c=k?k:a.m_dtn.GetKeyTypeAttribute();for(var n=0;n<a.m_dataelements.length;++n)b[(t=a.m_dataelements[n]).m_dataattributes[c.m_nArrayIndex].m_Value]=t;return b;};a.FindElementByKey=function(k,b,c){var t;if(c)return(t=c[k])?t:null;var e=b?b:a.m_dtn.GetKeyTypeAttribute();var f,g=this.m_dataelements;for(var n=0,l=g.length;n<l;++n){if(f=g[n]){if(f.m_dataattributes[e.m_nArrayIndex].m_Value==k)return f;}}return null;};a.FindElementByIndex=function(i){return this.m_dataelements[i];};a.InternalFindAndRemoveExistingElement=function(b,i,k,c){var e=null,f=null;if(k.m_Alias&&(e=b[k.m_Alias]))f=this.FindElementByKey(e,k,c);else if(k.m_Name&&(e=b[k.m_Name]))f=this.FindElementByKey(e,k,c);else f=this.FindElementByKey(e=i,k,c);if(f){this.m_dataelements.splice(VBI.IndexOf(this.m_dataelements,f),1);if(c)c.splice(e,1);f.clear();}};a.InternalFindOrCreateExistingElement=function(b,i,k,c){var e=null,f=null;if(k.m_Alias&&(e=b[k.m_Alias]))f=a.FindElementByKey(e,k,c);else if(k.m_Name&&(e=b[k.m_Name]))f=a.FindElementByKey(e,k,c);else f=a.FindElementByKey(e=i,k,c);if(f)return f;f=new VBI.DataProvider.DataElement();a.m_dataelements.push(f);if(c)c[e]=f;return f;};a.load=function(b,c){a.m_dtn=c;a.m_sLeadSelection=b["VB:s"];var k=a.m_dtn.GetKeyTypeAttribute();var e=a.GetElementKeyMap(k);if(b.E){if(jQuery.type(b.E)=='object'){var f=a.InternalFindOrCreateExistingElement(b.E,0,k,e);f.m_Parent=a;f.load(b.E,c);if(f.m_dataattributes[k.m_nArrayIndex]==null){da=new VBI.DataProvider.DataAttribute(k,null,f);da.m_Value=0;f.m_dataattributes[k.m_nArrayIndex]=da;}}else if(jQuery.type(b.E)=='array'){var f;for(var i=0,l=b.E.length;i<l;++i){f=a.InternalFindOrCreateExistingElement(b.E[i],i,k,e);f.m_Parent=a;f.load(b.E[i],c);if(f.m_dataattributes[k.m_nArrayIndex]==null){da=new VBI.DataProvider.DataAttribute(k,null,f);da.m_Value=i;f.m_dataattributes[k.m_nArrayIndex]=da;}}}}};a.GetName=function(){return this.m_Name;};a.GetPath=function(){return this.m_dtn.GetPath();};a.SetModified=function(){this.m_bModified=true;var p=this;while(p.m_Parent)p=p.m_Parent;if(p)p.OnNodeChanged(this);};a.SetLeadSelection=function(k){if(this.m_sLeadSelection!=k){this.m_sLeadSelection=k;this.SetModified();}};a.GetSelectedElements=function(){var s=[];var e=this.m_dataelements;var k=this.m_dtn.GetTypeAttribute("VB:s",true);for(var n=0,l=e.length;n<l;++n)if(e[n].IsSelected(k))s.push(e[n]);return s;};a.GetNumOfSelectedElements=function(){return(a.m_NumSelectedEltes!=undefined)?a.m_NumSelectedEltes:a.GetSelectedElements().length;};a.SetNumOfSelectedElements=function(){a.m_NumSelectedEltes=a.GetSelectedElements().length;};a.UnSetNumOfSelectedElements=function(){a.m_NumSelectedEltes=undefined;};a.SetSelection=function(s,c){var e=this.m_dataelements;var t=null,k=this.m_dtn.GetTypeAttribute("VB:s",true);if(!s&&c){this.SetNumOfSelectedElements();}for(var n=0,l=e.length;n<l;++n){if(t=e[n])c?t.Select(s):t.SetElementSelectionState(s,k);}this.UnSetNumOfSelectedElements();return null;};a.GetLeadSelectedElement=function(){if((this.m_sLeadSelection!=undefined)&&(this.m_sLeadSelection!==null)){var i,b=this.m_dtn;if(b.m_Key){return this.FindElementByKey(this.m_sLeadSelection);}else{i=parseInt(this.m_sLeadSelection);if(i<=this.m_dataelements.length&&i>=0){return this.m_dataelements[i];}else{VBI.m_bTrace&&VBI.Trace("Error: lead selection index out of range");}}}return null;};return a;};VBI.DataProvider.DataElement=function(){this.m_dataattributes=[];this.m_datanodes=[];this.m_Parent=null;this.m_bChangeable=false;};VBI.DataProvider.DataElement.prototype={m_dataattributes:null,m_datanodes:null,m_Parent:null,m_nModified:0,m_bChangeable:false,clear:function(){var n,t;for(n=0;n<this.m_datanodes.length;++n){if(t=this.m_datanodes[n]){t.clear();t.m_Parent=null;}}this.m_datanodes=[];for(n=0;n<this.m_dataattributes.length;++n){if(t=this.m_dataattributes[n]){t.clear();t.m_Parent=null;}}this.m_dataattributes=[];},load:function(b,c){var m=false;if(b["VB:m"]){if(m=VBI.Types.string2bool(b["VB:m"]))this.m_nModified=7;delete b["VB:m"];}if(b["VB:c"]){this.m_bChangeable=VBI.Types.string2bool(b["VB:c"]);delete b["VB:c"];}for(var a in b){if(!b.hasOwnProperty(a))continue;if(a=="N"&&!(typeof b[a]=='string')){if(jQuery.type(b[a])=='object'){var n;var l=c.GetTypeNode(b.N.name,true);this.m_datanodes[l.m_nArrayIndex]=(n=new VBI.DataProvider.DataNode());n.m_Parent=this;n.m_Name=b.N.name;n.load(b[a],l);}else if(jQuery.type(b[a])=='array'){var e=b[a];for(var f=0;f<e.length;++f){var n,g=e[f];var l=c.GetTypeNode(g.name,true);this.m_datanodes[l.m_nArrayIndex]=(n=new VBI.DataProvider.DataNode());n.m_Parent=this;n.m_Name=g.name;n.load(g,l);}}}else{var h=c.GetTypeAttribute(a,true);this.m_dataattributes[h.m_nArrayIndex]=new VBI.DataProvider.DataAttribute(h,b[a],this,m);}}},IsModified:function(a){if(this.m_nModified)return true;var n,l,t;for(n=0,l=this.m_dataattributes.length;n<l;++n){if((t=this.m_dataattributes[n])&&t.IsModified())return true;}for(n=0,l=this.m_datanodes.length;n<l;++n){if((t=this.m_datanodes[n])&&t.IsModified())return true;}return false;},IsChangeable:function(){return this.m_bChangeable;},IsSelected:function(k){var i,a=k?k:this.m_Parent.m_dtn.GetSelectTypeAttribute(false);if(a&&((i=a.m_nArrayIndex)<this.m_dataattributes.length)){var t;if(t=this.m_dataattributes[i])return(a.m_Type==VBI.Types.st_string)?VBI.Types.string2bool(t.m_Value):(t.m_Value?true:false);}return(this.m_Parent.m_dtn.m_MaxSelect==1&&this.m_Parent.GetLeadSelectedElement()==this)?true:false;},SetModified:function(){this.m_nModified|=1;var p=this;while(p.m_Parent)p=p.m_Parent;if(p)p.OnElementChanged(this);},store:function(a){var k=this.m_Parent.m_dtn.GetKeyTypeAttribute();var b=k.m_Alias?k.m_Alias:k.m_Name;a[b]=this.m_dataattributes[k.m_nArrayIndex].GetStringValue();if(this.m_nModified&2)a["VB:c"]=this.m_bChangeable?"true":"false";if(this.m_nModified&4)a["VB:m"]="true";var n,l,t;for(n=0,l=this.m_dataattributes.length;n<l;++n){if((t=this.m_dataattributes[n])&&t.IsModified()){var c=t.m_dta.m_Alias?t.m_dta.m_Alias:t.m_dta.m_Name;a[c]=t.GetStringValue();}}for(n=0,l=this.m_datanodes.length;n<l;++n){if((t=this.m_datanodes[n])&&t.IsModified()){t.store(a["N"]={});}}},GetKeyValue:function(){var k;if(this.m_Parent&&(k=this.m_Parent.m_dtn.GetKeyTypeAttribute()))return this.m_dataattributes[k.m_nArrayIndex].m_Value;return null;},GetPath:function(){var p=null;var c=this;while(c){var k=c.GetKeyValue();if(p)p=k+"."+p;else p=k;var n;if(n=this.m_Parent)p=this.m_Parent.m_dtn.m_Name+"."+p;else break;if(n.m_Parent&&n.m_Parent.m_Parent)c=n.m_Parent?n.m_Parent:null;else break;}return p;},SetElementSelectionState:function(s,t){var k=t;if(!k){k=t?t:this.m_Parent.m_dtn.GetTypeAttribute("VB:s",true);k.m_Type=VBI.Types.st_bool;}var i=k.m_nArrayIndex;if(this.m_dataattributes[i]==null)this.m_dataattributes[i]=new VBI.DataProvider.DataAttribute(k,null,this);var S,a=this.m_dataattributes[i];if(S=(a.m_Value!=(s?true:false))){a.m_Value=s?true:false;a.m_bModified=true;}if(S)this.SetModified();},GlobalSingleSelect:function(){var a=this.m_Parent.m_dtn;if(a.m_MaxSelect==0)return;this.m_Parent.SetSelection(false,false);var p=this;while(p.m_Parent)p=p.m_Parent;p.SetSelection(false,true);this.Select(true);},Select:function(s){var a=this.m_Parent.m_dtn;if(s){if(a.m_MaxSelect==0)return;if(a.m_MaxSelect<0){this.SetElementSelectionState(true);this.m_Parent.SetLeadSelection(this.GetKeyValue());return;}if(a.m_MaxSelect==1){this.m_Parent.SetLeadSelection(this.GetKeyValue());this.m_Parent.SetSelection(false,false);this.SetElementSelectionState(true);return;}}else{if((a.m_MinSelect==1)&&(this.m_Parent.GetNumOfSelectedElements()>1)){this.SetElementSelectionState(false);return;}if(a.m_MinSelect==0){this.SetElementSelectionState(false);return;}}},FindNodeFromPath:function(p){return d.FindFromPathEx(p,0,N,this,null);},FindAttributeFromPath:function(p){return d.FindFromPathEx(p,0,A,this,null);}};VBI.DataProvider.DataAttribute=function(a,v,p,m){this.m_dta=a;this.m_Parent=p;if(m)this.m_bModified=true;if(v===null)return;var b=VBI.Types;if(a.m_Type==b.st_vectorarray||a.m_Type==b.st_vector)this.m_Value=b.string2vector(v);else if(a.m_Type==b.st_long)this.m_Value=b.string2long(v);else if(a.m_Type==b.st_float)this.m_Value=b.string2float(v);else if(a.m_Type==b.st_bool)this.m_Value=b.string2bool(v);else if(a.m_Type==b.st_color)this.m_Value=b.string2color(v);else if(a.m_Type==b.st_string)this.m_Value=v;else this.m_Value=v;};VBI.DataProvider.DataAttribute.prototype={m_dta:null,m_Value:null,m_Parent:null,m_bModified:false,clear:function(){this.m_Parent=null;this.m_dta=null;},store:function(a){},set:function(v){if(v!=this.m_Value)this.SetModified();this.m_Value=v;},SetModified:function(){this.m_bModified=true;var p=this;while(p.m_Parent)p=p.m_Parent;if(p)p.OnAttributeChanged(this);},IsModified:function(){return this.m_bModified;},IsChangeable:function(){return(this.m_dta.m_bChangeable&&this.m_Parent.m_bChangeable);},GetStringValue:function(){var t="";switch(this.m_dta.m_Type){case VBI.Types.st_vectorarray:case VBI.Types.st_vector:return VBI.Types.vector2string(this.m_Value);case VBI.Types.st_long:t+=this.m_Value;return t;case VBI.Types.st_float:t+=this.m_Value;return t;case VBI.Types.st_string:return this.m_Value;case VBI.Types.st_bool:return this.m_Value?"true":"false";case VBI.Types.st_color:var c;if(c=/^rgba\(([\d]+),([\d]+),([\d]+),([\d]+|[\d]*.[\d]+)\)/.exec(this.m_Value)){c=[+c[1],+c[2],+c[3],parseInt(parseFloat(+c[4])*255.0)];return"RGBA("+c[0]+","+c[1]+","+c[2]+","+c[3]+")";}break;}return this.m_Value;},};return d;};
VBI.Adaptor=function(c){var C=c;this.RecursiveLoadElement=function(d,o,a){for(var n=0;n<a.m_datatypeattributes.length;++n){var b=a.m_datatypeattributes[n];var e=o[b.m_Name];if(e===undefined)continue;if((b.m_Type==VBI.Types.st_vector)&&jQuery.type(e)=="array")d[b.m_Alias]=""+e[0]+";"+e[1]+";0";else d[b.m_Alias]=e.toString();}if(a.m_datatypenodes.length){var f=d.N=[];for(var n=0;n<a.m_datatypenodes.length;++n){var g=f[n]={};var h=a.m_datatypenodes[n];var i=o[h.m_Name];if(i)this.RecursiveLoad(g,i,h);}}};this.RecursiveLoad=function(d,o,a){d.name=a.m_Name;d.E=[];if(jQuery.type(o)=='array'){for(var n=0;n<o.length;++n){var b=d.E[n]={};this.RecursiveLoadElement(b,o[n],a);}}else{var b=d.E[0]={};this.RecursiveLoadElement(b,o,a);}};this.LoadFindRefNode=function(d){var r=C.m_DataTypeProvider.FindTypeRefs();for(var n=0,l=r.length;n<l;++n){var s=d;var p=r[n].m_Ref.split(".");for(var a=0,b=p.length;a<b;++a){s=s[p[a]];if(s&&((a+1)==b)){r[n].m_Root=s;return r[n];}if(!s)break;}}return null;};this.CreateLoadData=function(d){if(!C.m_DataTypeProvider)return;var r=null;if(!(r=this.LoadFindRefNode(d)))return;var a=r.m_DTN;var b=r.m_Root;var v={SAPVB:{"version":"2.0","Data":{"Remove":{"type":"N","name":a.m_Name},"Set":{"type":"N","name":a.m_Name,"N":{}}}}};var o=b;var e=v.SAPVB.Data.Set.N;this.RecursiveLoad(e,o,a);return v;};};
VBI.ScenePointerEvents=function(s,e){s.m_Gesture=null;this.m_Events=["msgesturetap","msgesturehold","msgesturestart","msgestureend","msgesturechange","msgestureinertiastart","gesturetap","gesturehold","gesturestart","gestureend","gesturechange","gestureinertiastart","pointerdown","pointermove","pointerup","mspointerdown","mspointermove","mspointerup"];this.clear=function(){for(var n=0,a=this.m_Events.length;n<a;++n)e["on"+this.m_Events[n]]=null;};this.subscribe=function(){var a=this.m_Events;for(var n=0,b=a.length;n<b;++n){var h;if(a[n].slice(0,2)=="ms")h="process"+a[n].slice(2);else h="process"+a[n];if(!s[h])VBI.m_bTrace&&VBI.Trace("Error: Handler "+h+" not defined");e["on"+a[n]]=s[h];}};s.processgesturetap=function(a){VBI.m_bTrace&&VBI.Trace("scene.processgesturetap");return s.onsapclick(a);};s.processgesturehold=function(a){VBI.m_bTrace&&VBI.Trace("processgesturehold");s.DispatchEvent(a,"sapsecclick");a.preventDefault();};s.processgesturestart=function(a){VBI.m_bTrace&&VBI.Trace("processgesturestart");};s.processgestureend=function(a){VBI.m_bTrace&&VBI.Trace("processgestureend");if(s.m_Gesture)s.m_Gesture.target=null;s.m_Gesture=null;};s.processgesturechange=function(a){VBI.m_bTrace&&VBI.Trace("processgesturechange mode: "+s.m_nInputMode);if((s.m_nInputMode!=VBI.InputModeDefault)&&(s.m_nInputMode!=VBI.InputModeTrackMap)){s.DispatchEvent(a,"sapmove");return;}VBI.m_bTrace&&VBI.Trace("processgesturechange");VBI.m_bTrace&&VBI.Trace("rotation:"+a.rotation);VBI.m_bTrace&&VBI.Trace("scale:"+a.scale);VBI.m_bTrace&&VBI.Trace("trans:"+a.translationX+","+a.translationY);var g=a.gestureObject;var b=Math.round(g.tx)-g.txdone;var c=Math.round(g.ty)-g.tydone;var i=Math.round(a.translationX)+b;var d=Math.round(a.translationY)+c;g.tx+=a.translationX;g.ty+=a.translationY;g.txdone+=i;g.tydone+=d;VBI.m_bTrace&&VBI.Trace("done:"+g.txdone+","+g.tydone);VBI.m_bTrace&&VBI.Trace("calc:"+g.tx+","+g.ty);if(i||d){VBI.m_bTrace&&VBI.Trace("scene.processgesturechange move");s.MoveMap(i,d);}if(a.scale!=1.0)s.ZoomMap(a.scale,a.offsetX,a.offsetY);a.stopPropagation();a.preventDefault();return true;};s.processgestureinertiastart=function(a){VBI.m_bTrace&&VBI.Trace("processgestureinertiastart");a.preventDefault();};s.processpointerdown=function(a){VBI.m_bTrace&&VBI.Trace("scene.processpointerdown ");s.onsapdown(a);var g=s.m_Gesture;if(g&&(a.pointerType!=g.pointerType)){VBI.m_bTrace&&VBI.Trace("processpointerdown gesture pointer type mismatch");if(s.m_Gesture)s.m_Gesture.target=null;g=s.m_Gesture=null;}if(!g){VBI.m_bTrace&&VBI.Trace("processpointerdown create gesture");g=s.m_Gesture=new MSGesture();g.target=a.srcElement;g.pointerType=a.pointerType;g.tx=0;g.ty=0;g.txdone=0;g.tydone=0;}if(a.pointerType==g.pointerType)g.addPointer(a.pointerId);return;};s.processpointerup=function(a){VBI.m_bTrace&&VBI.Trace("processpointerup");return s.onsapup(a);};s.processpointermove=function(a){VBI.m_bTrace&&VBI.Trace("scene.processpointermove");s.m_currentMouseX=a.clientX;s.m_currentMouseY=a.clientY;s.onsapmove(a);return;};this.subscribe();};
VBI.SceneTouchEvents=function(s,a){this.m_Events=["touchstart","touchend","touchmove","touchcancel"];this.clear=function(){for(var n=0,b=this.m_Events.length;n<b;++n)a["on"+this.m_Events[n]]=null;};this.subscribe=function(){var b=this.m_Events;for(var n=0,c=b.length;n<c;++n){var h;if(b[n].slice(0,2)=="ms")h="process"+b[n].slice(2);else h="process"+b[n];if(!s[h])VBI.m_bTrace&&VBI.Trace("Error: Handler "+h+" not defined");a["on"+b[n]]=s[h];}};s.processtouchstart=function(e){var h=true;VBI.m_bTrace&&VBI.Trace("processtouchstart");if(s.m_TapTimer)window.clearInterval(s.m_TapTimer);if(s.DispatchEvent(e,"sapdown")==true)return;s.m_Touches.push(e);s.m_Touches.m_bMoveWasDone=false;if(e.touches.length==1&&!s.m_SuppressedNavigation.move){s.SetInputMode(VBI.InputModeTrackMap);var t=e.touches[0];s.m_currentMouseX=t.clientX;s.m_currentMouseY=t.clientY;VBI.m_bTrace&&VBI.Trace("processtouchstart"+"X:"+s.m_currentMouseX+"Y:"+s.m_currentMouseY);s.RestartContextMenuTimer(e,t,700);h=true;}else if(e.touches.length==2){s.SetInputMode(VBI.InputModeDefault);var b=e.touches[0];var c=e.touches[1];var d=(c.clientX+b.clientX)/2;var f=(c.clientY+b.clientY)/2;s.m_currentMouseX=d;s.m_currentMouseY=f;s.m_midPointX=d;s.m_midPointY=f;var g=Math.sqrt(Math.pow(b.clientX-c.clientX,2)+Math.pow(b.clientY-c.clientY,2));s.m_currentTouchDistance=g;VBI.m_bTrace&&VBI.Trace("processtouchstart"+"X1:"+b.clientX+"Y1:"+b.clientY+"X2:"+c.clientX+"Y2:"+c.clientY);h=true;}if(h){e.preventDefault();e.stopPropagation();return false;}};s.RestartContextMenuTimer=function(e,t,d){if(s.m_ContextMenuTimer)window.clearInterval(s.m_ContextMenuTimer);s.m_ContextMenuTimer=window.setInterval(function(){window.clearInterval(s.m_ContextMenuTimer);s.m_ContextMenuTimer=null;s.onPseudoRightClick(e,t);},d);};s.onPseudoRightClick=function(e,t){VBI.m_bTrace&&VBI.Trace("Pseudo Right Click");if(s.DispatchEvent(e,"sapsecclick")==true){s.m_Touches=[];return;}if(action=s.m_Ctx.m_Actions.findAction("ContextMenu",s,"Map")){s.m_Touches=[];var r=s.m_Div.getBoundingClientRect();s.m_Ctx.FireAction(action,s,"Map",null,{x:t.clientX-r.left,y:t.clientY-r.top,scene:s.m_ID});}};s.IsDoubleTap=function(e){if(e.length<4)return null;var i=e.length-4;var b=e.length-2;if(e[i].type=="touchstart"&&e[i].touches.length!=1)return null;if(e[b].type=="touchstart"&&e[b].touches.length!=1)return null;var d=e[i].touches[0].clientX-e[b].touches[0].clientX;var c=e[i].touches[0].clientY-e[b].touches[0].clientY;if((d*d+c*c)>1000)return null;var f=e.length-3;var g=e.length-1;var h=e[g].timeStamp-e[f].timeStamp;if(h>300)return null;return[e[b].touches[0].clientX,e[b].touches[0].clientY];};s.IsTwoFingerTap=function(e){if((e.length<2)||(e.m_bMoveWasDone))return null;var i=e.length-2;var b=e.length-1;if(e[i].type!="touchstart"||e[i].touches.length!=2)return null;var d=e[b].timeStamp-e[i].timeStamp;if(d>300)return null;var t=e[i].touches;return[(t[0].clientX+t[1].clientX)/2,(t[0].clientY+t[1].clientY)/2];};s.IsSingleTap=function(e){if(e.length!=2||(e.m_bMoveWasDone))return null;var i=e.length-2;var b=e.length-1;if(e[i].type!="touchstart"||e[i].touches.length!=1)return null;if(e[b].type!="touchend")return null;retVal=[e[i].touches[0].clientX,e[i].touches[0].clientY];retVal.timeTouchDown=e[b].timeStamp-e[i].timeStamp;return retVal;};s.processtouchend=function(e){if(!s.m_Touches.length){return;}if(e.m_delayedExamination){s.m_Touches.pop();}VBI.m_bTrace&&VBI.Trace("touchend");window.clearInterval(s.m_ContextMenuTimer);s.m_ContextMenuTimer=null;if(s.DispatchEvent(e,"sapup")==true){s.m_Touches=[];return;}var r=s.m_Div.getBoundingClientRect();if((r.width!=s.m_nDivWidth)||(r.height!=s.m_nDivHeight))s.resizeCanvas(0);s.m_Touches.push(e);var x;if(x=s.IsDoubleTap(s.m_Touches)){if(s.DispatchEvent(e,"sapdblclick")==true){s.m_Touches=[];e.stopPropagation();return;}s.AnimateZoom(true,x[0],x[1],12);s.m_Touches=[];}else if(x=s.IsTwoFingerTap(s.m_Touches)){s.AnimateZoom(false,x[0],x[1],33);s.m_Touches=[];}else{if(!(s.m_nInputMode==VBI.InputModeTrackMap))s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,s.m_Canvas[0].m_nExactLOD);}if(s.m_Touches.length>2)s.m_Touches.splice(0,s.m_Touches.length-2);s.SetInputMode(VBI.InputModeDefault);if(x=s.IsSingleTap(s.m_Touches)){if(x.timeTouchDown<300&&!e.m_delayedExamination){s.m_TapTimer=window.setInterval(function(){e.m_delayedExamination=true;s.processtouchend(e);window.clearInterval(s.m_TapTimer);},300);}else{if(s.DispatchEvent(e,"sapclick")){s.m_Touches=[];e.stopPropagation();return;}var b,c=s.m_Ctx.m_Actions;if(c){if(b=c.findAction("Click",s,"Map")){var d=s.m_Div.getBoundingClientRect();s.m_Ctx.FireAction(b,s,"Map",null,{x:x[0]-d.left,y:x[1]-d.top});}}s.m_Touches=[];}}e.stopPropagation();e.preventDefault();};s.processtouchcancel=function(e){VBI.m_bTrace&&VBI.Trace("touchcancel");if(s.DispatchEvent(e,"sapup")==true)return;s.SetInputMode(VBI.InputModeDefault);e.preventDefault();};s.processtouchmove=function(e){VBI.m_bTrace&&VBI.Trace("touchmove");if(!s.m_Touches.length||!s.m_currentMouseX){return;}var d,b,t;if(e.touches.length==1){t=e.touches[0];d=t.clientX-s.m_currentMouseX;b=t.clientY-s.m_currentMouseY;if((d==0)&&(b==0)){e.stopPropagation();return true;}}if(VBI.m_bIsAndroid&&(e.touches.length==2)){touch0=e.touches[0];c=e.touches[1];d=touch0.clientX+c.clientX-2*s.m_currentMouseX;b=touch0.clientY+c.clientY-2*s.m_currentMouseY;if((d==0)&&(b==0)){e.stopPropagation();return true;}}s.m_Touches.m_bMoveWasDone=true;window.clearInterval(s.m_ContextMenuTimer);s.m_ContextMenuTimer=null;var h=false;s.m_nTapCount=0;if(e.touches.length==1){if(s.m_nInputMode!=VBI.InputModeTrackMap)return;s.RestartContextMenuTimer(e,t,1100);VBI.m_bTrace&&VBI.Trace("ontouchmove "+"X1:"+t.pageX+"Y1:"+t.pageY);s.m_currentMouseX=t.clientX;s.m_currentMouseY=t.clientY;s.MoveMap(d,b);m_currentMouseX=t.clientX;m_currentMouseY=t.clientY;h=true;}else if(e.touches.length==2){if(!s.m_SuppressedNavigation.zoom){var r=s.m_Div.getBoundingClientRect();if((r.width!=s.m_nDivWidth)||(r.height!=s.m_nDivHeight))s.resizeCanvas(0);var c=e.touches[0];var f=e.touches[1];var g=c.clientX+(f.clientX-c.clientX)/2;var i=c.clientY+(f.clientY-c.clientY)/2;var j=s.m_Canvas[0].getBoundingClientRect();g-=j.left;i-=j.top;var k=Math.sqrt(Math.pow(c.clientX-f.clientX,2)+Math.pow(c.clientY-f.clientY,2));if(Math.abs(s.m_currentTouchDistance-k)>10){var z=(k>s.m_currentTouchDistance)?true:false;s.m_currentTouchDistance=k;VBI.m_bTrace&&VBI.Trace("ontouchmove "+" X1:"+c.pageX+" Y1:"+c.pageY+" X2:"+f.pageX+" Y2:"+f.pageY);s.ZoomMap(z?s.m_nLodFactorZoomIn:s.m_nLodFactorZoomOut,g,i,s.m_nTicksInALod);window.clearInterval(s.m_ReRenderTimer);s.m_ReRenderTimer=window.setInterval(function(){window.clearInterval(s.m_ReRenderTimer);s.m_ReRenderTimer=null;s.RenderAsync(true);},100);}h=true;}}if(h){e.stopPropagation();return true;}};s.SetInputModeTrackMap=function(S){if(S){}else{s.m_currentMouseX=0;s.m_currentMouseY=0;}};this.subscribe();};
VBI.SceneEvent=function(s,a){this.m_DeviceHandlers=[];this.m_Events=["mousedown","mouseup","mousemove","mousewheel","wheel","mouseout","click","dblclick","contextmenu","selectstart","dragstart","dragenter","dragover","dragleave","drop","dragend","keydown"];a.dropzone="true";if(sap.ui.Device.support.pointer&&navigator.msMaxTouchPoints)this.m_DeviceHandlers.push(new VBI.ScenePointerEvents(s,a));this.clear=function(){for(var n=0,b=this.m_DeviceHandlers.length;n<b;++n)this.m_DeviceHandlers[n].clear();this.m_DeviceHandlers=[];for(var n=0,b=this.m_Events.length;n<b;++n){var c="on"+this.m_Events[n];if(a[c])a[c]=null;}};this.subscribe=function(){var b=this.m_Events;for(var n=0,c=b.length;n<c;++n){var h;if(b[n].slice(0,2)=="ms")h="process"+b[n].slice(2);else h="process"+b[n];if(!s[h])VBI.m_bTrace&&VBI.Trace("Error: Handler "+h+" not defined");a["on"+b[n]]=s[h];}};if(sap.ui.Device.support.touch&&!(sap.ui.Device.support.pointer&&navigator.msMaxTouchPoints)){this.m_DeviceHandlers.push(new VBI.SceneTouchEvents(s,a));if(!sap.ui.Device.system.desktop)return;}s.SetInputModeTrackMap=function(S){if(S){document.addEventListener('mouseup',s.processmouseup,true);document.addEventListener('mousemove',s.processmousemove,true);}else{s.m_currentMouseX=0;s.m_currentMouseY=0;document.removeEventListener('mouseup',s.processmouseup,true);document.removeEventListener('mousemove',s.processmousemove,true);}};s.onsapdown=function(e){VBI.m_bTrace&&VBI.Trace("scene.onsapdown");s.m_currentMouseDownX=e.clientX;s.m_currentMouseDownY=e.clientY;s.m_currentMouseX=e.clientX;s.m_currentMouseY=e.clientY;if(s.DispatchEvent(e,"sapdown")==true)return true;};s.onsapup=function(e){VBI.m_bTrace&&VBI.Trace("scene.onsapup");if(s.DispatchEvent(e,"sapup")==true)return;s.SetInputMode(VBI.InputModeDefault);e.preventDefault();return false;};s.onsapclick=function(e){VBI.m_bTrace&&VBI.Trace("scene.onsapclick");var d=s.m_currentMouseDownX-e.clientX;var b=s.m_currentMouseDownY-e.clientY;if((d*d+b*b)<=5){VBI.m_bTrace&&VBI.Trace("process click dispatch");if(s.DispatchEvent(e,"sapclick")==true){VBI.m_bTrace&&VBI.Trace("process click handled in dispatch");return;}if(s.Click){var r=s.m_Canvas[s.m_nOverlayIndex].getBoundingClientRect();e.m_clientX=e.clientX-r.left;e.m_clientY=e.clientY-r.top;if(s.Click(e))return;}var c,f=s.m_Ctx.m_Actions;if(f){if(c=f.findAction("Click",s,"Map"))s.m_Ctx.FireAction(c,s,"Map",null,s.GetEventVPCoordsObj(e));e.preventDefault();}}};s.onsapmove=function(e){VBI.m_bTrace&&VBI.Trace("scene.onsapmove");if(s.DispatchEvent(e,"sapmove")==true)return true;var t;if(t=s.IsTransparent(e.clientX,e.clientY)){s.SetToolTip("");s.SetCursor('default');s.InternalSetHotItem(null,null);}s.SetCursor(t?'default':'pointer');return false;};s.processmousedown=function(e){VBI.m_bTrace&&VBI.Trace("scene.processmousedown");if(s.m_Gesture)return;if(s.onsapdown(e))return;if(!s.m_SuppressedNavigation.move&&(e.type.indexOf("pointer")<0)){VBI.m_bTrace&&VBI.Trace("set input mode track map");s.SetInputMode(VBI.InputModeTrackMap);s.m_Canvas[s.m_nOverlayIndex].focus();}};s.processkeydown=function(e){VBI.m_bTrace&&VBI.Trace("scene.processkeydown");var h=false,k=e.keyCode;if(s.DispatchEvent(e,"sapkeydown")==true)return;var r=s.m_Div.getBoundingClientRect();if((r.width!=s.m_nDivWidth)||(r.height!=s.m_nDivHeight))s.resizeCanvas(0);if(k==72){s.GoToInitialStart();h=true;}else if(k==90){new s.RectangularZoom();h=true;}else if(k==82){new s.RectSelection();h=true;}else{if(!s.m_SuppressedNavigation.zoom){var z=0;var c=s.GetCenterPos();var n=s.getCanvas().m_nExactLOD;if(k==187||k==107||k==171){z=1;}else if(k==189||k==109||k==173){z=-1;}if(z){var m=s.GetMinLOD();if((z>0)&&(n==m)&&(n!=Math.ceil(n)))n=Math.ceil(n);else n+=z;s.AnimateZoomToGeo(c,Math.round(n),40);h=true;}}if(!s.m_SuppressedNavigation.move){var d=20;switch(k){case 37:s.MoveMap(d,0);h=true;break;case 39:s.MoveMap(-d,0);h=true;break;case 38:s.MoveMap(0,d);h=true;break;case 40:s.MoveMap(0,-d);h=true;break;}}}if(h)e.preventDefault();return;};s.processcontextmenu=function(e){VBI.m_bTrace&&VBI.Trace("scene.processcontextmenu");if(s.DispatchEvent(e,"sapsecclick")==true)return;var b,c=s.m_Ctx.m_Actions;if(c){if(b=c.findAction("ContextMenu",s,"Map"))s.m_Ctx.FireAction(b,s,"Map",null,s.GetEventVPCoordsObjWithScene(e));e.preventDefault();}};s.processmouseout=function(e){VBI.m_bTrace&&VBI.Trace("scene.processmouseout");if(s.DispatchEvent(e,"sapout")==true)return;s.InternalSetHotItem(null,null);return false;};s.processdblclick=function(e){VBI.m_bTrace&&VBI.Trace("scene.processdblclick");if(s.DispatchEvent(e,"sapdblclick")==true)return;return;};s.processclick=function(e){VBI.m_bTrace&&VBI.Trace("scene.processclick");if(s.m_Gesture)return;return s.onsapclick(e);};s.processmouseup=function(e){VBI.m_bTrace&&VBI.Trace("scene.processmouseup");s.dragclear();return s.onsapup(e);};s.processmousemove=function(e){VBI.m_bTrace&&VBI.Trace("scene.processmousemove");if(s.m_DragInfo){if(s.m_DragInfo.bDragStart)return false;return;}var d=e.clientX-s.m_currentMouseX;var b=e.clientY-s.m_currentMouseY;s.m_currentMouseX=e.clientX;s.m_currentMouseY=e.clientY;if(s.m_Gesture)return;if(s.onsapmove(e))return;if(s.m_nInputMode==VBI.InputModeTrackMap){if(!(e.buttons==1||e.which==1)){s.SetInputMode(VBI.InputModeDefault);return false;}if(d||b){s.MoveMap(d,b);}return false;}e.preventDefault();};s.processmousewheel=function(e){VBI.m_bTrace&&VBI.Trace("processmousewheel");e.m_OffsetX=e.offsetX;e.m_OffsetY=e.offsetY;e.m_Delta=e.wheelDelta;s.processcommonwheel(e);return false;};s.processwheel=function(e){VBI.m_bTrace&&VBI.Trace("processwheel");var r=e.target.getBoundingClientRect();e.m_OffsetX=e.clientX-r.left;e.m_OffsetY=e.clientY-r.top;e.m_Delta=-e.deltaY;s.processcommonwheel(e);return false;};s.processcommonwheel=function(e){if(sap.ui.Device.os.macintosh){var t=Date.now();var m=((s.m_LastCWEvent!=undefined)&&(t-s.m_LastCWEvent<100));s.m_LastCWEvent=t;if(m)return;}VBI.m_bTrace&&VBI.Trace("processcommonwheel");if(s.DispatchEvent(e)==true)return;if(!s.m_SuppressedNavigation.zoom&&e.m_Delta){var r=s.m_Div.getBoundingClientRect();if((r.width!=s.m_nDivWidth)||(r.height!=s.m_nDivHeight))s.resizeCanvas(0);if(s.m_nZoomMode){var b=s.m_Canvas[0].getBoundingClientRect();s.AnimateZoom(e.m_Delta>0,e.m_OffsetX+b.left,e.m_OffsetY+b.top,100,e);}else{s.ZoomMap(e.m_Delta>0?s.m_nLodFactorZoomIn:s.m_nLodFactorZoomOut,e.m_OffsetX,e.m_OffsetY,s.m_nTicksInALod);}e.preventDefault();}return false;};s.dragclear=function(e){var i=document.getElementById(s.m_Target.id+"-transparentImg");if(i){s.m_Div.removeChild(i);}s.m_DragInfo=null;};s.processdragleave=function(e){if(s.m_DragInfo){}return;};s.processdragend=function(e){e.preventDefault();e.stopPropagation();s.dragclear();return true;};s.processselectstart=function(e){if(e.target.dragDrop&&s.m_DragInfo)e.target.dragDrop();e.preventDefault();return true;};s.processdragstart=function(e){if(s.m_DragInfo){if(s.m_DragInfo.strExtData)e.dataTransfer.setData('text',s.m_DragInfo.strExtData);else e.dataTransfer.setData('text',"");e.dataTransfer.effectAllowed='copy';s.m_DragInfo.bDragStart=true;if(e.dataTransfer.setDragImage){var t="iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";var i=VBI.Utilities.CreateDOMImageFromData(t,'/png',s.RenderAsync.bind());i.id=s.m_Target.id+"-transparentImg";s.m_Div.appendChild(i);e.dataTransfer.setDragImage(i,0,0);}return true;}return false;};s.processdragenter=function(e){if(!e.dataTransfer)return false;if(e.dataTransfer){try{e.dataTransfer.dropEffect='copy';}catch(b){VBI.m_bTrace&&VBI.Trace("Warning: scene.processdragenter exception occured: "+b.message);}}e.preventDefault();return true;};s.processdragover=function(e){if(!e.dataTransfer)return false;if(s.m_Gesture)return;if(s.m_DragInfo&&s.m_DragInfo.bDragStart){s.DispatchEvent(e,"sapdrag");}else e.preventDefault();return;};s.DesignCreateObject=function(d,p,f){var b=null;if(typeof d=='string')b=d;else b=JSON.stringify(d);if(b.indexOf("{POS}")>=0){if(p){var c=""+p[0]+";"+p[1]+";"+"0.0";var t=b.replace(/{POS}/g,c);f(t);}else{new s.DesignPositionArray(null,b,f,"{POS}",1);}}else if(b.indexOf("{POSARRAY}")>=0){new s.DesignPositionArray(p?[p[0],p[1],0.0]:null,b,f,"{POSARRAY}",null);}else{f(d);}return;};s.processdrop=function(e){if(!e.dataTransfer){s.dragclear();return false;}if(s.m_DragInfo&&s.m_DragInfo.bDragStart){s.DispatchEvent(e,"sapdrop");{e.preventDefault();e.stopPropagation();s.dragclear();return true;}}var d=e.dataTransfer.getData('text');var r=s.m_Canvas[0].getBoundingClientRect();var p=s.GetPosFromPoint([e.clientX-r.left,e.clientY-r.top,0.0]);var b=null,c=s.m_Ctx.m_Actions;if(c)b=s.m_Ctx.m_Actions.findAction("Drop",s,"Map");var f=null;if(b){f=function(g){var h=s.GetEventVPCoordsObj(e);h.content=g;s.m_Ctx.FireAction(b,s,"Map",null,h);};}else{f=s.m_Ctx.m_Control.load.bind(s.m_Ctx.m_Control);}s.DesignCreateObject(d,p,f);e.preventDefault();e.stopPropagation();s.dragclear();return true;};s.RectangularTracking=function(){this.m_PosStart=null;this.m_PosMove=null;this.m_bTrack=false;this.m_keycode=0;};s.RectangularTracking.prototype.onsapkeydown=function(e){if(e.keyCode==this.m_keycode){return(this.ExitRectMode(e));}};s.RectangularTracking.prototype.onsapdown=function(e){var r=s.m_Canvas[s.m_nOverlayIndex].getBoundingClientRect();this.m_PosStart=s.GetPosFromPoint([e.clientX-r.left,e.clientY-r.top,0]);this.m_bTrack=true;e.preventDefault();s.m_Canvas[s.m_nOverlayIndex].focus();return true;};s.RectangularTracking.prototype.onsapmove=function(e){if(this.m_bTrack){var r=s.m_Canvas[s.m_nOverlayIndex].getBoundingClientRect();this.m_PosMove=s.GetPosFromPoint([e.clientX-r.left,e.clientY-r.top,0]);}s.SetCursor('crosshair');s.RenderAsync(true);e.preventDefault();return true;};s.RectangularTracking.prototype.onsapout=function(e){};s.RectangularTracking.prototype.execute=function(e){};s.RectangularTracking.prototype.onsapup=function(e){if(!this.m_bTrack){return false;}if(this.m_PosStart&&this.m_PosMove){this.execute(e);}this.m_PosStart=null;this.m_PosMove=null;this.m_bTrack=false;s.RenderAsync(true);e.preventDefault();return true;};s.RectangularTracking.prototype.Hook=function(){s.SetInputMode(VBI.InputModeRectSelect);s.m_DesignVO=this;s.SetCursor('crosshair');s.RenderAsync(true);};s.RectangularTracking.prototype.UnHook=function(){if(s.m_nInputMode==VBI.InputModeRectSelect)s.SetInputMode(VBI.InputModeDefault);else VBI.Trace("Error: Wrong InputMode in UnHook: "+s.m_nInputMode);this.m_PosStart=null;this.m_PosMove=null;this.m_bTrack=false;s.m_DesignVO=null;s.RenderAsync(true);};s.RectangularTracking.prototype.ExitRectMode=function(e){this.UnHook();s.SetCursor('default');s.RenderAsync(true);e.preventDefault();return true;};s.RectangularZoom=function(){s.RectangularTracking.call(this);this.m_keycode=90;this.Hook();};s.RectangularZoom.prototype=Object.create(s.RectangularTracking.prototype);s.RectangularZoom.prototype.constructor=s.RectangularZoom;s.RectangularZoom.prototype.execute=function(e){var l=[];var b=[];l[0]=this.m_PosStart[0];l[1]=this.m_PosMove[0];b[0]=this.m_PosStart[1];b[1]=this.m_PosMove[1];s.ZoomToMultiplePositions(l,b,1.0);};s.RectangularZoom.prototype.Render=function(c,d){if(!this.m_bTrack){return false;}if(this.m_PosMove&&this.m_PosStart){var p=s.GetPointFromPos(this.m_PosStart,false);var b=s.GetPointFromPos(this.m_PosMove,false);var e=b.slice(0);var C=b[0]-p[0];var f=b[1]-p[1];var r=s.m_Div.getBoundingClientRect();var g=Math.abs(r.width/r.height);var h=Math.abs(C/f);var i=0;var w=0;if(h<g){w=b[0]-p[0];i=w/g;if(b[0]<p[0]&&b[1]>p[1]||b[0]>p[0]&&b[1]<p[1])e[1]=p[1]-i;else e[1]=p[1]+i;}else{i=b[1]-p[1];w=g*i;if(b[0]<p[0]&&b[1]>p[1]||b[0]>p[0]&&b[1]<p[1])e[0]=p[0]-w;else e[0]=p[0]+w;}VBI.Utilities.DrawTrackingRect(d,p[0],p[1],e[0],e[1]);var z=s.GetCurrentZoomFactors();e[0]*=z[0];e[1]*=z[1];this.m_PosMove=s.GetPosFromPoint([e[0],e[1]]);}};s.RectSelection=function(){s.RectangularTracking.call(this);this.m_keycode=82;this.Hook();};s.RectSelection.prototype=Object.create(s.RectangularTracking.prototype);s.RectSelection.prototype.constructor=s.RectSelection;s.RectSelection.prototype.execute=function(e){var p=s.GetPointFromPos(this.m_PosStart,false);var b=s.GetPointFromPos(this.m_PosMove,false);var c=[];var d=[];for(var n=0;n<=1;n++){if(p[n]<b[n]){c[n]=p[n];d[n]=b[n];}else{c[n]=b[n];d[n]=p[n];}}var z=s.GetCurrentZoomFactors();c[0]/=z[0];d[0]/=z[0];c[1]/=z[1];d[1]/=z[1];var f=[c[0],c[1],d[0],d[1]];var S,C;if((e.type.indexOf("touch")>=0)||(e.type.indexOf("pointer")>=0))S=C=false;else{C=e.ctrlKey;S=e.shiftKey;}var h=[[]];var H=false;for(var n=0,l=s.m_VOS.length;n<l;++n){if(!s.m_VOS[n].RectSelect)continue;h[n]=s.m_VOS[n].RectSelect(f);if(h[n].length)H=true;}if(H){for(var n=0,l=s.m_VOS.length;n<l;++n){var v=s.m_VOS[n];var g=v.m_DataSource;if(!S&&!C&&g){var i;if(i=g.GetCurrentNode(s.m_Ctx)){for(var j=0;j<=1;j++){for(var k=0,m=i.m_dataelements.length;k<m;++k){g.Select(k);var a;if(a=g.GetIndexedElement(s.m_Ctx,k)){if(v.IsSelected(s.m_Ctx)){if(VBI.IndexOf(h[n],k)==-1)a.Select(false);}else{if(VBI.IndexOf(h[n],k)!=-1)a.Select(true);}}}}}}else if(S){for(var k=0;k<h[n].length;k++){if(g){g.Select(h[n][k]);var a;if(a=g.GetIndexedElement(s.m_Ctx,h[n][k])){a.Select(true);}}}}else if(C){var o=[];for(var k=0;k<h[n].length;k++){if(g){g.Select(h[n][k]);var q={};if(v.IsSelected(s.m_Ctx))q.toSelect=false;else q.toSelect=true;q.idx=k;o.push(q);}}for(var r=0;r<=1;r++){for(var k=0;k<o.length;k++){if(g){g.Select(h[n][o[k]]);var a;if(a=v.m_DataSource.GetIndexedElement(s.m_Ctx,h[n][o[k].idx])){if(r==0&&o[k].toSelect)a.Select(true);if(r==1&&!o[k].toSelect)a.Select(false);}}}}}}var t;if(t=s.m_Ctx.m_Actions){var u;if(u=t.findAction("Select",s,"General")){s.m_Ctx.FireAction(u,s,"General",null,null);}}}};s.RectSelection.prototype.Render=function(c,d){if(!this.m_bTrack){return false;}if(this.m_PosMove&&this.m_PosStart){var p=s.GetPointFromPos(this.m_PosStart,false);var b=s.GetPointFromPos(this.m_PosMove,false);VBI.Utilities.DrawTrackingRect(d,p[0],p[1],b[0],b[1]);}};s.DesignTrack=function(o){this.m_Tcx=o;this.onsapkeydown=function(e){if(e.keyCode==27){this.UnHook(false);e.preventDefault();return true;}};this.onsapclick=function(e){VBI.m_bTrace&&VBI.Trace("Track sapclick");this.UnHook();return false;};this.onsapdown=function(e){VBI.m_bTrace&&VBI.Trace("Track sapdown");e.preventDefault();return true;};this.onsapmove=function(e){VBI.m_bTrace&&VBI.Trace("Track sapmove");var t=this.m_Tcx;t.m_ClientX=e.offsetX;t.m_ClientY=e.offsetY;if(t.m_CBDrag){VBI.m_bTrace&&VBI.Trace("Track sapmove: orig type "+e.type);t.m_CBDrag(t,e);}e.preventDefault();e.stopPropagation();return true;};this.onsapup=function(e){VBI.m_bTrace&&VBI.Trace("Track sapup");var t=this.m_Tcx;t.m_ClientX=e.offsetX;t.m_ClientY=e.offsetY;if(t.m_CBDrop)t.m_CBDrop(t,e);if(t.m_CBEnd)t.m_CBEnd(t,e);this.UnHook();e.preventDefault();e.stopPropagation();return true;};this.Hook=function(){s.SetInputMode(VBI.InputModeTrackObject);s.m_DesignVO=this;};this.UnHook=function(){if(s.m_DesignVO!=this)return;if(s.m_nInputMode==VBI.InputModeTrackObject)s.SetInputMode(VBI.InputModeDefault);else VBI.m_bTrace&&VBI.Trace("Error: Wrong InputMode in UnHook: "+s.m_nInputMode);s.m_DesignVO=null;this.m_Tcx=null;s.RenderAsync(true);};this.Render=function(c,d){return;};this.Hook();};s.DesignPositionArray=function(p,l,f,b,m){this.m_PosArray=p?p:[];this.m_PosMove=null;this.m_Func=f;this.m_PlaceHolder=b;s.SetCursor('crosshair');this.onsapkeydown=function(e){if(e.keyCode==27){this.UnHook(false);e.preventDefault();return true;}};this.onsapclick=function(e){VBI.m_bTrace&&VBI.Trace("this.onsapclick "+e.type);var r=s.m_Canvas[s.m_nOverlayIndex].getBoundingClientRect();var p=s.GetPosFromPoint([e.clientX-r.left,e.clientY-r.top,0]);var t=[p[0],p[1],0.0];var c=this.m_PosArray.length;var n=c/3;if((n>=1)&&(this.m_PosArray[c-3]==t[0])&&(this.m_PosArray[c-2]==t[1])&&(this.m_PosArray[c-1]==t[2]))return true;for(var d=0,g=t.length;d<g;++d)this.m_PosArray.push(t[d]);n=this.m_PosArray.length/3;s.RenderAsync(true);e.preventDefault();if(m&&n>=m)this.UnHook(true);return true;};this.onsapdown=function(e){e.preventDefault();return true;};this.onsapmove=function(e){VBI.m_bTrace&&VBI.Trace("this.onsapmove");VBI.m_bTrace&&VBI.Trace("Error: Wrong InputMode in onsapmove: "+s.m_nInputMode);var r=s.m_Canvas[0].getBoundingClientRect();this.m_PosMove=s.GetPosFromPoint([e.clientX-r.left,e.clientY-r.top,0]);s.RenderAsync(true);e.preventDefault();return true;};this.onsapdblclick=function(e){this.UnHook(true);return true;};this.Hook=function(){s.SetInputMode(VBI.InputModeTrackDesign);s.m_DesignVO=this;};this.UnHook=function(A){if(s.m_nInputMode==VBI.InputModeTrackDesign)s.SetInputMode(VBI.InputModeDefault);else VBI.m_bTrace&&VBI.Trace("Error: Wrong InputMode in UnHook: "+s.m_nInputMode);this.m_PosMove=null;var c=VBI.Types.vector2string(this.m_PosArray);var t=l.replace(new RegExp(this.m_PlaceHolder,'g'),c);s.m_DesignVO=null;s.RenderAsync(true);if(A&&this.m_Func)this.m_Func(t);};this.Render=function(c,d){var x,e=1.0;if(!this.m_PosArray.length)return;var S=false;var C=this.m_PosArray.concat(this.m_PosMove);var g=s.GetNearestPosArray(C);var h=s.GetPointArrayFromPosArray(g,false);d.strokeStyle="rgba( 255, 0, 20, 0.5 )";d.lineWidth=e;var i=e*e/2;d.beginPath();var t=[h[0],h[1]];d.moveTo(h[0],h[1]);for(var n=0;n<h.length/3;++n){x=[h[n*3],h[n*3+1],0.0];if(((tdx=(t[0]-x[0]))*tdx+(tdy=(t[1]-x[1]))*tdy)<i)continue;S=true;d.lineTo(x[0],x[1]);t=x;}if(S)d.stroke();};this.Hook();};this.subscribe();};
VBI.GeoLocation=function(){var g={};g.vbiclass="GeoLocation";g.m_coords={};g.m_bValid=false;g.m_coords.latiude=0;g.m_coords.longitude=0;g.m_coords.altitude=0;g.m_coords.accuracy=0;g.m_coords.altiudeAccuracy=0;g.m_coords.heading=0;g.m_coords.speed=0;g.m_timestamp=0;g.m_watch=null;g.OnError=function(m){VBI.m_bTrace&&VBI.Trace("GeoLocation.OnError: "+(typeof m=='string'?m:"unknown"));};g.OnPosition=function(p){g.m_coords.latiude=p.coords.latitude*Math.PI/180;g.m_coords.longitude=p.coords.longitude*Math.PI/180;g.m_coords.altitude=p.coords.altitude;g.m_coords.accuracy=p.coords.accuracy;g.m_coords.altiudeAccuracy=p.coords.altiudeAccuracy;g.m_coords.heading=p.coords.heading;g.m_coords.speed=p.coords.speed;g.m_timestamp=p.timestamp;g.m_bValid=true;g.OnPositionChanged(g);};g.StartWatch=function(){if(g.watch)return;if(!navigator)return;g.m_watch=navigator.geolocation.watchPosition(g.OnPosition,g.OnError);return;};g.StopWatch=function(){if(g.watch)navigator.geolocation.clearWatch(g.watch);g.watch=null;};g.GetWifiScan=function(l,a){var w=VBI.Utilities.CreateWifiObject();if(w)return w.ScanWifi("Scan "+a+","+l,0);return null;};g.OnPositionChanged=null;return g;};
VBI.MathLib=(function(){var m={};m.min_longitude=-Math.PI;m.max_longitude=Math.PI;m.min_latitude=(-85.05112878*2*Math.PI)/360.0;m.max_latitude=(85.05112878*2*Math.PI)/360.0;m.mercator_for_max_latitude=3.1415942;m.div_mercator_for_max_latitude=(0.5/m.mercator_for_max_latitude);m.div_max_longitude=(1.0/m.max_longitude);m.earthradius=6378137;m.stdWorldBorder=-180;m.CreateGUID=function(){var s=[];for(var n=0;n<8;++n)s[n]=(((Math.random()+1)*0x10000)|0).toString(16).substring(1);return(s[0]+s[1]+"-"+s[2]+"-"+s[3]+"-"+s[4]+"-"+s[5]+s[6]+s[7]);};m.DegToRad=function(l){var a=Math.PI/180.0;return[l[0]*a,l[1]*a];};m.RadToDeg=function(l){var a=180.0/Math.PI;return[l[0]*a,l[1]*a];};m.LonLatToUCS=function(l,u){var n=u[0];var a=u[1];var L=l[0];var f=l[1];if(f<m.min_latitude)f=m.min_latitude;else if(f>m.max_latitude)f=m.max_latitude;u[0]=L*m.div_max_longitude;u[0]=(u[0]+1.0)*n*0.5;var s=Math.sin(f);u[1]=(Math.log((1.0+s)/(1.0-s))*m.div_mercator_for_max_latitude);u[1]=0.5*a*(1.0-u[1]);return u;};m.UCSToLonLat=function(u,l){l[0]=u[0]*Math.PI;l[1]=Math.atan(m.sinh(-u[1]*m.mercator_for_max_latitude));return l;};m.sinh=function(v){var a=Math.pow(Math.E,v);var b=Math.pow(Math.E,-v);return(a-b)/2.0;};m.Distance=function(l,b){var R=m.earthradius;var e=l[1];var f=l[0];var g=b[1];var h=b[0];var L=g-e;var i=h-f;var a=Math.sin(L/2)*Math.sin(L/2)+Math.cos(e)*Math.cos(g)*Math.sin(i/2)*Math.sin(i/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var d=R*c;return d;};m.EquidistantLonLat=function(l,d,s){var r=[];s=s||64;var b,y,x;var a=d/m.earthradius;var c=l[0];var e=l[1];var f=Math.sin(a);var g=Math.cos(a);var h=Math.sin(e);var i=Math.cos(e);var j=c,k=c;var n=e,o=e;for(var p=0;p<s;++p){b=p*2*Math.PI/s;y=Math.asin(h*g+i*f*Math.cos(b));x=c+Math.atan2(Math.sin(b)*f*i,g-h*Math.sin(y));if(j>x)j=x;if(k<x)k=x;if(n>y)n=y;if(o<y)o=y;r.push([x,y]);}r.m_MinX=j;r.m_MaxX=k;r.m_MinY=n;r.m_MaxY=o;return r;};m.GetSurroundingBox=function(c,d,e,C){var f=100;var w=m.stdWorldBorder;if(d==undefined)d=360;var p=(c[0].length==2);var g=0,h=1,j=2,k=3;if(p){h=0;j=k=1;}var l=Number.MAX_VALUE,n=-Number.MAX_VALUE;var o,q,r,s;for(var i=0;i<c.length;++i){r=c[i];if(((o=r[g])<-180)||(o>180)){s=Math.floor((o+180)/360);o=(r[g]-=360*s);r[h]-=360*s;}if((q=r[h])<o){s=Math.ceil((o-q)/360);q=(r[h]+=360*s);}if(r[j]<l)l=r[j];if(r[k]>n)n=r[k];}c.sort(function(a,b){return a[0]-b[0]});var t=-1,u=-1;var v=-1,x=-1;var y,z;var A=c[0];var B,D=A[h],E=A[g];var F,G;for(var i=1;i<c.length;++i){A=c[i];E=A[g];B=A[h];if(E<D){if(B>D)D=B;}else{if((E-D)>t){y=D;t=E-D;v=i;}if((E-D)>u){F=Math.abs(((E-w+540)%360)-180);G=Math.abs(((D-w+540)%360)-180);if((F<f)||(G<f)){z=D;u=E-D;x=i;}}D=B;}}A=c[0];E=A[g];var H=E-D+360;if(H>u){F=Math.abs(((E-w+540)%360)-180);G=Math.abs(((D-w+540)%360)-180);if((F<f)||(G<f)){z=D;u=H;x=0;}}if(H>t){y=D;}else{if(v<0)return[w,w+360,l,n,false];A=c[v];}y-=360*Math.floor((y+180)/360);var I=Math.floor(e)+1;var J=(e==undefined)?0:360/Math.pow(2,I-e);var K=1000;if(d==0){d=J;if(C!=undefined)K=Math.floor(C(l,n));}var L=y-A[g]+360*(y<A[g]);var S=false;if(J&&(u>=0)){var M=Math.floor(I+Math.log(J/(360-t))/Math.LN2);var N=Math.floor(I+Math.log(J/(360-u))/Math.LN2);S=((M==N)||(K<=N));}if((L>d)||(K<=Math.floor(e))||S){if(!S)return[w,w+360,l,n,false];A=c[x];y=z-360*Math.floor((z+180)/360);}return[A[g],y,l,n];};return m;})();
VBI.QuadTree=function(m,b,r){var L=0,R=1,c=2,d=3,O=4;var q=function(e,f,m,b){var g=[];var i=[];return{quc:function(r,a){var t;for(var n=0,l=i.length;n<l;++n){t=i[n];if(t[0]>r[2]||t[2]<r[0]||t[1]>r[3]||t[3]<r[1])continue;a(t);}if(g.length){this.calcIntersectingNodes(r,a);}},qua:function(r,a){this.quc(r,function(h){a.push(h);});},calcIntersectingNodes:function(r,a){var l=e[0],t=e[1],w=(e[2]-l)/2.0,h=(e[3]-t)/2.0;if(r[0]<l+w){if(r[1]<t+h)g[L].quc(r,a);if(r[3]>=t+h)g[c].quc(r,a);}if(r[2]>=l+w){if(r[1]<t+h)g[R].quc(r,a);if(r[3]>=t+h)g[d].quc(r,a);}},calcQuadrant:function(r){var l,t,w=((e[2]-(l=e[0]))/2.0),h=((e[3]-(t=e[1]))/2.0);if(r[2]<l+w){if(r[3]<t+h)return L;if(r[1]>=t+h)return c;return O;}if(r[0]>=l+w){if(r[3]<t+h)return R;if(r[1]>=t+h)return d;return O;}return O;},subdivide:function(){var a=e[0];var h=e[1];var w=((e[2]-a)/2.0),j=((e[3]-h)/2.0);var k=++this.m_D;var l,t;g[L]=q([l=a,t=h,l+w,t+j],k,m,b);g[R]=q([l=a+w,t=h,l+w,t+j],k,m,b);g[c]=q([l=a,t=h+j,l+w,t+j],k,m,b);g[d]=q([l=a+w,t=h+j,l+w,t+j],k,m,b);var n=i;i=[];for(var o=0,p=n.length;o<p;++o)this.insert(n[o]);},insert:function(r){var a;if(g.length){if((a=this.calcQuadrant(r))==O){i.push(r);}else{g[a].insert(r);}}else{i.push(r);if(i.length>m&&this.m_D<b)this.subdivide();}},clear:function(){for(var n=0,l=g.length;n<l;++n)g[n].clear();i.length=0;g.length=0;},getNodes:function(){return g.length?g:null;},m_R:e,m_D:f};};return{insertArray:function(i){for(var n=0,l=i.length;n<l;++n)this.m_Root.insert(i[n]);},insert:function(r){this.m_Root.insert(r);},queryArray:function(r,a){return this.m_Root.qua(r,a);},queryCallback:function(r,a){return this.m_Root.quc(r,a);},clear:function(){this.m_Root.clear();},m_Root:(function(){return q(r,0,m,b);})(),};};
VBI.Tex=null;VBI.Shader=null;VBI.FB=null;VBI.Vals=null;VBI.Ro=null;VBI.Hm=null;VBI.Hook=function(){if(window.WebGLRenderingContext){var g=WebGLRenderingContext.prototype.getExtension;WebGLRenderingContext.prototype.getExtension=function(n){var v=['MS','WEBKIT','MOZ','O'];var e,a;if((e=g.call(this,n))===null){for(var b=0,l=v.length;b<l;++b){a=v[b];if((e=g.call(this,a+'_'+n))!==null)return e;}return null;}else{return e;}};WebGLRenderingContext.prototype.getExtensions=function(s){var a=this.getExtension('OES_texture_float');var h=this.getExtension('OES_texture_half_float');var b=this.getExtension('OES_texture_half_floatnLLinear');var c=this.getExtension('WEBGL_color_buffer_float');return;};}}();VBI.Shader=(function(){function S(g,v,f){this.m_GL=g;this.m_UL={};this.m_Prog=this.m_GL.createProgram();this.m_VS=this.m_GL.createShader(this.m_GL.VERTEX_SHADER);this.m_FS=this.m_GL.createShader(this.m_GL.FRAGMENT_SHADER);this.m_GL.attachShader(this.m_Prog,this.m_VS);this.Compile(this.m_VS,v);this.m_GL.attachShader(this.m_Prog,this.m_FS);this.Compile(this.m_FS,f);this.Link();};S.prototype.getShaderVar=function(n){return this.m_GL.getAttribLocation(this.m_Prog,n);};S.prototype.Compile=function(s,a){this.m_GL.shaderSource(s,a);this.m_GL.compileShader(s);if(!this.m_GL.getShaderParameter(s,this.m_GL.COMPILE_STATUS))VBI.m_bTrace&&VBI.Trace("Shader Compilation Error");};S.prototype.Link=function(){this.m_GL.linkProgram(this.m_Prog);if(!this.m_GL.getProgramParameter(this.m_Prog,this.m_GL.LINK_STATUS))VBI.m_bTrace&&VBI.Trace("Shader Link Error");};S.prototype.Apply=function(){this.m_GL.useProgram(this.m_Prog);return this;};S.prototype.getLoc=function(n){var l=this.m_UL[n];if(typeof(l)==="undefined")l=this.m_UL[n]=this.m_GL.getUniformLocation(this.m_Prog,n);return l;};S.prototype.SetInt=function(n,v){this.m_GL.uniform1i(this.getLoc(n),v);return this;};S.prototype.SetV2=function(n,v){this.m_GL.uniform2f(this.getLoc(n),v[0],v[1]);};return S;})();VBI.FB=(function(){function F(g){this.m_GL=g;this.m_FB=this.m_GL.createFramebuffer();}F.prototype.destroy=function(){return this.m_GL.deleteFramebuffer(this.m_FB);};F.prototype.BindFB=function(){this.m_GL.bindFramebuffer(this.m_GL.FRAMEBUFFER,this.m_FB);return this;};F.prototype.UnBindFB=function(){this.m_GL.bindFramebuffer(this.m_GL.FRAMEBUFFER,null);return this;};F.prototype.SetTex=function(t){this.m_GL.framebufferTexture2D(this.m_GL.FRAMEBUFFER,this.m_GL.COLOR_ATTACHMENT0,this.m_GL.TEXTURE_2D,t.m_Tex,0);return this;};return F;})();VBI.Tex=(function(){function T(g,p){var t;this.m_GL=g;p=p?p:{};this.m_colFmt=this.m_GL[((t=p.colfmt)!=null?t:'rgba').toUpperCase()];if(typeof p.type==='number')this.type=p.type;else this.type=this.m_GL[((t=p.type)!=null?t:'unsigned_byte').toUpperCase()];this.m_Tex=this.m_GL.createTexture();}T.prototype.destroy=function(){return this.m_GL.deleteTexture(this.m_Tex);};T.prototype.BindTex=function(s){if(s==null)s=0;this.m_GL.activeTexture(this.m_GL.TEXTURE0+s);this.m_GL.bindTexture(this.m_GL.TEXTURE_2D,this.m_Tex);return this;};T.prototype.AdjustSize=function(w,h){this.m_W=w;this.m_H=h;this.m_GL.texImage2D(this.m_GL.TEXTURE_2D,0,this.m_colFmt,w,h,0,this.m_colFmt,this.type,null);return this;};T.prototype.SetImage=function(d){this.m_W=d.width;this.m_H=d.height;this.m_GL.texImage2D(this.m_GL.TEXTURE_2D,0,this.m_colFmt,this.m_colFmt,this.type,d);return this;};T.prototype.SetFilterNearest=function(){this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_MAG_FILTER,this.m_GL.NEAREST);this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_MIN_FILTER,this.m_GL.NEAREST);return this;};T.prototype.SetWrapEdge=function(){this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_WRAP_S,this.m_GL.CLAMP_TO_EDGE);this.m_GL.texParameteri(this.m_GL.TEXTURE_2D,this.m_GL.TEXTURE_WRAP_T,this.m_GL.CLAMP_TO_EDGE);return this;};return T;})();VBI.Ro=(function(){function R(g,w,h){this.m_GL=g;this.m_W=w;this.m_H=h;this.m_GL.getExtensions();this.m_Tex=new VBI.Tex(this.m_GL,{type:36193});this.m_Tex.BindTex(0);this.m_Tex.AdjustSize(w,h);this.m_Tex.SetFilterNearest();this.m_Tex.SetWrapEdge();this.m_FB=new VBI.FB(this.m_GL);this.m_FB.BindFB();this.m_FB.SetTex(this.m_Tex);this.m_FB.UnBindFB();}R.prototype.Apply=function(){return this.m_FB.BindFB();};R.prototype.BindRo=function(s){return this.m_Tex.BindTex(s);};R.prototype.UnBindRo=function(){this.m_FB.UnBindFB();};R.prototype.AdjustSize=function(w,h){this.m_W=w;this.m_H=h;return this.m_Tex.BindTex(0).AdjustSize(w,h);};return R;})();VBI.Vals=(function(){function V(g,w,h){this.m_GL=g;this.m_nPointChunk=10240;this.m_vBufs=[];this.m_nVertexSize=8;this.m_W=w;this.m_H=h;this.m_Shader=new VBI.Shader(this.m_GL,"attribute vec4 pos, value;\nvarying vec2 off, dim;\nuniform vec2 size;\nvarying float val;\n void main(){ off = pos.zw; dim = abs(pos.zw); vec2 pos = pos.xy + pos.zw; val=value.x; gl_Position=vec4((pos/size)*2.0-1.0, 0.0, 1.0);}\n","#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp int;\n precision highp float;\n#else\n precision mediump int;\n precision mediump float;\n#endif\nvarying vec2 off, dim;\nvarying float val;\nvoid main(){ float f = (1.0-smoothstep(0.0,1.0,length(off/dim))); float tmp = f*val; gl_FragColor=vec4(tmp);}\n");this.m_Ro=new VBI.Ro(this.m_GL,this.m_W,this.m_H);this.m_VB=this.m_GL.createBuffer();this.m_vBuf=new Float32Array(this.m_nPointChunk*this.m_nVertexSize*6);for(var n=0,a=0,t=this.m_nPointChunk;0<=t?a<t:a>t;n=0<=t?++a:--a)this.m_vBufs.push(new Float32Array(this.m_vBuf.buffer,0,n*this.m_nVertexSize*6));this.m_nIdx=0;this.m_nPoints=0;};V.prototype.AdjustSize=function(w,h){this.m_W=w;this.m_H=h;this.m_Ro.AdjustSize(this.m_W,this.m_H);return;};V.prototype.Render=function(){if(this.m_nPoints>0){this.m_GL.enable(this.m_GL.BLEND);this.m_Ro.Apply();this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,this.m_VB);this.m_GL.bufferData(this.m_GL.ARRAY_BUFFER,this.m_vBufs[this.m_nPoints],this.m_GL.STREAM_DRAW);var s=this.m_Shader.getShaderVar('pos');var a=this.m_Shader.getShaderVar('value');this.m_GL.enableVertexAttribArray(1);this.m_GL.vertexAttribPointer(s,4,this.m_GL.FLOAT,false,32,0);this.m_GL.vertexAttribPointer(a,4,this.m_GL.FLOAT,false,32,16);this.m_Shader.Apply();this.m_Shader.SetV2('size',[this.m_W,this.m_H]);this.m_GL.drawArrays(this.m_GL.TRIANGLES,0,this.m_nPoints*6);this.m_GL.disableVertexAttribArray(1);this.m_Ro.UnBindRo();this.m_GL.disable(this.m_GL.BLEND);this.m_nPoints=0;this.m_nIdx=0;}};V.prototype.Clear=function(){this.m_Ro.Apply();this.m_GL.clearColor(0.0,0.0,0.0,0.0);this.m_GL.clear(this.m_GL.COLOR_BUFFER_BIT);return this.m_Ro.UnBindRo();};V.prototype.AddPoint=function(x,y,v,a){if((this.m_nPoints+1)>=this.m_nPointChunk)this.Render();y=this.m_H-y;var s=a/2;var b=this.PushVertex.bind(this);b(x,y,-s,-s,v);b(x,y,+s,-s,v);b(x,y,-s,+s,v);b(x,y,-s,+s,v);b(x,y,+s,-s,v);b(x,y,+s,+s,v);return this.m_nPoints+=1;};V.prototype.PushVertex=function(x,y,b,c,v){var a=this.m_vBuf;a[this.m_nIdx++]=x;a[this.m_nIdx++]=y;a[this.m_nIdx++]=b;a[this.m_nIdx++]=c;a[this.m_nIdx++]=a[this.m_nIdx++]=a[this.m_nIdx++]=a[this.m_nIdx++]=v;};return V;})();VBI.Hm=(function(){function H(a){var c;var b;var e,i,t;if(typeof(a.alphaBounds=='undefined'))a.alphaBounds=[0.0,1.0];if(typeof(a.alpha=='undefined'))a.alpha=true;this.m_Canv=a.canvas;this.m_W=a.width;this.m_H=a.height;if(!this.m_Canv)this.m_Canv=document.createElement("canvas");var A={depth:false,antialias:false,alpha:true};if(!this.m_GL)this.m_GL=this.m_Canv.getContext("experimental-webgl",A);if(!this.m_GL)this.m_GL=this.m_Canv.getContext("webgl",A);if(!this.m_GL){VBI.m_bTrace&&VBI.Trace("Error: WebGL not supported");return;}this.m_GL.blendFunc(this.m_GL.ONE,this.m_GL.ONE);this.m_GL.enableVertexAttribArray(0);if(a.colorTexture){this.m_ColorTexture=new VBI.Tex(this.m_GL,{colfmt:"rgba"});this.m_ColorTexture.BindTex(0);this.m_ColorTexture.SetFilterNearest();this.m_ColorTexture.SetWrapEdge();this.m_ColorTexture.AdjustSize(2,2);if(typeof(a.colorTexture)==="string"){i=new Image();i.onload=function(){this.m_ColorTexture.BindTex(0);this.m_ColorTexture.SetImage(i);}.bind(this);i.src=a.colorTexture;}b="uniform sampler2D colTex; vec3 calcCol( float g ){ return texture2D( colTex, vec2( g, 0.5 )).rgb; }\n";}else{b="vec3 calcCol( float g ){ return smoothstep( vec3( 0.0, 0.0, 1.0 ), vec3( 1.0, 1.0, 0.0 ), vec3( g ) ); }";}if(a.alpha)c=" vec4 calcAlpha(vec3 c,float i){ float a = smoothstep("+(a.alphaBounds[0].toFixed(8))+","+(a.alphaBounds[1].toFixed(8))+",i); return vec4( c*a, a); }\n";else c=" vec4 calcAlpha(vec3 c, float i){ return vec4(c,1.0);}\n";var f="#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp int;\n precision highp float;\n#else\n precision mediump int;\n precision mediump float;\n#endif\nuniform sampler2D src;\nvarying vec2 txy;\n";var d="\nvoid main(){ float f = smoothstep( 0.0, 1.0, texture2D(src, txy).b ); vec3 color = calcCol(f); gl_FragColor = calcAlpha( color, f ); }\n";this.m_Shader=new VBI.Shader(this.m_GL,"attribute vec4 pos; varying vec2 txy; void main(){ txy = pos.xy*0.5+0.5; gl_Position = pos; }",f+b+"\n"+c+d);if(this.m_W==null)this.m_W=this.m_Canv.offsetWidth||2;if(this.m_H==null)this.m_H=this.m_Canv.offsetHeight||2;this.m_Canv.width=this.m_W;this.m_Canv.height=this.m_H;var g=new Float32Array([-1,-1,0,1,1,-1,0,1,-1,1,0,1,-1,1,0,1,1,-1,0,1,1,1,0,1]);this.m_Geo=this.m_GL.createBuffer();this.m_GL.viewport(0,0,this.m_W,this.m_H);this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,this.m_Geo);this.m_GL.bufferData(this.m_GL.ARRAY_BUFFER,g,this.m_GL.STATIC_DRAW);this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,null);this.m_V=new VBI.Vals(this.m_GL,this.m_W,this.m_H);};H.prototype.AdjustSize=function(){if(!this.m_GL)return;var c=this.m_Canv.offsetHeight||2;var a=this.m_Canv.offsetWidth||2;if(this.m_W!==a||this.m_H!==c){this.m_GL.viewport(0,0,a,c);this.m_Canv.width=a;this.m_Canv.height=c;this.m_W=a;this.m_H=c;this.m_V.AdjustSize(this.m_W,this.m_H);}};H.prototype.RenderColors=function(){if(!this.m_GL)return;this.m_GL.bindBuffer(this.m_GL.ARRAY_BUFFER,this.m_Geo);this.m_GL.vertexAttribPointer(0,4,this.m_GL.FLOAT,false,0,0);this.m_V.m_Ro.BindRo(0);if(this.m_ColorTexture)this.m_ColorTexture.BindTex(1);this.m_Shader.Apply();this.m_Shader.SetInt("src",0);this.m_Shader.SetInt("colTex",1);return this.m_GL.drawArrays(this.m_GL.TRIANGLES,0,6);};H.prototype.RenderValues=function(){if(!this.m_GL)return;this.m_V&&this.m_V.Render();};H.prototype.Render=function(){this.RenderValues();this.RenderColors();};H.prototype.Clear=function(){return this.m_V?this.m_V.Clear():null;};H.prototype.AddPoint=function(x,y,v,s){return this.m_V?this.m_V.AddPoint(x,y,v,s):null;};return H;})();
VBI.CreateHM=function(p){return new VBI.Hm(p);};
VBI.MapLayerStackManager=function(){var m={};m.vbiclass="MapLayerStackManager";m.m_MapLayerStackArray=[];m.clear=function(){for(var n=0;n<m.m_MapLayerStackArray.length;++n)m.m_MapLayerStackArray[n].clear();m.m_MapLayerStackArray=[];};m.load=function(d,c){if(d.Set){m.clear();var a;if(jQuery.type(d.Set.MapLayerStack)=='object'){a=new VBI.MapLayerStack();a.load(d.Set.MapLayerStack,c);m.Add(a);}else if(jQuery.type(d.Set.MapLayerStack)=='array'){for(var n=0;n<d.Set.MapLayerStack.length;++n){a=new VBI.MapLayerStack();a.load(d.Set.MapLayerStack[n],c);m.Add(a);}}}};m.Add=function(a){this.m_MapLayerStackArray.push(a);};m.GetMapLayerStack=function(n){for(var i=0;i<this.m_MapLayerStackArray.length;++i){if(this.m_MapLayerStackArray[i].m_Name==n)return this.m_MapLayerStackArray[i];}return null;};return m;};
VBI.MapLayerStacks=VBI.MapLayerStackManager();
VBI.MapLayerStack=function(n,d){var m={};m.vbiclass="MapLayerStack";m.m_MapLayerArray=[];m.m_Name=n;m.m_Description=d;m.m_nMaxSquare=0;m.clear=function(){for(var a=0;a<m.m_MapLayerArray.length;++a)m.m_MapLayerArray[a].clear();m.m_MapLayerArray=[];};m.load=function(a,c){if(a.name)m.m_Name=a.name;if(a.description)m.m_Description=a.description;if(a.copyright)m.m_Copyright=a.copyright;if(a.copyrightLink)m.m_CopyrightLink=a.copyrightLink;if(a.copyrightImage)m.m_CopyrightImage=a.copyrightImage;if(a.maxSquare){m.m_nMaxSquare=a.maxSquare;}m.m_bSingleBMP=(a.singleBMP&&a.singleBMP=="true");var b;if(a.MapLayer){if(jQuery.type(a.MapLayer)=='object'){b=new VBI.MapLayer();b.load(a.MapLayer,c);m.Add(b);}else if(jQuery.type(a.MapLayer)=='array'){for(var e=0;e<a.MapLayer.length;++e){b=new VBI.MapLayer();b.load(a.MapLayer[e],c);m.Add(b);}}}};m.Add=function(a){this.m_MapLayerArray.push(a);};m.GetMaxLOD=function(){var a,b=0;var c=this.m_MapLayerArray;for(var i=0;i<c.length;++i){a=c[i].GetMaxLOD();if(a>b)b=a;}return b;};m.GetMinLOD=function(){var a,b=Number.MAX_VALUE;var c=this.m_MapLayerArray;for(var i=0;i<c.length;++i){a=c[i].GetMinLOD();if(a<b)b=a;}return b;};m.GetCopyright=function(){if(this.m_Copyright)return VBI.Utilities.AssembleCopyrightString(this.m_Copyright,this.m_CopyrightLink,this.m_CopyrightImage);var c=null;for(var a=0;a<this.m_MapLayerArray.length;a++){var b=this.m_MapLayerArray[a].GetMapProvider();if(!c)c=b.GetCopyright();else c=c+", "+b.GetCopyright();}return c;};return m;};
VBI.MapLayer=function(){var m={};m.vbiclass="MapLayer";m.m_Name=null;m.m_refMapProvider=null;m.m_fOpacity=1.0;m.m_colBkgnd=null;m.clear=function(){m.m_refMapProvider=null;};m.load=function(d,c){if(d.name)m.m_Name=d.name;if(d.opacity)m.m_fOpacity=d.opacity;if(d.colBkgnd)m.m_colBkgnd=d.colBkgnd;if(d.refMapProvider)if(c.m_MapProviders)m.m_refMapProvider=c.m_MapProviders.GetMapProviderByName(d.refMapProvider);if(!m.m_refMapProvider)VBI.m_bTrace&&VBI.Trace("Error: MapLayer: no valid mapprovider specified");};m.GetMinLOD=function(){if(m.m_refMapProvider)return m.m_refMapProvider.GetMinLOD();};m.GetMaxLOD=function(){if(m.m_refMapProvider)return m.m_refMapProvider.GetMaxLOD();};m.GetMapProvider=function(){if(m.m_refMapProvider)return m.m_refMapProvider;return null;};return m;};
VBI.MapManager=(function(){var m={};m.vbiclass="MapManager";m.m_nRequest=0;m.m_tileWidth=256;m.m_tileHeight=256;m.m_runningRequests=0;m.m_limitRequests=12;m.m_requestQueue=[];m.m_renderQueue=[];m.m_renderTimer=0;m.m_failedSendTimer=0;m.m_renderJunksize=100;m.onAbort=function(e){m.CheckReqQueue();var i=e.srcElement;VBI.m_bTrace&&VBI.Trace("onAbort "+i.src);m.UnlinkImage(i);m.CheckTmpCanvas(i.m_Target,i.m_nRequest,i.m_nLayersAbove);};m.onFailedSend=function(o){VBI.m_bTrace&&VBI.Trace("onFailedSend "+image.src);m.m_runningRequests--;m.m_bRequestError=true;if(!m.m_failedSendTimer)m.m_failedSendTimer=setInterval(function(){m.RetrySending();},750);};m.onError=function(e){m.CheckReqQueue();var i=e.srcElement;var a=null;VBI.m_bTrace&&VBI.Trace("onError "+i.src);if(i.m_Next!=null)i.m_Next.m_FillStyle=i.m_FillStyle;if(i.m_Prev==null&&i.m_Next!=null&&i.m_Next.complete==true)a=i.m_Next;m.UnlinkImage(i);if(a!=null){m.m_renderQueue.push(a);if(!m.m_renderTimer){m.m_renderTimer=setInterval(function(){m.RenderTiles();},1);}}else{m.CheckTmpCanvas(i.m_Target,i.m_nRequest,i.m_nLayersAbove);}};m.onLoad=function(e){m.CheckReqQueue();var i=e.srcElement||e.target;VBI.m_bTrace&&VBI.Trace("VBI.MapManager: onLoad  "+i.src);var c=true;for(var a=i.m_Prev;a!=null;a=a.m_Prev)c&=a.complete;for(var a=i.m_Next;a!=null;a=a.m_Next)c&=a.complete;if(!c){VBI.m_bTrace&&VBI.Trace("VBI.MapManager: onLoad skip as there is a a not yet loaded tile ");return;}m.m_renderQueue.push(i);if(!m.m_renderTimer){m.m_renderTimer=setInterval(function(){m.RenderTiles();},1);}};m.RetrySending=function(){clearInterval(m.m_failedSendTimer);m.m_failedSendTimer=0;m.m_bRequestError=false;m.m_runningRequests++;m.CheckReqQueue();};m.CheckReqQueue=function(){while((m.m_requestQueue.length)&&(!m.m_bRequestError)){var i=m.m_requestQueue.shift();var t=i.m_Target;if(i.m_nLOD!=t.m_nCurrentLOD||t.m_bInvalid){m.UnlinkImage(i);m.CheckTmpCanvas(t,i.m_nRequest,i.m_nLayersAbove);}else{try{i.src=i.src2execute;}catch(e){m.m_requestQueue.unshift(i);m.onFailedSend(i);}return;}}m.m_runningRequests--;};m.RenderTiles=function(){m.m_renderTimer=0;var n=Math.min(m.m_renderQueue.length,m.m_renderJunksize);for(var i=0;i<n;++i){m.RenderTile(m.m_renderQueue.shift());}if(!m.m_renderQueue.length)clearInterval(m.m_renderTimer);};m.RenderTile=function(i){var t=i.m_Target;if((t.m_CanvasRedirect!=undefined)&&(t.m_CanvasRedirRequest==i.m_nRequest))t=t.m_CanvasRedirect;var c=t.m_Scene;if(!c)return;var a=t.getPixelWidth();var b=t.getPixelHeight();t.m_nAppliedRequest=Math.max(t.m_nAppliedRequest,i.m_nRequest);var d=t.getContext('2d');var n=(1<<d.canvas.m_nCurrentLOD);var e=((i.m_nReqX-d.canvas.m_nCurrentX)%n+n)%n;if(n<c.m_nTilesX)e=i.m_nCol+i.m_nXOrigin-d.canvas.m_nCurrentX;var f=i.m_nReqY-d.canvas.m_nCurrentY;if(i.m_bOutdated||(e<0)||(f<0)||(e>=i.m_numCol)||(f>=i.m_numRow)||(i.m_nLOD!=t.m_nCurrentLOD||t.m_bInvalid)){m.UnlinkImage(i);VBI.m_bTrace&&VBI.Trace("VBI.MapManager: RenderTile  "+i.src+" is outdated");m.CheckTmpCanvas(t,i.m_nRequest,i.m_nLayersAbove);return;}VBI.m_bTrace&&VBI.Trace("VBI.MapManager: RenderTile  "+i.src);var g=c.m_nWidthCanvas;var h=c.m_nHeightCanvas;t.setPixelWidth(g);t.setPixelHeight(h);var j=g/c.m_nTilesX;var k=h/c.m_nTilesY;var l=e*j;var o=f*k;var p=i.m_nXExpansion*j;var q=i.m_nYExpansion*k;var r=i;while(r.m_Prev!=null)r=r.m_Prev;while(r!=null&&r.complete==true){r.onload=null;r.onabort=null;r.onerror=null;if(r.m_FillStyle!=null){VBI.m_bTrace&&VBI.Trace("RenderTile fillRect "+r.src);var s=d.fillStyle;d.fillStyle=r.m_FillStyle;d.fillRect(l,o,p,q);d.fillStyle=s;}VBI.m_bTrace&&VBI.Trace("RenderTile drawImage "+r.src);d.globalAlpha=r.m_Opacity;d.drawImage(r,l,o,p,q);if(r.m_Next!=null)r.m_Next.m_Prev=null;r=r.m_Next;}if(VBI.m_bTrace){var s=d.fillStyle;d.fillStyle="#FF0000";d.font="18px Arial";d.fillText(i.m_nRequest+"."+i.m_nCount+":"+i.m_nLOD+"/"+i.m_nReqX+"/"+i.m_nReqY+"@("+(l/256)+","+(o/256)+")",l+10,o+30);d.fillStyle=s;}t.setPixelWidth(a);t.setPixelHeight(b);if(t.onTileLoaded)t.onTileLoaded(i);d.globalAlpha=1.0;m.CheckTmpCanvas(t,i.m_nRequest,0);};m.CheckTmpCanvas=function(t,i,n){if((t.m_nTilesBefSwitch!=undefined)&&(t.m_nRequest==i)&&!n){t.m_nTilesBefSwitch--;if(!t.m_nTilesBefSwitch)t.m_Scene.SwitchTmpCanvasToActive();}};m.RequestTiles=function(t,a,x,y,n,b,l,c,r,d,f,g){m.m_bRequestError=false;if(f<0)return false;var h=t.m_Scene;if(!a||((h.AnimZoomTarget)&&(Math.abs(h.AnimZoomTarget-f)>h.m_nMaxAnimLodDiff))){t.m_nCurrentX=x;t.m_nCurrentY=y;t.m_nCurrentLOD=f;return false;}var j=0;var o=(1<<f);var p=h.m_Proj.m_nXYRatio;var q=o*p;var T=2.0/o;if(g){var u=t.getContext("2d");u.fillStyle='white';u.clearRect(0,0,u.canvas.width,u.canvas.height);}var v=a.m_MapLayerArray;t.m_nRequest=m.m_nRequest++;t.m_bInvalid=false;t.m_nCurrentX=x;t.m_nCurrentY=y;t.m_nCurrentLOD=f;var w,z,A,B=1;var C=y;if(a.m_bSingleBMP){z=1;C=Math.max(0,y);A=Math.min(b-c-d,o-C);}else{z=b-c-d;A=1;}var D=v.length;w=n-l-r;for(var i=0;i<w;++i){B--;if(!B){for(var k=0;k<z;++k){j++;var E=null;var F=null;var G=(x+l+i)%q;if(G<0)G=q+G;var H=C+c+k;if((H+A)<=0||H>=o){if((t.m_nTilesBefSwitch!=undefined)&&(t.m_nTilesBefSwitch>0))t.m_nTilesBefSwitch--;continue;}B=a.m_bSingleBMP?Math.min(q-G,w-i):1;for(var s=0;s<D;++s){var I=v[s];if(I.fillStyle)F=I.fillStyle;if((I.GetMinLOD()>f)||(I.GetMaxLOD()<f))continue;var J=new Image();J.m_nLayersAbove=D-s-1;J.m_nXOrigin=x;J.m_nYOrigin=y;J.m_nCol=i+l;J.m_nRow=k+c;J.m_numCol=n;J.m_numRow=b;J.m_Target=t;J.m_nRequest=t.m_nRequest;J.m_Opacity=I.m_fOpacity;J.m_bOutdated=false;J.m_Prev=E;if(E!=null)E.m_Next=J;if(J.m_Prev==null)J.m_FillStyle=F;J.m_nReqX=G;J.m_nReqY=H;J.m_nXExpansion=B;J.m_nYExpansion=A;J.m_nLOD=f;var K=I.GetMapProvider();var L;if(K.m_bPosRequired){var M=[G*T/p-1,H*T-1];var N=[(G+B)*T/p-1,(H+A)*T-1];L=K.CombineUrlWPos(G,H,f,T,M,N,B,A,m.m_requestTileWidth,m.m_requestTileHeight);}else{L=K.CombineUrl(G,H,f);}J.onload=m.onLoad;J.onabort=m.onAbort;J.onerror=m.onError;if((m.m_runningRequests<m.m_limitRequests)&&(!m.m_bRequestError)){m.m_runningRequests++;try{J.src=L;}catch(e){J.src2execute=L;m.m_requestQueue.push(J);m.onFailedSend(J);}}else{J.src2execute=L;m.m_requestQueue.push(J);}J.m_nCount=j;VBI.m_bTrace&&VBI.Trace("RequestTiles "+L);E=J;}}}}return true;};m.UnlinkImage=function(i){for(var a=i.m_Prev;a;a=a.m_Prev){a.m_bOutdated=true;}for(var a=i.m_Next;a;a=a.m_Next){a.m_bOutdated=true;}var c=i.m_Prev;var b=i.m_Next;if(c!=null){i.m_Prev.m_Next=b;i.m_Prev=null;}if(b!=null){i.m_Next.m_Prev=c;i.m_Next=null;}};return m;})();
VBI.MapProviders=function(){var m={};m.vbiclass="MapProviders";m.m_MapProviderArray=[];m.clear=function(){for(var n=0;n<m.m_MapProviderArray.length;++n)m.m_MapProviderArray[n].clear();m.m_MapProviderArray=[];};m.load=function(d,c){if(d.Set){var a;m.clear();if(d.Set.MapProvider){if(jQuery.type(d.Set.MapProvider)=='object'){a=new VBI.MapProvider();a.load(d.Set.MapProvider);m.Add(a);}else if(jQuery.type(d.Set.MapProvider)=='array'){for(var n=0;n<d.Set.MapProvider.length;++n){a=new VBI.MapProvider();a.load(d.Set.MapProvider[n]);m.Add(a);}}}}};m.Add=function(a){this.m_MapProviderArray.push(a);};m.GetMapProviderByName=function(n){for(var a=0;a<m.m_MapProviderArray.length;++a){if(m.m_MapProviderArray[a].m_Name==n)return m.m_MapProviderArray[a];}return null;};return m;};
VBI.MapProvider=function(n,d,c,t,a,m,b,f,r,p){var e={};e.vbiclass="MapProvider";e.m_SourceArray=[];e.m_Name=n;e.m_Description=d;e.m_Copyright=c;e.m_tileX=typeof t!=='undefined'?t:256;e.m_tileY=typeof a!=='undefined'?a:256;e.m_maxLOD=typeof b!=='undefined'?b:19;e.m_minLOD=typeof m!=='undefined'?m:0;e.m_nResolution=typeof r!='undefined'?r:256;e.m_nProjection=typeof p!='undefined'?p:1;if(f!=null)e.fillStyle=f;e.clear=function(){for(var g=0;g<e.m_SourceArray.length;++g)e.m_SourceArray[g].clear();e.m_SourceArray=[];};e.GetCopyright=function(){return VBI.Utilities.AssembleCopyrightString(this.m_Copyright,this.m_CopyrightLink,this.m_CopyrightImage);};e.addMapBase=function(l,g,h,i,j,s){var k={};if(l)k.left=parseFloat(l);if(g)k.right=parseFloat(g);if(h)k.top=parseFloat(h);if(i)k.bottom=parseFloat(i);k.round=(j!=undefined?parseFloat(j):0);k.xSize=g-l;k.ySize=h-i;if(s!=undefined){k.relXSize=k.xSize/s.xSize;k.relYSize=k.ySize/s.ySize;}return k;};e.addMapBaseBorder=function(g,h,i,j,k){g.leftBorder=h;g.rightBorder=i;g.bottomBorder=j;g.topBorder=k;};e.load=function(g){if(g.name)e.m_Name=g.name;if(g.description)e.m_Description=g.description;if(g.copyright)e.m_Copyright=g.copyright;if(g.copyrightLink)e.m_CopyrightLink=g.copyrightLink;if(g.copyrightImage)e.m_CopyrightImage=g.copyrightImage;if(g.tileX)e.m_tileX=g.tileX;if(g.tileY)e.m_tileY=g.tileY;if(g.maxLOD)e.m_maxLOD=g.maxLOD;if(g.minLOD)e.m_minLOD=g.minLOD;if(g.resolution)e.m_nResolution=g.resolution;if(g.projection){if(g.projection==="Linear")e.m_nProjection=2;}var h=g.MapBase;e.m_StdMapBase=e.addMapBase(-1,1,1,-1,10);if(g.MapBase){e.m_MapBase=e.addMapBase(h.left,h.right,h.top,h.bottom,h.round,e.m_StdMapBase);e.addMapBaseBorder(e.m_MapBase,h.minX,h.maxX,h.minY,h.maxY);}else{e.m_MapBase=e.addMapBase(-180,180,90,-90,10,e.m_StdMapBase);}if(g.Source){if(jQuery.type(g.Source)=='object'){var s=new VBI.Source(null);e.m_bPosRequired=s.load(g.Source);e.Add(s);}else if(jQuery.type(g.Source)=='array'){e.m_bPosRequired=false;for(var i=0;i<g.Source.length;++i){var s=new VBI.Source(null);e.m_bPosRequired=(s.load(g.Source[i])||e.m_bPosRequired);e.Add(s);}}}};e.Add=function(s){this.m_SourceArray.push(s);};e.CombineUrlWPos=function(x,y,l,T,g,h,i,j,k,o){var q=1<<l;var s=10;if(e.m_MapBase){var u=e.m_StdMapBase;var v=e.m_MapBase;g[0]=(g[0]-u.left)*v.relXSize+v.left;g[1]=-((g[1]-u.bottom)*v.relYSize+v.bottom);h[0]=(h[0]-u.left)*v.relXSize+v.left;h[1]=-((h[1]-u.bottom)*v.relYSize+v.bottom);s=v.round;}if(this.m_SourceArray.length==0)return null;return this.m_SourceArray[((y+x*q)%this.m_SourceArray.length)].CombineUrlWPos(x,y,l,T,g,h,i,j,s,Math.min(k,e.m_nResolution),Math.min(o,e.m_nResolution));};e.CombineUrl=function(x,y,l){var g=1<<l;if(x<0||y<0||(x>=g)||(y>=g))return null;if(this.m_SourceArray.length==0)return null;return this.m_SourceArray[((y+x*g)%this.m_SourceArray.length)].CombineUrl(x,y,l);};e.GetMaxLOD=function(){return this.m_maxLOD;};e.GetMinLOD=function(){return this.m_minLOD;};return e;};
VBI.Source=function(u){var s={};s.vbiclass="Source";s.m_ID=null;s.m_Url=u;s.clear=function(){};s.load=function(d){if(d.url)s.m_Url=d.url;if(d.id)s.m_ID=d.id;return((s.m_Url.indexOf("LU_LAT")>=0)||(s.m_Url.indexOf("LU_LONG")>=0)||(s.m_Url.indexOf("RL_LAT")>=0)||(s.m_Url.indexOf("RL_LONG")>=0));};s.CombineUrl=function(x,y,l){var t=s.m_Url;t=t.replace("{X}",x);t=t.replace("{Y}",y);t=t.replace("{LOD}",l);t=t.replace("{QUAD}",this.TileXYToQuadKey(x,y,l));t=t.replace("{NUMT}",this.TileXYToNumKey(x,y,l));return t;};s.CombineUrlWPos=function(x,y,l,t,a,r,b,c,n,d,e){var f=s.m_Url;var g=Math.pow(10,n);f=f.replace("{X}",x);f=f.replace("{Y}",y);f=f.replace("{LOD}",l);f=f.replace("{QUAD}",this.TileXYToQuadKey(x,y,l));f=f.replace("{NUMT}",this.TileXYToNumKey(x,y,l));f=f.replace("{WIDTH}",d*b);f=f.replace("{HEIGHT}",e*c);f=f.replace("{LU_LONG}",Math.round(a[0]*g)/g);f=f.replace("{LU_LAT}",Math.round(a[1]*g)/g);f=f.replace("{RL_LONG}",Math.round(r[0]*g)/g);f=f.replace("{RL_LAT}",Math.round(r[1]*g)/g);return f;};s.TileXYToQuadKey=function(x,y,l){var q=[];for(var i=l;i>0;--i){var d='0';var m=1<<(i-1);if(x&m)d++;if(y&m){d++;d++;}q.push(d);}var a=q.join("");return a;};s.TileXYToNumKey=function(x,y,l){var n=0;for(var i=1;i<l;++i){n+=(1<<i)*(1<<i);}n+=(y*(1<<l)+x+1);return n;};return s;};
VBI.NavigationControl=function(S){var n={};sap.ui.core.IconPool.insertFontFaceStyle();n.scene=null;n.suppressedVisibility=S;n.m_MinLOD=null;n.m_MaxLOD=null;n.m_lengthScrollLine=94-18;n.m_startScrollPoint=null;n.m_ID=null;n.zoomtimerfrq=33;n.zoomtimer;n.movetimer;n.bInitDrag=false;n.offsetX=0;n.offsetY=0;n.curMoveX=0;n.curMoveY=0;n.curZoomY=0;n.tint=20;n.midpointForZoom=[0,0];n.timer_mapnav=null;n.m_Div=n.m_Divmapnav=n.m_Divmapscrollarea=n.m_Divmapscrollpoint=n.m_Divmapcursorgrip=n.m_Divmapcursor=n.m_Divmapcursorreset=n.m_Divmapcursorleft=n.m_Divmapcursortop=n.m_Divmapcursorright=n.m_Divmapcursordown=n.m_DivmapmobileHome=n.m_DivmapmobileHomeIcon=n.m_DivmapmobileZoomin=n.m_DivmapmobileZoominIcon=n.m_DivmapmobileZoomout=n.m_DivmapmobileZoomoutIcon=null;n.clear=function(){if(n.timer_mapnav)window.clearInterval(n.timer_mapnav);n.DetachEvents();n.scene=null;n.m_Div=n.m_Divmapnav=n.m_Divmapscrollarea=n.m_Divmapscrollpoint=n.m_Divmapcursorgrip=n.m_Divmapcursor=n.m_Divmapcursorreset=n.m_Divmapcursorleft=n.m_Divmapcursortop=n.m_Divmapcursorright=n.m_Divmapcursordown=n.m_DivmapmobileHome=n.m_DivmapmobileHomeIcon=n.m_DivmapmobileZoomin=n.m_DivmapmobileZoominIcon=n.m_DivmapmobileZoomout=n.m_DivmapmobileZoomoutIcon=null;};n.getId=function(a,b){return b+'-'+a;};n.DetachEvents=function(){if(VBI.m_bIsMobile){jQuery(n.m_DivmapmobileHome).off();jQuery(n.m_DivmapmobileZoomin).off();jQuery(n.m_DivmapmobileZoomout).off();}else{jQuery(n.m_Divmapnav).off();jQuery(n.m_Divmapscrollpoint).off();jQuery(n.m_Divmapcursorgrip).off();jQuery(n.m_Divmapcursorleft).off();jQuery(n.m_Divmapcursorright).off();jQuery(n.m_Divmapcursortop).off();jQuery(n.m_Divmapcursordown).off();jQuery(n.m_Divmapcursorreset).off();document.removeEventListener('mouseup',n.zoom_processmouseup,true);document.removeEventListener('mousemove',n.zoom_processmousemove,true);}};n.AttachEvents=function(){if(VBI.m_bIsMobile)n.AttachTouchEvents();else n.AttachMouseEvents();};n.AttachTouchEvents=function(){jQuery(n.m_DivmapmobileHome).on("click",function(){VBI.m_bTrace&&VBI.Trace("Home Button : click");n.scene.GoToInitialStart();});jQuery(n.m_DivmapmobileHome).on("touchstart",function(){VBI.m_bTrace&&VBI.Trace("Home Button : touchstart");n.scene.GoToInitialStart();});jQuery(n.m_DivmapmobileHome).on("touchend",function(e){VBI.m_bTrace&&VBI.Trace("Home Button : touchend");e.preventDefault();});jQuery(n.m_DivmapmobileZoomin).on("touchstart",function(){VBI.m_bTrace&&VBI.Trace("ZoomIn Button : touchstart");n.StartAnimatedZoom(1);});jQuery(n.m_DivmapmobileZoomin).on("touchend",function(e){VBI.m_bTrace&&VBI.Trace("ZoomIn Button : touchend");if(n.zoomtimer){window.clearInterval(n.zoomtimer);n.ZoomToNextIntegerLOD(true);}e.preventDefault();});jQuery(n.m_DivmapmobileZoomin).on("touchleave",function(){VBI.m_bTrace&&VBI.Trace("ZoomIn Button : touchleave");if(n.zoomtimer){window.clearInterval(n.zoomtimer);n.ZoomToNextIntegerLOD(true);}});jQuery(n.m_DivmapmobileZoomout).on("touchstart",function(){VBI.m_bTrace&&VBI.Trace("ZoomOut Button : touchstart");n.StartAnimatedZoom(-1);});jQuery(n.m_DivmapmobileZoomout).on("touchend",function(e){VBI.m_bTrace&&VBI.Trace("ZoomOut Button : touchend");if(n.zoomtimer){window.clearInterval(n.zoomtimer);n.ZoomToNextIntegerLOD(false);}e.preventDefault();});jQuery(n.m_DivmapmobileZoomout).on("touchleave",function(){VBI.m_bTrace&&VBI.Trace("ZoomOut Button : touchleave");if(n.zoomtimer){window.clearInterval(n.zoomtimer);n.ZoomToNextIntegerLOD(false);}});};n.AttachMouseEvents=function(){var o=1.0;var t=50;n.timer_mapnav=null;var f=null;if(n.suppressedVisibility.fade){n.m_Divmapnav.style.opacity=1;}jQuery(n.m_Divmapnav).on("mouseenter",function(e){f=e.fromElement;});jQuery(n.m_Divmapnav).on("mouseup",function(){if(f)f.focus();});jQuery(n.m_Divmapnav).on("mouseleave",function(){if(!n.suppressedVisibility.fade){o=1.0;n.timer_mapnav=window.setInterval(function(){if(o<=0.5){window.clearInterval(n.timer_mapnav);}else{o-=0.01;n.m_Divmapnav.style.opacity=o;}},t);}});jQuery(n.m_Divmapnav).on("mouseenter",function(){window.clearInterval(n.timer_mapnav);n.m_Divmapnav.style.opacity=1;});if(!n.suppressedVisibility.zoom){if(n.suppressedVisibility.move)jQuery(n.m_Divmapscrollarea).css('top',10+'px');jQuery(n.m_Divmapscrollpoint).on("mousedown",function(e){if(e.which==1){n.midpointForZoom=n.scene.GetCenterPos();n.curZoomY=jQuery(n.m_Divmapscrollpoint).position().top;n.offsetY=e.pageY-n.curZoomY;document.addEventListener('mouseup',n.zoom_processmouseup,true);document.addEventListener('mousemove',n.zoom_processmousemove,true);}});jQuery(n.m_Divmapscrollpoint).on("dragstart",function(e){e.preventDefault();});}if(!n.suppressedVisibility.move){jQuery(n.m_Divmapcursorgrip).on("mouseenter",function(){jQuery(n.m_Divmapcursor).css("background-position","-5px 228px");}).on("mouseleave",function(){jQuery(n.m_Divmapcursor).css("background-position","-5px 305px");});var d=10;jQuery(n.m_Divmapcursorleft).on("mousedown",function(e){if(e.which==1){jQuery(this).css("background-position","-134px 194px");window.clearInterval(n.movetimer);n.movetimer=window.setInterval(function(){n.scene.MoveMap(d,0);},n.tint);}}).on("mouseup",function(e){window.clearInterval(n.movetimer);jQuery(this).css("background-position","-134px 211px");}).on("mouseout",function(e){if(n.bInitDrag==false){window.clearInterval(n.movetimer);jQuery(this).css("background-position","-134px 228px");}}).on("mousemove",function(e){if(n.bInitDrag==true)jQuery(this).css("background-position","-134px 177px");});jQuery(n.m_Divmapcursorright).on("mousedown",function(e){if(e.which==1){jQuery(this).css("background-position","-116px 194px");window.clearInterval(n.movetimer);n.movetimer=window.setInterval(function(){n.scene.MoveMap(-d,0);},n.tint);}}).on("mouseup",function(e){window.clearInterval(n.movetimer);jQuery(this).css("background-position","-116px 211px");}).on("mouseout",function(e){if(n.bInitDrag==false){window.clearInterval(n.movetimer);jQuery(this).css("background-position","-116px 228px");}}).on("mousemove",function(e){if(n.bInitDrag==true)jQuery(this).css("background-position","-116px 177px");});jQuery(n.m_Divmapcursortop).on("mousedown",function(e){if(e.which==1){jQuery(this).css("background-position","-82px 192px");window.clearInterval(n.movetimer);n.movetimer=window.setInterval(function(){n.scene.MoveMap(0,d);},n.tint);}}).on("mouseup",function(e){window.clearInterval(n.movetimer);jQuery(this).css("background-position","-82px 210px");}).on("mouseout",function(e){if(n.bInitDrag==false){window.clearInterval(n.movetimer);jQuery(this).css("background-position","-82px 228px");}}).on("mousemove",function(e){if(n.bInitDrag==true)jQuery(this).css("background-position","-82px 174px");});jQuery(n.m_Divmapcursordown).on("mousedown",function(e){if(e.which==1){jQuery(this).css("background-position","-99px 192px");window.clearInterval(n.movetimer);n.movetimer=window.setInterval(function(){n.scene.MoveMap(0,-d);},n.tint);}}).on("mouseup",function(e){window.clearInterval(n.movetimer);jQuery(this).css("background-position","-99px 210px");}).on("mouseout",function(e){if(n.bInitDrag==false){window.clearInterval(n.movetimer);jQuery(this).css("background-position","-99px 228px");}}).on("mousemove",function(e){if(n.bInitDrag==true)jQuery(this).css("background-position","-99px 174px");});jQuery(n.m_Divmapcursorreset).on("dragstart",function(e){e.preventDefault();});jQuery(n.m_Divmapcursorreset).on("mousedown",function(e){if(e.which==1){n.curMoveX=jQuery(n.m_Divmapcursorreset).position().left;n.curMoveY=jQuery(n.m_Divmapcursorreset).position().top;jQuery(n.m_Divmapcursorleft).css("background-position","-134px 177px");jQuery(n.m_Divmapcursorright).css("background-position","-116px 177px");jQuery(n.m_Divmapcursordown).css("background-position","-99px 174px");jQuery(n.m_Divmapcursortop).css("background-position","-82px 174px");jQuery(this).css("background-position","-222px 263px");n.offsetX=e.pageX-n.curMoveX;n.offsetY=e.pageY-n.curMoveY;window.clearInterval(n.movetimer);n.movetimer=0;n.bInitDrag=true;document.addEventListener('mouseup',n.processmouseup,true);document.addEventListener('mousemove',n.processmousemove,true);}});jQuery(n.m_Divmapcursorreset).css("position","");jQuery(n.m_Divmapcursorreset).on("dblclick",function(){n.scene.GoToInitialStart();});}};n.AppendButton=function(){n.m_Divmapnav=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-nav',n.m_ID),'vbi-nav');n.m_DivmapmobileHome=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-navmobile-home',n.m_ID),'vbi-navmobile-home');n.m_DivmapmobileHome.innerHTML="\ue070";n.m_Divmapnav.appendChild(n.m_DivmapmobileHome);if(!n.suppressedVisibility.zoom){n.m_DivmapmobileZoomin=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-navmobile-zoomin',n.m_ID),'vbi-navmobile-zoomin');n.m_DivmapmobileZoomin.innerHTML="+";n.m_Divmapnav.appendChild(n.m_DivmapmobileZoomin);n.m_DivmapmobileZoomout=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-navmobile-zoomout',n.m_ID),'vbi-navmobile-zoomout');n.m_DivmapmobileZoomout.innerHTML="-";n.m_Divmapnav.appendChild(n.m_DivmapmobileZoomout);}n.scene.m_Div.appendChild(n.m_Divmapnav);};n.AppendDiv=function(){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.vbm");var t=r.getText("NAVCTL_TITLE_MOVE_ARROWS");var T=r.getText("NAVCTL_TITLE_ZOOM",[0]);T=T.substr(0,T.search(/[0-9]/));n.m_Divmapnav=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-nav',n.m_ID),'vbi-nav');n.m_Divmapcursor=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-cursor',n.m_ID),'vbi-cursor');n.m_Divmapscrollarea=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-scrollarea',n.m_ID),'vbi-scrollarea');n.m_Divmapcursorgrip=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-cursor-grip',n.m_ID),'vbi-cursor-grip');var m=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-cursor-middle',n.m_ID),'vbi-cursor-middle');var a=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-scrolllineupperending',n.m_ID),'vbi-scrolllineupperending');var b=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-scrollline',n.m_ID),'vbi-scrollline');var c=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-scrolllinelowerending',n.m_ID),'vbi-scrolllinelowerending');n.m_Divmapscrollpoint=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-scrollpoint',n.m_ID),'vbi-scrollpoint',T);n.m_Divmapcursorleft=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-cursor-left',n.m_ID),'vbi-cursor-left',t);n.m_Divmapcursorright=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-cursor-right',n.m_ID),'vbi-cursor-right',t);n.m_Divmapcursortop=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-cursor-top',n.m_ID),'vbi-cursor-top',t);n.m_Divmapcursordown=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-cursor-down',n.m_ID),'vbi-cursor-down',t);n.m_Divmapcursorreset=VBI.Utilities.CreateGeoSceneDivCSS(n.getId('vbi-cursor-reset',n.m_ID),'vbi-cursor-reset',r.getText("NAVCTL_TITLE_MOVE"));m.appendChild(n.m_Divmapcursorleft);m.appendChild(n.m_Divmapcursorright);m.appendChild(n.m_Divmapcursortop);m.appendChild(n.m_Divmapcursordown);m.appendChild(n.m_Divmapcursorreset);n.m_Divmapcursorgrip.appendChild(m);n.m_Divmapscrollarea.appendChild(a);n.m_Divmapscrollarea.appendChild(b);n.m_Divmapscrollarea.appendChild(c);n.m_Divmapscrollarea.appendChild(n.m_Divmapscrollpoint);if(!n.suppressedVisibility.zoom){n.m_Divmapnav.appendChild(n.m_Divmapscrollarea);}if(!n.suppressedVisibility.move){n.m_Divmapnav.appendChild(n.m_Divmapcursor);n.m_Divmapnav.appendChild(n.m_Divmapcursorgrip);}n.scene.m_Div.appendChild(n.m_Divmapnav);};n.AdaptMinMaxLOD=function(s){n.m_MinLOD=n.scene.GetMinLOD();n.m_MaxLOD=n.scene.GetMaxLOD();};n.Awake=function(s,t){n.scene=s;n.m_MinLOD=n.scene.GetMinLOD();n.m_MaxLOD=n.scene.GetMaxLOD();var l=jQuery.sap.byId(t);n.m_ID=jQuery(l).attr('id');if(VBI.m_bIsMobile){n.AppendButton();}else{n.AppendDiv();n.m_Divmapnav.style.opacity=0.5;n.m_startScrollPoint=0;}n.AttachEvents();};n.AdjustScrollPoint=function(l){if(VBI.m_bIsMobile)return;if(l){var c=((n.m_lengthScrollLine*(l-n.m_MinLOD))/(n.m_MaxLOD-n.m_MinLOD))+n.m_startScrollPoint;jQuery(n.m_Divmapscrollpoint).css('top',c+'px');}else{var a=n.scene.GetCurrentZoomlevel();var c=((n.m_lengthScrollLine*(a-n.m_MinLOD))/(n.m_MaxLOD-n.m_MinLOD))+n.m_startScrollPoint;jQuery(n.m_Divmapscrollpoint).css('top',c+'px');}};n.StopAnimatedMove=function(){window.clearInterval(n.movetimer);n.movetimer=0;jQuery(n.m_Divmapcursorleft).removeAttr("style");jQuery(n.m_Divmapcursorright).removeAttr("style");jQuery(n.m_Divmapcursordown).removeAttr("style");jQuery(n.m_Divmapcursortop).removeAttr("style");jQuery(n.m_Divmapcursorreset).removeAttr("style");jQuery(n.m_Divmapcursorreset).css('top',n.curMoveX+'px');jQuery(n.m_Divmapcursorreset).css('left',n.curMoveY+'px');};n.ZoomToNextIntegerLOD=function(z){var l=n.scene.m_Canvas[0].m_nExactLOD;var a=z?Math.ceil(l):Math.floor(l);if(l!=a)n.scene.AnimateZoomToGeo(n.scene.GetCenterPos(),a,n.zoomtimerfrq);else n.scene.InternalOnZoomLayer(n.scene.m_Canvas[n.scene.m_nOverlayIndex]);};n.StartAnimatedZoom=function(z){var a=n.scene.GetCenterPos();if(n.zoomtimer)window.clearInterval(n.zoomtimer);n.zoomtimer=window.setInterval(function(){var b=n.scene.GetCurrentZoomlevel()+0.2*z;n.scene.ZoomToZoomlevel(a,b,true);},n.zoomtimerfrq);};n.processmouseup=function(){n.bInitDrag=false;n.StopAnimatedMove();document.removeEventListener('mouseup',n.processmouseup,true);document.removeEventListener('mousemove',n.processmousemove,true);};n.zoom_processmouseup=function(e){document.removeEventListener('mouseup',n.zoom_processmouseup,true);document.removeEventListener('mousemove',n.zoom_processmousemove,true);if(n.bInitDrag){var a=e.pageY-n.offsetY;if(a<0)a=0;if(a>n.m_lengthScrollLine)a=n.m_lengthScrollLine;var z=n.m_MinLOD+(((n.m_MaxLOD-n.m_MinLOD)*(a))/n.m_lengthScrollLine);n.scene.AnimateZoomToGeo(n.midpointForZoom,Math.round(z),40);}n.bInitDrag=false;};n.processmousemove=function(e){var s,a;if(n.bInitDrag==true){window.clearInterval(n.movetimer);n.movetimer=0;var b=e.pageX-n.offsetX;var c=e.pageY-n.offsetY;var d=parseInt(Math.sqrt(Math.pow(b-n.curMoveX,2)+Math.pow(c-n.curMoveY,2)));var m=17;if(d>m){var f=Math.atan2(b-n.curMoveX,c-n.curMoveY);s=Math.ceil((n.curMoveX+(Math.sin(f)*m)));a=Math.ceil((n.curMoveY+(Math.cos(f)*m)));d=m;}else{s=b;a=c;}jQuery(n.m_Divmapcursorreset).css('top',a+'px');jQuery(n.m_Divmapcursorreset).css('left',s+'px');var g=-(jQuery(n.m_Divmapcursorreset).position().left-n.curMoveX)*(d/m);var h=-(jQuery(n.m_Divmapcursorreset).position().top-n.curMoveY)*(d/m);n.movetimer=window.setInterval(function(){n.scene.MoveMap(g,h);},n.tint);}};n.zoom_processmousemove=function(e){var a=e.pageY-n.offsetY;if(!n.bInitDrag){if(a!=n.curZoomY)n.bInitDrag=true;}if(n.bInitDrag){if(a<0)a=0;if(a>n.m_lengthScrollLine)a=n.m_lengthScrollLine;jQuery(n.m_Divmapscrollpoint).css('top',a+'px');var z=n.m_MinLOD+(((n.m_MaxLOD-n.m_MinLOD)*(a))/n.m_lengthScrollLine);n.scene.ZoomToZoomlevel(n.midpointForZoom,z);}};return n;};
VBI.Parser=function(){var p={};p.formulas=[];p.fPos=0;p.fCode="";p.fAttributes=[];p.clear=function(){var t;while((t=p.formulas.shift())!=undefined)p.clearExpression(t.dTree);};p.evaluate=function(v,a,c){p.vo=v;p.voi=a;p.ctx=c;p.pos=undefined;var n=p.formulas.length;for(var i=0;i<n;++i){var f=p.formulas[i];if(p.evalF(f.dTree))return f.index;}return-1;};p.evalF=function(n){if((n.operator==false)||(n.operator==true))return n.operator;if(n.operator==600){var r=p.evalF(n.operand1);return r?p.evalF(n.operand2):false;}if(n.operator==700){var r=p.evalF(n.operand1);return r?true:p.evalF(n.operand2);}var o;var v=p.vo;switch(n.operand1){case"id":o=v.m_ID;break;case"image":o=v.m_Image.GetValueString(p.ctx);break;case"x":if(!p.pos)p.pos=p.vo.m_Pos.GetValueVector(p.ctx);o=p.pos[0];break;case"y":if(!p.pos)p.pos=p.vo.m_Pos.GetValueVector(p.ctx);o=p.pos[1];break;case"tooltip":o=v.m_Tooltip.GetValueString(p.ctx);break;default:var a=p.fAttributes[p.voi];o="";for(var j=0;j<a.length;++j)if(a[j].name==n.operand1){var d=v.m_DataSource.m_CurElement.m_dataattributes[a[j].index];if(d!=undefined)o=d.m_Value;}}switch(n.operator){case 50:return o==n.operand2;case 51:return o>=n.operand2;case 52:return o>n.operand2;case 55:return o!=n.operand2;case 56:return o<=n.operand2;case 57:return o<n.operand2;}};p.verifyAttribute=function(n,v,d){if(jQuery.type(n.operand2)=='object')p.verifyAttribute(n.operand2,v,d);if(jQuery.type(n.operand1)=='object')p.verifyAttribute(n.operand1,v,d);else{var e=n.operand1;if((e!="id")&&(e!="image")&&(e!="x")&&(e!="y")&&(e!="tooltip")){if(!p.fAttributes)p.buildAttributeTable(v);for(var i=0;i<d.m_datatypenodes.length;++i){var c=d.m_datatypenodes[i];var a=c.m_Name;var b=c.m_datatypeattributes;for(j=0;j<b.length;++j){var f=b[j];if(f.m_Name==e)for(var k=0;k<p.fAttributes.length;++k){var g=p.fAttributes[k];if(g.m_Name==a){var F=false;for(var l=0;l<g.length;++l)if(g[l].name==e)F=true;if(!F)g.push({name:e,index:j});}}}}}}};p.buildAttributeTable=function(v){p.fAttributes=[];for(i=0;i<v.length;++i){var P=[];P.m_Name=v[i].m_DataSource.m_NPath[0];p.fAttributes.push(P);}};p.verifyAttributes=function(v,c){p.fAttributes=undefined;dtp=c.m_DataTypeProvider;for(ii=0;ii<p.formulas.length;++ii)p.verifyAttribute(p.formulas[ii].dTree,v,dtp)};p.clearExpression=function(m){if(jQuery.type(m)!='object')return;p.clearExpression(m.operand1);p.clearExpression(m.operand2);m.operand1=m.operand2=undefined;};p.addFormula=function(a,m){p.formulas.push({index:a,formula:m,dTree:p.buildDecisionTree(m)});return p.formulas.length-1;};p.buildDecisionTree=function(m){p.fPos=0;p.fCode=m;var c={};if(!p.parseExpression(c)){VBI.Trace("Error: "+m+" could not be interpreted");c.operator=false;}return c;};p.parseExpression=function(n){var o=p.scan();if(o==-1)return(n.operator=true);if(o==10){n.operand1={};if(!p.parseExpression(n.operand1))return false;if(p.scan()!=20)return false;n.operator=p.scan();if(p.ttype!=2)return false;if(p.scan()!=10)return false;n.operand2={};if(!p.parseExpression(n.operand2))return false;if(p.scan()!=20)return false;return true;}if(o==500){n.operand1=p.token;n.operator=p.scan();if(p.ttype!=1)return false;p.scan();if(p.ttype!=10)return false;n.operand2=p.token;return true;}return false;};p.scan=function(){var l;var n=0;if(p.fPos>=p.fCode.length)return-1;var m=p.fCode.substr(p.fPos,1);switch(true){case m=="(":return p.getToken(m,10,0);case m==")":return p.getToken(m,20,0);case m=="=":return p.getToken(m,50,1);case m=="!":return p.fCode.substr(p.fPos+1,1)=="="?p.getToken("!=",55,1):false;case m=="<":n=5;case m==">":l=p.fCode.substr(p.fPos+1,1);if(l=="=")return p.getToken(m+l,51+n,1);if(m=="<"&&l==">")return p.getToken("!=",55,1);return p.getToken(m,52+n,1);case m=="|":n=100;case m=="&":l=p.fCode.substr(p.fPos+1,1);if(m!=l)l="";return p.getToken(m+l,600+n,2);case((m>="0")&&(m<="9")):return p.readNumber(m);case(((m>="a")&&(m<="z"))||((m>="A")&&(m<="Z"))):return p.readString(m);}};p.readNumber=function(f){var s=f;var i=1;var n=p.fCode.substr(p.fPos+i,1);while((n>="0")&&(n<="9")){s+=n;i++;n=p.fCode.substr(p.fPos+i,1);}return p.getToken(s,600,10);};p.readString=function(f){var s=f;var i=1;var n=p.fCode.substr(p.fPos+i,1);while((((n>="a")&&(n<="z"))||((n>="A")&&(n<="Z")))||((n>="0")&&(n<="9"))||(n=="_")||(n==".")||(n=="/")||(n=="\\")){s+=n;i++;n=p.fCode.substr(p.fPos+i,1);}return p.getToken(s,500,10);};p.getToken=function(s,a,t){p.fPos+=s.length;p.token=s;p.ttype=t;return a;};return p;};
VBI.LinearProjection=function(t){var p={};p.vbiclass="Projection/Linear";p.m_nXYRatio=2;p.m_nXMin=-2;p.m_nXMax=2;p.m_nGeometrySize=4;p.m_nUCSMin=-0.5;p.m_nUCSMax=1.5;p.m_bIsIsogonal=true;p.LonLatToUCS=function(l,u){var x=u[0];var y=u[1];u[0]=x*(0.5+l[0]/Math.PI);u[1]=y*(0.5-l[1]/Math.PI);return u;};p.UCSToLonLat=function(u,l){l[0]=Math.PI*(p.m_nUCSMin+u[0]/2);l[1]=-Math.PI*(u[1]/2);return l;};return p;};
VBI.MercatorProjection=function(t){var p={};p.vbiclass="Projection/Mercator";p.m_nXYRatio=1;p.m_nXMin=-1;p.m_nXMax=1;p.m_nGeometrySize=2;p.m_nUCSMin=0;p.m_nUCSMax=1;p.m_bIsIsogonal=true;p.LonLatToUCS=VBI.MathLib.LonLatToUCS;p.UCSToLonLat=VBI.MathLib.UCSToLonLat;return p;};
VBI.ResourceManager=(function(){var r={};r.m_DummyData="iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA61JREFUeNqsVG1LU2EYvs85bjomsr6YhFQsNagke6FQigoiSQOJ8FM/oT8R9CmoCD/2C4o+FxUFWmFFKNHS2rTMtbmjm3vx7O3Msz1d9/YcXcvhjB643OY5z329PPf9KER0HTgBuOn/rTAwBXxpwp/2W8PD3hsjI3tcmqaKdJpEofBPVXlfSdcpNzXV9+ndu6ZBId4wwdq11tZdjoUFtdjcTMIwKgRC7LC6IBZn+XykT09rQUW5IIR4wAQLvomJmd0+3ynF7SZhWUTr65VNitJ4cewrhUL0ESTP8a98d/fPrvHxM1yhq49o30OiWzgEp6Nqn9KoeI4BmAGeArOKIq7evPnV4fHEVfyOfSIKvSV6wy8V5IadLHimBOAH5oG9x4/ntLY2TzAYbGeCLGDcI3qVRn0TP0qSRDSongv8kgTrmiaOXrmSzmazpeXl5SwTcODpWbh4T/SBHRR3qH4VmAN+APtPnsw1ezxWLBYr6LoeUUWlW/JA8g7RE4PIzDfogp9lgBDwjYVBfe/QUBqriOJJkMyr8t2yC9hcgov361JZI+rjQIBbEfCePp1ztrVZ8Xi8gHgiqVQqoFa6bNPFXTRCCt+3OwtbfVBmLxwOceTy5bL6SCSSAsn3ZDK5qK6gpWpcRCaJJgtSYb2I+OVYVfYH+vuzTW53OXuoXwLBt0QiEVc3Z2XTxRjRsySaw6xyIOp0DmevOJ2lw4ODGaxy9ig8Dyf82CwT1LgwYDuCuXhbqHMW/FJUqufsuwYGcprLZUWjURPqw1AfAHg0xIYDJqlykbpP9CIhXZRqnNjZfwVUqO9F9qwexZOrq6vz+M6PeSupdZrD0Il0nm5TKhY12XPn/AR6zp7NksNRRPZ5zh4EfiBhb/mDoNbFbZwF3kzb1wcPIKadFiWBo6WldPjSpQzyttA5rH7ONM2wvHGongPbRRoHvfKaaMJ2YWe/of7cuQyr5+xxuJw9q49X98RfBDUu1jDdL7FjLS/V233vdLlKhy5ezBqGYSEaNE6C1YekDtrOQbWL5XGicS6uy4NlkoPnz2eEppXVI54Qdw7OIVk7OlsSVLnI8VzgLJ4ikgQX/wy0tLaWs7fVc/aY2r/Ub+eAIhUXaxiq4DTRo4C8OY8NDeU0p1PIvg/hzplDa6a2Gvy6BOyiQwgF45iHm6h3bOy14vX+6ujuzrN6RGKFw+E4YglAfXgr9byatrsxO0V5GFuGR0eLnT09j5H3AAq3+/1+E5+LfGPWU8/rtwADAFTqgB/beBQtAAAAAElFTkSuQmCC";return r;})();
VBI.Resources=function(){var r={};r.m_resourcedata=[];r.m_resourceinstance=[];r.clear=function(){r.m_resourcedata=[];r.m_resourceinstance=[];};r.load=function(d,c){if(d.Set){r.clear();var a=d.Set.Resource;if(jQuery.type(a)=='object'){r.m_resourcedata[a.name]=a.value;}else if(jQuery.type(a)=='array'){for(var n=0,l=a.length;n<l;++n)r.m_resourcedata[a[n].name]=a[n].value;}}};r.GetData=function(n){return r.m_resourcedata[n];};r.GetImageBits=function(n,a,b,l){var c,d=n;if(a)d+=a;if(b)d+=b;if(c=r.m_resourceinstance[n])if(c.m_Bits)return([c.m_Bits,c.m_Image.naturalWidth,c.m_Image.naturalHeight]);var i=r.GetImage(n,null,null,l);if(i){var e=VBI.Utilities.GetImagePixelData(i).data;r.m_resourceinstance[n].m_Bits=e;return([r.m_resourceinstance[n].m_Bits,i.naturalWidth,i.naturalHeight]);}return null;};r.GetImage=function(n,a,b,l){var c,d;var i="";if(n!=undefined){var e=n.lastIndexOf(".");if(e>=0)i="/"+n.substring(e+1);}var f=n;if(a)f+=a;if(b)f+=b;if(c=r.m_resourceinstance[f])if(c.m_Image)return c.m_Image;if(c){if(a||b)return(c.m_Image=VBI.Utilities.CreateDOMColorShiftedImageFromData(r.m_resourcedata[n],i,a,b,l));return(c.m_Image=VBI.Utilities.CreateDOMImageFromData(r.m_resourcedata[n],i,l));}else{var R=(d=r.m_resourcedata[n]);if(!R){VBI.m_bTrace&&VBI.Trace("resource not found; default image loaded");i='/png';d=VBI.ResourceManager.m_DummyData;}if(a||b){r.m_resourceinstance[f]={m_Image:VBI.Utilities.CreateDOMColorShiftedImageFromData(d,i,a,b,l)};return r.GetImage(n,null,null,l);}return(r.m_resourceinstance[f]={m_Image:VBI.Utilities.CreateDOMImageFromData(d,i,l)}).m_Image;}};return r;};
VBI.SupportedUnitsOfLength=[{RequestedUnit:"km",DisplayUnitDefault:"m",DisplayUnit2:"km",ConvFactor:1000.0,ConvFactorMeter:1.0},{RequestedUnit:"mi",DisplayUnitDefault:"ft",DisplayUnit2:"mi",ConvFactor:5280.0,ConvFactorMeter:0.3048},{RequestedUnit:"nm",DisplayUnitDefault:"ft",DisplayUnit2:"nm",ConvFactor:6076.12,ConvFactorMeter:0.3048}];
VBI.Scale=function(){var s={};s.scene=null;s.m_ID=null;s.m_Image=null;s.m_CurrentUnit=null;s.m_DisplayUnit=null;s.m_nDivider=0;s.m_nScalerLength=0;s.m_nDistance=0;s.m_bRtl=false;s.clear=function(){var i=document.getElementById(s.m_canvas.id);i.parentNode.removeChild(i);s.m_Image=null;s.scene=null;};s.Awake=function(a,t){s.scene=a;var l=jQuery.sap.byId(t);s.m_ID=$(l).attr('id');s.AppendCanvas();};s.getId=function(a,b){return b+'-'+a;};s.AppendCanvas=function(){s.m_bRtl=(document.dir=='rtl')?true:false;s.m_canvas=document.createElement('canvas');s.m_canvas.style.position="absolute";s.m_canvas.style.zIndex=5;s.m_canvas.id=s.getId('vbi-scale-canvas',s.m_ID);s.scene.m_Div.appendChild(s.m_canvas);if(s.m_bRtl)s.m_canvas.style.right="10px";else s.m_canvas.style.left="10px";s.m_canvas.style.bottom="10px";};s.getConfig=function(){if(s.m_CurrentUnit)return s.m_CurrentUnit;else{var c=s.scene.m_Ctx;var a,u;if(c)a=c.GetConfig();if(a)u=a.GetData("UnitOfLength");if(u){for(var n=0;n<VBI.SupportedUnitsOfLength.length;++n){if(VBI.SupportedUnitsOfLength[n].RequestedUnit==u){s.m_CurrentUnit=VBI.SupportedUnitsOfLength[n];break;}}}}if(!s.m_CurrentUnit)s.m_CurrentUnit=VBI.SupportedUnitsOfLength[0];return s.m_CurrentUnit;};s.getImage=function(l){if(s.m_Image)return s.m_Image;var i=new Image();if(l){i.onload=function(){if(typeof l==='function')l(i);this.onload=null;};}i.src=sap.ui.resource("sap.ui.vbm","themes/base/img/sapvisualbusiness.png");s.m_Image=i;return i;};s.CalcScaleDimensions=function(){var r=s.scene.m_Div.getBoundingClientRect();var c=s.getConfig();var p=[parseInt((r.left+(r.right-r.left))/2-75),parseInt((r.top+(r.bottom-r.top))/2)];var a=[p[0]+180,p[1]];var d=s.scene.GetDistance(p,a);var b;d=d*(1.0/c.ConvFactorMeter);if(d>=c.ConvFactor){b=parseInt(d/c.ConvFactor);s.m_DisplayUnit=c.DisplayUnit2;}else{b=d;s.m_DisplayUnit=c.DisplayUnitDefault;}var l=parseInt(Math.log(b)/Math.LN10);b=parseInt(b/Math.pow(10,l));if(b<2)b=1;else if(b<5)b=2;else if(b<10)b=5;b=parseInt(b*Math.pow(10,l));var e;if(d>=c.ConvFactor){e=b*c.ConvFactor;e=e*c.ConvFactorMeter;}else e=b*c.ConvFactorMeter;var f=[p[0]-s.scene.m_Canvas[0].getPixelLeft(),p[1]-s.scene.m_Canvas[0].getPixelTop()];var g=s.scene.GetTargetPointForDistance(e,p);var h=[g[0]+s.scene.m_Canvas[0].getPixelLeft(),g[1]+s.scene.m_Canvas[0].getPixelTop()];var t=b;var n=0;while(n==0&&t>0){n=t%5;t/=10;}if(n!=2)n=5;var i=Math.round(h[0]-p[0]);var j=parseInt(((a[0]-p[0])*e)/d);if(i>60&&i<(r.right-r.left)){s.m_nScalerLength=i;s.m_nDistance=b;s.m_nDivider=n;return true;}return false;};s.Update=function(){var r=[211,304,4,8];var a=[240,304,4,8];var b=[224,304,4,8];var c=[235,304,1,8];var d=[219,304,1,8];var e=document.getElementById(s.m_canvas.id).getContext('2d');e.clearRect(0,0,s.m_canvas.width,s.m_canvas.height);if(!s.CalcScaleDimensions())return;s.m_canvas.width=s.m_nScalerLength+10;s.m_canvas.height=30;var i=s.getImage(s.scene.RenderAsync.bind(s.scene));if(i){var l=0;var t=20;e.drawImage(i,r[0],r[1],r[2],r[3],l,t,r[2],r[3]);l+=r[2];var n=0;while(n<s.m_nDivider){for(var f=0;f<s.m_nScalerLength/s.m_nDivider;f++){if(n%2){e.drawImage(i,c[0],c[1],c[2],c[3],l,t,c[2],c[3]);l+=c[2];}else{e.drawImage(i,d[0],d[1],d[2],d[3],l,t,d[2],d[3]);l+=d[2];}}n++;}if(s.m_nDivider%2){e.drawImage(i,b[0],b[1],b[2],b[3],l,t,b[2],b[3]);l+=b[2];}else{e.drawImage(i,a[0],a[1],a[2],a[3],l,t,a[2],a[3]);l+=a[2];}var o=e.textAlign;var g=e.fillStyle;var h=e.font;e.font="12px arial";e.fillStyle="#FFFFFF";for(var f=0;f<2;++f){e.textAlign=s.m_bRtl?"end":"start";e.fillText("0",f,15+f);e.textAlign=s.m_bRtl?"start":"end";e.fillText(s.m_nDistance+s.m_DisplayUnit,s.m_canvas.width-1+f,15+f);e.fillStyle="#212C34";}e.textAlign=o;e.fillStyle=g;e.font=h;}};return s;};
VBI.InputModeDefault=0;VBI.InputModeTrackObject=1;VBI.InputModeTrackMap=2;VBI.InputModeTrackDesign=3;VBI.InputModeRectSelect=4;
VBI.SceneManager=function(){var s={};s.vbiclass="SceneManager";s.m_SceneArray=[];s.find=function(n){for(var a=0;a<s.m_SceneArray.length;++a)if(s.m_SceneArray[a].m_ID==n)return s.m_SceneArray[a];return null;};s.clear=function(){for(var n=0;n<s.m_SceneArray.length;++n)s.m_SceneArray[n].clear();s.m_SceneArray=[];};s.load=function(d,c){if(d.Set)s.loadScenes(d.Set,false,d,c);if(d.Merge)s.loadScenes(d.Merge,true,d,c);};s.loadScenes=function(a,i,d,c){if(jQuery.type(a)=='array'){for(var n=0;n<a.length;++n)s.loadScene(a[n],i,d,c);}else{s.loadScene(a,i,d,c);}};s.loadScene=function(m,i,d,c){var a;if(m.name){if(a=s.find(m.name)){if(!i)a.clear();if(m.SceneGeo)a.load(m.SceneGeo,c,i);else a.load(m.Scene,c,i);if(i)a.ReAwake();return;}}else{if(!i)s.clear();}if(m.SceneGeo)s.loadNewScene(m.SceneGeo,true,c);if(m.Scene)s.loadNewScene(m.Scene,false,c);};s.loadNewScene=function(a,i,c){if(jQuery.type(a)=='object'){var b=i?new VBI.GeoScene(null,null,null):new VBI.Scene(null,null,null);b.load(a,c);s.Add(b);}else{if(jQuery.type(a)=='array'){for(var n=0;n<a.length;++n){var b=i?new VBI.GeoScene(null,null,null):new VBI.Scene(null,null,null);b.load(a[n],c);s.Add(b);}}}};s.Add=function(a){s.m_SceneArray.push(a);};s.GetScene=function(t){for(var i=0;i<s.m_SceneArray.length;++i){if(s.m_SceneArray[i].m_TargetName==t)return s.m_SceneArray[i];}return null;};s.GetSceneByName=function(n){for(var i=0;i<s.m_SceneArray.length;++i){if(s.m_SceneArray[i].m_ID==n)return s.m_SceneArray[i];}return null;};return s;};
VBI.Scene=function(t){var s={};s.vbiclass="Scene";s.m_TargetName=t;s.m_EvtCont=new VBI.Events();s.m_ID="";s.m_Ctx=null;s.m_Div=null;s.m_Parent=null;s.m_CaptureVO=null;s.m_DesignVO=null;s.m_VOS=[];s.m_Events=null;s.m_Proj=null;s.m_LastDefinedCenterPos=s.m_LastZoomArea=undefined;s.m_HotItem={m_VO:null,m_Index:null,m_Design:null,m_HitObj:null};s.m_DragInfo=null;s.m_Target=t;s.LoadSingleVO=function(e,v,c,I){if(jQuery.type(e)=='object'){var a=v.Factory.CreateInstance(e.type);a.m_Scene=s;a.load(e,c);if(I){var n=a.m_ID;for(var i=s.m_VOS.length;i--;){if(s.m_VOS[i].m_ID==n){s.m_VOS[i]=a;return;}}}s.m_VOS.push(a);}};s.BaseLoad=function(d,c,i){if(!i){VBI.RegisterKeyboardHook();s.m_Ctx=c;if(d.id)s.m_ID=d.id;}if(d.VO){var v=new VBI.VisualObjects();if(jQuery.type(d.VO)=='array'){for(var n=0;n<d.VO.length;++n)s.LoadSingleVO(d.VO[n],v,c,i);}else{s.LoadSingleVO(d.VO,v,c,i);}}};s.BaseClear=function(){for(var n=0,a=s.m_VOS.length;n<a;++n)s.m_VOS[n].clear();s.m_VOS=[];s.m_Ctx=null;s.m_CaptureVO=null;s.m_DesignVO=null;if(s.m_Parent)s.m_Parent.m_refSceneInstance=null;s.m_HotItem=null;if(s.m_Events){s.m_Events.clear();s.m_Events=null;}VBI.UnRegisterKeyboardHook();};s.BaseGetVO=function(i){for(var n=0,a=s.m_VOS.length;n<a;++n)if(s.m_VOS[n].m_ID==i)return s.m_VOS[n];return null;};s.load=function(d,c,i){s.BaseLoad(d,c,i);};s.clear=function(){s.BaseClear();s.m_Div=null;};s.InternalSetHotItem=function(v,h){var a=s.m_HotItem;var m=false;var o=a.m_Index;var b=a.m_VO;if(h){if(a.m_Index!=h.m_Index){a.m_Index=h.m_Index;m=true;}if(a.m_Design!=h.m_Design){a.m_Design=h.m_Design;m=true;}if(a.m_Entity!=h.m_Entity){a.m_Entity=h.m_Entity;m=true;}}else{if(a.m_Entity||a.m_Detail){m=true;a.m_Entity=null;a.m_Detail=null;}}if(a.m_VO!=v){a.m_VO=v;m=true;}if(!m){var c;if(h&&(c=a.m_HitObj)){if(!jQuery.sap.equal(c,h,2))m=true;}else{if(h!=null||a.m_HitObj!=null)m=true;}}a.m_HitObj=h;if(m){if(b)b.InternalChangeHotItem(o,false);if(v)v.InternalChangeHotItem(a.m_Index,true);s.RenderAsync(false);}return m;};s.InternalRenderVisualObjects=function(c,a){var b=Date.now();var v=s.m_VOS;VBI.Utilities.BackupFont(a);for(var n=0;n<s.m_VOS.length;++n)v[n].Render(c,a);VBI.Utilities.RestoreFont(a);s.m_nLastRenderingTime=Date.now()-b;};s.Render=function(){};s.Awake=function(t){s.InternalRenderVisualObjects(null,s.m_Ctx);};s.NotifyDataChange=function(){for(var n=0;n<s.m_VOS.length;++n)s.m_VOS[n].NotifyDataChange(s.m_Ctx);s.m_PreassembledData=undefined;};s.GetPointArrayFromPosArray=function(p,a){return p;};s.GetPosFromPoint=function(p){return p;};s.GetPointFromPos=function(p,a){return s.GetPointArrayFromPosArray(p,a);};s.GetEventVPCoords=function(e){if(!e)return[0,0];var r=s.m_Div.getBoundingClientRect();return[e.clientX-r.left,e.clientY-r.top];};s.GetEventVPCoordsObj=function(e){var p=s.GetEventVPCoords(e);return{x:p[0].toString(),y:p[1].toString()};};s.GetEventVPCoordsObjWithScene=function(e){var p=s.GetEventVPCoords(e);return{x:p[0].toString(),y:p[1].toString(),scene:s.m_ID};};s.GetEventDropObjWithScene=function(e){return{strSource:s.m_DragInfo.strScene+"|"+s.m_DragInfo.strID+"|"+s.m_DragInfo.strInstance,scene:s.m_ID};};s.SetCapture=function(v){m_CaptureVO=v;};s.DispatchEvent=function(e,a){VBI.m_bTrace&&VBI.Trace("DispatchEvent "+e.type+" as "+a+" mode:"+s.m_nInputMode+(s.m_Gesture?" gesture active":""));if(s.m_nInputMode==VBI.InputModeTrackMap)return false;var f,b=e.type;if(a)e.m_evName=b=a;e.m_Scene=s;if(e.offsetX==undefined||e.offsetY==undefined){var r;if(e.clientX!==undefined&&e.clientY!==undefined){r=e.target.getBoundingClientRect();e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top;}else if(e.changedTouches!==undefined&&(e.changedTouches.length>0)){r=e.target.getBoundingClientRect();e.clientX=e.changedTouches[0].clientX;e.clientY=e.changedTouches[0].clientY;e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top;}}if(e.shiftKey==undefined)e.shiftKey=VBI.m_shiftKey;if(e.ctrlKey==undefined)e.ctrlKey=VBI.m_ctrlKey;var v=s.m_VOS;for(var n=0,l=v.length;n<l;++n){var L=v[n].getLabelData(false);for(var c=0;c<L.length;++c){var d=L[c];var g=VBI.Types.string2rgba(d.m_BgColor);if(g[3]<0.1&&g[4]==1)continue;var z=s.GetCurrentZoomFactors();var h=e.offsetX/z[0];var i=e.offsetY/z[1];for(var j=0;j<d.m_Pos.length;++j){for(var k=0;k<d.m_Pos[j].length;k++){var x=d.m_Pos[j][k][0];var y=d.m_Pos[j][k][1];var r=[x,y,x+d.m_Width,y+d.m_Height];var p=[h,i];if(VBI.Utilities.PtInRect(p,r))return true;}}}}if(s.m_DesignVO){VBI.m_bTrace&&VBI.Trace("DispatchEvent to Design VO");if((f=s.m_DesignVO["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_DesignVO))(e)==true)return true;}}if(s.m_CaptureVO){if((f=s.m_CaptureVO["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_CaptureVO))(e)==true)return true;}}var m;for(var c=0,l=s.m_VOS.length;c<l;++c){m=l-c-1;if((f=s.m_VOS[m]["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_VOS[m]))(e)==true)return true;}}return false;};return s;};
VBI.GeoScene=function(t,m,c){var s=new VBI.Scene(t);s.vbiclass="GeoScene";s.m_RefMapLayerStack="";s.m_DivCopyright=null;s.m_Canvas=[];s.m_cvObjImg=null;s.m_ZoomFactors=[1.0,1.0];s.m_MapManager=m;s.m_MapLayerStack=c;s.m_nMaxCanvasDimension=8192;if(VBI.m_bIsMobile)s.m_nMaxCanvasDimension=6144;s.Click=null;s.m_nOverlayIndex=2;s.m_nTapCount=0;s.GetHomeLocation=null;s.m_Touches=[];s.m_currentMouseX=0;s.m_currentMouseY=0;s.m_oldMouseX=0;s.m_oldMouseY=0;s.m_currentMouseDownX=0;s.m_currentTouchCount=0;s.m_currentMouseDownY=0;s.m_midPointX=0;s.m_midPointY=0;s.m_currentTouchDistance=0;s.m_nInputMode=VBI.InputModeDefault;s.m_BlendTimer=null;s.m_AnimZoomTimer=null;s.m_startPointLonLat=[0.0,0.0];s.m_startLOD=0;s.m_bNavControlVisible=true;s.m_NavControl=null;s.m_RenderTimer=null;s.m_SuppressedNavigation={zoom:false,move:false};s.m_bScaleVisible=true;s.m_Scale=null;s.m_OverlayImage=null;s.m_nCanvasXOversize=2.2;s.m_nCanvasYOversize=2.2;s.m_nCanvasStdXPos=s.m_nCanvasXOversize/4;s.m_nCanvasStdYPos=s.m_nCanvasYOversize/4;s.m_nTicksInALod=5;s.m_nLodFactorZoomIn=Math.pow(2,1/s.m_nTicksInALod);s.m_nLodFactorZoomOut=1/s.m_nLodFactorZoomIn;s.m_nLodFactorZoomInHalf=Math.pow(2,1/(2*s.m_nTicksInALod));s.m_nLodFactorZoomOutHalf=1/s.m_nLodFactorZoomInHalf;s.m_nMaxAnimLodDiff=3;s.m_nZoomMode=1;s.m_nLastRenderingTime=0;s.m_nRenderTimeTarget=250;s.m_nNumOfScalingVOInst=0;s.m_nLastClusteringTime=0;s.onTileLoaded=null;s.clear=function(){s.BaseClear();s.m_Touches=[];if(s.m_NavControl){s.m_NavControl.clear();s.m_NavControl=null;}if(s.m_Scale){s.m_Scale.clear();s.m_Scale=null;}s.clearTimers();s.clearCanvases();s.SetInputMode(VBI.InputModeDefault);s.Remove();s.m_RefMapLayerStack="";s.m_MapManager=null;s.m_MapLayerStack=null;s.m_TargetName=null;s.m_OverlayImage=null;s.m_Proj=null;s.m_DivCopyright=null;s.m_Target=null;};s.loadSingleRemoveOnScene=function(r,a){if(jQuery.type(r)=='object'){switch(r.type){case"VO":var i=r.id;for(var j=s.m_VOS.length;j--;){if(s.m_VOS[j].m_ID==i){s.m_VOS.splice(j,1);return;}}break;};}};s.loadRemoveOnScene=function(r,a){if(jQuery.type(r)=='array')for(j=0;j<r.length;++j)s.loadSingleRemoveOnScene(r[j],a);else s.loadSingleRemoveOnScene(r,a);};s.load=function(d,a,i){if(i&&d.Remove)s.loadRemoveOnScene(d.Remove,a);s.BaseLoad(d,a,i);if(d.refMapLayerStack)s.m_RefMapLayerStack=a.m_MapLayerStackManager.GetMapLayerStack(d.refMapLayerStack);else VBI.m_bTrace&&VBI.Trace("no map layer specified in geo scene");if(i)return;var b=-1000,e=1000;var f=-90,g=90;s.m_nMinLodVisualBorder=0;s.m_nMaxLodVisualBorder=99;s.m_nOffsetMinLod=0;s.m_bYBorderExists=false;if(d.VisualFrame){if(d.VisualFrame.minX!=undefined)b=d.VisualFrame.minX;if(d.VisualFrame.maxX!=undefined)e=d.VisualFrame.maxX;if(d.VisualFrame.minY!=undefined)f=d.VisualFrame.minY;if(d.VisualFrame.maxY!=undefined)g=d.VisualFrame.maxY;if(d.VisualFrame.minY!=undefined||d.VisualFrame.maxY!=undefined)s.m_bYBorderExist=true;if(d.VisualFrame.minLOD!=undefined)s.m_nMinLodVisualBorder=d.VisualFrame.minLOD;if(d.VisualFrame.maxLOD!=undefined)s.m_nMaxLodVisualBorder=d.VisualFrame.maxLOD;if(d.VisualFrame.offsetMinLOD!=undefined)s.m_nOffsetMinLod=d.VisualFrame.offsetMinLOD;}s.m_bXBorderExists=(b!=-1000)||(e!=1000);s.m_nBorderMinPoint=VBI.MathLib.DegToRad([b,g]);s.m_nBorderMaxPoint=VBI.MathLib.DegToRad([e,f]);s.m_Proj=s.setProjection();var u=[1.0,1.0],h=[1.0,1.0];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,u);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,h);s.m_nXSizeVisualBorder=Math.max(0.0,Math.min(1.0,h[0]-u[0]));s.m_nYSizeVisualBorder=Math.max(0.0,Math.min(1.0,h[1]-u[1]));if(d.initialStartPosition){var k=d.initialStartPosition.split(';');s.m_startPointLonLat=VBI.MathLib.DegToRad([parseFloat(k[0]),parseFloat(k[1])]);}if(d.initialZoom){s.m_startLOD=parseInt(d.initialZoom);}var S={zoom:false,move:false,fade:false};if(d.NavigationDisablement){if(d.NavigationDisablement.zoom)s.m_SuppressedNavigation.zoom=VBI.Types.string2bool(d.NavigationDisablement.zoom);if(d.NavigationDisablement.move)s.m_SuppressedNavigation.move=VBI.Types.string2bool(d.NavigationDisablement.move);}if(d.navControlVisible)s.m_bNavControlVisible=VBI.Types.string2bool(d.navControlVisible);S.zoom=s.m_SuppressedNavigation.zoom;S.move=s.m_SuppressedNavigation.move;if(s.m_SuppressedNavigation.zoom&&s.m_SuppressedNavigation.move)s.m_bNavControlVisible=false;else{if(s.m_bNavControlVisible){if(d.SuppressedNavControlVisibility){if(!S.zoom&&d.SuppressedNavControlVisibility.zoom)S.zoom=VBI.Types.string2bool(d.SuppressedNavControlVisibility.zoom);if(!S.move&&d.SuppressedNavControlVisibility.move)S.move=VBI.Types.string2bool(d.SuppressedNavControlVisibility.move);if(d.SuppressedNavControlVisibility.fade)S.fade=VBI.Types.string2bool(d.SuppressedNavControlVisibility.fade);}if(S.move&&S.zoom)s.m_bNavControlVisible=false;}}if(s.m_bNavControlVisible)s.m_NavControl=new VBI.NavigationControl(S);if(d.scaleVisible)s.m_bScaleVisible=VBI.Types.string2bool(d.scaleVisible);if(s.m_bScaleVisible)s.m_Scale=new VBI.Scale(s);};s.SetInputMode=function(v){VBI.m_bTrace&&VBI.Trace("SetInputMode: "+this.m_nInputMode);if(this.m_nInputMode==v)return;switch(this.m_nInputMode){case VBI.InputModeTrackMap:s.SetInputModeTrackMap(false);break;};switch(v){case VBI.InputModeTrackMap:s.SetInputModeTrackMap(true);break;}this.m_nInputMode=v;};s.SetToolTip=function(a){var C=s.m_Canvas[s.m_nOverlayIndex];if(C.title!=a)C.title=a;};s.SetCursor=function(a){var C=s.m_Canvas[s.m_nOverlayIndex];if(C.style.cursor!=a)C.style.cursor=a;};s.RenderAsync=function(f){if(f!=false)s.bForceRecluster=true;if(s.m_RenderTimer)return;s.m_RenderTimer=window.setInterval(s.DoRender,20);};s.DoRender=function(){s.Render(!s.bForceRecluster);};s.Render=function(a){s.bForceRecluster=false;if(s.m_RenderTimer){window.clearInterval(s.m_RenderTimer);s.m_RenderTimer=null;}if(s.m_Canvas.length)s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,a!=true,s.m_Canvas[0].m_nExactLOD);};s.GoToInitialStart=function(){if(!s.ZoomToGeoPosition(s.m_startPointLonLat,s.m_startLOD,true,false,true)){var a=VBI.MathLib.RadToDeg(s.m_nBorderMinPoint);var b=VBI.MathLib.RadToDeg(s.m_nBorderMaxPoint);var l=[a[0],b[0]];var d=[a[1],b[1]];s.ZoomToMultiplePositions(l,d,1.1,true);}s.RenderAsync(true);};s.GetDistance=function(p,a){var G=s.GetPosFromVPPoint(p);var b=s.GetPosFromVPPoint(a);return VBI.MathLib.Distance(VBI.MathLib.DegToRad(G),VBI.MathLib.DegToRad(b));};s.GetTargetPointForDistance=function(d,p){var a=s.GetPosFromVPPoint(p);var b=a.slice(0);a=VBI.MathLib.DegToRad(a);var e=90*Math.PI/180;var l=Math.asin(Math.sin(a[1])*Math.cos(d/VBI.MathLib.earthradius)+Math.cos(a[1])*Math.sin(d/VBI.MathLib.earthradius)*Math.cos(e));var f=a[0]+Math.atan2(Math.sin(e)*Math.sin(d/VBI.MathLib.earthradius)*Math.cos(a[1]),Math.cos(d/VBI.MathLib.earthradius)-Math.sin(a[1])*Math.sin(l));var g=VBI.MathLib.RadToDeg([f,l]);return(s.GetPointFromGeo([f,l],true));};s.ZoomToMultiplePositions=function(l,d,e,S){var f=[];var g=[];if(l.length!=d.length)return;for(var n=0;n<l.length;n++){var L=(parseFloat(l[n]));if(L<0)L+=360;f.push(L);g.push(parseFloat(d[n]));}if(f.length!=g.length||!f.length)return;f.sort(function(a,b){return a-b;});g.sort(function(a,b){return a-b;});var h=0,i=0,k,o;k=g[0];o=g[g.length-1];var p=undefined,q,r,u;q=f[f.length-1];for(var n=0;n<f.length;n++){r=f[n];u=(r<q?(r+360-q):(r-q));if(p==undefined||u>p){p=u;h=(r<q?r+360:r);i=q;}q=r;}s.ZoomToArea(h,i,k,o,e?e:0.9,false,S);};s.ZoomToAreas=function(a,b){var x=Math.log(s.m_nDivWidth/(s.m_MapManager.m_tileWidth*s.m_nXSizeVisualBorder))*Math.LOG2E;var d=VBI.MathLib.GetSurroundingBox(a,0,x,s.CalculateYMinLod);s.ZoomToArea(d[0],d[1],d[2],d[3],b,true);var e=new Date().getTime();s.m_LastZoomArea=[e,"Areas",a,b];return true;};s.CalculateYMinLod=function(a,b){if(a==b)return 1000;var u=[256,256];var d=[256,256];s.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad([0,a]),u);s.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad([0,b]),d);lodY=s.m_nDivHeight/Math.abs(d[1]-u[1]);lodY=Math.log(lodY)*Math.LOG2E;return lodY;};s.ZoomToArea=function(a,b,d,e,f,r,S){var n=256,g=256;if(s.m_MapManager){n=s.m_MapManager.m_tileWidth;nTileHeigth=s.m_MapManager.m_tileHeight;}var h=s.m_nDivHeight?s.m_nDivHeight:g;var i=s.m_nDivWidth?s.m_nDivWidth:n;var I;var p;if(jQuery.type(f)=='array'){if(f.length>=4){var x=f[0]+f[2];var y=f[1]+f[3];if((x<i)&&(y<h)){if((f[0]!=f[2])||(f[1]!=f[3]))p=[(f[2]-f[0])/2,(f[3]-f[1])/2];i-=x;h-=y;I=((x<0)||(y<0));}}}else{h*=f;i*=f;I=(f>1.0);}if(b<a)b+=360;while(a>180)a-=360;while(b>180)b-=360;var k=[a,d];var l=[b,e];k=VBI.MathLib.DegToRad(k);l=VBI.MathLib.DegToRad(l);var u=[n,g];var o=[n,g];s.m_Proj.LonLatToUCS(k,u);s.m_Proj.LonLatToUCS(l,o);var q=u[0]+o[0]+(o[0]<=u[0])*n;var v=u[1]+o[1];var w=[q/n-1,v/g-1];var z=[1,1];s.m_Proj.UCSToLonLat(w,z);var A=14,B=14;if(e!=d){A=h/Math.abs(o[1]-u[1]);A=Math.log(A)*Math.LOG2E;}if(b!=a){B=i/Math.abs((o[0]-u[0])+(o[0]<=u[0])*n);B=Math.log(B)*Math.LOG2E;}var C=(I)?Math.max(B,A):Math.min(B,A);if(r)C=Math.floor(C);s.ZoomToGeoPosition(z,C,false,false,S,p);if(C!=Math.floor(C)){setTimeout(function(){s.AnimateZoomToGeo(z,Math.floor(C),40);},600);}var D=new Date().getTime();s.m_LastZoomArea=[D,"Area",a,b,d,e,f];};s.AdaptOtherCanvas=function(u,l,a,n){var b=a?1:0;var o=s.m_Canvas[1-b];if((a<=1)&&(a>=-2)){var d=l-o.m_nCurrentLOD;var e=Math.pow(2,-d);var p=Math.max(1,e);var f=o.getPixelLeft(),g=o.getPixelTop();var h=o.getPixelWidth(),i=o.getPixelHeight();var k=h/s.m_nWidthCanvas;var q=[(this.m_MapManager.m_tileWidth*o.m_nCurrentX+(s.m_nDivWidth/2-f)/k),(this.m_MapManager.m_tileHeight*o.m_nCurrentY+(s.m_nDivHeight/2-g)/k)];var r=[q[0]-e*u[0],q[1]-e*u[1]];if((Math.abs(r[0])<p*s.m_nWidthCanvas)&&(Math.abs(r[1])<p*s.m_nHeightCanvas)){var v=Math.pow(2,n);var w=v*(f-s.m_nDivWidth/2+k*r[0])+s.m_nDivWidth/2;var x=v*(g-s.m_nDivHeight/2+k*r[1])+s.m_nDivHeight/2;this.MoveCanvas(o,w,x,h*v,i*v);return b;}}return 0;};s.ZoomToGeoPosition=function(l,a,d,S,b,p){if((l.pixelShift!=undefined)&&(p==undefined))p=l.pixelShift;if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive();}var x=0,y=0;var e=s.m_Canvas[0];var o=e.m_nExactLOD;var n=s.m_MapManager.m_tileWidth;var f=s.m_MapManager.m_tileHeight;var g=Math.min(Math.max(a,s.GetMinLOD()),s.GetMaxLOD());a=Math.floor(g);var h=Math.pow(2,g-a);var i=(1<<a);if(p!=undefined){x=p[0]/h;y=p[1]/h;}var u=[i*n,i*f];s.m_Proj.LonLatToUCS(l,u);var k=[u[0]-s.m_nDivWidth/2+x,u[1]-s.m_nDivHeight/2+y];var q=s.m_Proj.m_nUCSMin*i;nTargetCanvas=s.AdaptOtherCanvas(u,a,a-e.m_nCurrentLOD,g-e.m_nExactLOD);var r=Math.round(k[0]/n-s.m_nCanvasStdXPos-q);var v=Math.round(k[1]/f-s.m_nCanvasStdYPos);var w=-Math.floor(k[0]-(r+q)*n);var z=-Math.floor(k[1]-v*f);var A=Math.round(w+((h-1)*(w-s.m_nDivWidth/2)));var B=Math.round(z+((h-1)*(z-s.m_nDivHeight/2)));var C=Math.round(s.m_nWidthCanvas*h);var D=Math.round(s.m_nHeightCanvas*h);var E=[i,i];var F=[i,i];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,E);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,F);var G=D/s.m_nHeightCanvas;var H=f*(v-E[1])*G-B;var I=f*(v-F[1])*G+s.m_nDivHeight-B;var T=true;if(H<-s.m_nMaxPixelBeyondPoles)B=f*(v-E[1])*G+s.m_nMaxPixelBeyondPoles;else if(I>s.m_nMaxPixelBeyondPoles)B=f*(v-F[1])*G+s.m_nDivHeight-s.m_nMaxPixelBeyondPoles;else T=false;if(T){if(d)return false;var J=(B+(h-1)*s.m_nDivHeight/2)/h;var K=-Math.round(s.m_nCanvasStdYPos+J/f);v+=K;B+=h*K*f;}if(s.m_bXBorderExists){var L=n*(r-E[0])*G-A;var M=n*(r-F[0])*G+s.m_nDivWidth-A;var N=true;if(L<-s.m_nMaxPixelBeyondPoles)A=n*(r-E[0])*G+s.m_nMaxPixelBeyondPoles;else if(M>s.m_nMaxPixelBeyondPoles)A=n*(r-F[0])*G+s.m_nDivWidth-s.m_nMaxPixelBeyondPoles;else N=false;if(N){if(d)return false;var O=(A+(h-1)*s.m_nDivWidth/2)/h;var K=-Math.round(s.m_nCanvasStdXPos+O/f);r+=K;A+=h*K*n;}}var P=((e.m_nCurrentX==r)&&(e.m_nCurrentY==v)&&(e.m_nCurrentLOD==a));if(P){s.MoveCanvas(e,A,B,C,D);e.m_nExactLOD=g;}else{s.InvalidateCanvas(s.m_Canvas[1]);if(nTargetCanvas==0){var Q=e.getContext("2d");Q.clearRect(0,0,e.width,e.height);}var R=s.m_Canvas[nTargetCanvas];s.MoveCanvas(R,A,B,C,D);s.m_MapManager.RequestTiles(R,s.m_MapLayerStack,r,v,s.m_nTilesX,s.m_nTilesY,0,0,0,0,a,false);R.m_nExactLOD=g;if(nTargetCanvas==1)s.ToggleCanvas(s);}if(b!=true)s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,!P,!P,g);s.m_LastDefinedCenterPos=p?undefined:l;s.InternalOnMoveLayer(e,S);if(g!=o)s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],S);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(g);}return true;};s.SetMapLayerStack=function(n){var i=VBI.GetMapLayerStack(n);if(i==null)return;if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive();}s.m_MapLayerStack=i;var a=s.m_Canvas[0];s.m_MapManager.RequestTiles(a,s.m_MapLayerStack,a.m_nCurrentX,a.m_nCurrentY,s.m_nTilesX,s.m_nTilesY,0,0,0,0,a.m_nCurrentLOD,false);s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,a.m_nCurrentLOD);};s.ZoomToZoomlevel=function(l,n,S){var r=s.m_Div.getBoundingClientRect();if((r.width!=s.m_nDivWidth)||(r.height!=s.m_nDivHeight))s.resizeCanvas(0);s.ZoomToGeoPosition(l,n,false,S);};s.GetMapLayerStack=function(){return s.m_MapLayerStack;};s.GetMinLOD=function(){var n=Math.max(s.m_nDivWidth/(s.m_MapManager.m_tileWidth*s.m_nXSizeVisualBorder),s.m_nDivHeight/(s.m_MapManager.m_tileHeight*s.m_nYSizeVisualBorder));var a=Math.log(n)*Math.LOG2E;var b=s.m_MapLayerStack;var d=Math.max(s.m_nMinLodVisualBorder-s.m_nOffsetMinLod,b?b.GetMinLOD():0);return Math.max(a,d);};s.GetMinLODForWidth=function(w){var n=w/s.m_MapManager.m_tileWidth;var a=Math.log(n)*Math.LOG2E;var b=s.m_MapLayerStack;var d=Math.max(s.m_nMinLodVisualBorder,b?b.GetMinLOD():0)-s.m_nOffsetMinLod;return Math.max(a,d);};s.GetMaxLOD=function(){var a=s.m_MapLayerStack;return Math.min(a?a.GetMaxLOD():20,s.m_nMaxLodVisualBorder);};s.GetCurrentZoomlevel=function(){return s.m_Canvas[0].m_nExactLOD;};s.GetCenterPos=function(){if(s.m_LastDefinedCenterPos!=undefined){return s.m_LastDefinedCenterPos;}var a=s.getCanvas();var p=[s.m_nDivWidth/2-a.getPixelLeft(),s.m_nDivHeight/2-a.getPixelTop()];return(s.GetGeoFromPoint(p));};s.InternalRenderVisualObjects=function(a,d,b){var e=Date.now();var v=s.m_VOS;var V=v.length;var f;s.m_nNumOfScalingVOInst=0;VBI.Utilities.BackupFont(d);for(var n=0;n<V;++n){if(b){v[n].m_nPreDataIndex=n;f=v[n].Render(a,d,b[n]);}else f=v[n].Render(a,d);if(f!=undefined)s.m_nNumOfScalingVOInst+=f;}if(s.m_DesignVO)s.m_DesignVO.Render(a,d);if(!s.m_cvObjImg){s.m_cvObjImg=document.createElement('canvas');}s.m_cvObjImg.width=a.width;s.m_cvObjImg.height=a.height;var l=s.m_cvObjImg.getContext('2d');l.clearRect(0,0,s.m_cvObjImg.width,s.m_cvObjImg.height);l.drawImage(a,0,0,a.width,a.height);s.InternalRenderLabels(a,d);VBI.Utilities.RestoreFont(d);s.m_nLastRenderingTime=Date.now()-e;};s.UpdatePreData4Selected=function(V,I){var a=s.m_Ctx.m_Clustering;if((V!=undefined)&&a)a.UpdatePreData4Selected(V,I,s.m_PreassembledData,s.m_VOS,s.m_Ctx);};s.InternalRenderLabels=function(a,d){VBI.Utilities.SetTextAttributes(d,VBI.Utilities.RemToPixel(0.75)+"px Lucida Sans Unicode",undefined,undefined,"left","middle");var v=s.m_VOS;for(var n=0,l=v.length;n<l;++n){var L=v[n].getLabelData(true);for(var b=0;b<L.length;++b){var e=L[b];e.SetDimensions(d);e.AlignLabel();var f=e.GetLabelTextColor();var g=e.m_Text.split(/\r\n/);for(var h=0;h<e.m_Pos.length;++h){for(var i=0;i<e.m_Pos[h].length;i++){var p=e.m_Pos[h][i][0];var k=e.m_Pos[h][i][1];d.fillStyle=e.m_BgColor;var o=f.length==1?VBI.Utilities.RemToPixel(0.75):VBI.Utilities.RemToPixel(0.75)+1;d.fillRect(p,k,e.m_Width,e.m_Height);var q=0;for(var r=0;r<f.length;++r){d.fillStyle=f[r];var u=0;for(var w=0;w<g.length;w++){u=e.m_Padding+o*w;d.fillText(g[w],p+e.m_Padding+q,k+u+q+7);}q++;}}}}}};s.InvalidatePreassembledData=function(a,l){var h=s.m_HotItem.m_VO;var b;if(h!=undefined&&h.IsClusterable())b=h.SwitchHotItemToStandard();a.InvalidatePreassembledData(s,l);return b;};s.ValidatePreassembledData=function(){var n=s.m_PreassembledData.HotItemBBIndex;s.m_HotItem.m_Index=n;if(s.m_HotItem.m_HitObj)s.m_HotItem.m_HitObj.m_Index=n;};s.InternalRenderLayer=function(a,C,f,F,n){var b=s.m_Canvas[0];var l;var d=s.m_Ctx.m_Clustering;var e=((d!=undefined)&&d.m_Clusters.length);if((s.m_PreassembledData!=undefined)&&((d==undefined)||(d.m_loadCount!=s.m_PreassembledData.m_version)))l=s.InvalidatePreassembledData(d,b.m_nCurrentLOD);var r=false;if((f==false)&&(n!=undefined)){var g=Math.floor(n);if(n==s.m_nLastRenderLOD)return;if((g==Math.floor(s.m_nLastRenderLOD))&&(n!=g&&(n>(s.GetMinLOD()+0.00001)))){var h=Math.abs(n-s.m_nLastRenderLOD);if(h<s.m_nLastRenderingTime/s.m_nRenderTimeTarget)return;if(h<(s.m_nLastRenderingTime+s.m_nLastClusteringTime)/s.m_nRenderTimeTarget)r=true;}}else{r=!F;}s.m_OverlayImage=null;s.m_nLastRenderLOD=(n==undefined)?-1:n;var o=a.getPixelWidth();var i=a.getPixelHeight();a.setPixelWidth(s.m_nWidthCanvas);a.setPixelHeight(s.m_nHeightCanvas);s.m_ZoomFactors[0]=o/s.m_nWidthCanvas;s.m_ZoomFactors[1]=i/s.m_nHeightCanvas;var k=a.getContext('2d');if(C){k.clearRect(0,0,a.width,a.height);a.setPixelWidth(o);a.setPixelHeight(i);return;}if((!r||s.m_PreassembledData==undefined)&&e){var p=Date.now();if(s.m_PreassembledData)l=s.InvalidatePreassembledData(d,b.m_nCurrentLOD);s.m_PreassembledData=d.DoClustering(this,b.m_nCurrentLOD,b.m_nCurrentX,b.m_nCurrentY,s.m_nTilesX,s.m_nTilesY,s.m_VOS,s.m_Ctx,l);s.ValidatePreassembledData();s.m_nLastClusteringTime=Date.now()-p;}if(r&&s.m_PreassembledData!=undefined)s.m_PreassembledData.m_bAlreadyRendered=false;k.clearRect(0,0,a.width,a.height);s.InternalRenderVisualObjects(a,k,s.m_PreassembledData);a.setPixelWidth(o);a.setPixelHeight(i);s.InternalOnRenderLayer(a);if(s.m_Scale)s.m_Scale.Update();};s.InternalOnMoveLayer=function(a,S){s.m_Ctx.m_Windows.NotifySceneMove(this);var b;if((b=s.m_Ctx.m_Actions)&&(S!=true)){var d;if(d=b.findAction("CenterChanged",s,"Map")){var e=s.m_Canvas[s.m_nOverlayIndex];var n=e.getPixelWidth();var f=e.getPixelHeight();var l=s.GetPosFromPoint([0,0]);var r=s.GetPosFromPoint([n,f]);if(!s.m_Proj.m_bIsIsogonal){var g=s.GetPosFromPoint([n,0]);var h=s.GetPosFromPoint([0,f]);l=[Math.min(l[0],h[0]),Math.min(l[1],g[1])];r=[Math.max(g[0],r[0]),Math.max(h[1],r[1])];}var i=s.m_Div.getBoundingClientRect();var v=-e.getPixelLeft();var k=-e.getPixelTop();var o=s.GetPosFromPoint([v,k]);var p=s.GetPosFromPoint([v+i.width,k+i.height]);var q={level:s.GetCurrentZoomlevel().toString(),min:l[0].toString()+";"+l[1].toString()+";0",max:r[0].toString()+";"+r[1].toString()+";0",vpmin:o[0].toString()+";"+o[1].toString()+";0",vpmax:p[0].toString()+";"+p[1].toString()+";0",};s.m_Ctx.FireAction(d,s,this,null,q);}}this.m_EvtCont.fire("onMove",{canvas:a});s.m_Ctx.onMoveLayer(a);};s.InternalOnZoomLayer=function(a,b){s.m_Ctx.m_Windows.NotifySceneZoom(this);if(b!=true){var d;if(d=s.m_Ctx.m_Actions){var e;if(e=d.findAction("ZoomChanged",s,"Map")){var f=s.m_Canvas[s.m_nOverlayIndex];var n=f.getPixelWidth();var g=f.getPixelHeight();var l=s.GetPosFromPoint([0,0]);var r=s.GetPosFromPoint([n,0]);var h=s.GetPosFromPoint([0,g]);var i=s.GetPosFromPoint([n,g]);var k=s.m_Div.getBoundingClientRect();var v=-f.getPixelLeft();var o=-f.getPixelTop();var p=s.GetPosFromPoint([v,o]);var q=s.GetPosFromPoint([v+k.width,o+k.height]);var u={level:s.GetCurrentZoomlevel().toString(),min:Math.min(l[0],h[0]).toString()+";"+Math.min(l[1],r[1]).toString()+";0",max:Math.max(i[0],r[0]).toString()+";"+Math.max(h[1],i[1]).toString()+";0",vpmin:p[0].toString()+";"+p[1].toString()+";0",vpmax:q[0].toString()+";"+q[1].toString()+";0",};if(b!=undefined&&b!=false){var k=s.m_Div.getBoundingClientRect();u.x=b.x.toString()-k.left;u.y=b.y.toString()-k.top;}s.m_Ctx.FireAction(e,s,this,null,u);}}}this.m_EvtCont.fire("onZoom",{canvas:a});s.m_Ctx.onZoomLayer(a);};s.InternalOnRenderLayer=function(a){s.m_Ctx.onRenderLayer(a);if(s.GetHomeLocation){var o=a.getPixelWidth();var b=a.getPixelHeight();var l=[0,0];var h=s.GetHomeLocation();l[0]=h[0];l[1]=h[1];var x=s.GetPointFromGeo(l);a.setPixelWidth(s.m_nWidthCanvas);a.setPixelHeight(s.m_nHeightCanvas);var d=a.getContext('2d');d.clearRect(0,0,a.width,a.height);d.fillStyle='yellow';d.beginPath();d.arc(x[0],x[1],5,0,Math.PI*2,true);d.closePath();d.fill();var i=null;if(s.m_Ctx)i=s.m_Ctx.GetImage("dummy",s.RenderAsync.bind());if(i)d.drawImage(i,x[0]-i.naturalWidth/2,x[1]-i.naturalHeight);a.setPixelWidth(o);a.setPixelHeight(b);}};s.MoveObject=function(o,x,y,w,h){o.m_pixelLeft=Math.round(x);o.m_pixelTop=Math.round(y);o.style.left=o.m_pixelLeft.toString()+"px";o.style.top=o.m_pixelTop.toString()+"px";if(w!==undefined){o.m_pixelWidth=Math.round(w);o.style.width=o.m_pixelWidth.toString()+"px";}if(h!==undefined){o.m_pixelHeight=Math.round(h);o.style.height=o.m_pixelHeight.toString()+"px";}};s.InvalidateCanvas=function(a){var b=a.getContext("2d");b.fillStyle='white';b.clearRect(0,0,a.width,a.height);a.m_bInvalid=true;};s.MoveCanvas=function(a,x,y,w,h){s.MoveObject(s.m_Canvas[s.m_nOverlayIndex],x,y,w,h);s.MoveObject(a,x,y,w,h);};s.MoveOnlyThisCanvas=function(a,x,y,w,h){s.MoveObject(a,x,y,w,h);};s.MoveMap=function(d,a){VBI.m_bTrace&&VBI.Trace("MoveMap"+" DX:"+d+" DY:"+a);var b=s.m_Canvas[3];var e=s.m_Canvas[0];var f=(b.m_bCanvasValid?b:e);var g=s.m_MapManager;var n=f.getPixelWidth();var h=f.getPixelHeight();var i=f.getPixelLeft()+d;var k=f.getPixelTop()+a;var l=g.m_tileWidth,o=g.m_tileHeight;var p=n/s.m_nTilesX;var q=h/s.m_nTilesY;var r=h/s.m_nHeightCanvas;var u=(1<<e.m_nCurrentLOD);var v=[u,u];var w=[u,u];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,v);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,w);if((a>0&&((o*r*(f.m_nCurrentY-v[1])-k)<-s.m_nMaxPixelBeyondPoles))||(a<0&&((o*r*(f.m_nCurrentY-w[1])+s.m_nDivHeight-k)>s.m_nMaxPixelBeyondPoles))){if(d==0)return;a=0;k=f.getPixelTop();}if(s.m_bXBorderExists&&((d>0&&((l*r*(f.m_nCurrentX-v[0])-i)<-s.m_nMaxPixelBeyondPoles))||(d<0&&((l*r*(f.m_nCurrentX-w[0])+s.m_nDivWidth-i)>s.m_nMaxPixelBeyondPoles)))){if(a==0)return;d=0;i=f.getPixelLeft();}var x=0;var y=0;var z;if((d>0)&&(z=i+s.m_nMapMoveXPreLoad)>0){x=Math.ceil(z/p);}else if((d<0)&&((z=s.m_nMapMoveXPreLoad+s.m_nDivWidth-(i+n))>0)){x=-Math.ceil(z/p);}var A=f.m_nCurrentX-x;if((a>0)&&(z=k+s.m_nMapMoveYPreLoad)>0){y=Math.ceil(z/q);}else if((a<0)&&(z=(s.m_nMapMoveYPreLoad+s.m_nDivHeight-(k+h)))>0){y=-Math.ceil(z/q);}var B=f.m_nCurrentY-y;var C=s.m_MapLayerStack;var S=C?C.m_bSingleBMP:false;if(x||y){var D=nPendingOffsetY=0;if(!s.m_Canvas[1].m_bInvalid){s.InvalidateCanvas(s.m_Canvas[1]);}s.MoveCanvas(e,e.getPixelLeft()+d,e.getPixelTop()+a);if(b.m_bCanvasValid){if(b.m_nTilesBefSwitch<b.m_nForceSwitchLimit){s.SwitchTmpCanvasToActive();}else{D=b.m_nOffsetX;nPendingOffsetY=b.m_nOffsetY;}}b.m_nTilesBefSwitch=(S||Math.abs(x)>=s.m_nTilesX||Math.abs(y)>=s.m_nTilesY)?1:(s.m_nTilesX-Math.abs(x))*(s.m_nTilesY-Math.abs(y));b.m_nForceSwitchLimit=Math.ceil(b.m_nTilesBefSwitch/2);b.m_nOffsetX=x+D;b.m_nOffsetY=y+nPendingOffsetY;s.MoveOnlyThisCanvas(b,i-x*p,k-y*q,n,h);var E=b.getContext("2d");E.clearRect(0,0,e.getPixelWidth(),e.getPixelHeight());if(g.RequestTiles(b,s.m_MapLayerStack,A,B,s.m_nTilesX,s.m_nTilesY,0,0,0,0,e.m_nCurrentLOD,false))b.m_bCanvasValid=true;else s.SwitchTmpCanvasToActive();}else{s.MoveCanvas(e,e.getPixelLeft()+d,e.getPixelTop()+a);s.MoveObject(s.m_Canvas[1],s.m_Canvas[1].getPixelLeft()+d,s.m_Canvas[1].getPixelTop()+a);if(b.m_bCanvasValid)s.MoveOnlyThisCanvas(b,i,k);}var V=s.m_VOS;var R=false;for(var F=0,G=V.length;F<G;++F){if(V[F].m_Label.length>0&&V[F].CalculateLabelPos){R=true;break;}}if(R){if(s.m_cvObjImg){var H=s.m_Canvas[s.m_nOverlayIndex].getContext("2d");H.clearRect(0,0,s.m_Canvas[s.m_nOverlayIndex].width,s.m_Canvas[s.m_nOverlayIndex].height);H.drawImage(s.m_cvObjImg,0,0,s.m_cvObjImg.width,s.m_cvObjImg.height);}VBI.Utilities.BackupFont(H);s.InternalRenderLabels(s.m_Canvas[s.m_nOverlayIndex],H);VBI.Utilities.RestoreFont(H);}s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex]);s.m_LastDefinedCenterPos=undefined;};s.AdaptZoomFactor=function(a,f,x,y,b){var r={};r.bZoomNotPossible=true;var n=(1<<a.m_nCurrentLOD);if((a.m_nCurrentY<0)&&(y<-a.m_nCurrentY*(a.getPixelHeight()/s.m_nTilesY)))return r;if(((a.m_nCurrentY+s.m_nTilesY)>n)&&(y>(n-a.m_nCurrentY)*(a.getPixelHeight()/s.m_nTilesY)))return r;if(f<1){var d=Math.max((s.m_nDivWidth/(a.getPixelWidth()*s.m_nXSizeVisualBorder))*(s.m_nTilesX/n),(s.m_nDivHeight/(a.getPixelHeight()*s.m_nYSizeVisualBorder))*(s.m_nTilesY/n));if(f<d){if((d>=1)&&(f!=0))return r;f=d;A=false;}}var A=b&&(s.m_nZoomMode||(f==s.m_nLodFactorZoomIn)||(f==s.m_nLodFactorZoomOut));var e=a.m_nExactLOD+Math.log(f)*Math.LOG2E;var g=s.GetMinLOD();if((g!=Math.round(g))&&(f!=1.0)&&(a.m_nExactLOD<=Math.ceil(g))&&(Math.round(b*e)==Math.round(b*g)))A=false;if(A&&Math.round(b*e)!=b*e){e=Math.round(b*e)/b;f=Math.pow(2,e-a.m_nExactLOD);}else{if(e<g){e=g;f=Math.pow(2,e-a.m_nExactLOD);}}r.factor=f;r.nNewLod=Math.floor(e);r.lodFallsOnInteger=(Math.round(e)==e);r.bZoomNotPossible=((e>s.GetMaxLOD())||(e<g));return r;};s.ZoomMap=function(f,x,y,a,S){if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive();}var b=s.m_Canvas[0];var o=s.m_Canvas[1];var d=s.m_MapManager;var e=d.m_tileWidth,g=d.m_tileHeight;var n,h,i=0,k=0;var l=b.getPixelLeft(),p=b.getPixelTop();var q=b.getPixelWidth(),r=b.getPixelHeight();var u=o.getPixelWidth();var z=s.AdaptZoomFactor(b,f,x,y,a);if(z.bZoomNotPossible)return;f=z.factor;var v=z.nNewLod;VBI.m_bTrace&&VBI.Trace("Zoom by "+f+" to "+x+"/"+y);var w=Math.round(q*f);var A=Math.round(r*f);var B=Math.round(l-((f-1)*x));var C=Math.round(p-((f-1)*y));if(f<1){var D=(1<<b.m_nCurrentLOD);var E=[D,D];var F=[D,D];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,E);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,F);var G=A/s.m_nHeightCanvas;var H=(b.m_nCurrentY-E[1])*g*G-C;if(H<-s.m_nMaxPixelBeyondPoles){C=Math.round(g*(b.m_nCurrentY-E[1])*G+s.m_nMaxPixelBeyondPoles);y=(p-C)/(f-1);}else{var I=g*(b.m_nCurrentY-F[1])*G+s.m_nDivHeight-C;if(I>s.m_nMaxPixelBeyondPoles){C=Math.round(g*(b.m_nCurrentY-F[1])*G+s.m_nDivHeight-s.m_nMaxPixelBeyondPoles);y=(p-C)/(f-1);}}if(s.m_bXBorderExists){var J=(b.m_nCurrentX-E[0])*e*G-B;if(J<-s.m_nMaxPixelBeyondPoles){B=Math.round(e*(b.m_nCurrentX-E[0])*G+s.m_nMaxPixelBeyondPoles);x=(l-B)/(f-1);}var K=(b.m_nCurrentX-F[0])*e*G+s.m_nDivWidth-B;if(K>s.m_nMaxPixelBeyondPoles){B=Math.round(e*(b.m_nCurrentX-F[0])*G+s.m_nDivWidth-s.m_nMaxPixelBeyondPoles);x=(l-B)/(f-1);}}}s.MoveCanvas(b,B,C,w,A);var L=w/s.m_nTilesX;var M=A/s.m_nTilesY;var R=false;if(v==b.m_nCurrentLOD){if(!o.m_bInvalid){var N=Math.round(u*f);var O=Math.round(o.getPixelHeight()*f);if((N<=s.m_nMaxCanvasDimension)&&(O<=s.m_nMaxCanvasDimension)){var P=o.getPixelLeft();var Q=o.getPixelTop();var T=Math.round(P-((f-1)*(x+l-P)));var U=Math.round(Q-((f-1)*(y+p-Q)));s.MoveObject(o,T,U,Math.round(u*f),Math.round(o.getPixelHeight()*f));}else{s.InvalidateCanvas(s.m_Canvas[1]);}}b.m_nExactLOD=b.m_nCurrentLOD+Math.log(L/e)*Math.LOG2E;if(B>0||C>0||(B+w<s.m_nDivWidth)||(C+A<s.m_nDivHeight)){R=true;n=-Math.ceil(B/L);h=-Math.ceil(C/M);i=B+n*L;k=C+h*M;B=b.m_nCurrentX+n;C=b.m_nCurrentY+h;VBI.m_bTrace&&VBI.Trace("run out viewport newTop="+C+" nTilesY="+h+" nPosY="+k+" yOffset="+y+"\n");}}else{R=true;var V=Math.pow(2,b.m_nCurrentLOD-v);var W=r/s.m_nHeightCanvas;var X=x/W+(V*(s.m_nDivWidth/2-l-x));var Y=y/W+(V*(s.m_nDivHeight/2-p-y));if(v>b.m_nCurrentLOD){n=Math.round(X/V/e-s.m_nTilesX/2);h=Math.round(Y/V/g-s.m_nTilesY/2);i=Math.ceil(B+n*L*V);k=Math.ceil(C+h*M*V);}else{var Z=((b.m_nCurrentX%V)+V)%V;var $=((b.m_nCurrentY%V)+V)%V;n=Math.round((X/e+Z)/V-s.m_nTilesX/2);h=Math.round((Y/g+$)/V-s.m_nTilesY/2);i=B+L*(n*V-Z);k=C+M*(h*V-$);}B=Math.floor(b.m_nCurrentX/V+n);C=Math.floor(b.m_nCurrentY/V+h);w=z.lodFallsOnInteger?(e*s.m_nTilesX):Math.ceil(w*V);A=z.lodFallsOnInteger?(g*s.m_nTilesY):Math.ceil(A*V);}var _=v+Math.log(w/s.m_nWidthCanvas)*Math.LOG2E;if(R){o.m_nExactLOD=_;s.MoveCanvas(o,i,k,w,A);var a1=o.getContext("2d");a1.fillStyle='white';a1.clearRect(0,0,a1.canvas.width,a1.canvas.height);s.m_MapManager.RequestTiles(s.m_Canvas[1],s.m_MapLayerStack,B,C,s.m_nTilesX,s.m_nTilesY,0,0,0,0,v,true);b.m_Scene.ToggleCanvas(b.m_Scene);}s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,R,R,_);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(v);}s.InternalOnMoveLayer(b,S);s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],S);s.m_LastDefinedCenterPos=s.m_LastZoomArea=undefined;};s.ZoomOtherCanvas=function(o,a,f,x,y){var n=Math.round(o.getPixelLeft()-((f-1)*x));var b=Math.round(o.getPixelTop()-((f-1)*y));var d=Math.round(o.getPixelWidth()*f);var e=Math.round(o.getPixelHeight()*f);s.MoveObject(o,n,b,d,e);};s.AnimateZoom=function(z,a,b,i,e){var Z=false;var d=((e!=undefined&&e.clientX!=undefined)?{x:e.clientX,y:e.clientY}:undefined);var n=s.m_Canvas[0].m_nExactLOD;var f=2*s.m_nTicksInALod;if(s.m_AnimZoomTimer&&(s.m_nAnimDirection==z)){if(s.m_nAnimOpenTicks>22)return;window.clearInterval(s.m_AnimZoomTimer);s.m_nAnimOpenTicks+=f;s.m_nAnimTicks+=f;}else{if(n!=Math.round(n)){var g=Math.round((n-Math.floor(n))*f);s.m_nAnimTicks=1+(z?f-g:g);}else s.m_nAnimTicks=1+f;if(s.m_nAnimTicks==1){Z=true;s.m_nAnimTicks++;}s.m_nAnimOpenTicks=s.m_nAnimTicks;s.m_nAnimDirection=z;if(s.m_AnimZoomTimer)window.clearInterval(s.m_AnimZoomTimer);}var h=i*f/Math.max(5,(s.m_nAnimOpenTicks-1));s.AnimZoomTarget=Math.min(s.GetMaxLOD(),Math.max(s.GetMinLOD(),n+(s.m_nAnimDirection?1:-1)*(s.m_nAnimOpenTicks-1)/f));s.m_AnimZoomTimer=window.setInterval(function(){if(--s.m_nAnimOpenTicks){var r=s.m_Canvas[0].getBoundingClientRect();var o=s.m_Canvas[0].m_nExactLOD;var k=Z?1.0:(s.m_nAnimDirection?s.m_nLodFactorZoomInHalf:s.m_nLodFactorZoomOutHalf);s.ZoomMap(k,a-r.left,b-r.top,f,true);if((s.m_Canvas[0].m_nExactLOD!=o)||(Math.abs(s.AnimZoomTarget-o)>s.m_nMaxAnimLodDiff))return;}s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex],d);s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],d);if(s.m_AnimZoomTimer){s.m_nAnimOpenTicks=s.m_nAnimationTicks=s.m_nAnimationDirection=s.AnimZoomTarget=undefined;window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;}},h);};s.AnimateZoomToGeo=function(l,G,i){var n=s.m_Canvas[0].m_nExactLOD;if(n==G)return;var a=2*s.m_nTicksInALod;if(s.m_AnimZoomTimer){window.clearInterval(s.m_AnimZoomTimer);}s.m_nAnimTicks=2+Math.abs(Math.round((n-G)*a));s.m_nAnimOpenTicks=s.m_nAnimTicks;var b=n;var d=G;var e=i*a/s.m_nAnimTicks;s.m_AnimZoomTimer=window.setInterval(function(){if(--s.m_nAnimOpenTicks){s.ZoomToZoomlevel(l,d-(s.m_nAnimOpenTicks-1)*(d-b)/(s.m_nAnimTicks-1),true);return;}s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex]);if(s.m_AnimZoomTimer){s.m_nAnimOpenTicks=s.m_nAnimationTicks=undefined;window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,false,false,s.m_Canvas[0].m_nExactLOD);}},e);};s.IsTransparent=function(a,b){var C=s.m_Canvas[s.m_nOverlayIndex];if(!C)return false;var r=C.getBoundingClientRect();var n=Math.round((a-r.left)/s.m_ZoomFactors[0]);var d=Math.round((b-r.top)/s.m_ZoomFactors[1]);if(!s.m_OverlayImage){var e=C.getContext("2d");s.m_OverlayImage=e.getImageData(0,0,s.m_nWidthCanvas,s.m_nHeightCanvas);}var f=(d*s.m_nWidthCanvas+n)*4+3;if((f<0)||(f>=(s.m_nWidthCanvas*s.m_nHeightCanvas*4))){VBI.m_bTrace&&VBI.Trace("GeoScene::IsTransparent coordinate out of bounds");return true;}var I=s.m_OverlayImage.data;var g=I[f];return g?false:true;};s.GetCurrentZoomFactors=function(){return s.m_ZoomFactors;};s.ToggleCanvas=function(s){var a=s.m_Canvas[0];s.m_Canvas[0]=s.m_Canvas[1];s.m_Canvas[1]=a;s.m_Canvas[0].style.opacity=0.0;s.m_Canvas[1].style.opacity=1.0;a=s.m_Canvas[0].style.zIndex;s.m_Canvas[0].style.zIndex=s.m_Canvas[1].style.zIndex;s.m_Canvas[1].style.zIndex=a;s.BlendCanvas();};s.BlendCanvas=function(){if(s.m_BlendTimer!=null)window.clearInterval(s.m_BlendTimer);var n=parseFloat(s.m_Canvas[0].style.opacity);if(n<1.0){s.m_BlendTimer=window.setInterval(s.BlendCanvas,40);s.m_Canvas[0].style.opacity=Math.min(n+0.1,1.0);if(VBI.m_bIsMyChromeTest){s.m_Canvas[0].style.display='none';s.m_Canvas[0].offsetHeight;s.m_Canvas[0].style.display='block';}}else{window.clearInterval(s.m_BlendTimer);}};s.GetNearestPosArray=function(p){var a=p.slice();var n=Math.floor(a.length/3)*3;var b=a[0];var d=a[1];var e=b,f=b;var g=d,h=d;for(var i=3;i<n;i+=3){while(a[i]-b>180)a[i]-=360;while(b-a[i]>180)a[i]+=360;b=a[i];d=a[i+1];if(e>b)e=b;if(f<b)f=b;if(g>d)g=d;if(h<d)h=d;}a.m_MinX=e;a.m_MaxX=f;a.m_MinY=g;a.m_MaxY=h;return a;};s.GetNearestPos=function(a,n){var p=a.slice();var b=n[0];while(p[0]-b>180)p[0]-=360;while(b-p[0]>180)p[0]+=360;return p;};s.GetPointArrayFromPosArray=function(p,a){var l=[0.0,0.0],r=[];var b=s.m_Canvas[0];var n=(1<<b.m_nCurrentLOD);var d=s.m_nWidthCanvas/s.m_nTilesX;var e=s.m_nHeightCanvas/s.m_nTilesY;var f=n*d;var g=n*e;var h=s.m_Canvas[s.m_nOverlayIndex];var i=h.getPixelWidth()/s.m_nWidthCanvas;var k=h.getPixelHeight()/s.m_nHeightCanvas;var o=s.m_Proj.LonLatToUCS;var u=[0,0],q=Math.PI/180.0;var v=s.m_Proj;var w=v.m_nUCSMin*f;var z=v.m_nUCSMax*f;var A=v.m_nXYRatio*f;var B=b.m_nCurrentX*d+w;var C=b.m_nCurrentY*e;for(var D=0,E=p.length/3;D<E;++D){l[0]=q*p[D*3];l[1]=q*p[D*3+1];u[0]=f;u[1]=g;u=o(l,u);u[0]=u[0]-B;u[1]=u[1]-C;if(a){while(u[0]<w)u[0]+=A;while(u[0]>z)u[0]-=A;}r.push(u[0]*i,u[1]*k,0.0);}if(D==1&&u){var x,y;r.m_bVisible=(((x=u[0])>0)&&((y=u[1])>0)&&(x<s.m_nWidthCanvas)&&(y<s.m_nHeightCanvas));}return r;};s.GetPointFromGeo=function(l,a){return s.GetPointArrayFromPosArray(VBI.MathLib.RadToDeg(l),a);};s.GetInstanceOffsets=function(r){var a=r.slice();var b=s.m_Canvas[0];var d=s.m_nWidthCanvas/s.m_nTilesX;var e=(1<<b.m_nCurrentLOD)*d*s.m_Proj.m_nXYRatio;var f=[0,0,s.m_nWidthCanvas,s.m_nHeightCanvas];var n=0;while(a[2]>0){--n;VBI.Utilities.RectOffset(a,-e,0);}var o=[];while(a[0]<s.m_nWidthCanvas){n++;VBI.Utilities.RectOffset(a,e,0);if(VBI.Utilities.RectIntersect(a,f))o.push(n*e);}return o;};s.GetPosFromVPPoint=function(p){var a=s.m_Canvas[s.m_nOverlayIndex];var b=[p[0]-a.getPixelLeft(),p[1]-a.getPixelTop(),0];var d=this.GetGeoFromPoint(b);return VBI.MathLib.RadToDeg(d);};s.GetPosFromPoint=function(p){var a=this.GetGeoFromPoint(p);return VBI.MathLib.RadToDeg(a);};s.GetGeoFromPoint=function(p){var a=s.m_Canvas[0];var n=a.m_nCurrentLOD;var b=(1<<n);var d=p[0]*s.m_nWidthCanvas/a.getPixelWidth();var e=p[1]*s.m_nHeightCanvas/a.getPixelHeight();var f=s.m_nWidthCanvas/s.m_nTilesX;var g=s.m_nHeightCanvas/s.m_nTilesY;var h=a.m_nCurrentX*f;var i=a.m_nCurrentY*g;var k=h+d;var l=i+e;var o=b*f;var q=b*g;var r=[0,0];var u=[k/o*2.0-1.0,l/q*2.0-1.0];return s.m_Proj.UCSToLonLat(u,r);};s.getCanvas=function(){return s.m_Canvas[0];};s.clearTimers=function(){if(s.m_BlendTimer){window.clearInterval(s.m_BlendTimer);s.m_BlendTimer=null;}if(s.m_AnimZoomTimer){window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;}};s.clearCanvases=function(){for(var n=0,a=s.m_Canvas.length;n<a;++n){s.m_Canvas[n].m_Scene=null;s.m_Canvas[n]=null;}s.m_Canvas=[];};s.Remove=function(){if(s.m_Div){s.SetInputMode(VBI.InputModeDefault);while(s.m_Div.firstChild)s.m_Div.removeChild(s.m_Div.firstChild);s.m_Div.parentElement.removeChild(s.m_Div);s.m_Div=null;s.clearTimers();s.clearCanvases();}if(s.m_Target){while(s.m_Target.firstChild)s.m_Target.removeChild(s.m_Target.firstChild);s.m_Target=null;}};s.AddCopyright=function(){if(!s.m_MapLayerStack)return;if(!s.m_DivCopyright){var C=VBI.Utilities.CreateGeoSceneDivCSS(s.m_Target.id+"-copyright","vbi-copyright");s.m_Div.appendChild(C);s.m_DivCopyright=C;}var a=s.m_MapLayerStack.GetCopyright();if(a){s.m_DivCopyright.innerHTML=a;}else{s.m_DivCopyright.style.paddingRight=0;s.m_DivCopyright.style.paddingLeft=0;}};s.ReAwake=function(){s.m_MapLayerStack=s.m_RefMapLayerStack;s.AddCopyright();s.resizeCanvas(0,true);};s.Awake=function(t,m,c){if(!(s.m_Target=VBI.Utilities.GetDOMElement(t)))s.m_Target=VBI.Utilities.CreateDOMElement(t,"1px","1px");if(s.m_Div){if(s.m_Div.parentNode==s.m_Target)return;s.m_Target.appendChild(s.m_Div);if(s.m_bNavControlVisible&&s.m_NavControl)s.m_NavControl.AttachEvents();return;}s.m_TargetName=t;s.m_MapManager=typeof m!=='undefined'?m:VBI.MapManager;s.m_MapLayerStack=typeof c!=='undefined'?c:s.m_RefMapLayerStack;s.m_Div=VBI.Utilities.CreateGeoSceneDiv(t+"-geoscene");s.m_Target.appendChild(s.m_Div);s.DoAwake(t);};s.setProjection=function(){if(!s.m_RefMapLayerStack||!s.m_RefMapLayerStack.m_MapLayerArray||!s.m_RefMapLayerStack.m_MapLayerArray.length)return new VBI.MercatorProjection;var l=s.m_RefMapLayerStack.m_MapLayerArray;var n=l[0].GetMapProvider().m_nProjection;for(var i=2;i<l.length;++i){if(l[i].GetMapProvider().m_nProjection!=n){VBI.m_bTrace&&VBI.Trace("projection of layer "+i+" is inconsistent to base layer. Choosing projection of base layer");}}switch(n){case 1:return new VBI.MercatorProjection;case 2:return new VBI.LinearProjection;default:return new VBI.MercatorProjection;}};s.DoAwake=function(t){s.CalculateCanvasDimensions();s.CreateCanvases();
// append copyright 
s.AddCopyright();var C=s.m_Canvas[s.m_nOverlayIndex];C.draggable="true";if(s.m_Events)s.m_Events.clear();s.m_Events=new VBI.SceneEvent(this,C);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.Awake(s,t);}if(s.m_bScaleVisible&&s.m_Scale){s.m_Scale.Awake(s,t);}var e=s.GetMinLOD();if(s.m_startLOD<e){var f=Math.ceil(e);s.m_startLOD=(f-e)<0.6?f:e;}s.GoToInitialStart();};s.CalcCanvasWidth=function(w,a){return(Math.floor(w/a+s.m_nCanvasXOversize))*a;};s.CalcCanvasHeight=function(h,a){return(Math.floor(h/a+s.m_nCanvasYOversize))*a;};s.CalculateCanvasDimensions=function(){var n=s.m_Target.offsetWidth;var r=s.m_Div.getBoundingClientRect();var a=s.m_MapManager;var d=r.width?r.width:s.m_Div.clientWidth;var b=r.height?r.height:s.m_Div.clientHeight;if((d==s.m_nDivWidth)&&(b==s.m_nDivHeight))return;s.m_nDivWidth=d;s.m_nDivHeight=b;s.m_nWidthCanvas=s.CalcCanvasWidth(d,a.m_tileWidth);s.m_nHeightCanvas=s.CalcCanvasHeight(b,a.m_tileHeight);s.m_nTilesX=s.m_nWidthCanvas/a.m_tileWidth;s.m_nTilesY=s.m_nHeightCanvas/a.m_tileHeight;a.m_requestTileWidth=a.m_tileWidth;a.m_requestTileHeight=a.m_tileHeight;var l=s.m_MapLayerStack;if(l.m_nMaxSquare&&l.m_MapLayerArray.length){var e=0;for(var i=0;i<l.m_MapLayerArray.length;++i){if(!i||(l.m_MapLayerArray[i].m_refMapProvider.m_nResolution<e)){e=parseInt(l.m_MapLayerArray[i].m_refMapProvider.m_nResolution);}}var f=l.m_nMaxSquare*e;if((s.m_nTilesX*a.m_tileWidth>f)||(s.m_nTilesY*a.m_tileHeight>f)){var g=Math.floor(f/Math.max(s.m_nTilesX,s.m_nTilesY));a.m_requestTileWidth=g;a.m_requestTileHeight=g;}}VBI.m_bTrace&&VBI.Trace("Setting Canvas Size to ("+s.m_nWidthCanvas+","+s.m_nHeightCanvas+") on div with size ("+d+","+b+")");s.m_nMapMoveXPreLoad=Math.min(120,a.m_tileWidth*(s.m_nTilesX-1)-d);s.m_nMapMoveYPreLoad=Math.min(120,a.m_tileHeight*(s.m_nTilesY-1)-b);s.m_nCanvasStdXPos=(s.m_nWidthCanvas-s.m_nDivWidth)/a.m_tileWidth/2;s.m_nCanvasStdYPos=(s.m_nHeightCanvas-s.m_nDivHeight)/a.m_tileHeight/2;s.m_nMaxPixelBeyondPoles=0;};s.SwitchTmpCanvasToActive=function(){var d=s.m_Canvas[0],a=s.m_Canvas[3];var b=d.getContext('2d');b.clearRect(0,0,d.getPixelWidth(),d.getPixelHeight());b.drawImage(s.m_Canvas[3],0,0);s.MoveCanvas(d,d.getPixelLeft()-a.m_nOffsetX*d.getPixelWidth()/s.m_nTilesX,d.getPixelTop()-a.m_nOffsetY*d.getPixelHeight()/s.m_nTilesY);d.m_nCurrentX=a.m_nCurrentX;d.m_nCurrentY=a.m_nCurrentY;a.m_bCanvasValid=false;a.m_CanvasRedirect=d;a.m_CanvasRedirRequest=a.m_nRequest;a.m_nOffsetX=a.m_nOffsetY=0;a.m_nTilesBefSwitch=undefined;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,d.m_nExactLOD);};s.CreateCanvases=function(){var i=s.m_TargetName+"-"+s.m_ID+"-";s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"layer1",s.m_nWidthCanvas,s.m_nHeightCanvas,2));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"layer2",s.m_nWidthCanvas,s.m_nHeightCanvas,1));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"objectlayer",s.m_nWidthCanvas,s.m_nHeightCanvas,3,0));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"nondomlayer",s.m_nWidthCanvas,s.m_nHeightCanvas,4,0,true));for(var n=0;n<s.m_Canvas.length;++n){s.m_Canvas[n].m_Scene=s;s.m_Canvas[n].m_nCurrentLOD=2;s.m_Canvas[n].m_nExactLOD=2;s.m_Canvas[n].m_nCurrentX=undefined;s.m_Canvas[n].m_nCurrentY=undefined;s.m_Canvas[n].m_nAppliedRequest=0;s.m_Canvas[n].m_bInvalid=false;if(!s.m_Canvas[n].m_bNotInDOM)s.m_Div.appendChild(s.m_Canvas[n]);}};s.resizeCanvas=function(e,f){if(!s.m_Canvas.length){s.DoAwake();return;}if(s.m_Canvas[3].m_bCanvasValid)s.SwitchTmpCanvasToActive();var a=s.m_MapManager;var b=s.m_Canvas[0];var o=s.m_nDivWidth;var d=s.m_nDivHeight;var g=s.GetMinLODForWidth(o);var h=b.getPixelWidth()/s.m_nWidthCanvas;s.m_nLastRenderLOD=-1;s.CalculateCanvasDimensions();if((!f)&&(s.m_nDivWidth==o)&&(s.m_nDivHeight==d))return;VBI.m_bTrace&&VBI.Trace("Resizing ("+(o)+","+(d)+") to ("+(s.m_nDivWidth)+","+(s.m_nDivHeight)+")");var k=b.m_nCurrentX;var l=b.m_nCurrentY;var n=b.m_nCurrentLOD;var p=b.getPixelLeft()+(s.m_nDivWidth-o)/2;var x=Math.round((-p/a.m_tileWidth-s.m_nCanvasStdXPos)/h);p+=h*x*a.m_tileWidth;var q=b.getPixelTop()+(s.m_nDivHeight-d)/2;var y=Math.round((-q/a.m_tileHeight-s.m_nCanvasStdYPos)/h);q+=h*y*a.m_tileHeight;for(var i=0;i<s.m_Canvas.length;++i){s.m_Canvas[i].width=s.m_nWidthCanvas;s.m_Canvas[i].height=s.m_nHeightCanvas;}s.InvalidateCanvas(s.m_Canvas[1]);s.MoveCanvas(b,p,q,h*s.m_nWidthCanvas,h*s.m_nHeightCanvas);s.m_MapManager.RequestTiles(b,s.m_MapLayerStack,k+x,l+y,s.m_nTilesX,s.m_nTilesY,0,0,0,0,n,false);var r=s.m_LastZoomArea;if(r==undefined){var u=s.GetMinLOD();if(b.m_nExactLOD<u){s.ZoomMap(Math.pow(2,u-b.m_nExactLOD)*1.000001,s.m_nDivWidth/2-p,s.m_nDivHeight/2-q);}else{if(b.m_nExactLOD!=Math.floor(b.m_nExactLOD)){s.AnimateZoomToGeo(s.GetCenterPos(),Math.floor(b.m_nExactLOD),33);}else{s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,b.m_nExactLOD);s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex]);}}var v=s.GetMaxLOD();if(b.m_nExactLOD>v){s.ZoomMap(Math.pow(2,v-b.m_nExactLOD),s.m_nDivWidth/2-p,s.m_nDivHeight/2-q);}}else{var w=new Date().getTime();if((w-r[0])<3000){switch(r[1]){case"Area":s.ZoomToArea(r[2],r[3],r[4],r[5],r[6]);break;case"Areas":s.ZoomToAreas(r[2],r[3]);break;}}}if((f||(s.GetMinLOD()!=g))&&s.m_NavControl)s.m_NavControl.AdaptMinMaxLOD(s);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(s.m_Canvas[0].m_nCurrentLOD);}s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,false,true,s.m_Canvas[0].m_nExactLOD);};if(t)s.Awake(t,m,c);return s;};
VBI.Utilities=VBI.Utilities||{};
HTMLCanvasElement.prototype.getPixelWidth=function(){if(this.m_pixelWidth)return this.m_pixelWidth;if(this.style.pixelWidth!==undefined)return this.style.pixelWidth;return parseInt(this.style.width);};
HTMLCanvasElement.prototype.getPixelHeight=function(){if(this.m_pixelHeight)return this.m_pixelHeight;if(this.style.pixelHeight!==undefined)return this.style.pixelHeight;return parseInt(this.style.height);};
HTMLCanvasElement.prototype.getPixelLeft=function(){if(this.m_pixelLeft)return this.m_pixelLeft;if(this.style.pixelLeft!==undefined)return this.style.pixelLeft;return parseInt(this.style.left);};
HTMLCanvasElement.prototype.getPixelTop=function(){if(this.m_pixelTop)return this.m_pixelTop;if(this.style.pixelTop!==undefined)return this.style.pixelTop;return parseInt(this.style.top);};
HTMLCanvasElement.prototype.setPixelWidth=function(v){this.m_pixelWidth=v;(this.style.pixelWidth!==undefined)?(this.style.pixelWidth=v):(this.style.width=v+'px');};
HTMLCanvasElement.prototype.setPixelHeight=function(v){this.m_pixelHeight=v;(this.style.pixelHeight!==undefined)?(this.style.pixelHeight=v):(this.style.height=v+'px');};
HTMLCanvasElement.prototype.setPixelLeft=function(v){this.m_pixelLeft=v;(this.style.pixelLeft!==undefined)?(this.style.pixelLeft=v):(this.style.left=v+'px');};
HTMLCanvasElement.prototype.setPixelTop=function(v){this.m_pixelTop=v;(this.style.pixelTop!==undefined)?(this.style.pixelTop=v):(this.style.top=v+'px');};
VBI.Utilities.CreateWifiObject=function(){var n=document.createElement('object');if(!n)return null;n.classid="CLSID:00100000-2013-0070-2000-651572487E69";return n;};
VBI.Utilities.CreateDOMElement=function(t,i,w,h){var n=document.createElement(t);n.style.height=w?w:"1px";n.style.width=h?h:"1px";n.id=i;return n;};
VBI.Utilities.GetDOMElement=function(e){var a=[];for(var i=0,l=arguments.length;i<l;i++){var e=arguments[i];if(typeof e=='string'){e=document.getElementById(e);}if(arguments.length==1){return e;}a.push(e);}return a;};
VBI.Utilities.CreateDOMVBIDivElement=function(i,w,h){var n=document.createElement('div');n.id=i;n.style.height="300x";n.style.width="300px";n.style.overflow="hidden";n.style.position="absolute";n.style.left="0px";n.style.top="0px";return n;};
VBI.Utilities.CreateGeoSceneDiv=function(i){var n=document.createElement('div');n.id=i;n.style.left="0px";n.style.top="0px";n.style.width="100%";n.style.height="100%";n.style.position="relative";n.style.overflow="hidden";return n;};
VBI.Utilities.CreateGeoSceneCanvas=function(i,w,h,z,t,a){var n=document.createElement('canvas');n.id=i;n.m_pixelLeft=n.m_pixelTop=0;n.width=n.m_pixelWidth=w?w:512;n.height=n.m_pixelHeight=h?h:512;n.style.left=n.style.top="0px";n.style.width=n.m_pixelWidth+"px";n.style.height=n.m_pixelHeight+"px";n.style.position="absolute";n.style.zIndex=z;n.style.touchaction="none";n.className="vbi-geoscenecanvas";n.m_bNotInDOM=(a!=undefined?a:false);n.m_CanvasValid=!n.m_bNotInDOM;if(n.m_bNotInDOM)n.m_nMoveCount=0;if(t!=undefined)n.tabIndex=t;return n;};
VBI.Utilities.Align=['','left','center','','right'];
VBI.Utilities.CreateCaption=function(i,t,l,a,r,b,c,d,e,f){var n=document.createElement('div');n.id=i;n.style.left=l+"px";n.style.top=a+"px";n.style.width=(r-l).toString()+"px";n.style.height=(b-a).toString()+"px";n.style.textAlign=VBI.Utilities.Align[f];n.style.title=c;switch(e){case 3:n.style.fontSize="14px";n.style.fontWeight="bold";break;}n.className="vbi-2d-caption vbi-2d-common";n.innerHTML=t;return n;};
VBI.Utilities.CreateLabel=function(i,t,l,a,r,b,c,d){var n=document.createElement('div');n.id=i;n.style.left=l+"px";n.style.top=a+"px";n.style.width=(r-l).toString()+"px";n.style.height=(b-a).toString()+"px";n.style.textAlign=VBI.Utilities.Align[d];n.style.title=c;n.className="vbi-2d-label vbi-2d-common";n.innerHTML=t;return n;};
VBI.Utilities.CreateLink=function(i,t,l,a,r,b,h,c,d){var n=document.createElement('a');n.id=i;n.style.left=l+"px";n.style.top=a+"px";n.style.width=(r-l).toString()+"px";n.style.height=(b-a).toString()+"px";n.style.textAlign=VBI.Utilities.Align[d];n.className="vbi-2d-link vbi-2d-common";n.href=h?h:"javascript:void(0)";n.title=c;n.innerHTML=t;return n;};
VBI.Utilities.CreateImage=function(i,a,l,t,r,b,c,d){var n=a.cloneNode(true);n.id=i;n.style.left=l+"px";n.style.top=t+"px";n.style.width=(r-l).toString()+"px";n.style.height=(b-t).toString()+"px";n.style.textAlign=VBI.Utilities.Align[d];n.className="vbi-2d-image vbi-2d-common";n.title=c;return n;};
VBI.Utilities.CreateButton=function(i,t,l,a,r,b,c,d){var n=document.createElement('button');n.id=i;n.style.left=l+"px";n.style.top=a+"px";n.style.width=(r-l).toString()+"px";n.style.height=(b-a).toString()+"px";n.style.textAlign=VBI.Utilities.Align[d];n.className="vbi-2d-button vbi-2d-common";n.innerHTML=t;n.title=c;return n;};
VBI.Utilities.CreateContainer=function(i,k,l,t,w,h,a,z){var n=document.createElement('div');n.id=i;n.style.left=l+"px";n.style.top=t+"px";n.style.zIndex=z;n.title=a;n.style.position="absolute";n.className="vbi-container-vo";n.m_Key=k;return n;};
VBI.Utilities.CreateCallout=function(i,l,t,w,h,z){var n=document.createElement('div');n.id=i;n.style.left=l+"px";n.style.top=t+"px";if(w)n.style.width=w?(w+"px"):"512px";if(h)n.style.height=h?(h+"px"):"300px";n.style.position="absolute";n.style.zIndex=z;n.className="vbi-callout";var a=document.createElement('div');a.id=i+"-window-content";a.style.position="relative";a.style.left="0px";a.style.top="0px";a.style.width="100%";a.style.height="100%";a.className="vbi-callout-content";var b=document.createElement('div');b.id=i+"-window-closebutton";b.className="vbi-callout-closebutton";n.appendChild(a);n.appendChild(b);var c;c=document.createElement('b');c.className="vbi-notch vbi-down";n.appendChild(c);c=document.createElement('b');c.className="vbi-border-notch vbi-notch";n.appendChild(c);return{m_Div:n,m_Content:a,m_CloseButton:b,GetAnchorPoint:function(){return[50,(style.paddingTop?parseInt(style.paddingTop):0)+(style.paddingBottom?parseInt(style.paddingBottom):0)+(style.height?parseInt(style.height):0)+(style.borderTop?parseInt(style.borderTop):0)+(style.borderBottom?parseInt(style.borderBottom):0)+ +40];}};};
VBI.Utilities.CreateDetailPhone=function(i,l,t,w,h,a,z,p){var d=document.createElement('div');d.id=i;d.style.left=l+"px";d.style.top=t+"px";d.style.zIndex=z;var b=12;var s=6;var c=14;b=VBI.Utilities.RemToPixel(0.750);s=VBI.Utilities.RemToPixel(0.375);c=VBI.Utilities.RemToPixel(0.875);if(h)d.style.minHeight=h+c+4+s+2*b+"px";d.className=".vbi-detail vbi-detail-phone";var e=document.createElement('div');e.id=i+"-window-header";e.className="vbi-detail-header-phone";d.appendChild(e);var f=document.createElement('div');f.id=i+"-window-title";f.className="vbi-detail-title-phone";f.innerHTML=a;e.appendChild(f);var g=document.createElement('div');g.id=i+"-window-close";g.className="vbi-detail-closebutton vbi-detail-closebutton-tablet";e.appendChild(g);var j=document.createElement('div');j.id=i+"-window-content";j.className="vbi-detail-content";j.style.fontSize=VBI.Utilities.RemToPixel(0.875)+"px";d.appendChild(j);return{m_Div:d,m_Content:j,m_CloseButton:g,m_Arrow:null,GetAnchorPoint:null};};
VBI.Utilities.CreateDetail=function(i,l,t,w,h,a,z,p){if(VBI.m_bIsPhone)return(VBI.Utilities.CreateDetailPhone(i,l,t,w,h,a,z,p));var d=document.createElement('div');d.id=i;d.style.left=l+"px";d.style.top=t+"px";d.style.zIndex=z;var P=VBI.m_bIsPhone;if(!P){var b=16;var s=16;var c=16;b=VBI.Utilities.RemToPixel(1);s=VBI.Utilities.RemToPixel(1);c=VBI.Utilities.RemToPixel(1);if(w)d.style.width=w+2*b+"px";if(h)d.style.minHeight=h+c+4+s+2*b+"px";}else{var e=12;var f=6;var g=14;e=VBI.Utilities.RemToPixel(0.750);f=VBI.Utilities.RemToPixel(0.375);g=VBI.Utilities.RemToPixel(0.875);if(h)d.style.minHeight=h+g+4+f+2*e+"px";}d.className="vbi-detail vbi-detail-border";var j=document.createElement('div');j.id=i+"-window-header";j.className="vbi-detail-header";d.appendChild(j);var k=document.createElement('div');k.id=i+"-window-title";k.className="vbi-detail-title";k.innerHTML=a;j.appendChild(k);var m=document.createElement('div');m.id=i+"-window-close";var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.vbm");m.title=r.getText("WINDOW_CLOSE");if(VBI.m_bIsMobile)m.className="vbi-detail-closebutton vbi-detail-closebutton-tablet";else m.className="vbi-detail-closebutton vbi-detail-closebutton-desktop";j.appendChild(m);var n=document.createElement('div');n.id=i+"-window-content";n.className="vbi-detail-content";d.appendChild(n);var o;o=document.createElement('b');o.className="vbi-detail-arrow vbi-detail-left";o.style.zIndex=z+1;if(!P)d.appendChild(o);var q=document.createElement('b');q.className="vbi-detail-arrow vbi-detail-left vbi-detail-border-arrow";q.style.zIndex=z;if(!P)d.appendChild(q);return{m_Div:d,m_Content:n,m_CloseButton:m,m_Arrow:o,GetAnchorPoint:function(){return[this.m_Arrow.offsetLeft,this.m_Arrow.offsetTop+this.m_Arrow.offsetHeight/2];}};};
VBI.Utilities.CreateLegendPhone=function(i,l,t,w,h,a,z,p){};
VBI.Utilities.CreateLegend=function(i,r,t,a,z,p){var l=document.createElement('div');l.id=i;l.style.right=r+"px";l.style.top=t+"px";l.style.zIndex=z;l.className="vbi-legend vbi-legend-border";var b=document.createElement('div');b.id=i+"-button-collapse";var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.vbm");b.title=R.getText("LEGEND_COLLAPSE");b.className="vbi-legend-button vbi-legend-button-col";l.appendChild(b);var c=document.createElement('div');c.id=i+"-button-expand";var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.vbm");c.title=R.getText("LEGEND_EXPAND");c.className="vbi-legend-button vbi-legend-button-exp";l.appendChild(c);c.style.visibility='hidden';var h=document.createElement('div');h.id=i+"-header";h.className="vbi-legend-header";l.appendChild(h);var d=document.createElement('div');d.id=i+"-title";d.className="vbi-legend-title";d.innerHTML=a;h.appendChild(d);var e=document.createElement('div');e.id=i+"-content";e.className="vbi-legend-content";l.appendChild(e);var f=document.createElement('table');f.id=i+"-table";f.className="vbi-legend-table";e.appendChild(f);return{m_Div:l,m_Header:h,m_Content:e,m_Table:f,m_ButtonCol:b,m_ButtonExp:c};};
VBI.Utilities.CreateGeoSceneDivCSS=function(i,c,t){var n=document.createElement('div');n.id=i;n.className=c;if(t)n.title=t;return n;};
VBI.Utilities.CreateDOMColorShiftedImageFromData=function(d,i,c,e,l){var f=null,h=c?VBI.Types.string2rhls(c):null;if(!h)f=c?VBI.Types.string2rgba(c):null;var j=null,k=e?VBI.Types.string2rhls(e):null;if(!k)j=e?VBI.Types.string2rgba(e):null;var t=document.createElement('img');var m=document.createElement('img');if(l){t.onload=function(){if(typeof l==='function')l(t);this.onload=null;};m.onload=function(){var n=document.createElement("canvas");var o=n.getContext("2d");n.width=m.width;n.height=m.height;o.drawImage(m,0,0,m.naturalWidth,m.naturalHeight,0,0,m.width,m.height);var p=o.getImageData(0,0,m.width,m.height);var d=p.data;function q(d,v,w,x){var r=d[v];var g=d[v+1];var b=d[v+2];var a=d[v+3];if(w){var y=VBI.Utilities.RGB2HLS(r,g,b);var z=VBI.Utilities.HLS2RGB(y[0]+w[0],y[1]*w[1],y[2]*w[2]);d[v]=Math.min(Math.round(z[0]),255);d[v+1]=Math.min(Math.round(z[1]),255);d[v+2]=Math.min(Math.round(z[2]),255);d[v+3]=Math.min(Math.round(w[3]*a),255);}else if(x){d[v]=x[0];d[v+1]=x[1];d[v+2]=x[2];if(d[v+3])d[v+3]=x[4]?Math.floor(Math.min(x[3]*255,255)):255;}};for(var s=0,u=(m.width*m.height);s<u;++s){var v=s*4;if(h||f)q(d,v,h,f);if(k||j)q(d,v,k,j);}o.putImageData(p,0,0);t.src=n.toDataURL("image/png");this.onload=null;};}if(d.indexOf("data:image")==0)m.src=d;else m.src="data:image"+i+";base64,"+d;return t;};
VBI.Utilities.CreateDOMImageFromData=function(d,i,l){var a=document.createElement('img');if(l){a.onload=function(){if(typeof l==='function')l(a);this.onload=null;};}if(d.indexOf("data:image")==0)a.src=d;else a.src="data:image"+i+";base64,"+d;return a;};
VBI.Utilities.PtOnRect=function(p,r){return((p[0]>=r[0])&&(p[0]<=r[2])&&(p[1]>=r[1])&&(p[1]<=r[3]))?true:false;};
VBI.Utilities.PtInRect=function(p,r){return((p[0]>r[0])&&(p[0]<r[2])&&(p[1]>r[1])&&(p[1]<r[3]))?true:false;};
VBI.Utilities.RectIntersect=function(r,a){return!(a[0]>r[2]||a[2]<r[0]||a[3]<r[1]||a[1]>r[3]);};
VBI.Utilities.RectOffset=function(r,n,a){r[0]+=n;r[1]+=a;r[2]+=n;r[3]+=a;};
VBI.Utilities.cImg;
VBI.Utilities.GetImagePixelData=function(i){if(!VBI.Utilities.cImg){VBI.Utilities.cImg=document.createElement('canvas');}VBI.Utilities.cImg.width=i.naturalWidth;VBI.Utilities.cImg.height=i.naturalHeight;VBI.Utilities.cImg.style.width=(i.naturalWidth+"px");VBI.Utilities.cImg.style.height=(i.naturalHeight+"px");VBI.Utilities.cImg.style.top="0px";VBI.Utilities.cImg.style.left="0px";VBI.Utilities.cImg.style.position="absolute";var c=VBI.Utilities.cImg.getContext("2d");c.drawImage(i,0,0);var a=c.getImageData(0,0,VBI.Utilities.cImg.width,VBI.Utilities.cImg.height);return a;};
VBI.Utilities.pointOnLine=function(p,x,y,d,c){function s(v,e){return((v[0]-e[0])*(v[0]-e[0])+(v[1]-e[1])*(v[1]-e[1]));};var r=-1,n=-1,a=d*d,b=a;var t,v,e;var f=VBI.Utilities.sqDistance;for(var g=0,l=p.length-1;g<l;++g){v=p[g];e=p[g+1];if((t=f(v[0],v[1],e[0],e[1],x,y))<a){a=t;r=g;}}if(r>=0){if((t=s([x,y],p[r]))<b){b=t;n=r;}if(s([x,y],p[r+1])<b){b=t;n=r+1;}}if(c&&(l>0)){v=p[0];e=p[l];if((t=f(v[0],v[1],e[0],e[1],x,y))<a){a=t;r=g;}if(r>=0){if((t=s([x,y],p[r]))<b){b=t;n=r;}if(s([x,y],p[0])<b){b=t;n=0;}}}return{m_edge:r,m_node:n};};
VBI.Utilities.pointInPolygon=function(p,x,y){var v,a,b=p.length;if(jQuery.type(p[0])=='array'){for(var c=false,n=-1,l=b,d=l-1;++n<l;d=n){v=p[n];a=p[d];((v[1]<=y&&y<a[1])||(a[1]<=y&&y<v[1]))&&(x<(a[0]-v[0])*(y-v[1])/(a[1]-v[1])+v[0])&&(c=!c);}}else{for(var c=false,n=0,l=b,d=l-2;n<=l-2;n+=2){v=[p[n],p[n+1]];a=[p[d],p[d+1]];((v[1]<=y&&y<a[1])||(a[1]<=y&&y<v[1]))&&(x<(a[0]-v[0])*(y-v[1])/(a[1]-v[1])+v[0])&&(c=!c);d=n;}}return c;};
VBI.Utilities.pointInTriangle=function(t,p){var a=t[2][0]-t[0][0];var b=t[2][1]-t[0][1];var c=t[1][0]-t[0][0];var d=t[1][1]-t[0][1];var e=p[0]-t[0][0];var f=p[1]-t[0][1];var g=a*a+b*b;var h=a*c+b*d;var i=a*e+b*f;var j=c*c+d*d;var k=c*e+d*f;var n=1/(g*j-h*h);var u=(j*i-h*k)*n;var v=(g*k-h*i)*n;return((u>=0)&&(v>=0)&&(u+v<1));};
VBI.Utilities.INSIDE=0;VBI.Utilities.LEFT=1;VBI.Utilities.RIGHT=2;VBI.Utilities.BOTTOM=4;VBI.Utilities.TOP=8;
VBI.Utilities.ComputeOutCode=function(x,y,r){var a=r[0];var b=r[2];var c=r[1];var d=r[3];var e=VBI.Utilities.INSIDE;if(x<a)e|=VBI.Utilities.LEFT;else if(x>b)e|=VBI.Utilities.RIGHT;if(y<c)e|=VBI.Utilities.BOTTOM;else if(y>d)e|=VBI.Utilities.TOP;return e;};
VBI.Utilities.LineIntersectRect=function(a,b,c,d,r){var R={};var e=r[0];var f=r[2];var g=r[1];var h=r[3];var n=VBI.Utilities.ComputeOutCode(a,b,r);var i=VBI.Utilities.ComputeOutCode(c,d,r);var A=false;while(true){if(!(n|i)){A=true;break;}else if(n&i){break;}else{var x,y;var j=n?n:i;if(j&VBI.Utilities.TOP){x=a+(c-a)*(h-b)/(d-b);y=h;}else if(j&VBI.Utilities.BOTTOM){x=a+(c-a)*(g-b)/(d-b);y=g;}else if(j&VBI.Utilities.RIGHT){y=b+(d-b)*(f-a)/(c-a);x=f;}else if(j&VBI.Utilities.LEFT){y=b+(d-b)*(e-a)/(c-a);x=e;}if(j==n){a=x;b=y;n=VBI.Utilities.ComputeOutCode(a,b,r);}else{c=x;d=y;i=VBI.Utilities.ComputeOutCode(c,d,r);}}}R.bReturn=false;if(A){R.x0=a;R.y0=b;R.x1=c;R.y1=d;R.bReturn=true;}return R;};
VBI.Utilities.LineLineIntersection=function(p,a,q,b){var A=a[1]-p[1];var B=p[0]-a[0];var C=A*p[0]+B*p[1];var c=b[1]-q[1];var d=q[0]-b[0];var e=c*q[0]+d*q[1];var f=A*d-c*B;if(!f)return null;return[(d*C-B*e)/f,(A*e-c*C)/f];};
VBI.Utilities.IsClockwise=function(p){var l=p.length;if(p.length%2)l-=1;var x,a,y,b,z;z=0;x=p[l-2];y=p[l-1];for(var n=0;n<l;n+=2){a=p[n];b=p[n+1];z+=(a-x)*(b+y);x=a;y=b;}return(z<0);};
VBI.Utilities.GetClippedPolygon=function(p,X,r){var o=X;var a=p.slice(0);var i=[];for(var n=0;n<=3;++n,o=0){i=a.slice(0);a=[];var t=[i[i.length-2],i[i.length-1]];var S=[t[0]+o,t[1]];for(var b=0;b<=i.length-2;b+=2){t=[i[b],i[b+1]];var E=[t[0]+o,t[1]];var e=false;var s=false;var c=[];switch(n){case 0:e=(E[1]>r[1]);s=(S[1]>r[1]);c=[[r[0],r[1]],[r[2],r[1]]];break;case 1:e=(E[0]<r[2]);s=(S[0]<r[2]);c=[[r[2],r[1]],[r[2],r[3]]];break;case 2:e=(E[1]<r[3]);s=(S[1]<r[3]);c=[[r[0],r[3]],[r[2],r[3]]];break;case 3:e=(E[0]>r[0]);s=(S[0]>r[0]);c=[[r[0],r[1]],[r[0],r[3]]];break;default:break;}if(e){if(!s){var d=VBI.Utilities.LineLineIntersection(S,E,c[0],c[1]);if(d)a.push(d[0],d[1]);}a.push(E[0],E[1]);}else if(s){var d=VBI.Utilities.LineLineIntersection(S,E,c[0],c[1]);if(d)a.push(d[0],d[1]);}S=[E[0],E[1]];}}return a;};
VBI.Utilities.GetBarycenterForPolygon=function(p,o){var a=p.slice(0);var b=[a[0],a[1]];var c=[a[a.length-2],a[a.length-1]];if(b!=c){a.push(a[0],a[1]);}var N=a.length-2;var s=0;var A=0;var d;var e;for(var n=0;n<N;n+=2){s+=((a[n]+o)*a[n+3]-(a[n+2]+o)*a[n+1]);}A=s/2;if(A){s=0;for(var n=0;n<N;n+=2){s+=(a[n]+o+a[n+2]+o)*((a[n]+o)*a[n+3]-(a[n+2]+o)*a[n+1]);}d=s/(A*6);s=0;for(var n=0;n<N;n+=2){s+=(a[n+1]+a[n+3])*((a[n]+o)*a[n+3]-(a[n+2]+o)*a[n+1]);}e=s/(A*6);}if(d&&e)return[d,e];return null;};
VBI.Utilities.GetMidpointForPolygon=function(p,b,X,r){var o=X;var l=[];var a=b[0];var c=b[1];var d=VBI.Utilities.PtInRect([a[0]+o,a[1]],r);var e=VBI.Utilities.PtInRect([c[0]+o,c[1]],r);if(!d||!e){p=VBI.Utilities.GetClippedPolygon(p,o,r);o=0;}var f=VBI.Utilities.GetBarycenterForPolygon(p,o);if(f){var g=VBI.Utilities.getNextPoint(f[0],f[1],p,o);l.push(g);return{max:0,aPos:l};}return null;};
VBI.Utilities.GetClippedPolygons=function(p,o,r){var c=[];var d=p.slice(0);var n=d.length;var e=n-2;var z=VBI.Utilities.IsClockwise(p);if(z>0)d.push(r[0],r[1],r[2],r[1],r[2],r[3],r[0],r[3]);else d.push(r[0],r[1],r[0],r[3],r[2],r[3],r[2],r[1]);var g=d.length;var E=[];var L=[];var i=[];var h=[];for(var j=0;j<n;j+=2)i.push(j);var k,m,q,s;k=[d[e]+o,d[e+1]];for(var t=e,j=0;j<=e;j+=2){m=[d[j]+o,d[j+1]];var R=VBI.Utilities.LineIntersectRect(k[0],k[1],m[0],m[1],r);var u=[R.x0,R.y0];var v=[R.x1,R.y1];var w=null;if(R.bReturn==true){if((R.x0!=k[0]||R.y0!=k[1])&&(R.x1!=m[0]||R.y1!=m[1])){if(!(R.x0==R.x1&&R.y0==R.y1)){var f=d.push(R.x0,R.y0);var l=d.push(R.x1,R.y1);E.push(f-2);L.push(l-2);var I=i.indexOf(j);i.splice(I,0,f-2,l-2);}}else if(R.x0!=k[0]||R.y0!=k[1]){if(R.x0!=m[0]||R.y0!=m[1]){var l=d.push(R.x0,R.y0);E.push(l-2);var I=i.indexOf(j);i.splice(I,0,l-2);}}else if(R.x1!=m[0]||R.y1!=m[1]){var l=d.push(R.x1,R.y1);L.push(l-2);var I=i.indexOf(j);i.splice(I,0,l-2);}}k=m;t=j;}for(var j=n,x=0;x<4;j+=2,++x){var y=[];h.push(j);q=[d[j],d[j+1]];if(x==3)s=[d[n],d[n+1]];else s=[d[j+2],d[j+3]];var A=(q[0]==s[0])?1:0;var B=A?0:1;for(var C=g;C<=d.length-2;C+=2){if(d[C+B]==q[B]){y.push({pt:d[C+A],idx:C});}}if(x<2)y.sort(function(a,b){return a.pt-b.pt});else y.sort(function(a,b){return b.pt-a.pt});for(var D=0;D<y.length;++D){h.push(y[D].idx);}q=s;}for(var j=n;j<=d.length-2;j+=2)d[j]-=o;for(var j=0;j<E.length;++j){var F=[];var G=E[j];var H=i.indexOf(E[j]);var J=i;var K=h;var M=L;var N=E;F.push(d[E[j]],d[E[j]+1]);var O=0;while(true){H++;if(H>J.length-1)H=0;if(J[H]==G){c.push(F);break;}F.push(d[J[H]],d[J[H]+1]);var I=M.indexOf(J[H]);if(I>-1){O++;H=K.indexOf(J[H]);var P=J;J=K;K=P;P=M;M=N;N=P;}}}return c;};
VBI.Utilities.GetMidpointsForPolygon=function(p,b,X,r){var a=[];var o=X;var l=[];var c=b[0];var d=b[1];if(VBI.Utilities.RectIntersect([c[0]+o,c[1],d[0]+o,d[1]],r)){var e=VBI.Utilities.PtOnRect([c[0]+o,c[1]],r);var f=VBI.Utilities.PtOnRect([d[0]+o,d[1]],r);if(!e||!f){a=VBI.Utilities.GetClippedPolygons(p,o,r);if(!a.length){var m=[r[0]+(r[2]-r[0])/2,r[1]+(r[3]-r[1])/2];if(VBI.Utilities.pointInPolygon(p,m[0],m[1]))l.push(m);}}else a.push(p);for(var n=0;n<a.length;++n){var g=VBI.Utilities.GetBarycenterForPolygon(a[n],o);if(g){var h=VBI.Utilities.getNextPoint(g[0],g[1],a[n],o);l.push(h);}}if(l.length>0)return{max:0,aPos:l};}return null;};
VBI.Utilities.GetMidpointsForLine=function(p,o,r){var l=[];var R={};var a=[Number.MAX_VALUE,Number.MAX_VALUE];var O=false;var s;var S=[];if(p.length>5){for(var n=0;n<=p.length-6;n+=3){var x=p[n];var y=p[n+1];var b=p[n+3];var c=p[n+4];R=VBI.Utilities.LineIntersectRect(x+o,y,b+o,c,r);if(R.bReturn==true){if(s&&O&&(R.x0!=a[0]||R.y0!=a[1])){S.push(s);O=false;}if(!O){s=new Array;s.push(R.x0);s.push(R.y0);O=true;}s.push(R.x1);a[0]=R.x1;s.push(R.y1);a[1]=R.y1;}else{if(O){S.push(s);O=false;}}}if(O){S.push(s);O=false;}}var m=0;var d=0;for(var e=0;e<S.length;e++){var f=S[e];if(f.length>3){var t=0.0;var L;var v=[];for(var n=0;n<=f.length-4;n+=2){L=Math.sqrt(Math.pow(f[n+2]-f[n],2)+Math.pow(f[n+3]-f[n+1],2));t+=L;v.push(L);}var g=t;var h=t/2;var i=-1;var M=0.0;for(var n=v.length-1;n>=0;n--){t-=v[n];if(t<=h){M=h-t;i=n;break;}}if(i>-1){var j=[f[i*2+2]-f[i*2],f[i*2+3]-f[i*2+1]];var k=Math.sqrt(Math.pow(j[0],2)+Math.pow(j[1],2));var q=[j[0]/k,j[1]/k];var u=[q[0]*M,q[1]*M];l.push([f[i*2]+parseInt(u[0]),f[i*2+1]+parseInt(u[1])]);if(g>m){m=g;d=e;}}}}return{max:d,aPos:l};};
VBI.Utilities.updateBoundRect=function(a,r){var x,n=a.length;var m=r[0];var b=r[2];var c=r[1];var d=r[3];for(var e=0;e<n;++e){x=a[e];if(m>x[0])m=x[0];if(b<x[0])b=x[0];if(c>x[1])c=x[1];if(d<x[1])d=x[1];}r[0]=m;r[2]=b;r[1]=c;r[3]=d;};
VBI.Utilities.inflateRect=function(r,v){r[0]-=v;r[1]-=v;r[2]+=v;r[3]+=v;};
VBI.Utilities.sqDistance=function(x,y,a,b,c,d){var p=a-x;var e=b-y;var s=p*p+e*e;if(!s)return(c-x)*(c-x)+(d-y)*(d-y);var u=((c-x)*p+(d-y)*e)/s;if(u>1)u=1;else if(u<0)u=0;var f=x+u*p-c;var g=y+u*e-d;return f*f+g*g;};
VBI.Utilities.getNextPoint=function(x,y,p,o){var v,a,b=p.length;var d=[];var e=[];for(var c=false,n=0,l=b,f=l-2;n<=l-2;n+=2){v=[p[n]+o,p[n+1]];a=[p[f]+o,p[f+1]];var s=0;var r=[];var A=x-v[0];var B=y-v[1];var C=a[0]-v[0];var D=a[1]-v[1];var g=A*C+B*D;var h=C*C+D*D;if(!h){s=(x-v[0])*(x-v[0])+(y-v[1])*(y-v[1]);r=[v[0],v[1]];}else{var i=g/h;if(i<0){r=[v[0],v[1]];}else if(i>1){r=[a[0],a[1]];}else{r=[v[0]+i*C,v[1]+i*D];}var j=x-(v[0]+i*C);var k=y-(v[1]+i*D);s=(j*j+k*k);}d.push(r);e.push(s);((v[1]<=y&&y<a[1])||(a[1]<=y&&y<v[1]))&&(x<(a[0]-v[0])*(y-v[1])/(a[1]-v[1])+v[0])&&(c=!c);f=n;}if(c){return[x,y];}else{var m=10000;var q=-1;if(e.length){for(var n=0;n<e.length;++n){if(e[n]<m){q=n;m=e[n];}}if(q>-1){return(d[q]);}}return([p[0]+o,p[1]]);}};
VBI.Utilities.DrawSelectIndicator=function(c,p){var r=4;c.lineWidth=1;c.strokeStyle='rgba( 0, 0, 0, 1.0 )';c.fillStyle='rgba( 10, 10, 255, 1.0 )';c.beginPath();c.arc(p[0],p[1],r,0,2*Math.PI);c.closePath();c.fill();c.stroke();};
VBI.Utilities.DrawDesignRect=function(c,a,p,b,d,e){var x,y,r=3,D=c.setLineDash?true:false;c.save();c.lineWidth=1;c.strokeStyle='rgba( 0, 0, 0, 1.0 )';if(typeof p=='object'){var w=p[2]-p[0];var h=p[3]-p[1];var f=w/2;var g=h/2;if(D)c.setLineDash([1,2]);c.strokeRect(p[0],p[1],w,h);var i='rgba( 255, 255, 255, 1.0 )';var j='rgba( 128, 128, 128, 1.0 )';if(D)c.setLineDash([0,0]);c.fillStyle=i;for(x=0;x<3;++x)for(y=0;y<3;++y){if(!a[y*3+x])c.fillStyle=j;else c.fillStyle=i;if(x==1&&y==1)continue;c.beginPath();c.arc(p[0]+x*f,p[1]+y*g,r,0,2*Math.PI);c.closePath();c.fill();c.stroke();}}else{c.strokeRect(p-1,b-1,d-p,e-b);c.strokeStyle='rgba( 255, 255, 255, 1.0 )';c.strokeRect(p,b,d-p,e-b);}c.restore();};
VBI.Utilities.DrawFrameRect=function(c,a,p,b,d,e){c.lineWidth=1;c.strokeStyle=a;if(typeof p=='object')c.strokeRect(p[0],p[1],p[2]-p[0],p[3]-p[1]);else c.strokeRect(p,b,d-p,e-b);};
VBI.Utilities.AssembleCopyrightString=function(C,a,b){var r=/\{LINK\|IMG\}/;var c=/\{IMG\}/;var d=/\{LINK\|([^\}]+)\}/;if(C){var t=C.replace(r,"<a href='"+a+"'><img src='"+b+"' width='10' height='10' border='none'></a>");t=t.replace(c,"<img src='"+b+"' width='10' height='10' border='none' >");return t.replace(d,"<a  href='"+a+"'>$1</a>");}return C;};
VBI.Utilities.DrawTrackingRect=function(c,p,a,b,d){c.save();c.strokeStyle='black';c.lineWidth=1;if(c.setLineDash)c.setLineDash([1,2]);c.beginPath();c.rect(p,a,b-p,d-a);c.stroke();c.fillStyle='rgba( 0, 192, 192, 0.2 )';c.fill();c.restore();};
VBI.Utilities.RGB2HLS=function(r,g,b){r/=255.0,g/=255.0,b/=255.0;var m=Math.max(r,g,b);var a=Math.min(r,g,b);var h=0,s,l=(m+a)/2;if(m==a){h=s=0;}else{var d=m-a;s=l>0.5?d/(2-m-a):d/(m+a);switch(m){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6;}return[h,l,s];};
VBI.Utilities.HLS2RGB=function(h,l,s){var r=0,g=0,b=0;if(s==0){r=g=b=l;}else{function H(p,q,t){if(t<0)t+=1;else if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=H(p,q,h+1/3);g=H(p,q,h);b=H(p,q,h-1/3);}return[r*255,g*255,b*255];};
VBI.Utilities.RemToPixel=function(v){return v*parseFloat(getComputedStyle(document.documentElement).fontSize);};
VBI.Utilities.ColorHex2rgba=function(h){var c=h.charAt(0)==="#"?h.substring(1,7):h;return'rgba('+parseInt(c.substring(0,2),16)+','+parseInt(c.substring(2,4),16)+','+parseInt(c.substring(4,6),16)+',1.0)';};
VBI.Clustering=function(t){var f={};var D={};var E=1.0/1048576.0;f.m_Clusters=[];f.m_Clustergroups=[];f.m_loadCount=0;f.m_Parser=VBI.Parser();f.clear=function(){f.m_Clusters=[];};f.load=function(d,c){if(d.Set){f.clear();f.m_Parser.clear();f.m_loadCount++;var r=d.Set.Cluster;f.m_cellColor=d.Set.cellColor;f.m_bDelaunay=(d.Set.delaunay!=undefined);f.m_bShowGrid=(f.m_cellColor!=undefined);if(jQuery.type(r)=='object'){var a=new VBI.Clustering.Cluster();a.load(r,c,f.m_Clusters.length);f.m_Clusters.push(a);f.UpdateAutomaticClusterGroup(a.m_groupID);}else if(jQuery.type(r)=='array'){var b=f.m_Clusters.length;for(var n=0,l=r.length;n<l;++n){var a=new VBI.Clustering.Cluster();a.load(r[n],c,b++);f.m_Clusters.push(a);f.UpdateAutomaticClusterGroup(a.m_groupID);}}for(var n=0,l=f.m_Clustergroups.length;n<l;++n)f.m_Clusters.push(f.m_Clustergroups.shift());}};f.InvalidatePreassembledData=function(s,n){if(!s.m_PreassembledData)return;var p=s.m_PreassembledData;var a=p.m_ClusterColumns['distance'].length;var b=p.m_ClusterColumns['tree'].length;if((a==0)||(b==0)||(p.m_lod!=n)||(p.m_version!=f.m_loadCount))s.m_PreassembledData=undefined;else p.bGridDataInvalidated=true;};f.UpdateAutomaticClusterGroup=function(g){if(g=="")return;var a=f.m_Clusters[f.m_Clusters.length-1];var n,b;for(var c=0,l=f.m_Clustergroups.length;c<l;++c){var d=f.m_Clustergroups[c];if(d.m_id==g)n=c;}if(n!=undefined){var h=f.m_Clustergroups[n];h.m_limit=Math.min(a.m_limitOnSum,h.m_limit);a.m_bPartOfGrp=true;}else{for(var c=0,l=f.m_Clusters.length-1;c<l;++c){var d=f.m_Clusters[c];if((d.m_type=="grid")&&(d.m_groupID==g))b=c;}if(b!=undefined){var o=f.m_Clusters[b];var h=new VBI.Clustering.Cluster();h.m_type="clustergroup";h.m_id=g;h.m_dividerX=o.m_dividerX;h.m_dividerY=o.m_dividerY;h.m_limit=Math.min(a.m_limitOnSum,o.m_limitOnSum);h.initializeFunctions();f.m_Clustergroups.push(h);a.m_bPartOfGrp=o.m_bPartOfGrp=true;}}};f.PreassembleDataForVO=function(s,r,a,v,c){if(node=v.m_DataSource.GetCurrentNode(c)){var I=v.m_ID;for(nL=0;nL<node.m_dataelements.length;++nL){v.m_DataSource.Select(nL);var o=v.m_Pos.GetValueVector(c);var u=s.GetPointFromPos(o,true);var n=f.m_Parser.evaluate(v,a,c);var b=(n>=0)&&(f.m_Clusters[n].m_type=="distance");var d=(n>=0)&&(f.m_Clusters[n].m_type=="tree");if(u.m_bVisible||b||d){u.orgPos=o;u.h=v.BaseIsHot(nL,c);u.hscale=v.GetHotScale(c);u.hcol=v.m_HotDeltaColor.GetValueString(c);if(u.s=v.IsSelected(c)){u.scol=v.m_SelectColor.GetValueString(c);u.simag=v.m_ImageSelected.GetValueString(c);}if(u.im==undefined)u.im=v.m_Image.GetValueString(c);u.tx=v.m_Text.GetValueString(c);u.sc=v.m_Scale.GetValueVector(c);u.m_ID=I;u.nI=nL;u.b2Ignore=false;u.cl=n;if(b)r[a].containsDistClust=true;else if(d)r[a].containsTreeClust=true;else r[a].containsGridClust=true;r[a].push(u);}}}};f.InitializeResultVector=function(o,n,l){var R;if(true){R=[];for(var i=0;i<n;++i){var a=[];R.push(a);}R.bShowGrid=f.m_bShowGrid;R.m_version=f.m_loadCount;R.m_lod=l;R.m_SelectedVOs=[];R.m_ClusterColumns=[];R.m_ClusterColumns['grid']=[];R.m_ClusterColumns['distance']=[];R.m_ClusterColumns['tree']=[];}return R;};f.CheckNonClusteredVOs=function(R,C){for(var n=0;n<R.length;++n){var v=R[n];var c=0;for(nJ=0,vl=v.length;nJ<vl;++nJ){var a=v[nJ];if(a.isCl!=true){if((a.cl!=undefined)&&(a.sq!=undefined)&&(C[a.cl])[a.sq].b2Cluster)a.b2Ignore=true;if(!a.b2Ignore){a.bbInd=c;if(a.h)R.HotItemBBIndex=c;if(a.s)R.m_SelectedVOs.push({m_vo:n,m_index:nJ,m_dataIndex:nL,m_BBIndex:c});c++;}}}v.m_NumVisVOs=c;}};f.FetchClusterVOData=function(r,v,c){var a=f.m_Clusters;var b=a.length;var d=[];for(var j=0;j<b;++j)d.push({});var n=v.length;for(var i=0;i<n;++i)for(var j=0;j<b;++j)if(v[i].m_ID==a[j].m_VO){d[j].m_index=i;d[j].m_image=v[i].m_Image.GetValueString(c);d[j].m_scale=v[i].m_Scale.GetValueVector(c);d[j].m_hotscale=v[i].m_HotScale.GetValueVector(c);d[j].m_hotcol=v[i].m_HotDeltaColor.GetValueString(c);r.m_ClusterColumns[a[j].m_type].push(i);if(a[j].m_type=='grid')d[j].m_isGridType=r[i].containsGridClust=true;if(a[j].m_type=='distance')d[j].m_isDistType=r[i].containsDistClust=true;if(a[j].m_type=='tree')d[j].m_isDistType=r[i].containsTreeClust=true;}return d;};f.FetchClusterGroupData=function(){var c=f.m_Clusters;var a=c.length;var r=[];for(var i=0;i<a;++i){var s=[];if(c[i].m_type=="clustergroup")for(var j=0;j<a;++j)if((i!=j)&&(c[i].m_id==c[j].m_groupID))s.push({index:j,limit:c[j].m_limit});r.push(s);}return r;};f.RecalculatePositions=function(s,r){for(i=0;i<r.length;++i){var a=r[i];for(j=0;j<a.length;++j){var m=a[j];var u=s.GetPointFromPos(m.orgPos,true);m[0]=u[0];m[1]=u[1];}}return r;};f.DoClustering=function(s,l,x,y,n,a,v,c,b){var o=s.m_PreassembledData;if(o&&(o.m_version==f.m_loadCount)&&(o.m_ClusterColumns['grid'].length==0))return f.RecalculatePositions(s,o);var d;var R=f.InitializeResultVector(o,v.length,l);var g=f.FetchClusterVOData(R,v,c);var h=f.FetchClusterGroupData();f.m_Parser.verifyAttributes(v,c);for(d=0;d<v.length;++d){var k=v[d];if(k.IsClusterable())f.PreassembleDataForVO(s,R,d,k,c);}var C=f.InitializeClusterData(s,l,n,a);for(d=0;d<f.m_Clusters.length;++d)f.m_Clusters[d].ClusterPass1(d,R,C);for(d=0;d<f.m_Clusters.length;++d)f.m_Clusters[d].ClusterPass2(d,R,C,h);var m=(C.gridBase==undefined)?undefined:C[C.gridBase];for(d=0;d<f.m_Clusters.length;++d)f.m_Clusters[d].DecisionPass(s,d,R,C,m,g,h);f.CheckNonClusteredVOs(R,C);return R;};f.InitializeClusterData=function(s,l,n,a){var C=[];var b=(1<<l);C.numTiles=b;C.completeX=b*s.m_nWidthCanvas/s.m_nTilesX;C.completeY=b*s.m_nHeightCanvas/s.m_nTilesY;var S=f.m_bShowGrid;for(nJ=0;nJ<f.m_Clusters.length;++nJ){var c=false;var d=f.m_Clusters[nJ];var g=(n+2)*d.m_dividerX;var h=(a+2)*d.m_dividerY;if(S&&(d.m_type=="grid"||d.m_type=="clustergroup")){S=false;c=true;C.gridBase=nJ;C.bGridClustering=true;}C.push(d.InitializeClusterData(s,g,h,c));}return C;};f.UpdatePreData4Selected=function(v,a,R,b,c){var d,s;if(R.m_SelectedVOs.length){var g=R.m_SelectedVOs[0];while((R.m_SelectedVOs.length)&&(g.m_index==a)&&(g.m_vo==v)){R.m_SelectedVOs.shift();g=R.m_SelectedVOs[0];}if(R.m_SelectedVOs.length){d=b[g.m_vo];d.m_DataSource.Select(g.m_dataIndex);if(!d.IsSelected(c)){for(var i=0,l=R.m_SelectedVOs.length;i<l;++i){g=R.m_SelectedVOs[0];(R[g.m_vo])[g.m_index].s=false;R.m_SelectedVOs.shift();}}}}var h=(R[v])[a];d=b[v];d.m_DataSource.Select(h.nI);if((s=d.IsSelected(c))){R.m_SelectedVOs.unshift({m_vo:v,m_index:a,m_dataIndex:h.nI,m_BBIndex:h.bbInd});h.scol=d.m_SelectColor.GetValueString(c);h.simag=d.m_ImageSelected.GetValueString(c);}h.s=s;};VBI.Clustering.Cluster=function(){var c={};c.m_additionalProperties=[];c.clear=function(){c.m_addProperties=null;};c.load=function(d,a,b){c.m_id=d.id;c.m_type=d.type;c.m_type2=d.type2;c.m_switch=parseInt(d.typeswitch);c.m_bPartOfGrp=false;c.m_VO=d.VO;c.m_order=parseInt(d.order);c.m_dispOffsetX=parseInt(d.offsetX);if(isNaN(c.m_dispOffsetX))c.m_dispOffsetX=0;c.m_dispOffsetY=parseInt(d.offsetY);if(isNaN(c.m_dispOffsetY))c.m_dispOffsetY=0;f.m_Parser.addFormula(b,d.rule==undefined?"":d.rule);c.m_textcolor=d.textcolor;if(c.m_textcolor==undefined)c.m_textcolor="rgba(0,0,0,0.7)";c.m_textfont=d.textfont;c.m_textfontscale=d.textfontscale;if(isNaN(c.m_textfontscale))c.m_textfontscale=2.0;c.m_textoffset=parseInt(d.textoffset);if(isNaN(c.m_textoffset))c.m_textoffset=0;if(c.m_type=="grid"){c.m_distanceX=((d.distanceX==undefined)||(d.distanceX<=0))?256:d.distanceX;c.m_dividerX=Math.max(1,Math.round(256/c.m_distanceX));c.m_distanceY=((d.distanceY==undefined)||(d.distanceY<=0))?256:d.distanceY;c.m_dividerY=Math.max(1,Math.round(256/c.m_distanceY));c.m_groupID=(d.groupID==undefined?"&":d.groupID)+c.m_dividerX+"_"+c.m_dividerY;c.m_omitEmpties=(d.showEmpties!="true");}if(c.m_type=="distance"){c.m_distance=d.distance;if(c.m_distance==undefined||c.m_distance<=0)c.m_distance=128;}if(c.m_type=="tree"){c.m_distance=d.distance;if(c.m_distance==undefined||c.m_distance<=0)c.m_distance=128;}c.m_limit=parseInt(d.limit);c.m_limitOnSum=d.limitOnSum==undefined?999999:parseInt(d.limitOnSum);c.initializeFunctions();};c.initializeFunctions=function(){switch(c.m_type){case"grid":c.InitializeClusterData=c.InitializeGridClusterData;c.ClusterPass1=c.gridClusteringCounting;c.ClusterPass2=c.NothingToDo;c.DecisionPass=c.gridBasedDecision;c.CheckClusterData=c.CheckSingleClusterData;break;case"clustergroup":c.InitializeClusterData=c.InitializeGridClusterData;c.ClusterPass1=c.NothingToDo;c.ClusterPass2=c.gridClustergroupCounting;c.DecisionPass=c.gridBasedDecision;c.CheckClusterData=c.CheckGroupClusterData;break;case"distance":c.InitializeClusterData=c.InitializeDistClusterData;c.ClusterPass1=c.NothingToDo;c.ClusterPass2=c.NothingToDo;c.DecisionPass=c.distanceBasedDecision;c.CheckClusterData=c.NothingToDo;break;case"tree":c.InitializeClusterData=c.InitializeTreeClusterData;c.ClusterPass1=c.NothingToDo;c.ClusterPass2=c.NothingToDo;c.DecisionPass=c.treeBasedDecision;c.CheckClusterData=c.NothingToDo;break;}};c.gridClusteringCounting=function(n,R,C){var m=C[n];var x=m.nX;var y=m.nY;var a=x*y;var b=c.m_dividerX*C.numTiles/C.completeX;var d=c.m_dividerY*C.numTiles/C.completeX;var g,h,k;var l,o,p;for(var q=0;q<R.length;++q){o=R[q];for(nJ=0;nJ<o.length;++nJ){p=o[nJ];if(p.cl==n){g=Math.floor((p[0])*b);h=Math.floor((p[1])*d);k=g+x*h;if((k>=0)&&(k<a)){p.sq=k;m[k].numInst++;}}}}};c.gridClustergroupCounting=function(n,R,C,g){var a,b;var m=g[n];var d=m.length;var h=C[n];for(nK=0;nK<h.length;++nK){var k=0;a=h[nK];a.bLimitExceeded=false;for(nL=0;nL<d;++nL){var l=m[nL].index;var o=C[l];var p=o[nK].numInst;k+=p;if(p>=m[nL].limit)a.bLimitExceeded=true;}a.numInst=k;}};c.distanceBasedDecision=function(s,n,R,C,b,a,g){var d=f.m_Clusters[n];distance=d.m_distance;var h=c.doDistClustering(n,R,distance,C.completeX);c.distFillClusterData(s,h,R,a[n]);};c.treeBasedDecision=function(s,n,R,C,b,a,g){var d=f.m_Clusters[n];distance=d.m_distance;var h=c.doTreeClustering(n,R,distance,C.completeX);c.treeFillClusterData(s,h,R,a[n]);};c.gridBasedDecision=function(s,n,R,C,b,a,g){var d=f.m_Clusters[n];if(!d.m_bPartOfGrp){clustsq=C[n];for(var x=0;x<clustsq.nX;++x){for(var y=0;y<clustsq.nY;++y){nJ=x+clustsq.nX*y;var S=(b!=undefined)?b[nJ].bShowGrid:false;S=d.CheckClusterData(R,C,clustsq[nJ],n,nJ,x,y,a,g[n],S);if(b)b[nJ].bShowGrid=S;}}}};c.NothingToDo=function(){};c.ReturnFalse=function(){return false;};c.CheckSingleClusterData=function(R,C,a,n,b,x,y,v,d,s){if(a.numInst>=c.m_limit){var t=C[n];f.m_Clusters[n].FillClusterData(R,t[b],x,y,C[n].XPerTile,C[n].YPerTile,v[n],s);return false;}a.b2Cluster=false;return s;};c.CheckGroupClusterData=function(R,C,a,n,b,x,y,v,d,s){if(a.bLimitExceeded||(a.numInst>=c.m_limit)){for(var i=0;i<d.length;++i){var g=d[i].index;var t=C[g];s=f.m_Clusters[g].FillClusterData(R,t[b],x,y,C[n].XPerTile,C[n].YPerTile,v[g],s);}}else{a.b2Cluster=false;for(var i=0;i<d.length;++i){var t=C[d[i].index];t[b].b2Cluster=false;}}return s;};c.InitializeGrid=function(m,n,a,b){m=[];for(var x=0;x<n;++x)for(var y=0;y<a;++y){var d=[];if(bShowGrid)d.bShowGrid=true;myGrid.push(d);}};c.InitializeGridClusterData=function(s,n,a,S){var m=[];m.nX=n;m.nY=a;m.XPerTile=s.m_nWidthCanvas/(s.m_nTilesX*c.m_dividerX);m.YPerTile=s.m_nHeightCanvas/(s.m_nTilesY*c.m_dividerY);for(var x=0;x<n;++x)for(var y=0;y<a;++y){var b={};b.numInst=0;if(S)b.bShowGrid=true;m.push(b);}return m;};c.InitializeDistClusterData=function(s,n,a,S){var b={};b.numInst=0;b.type=c.m_type;return b;};c.InitializeTreeClusterData=function(s,n,a,S){var b={};b.numInst=0;b.type=c.m_type;return b;};c.FillClusterData=function(R,a,x,y,b,d,v,s){if(c.m_omitEmpties&&!a.numInst){a.b2Cluster=false;return s;}a.b2Cluster=true;var g=y*d;var h=g+d;var k=x*b;var l=k+b;var m=b/2;var n=d/2;var o=[k+m+c.m_dispOffsetX,g+n+c.m_dispOffsetY,0,0];o.h=o.s=false;o.im=v.m_image;o.sc=v.m_scale;o.hscale=v.m_hotscale;o.hcol=v.m_hotcol;if(c.m_textfont!=undefined){o.ct=""+a.numInst;o.f=c.m_textfont;o.fc=c.m_textcolor;o.fs=c.m_textfontscale;o.fo=c.m_textoffset;}if(s){o.centX=k+m;o.centY=g+n;o.halfxSize=m;o.halfySize=n;o.cellColor=f.m_cellColor;}o.isCl=true;o.nI=-1;R[v.m_index].push(o);return false;};c.doDistClustering=function(n,R,d,g){var T=[];var h={};for(var i=0;i<R.length;++i){h=R[i];for(var j=0;j<h.length;++j){if(h[j].cl==n)T.push(h[j]);}}var k=new Array(T.length);var a,l,b;for(var i=0;i<T.length;++i){a=T[i];k[i]=[a[0],a[1]];}var m=[];if(f.m_bDelaunay){m=D.triangulate(k);m.sort(function(a,b){var B=a.l-b.l;if(B)return B;B=a.s-b.s;return B?B:a.d-b.d;});}T.sort(function(a,b){return a[0]-b[0]});var o=T.length-1;var G=0;for(var i=0;i<o;++i){a=T[i];b=T[i+1];l=b[0]-a[0];if(l>d){G=i+1;break;}}var p=[];var q,r,x,s,u,v;var w=T.length+G;var y=T.length;for(var i=G;i<w;++i){u=i%y;var a=T[u];if(a.isGrouped)continue;x=a[0];if(i>y-1)x+=g;for(var j=i+1;j<w;++j){v=j%y;var b=T[v];if(b.isGrouped)continue;s=b[0];if(j>y-1)s+=g;if(s-x<=d){if(p.length<=0){q=a[1];r=a[1];}else{if(a.isGrouped){q=p[a.nGrp].minY;r=p[a.nGrp].maxY;}else{q=a[1];r=a[1];}}if(Math.abs(b[1]-q)<=d&&Math.abs(b[1]-r)<=d){if(a.isGrouped){p[a.nGrp].push(b);b.isGrouped=true;b.nGrp=a.nGrp;b.b2Ignore=true;if(b.objRef!=undefined)b.objRef.b2Ignore=true;if(b[1]<p[a.nGrp].minY)p[a.nGrp].minY=b[1];if(b[1]>p[a.nGrp].maxY)p[a.nGrp].maxY=b[1];if(s<p[a.nGrp].minX)p[a.nGrp].minX=s;if(s>p[a.nGrp].maxX)p[a.nGrp].maxX=s;if(p[a.nGrp].sumX==undefined)p[a.nGrp].sumX=s;else p[a.nGrp].sumX+=s;if(p[a.nGrp].sumY==undefined)p[a.nGrp].sumY=b[1];else p[a.nGrp].sumY+=b[1];}else{var z=[];z.push(a);z.push(b);p.push(z);var A=p.length-1;a.isGrouped=true;a.nGrp=A;a.b2Ignore=true;b.isGrouped=true;b.nGrp=A;b.b2Ignore=true;if(a.objRef!=undefined)a.objRef.b2Ignore=true;if(b.objRef!=undefined)b.objRef.b2Ignore=true;if(a[1]<b[1]){p[A].minY=a[1];p[A].maxY=b[1];}else{p[A].minY=b[1];p[A].maxY=a[1];}if(x<s){p[A].minX=x;p[A].maxX=s;}else{p[A].minX=s;p[A].maxX=x;}if(p[A].sumX==undefined)p[A].sumX=x+s;else p[A].sumX+=x+s;if(p[A].sumY==undefined)p[A].sumY=a[1]+b[1];else p[A].sumY+=a[1]+b[1];}}}else break;}}return p;};c.distFillClusterData=function(s,d,R,v){var L=s.m_Canvas[0].m_nExactLOD-s.m_Canvas[0].m_nCurrentLOD;var a=Math.pow(2,L);for(var i=0;i<d.length;++i){var l=d[i].length;var x=d[i].sumX/l+c.m_dispOffsetX;var y=d[i].sumY/l+c.m_dispOffsetY;var b=[x,y,0,0];b.orgPos=s.GetPosFromPoint([x*a,y*a]);b.h=false;b.hscale=v.m_hotscale;b.hcol=v.m_hotcol;b.s=false;b.im=v.m_image;b.sc=v.m_scale;if(c.m_textfont!=undefined){b.ct=""+l;b.f=c.m_textfont;b.fc=c.m_textcolor;b.fs=c.m_textfontscale;b.fo=c.m_textoffset;}b.cobjs=d[i];b.isCl=true;R[v.m_index].push(b);}return true;};c.doTreeClustering=function(n,R,d,g){var T=[];var h={};for(var i=0;i<R.length;++i){h=R[i];for(var j=0;j<h.length;++j){if(h[j].cl==n){h[j].lod=20;T.push(h[j]);}}}var a,k,b;T.sort(function(a,b){return a[0]!=b[0]?a[0]-b[0]:a[1]-b[1]});var l=T.length-1;var G=0;var m=[];var o=T[0];lastP=T[l];if(l<2)return[];var p=o[0]-lastP[0]+g;if(p<d){for(var i=0;i<l;++i){a=T[i];b=T[i+1];k=b[0]-a[0];if(k>p){G=i+1;p=k;if(p>d)break;}}}var q=T.length;var r=G+q;var s=0;var u=-1,v;var z=[];for(var i=G;i<r;++i){if(i>=q){j=i-q;s=g;}else{j=i;}a=T[j];if(u!=-1&&a[0]===v[0]&&a[1]===v[1]){z.push({s:u,d:j,l:0});}else{m.push([a[0]+s,a[1],j]);u=j;v=a;}}VBI.Trace("clustering "+l+" elements with "+z.length+" zero edges.");var w=D.triangulate(m);w.sort(function(a,b){var A=a.l-b.l;if(A)return A;A=a.s-b.s;return A?A:a.d-b.d;});var x=z.concat(w);c.buildTree(T,x,d,g);var y=[];return y;};c.buildTree=function(n,a,d,b){var l=Math.log2(b);var g=0;var p=undefined;var h,k,m,o,q,r,s;for(e=0;e<a.length;++e){var u=a[e];if(p&&(u.s==p.s)&&(u.d==p.d))continue;p=u;m=h=n[u.s];o=k=n[u.d];while(m.c!=undefined)m=m.c;while(o.c!=undefined)o=o.c;var v=Math.floor(u.l?Math.min(22,l+Math.log2(d/u.l)):22);if(!m.bCluster){if(!o.bCluster){var w={lod:v,ident:++g,bCluster:true,cnt:2};w.bw=[m,o];m.c=w;o.c=w;}else{if(o.lod==v){h.c=o;o.bw.push(h);o.cnt++;}else{var w={lod:v,ident:++g,bCluster:true,cnt:2};w.bw=[m,o];m.c=w;o.c=w;}}}else{if(!o.bCluster){if(m.lod==v){k.c=m;m.bw.push(k);m.cnt++;}else{var w={lod:v,ident:++g,bCluster:true,cnt:2};w.bw=[m,o];m.c=w;o.c=w;}}else{if(v<Math.min(o.lod,m.lod)){var w={lod:v,ident:++g,bCluster:true,cnt:2};w.bw=[m,o];m.c=w;o.c=w;}else{if(m.ident==o.ident)continue;if((o.lod<m.lod)||((o.lod==m.lod)&&(o.cnt>m.cnt))){q=m;r=o;}else{q=o;r=m;}for(i=q.bw.length;i--;){s=q.bw[i];if(s==undefined)debugger;s.c=r;r.bw.push(s);r.cnt++;q.bw[i]=undefined;}}}}}};c.treeFillClusterData=function(s,a,R,v){var L=s.m_Canvas[0].m_nExactLOD-s.m_Canvas[0].m_nCurrentLOD;var b=Math.pow(2,L);for(var i=0;i<a.length;++i){var l=a[i].length;var x=a[i].sumX/l+c.m_dispOffsetX;var y=a[i].sumY/l+c.m_dispOffsetY;var d=[x,y,0,0];d.orgPos=s.GetPosFromPoint([x*b,y*b]);d.h=false;d.hscale=v.m_hotscale;d.hcol=v.m_hotcol;d.s=false;d.im=v.m_image;d.sc=v.m_scale;if(c.m_textfont!=undefined){d.ct=""+l;d.f=c.m_textfont;d.fc=c.m_textcolor;d.fs=c.m_textfontscale;d.fo=c.m_textoffset;}d.isCl=true;R[v.m_index].push(d);}return true;};return c;};D={supertriangle:function(v){var x=Number.POSITIVE_INFINITY,y=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,b=Number.NEGATIVE_INFINITY,i,d,c,g,h,k;for(i=v.length;i--;){if(v[i][0]<x)x=v[i][0];if(v[i][0]>a)a=v[i][0];if(v[i][1]<y)y=v[i][1];if(v[i][1]>b)b=v[i][1];}d=a-x;c=b-y;g=Math.max(d,c);h=x+d*0.5;k=y+c*0.5;return[[h-20*g,k-g,-1],[h,k+20*g,-2],[h+20*g,k-g,-3]];},circumcircle:function(v,i,j,k){var x=v[i][0],y=v[i][1],a=v[j][0],b=v[j][1],c=v[k][0],d=v[k][1],g=Math.abs(y-b),h=Math.abs(b-d),l,m,n,o,p,q,r,s,u,w;if(g<E&&h<E)throw new Error("Eek! Coincident points!");if(g<E){o=-((c-a)/(d-b));q=(a+c)/2.0;s=(b+d)/2.0;l=(a+x)/2.0;m=o*(l-q)+s;}else if(h<E){n=-((a-x)/(b-y));p=(x+a)/2.0;r=(y+b)/2.0;l=(c+a)/2.0;m=n*(l-p)+r;}else{n=-((a-x)/(b-y));o=-((c-a)/(d-b));p=(x+a)/2.0;q=(a+c)/2.0;r=(y+b)/2.0;s=(b+d)/2.0;l=(n*p-o*q+s-r)/(n-o);m=(g>h)?n*(l-p)+r:o*(l-q)+s;}u=a-l;w=b-m;return{i:i,j:j,k:k,x:l,y:m,r:u*u+w*w};},dedup:function(c){var i,j,a,b,m,n;for(j=c.length;j;){b=c[--j];a=c[--j];for(i=j;i;){n=c[--i];m=c[--i];if((a===m&&b===n)||(a===n&&b===m)){c.splice(j,2);c.splice(i,2);break;}}}},triangulate:function(v,k){var n=v.length,i,j,d,s,o,g,h,l,m,a,b,c;if(n<3)return[];v=v.slice(0);if(k)for(i=n;i--;)v[i]=v[i][k];d=new Array(n);for(i=n;i--;)d[i]=i;d.sort(function(i,j){return v[j][0]-v[i][0];});s=this.supertriangle(v);v.push(s[0],s[1],s[2]);o=[this.circumcircle(v,n+0,n+1,n+2)];g=[];h=[];for(i=d.length;i--;h.length=0){c=d[i];for(j=o.length;j--;){l=v[c][0]-o[j].x;if(l>0.0&&l*l>o[j].r){g.push(o[j]);o.splice(j,1);continue;}m=v[c][1]-o[j].y;if(l*l+m*m-o[j].r>E)continue;h.push(o[j].i,o[j].j,o[j].j,o[j].k,o[j].k,o[j].i);o.splice(j,1);}this.dedup(h);for(j=h.length;j;){b=h[--j];a=h[--j];o.push(this.circumcircle(v,a,b,c));}}for(i=o.length;i--;)g.push(o[i]);o.length=0;for(i=g.length;i--;)if(g[i].i<n&&g[i].j<n&&g[i].k<n){var p=[g[i].i,g[i].j,g[i].k];p.sort();var q=v[p[0]],r=v[p[1]],u=v[p[2]];var w=((q[0]-r[0])*(q[0]-r[0])+(q[1]-r[1])*(q[1]-r[1]));var x=((q[0]-u[0])*(q[0]-u[0])+(q[1]-u[1])*(q[1]-u[1]));var y=((u[0]-r[0])*(u[0]-r[0])+(u[1]-r[1])*(u[1]-r[1]));o.push({s:(v[p[0]])[2],d:(v[p[1]])[2],l:w});o.push({s:(v[p[0]])[2],d:(v[p[2]])[2],l:x});o.push({s:(v[p[1]])[2],d:(v[p[2]])[2],l:y});}return o;},contains:function(g,p){if((p[0]<g[0][0]&&p[0]<g[1][0]&&p[0]<g[2][0])||(p[0]>g[0][0]&&p[0]>g[1][0]&&p[0]>g[2][0])||(p[1]<g[0][1]&&p[1]<g[1][1]&&p[1]<g[2][1])||(p[1]>g[0][1]&&p[1]>g[1][1]&&p[1]>g[2][1]))return null;var a=g[1][0]-g[0][0],b=g[2][0]-g[0][0],c=g[1][1]-g[0][1],d=g[2][1]-g[0][1],i=a*d-b*c;if(i===0.0)return null;var u=(d*(p[0]-g[0][0])-b*(p[1]-g[0][1]))/i,v=(a*(p[1]-g[0][1])-c*(p[0]-g[0][0]))/i;if(u<0.0||v<0.0||(u+v)>1.0)return null;return[u,v];}};return f;};
(function(){var i=(typeof VBI=="object")||window.VBI;if(i)return;window.VBI={m_bIsMyChromeTest:(/chrome/gi).test(navigator.appVersion),m_bIsIDevice:(/iphone|ipad/gi).test(navigator.appVersion),m_bIsAndroid:(/android/gi).test(navigator.appVersion),m_bIsMobile:(/iphone|ipad|android|BB|blackberry|playbook/gi).test(navigator.appVersion),m_bIsPhone:jQuery.device.is.phone,m_ctrlKey:false,m_shiftKey:false,m_dwRefKeyboardHook:0,GetGeoLocationService:function(){if(this.GeoLocationService)return this.GeoLocationService;this.GeoLocationService=new VBI.GeoLocation();return this.GeoLocationService;},Events:function(){var c={};var h=c.hasOwnProperty;return{subscribe:function(a,b){if(!h.call(c,a))c[a]=[];var n=c[a].push(b)-1;return{unsubscribe:function(){delete c[a][n];}};},fire:function(a,d){if(!h.call(c,a))return;c[a].forEach(function(a){a(d||{});});}};},m_Log:"",m_bTrace:(function(){var e=document.getElementById('VBITrace');return(e!=null)?true:false;})(),Trace:function(t){if(typeof console!="undefined")console.log(t+"\r\n");var a=document.getElementById('VBITrace');if(a==null)return;VBI.m_Log=VBI.m_Log+t+"<br>";a.innerHTML=VBI.m_Log;},RegisterKeyboardHook:function(){++window.VBI.m_dwRefKeyboardHook;if(window.VBI.m_dwRefKeyboardHook>1)return;window.VBI.onkeydown=function(e){if(e.keyCode==16)VBI.m_shiftKey=true;else if(e.keyCode==17)VBI.m_ctrlKey=true;};window.VBI.onkeyup=function(e){if(e.keyCode==16)VBI.m_shiftKey=false;else if(e.keyCode==17)VBI.m_ctrlKey=false;};document.addEventListener('keydown',window.VBI.onkeydown);document.addEventListener('keyup',window.VBI.onkeyup);},UnRegisterKeyboardHook:function(){--window.VBI.m_dwRefKeyboardHook;if(window.VBI.m_dwRefKeyboardHook>0)return;document.removeEventListener('keydown',window.VBI.onkeydown);document.removeEventListener('keyup',window.VBI.onkeyup);window.VBI.onkeydown=null;window.VBI.onkeyup=null;}};var V=["saputilities","sapvbicontext","sapdataprovider","sapresources","sapgeomath","sapmaplayer","sapmapprovider","sapmapmanager","sapvobase","sapevents","sapscene","sapwindow","sapactions","sapautomations","sapgeolocation","sapgeotool","sapscale","sapnavigation","sapvbmenu","sapprojection","sapvbcluster","sapparsing","sapconfig"];for(var n=0,l=V.length;n<l;++n)jQuery.sap.require("sap.ui.vbm.lib."+V[n]);})();
VBI.VBIContext=function(c){var v={};v.vbiclass="VBIContext";v.m_bLoaded=false;v.m_Resources=null;v.m_Config=null;v.m_DataTypeProvider=null;v.m_DataProvider=null;v.m_SceneManager=null;v.m_MapProviders=null;v.m_MapLayerStackManager=null;v.m_Windows=null;v.m_Actions=null;v.m_Automations=null;v.m_Menus=null;v.m_Control=c;var n=new Date();v.m_StartupTime=n.getTime();v.clear=function(){v.m_Control=null;if(v.m_Resources)v.m_Resources.clear();if(v.m_Config)v.m_Config.clear();if(v.m_DataTypeProvider)v.m_DataTypeProvider.clear();if(v.m_DataProvider)v.m_DataProvider.clear();if(v.m_SceneManager)v.m_SceneManager.clear();if(v.m_MapProviders)v.m_MapProviders.clear();if(v.m_MapLayerStackManager)v.m_MapLayerStackManager.clear();if(v.m_Windows)v.m_Windows.clear();if(v.m_Actions)v.m_Actions.clear();if(v.m_Automations)v.m_Automations.clear();if(v.m_Menus)v.m_Menus.clear();v.m_Resources=null;v.m_Config=null;v.m_DataTypeProvider=null;v.m_DataProvider=null;v.m_SceneManager=null;v.m_MapProviders=null;v.m_MapLayerStackManager=null;v.m_Windows=null;v.m_Actions=null;v.m_Automations=null;v.m_Menus=null;};v.GetResources=function(){var r;if(r=v.m_Resources)return r;return(v.m_Resources=new VBI.Resources());};v.GetConfig=function(){var C;if(C=v.m_Config)return C;return(v.m_Config=new VBI.Configurations());};v.GetMainScene=function(){if(v.m_Windows){var w=null;if(w=v.m_Windows.GetMainWindow()){var s=null;if(s=w.GetScene())return s;}}return null;};v.FireAction=function(b,s,d,e,p,i){var f=null;if(jQuery.type(d)=='object')f=d.m_ID;else if(jQuery.type(d)=='string')f=d;var o={};var r=(o["SAPVB"]={});r["version"]="2.0";r["xmlns:VB"]="VB";var A=(r["Action"]={});A.name=b.m_name;A.object=f;A.id=b.m_id;if(i!=undefined)A.instance=i;else if(e)A.instance=e.GetPath();var x=0.0;var y=0.0;var m=false;if(p){A.Params={};A.Params.Param=[];for(var a in p){var t={};t["name"]=a;t["#"]=p[a];A.Params.Param.push(t);if(a=='x'){x=p[a];m=true;}if(a=='y'){y=p[a];m=true;}}}if(v.m_DataProvider)v.m_DataProvider.store(r);var l;if(b.m_additionalProperties&&(l=b.m_additionalProperties.length)){var g=A.AddActionProperties={};var h=g.AddActionProperty=[];for(var j=0;j<l;++j){var k;switch(b.m_additionalProperties[j]){case'zoom':h.push({name:'zoom','#':s.GetCurrentZoomlevel().toString()});break;case'centerpoint':k=VBI.MathLib.RadToDeg(s.GetCenterPos());h.push({name:'centerpoint','#':k[0].toString()+';'+k[1].toString()+';0.0'});break;case'clustercount':clusterGroups=s.m_PreassembledData;cluster=clusterGroups[d.m_nPreDataIndex];clusteredObjects=d.m_HotClusterVO.cobjs;h.push({name:'clustercount','#':d.m_HotClusterVO.ct});break;case'pos':if(m){k=s.GetPosFromVPPoint([x,y,0]);h.push({name:'pos','#':k[0].toString()+';'+k[1].toString()+';0.0'});}break;case'pitch':h.push({name:'pitch','#':'0.0'});break;case'yaw':h.push({name:'yaw','#':'0.0'});break;}}}var q=JSON.stringify(r,null,'  ');if(v.m_Control)v.m_Control.fireSubmit({data:q});};v.onRenderLayer=function(a){v.m_Control.fireRender({canvas:a});};v.onMoveLayer=function(a){v.m_Control.fireMove({canvas:a});};v.onZoomLayer=function(a){v.m_Control.fireZoom({canvas:a});};v.onOpenWindow=function(i,d){v.m_Control.fireOpenWindow({id:i,contentarea:d});};v.onCloseWindow=function(i,d){v.m_Control.fireCloseWindow({id:i,contentarea:d});};return v;};
VBI.Menus=function(){var m={};m.m_menus=[];m.m_menucnt=0;m.clear=function(){for(var n=m.m_menus.length-1;n>=0;--n){m.m_menus[n].destroy();m.m_menus.pop();}m.m_menus=[];};m.loadMainMenu=function(d,c){var M=new sap.ui.unified.Menu("vbimenu_i"+m.m_menucnt);m.loadMenu(M,d,c,"i"+m.m_menucnt);m.m_menucnt++;M.vbi_data={};M.vbi_data.menuRef=d.id;M.vbi_data.VBIName=d.name;M.attachItemSelect(function(e){var r={};r.refid=e.mParameters.item.vbi_data.refid;r.menu=M;m.OnSelected(r);});m.m_menus.push(M);return M;};m.loadMenu=function(M,d,c,i){var a=jQuery.type(d.MenuItem)=='object';var b=(a?1:d.MenuItem.length);for(var e=0;e<b;++e){var s=(a?d.MenuItem:d.MenuItem[e]);if(s.active=="false")continue;var f;f=i+"_"+e;var t=s.Separator==undefined?s.text:"---------------------------";var o=new sap.ui.unified.MenuItem("vbimi_"+f,{text:t});o.vbi_data={};if((s.disabled=="true")||(s.Separator!=undefined))o.setEnabled(false);M.addItem(o);if(s.icon)o.setIcon(s.icon);VBI.m_bTrace&&VBI.Trace("Adding Menuitem: menuitem_"+f+" with text "+t);if(s.MenuItem!=undefined){var S=new sap.ui.unified.Menu("vbim_"+f);S.setAriaDescription("Menu "+f);o.setSubmenu(S);m.loadMenu(S,s,c,f);}else{if(s.id!=""){o.vbi_data.refid=s.id;}}}};m.deleteMenu=function(a){var i=m.findMenuIdxByName(a);if(i>=0){var l=m.m_menus.length-1;m.m_menus[i].destroy();if(i!=l){m.m_menus[i]=m.m_menus[l];}m.m_menus.pop();return i;}return-1;};m.getMainScene=function(c){if(c.m_SceneManager.m_SceneArray.length==1)return c.m_SceneManager.m_SceneArray[0].m_ID;return undefined;};m.load=function(d,c){jQuery.sap.require("sap.ui.unified.Menu");m.m_context=c;if(d.Set){if(d.Set.name!=undefined)m.deleteMenu(d.Set.name);else m.clear();if(jQuery.type(d.Set)=='object'){if(d.Set.Menu){m.loadMainMenu(d.Set.Menu,c);}}else if(jQuery.type(d.Set)=='array'){for(var n=0;n<d.Set.length;++n){if(d.Set[n].Menu){m.loadMainMenu(d.Set[n].Menu,c);}}}};};m.findMenuByID=function(a){if(m.m_menus){for(var i=0;i<m.m_menus.length;++i){if(m.m_menus[i].vbi_data.menuRef==a)return m.m_menus[i];}}return null;};m.findMenuIdxByName=function(a){if(m.m_menus){for(var i=0;i<m.m_menus.length;++i){if(m.m_menus[i].vbi_data.VBIName==a)return i;}}return-1;};m.OnSelected=function(r){var a=r.menu.vbi_data.object;if(r.refid==undefined)return;var s=m.m_context.m_SceneManager.GetSceneByName(r.menu.vbi_data.scene);var b=m.m_context.m_Actions;if(b){if(b.findAction("ContextMenu",s,a)){var c=new VBI.Actions.Action();c.m_name="FCODE_SELECT";c.m_id=r.refid;s.m_Ctx.FireAction(c,s,a,null,null,r.menu.vbi_data.instance);}}};return m;};
VBI.Utilities.SceneBindDesignSpotBoxSize=function(o){var s=this.m_Scene;if(o.m_Design&&(o.m_Hit==VBI.HTBOXHANDLE)&&this.m_Scale.IsChangeable(s.m_Ctx)){if(o.m_Handle>6)return;var z=s.GetCurrentZoomFactors();var n=o.m_ClientX/z[0];var a=o.m_ClientY/z[1];var b=o.m_DhOrig[0];var m=(b[0]+b[2])/2.0;var w=(b[2]-b[0])/2.0;var h=(b[3]-b[1]);var f=1.0,c=1.0;switch(o.m_Handle){case 1:c=Math.abs(a-b[3])/h;break;case 2:c=Math.abs(a-b[3])/h;case 5:f=Math.abs(n-m)/w;break;case 0:c=Math.abs(a-b[3])/h;case 3:f=Math.abs(n-m)/w;break;}var d=o.m_ScaleOrig.slice(0);d[0]*=f;d[1]*=c;this.m_Scale.SetValueVector(s.m_Ctx,d);}};
VBI.Utilities.SceneBindDesignBoxBoxSize=function(k,o){var s=this.m_Scene;if(o.m_Design&&(o.m_Hit==VBI.HTBOXHANDLE)&&this.m_Scale.IsChangeable(s.m_Ctx)){var z=s.GetCurrentZoomFactors();var n=o.m_ClientX/z[0];var a=o.m_ClientY/z[1];var b=o.m_DhOrig[0];var m=(b[0]+b[2])/2.0;var c=(b[1]+b[3])/2.0;var w=(b[2]-b[0])/2.0;var h=(b[3]-b[1])/2.0;var f=1.0,d=1.0;switch(o.m_Handle){case 0:case 2:case 6:case 8:f=Math.abs(n-m)/w;d=Math.abs(a-c)/h;if(k)f=d=Math.max(f,d);break;case 1:case 7:d=Math.abs(a-c)/h;if(k)f=d;break;case 3:case 5:f=Math.abs(n-m)/w;if(k)d=f;break;}var e=o.m_ScaleOrig.slice(0);e[0]*=f;e[1]*=d;this.m_Scale.SetValueVector(s.m_Ctx,e);}};
VBI.Utilities.SceneBindMeterRadiusDesignBoxSize=function(o){var s=this.m_Scene;if(o.m_Design){var c=this.m_Pos.GetValueVector(s.m_Ctx);var a=s.GetPosFromPoint([o.m_ClientX,o.m_ClientY,0]);var r=0;switch(o.m_Handle){case 1:case 7:r=VBI.MathLib.Distance(VBI.MathLib.DegToRad(c),VBI.MathLib.DegToRad([c[0],a[1]]));break;case 3:case 5:r=VBI.MathLib.Distance(VBI.MathLib.DegToRad(c),VBI.MathLib.DegToRad([a[0],c[1]]));break;}this.m_Radius.SetValueFloat(s.m_Ctx,Math.abs(r));}};
VBI.Utilities.SceneBindRadiusDesignBoxSize=function(o){var s=this.m_Scene;if(o.m_Design){var c=this.m_Pos.GetValueVector(s.m_Ctx);var a=s.GetPointFromPos(c);var r=0;switch(o.m_Handle){case 1:case 7:r=(a[1]-o.m_ClientY);break;case 3:case 5:r=(a[0]-o.m_ClientX);break;}this.m_Radius.SetValueFloat(s.m_Ctx,Math.abs(r));}};
VBI.Utilities.SceneBindPosArrayDesignBoxSize=function(o){var s=this.m_Scene;if(o.m_Design){var p=s.GetPosFromPoint([o.m_ClientX,o.m_ClientY,0]);var m=Number.MAX_VALUE;var a=-Number.MAX_VALUE;var b=Number.MAX_VALUE;var c=-Number.MAX_VALUE;var d=o.m_PosOrig.slice(0);var n,l=d.length/3,i;for(n=0;n<l;++n){i=n*3;if(m>d[i])m=d[i];if(a<d[i])a=d[i];if(b>d[i+1])b=d[i+1];if(c<d[i+1])c=d[i+1];}var e=0,f=1;var g=0,h=1;switch(o.m_Handle){case 0:e=a;f=(p[0]-a)/(m-a);case 1:g=b;h=(p[1]-b)/(c-b);break;case 2:g=b;h=(p[1]-b)/(c-b);case 5:e=m;f=(p[0]-m)/(a-m);break;case 6:g=c;h=(p[1]-c)/(b-c);case 3:e=a;f=(p[0]-a)/(m-a);break;case 8:e=m;f=(p[0]-m)/(a-m);case 7:g=c;h=(p[1]-c)/(b-c);break;}for(n=0;n<l;++n){var i=n*3;d[i]=e+(d[i]-e)*f;d[i+1]=g+(d[i+1]-g)*h;}this.m_Pos.SetValueVector(s.m_Ctx,d);}};
VBI.Utilities.BackupFont=function(d){d.m_BackupFont=[];d.m_BackupFont.m_font=d.m_font=d.font;d.m_BackupFont.m_fillStyle=d.fillStyle;d.m_BackupFont.m_strokeStyle=d.strokeStyle;d.m_BackupFont.m_textAlign=d.textAlign;d.m_BackupFont.m_textBaseline=d.textBaseline;};
VBI.Utilities.RestoreFont=function(d){d.m_font=d.font=d.m_BackupFont.m_font;d.fillStyle=d.m_BackupFont.m_fillStyle;d.strokeStyle=d.m_BackupFont.m_strokeStyle;d.textAlign=d.m_BackupFont.m_textAlign;d.textBaseline=d.m_BackupFont.m_textBaseline;};
VBI.Utilities.SetTextAttributes=function(d,n,a,b,c,e){if((n!=undefined)&&(d.m_font!=n)){d.m_font=d.font=n;}d.fillStyle=a;d.strokeStyle=b;d.textAlign=c;d.textBaseline=e;};
VBI.Utilities.SetFont=function(d,n){if((n!=undefined)&&(d.m_font!=n)){d.m_font=d.font=n;}};
VBI.Label=function(l,r,p,a,i){this.m_bAligned=false;this.m_aIO=i;this.m_rcBox=a;this.m_Text=l.labeltext;this.m_BgColor=l.bgColor;this.m_Align=l.Align;this.m_Padding=2;this.m_PosArray=p;this.m_Pos=[];this.m_Width=0;this.m_Height=0;this.m_LabelTextColor=[];if(!r){var n=Math.floor(this.m_PosArray.pa.length/3)*3;for(var b=0;b<i.length;b++){var t=[];for(var c=0;c<n;c+=3){var d=[this.m_PosArray.pa[c]+i[b],this.m_PosArray.pa[c+1]];t.push(d);}this.m_Pos.push(t);}}this.CalculateLabelPos=r;this.GetLabelTextColor=function(){if(!this.m_LabelTextColor.length){var e=VBI.Types.string2rgba(this.m_BgColor);if(e[3]==0&&e[4]==1){this.m_LabelTextColor[0]="#FFFFFF";this.m_LabelTextColor[1]="#000000";}else{var f=(299*250+587*250+114*250)/1000.0;var g=(299*e[0]+587*e[1]+114*e[2])/1000.0;if(Math.abs(g-f)<=125.0)this.m_LabelTextColor[0]="#000000";else this.m_LabelTextColor[0]="#FAFAFA";}}return this.m_LabelTextColor;};this.SetDimensions=function(e){if(!this.m_Width||!this.m_Height){var s=this.m_Text.split(/\r\n/);var f=0;var g=0;var h=VBI.Utilities.RemToPixel(0.75);for(var j=0;j<s.length;j++){var k=s[j].length;if(k>f){f=k;g=j;}}this.m_Width=e.measureText(s[g]).width+this.m_Padding*2;this.m_Height=h*s.length+this.m_Padding*2;}};this.AlignLabel=function(){if(!this.m_bAligned&&this.m_rcBox){for(var c=0;c<this.m_Pos.length;c++){for(var e=0;e<this.m_Pos[c].length;e++){var d=this.m_Pos[c][e];switch(this.m_Align){case 0:d[0]-=this.m_Width/2;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])/2+this.m_Height/2;break;case 1:d[0]-=this.m_Width/2;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])+this.m_Height;break;case 2:d[0]+=(this.m_rcBox[2]-this.m_rcBox[0])/2;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])+this.m_Height;break;case 3:d[0]+=(this.m_rcBox[2]-this.m_rcBox[0])/2;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])/2+this.m_Height/2;break;case 4:d[0]+=(this.m_rcBox[2]-this.m_rcBox[0])/2;break;case 5:d[0]-=(this.m_Width/2);break;case 6:d[0]-=(this.m_rcBox[2]-this.m_rcBox[0])/2+this.m_Width;break;case 7:d[0]-=(this.m_rcBox[2]-this.m_rcBox[0])/2+this.m_Width;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])/2+this.m_Height/2;break;case 8:d[0]-=(this.m_rcBox[2]-this.m_rcBox[0])/2+this.m_Width;d[1]-=(this.m_rcBox[3]-this.m_rcBox[1])+this.m_Height;break;default:break;}if(!this.CalculateLabelPos)d[0]+=this.m_aIO[e];}}}this.m_bAligned=true;};this.clear=function(){this.CalculateLabelPos=null;this.m_Pos=null;this.m_PosArray=null;this.m_rcBox=null;this.m_aIO=null;this.m_LabelTextColor=null;};return this;};
VBI.DnDInfo=function(){var d={};d.m_datasource=null;d.m_boundtype=null;d.m_type=[];d.clear=function(){for(var n=0;n<d.m_type.length;++n)d.m_type[n].clear();if(d.m_boundtype)d.m_boundtype.clear();if(d.m_datasource)d.m_datasource.clear();d.m_datasource=null;d.m_boundtype=null;d.m_type=[];};d.load=function(a,c,i){if(a){if(jQuery.type(a)=='array'){for(var n=0;n<a.length;++n){if(jQuery.type(a[n])=='object'){if(a[n].datasource){d.m_datasource=new VBI.NodeProperty(a[n],'datasource',i.m_DataSource,c);d.m_boundtype=new VBI.AttributeProperty(a[n],'type',d.m_datasource,c);}else d.m_type.push(new VBI.AttributeProperty(a[n],'type',null,c));}}}else if(jQuery.type(a)=='object'){if(a.datasource){d.m_datasource=new VBI.NodeProperty(a,'datasource',i.m_DataSource,c);d.m_boundtype=new VBI.AttributeProperty(a,'type',d.m_datasource,c);}else d.m_type.push(new VBI.AttributeProperty(a,'type',null,c));}}};d.getItemArray=function(c){var v=[];if(d.m_datasource){var a=d.m_datasource;var n;if(n=a.GetCurrentNode(c)){for(var b=0;b<n.m_dataelements.length;++b){a.Select(b);v.push(d.m_boundtype.GetValueString(c));}}}if(d.m_type.length){for(var b=0;b<d.m_type.length;++b)v.push(d.m_type[b].GetValueString(c));}return v;};return d;};
VBI.NodeProperty=function(d,n,p,c){var a=null;if(!(a=d[n]))a=d[n+".bind"];this.m_NPath=a.split(".");this.m_Path=a.split(".");this.m_PNP=p;this.m_nCurElement=0;this.m_CurElement=null;this.m_DTN=c.m_DataTypeProvider.FindTypeNodeFromPath(this.m_Path);var t=this;while(t=t.m_PNP){if(c.m_DataTypeProvider.isParentOf(t.m_DTN,this.m_DTN)){var b,e=t.m_DTN.GetPath();for(b=0;b<e.length;++b){if(this.m_NPath[0]==e[b])this.m_NPath.splice(0,1);else break;}break;}}this.m_PNP=t;this.NotifyDataChange=function(c){this.m_CurElement=null;this.m_DTN=c.m_DataTypeProvider.FindTypeNodeFromPath(this.m_Path);};this.clear=function(){this.m_PNP=null;this.m_CurElement=null;this.m_DTN=null;this.m_NPath=null;this.m_Path=null;};this.GetCurrentElement=function(c){if(this.m_CurElement)return this.m_CurElement;var f=this.GetCurrentNode(c);if(!f)return null;return(this.m_CurElement=f.m_dataelements[this.m_nCurElement]);};this.GetIndexedElement=function(c,i){var f=this.GetCurrentNode(c);if(!f)return null;return f.m_dataelements[i];};this.GetCurrentNode=function(c){var f=null;if(this.m_PNP){var g=this.m_PNP.GetCurrentElement(c);f=g.FindNodeFromPath(this.m_NPath);}else{f=c.m_DataProvider.FindNodeFromPath(this.m_NPath);}return f;};this.Select=function(i){this.m_CurElement=null;this.m_nCurElement=i;};this.SetEditMode=function(c,m){var f;if(f=this.GetCurrentElement(c))f.m_EditMode=m;};this.GetEditMode=function(c){var f;if((f=this.GetCurrentElement(c))&&(f.m_EditMode!=undefined))return f.m_EditMode;return VBI.EMHandle;};this.IsElementSelected=function(c){var f;if(f=this.GetCurrentElement(c))return f.IsSelected();return false;};this.SetSelected=function(c,s){return;};return this;};
VBI.AttributeProperty=function(d,n,p,c,a){var v;this.m_DefaultValue=a;if(v=d[n]){this.m_Name=n;this.m_Value=v;}else if(v=d[n+".bind"]){this.m_PNP=p;this.m_Name=n;this.m_RelBind=v.split(".");this.m_AbsBind=v.split(".");this.m_DTA=c.m_DataTypeProvider.FindTypeAttributeFromPath(this.m_AbsBind);var t=this;while(t=t.m_PNP){if(c.m_DataTypeProvider.isParentOf(t.m_DTN,this.m_DTA)){var b,e=t.m_DTN.GetPath();for(b=0;b<e.length;++b){if(this.m_RelBind[0]==e[b])this.m_RelBind.splice(0,1);else break;}break;}}this.m_PNP=t;}this.NotifyDataChange=function(c){if(this.m_AbsBind)this.m_DTA=c.m_DataTypeProvider.FindTypeAttributeFromPath(this.m_AbsBind);};this.clear=function(){this.m_PNP=null;this.m_DTA=null;this.m_DefaultValue=null;if(this.m_Name)this.m_Name=null;if(this.m_Value)this.m_Value=null;if(this.m_PNP)this.m_PNP=null;if(this.m_RelBind)this.m_RelBind=null;if(this.m_AbsBind)this.m_AbsBind=null;};this.IsChangeable=function(c){var f;if(f=this.GetAttributeObject(c))return f.IsChangeable();return false;};this.GetAttributeObject=function(c){if(this.m_RelBind){if(this.m_PNP)return this.m_PNP.GetCurrentElement(c).FindAttributeFromPath(this.m_RelBind);else return c.m_DataProvider.FindAttributeFromPath(this.m_RelBind);}return null;};this.GetValueFloat=function(c){if(this.m_Value)return VBI.Types.string2float(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if(f.m_dta.m_Type==VBI.Types.st_float)return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2float(f.m_Value);if(f.m_dta.m_Type==VBI.Types.st_long)return VBI.Types.long2float(f.m_Value);if(f.m_dta.m_Type==VBI.Types.st_bool)return f.m_Value?1.0:0.0;}}return this.m_DefaultValue;};this.GetValueString=function(c){if(this.m_Value)return this.m_Value;if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if(f.m_dta.m_Type==VBI.Types.st_string)return f.m_Value;else return f.GetStringValue();}};return this.m_DefaultValue;};this.GetValueLong=function(c){if(this.m_Value)return VBI.Types.string2long(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if(f.m_dta.m_Type==VBI.Types.st_long)return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_bool)return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2long(f.m_Value);if(f.m_dta.m_Type==VBI.Types.st_float)return VBI.Types.float2long(f.m_Value);}};return this.m_DefaultValue;};this.GetValueBool=function(c){if(this.m_Value)return VBI.Types.string2bool(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if(f.m_dta.m_Type==VBI.Types.st_bool)return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2bool(f.m_Value);}};return this.m_DefaultValue;};this.GetValueVector=function(c){if(this.m_Value)return VBI.Types.string2vector(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if((f.m_dta.m_Type==VBI.Types.st_vector)||(f.m_dta.m_Type==VBI.Types.st_vectorarray))return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2vector(f.m_Value);}}return this.m_DefaultValue;};this.GetValueColor=function(c){if(this.m_Value)return VBI.Types.string2color(this.m_Value);if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if((f.m_dta.m_Type==VBI.Types.st_color))return f.m_Value;if(f.m_dta.m_Type==VBI.Types.st_string)return VBI.Types.string2color(f.m_Value);}}return this.m_DefaultValue;};this.SetValueVector=function(c,v){if(this.m_Value)return null;if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if((f.m_dta.m_Type==VBI.Types.st_vector)||(f.m_dta.m_Type==VBI.Types.st_vectorarray))f.set(v);if(f.m_dta.m_Type==VBI.Types.st_string)f.set(VBI.Types.float2string(v));}}return null;};this.SetValueFloat=function(c,v){if(this.m_Value)return null;if(this.m_RelBind){var f;if(f=this.GetAttributeObject(c)){if((f.m_dta.m_Type==VBI.Types.st_float))f.set(v);else if((f.m_dta.m_Type==VBI.Types.st_long))f.set(VBI.Types.float2long(v));else if(f.m_dta.m_Type==VBI.Types.st_string)f.set(VBI.Types.float2string(v));}}return null;};this.IsBound=function(){return this.m_RelBind?true:false;};return this;};
VBI.VisualObjects=function(){VBI.EMHandle=0;VBI.EMBox=1;VBI.HTHANDLE=0;VBI.HTBOX=1;VBI.HTBOXHANDLE=2;var v={};v.vbiclass="VisualObjects";v.Factory={"{00100000-2012-0004-B001-64592B8DB964}":function(){return new VBI.VisualObjects.Spot();},"{00100000-2012-0004-B001-C46BD7336A1A}":function(){return new VBI.VisualObjects.Route();},"{00100000-2013-0004-B001-7EB3CCC039C4}":function(){return new VBI.VisualObjects.Circle();},"{00100000-2013-0004-B001-686F01B57873}":function(){return new VBI.VisualObjects.CircleDist();},"{00100000-2012-0004-B001-383477EA1DEB}":function(){return new VBI.VisualObjects.Pie();},"{00100000-2012-0004-B001-BFED458C3076}":function(){return new VBI.VisualObjects.Box();},"{00100000-2012-0004-B001-F311DE491C77}":function(){return new VBI.VisualObjects.Area();},"{00100000-2012-0004-B001-E180770E8A12}":function(){return new VBI.VisualObjects.HeatMap();},"{00100000-2012-0070-1000-35762CF28B6B}":function(){return new VBI.VisualObjects.Dummy();},"{00100000-2014-0004-B001-9F1B43BE944A}":function(){return new VBI.VisualObjects.Route();},"{00100000-2014-0004-BDA8-87B904609063}":function(){return new VBI.VisualObjects.Area();},"{00100000-2012-0004-B001-2297943F0CE6}":function(){return new VBI.VisualObjects.Container();},"{00100000-2013-1000-1100-50059A6A47FA}":function(){return new VBI.VisualObjects.Caption();},"{00100000-2013-1000-3700-AD84DDBBB31B}":function(){return new VBI.VisualObjects.Label();},"{00100000-2013-1000-2400-D305F7942B98}":function(){return new VBI.VisualObjects.Link();},"{00100000-2013-1000-2200-6B060A330B2C}":function(){return new VBI.VisualObjects.Image();},"{00100000-2013-1000-1200-855B919BB0E9}":function(){return new VBI.VisualObjects.Button();},};v.Factory.CreateInstance=function(c){return v.Factory[c]();};VBI.VisualObjects.Base={m_Props:null,m_Scene:null,m_BB:[],m_IO:[],m_colorHot:'rgba( 240, 171, 0, 0.5 )',m_defaultColor:'rgba( 255, 0, 0, 1.0 )',m_defaultTooltip:'',m_defaultLabeltext:'',m_defaultLabelBgCol:'RGBA(200,200,200,200)',m_Label:[],m_DH:[],m_szHandle:8,m_Track:null,m_DragSourceInfo:null,m_DropTargetInfo:null,LoadDragDropInfo:function(d,c,i){if(d.DragSource&&d.DragSource.DragItem){i.m_DragSourceInfo=new VBI.DnDInfo;i.m_DragSourceInfo.load(d.DragSource.DragItem,c,i);}if(d.DropTarget&&d.DropTarget.DropItem){i.m_DropTargetInfo=new VBI.DnDInfo;i.m_DropTargetInfo.load(d.DropTarget.DropItem,c,i);}},BaseLoad:function(d,c,i){VBI.m_bTrace&&VBI.Trace("BaseLoad");i.m_Props.push(i.m_HotScale=new VBI.AttributeProperty(d,'hotScale',i.m_DataSource,c,[1.0,1.0,1.0]));i.m_Props.push(i.m_HotDeltaColor=new VBI.AttributeProperty(d,'hotDeltaColor',i.m_DataSource,c,null));i.m_Props.push(i.m_SelectColor=new VBI.AttributeProperty(d,'selectColor',i.m_DataSource,c,null));i.m_Props.push(i.m_FxSize=new VBI.AttributeProperty(d,'fxsize',i.m_DataSource,c,true));i.m_Props.push(i.m_FxDir=new VBI.AttributeProperty(d,'fxdir',i.m_DataSource,c));i.m_Props.push(i.m_Entity=new VBI.AttributeProperty(d,'entity',i.m_DataSource,c,null));i.m_Props.push(i.m_Labeltext=new VBI.AttributeProperty(d,'labelText',i.m_DataSource,c,i.m_defaultLabeltext));i.m_Props.push(i.m_LabelBgCol=new VBI.AttributeProperty(d,'labelBgColor',i.m_DataSource,c,i.m_defaultLabelBgCol));i.m_Props.push(i.m_LabelPos=new VBI.AttributeProperty(d,'labelPos',i.m_DataSource,c));i.m_Props.push(i.m_DragData=new VBI.AttributeProperty(d,'dragdata',i.m_DataSource,c,null));this.LoadDragDropInfo(d,c,i);},BaseMousemove:function(e){VBI.m_bTrace&&VBI.Trace("BaseMousemove");if(this.m_Track)return false;if(!this.GetHitArray)return false;var h=this.GetHitArray(e.offsetX,e.offsetY);if(h.length>0){var s=this.m_Scene;if(s.InternalSetHotItem(this,h[0])){if(!h[0].m_Design&&this.m_Tooltip){s.SetToolTip(this.getTooltip(s.m_Ctx,h[0]));}var c;if(c=this.DetailCursor(e,h[0]))s.SetCursor(c);}}return h.length>0?true:false;},BaseContextmenu:function(e){VBI.m_bTrace&&VBI.Trace("BaseContextmenu");if(!this.GetHitArray)return false;var h=this.GetHitArray(e.offsetX,e.offsetY);if(h.length>0){var s=this.m_Scene,a=h[0];var m=this.GetDataIndex(a.m_Index);var b=this.m_DataSource.GetIndexedElement(s.m_Ctx,m);var c,d=s.m_Ctx.m_Actions;if(d&&a.m_Design&&(a.m_Hit==VBI.HTHANDLE)){if(c=d.findAction("HandleContextMenu",s,this)){var p=s.GetEventVPCoordsObj(e);p.handle=a.m_Handle.toString();this.m_Scene.m_Ctx.FireAction(c,s,this,b,p);e.preventDefault();return true;}}if(this.DetailContextmenu(e,b,h[0])){e.preventDefault();return true;}if(d){if(c=d.findAction("ContextMenu",s,this)){this.m_Scene.m_Ctx.FireAction(c,s,this,b,s.GetEventVPCoordsObjWithScene(e));e.preventDefault();return true;}}e.preventDefault();}return false;},BaseFindAction:function(n){var s=this.m_Scene,a=s.m_Ctx.m_Actions;return a?a.findAction(n,s,this):null;},BaseClick:function(e){VBI.m_bTrace&&VBI.Trace("BaseClick");if(!this.GetHitArray)return false;var s=this.m_Scene;var h=this.GetHitArray(e.offsetX,e.offsetY);if(!h.length)return false;var m=this.GetDataIndex(h[0].m_Index);this.m_DataSource.Select(m);s.RenderAsync(false);var a;if(a=this.m_DataSource.GetIndexedElement(s.m_Ctx,m)){if((e.type.indexOf("touch")>=0)||(e.type.indexOf("pointer")>=0))a.Select(this.IsSelected(s.m_Ctx)?false:true);else if(e.shiftKey==true)a.Select(true);else if(e.ctrlKey==true)a.Select(this.IsSelected(s.m_Ctx)?false:true);else{a.GlobalSingleSelect();}if(s.m_PreassembledData)s.UpdatePreData4Selected(this.m_nPreDataIndex,this.GetInternalIndex(h[0].m_Index));}if(this.IsPosChangeable(s.m_Ctx)){var b=this.m_DataSource.GetEditMode(s.m_Ctx)==VBI.EMHandle?VBI.EMBox:VBI.EMHandle;VBI.m_bTrace&&VBI.Trace("SetEditMode: "+b);this.m_DataSource.SetEditMode(s.m_Ctx,b);e.preventDefault();return true;}if(this.DetailClick(e,a,h[0])){e.preventDefault();return true;}var c;if(c=s.m_Ctx.m_Actions){var d;if(d=c.findAction("Click",s,this)){this.m_Scene.m_Ctx.FireAction(d,s,this,a,s.GetEventVPCoordsObj(e));e.preventDefault();return true;}}return false;},BaseHitTest:function(n,a,o){var t,h=[];var p=VBI.Utilities.PtInRect;var b={};if(this.BaseDesignHitTest(n,a,b)){h.push(b);return h;}for(var c=this.m_BB.length-1;c>=0;--c){if(t=this.m_BB[c])for(var d=this.m_IO[c].length-1;d>=0;--d){var e=this.m_IO[c][d];if(!p([n-e,a],t))continue;if(o){var r=o.m_cb(o,c,n-e,a);if(r&&r.m_hit>0){h.push({m_Index:c,m_Entity:this.GetEntity(c,this.m_Scene.m_Ctx),m_Detail:r});if(r.m_hit==1)return h;}}}}return h;},clear:function(){if(this.m_Props){for(var n=0;n<this.m_Props.length;++n)this.m_Props[n].clear();this.m_Props=null;}if(this.m_DragSourceInfo){this.m_DragSourceInfo.clear();this.m_DragSourceInfo=null;}if(this.m_DropTargetInfo){this.m_DropTargetInfo.clear();this.m_DropTargetInfo=null;}this.m_Scene=null;this.m_Track=null;this.m_BB=null;this.m_IO=null;this.m_DH=null;if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}},load:function(i,d,c){if(d.id)i.m_ID=d.id;this.m_Props=[];this.m_DragSourceInfo=null;this.m_DropTargetInfo=null;},NotifyDataChange:function(c){if(this.m_Props){for(var n=0,l=this.m_Props.length;n<l;++n)this.m_Props[n].NotifyDataChange(c);}this.m_bChanged=true;},IsPosChangeable:function(c){if(this.m_Pos)return this.m_Pos.IsChangeable(c);return false;},IsSelected:function(c){if(this.m_DataSource)return this.m_DataSource.IsElementSelected(c);return false;},IsHandleMode:function(){return this.m_DataSource.GetEditMode(this.m_Scene.m_Ctx)==VBI.EMHandle?true:false;},IsBoxMode:function(){return this.m_DataSource.GetEditMode(this.m_Scene.m_Ctx)==VBI.EMBox?true:false;},IsDataAccepted:function(e){var s=this.m_Scene;if(this.m_Track){VBI.m_bTrace&&VBI.Trace("Error: Track object should be already gone");return false;}if(!this.GetHitArray)return false;var h,a=this.GetHitArray(e.offsetX,e.offsetY);if(a.length&&(h=a[0]).m_Design){return false;}if(a.length&&s.m_DragInfo){this.m_DataSource.Select(h.m_Index);if(this.m_DropTargetInfo){var c=s.m_Ctx;var d=this.m_DropTargetInfo.getItemArray(c);var D=s.m_DragInfo.aItems;for(var n=0;n<d.length;++n){if(D.indexOf(d[n])!=-1){try{e.dataTransfer.dropEffect='copy';e.stopPropagation();e.preventDefault();}catch(b){VBI.m_bTrace&&VBI.Trace("Warning: sapvobase.IsDataAccepted exception occured: "+b.message);}return h;}}}}return false;},GetEntity:function(n,c){this.m_DataSource.Select(n);return this.m_Entity.GetValueString(c);},IsHot:function(i){var s=this.m_Scene,h=s.m_HotItem;if(h.m_Entity&&h.m_Entity==this.m_Entity.GetValueString(s.m_Ctx))return true;if(!h.m_HitObj||h.m_Index!=i)return false;if(h.m_Design)return false;if(h.m_VO!=this)return false;return true;},InternalChangeHotItem:function(o,n){},IsClusterable:function(){return false;},GetDataIndex:function(B){return B;},GetInternalIndex:function(B){return B;},ShowGrid:function(c,d,p){},getTooltip:function(c,h){this.m_DataSource.Select(h.m_Index);return this.m_Tooltip.GetValueString(c);},getLabelData:function(r){if(r){for(var n=0;n<this.m_Label.length;n++){var l=this.m_Label[n];if(l.CalculateLabelPos&&l.m_PosArray.pa.length>0){l.m_Pos=[];for(var a=0;a<l.m_aIO.length;a++){var p=this.CalculateLabelPos(this.m_Scene,l.m_PosArray,l.m_aIO[a]);if(p&&p.length>0)l.m_Pos.push(p);}l.m_bAligned=false;}}}return this.m_Label;},BaseRender:function(c,d){var l=this.m_DH.length;if(!l)return;var t,a,b;var s=this.m_szHandle,h=s/2,e=1.5*s*s;var f=d.fillStyle;var g='rgba(255,132,0,1.0)';var i='rgba(188,54,24,1.0)';var j='rgba( 240, 171, 0, 1.0 )';var k=this.m_Scene.m_HotItem;var H,x,S=false;for(var n=0;n<l;++n){if(!(H=this.m_DH[n]))continue;for(var m=0,o=this.m_IO[n].length;m<o;++m){d.setTransform(1.0,0.0,0.0,1.0,this.m_IO[n][m],0.0);if(H.m_EditMode==VBI.EMBox){if(H.length==1){x=H[0];VBI.Utilities.DrawDesignRect(d,this.DesignGetActiveBoxHandles(n),x);}}else{d.fillStyle=i;d.lineWidth=1;t=null;if(S){d.fillStyle=i;S=false;}for(var p=0,q=H.length;p<q;++p){x=H[p];var r=(k.m_VO==this&&k.m_Index==n&&k.m_Design&&k.m_HitObj&&k.m_HitObj.m_Handle==p);if(t&&(((a=(t[0]-x[0]))*a)+((b=(t[1]-x[1]))*b))<e){if(!S){S=true;d.fillStyle=r?g:j;d.fill();}continue;}if(S){d.fillStyle=i;S=false;}if(r)d.fillStyle=j;d.beginPath();d.rect(x[0]-h,x[1]-h,s,s);d.closePath();d.fill();if(r)d.fillStyle=i;t=x;}}}}d.fillStyle=f;d.setTransform(1.0,0.0,0.0,1.0,0.0,0.0);},BaseDesignHitTest:function(n,a,b){VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest nsx:"+n+" nsy:"+a+" instance:"+this.m_ID);var l=this.m_DH.length;if(!l)return false;var s=this.m_szHandle,c=s/2.0;var P=VBI.Utilities.PtInRect;if(b.m_Handle)delete b.m_Handle;var H,d;for(var e=l;e>=0;--e){if(!(H=this.m_DH[e]))continue;for(var f=0;f<this.m_IO[e].length;++f){var g=this.m_IO[e][f];if(H.m_EditMode==VBI.EMHandle){VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest Handle");for(var i=0,j=H.length;i<j;++i){d=H[i];if(P([n-g,a],[d[0]-c,d[1]-c,d[0]+c,d[1]+c])){VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest Handle Hit! Index:"+e+" Handle: "+i);b.m_Index=e;b.m_Design=true;b.m_Hit=VBI.HTHANDLE;b.m_Handle=i;b.m_NsX=n;b.m_NsY=a;return true;}}}else if(H.m_EditMode==VBI.EMBox){VBI.m_bTrace&&(H.length>1||H.length==0)&&VBI.Trace("Error: Box edit mode must fill one rectangle only");d=H[0];VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest Box");var r=9;var w=d[2]-d[0];var h=d[3]-d[1];var k=w/2;var m=h/2;var o=this.DesignGetActiveBoxHandles(e);for(var x=0;x<3;++x)for(var y=0;y<3;++y){if(x==1&&y==1)continue;if(!o[y*3+x])continue;var p=d[0]+x*k-(n-g);var q=d[1]+y*m-(a);if((p*p+q*q)<r){b.m_Index=e;b.m_Handle=y*3+x;b.m_Design=true;b.m_Hit=VBI.HTBOXHANDLE;b.m_NsX=n;b.m_NsY=a;return true;}}if(P([n-g,a],d)){VBI.m_bTrace&&VBI.Trace("BaseDesignHitTest Box Hit! Index:"+e);b.m_Index=e;b.m_Handle=-1;b.m_Design=true;b.m_Hit=VBI.HTBOX;b.m_NsX=n;b.m_NsY=a;return true;}}}}return false;},DesignHandleDrag:function(o,e){var s=this.m_Scene;VBI.m_bTrace&&VBI.Trace("DesignHandleDrag");VBI.m_bTrace&&(s.m_nInputMode!=VBI.InputModeTrackObject)&&VBI.Trace("Error: DesignHandleDrag wrong input mode: "+s.m_nInputMode);this.m_DataSource.Select(o.m_Index);var p=s.GetPosFromPoint([o.m_ClientX,o.m_ClientY,0]);var a=s.GetPosFromPoint([o.m_ClientStartX,o.m_ClientStartY,0]);if(this.IsPosChangeable(s.m_Ctx)){var b=this.m_Pos.GetValueVector(s.m_Ctx).slice(0);var c=o.m_PosOrig;if(o.hasOwnProperty('m_Handle')){VBI.m_bTrace&&VBI.Trace("DesignHandleDrag Handle");if(o.m_Hit==VBI.HTHANDLE){var i=o.m_Handle*3;b[i]=p[0];b[i+1]=p[1];this.m_Pos.SetValueVector(s.m_Ctx,b);}else if(o.m_Hit==VBI.HTBOXHANDLE){if(this.DesignBoxSize)this.DesignBoxSize(o);}else if(o.m_Hit==VBI.HTBOX){VBI.m_bTrace&&VBI.Trace("DesignHandleDrag Box");var d=(p[0]-a[0]);var f=(p[1]-a[1]);for(var n=0,l=b.length/3;n<l;++n){var i=n*3;b[i]=c[i]+d;b[i+1]=c[i+1]+f;}this.m_Pos.SetValueVector(s.m_Ctx,b);}}}s.RenderAsync(true);},DesignHandleDrop:function(o,e){var s=this.m_Scene;VBI.m_bTrace&&(s.m_nInputMode!=VBI.InputModeTrackObject)&&VBI.Trace("Error: DesignHandleDrop wrong input mode: "+s.m_nInputMode);var a,b=s.m_Ctx.m_Actions;if(b&&o.m_Design){if(a=b.findAction("HandleMoved",s,this)){var c;if(c=this.m_DataSource.GetIndexedElement(s.m_Ctx,o.m_Index)){var p=s.GetEventVPCoordsObj(e);p.handle=o.m_Handle.toString();p.mode=o.m_Hit.toString();s.m_Ctx.FireAction(a,s,this,c,p);}}}s.SetInputMode(VBI.InputModeDefault);s.RenderAsync(true);return true;},DesignHandleEnd:function(o,e){this.m_Track.UnHook();this.m_Track=null;},DesignGetActiveBoxHandles:function(i){return[1,1,1,1,0,1,1,1,1];},onsapsecclick:function(e){return this.BaseContextmenu(e);},onsapclick:function(e){return this.BaseClick(e);},onsapmove:function(e){return this.BaseMousemove(e);},onsapup:function(e){if(!this.m_Track)return false;this.m_Track.UnHook();this.m_Track=null;},onsapdrop:function(e){VBI.m_bTrace&&VBI.Trace("onsapdrop in base "+e.type);var h;if(h=this.IsDataAccepted(e)){var s=this.m_Scene;var m=this.GetDataIndex(h.m_Index);var a=this.m_DataSource.GetIndexedElement(s.m_Ctx,m);var b,c=s.m_Ctx.m_Actions;if(c){if(b=c.findAction("Drop",s,this)){this.m_Scene.m_Ctx.FireAction(b,s,this,a,s.GetEventDropObjWithScene(e));e.preventDefault();return true;}}return false;}return false;},onsapdrag:function(e){VBI.m_bTrace&&VBI.Trace("onsapdrag in base "+e.type);if(this.IsDataAccepted(e)){return true;}return false;},onsapdown:function(e){VBI.m_bTrace&&VBI.Trace("onsapdown in base "+e.type);var s=this.m_Scene;if(this.m_Track){VBI.m_bTrace&&VBI.Trace("Error: Track object should be already gone");return true;}if(!this.GetHitArray)return false;var h,a=this.GetHitArray(e.offsetX,e.offsetY);if(a.length&&(h=a[0]).m_Design){VBI.m_bTrace&&VBI.Trace("Start Tracking on "+this.m_ID+" caused by "+e.type);this.m_DataSource.Select(h.m_Index);h.m_CBDrag=this.DesignHandleDrag.bind(this);h.m_CBDrop=this.DesignHandleDrop.bind(this);h.m_CBEnd=this.DesignHandleEnd.bind(this);h.m_ClientStartX=e.offsetX;h.m_ClientStartY=e.offsetY;h.m_PosOrig=this.m_Pos.GetValueVector(s.m_Ctx).slice(0);s.SetInputMode(VBI.InputModeTrackObject);s.SetCursor(this.DetailCursor(e,h));if(this.DesignBeginDrag)this.DesignBeginDrag(h);this.m_Track=new s.DesignTrack(h);e.stopPropagation();e.preventDefault();return true;}if(a.length){this.m_DataSource.Select(h.m_Index);if(this.m_DragSourceInfo){var c=s.m_Ctx;var d=this.m_DragSourceInfo.getItemArray(c);if(d.length){s.m_DragInfo={};s.m_DragInfo.aItems=d;s.m_DragInfo.strInstance=this.m_DataSource.m_Path+"."+this.m_DataSource.m_nCurElement;s.m_DragInfo.strScene=this.m_Scene.m_ID;s.m_DragInfo.strID=this.m_ID;s.m_DragInfo.strExtData=this.m_DragData.GetValueString(s.m_Ctx);s.m_DragInfo.bDragStart=false;return true;}}}return false;},DetailClick:function(e,a,h){return false;},DetailContextmenu:function(e,a,h){return false;},DetailCursor:function(e,h){if(h.m_Design){if(h.m_Hit==VBI.HTBOXHANDLE){var c=['nw-resize','n-resize','ne-resize','w-resize','','e-resize','sw-resize','s-resize','se-resize'];return c[h.m_Handle];}else if(h.m_Hit==VBI.HTBOX){return'move';}}return'pointer';},GetSelectColor:function(c,o){var r,a;if(a=this.m_SelectColor.GetValueString(c)){if(r=VBI.Types.string2rhls(a)){var b;if(b=VBI.Types.color2array(o)){var h=VBI.Utilities.RGB2HLS(b[0],b[1],b[2]);var d=VBI.Utilities.HLS2RGB(h[0]+r[0],h[1]*r[1],h[2]*r[2]);return'rgba('+Math.min(Math.round(d[0]),255)+","+Math.min(Math.round(d[1]),255)+","+Math.min(Math.round(d[2]),255)+","+Math.min((r[3]*b[3]).toString(),1.0)+')';}}else if(r=VBI.Types.string2color(a)){return r;}}return o;},GetHotColor:function(c,o){var r,a;if(a=this.m_HotDeltaColor.GetValueString(c)){if(r=VBI.Types.string2rhls(a)){var b;if(b=VBI.Types.color2array(o)){var h=VBI.Utilities.RGB2HLS(b[0],b[1],b[2]);var d=VBI.Utilities.HLS2RGB(h[0]+r[0],h[1]*r[1],h[2]*r[2]);return'rgba('+Math.min(Math.round(d[0]),255)+","+Math.min(Math.round(d[1]),255)+","+Math.min(Math.round(d[2]),255)+","+Math.min((r[3]*b[3]).toString(),1.0)+')';}}else if(r=VBI.Types.string2color(a)){return r;}}return this.m_colorHot;},GetHotScale:function(c){var r;if(r=this.m_HotScale.GetValueVector(c))return r;return[1.0,1.0,1.0];},RectSelect:function(s){var t,o,h=[];for(var n=this.m_BB.length-1;n>=0;--n){if(t=this.m_BB[n])for(var a=this.m_IO[n].length-1;a>=0;--a){var b=this.m_IO[n][a];o=[s[0]-b,s[1],s[2]-b,s[3]];if(t[0]>=o[0]&&t[1]>=o[1]&&t[2]<=o[2]&&t[3]<=o[3])h.push(n);}}return h;},GetLabel:function(c){var l={};var t=this.m_Labeltext.GetValueString(c);if(t){l.labeltext=t;l.bgColor=this.m_LabelBgCol.GetValueColor(c);l.Align=this.m_LabelPos.GetValueLong(c);return l;}else return null;},};VBI.VisualObjects.Spot=function(){this.m_fHotScale=1.2;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_Image=new VBI.AttributeProperty(d,'image',this.m_DataSource,c));this.m_Props.push(this.m_ImageSelected=new VBI.AttributeProperty(d,'imageSelected',this.m_DataSource,c,null));this.m_Props.push(this.m_Icon=new VBI.AttributeProperty(d,'icon',this.m_DataSource,c));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',this.m_DataSource,c));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c,[1.0,1.0,1.0]));this.m_Props.push(this.m_Alignment=new VBI.AttributeProperty(d,'alignment',this.m_DataSource,c,"5"));this.BaseLoad(d,c,this);};this.DetailHitTest=function(o,n,a,b){var i,h,s;var c=o.m_Ctx;var m=n;var d=null;var e=null;h=this.IsHot(m,c);if(this.bUsePreData){m=this.m_BBRefs[n];var I=this.m_Scene.m_PreassembledData[this.m_nPreDataIndex];var f=I[m];i=f.im;if(h)d=f.hcol;s=f.s;}else{this.m_DataSource.Select(m);i=this.m_Image.GetValueString(c);if(h)d=this.m_HotDeltaColor.GetValueString(c);s=this.IsSelected(c);if(s)e=this.m_HotDeltaColor.GetValueString(c);}var g,j=0;if(g=c.GetResources().GetImageBits(i,d,e)){var k=g[0];var r=this.m_BB[n];var w=r[2]-r[0];var l=r[3]-r[1];var p=Math.floor((a-r[0])/w*g[1]);var q=Math.floor((b-r[1])/l*g[2]);j=k[(q*g[1]+p)*4+3];}return(j>0)?{m_hit:(j==255?1:2)}:null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this),m_Ctx:this.m_Scene.m_Ctx};return this.BaseHitTest(n,a,o);};this.ShowGrid=function(c,d,p){if(p!=undefined){var s=this.m_Scene;var a=s.m_Ctx;var b=0;var n=p.length;for(var e=0;e<n;++e){var f=p[e];if(f.cellColor!=undefined)this.ShowGridCell(c,s,d,f);}}};this.RenderThisInstance=function(e,n,a,d){VBI.m_bTrace&&VBI.Trace("Spot: RenderInstance");var s=this.m_Scene;var i=s.m_Ctx.GetResources().GetImage((e.s&&e.simag)?e.simag:e.im,e.s?e.scol:null,e.h?e.hcol:null,s.RenderAsync.bind(s));var b=e.sc;var t=e.tx;var c=e.ct;if(!i)return false;var x=[e[0],e[1]];var z=s.GetCurrentZoomFactors();var w=i.naturalWidth/z[0]*b[0];var h=i.naturalHeight/z[1]*b[1],o=h;if(e.h){if(e.hscale!=undefined){w=w*e.hscale[0];h=h*e.hscale[1];}}var l=x[0]-w/2;var f=x[1]-h;var I=this.m_IO[n]=s.GetInstanceOffsets(this.m_BB[n]=[l,f,l+w,f+h]);this.m_BBRefs.push(a);this.m_BB[n].nI=a;if(this.IsPosChangeable(s.m_Ctx)){var D=this.m_DH[n]=[];if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(this.m_BB[n]);}}if(t)VBI.Utilities.SetTextAttributes(d,(Math.floor(h/2.8)).toString()+"px Arial","rgba( 0, 0, 0, 1.0 )","rgba( 0, 0, 0, 1.0 )","center");for(var g=0;g<I.length;++g){var j=I[g];d.drawImage(i,l+j,f,w,h);if(t)d.fillText(t,l+j+w/2,f+h/2.2);}if(c){var k=Math.floor(o/e.fs);VBI.Utilities.SetTextAttributes(d,(k).toString()+"px "+e.f,e.fc,e.fc,"left");for(var g=0;g<I.length;++g){var j=I[g];d.fillText(c,w+l+j+e.fo,f+(h+k/1.5)/2.0);}}return true;};this.RenderInstance=function(n,d,p,i,t,s,h,l){VBI.m_bTrace&&VBI.Trace("Spot: RenderInstance");if(!i)return;var a=this.m_Scene;var x=a.GetPointFromPos(p,true);var z=a.GetCurrentZoomFactors();var w=i.naturalWidth/z[0]*s[0];var b=i.naturalHeight/z[1]*s[1];if(h){var c=this.GetHotScale(a.m_Ctx);w=Math.round(w*c[0]);b=Math.round(b*c[1]);}var e;var f;var g=parseInt(this.m_Alignment.GetValueString(a.m_Ctx));switch(g){case 0:e=x[0]-w/2;f=x[1]-b/2;break;case 8:e=x[0];f=x[1];break;case 1:e=x[0]-w/2;f=x[1];break;case 2:e=x[0]-w;f=x[1];break;case 3:e=x[0]-w;f=x[1]-b/2;break;case 4:e=x[0]-w;f=x[1]-b;break;case 6:e=x[0];f=x[1]-b;break;case 7:e=x[0];f=x[1]-b/2;break;case 5:default:e=x[0]-w/2;f=x[1]-b;break;}var I=this.m_IO[n]=a.GetInstanceOffsets(this.m_BB[n]=[e,f,e+w,f+b]);if(this.IsPosChangeable(a.m_Ctx)){var D=this.m_DH[n]=[];if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(this.m_BB[n]);}}if(t)VBI.Utilities.SetTextAttributes(d,(Math.floor(b/2.8)).toString()+"px Arial","rgba( 0, 0, 0, 1.0 )","rgba( 0, 0, 0, 1.0 )","center");for(var j=0;j<I.length;++j){var o=I[j];d.drawImage(i,e+o,f,w,b);if(t)d.fillText(t,e+o+w/2,f+b/2.2);}if(l&&I.length){var L={pa:[x[0],x[1],x[2]],bb:null};this.m_Label.push(new VBI.Label(l,null,L,this.m_BB[n],I));}};this.Render=function(c,d,p){this.m_BB=[];this.m_BBRefs=[];this.m_IO=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var s=this.m_Scene;var a=s.m_Ctx;var b=0;this.SwitchPreDataRendering(p!=undefined);if(this.bUsePreData){var e=p.length;for(var n=0;n<e;++n){var f=p[n];if(!f.b2Ignore){if(this.RenderThisInstance(f,b,n,d))b++;}}}else{var g,t;if(g=this.m_DataSource.GetCurrentNode(a)){b=g.m_dataelements.length;for(var n=0;n<b;++n){this.m_DataSource.Select(n);var h=this.IsHot(n);var S=this.IsSelected(a);var i=this.m_Pos.GetValueVector(a);var j=this.m_Image.GetValueString(a);if(S&&(t=this.m_ImageSelected.GetValueString(a)))j=t;var k=this.m_Text.GetValueString(a);var l=this.m_Scale.GetValueVector(a);var m=a.GetResources().GetImage(j,S?this.m_SelectColor.GetValueString(a):null,h?this.m_HotDeltaColor.GetValueString(a):null,s.RenderAsync.bind(s));this.RenderInstance(n,d,i,m,k,l,h,this.GetLabel(a));}}else{}}this.BaseRender(c,d);return b;};this.SwitchPreDataRendering=function(s){if(this.bUsePreData!=s){this.bUsePreData=s;if(s){this.IsHot=this.PreDataIsHot;this.GetEntity=this.PreDataGetEntity;}else{this.IsHot=this.BaseIsHot;this.GetEntity=this.BaseGetEntity;}}};this.DesignBeginDrag=function(o){o.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);o.m_DhOrig=this.m_DH[o.m_Index].slice(0);};this.DesignGetActiveBoxHandles=function(i){return[1,1,1,1,0,1,0,0,0];};this.InternalChangeHotItem=function(n,a){if(this.bUsePreData){var b=this.m_BBRefs[n];if(b!=undefined){var I=this.m_Scene.m_PreassembledData[this.m_nPreDataIndex];if(I[b]!=undefined){I[b].h=a;this.m_HotClusterVO=((a&&I[b].isCl)?I[b]:undefined);}}}};this.BaseIsHot=this.IsHot;this.PreDataIsHot=function(n,c){var a=this.m_BBRefs[n];var I=this.m_Scene.m_PreassembledData[this.m_nPreDataIndex];return I[a].h;};this.BaseGetEntity=this.GetEntity;this.PreDataGetEntity=function(n,c){this.m_DataSource.Select(n);return this.m_Entity.GetValueString(c);};this.SwitchHotItemToStandard=function(){var s=this.m_Scene;var n=this.m_BBRefs[s.m_HotItem.m_Index];var e=(s.m_PreassembledData[this.m_nPreDataIndex])[n];if(e)if(e.isCl==true){s.InternalSetHotItem(null,null);return e;}else{s.m_HotItem.m_Index=e.nI;if(s.m_HotItem.m_HitObj)s.m_HotItem.m_HitObj.m_Index=e.nI;return undefined;}};this.IsClusterable=function(){return true;};this.GetDataIndex=function(B){if(this.bUsePreData){var p=this.m_BBRefs[B];if(p!=undefined){var e=(this.m_Scene.m_PreassembledData[this.m_nPreDataIndex])[p];if(e!=undefined)return e.nI;}}return B;};this.GetInternalIndex=function(B){if(this.bUsePreData)return this.m_BBRefs[B];return B;};this.getTooltip=function(c,h){this.m_DataSource.Select(this.GetDataIndex(h.m_Index));var t=this.m_DataSource.GetIndexedElement(c,this.GetDataIndex(h.m_Index));return this.m_Tooltip.GetValueString(c);};this.DesignBoxSize=VBI.Utilities.SceneBindDesignSpotBoxSize.bind(this);};VBI.VisualObjects.Spot.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Route=function(){this.m_LP=[];this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'posarray',this.m_DataSource,c));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Start=new VBI.AttributeProperty(d,'start',this.m_DataSource,c,0));this.m_Props.push(this.m_End=new VBI.AttributeProperty(d,'end',this.m_DataSource,c,0));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_LineWidth=new VBI.AttributeProperty(d,'linewidth',this.m_DataSource,c,6.0));this.m_Props.push(this.m_DotColor=new VBI.AttributeProperty(d,'dotcolor',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_DotBorderColor=new VBI.AttributeProperty(d,'dotbordercolor',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_DotWidth=new VBI.AttributeProperty(d,'dotwidth',this.m_DataSource,c,0.0));this.BaseLoad(d,c,this);};this.DrawArrow=function(c,a,b){if(a.length<3)return;c.beginPath();c.moveTo(a[0][0],a[0][1]);c.lineTo(a[1][0],a[1][1]);c.lineTo(a[2][0],a[2][1]);c.lineTo(a[0][0],a[0][1]);c.closePath();c.fillStyle=b;c.fill();};this.CalcArrow=function(s,p,a,r,b){var n=p.length/3;var d=2*a*a;var c,e;var t,f,g,h,x=[0,0,0];var F=false;e=r?n-1:0;h=g=[p[e*3],p[e*3+1],0.0];for(c=1;c<n;c++){e=r?n-1-c:c;x=[p[e*3],p[e*3+1],0.0];if(((t=(h[0]-x[0]))*t+(f=(h[1]-x[1]))*f)>d){F=true;break;}}if(!F)return false;var i=x[0]-g[0];var j=x[1]-g[1];while((Math.abs(i)>1000.0)&&(Math.abs(j)>1000.0)){i/=1000.0;j/=1000.0;}var l=Math.sqrt(i*i+j*j);i=(i*a)/l;j=(j*a)/l;var k=g[0]+i;var m=g[1]+j;b.idx=r?n-c-1:c;b.ta=[[g[0],g[1]],[k+j,m-i],[k-j,m+i]];b.pt=[k,m];return true;};this.CalculateLabelPos=function(s,p,o){var z=s.GetCurrentZoomFactors();var r=s.m_Div.getBoundingClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var c=s.m_Canvas[0].getPixelTop()/z[1];var d=[-P,-c,-P+a,-c+b];var e=VBI.Utilities.GetMidpointsForLine(p.pa,o,d);return e.aPos;};this.RenderInstance=function(n,d,p,c,s,e,l,a,b,f,g){var h=this.m_Scene;var i=h.GetNearestPosArray(p);var j=h.GetPointFromPos([i.m_MinX,i.m_MaxY,0.0],false);var r=h.GetPointFromPos([i.m_MaxX,i.m_MinY,0.0],false);var k=Math.max(l,f/2);var I=this.m_IO[n]=h.GetInstanceOffsets(this.m_BB[n]=[j[0]-k,j[1]-k,r[0]+k,r[1]+k]);var m=I.length?h.GetPointArrayFromPosArray(i,false):null;for(var o=0,q=I.length;o<q;++o){d.setTransform(1,0,0,1,I[o],0);this.RenderRoute(n,d,m,c,s,e,l,a,b,f);VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);if(g&&I.length){var t=[0,0,0,0];var u={pa:m,bb:[j,r]};this.m_Label.push(new VBI.Label(g,this.CalculateLabelPos,u,t,I));}};this.RenderRoute=function(n,d,p,c,s,e,l,a,b,f){var g=this.m_Scene;var h=l*l/2;var i=p.length/3;if(i<2)return;var t,j,k=1;var m=i-1;var L=this.m_LP[n];var H=this.m_DH[n];var D=f?[]:null;if(L.length)L=null;if(H&&H.length)H=null;if(H){if(H.m_EditMode==VBI.EMHandle){for(var o=0;o<i;++o)H.push([p[o*3],p[o*3+1]]);}else if(H.m_EditMode==VBI.EMBox){H.push(this.m_BB[n]);}}var r={};var q={};if(l&&s&&this.CalcArrow(g,p,l+5,false,r)){this.DrawArrow(d,r.ta,c);k=r.idx;if(L)L.m_RS=r;}if(l&&e&&this.CalcArrow(g,p,l+5,true,q)){this.DrawArrow(d,q.ta,c);m=q.idx;if(L)L.m_RE=q;}d.strokeStyle=c;d.lineWidth=l;d.lineCap='round';var u=r.pt?[r.pt[0],r.pt[1]]:[p[0],p[1],0.0];if(L)L.push(u);if(D&&!s)D.push(u);d.beginPath();d.moveTo(u[0],u[1]);for(var o=k;o<=m;++o){var x=[p[o*3],p[o*3+1],0.0];if(((t=(u[0]-x[0]))*t+(j=(u[1]-x[1]))*j)<h)continue;if(l)d.lineTo(x[0],x[1]);if(L)L.push(x);if(D)D.push(x);u=x;}if(q.pt){if(l)d.lineTo(q.pt[0],q.pt[1]);if(L)L.push(q.pt);}d.stroke();if(D){d.fillStyle=a;d.strokeStyle=b;d.lineWidth=1;for(var o=0,w=D.length;o<w;++o){var x=D[o];d.beginPath();d.arc(x[0],x[1],f/2.0,0,2.0*Math.PI);d.closePath();d.fill();d.stroke();}}};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_LP=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var b=this.m_Scene.m_Ctx;var e;if(e=this.m_DataSource.GetCurrentNode(b)){for(var n=0,l=e.m_dataelements.length;n<l;++n){this.m_DataSource.Select(n);this.m_LP[n]=[];if(this.IsPosChangeable(b)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode())D.m_EditMode=VBI.EMHandle;else if(this.IsBoxMode())D.m_EditMode=VBI.EMBox;}var h=this.IsHot(n);var s=this.IsSelected(b);var p=this.m_Pos.GetValueVector(b);var f=this.m_Color.GetValueColor(b);if(s)f=this.GetSelectColor(b,f);if(h)f=this.GetHotColor(b,f);var g=this.m_Start.GetValueLong(b);var i=this.m_End.GetValueLong(b);var j=this.m_LineWidth.GetValueFloat(b);if(h)j*=(this.GetHotScale(b))[0];var k=this.m_DotColor.GetValueColor(b);if(s)k=this.GetSelectColor(b,k);if(h)k=this.GetHotColor(b,k);var m=this.m_DotBorderColor.GetValueColor(b);if(s)m=this.GetSelectColor(b,m);if(h)m=this.GetHotColor(b,m);var o=this.m_DotWidth.GetValueFloat(b);this.RenderInstance(n,d,p,f,g,i,j,k,m,o,this.GetLabel(b));}}else{}this.BaseRender(c,d);};this.DetailHitDot=function(n,a,x,y,s){var t,b;return(((t=(x-n))*t+(b=(y-a))*b)<s)?true:false;};this.DetailHitTest=function(o,n,a,b){var x,y,c,d;this.m_DataSource.Select(n);var l=this.m_LineWidth.GetValueLong(this.m_Scene.m_Ctx)/2;var e=this.m_DotWidth.GetValueLong(this.m_Scene.m_Ctx)/2;var s=l*l;var f=e*e;var L=this.m_LP[n];x=L[0][0];y=L[0][1];if(f&&this.DetailHitDot(a,b,x,y,f))return{m_hit:1,m_dot:0};var g=L.length;for(var h=1;h<g;++h){c=L[h][0];d=L[h][1];if(l&&!((a<(Math.min(x,c)-l))||(a>(Math.max(x,c)+l))||(b<(Math.min(y,d)-l))||(b>(Math.max(y,d)+l)))&&(s>VBI.Utilities.sqDistance(x,y,c,d,a,b))){VBI.m_bTrace&&VBI.Trace("VBI.VisualObjects.Route hit line "+n);return{m_hit:1};}if(f&&this.DetailHitDot(a,b,c,d,f)){VBI.m_bTrace&&VBI.Trace("VBI.VisualObjects.Route hit dot "+n);return{m_hit:1,m_dot:h};}x=c;y=d;}if(L.m_RS&&VBI.Utilities.pointInTriangle(L.m_RS.ta,[a,b]))return{m_hit:1,m_arrow:0};if(L.m_RE&&VBI.Utilities.pointInTriangle(L.m_RE.ta,[a,b]))return{m_hit:1,m_arrow:1};return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.DesignBoxSize=VBI.Utilities.SceneBindPosArrayDesignBoxSize.bind(this);};VBI.VisualObjects.Route.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Circle=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(d,'colorBorder',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Radius=new VBI.AttributeProperty(d,'radius',this.m_DataSource,c,5));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Slices=new VBI.AttributeProperty(d,'slices',this.m_DataSource,c,10));this.BaseLoad(d,c,this);};this.CalculateLabelPos=function(s,p,o){var z=s.GetCurrentZoomFactors();var r=s.m_Div.getBoundingClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var c=s.m_Canvas[0].getPixelTop()/z[1];var d=[-P,-c,-P+a,-c+b];var e=VBI.Utilities.GetMidpointForPolygon(p.pa,p.bb,o,d);if(e&&e.aPos){return e.aPos;}return null;};this.RenderInstance=function(n,d,p,c,a,b,s,l){var e=this.m_Scene;var z=e.GetCurrentZoomFactors();var r=b/z[0];var x=e.GetPointFromPos(p,false);var f;var i=this.m_IO[n]=e.GetInstanceOffsets(f=this.m_BB[n]=[x[0]-r,x[1]-r,x[0]+r,x[1]+r]);f.m_Radius=r;f.m_Pos=x;if(this.IsPosChangeable(e.m_Ctx)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(f);}}d.lineWidth=1;d.fillStyle=c;for(var g=0;g<i.length;++g){d.setTransform(1,0,0,1,i[g],0);d.beginPath();d.arc(x[0],x[1],r,0,2*Math.PI);d.closePath();d.fill();d.strokeStyle=a;d.stroke();VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);if(l&&i.length){var h=[0,0,0,0];var j=[];var k=20;for(var g=0;g<k;++g){var t=g*2*Math.PI/k;var m=x[0]+r*Math.sin(t);var o=x[1]+r*Math.cos(t);j.push(m,o);}var q={pa:j,bb:[[f[0],f[1]],[f[2],f[3]]]};this.m_Label.push(new VBI.Label(l,this.CalculateLabelPos,q,h,i));}};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var b=this.m_Scene.m_Ctx;var e=0;var f;if(f=this.m_DataSource.GetCurrentNode(b)){e=f.m_dataelements.length;for(var n=0;n<e;++n){this.m_DataSource.Select(n);var h=this.IsHot(n);var S=this.IsSelected(b);var p=this.m_Pos.GetValueVector(b);var g=this.m_Color.GetValueColor(b);if(S)g=this.GetSelectColor(b,g);if(h)g=this.GetHotColor(b,g);var i=this.m_ColorBorder.GetValueColor(b);if(S)i=this.GetSelectColor(b,i);if(h)i=this.GetHotColor(b,i);var r=this.m_Radius.GetValueFloat(b);if(h)r=(this.GetHotScale(b))[0]*r;var s=this.m_Slices.GetValueLong(b);this.RenderInstance(n,d,p,g,i,r,s,this.GetLabel(b));}}else{}this.BaseRender(c,d);return e;};this.DetailHitTest=function(o,n,a,b){var c=this.m_BB[n];var r=c.m_Radius;var x=c.m_Pos;var t,d;if(((t=(x[0]-a))*t+(d=(x[1]-b))*d)<r*r)return{m_hit:1};return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this),m_zf:z};return this.BaseHitTest(n,a,o);};this.DesignGetActiveBoxHandles=function(i){var s=this.m_Scene;this.m_DataSource.Select(i);return this.m_Radius.IsChangeable(s.m_Ctx)?[0,1,0,1,0,1,0,1,0]:[0,0,0,0,0,0,0,0,0];};this.DesignBoxSize=VBI.Utilities.SceneBindRadiusDesignBoxSize.bind(this);};VBI.VisualObjects.Circle.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.CircleDist=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'midpoint',this.m_DataSource,c));this.m_Props.push(this.m_ColBorder=new VBI.AttributeProperty(d,'colorBorder',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Radius=new VBI.AttributeProperty(d,'radius',this.m_DataSource,c,10));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_ColFill=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Slices=new VBI.AttributeProperty(d,'slices',this.m_DataSource,c,10));this.BaseLoad(d,c,this);};this.CalculateLabelPos=function(s,p,o){var z=s.GetCurrentZoomFactors();var r=s.m_Div.getBoundingClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var c=s.m_Canvas[0].getPixelTop()/z[1];var d=[-P,-c,-P+a,-c+b];var e=VBI.Utilities.GetMidpointForPolygon(p.pa,p.bb,o,d);if(e&&e.aPos){return e.aPos;}return null;};this.RenderCircleDist=function(n,d,a,c,b){var s=this.m_Scene;var l=this.m_LP[n];if(l.length)l=null;var t,e,x,f=s.GetPointFromGeo(a[0],false);d.strokeStyle=b;d.fillStyle=c;d.lineWidth=1;d.beginPath();d.moveTo(f[0],f[1]);l&&l.push(f);for(var g=1;g<a.length;++g){x=s.GetPointFromGeo(a[g],false);if(((t=(f[0]-x[0]))*t+(e=(f[1]-x[1]))*e)<5.0)continue;l&&l.push(x);d.lineTo(x[0],x[1]);f=x;}d.closePath();d.stroke();d.fill();};this.RenderInstance=function(n,d,p,c,a,r,s,l){var b,e=this.m_Scene;var f=VBI.MathLib.EquidistantLonLat(VBI.MathLib.DegToRad(p),r,s);this.m_Pos.IsChangeable(e.m_Ctx)&&(this.m_DH[n]=[e.GetPointFromPos(p,false)]);var g=e.GetPointFromGeo([f.m_MinX,f.m_MaxY,0.0],false);var h=e.GetPointFromGeo([f.m_MaxX,f.m_MinY,0.0],false);var i=this.m_IO[n]=e.GetInstanceOffsets(b=this.m_BB[n]=[g[0],g[1],h[0],h[1]]);if(this.IsPosChangeable(e.m_Ctx)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(e.GetPointFromPos(p,false));}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(b);}}for(var j=0;j<i.length;++j){d.setTransform(1,0,0,1,i[j],0);this.RenderCircleDist(n,d,f,c,a);VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);if(l&&i.length){var k=[0,0,0,0];var m=[];for(var o=0;o<this.m_LP[n].length;++o){m.push(this.m_LP[n][o][0],this.m_LP[n][o][1]);}var q={pa:m,bb:[g,h]};this.m_Label.push(new VBI.Label(l,this.CalculateLabelPos,q,k,i));}};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_LP=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var b=this.m_Scene.m_Ctx;var e;if(e=this.m_DataSource.GetCurrentNode(b)){for(var n=0,l=e.m_dataelements.length;n<l;++n){this.m_DataSource.Select(n);var h=this.IsHot(n);var S=this.IsSelected(b);var p=this.m_Pos.GetValueVector(b);var f=this.m_ColBorder.GetValueColor(b);if(S)f=this.GetSelectColor(b,f);if(h)f=this.GetHotColor(b,f);var r=this.m_Radius.GetValueFloat(b);if(h)r=(this.GetHotScale(b))[0]*r;var s=this.m_Slices.GetValueLong(b);var g=this.m_ColFill.GetValueColor(b);if(S)g=this.GetSelectColor(b,g);if(h)g=this.GetHotColor(b,g);this.m_LP[n]=[];this.RenderInstance(n,d,p,g,f,r,s,this.GetLabel(b));}}else{}this.BaseRender(c,d);};this.DetailHitTest=function(o,n,a,b){return VBI.Utilities.pointInPolygon(this.m_LP[n],a,b)?{m_hit:1}:null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this),m_zf:z};return this.BaseHitTest(n,a,o);};this.DesignGetActiveBoxHandles=function(i){var s=this.m_Scene;this.m_DataSource.Select(i);return this.m_Radius.IsChangeable(s.m_Ctx)?[0,1,0,1,0,1,0,1,0]:[0,0,0,0,0,0,0,0,0];};this.DesignBoxSize=VBI.Utilities.SceneBindMeterRadiusDesignBoxSize.bind(this);};VBI.VisualObjects.CircleDist.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.m_AC=["rgba(0,143,211,1.0)","rgba(153,209,1,1.0)","rgba(243,155,2,1.0)","rgba(159,207,236,1.0)","rgba(75,167,7,1.0)","rgba(246,209,51,1.0)","rgba(203,77,44,1.0)","rgba(202,199,186,1.0)","rgba(13,134,156,1.0)","rgba(205,215,46,1.0)","rgba(36,114,48,1.0)","rgba(108,222,220,1.0)","rgba(235,115,0,1.0)","rgba(185,187,209,1.0)","rgba(0,109,211,1.0)","rgba(61,185,127,1.0)","rgba(165,84,148,1.0)","rgba(1,88,43,1.0)","rgba(77,182,239,1.0)","rgba(175,43,23,1.0)","rgba(212,153,18,1.0)","rgba(187,204,210,1.0)","rgba(48,146,13,1.0)","rgba(29,169,193,1.0)","rgba(42,71,201,1.0)","rgba(209,153,194,1.0)","rgba(204,88,38,1.0)","rgba(114,191,68,1.0)","rgba(10,72,157,1.0)","rgba(151,156,163,1.0)","rgba(14,145,144,1.0)","rgba(97,32,154,1.0)"];VBI.VisualObjects.Pie=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Series=new VBI.NodeProperty(d,'series',this.m_DataSource,c));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c,[1.0,1.0,1.0]));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_Values=new VBI.AttributeProperty(d,'value',this.m_Series,c));this.m_Props.push(this.m_Texts=new VBI.AttributeProperty(d,'text',this.m_Series,c));this.m_Props.push(this.m_SliceColor=new VBI.AttributeProperty(d,'slicecolor',this.m_Series,c));this.m_Props.push(this.m_Tooltips=new VBI.AttributeProperty(d,'extooltip',this.m_Series,c,this.m_defaultTooltip));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_StartColor=new VBI.AttributeProperty(d,'startcolor',this.m_DataSource,c,0));this.BaseLoad(d,c,this);};this.RenderInstance=function(n,d,p,r,a,t,c,b,s){var e=this.m_Scene;var f=e.m_Ctx;var g=0;for(var h=0;h<a.length;++h)g+=a[h];this.m_SUM[n]=g;var x=e.GetPointFromPos(p,false);var z=e.GetCurrentZoomFactors();r/=z[0];var i;var I=this.m_IO[n]=e.GetInstanceOffsets(i=this.m_BB[n]=[x[0]-r,x[1]-r,x[0]+r,x[1]+r]);i.m_Radius=r;i.m_Pos=x;if(this.IsPosChangeable(f)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(i);}}this.m_ARC[n]=[3*Math.PI/2];var j=this.m_StartColor.GetValueLong(f);var k=VBI.VisualObjects.m_AC.length;for(var l=0;l<I.length;++l){d.setTransform(1,0,0,1,I[l],0);var m=3*Math.PI/2;for(var h=0;h<a.length;++h){var o=d.createRadialGradient(x[0],x[1],0,x[0],x[1],r);var q=c[h];if(!q)q=VBI.VisualObjects.m_AC[(h+j)%k];if(s)q=this.GetSelectColor(f,q);if(h==b)q=this.GetHotColor(f,q);o.addColorStop(0,q);o.addColorStop(0.95,q);o.addColorStop(1.0,'rgba(255,255,255,0.0 )');d.fillStyle=o;d.beginPath();d.moveTo(x[0],x[1]);var u=Math.PI*2*(a[h]/g);d.arc(x[0],x[1],r,m,m+u,false);d.lineTo(x[0],x[1]);d.closePath();d.fill();m+=u;if(!l)this.m_ARC[n].push(m);}}d.setTransform(1,0,0,1,0,0);};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_DH=[];this.m_ARC=[];this.m_SUM=[];var s=this.m_Scene;var b=s.m_Ctx;var e=0;var n,f;if(n=this.m_DataSource.GetCurrentNode(b)){e=n.m_dataelements.length;for(var g=0;g<e;++g){this.m_DataSource.Select(g);var p=this.m_Pos.GetValueVector(b);var S=this.m_Scale.GetValueVector(b);var r=16*S[0];var h=this.IsHot(g);var i=this.IsSelected(b);if(h)r=(this.GetHotScale(b))[0]*r;var V=[],t=[],j=[];if(f=this.m_Series.GetCurrentNode(b)){for(var k=0;k<f.m_dataelements.length;++k){this.m_Series.Select(k);V.push(this.m_Values.GetValueFloat(b));t.push(this.m_Texts.GetValueString(b));j.push(this.m_SliceColor.GetValueColor(b));}}var l,m=(h&&(l=s.m_HotItem.m_HitObj)&&(l=l.m_Detail))?l.m_slice:-1;this.RenderInstance(g,d,p,r,V,t,j,m,i);}}else{}this.BaseRender(c,d);return e;};this.DetailHitTest=function(o,n,a,b){var c=this.m_BB[n];var r=c.m_Radius;var p=c.m_Pos;var t,d;if(((t=(p[0]-a))*t+(d=(p[1]-b))*d)<(r*r)){var e=Math.acos(d/Math.sqrt(t*t+d*d));var f=(t<=0?3*Math.PI/2+e:7*Math.PI/2-e);var m=this.m_ARC[n];var l=0,h=m.length-1,g;while(h>l+1){g=Math.round((l+h)/2);if(m[g]>f)h=g;else l=g;}return{m_hit:1,m_slice:l};}return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.doFormatedReplaces=function(m,s,e,a){var l=s.length;while((nIndex=m.indexOf(s))>=0){var n=nIndex+m.substring(nIndex+l).indexOf(e)+l+1;var f=m.substring(nIndex+l,n-1);var u=false,b;if((b=f.indexOf(","))>=0)u=true;else b=f.indexOf(".");var c=Math.min(10,(b>=0?parseInt(f.substring(b+1)):0));var d=m.substring(nIndex,n);var g=""+a.toFixed(c);if(u)g=g.replace(".",",");m=m.replace(d,g);}return m;};this.getTooltip=function(c,h){var p=h.m_Index;var i=h.m_Detail.m_slice;this.m_DataSource.Select(p);this.m_Series.Select(i);var t=this.m_Tooltips.GetValueString(c);if(t=="")t=this.m_Tooltip.GetValueString(c);if((t===null)||(t===""))return"";t=t.replace(/%MAIN%/,this.m_Tooltip.GetValueString(c));t=t.replace(/%NUM%/g,i+1);t=t.replace(/%ONUM%/g,i+1);t=t.replace(/%NAME%/g,this.m_Texts.GetValueString(c));var a=parseFloat(this.m_Values.GetValueString(c));t=this.doFormatedReplaces(t,"%VALUE","%",a);t=this.doFormatedReplaces(t,"%PERCENTAGE","%",100*a/this.m_SUM[p]);return t;};this.DesignBeginDrag=function(o){o.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);o.m_DhOrig=this.m_DH[o.m_Index].slice(0);};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,true);};VBI.VisualObjects.Pie.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Box=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c,[0.0,0.0,0.0]));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c,[1.0,1.0,1.0]));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(d,'colorBorder',this.m_DataSource,c,this.m_defaultColor));this.BaseLoad(d,c,this);};this.RenderInstance=function(n,d,p,s,c,a,e){var g,h=this.m_Scene;if(!s)s=[1.0,1.0,1.0];if(!c)c="#6f6f7a";var x=h.GetPointFromPos(p,false);var z=h.GetCurrentZoomFactors();var i=1.0;sy=1.0;if(this.IsHot(n)){var j=this.GetHotScale(h.m_Ctx);i=j[0];sy=j[1];}var k=370;var m=k*s[0]*i/z[0];var o=k*s[1]*sy/z[1];if(!e){var f=Math.pow(2,h.GetCurrentZoomlevel())/14.6;m*=f;o*=f;}var l=x[0]-m/2;var t=x[1]-o/2;var r=x[0]+m/2;var b=x[1]+o/2;var I=this.m_IO[n]=h.GetInstanceOffsets(g=this.m_BB[n]=[l,t,r,b]);if(this.IsPosChangeable(h.m_Ctx)){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;D.push(x);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(g);}}for(var q=0;q<I.length;++q){d.setTransform(1,0,0,1,I[q],0);d.fillStyle=c;d.fillRect(l,t,m,o);d.lineWidth=1;d.strokeStyle=a;d.strokeRect(l,t,m,o);VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_DH=[];var s=this.m_Scene,b=s.m_Ctx;var e=0;var n;if(n=this.m_DataSource.GetCurrentNode(b)){e=n.m_dataelements.length;for(var f=0;f<e;++f){this.m_DataSource.Select(f);var h=this.IsHot(f);var S=this.IsSelected(b);var p=this.m_Pos.GetValueVector(b);var g=this.m_Scale.GetValueVector(b);var C=this.m_Color.GetValueColor(b);if(S)C=this.GetSelectColor(b,C);if(h)C=this.GetHotColor(b,C);var i=this.m_ColorBorder.GetValueColor(b);if(S)i=this.GetSelectColor(b,i);if(h)i=this.GetHotColor(b,i);var F=this.m_FxSize.GetValueBool(b);this.RenderInstance(f,d,p,g,C,i,F);}}else{}this.BaseRender(c,d);return e;};this.DetailHitTest=function(o,n,a,b){return{m_hit:1};};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.DesignBeginDrag=function(o){o.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);o.m_DhOrig=this.m_DH[o.m_Index].slice(0);};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,false);};VBI.VisualObjects.Box.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Area=function(){this.m_LineWidth=1;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'posarray',this.m_DataSource,c));this.m_Props.push(this.m_Scale=new VBI.AttributeProperty(d,'scale',this.m_DataSource,c));this.m_Props.push(this.m_Color=new VBI.AttributeProperty(d,'color',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_ColorBorder=new VBI.AttributeProperty(d,'colorBorder',this.m_DataSource,c,this.m_defaultColor));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,this.m_defaultTooltip));this.BaseLoad(d,c,this);};this.RenderArea=function(n,d,p,c,a,l,h){var s=l*l/2;var i,x,t,b;var e=p.length/3;if(e<2)return;var L=this.m_LP[n];if(L.length)L=null;d.strokeStyle=a;d.fillStyle=c;d.lineWidth=h>0?2:l;d.lineCap='round';d.beginPath();var f=[p[0],p[1]];if(L)L.push(f);d.moveTo(f[0],f[1]);for(var g=1;g<e;++g){i=g*3;x=[p[i],p[i+1],0.0];if(((t=(f[0]-x[0]))*t+(b=(f[1]-x[1]))*b)<s)continue;d.lineTo(x[0],x[1]);if(L)L.push(x);f=x;}d.closePath();d.fill();d.stroke();};this.CalculateLabelPos=function(s,p,o){var z=s.GetCurrentZoomFactors();var r=s.m_Div.getBoundingClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var c=s.m_Canvas[0].getPixelTop()/z[1];var d=[-P,-c,-P+a,-c+b];var e=VBI.Utilities.GetMidpointsForPolygon(p.pa,p.bb,o,d);if(e&&e.aPos){return e.aPos;}return null;};this.RenderInstance=function(n,d,p,c,a,l,h,b){var s=this.m_Scene;var e=s.GetNearestPosArray(p);var f=s.GetPointFromPos([e.m_MinX,e.m_MaxY,0.0],false);var r=s.GetPointFromPos([e.m_MaxX,e.m_MinY,0.0],false);var i=this.m_IO[n]=s.GetInstanceOffsets(this.m_BB[n]=[f[0]-l,f[1]-l,r[0]+l,r[1]+l]);var g=i.length?s.GetPointArrayFromPosArray(e,false):null;if(this.IsPosChangeable(s.m_Ctx)&&g){var D=(this.m_DH[n]=[]);if(this.IsHandleMode()){D.m_EditMode=VBI.EMHandle;for(var j=0,k=g.length/3;j<k;++j)D.push([g[j*3],g[j*3+1]]);}else if(this.IsBoxMode()){D.m_EditMode=VBI.EMBox;D.push(this.m_BB[n]);}}for(var j=0;j<i.length;++j){d.setTransform(1,0,0,1,i[j],0);this.RenderArea(n,d,g,c,a,l,h);VBI.m_bTrace&&VBI.Utilities.DrawFrameRect(d,"red",this.m_BB[n]);}d.setTransform(1,0,0,1,0,0);if(b&&i.length){var m=[0,0,0,0];var o=[];for(var j=0;j<=g.length-3;j+=3){o.push(g[j],g[j+1]);}var q={pa:o,bb:[f,r]};this.m_Label.push(new VBI.Label(b,this.CalculateLabelPos,q,m,i));}};this.Render=function(c,d,a){this.m_BB=[];this.m_IO=[];this.m_LP=[];this.m_DH=[];if(this.m_Label){for(var n=0;n<this.m_Label.length;++n)this.m_Label[n].clear();this.m_Label=[];}var s=this.m_Scene;var b=s.m_Ctx;var e;if(e=this.m_DataSource.GetCurrentNode(b)){for(var n=0,l=e.m_dataelements.length;n<l;++n){this.m_DataSource.Select(n);this.m_LP[n]=[];var h=this.IsHot(n);var S=this.IsSelected(b);var f=-1;var p=this.m_Pos.GetValueVector(b);var g=this.m_Color.GetValueColor(b);if(S)g=this.GetSelectColor(b,g);var i=this.m_ColorBorder.GetValueColor(b);if(S)i=this.GetSelectColor(b,i);if(h){var j=s.m_HotItem.m_HitObj.m_Detail;if(j&&j.m_edge>=0&&(this.BaseFindAction("EdgeClick")||this.BaseFindAction("EdgeContextMenu"))){f=j.m_edge;i=this.GetHotColor(b,i);}else{g=this.GetHotColor(b,g);i=this.GetHotColor(b,i);}}this.RenderInstance(n,d,p,g,i,this.m_LineWidth,f,this.GetLabel(b));}}else{}this.BaseRender(c,d);};this.DetailHitTest=function(a,n,b,c){if(VBI.Utilities.pointInPolygon(this.m_LP[n],b,c)){var h={m_hit:1};var o;if((o=VBI.Utilities.pointOnLine(this.m_LP[n],b,c,5,true))&&o.m_edge>=0){h.m_edge=o.m_edge;h.m_node=o.m_node;}return h;}return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.ProcessDetailNodeEdgeEvent=function(e,a,h,n){var s=this.m_Scene,b=s.m_Ctx.m_Actions;if(b){var c;if(c=b.findAction(n,s,this)){var p=s.GetEventVPCoordsObj(e);p.edge=h.m_Detail.m_edge.toString();p.node=h.m_Detail.m_node.toString();this.m_Scene.m_Ctx.FireAction(c,s,this,a,p);return true;}}return false;};this.DetailClick=function(e,a,h){if(h.m_Detail&&(h.m_Detail.m_edge>=0))return this.ProcessDetailNodeEdgeEvent(e,a,h,'EdgeClick');return false;};this.DetailContextmenu=function(e,a,h){if(h.m_Detail&&(h.m_Detail.m_edge>=0))return this.ProcessDetailNodeEdgeEvent(e,a,h,'EdgeContextMenu');return false;};this.DesignBoxSize=VBI.Utilities.SceneBindPosArrayDesignBoxSize.bind(this);};VBI.VisualObjects.Area.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.HeatMap=function(){this.load=function(d,c){jQuery.sap.require("sap.ui.vbm.lib."+"sapheatmap");Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_Value=new VBI.AttributeProperty(d,'value',this.m_DataSource,c,1));this.m_Props.push(this.m_Opacity=new VBI.AttributeProperty(d,'opacity',this.m_DataSource,c,0.5));this.m_Props.push(this.m_Gradient=new VBI.AttributeProperty(d,'gradient',this.m_DataSource,c,""));this.BaseLoad(d,c,this);};this.CollectData=function(c){var s=this.m_Scene;var n,a,b,p=[],V=[],m=Number.MAX_VALUE,d=Number.MAX_VALUE,e=-Number.MAX_VALUE,f=-Number.MAX_VALUE;if(b=this.m_DataSource.GetCurrentNode(c)){for(var g=0,l=b.m_dataelements.length;g<l;++g){this.m_DataSource.Select(g);var h=this.m_Pos.GetValueVector(c);n=h[0];a=h[1];if(m>n)m=n;if(e<n)e=n;if(d>a)d=a;if(f<a)f=a;V.push(this.m_Value.GetValueFloat(c));p.push(h[0],h[1],0);}}var i=s.GetPointFromPos([m,f,0.0],false);var r=s.GetPointFromPos([e,d,0.0],false);this.m_IO[0]=s.GetInstanceOffsets([i[0],i[1],r[0],r[1]]);return{pos:this.m_Scene.GetPointArrayFromPosArray(p,false),val:V};};this.Render=function(c,d){this.m_IO=[];var s=this.m_Scene;var b=s.m_Ctx;var w=s.m_nWidthCanvas;var h=s.m_nHeightCanvas;if(!this.Heatmap){var e=document.createElement("canvas");e.width=w;e.height=h;this.Heatmap=VBI.CreateHM({canvas:e,colorTexture:b.GetResources().GetData(this.m_Gradient.GetValueString(b)),alpha:true,width:w,height:h});}var f=this.Heatmap;var V=this.CollectData(b);f.Clear();for(var n=this.m_IO[0].length-1;n>=0;--n){var o=this.m_IO[0][n];for(var g=0,l=V.pos.length/3;g<l;++g)f.AddPoint(V.pos[3*g]+o,V.pos[3*g+1],(V.val[g]+20)/100,70);}f.Render();var a=d.globalAlpha;d.globalAlpha=this.m_Opacity.GetValueFloat(b);d.drawImage(f.m_Canv,0,0);d.globalAlpha=a;};this.DetailHitTest=function(o,n,a,b){return null;};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this)};return this.BaseHitTest(n,a,o);};this.DesignBeginDrag=function(o){o.m_ScaleOrig=this.m_Scale.GetValueVector(this.m_Scene.m_Ctx).slice(0);o.m_DhOrig=this.m_DH[o.m_Index].slice(0);};this.DesignBoxSize=VBI.Utilities.SceneBindDesignBoxBoxSize.bind(this,true);};VBI.VisualObjects.HeatMap.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Container=function(){this.m_ContHash={};this.m_Cont=[];this.m_Sub=[];this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_DataSource=new VBI.NodeProperty(d,'datasource',null,c));this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));this.m_Props.push(this.m_Key=new VBI.AttributeProperty(d,'key',this.m_DataSource,c,""));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',this.m_DataSource,c,""));this.m_Props.push(this.m_Alignment=new VBI.AttributeProperty(d,'alignment',this.m_DataSource,c,"0"));this.m_Sub.push(this.m_Scene.m_EvtCont.subscribe("onMove",this.onLayout.bind(this)));this.m_Sub.push(this.m_Scene.m_EvtCont.subscribe("onZoom",this.onLayout.bind(this)));};this.clear=function(){Object.getPrototypeOf(this).clear();for(var n=0,l=this.m_Sub.lenght;n<l;++n)this.m_Sub[n].unsubscribe();this.m_Sub=[];};this.getParentDiv=function(){return this.m_Scene.m_Div;};this.findContainer=function(i){return this.m_ContHash[i];};this.markContainer=function(c,a){c.m_Mark=a;};this.markContainers=function(a){for(var n=0,l=this.m_Cont.length;n<l;++n)this.m_Cont[n].m_Mark=a;};this.sweepContainers=function(a,c){var p=this.getParentDiv();for(var l=this.m_Cont.length,n=l-1;n>=0;--n){var b=this.m_Cont[n];if(b.m_Mark==a){this.m_Cont.splice(n,1);c.onCloseWindow(b.id,b);p.removeChild(b);}}};this.updateContainers=function(c,s,a){this.markContainers(true);var d=this.getParentDiv();var x=c.getPixelLeft();var y=c.getPixelTop();var t=[];var z=this.m_Scene.GetCurrentZoomFactors();if(node=this.m_DataSource.GetCurrentNode(a)){var b,l=node.m_dataelements.length;for(var n=0,l=node.m_dataelements.length;n<l;++n){this.m_DataSource.Select(n);var p=this.m_Pos.GetValueVector(a);var k=this.m_Key.GetValueString(a);var e=this.m_Tooltip.GetValueString(a);var f=this.m_Alignment.GetValueString(a);var g=s.GetPointFromPos(p,false);if(b=this.findContainer(k)){this.markContainer(b,false);t.push(b);if(!b.children.length)a.onOpenWindow(k,b);}else{b=VBI.Utilities.CreateContainer("vbi_"+k,k,x+(g[0]|0),y+(g[1]|0),"50px","30px",e,500);b.m_ID=this.m_ID;this.markContainer(b,false);t.push(b);d.appendChild(b);a.onOpenWindow(k,b);}}}this.sweepContainers(true,a);this.m_ContHash={};this.m_Cont=t;for(var n=0,l=t.length;n<l;++n)this.m_ContHash[t[n].m_Key]=t[n];};this.onLayout=function(o){this.RenderInstances(o.canvas,[1.0,1.0]);};this.RenderInstances=function(c,z){var s=this.m_Scene;var a=s.m_Ctx;if(this.m_bChanged){this.updateContainers(c,s,a);this.m_bChanged=false;}var x=c.getPixelLeft();var y=c.getPixelTop();if(node=this.m_DataSource.GetCurrentNode(a)){var l=node.m_dataelements.length;for(var n=0,l=node.m_dataelements.length;n<l;++n){var b=this.m_Cont[n];this.m_DataSource.Select(n);var p=this.m_Pos.GetValueVector(a);var d=s.GetPointFromPos(p,true);b.style.left=(x+(d[0]|0)/z[0])+"px";b.style.top=(y+(d[1]|0)/z[1])+"px";var e=this.m_Alignment.GetValueString(a);switch(e){case"0":b.style.msTransform=b.style.transform="translate(-50%, -50%)";break;case"1":b.style.msTransform=b.style.transform="translate(-50%, 0%)";break;case"2":b.style.msTransform=b.style.transform="translate(-100%, 0%)";break;case"3":b.style.msTransform=b.style.transform="translate(-100%, -50%)";break;case"4":b.style.msTransform=b.style.transform="translate(-100%, -100%)";break;case"5":b.style.msTransform=b.style.transform="translate(-50%, -100%)";break;case"6":b.style.msTransform=b.style.transform="translate(0%, -100%)";break;case"7":b.style.msTransform=b.style.transform="translate(0%, -50%)";break;default:case"8":b.style.msTransform=b.style.transform="translate(0%, 0%)";break;}}}};this.Render=function(c,d){var z=this.m_Scene.GetCurrentZoomFactors();if(z[0]!=1.0)return;this.RenderInstances(c,[1.0,1.0]);};this.onclick=function(e){return this.BaseClick(e);};};VBI.VisualObjects.Container.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Base2D=function(){this.m_DOMElement=null;this.m_paddingLeft=5;this.m_paddingTop=5;this.m_paddingRight=5;this.m_paddingBottom=5;this.IsValid=function(){if(this.m_DOMElement&&this.m_Scene.m_Div){if(this.m_DOMElement.parentNode==this.m_Scene.m_Div)return true;}return false;};this.load=function(i,d,c){Object.getPrototypeOf(this).load(i,d,c);i.m_Props.push(i.m_Left=new VBI.AttributeProperty(d,'left',null,c));i.m_Props.push(i.m_Top=new VBI.AttributeProperty(d,'top',null,c));i.m_Props.push(i.m_Right=new VBI.AttributeProperty(d,'right',null,c));i.m_Props.push(i.m_Bottom=new VBI.AttributeProperty(d,'bottom',null,c));i.m_Props.push(i.m_Align=new VBI.AttributeProperty(d,'align',null,c,1));};this.clear=function(){Object.getPrototypeOf(this).clear();this.m_DOMElement=null;};this.BaseClick=function(e){var s=this.m_Scene;var a;if(a=s.m_Ctx.m_Actions){var b;if(b=a.findAction("Click",s,this)){s.m_Ctx.FireAction(b,s,this,null,s.GetEventVPCoordsObj(e));e.preventDefault();return true;}}return false;};};VBI.VisualObjects.Base2D.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Caption=function(){this.m_LineWidth=1;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',null,c,""));this.m_Props.push(this.m_Design=new VBI.AttributeProperty(d,'design',null,c,"0"));this.m_Props.push(this.m_Level=new VBI.AttributeProperty(d,'level',null,c,0));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',null,c,""));};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var f=this.m_Align.GetValueLong(e);var g=this.m_Text.GetValueString(e);var h=this.m_Design.GetValueLong(e);var i=this.m_Level.GetValueLong(e);var j=this.m_Tooltip.GetValueString(e);this.m_DOMElement=VBI.Utilities.CreateCaption(this.m_ID,g,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,j,h,i,f);this.m_Scene.m_Div.appendChild(this.m_DOMElement);};};VBI.VisualObjects.Caption.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Label=function(){this.m_LineWidth=1;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',null,c,""));this.m_Props.push(this.m_Design=new VBI.AttributeProperty(d,'design',null,c,"0"));};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var f=this.m_Align.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var g=this.m_Text.GetValueString(e);this.m_DOMElement=VBI.Utilities.CreateLabel(this.m_ID,g,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,0,f);this.m_Scene.m_Div.appendChild(this.m_DOMElement);};};VBI.VisualObjects.Label.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Link=function(){this.m_LineWidth=1;this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Reference=new VBI.AttributeProperty(d,'reference',null,""));this.m_Props.push(this.m_Autoexecute=new VBI.AttributeProperty(d,'autoexecute',null,c,false));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',null,c,""));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',null,c,""));};this.clear=function(){if(this.m_DOMElement)this.m_DOMElement.onclick=null;Object.getPrototypeOf(this).clear();};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var f=this.m_Align.GetValueLong(e);var g=this.m_Text.GetValueString(e);var h=this.m_Reference.GetValueString(e);var i=this.m_Autoexecute.GetValueBool(e);var j=this.m_Tooltip.GetValueString(e);this.m_DOMElement=VBI.Utilities.CreateLink(this.m_ID,g,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,i?h:null,j,f);this.m_Scene.m_Div.appendChild(this.m_DOMElement);this.m_DOMElement.onclick=this.onclick.bind(this);};this.onclick=function(e){return this.BaseClick(e);};};VBI.VisualObjects.Link.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Image=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Image=new VBI.AttributeProperty(d,'image',null,c));this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',null,c,""));};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var f=this.m_Align.GetValueLong(e);var i=this.m_Image.GetValueString(e);var g=this.m_Tooltip.GetValueString(e);var h;if(h=e.GetResources().GetImage(i)){this.m_DOMElement=VBI.Utilities.CreateImage(this.m_ID,h,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,g,f);this.m_Scene.m_Div.appendChild(this.m_DOMElement);}};};VBI.VisualObjects.Image.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.Button=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Tooltip=new VBI.AttributeProperty(d,'tooltip',null,c,""));this.m_Props.push(this.m_Text=new VBI.AttributeProperty(d,'text',null,c,""));};this.clear=function(){if(this.m_DOMElement)this.m_DOMElement.onclick=null;Object.getPrototypeOf(this).clear();};this.Render=function(c,d,a){if(this.IsValid())return;var e=this.m_Scene.m_Ctx;var l=this.m_Left.GetValueLong(e);var t=this.m_Top.GetValueLong(e);var r=this.m_Right.GetValueLong(e);var b=this.m_Bottom.GetValueLong(e);var f=this.m_Text.GetValueString(e);var g=this.m_Tooltip.GetValueString(e);this.m_DOMElement=VBI.Utilities.CreateButton(this.m_ID,f,l+this.m_paddingLeft,t+this.m_paddingTop,r+this.m_paddingLeft,b+this.m_paddingTop,g);this.m_Scene.m_Div.appendChild(this.m_DOMElement);this.m_DOMElement.onclick=this.onclick.bind(this);};this.onclick=function(e){return this.BaseClick(e);};};VBI.VisualObjects.Button.prototype=new VBI.VisualObjects.Base2D;VBI.VisualObjects.DetailWindowProxy=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);this.m_Props.push(this.m_Pos=new VBI.AttributeProperty(d,'pos',this.m_DataSource,c));};this.DetailHitTest=function(o,n,a,b){return{m_hit:1};};this.GetHitArray=function(x,y){var z=this.m_Scene.GetCurrentZoomFactors();var n=x/z[0];var a=y/z[1];var o={m_cb:this.DetailHitTest.bind(this),m_Ctx:this.m_Scene.m_Ctx};return this.BaseHitTest(n,a,o);};this.Render=function(c,d,a){var s=this.m_Scene;var x=s.GetPointFromPos(pos,true);this.IsPosChangeable(s.m_Ctx)&&this.IsHandleMode()&&(this.m_DH[nIndex]=[x]);this.BaseRender(c,d);};};VBI.VisualObjects.DetailWindowProxy.prototype=VBI.VisualObjects.Base;VBI.VisualObjects.Dummy=function(){this.load=function(d,c){Object.getPrototypeOf(this).load(this,d,c);};this.RenderInstance=function(n,d,x,s,c){};this.Render=function(c,d,a){this.BaseRender(c,d);};};VBI.VisualObjects.Dummy.prototype=VBI.VisualObjects.Base;return v;};
VBI.Windows=function(){var w={};w.vbiclass="Windows";w.m_WindowArray=[];w.find=function(n){for(var a=0,l=w.m_WindowArray.length;a<l;++a)if(w.m_WindowArray[a].m_ID==n)return w.m_WindowArray[a];return null;};w.clear=function(){for(var n=0;n<w.m_WindowArray.length;++n)w.m_WindowArray[n].clear();w.m_WindowArray=[];};w.create=function(d,c){var a=null;switch(d.type){case'callout':a=new VBI.CalloutWindow();break;case'legend':a=new VBI.LegendWindow();break;default:a=new VBI.Window();break;}if(a)a.load(d,c);return a;};w.load=function(d,c){if(d.Remove){if(jQuery.type(d.Remove)=='object'){if(d.Remove.name)w.Remove(d.Remove.name);}else if(jQuery.type(d.Remove)=='array'){for(var n=0,l=d.Remove.length;n<l;++n){if(d.Remove[n].name)w.Remove(d.Remove[n].name);}}}if(d.Set){var b;if(jQuery.type(d.Set)=='object'){if(d.Set.name){if(b=w.find(d.Set.name)){b.load(d.Set.Window,c);return;}else{b=w.create(d.Set.Window,c);w.Add(b);return;}}w.clear();if(d.Set.Window){if(jQuery.type(d.Set.Window)=='object'){b=w.create(d.Set.Window,c);w.Add(b);}else if(jQuery.type(d.Set.Window)=='array'){var a=d.Set.Window;for(var n=0;n<a.length;++n){b=w.create(a[n],c);w.Add(b);}return;}}}else if(jQuery.type(d.Set)=='array'){var a=d.Set;for(var n=0;n<a.length;++n){var i=a[n];if(i.name){if(b=w.find(i.name)){b.load(i.Window,c);}else{b=w.create(i.Window,c);w.Add(b);}}}}}};w.Add=function(a){w.m_WindowArray.push(a);};w.Remove=function(n){var a=null;for(var b=0,l=w.m_WindowArray.length;b<l;++b){if((a=w.m_WindowArray[b]).m_ID==n){a.clear();w.m_WindowArray.splice(b,1);break;}}};w.Awake=function(t){for(var n=0;n<w.m_WindowArray.length;++n)w.m_WindowArray[n].Awake(t);};w.GetMainWindow=function(){for(var n=0;n<w.m_WindowArray.length;++n){if(w.m_WindowArray[n].m_refParent==null)return w.m_WindowArray[n];}return null;};w.NotifyDataChange=function(){var a=w.m_WindowArray;for(var n=0;n<a.length;++n)a[n].NotifyDataChange();return null;};w.NotifySceneMove=function(s){var a=w.m_WindowArray;for(var n=0,l=a.length;n<l;++n)a[n].NotifySceneMove(s);return null;};w.NotifySceneZoom=function(s){var a=w.m_WindowArray;for(var n=0,l=a.length;n<l;++n)a[n].NotifySceneZoom(s);return null;};w.Render=function(){var a=w.m_WindowArray;for(var n=0;n<a.length;++n)a[n].Render();return null;};w.RenderAsync=function(){var a=w.m_WindowArray;for(var n=0;n<a.length;++n)a[n].RenderAsync(true);return null;};return w;};
VBI.Window=function(){this.vbiclass="Window";this.m_ID="";this.m_Caption="";this.m_Type="";this.m_bModal=true;this.m_refScene=null;this.m_refSceneInstance=null;this.m_refParent=null;this.m_Width=null;this.m_Height=null;this.m_Div=null;this.m_Ctx=null;this.BaseLoad=function(i,d,c){if(d.id)i.m_ID=d.id;if(d.caption)i.m_Caption=d.caption;if(d.refParent)i.m_refParent=d.refParent;if(d.modal)i.m_bModal=(d.ref=="true")?true:false;if(d.width)i.m_Width=parseInt(d.width);if(d.height)i.m_Height=parseInt(d.height);i.m_Ctx=c;if(d.refScene)i.m_refScene=d.refScene;else VBI.m_bTrace&&VBI.Trace("Error: no scene assigned to window");};this.BaseClear=function(){var s;if(s=this.GetScene())s.m_Parent=null;this.m_refParent=null;this.m_refScene=null;this.m_refSceneInstance=null;this.m_Ctx=null;this.m_Div=null;};this.clear=function(){this.BaseClear();};this.load=function(d,c){this.BaseLoad(this,d,c);};this.GetScene=function(){if(this.m_refSceneInstance)return this.m_refSceneInstance;this.m_refSceneInstance=(this.m_Ctx&&this.m_Ctx.m_SceneManager)?this.m_Ctx.m_SceneManager.GetSceneByName(this.m_refScene):null;if(this.m_refSceneInstance)this.m_refSceneInstance.m_Parent=this;return this.m_refSceneInstance;};this.GetHostingScene=function(){if(!this.m_refParent)return null;var w;if(w=this.m_Ctx.m_Windows.find(this.m_refParent))return w.GetScene();return null;};this.NotifyDataChange=function(){var s=this.GetScene();if(s)s.NotifyDataChange();};this.NotifySceneMove=function(s){return;};this.NotifySceneZoom=function(s){return;};this.Render=function(){var s=this.GetScene();if(s)s.Render();};this.RenderAsync=function(){var s=this.GetScene();if(s)if(s.RenderAsync)s.RenderAsync(true);else s.Render();};this.Awake=function(t){var s=this.GetScene();if(s)s.Awake(t);else VBI.m_bTrace&&VBI.Trace("Error: Awake no scene assigned to window");};this.Create=function(t){};this.Destroy=function(){if(this.m_Div){}};};
VBI.CalloutWindow=function(){var c=new VBI.Window();c.m_oCallout=null;c.load=function(d,a){c.BaseLoad(c,d,a);c.m_Pos=new VBI.AttributeProperty(d,'pos',null,a);c.m_OffsetX=new VBI.AttributeProperty(d,'offsetX',null,a,0);c.m_OffsetY=new VBI.AttributeProperty(d,'offsetY',null,a,0);};c.clear=function(){c.UnRegisterEvents();c.Remove();c.BaseClear();c.m_oCallout=null;};c.processclosebuttonclick=function(e){c.m_Ctx.onCloseWindow(c.m_ID,c.m_oCallout.m_Content);c.clear();e.preventDefault();e.stopPropagation();};c.IsValid=function(){return(c.m_oCallout&&c.m_oCallout.m_Div)?true:false;};c.NotifySceneMove=function(s){c.UpdatePosition();};c.NotifySceneZoom=function(s){c.UpdatePosition();};c.CalcDivPosition=function(){if(!c.IsValid())return;var p=VBI.m_bIsPhone;if(p){return;}var o=c.m_OffsetX.GetValueLong();var a=c.m_OffsetY.GetValueLong();var b=c.m_Pos.GetValueVector(c.m_Ctx);var h=c.GetHostingScene();var d=h.m_Canvas[h.m_nOverlayIndex];var e=d.getPixelLeft();var f=d.getPixelTop();var t=[];if(b.length>5){var g=d.getPixelWidth();var i=d.getPixelHeight();d.setPixelWidth(h.m_nWidthCanvas);d.setPixelHeight(h.m_nHeightCanvas);h.m_ZoomFactors[0]=g/h.m_nWidthCanvas;h.m_ZoomFactors[1]=i/h.m_nHeightCanvas;var j=h.GetNearestPosArray(b);var l=h.GetPointFromPos([j.m_MinX,j.m_MaxY,0.0],false);var r=h.GetPointFromPos([j.m_MaxX,j.m_MinY,0.0],false);var O=h.GetInstanceOffsets([l[0],l[1],r[0],r[1]]);var k=O.length?h.GetPointArrayFromPosArray(j,false):null;var m;var n=h.m_Div.getBoundingClientRect();var q=n.width/h.m_ZoomFactors[0];var s=n.height/h.m_ZoomFactors[1];var P=e/h.m_ZoomFactors[0];var u=f/h.m_ZoomFactors[1];var v=[-P,-u,-P+q,-u+s];for(var w=0,x=O.length;w<x;++w){m=VBI.Utilities.GetMidpointsForLine(k,O[w],v);if(m.aPos.length>m.max){t=m.aPos[m.max];t[0]*=h.m_ZoomFactors[0];t[1]*=h.m_ZoomFactors[1];break;}}d.setPixelWidth(g);d.setPixelHeight(i);}else{t=h.GetPointFromPos(b,true);var O=h.GetInstanceOffsets([t[0],t[1],t[0],t[1]]);for(var w=0,x=O.length;w<x;++w){var z=h.m_ZoomFactors[0]*O[w];if((t[0]+e+z)>0){t[0]+=z;break;}}}if(t.length>1){t[0]+=e;t[1]+=f;t[0]+=o;t[1]+=a;var y=c.m_oCallout.GetAnchorPoint();t[0]-=y[0];t[1]-=y[1];}else t.push(-1000,-1000);return t;};c.UpdatePosition=function(){if(!c.IsValid())return;var p=c.CalcDivPosition();if(p){c.m_oCallout.m_Div.style.left=Math.round(p[0])+"px";c.m_oCallout.m_Div.style.top=Math.round(p[1])+"px";}else{c.m_oCallout.m_Div.style.top="";c.m_oCallout.m_Div.style.left="0px";c.m_oCallout.m_Div.style.bottom="0px";}};c.Create=function(t){if(c.m_refParent&&!c.m_oCallout){var h;if(h=c.GetHostingScene()){c.m_oCallout=VBI.Utilities.CreateDetail(t+"-"+c.m_ID,0,0,c.m_Width,c.m_Height,c.m_Caption,5,5);c.RegisterEvents();h.m_Div.appendChild(c.m_oCallout.m_Div);c.m_Ctx.onOpenWindow(c.m_ID,c.m_oCallout.m_Content);c.UpdatePosition();}}};c.RegisterEvents=function(){var f=c.processclosebuttonclick.bind(c);c.m_oCallout.m_CloseButton.onclick=f;c.m_oCallout.m_CloseButton.ontouchend=f;};c.UnRegisterEvents=function(){if(!c.m_oCallout||!c.m_oCallout.m_CloseButton)return;c.m_oCallout.m_CloseButton.onclick=null;c.m_oCallout.m_CloseButton.ontouchend=null;};c.Remove=function(){var a=c.m_oCallout;if(!a||!a.m_Div)return;var b=a.m_Div;while(b.firstChild)b.removeChild(b.firstChild);if(b.parentElement)b.parentElement.removeChild(b);c.m_oCallout=null;};c.Awake=function(t){if(this.m_refParent)this.Create(t);var s=this.GetScene();if(s){s.m_Div=c.m_oCallout.m_Content;s.Awake(t);}else VBI.m_bTrace&&VBI.Trace("Error: Awake no scene assigned to window");};return c;};
VBI.LegendWindow=function(){var c=new VBI.Window();c.m_oLegend=null;c.m_Props=[];c.m_Data=[];c.m_bRenew=false;c.load=function(d,a){c.BaseLoad(c,d,a);c.m_Props.push(c.m_DataSource=new VBI.NodeProperty(d,'datasource',null,a));c.m_Props.push(c.m_Colors=new VBI.AttributeProperty(d,'colors',c.m_DataSource,a));c.m_Props.push(c.m_Images=new VBI.AttributeProperty(d,'images',c.m_DataSource,a));c.m_Props.push(c.m_Texts=new VBI.AttributeProperty(d,'texts',c.m_DataSource,a));c.m_Props.push(c.m_Tooltips=new VBI.AttributeProperty(d,'tooltips',c.m_DataSource,a));};c.clear=function(){c.UnRegisterEvents();c.Remove();c.BaseClear();c.m_oLegend=null;if(c.m_Props){for(var n=0;n<c.m_Props.length;++n)c.m_Props[n].clear();c.m_Props=[];}c.m_Data=[];};c.invalidate=function(){c.m_bRenew=true;};c.IsValid=function(){return(c.m_oLegend&&c.m_oLegend.m_Div)?true:false;};c.NotifySceneMove=function(s){};c.NotifySceneZoom=function(s){};c.LegendChanged=function(){var h=c.GetHostingScene();var n;if(n=c.m_DataSource.GetCurrentNode(c.m_Ctx)){var l=n.m_dataelements.length;if(l!=c.m_Data.length)return true;for(var a=0;a<l;++a){c.m_DataSource.Select(a);var t=c.m_Texts.GetValueString(c.m_Ctx);if(t!=c.m_Data[a].text)return true;if(c.m_Data[a].type==1){if(c.m_Data[a].value!=c.m_Images.GetValueString(c.m_Ctx))return true;}else if(c.m_Data[a].type==2){if(c.m_Data[a].value!=c.m_Colors.GetValueColor(c.m_Ctx))return true;}}}else return true;return false;};c.ApplyData=function(){var h=c.GetHostingScene();var n;if(n=c.m_DataSource.GetCurrentNode(c.m_Ctx)){var l=n.m_dataelements.length;for(var a=0;a<l;++a){var b;var i;var o={};c.m_DataSource.Select(a);o.text=c.m_Texts.GetValueString(c.m_Ctx);if(o.text){o.type=0;i=c.m_Images.GetValueString(c.m_Ctx);if(i){o.type=1;o.value=i;}else{b=c.m_Colors.GetValueColor(c.m_Ctx);if(b){o.type=2;o.value=b;}}c.m_Data.push(o);}}}};c.NotifyDataChange=function(){if(c.m_Props){for(var n=0,l=c.m_Props.length;n<l;++n)c.m_Props[n].NotifyDataChange(c.m_Ctx);}if(c.LegendChanged()){c.m_Data=[];if(c.m_oLegend&&c.m_oLegend.m_Table){while(c.m_oLegend.m_Table.rows.length>0){c.m_oLegend.m_Table.deleteRow(-1);}c.ApplyData();c.FillContent();}}};c.Create=function(t){if(c.m_bRenew){c.m_Data=[];if(c.m_oLegend&&c.m_oLegend.m_Table){while(c.m_oLegend.m_Table.rows.length>0){c.m_oLegend.m_Table.deleteRow(-1);}c.ApplyData();c.FillContent();}c.m_bRenew=false;}else if(c.m_refParent&&!c.m_oLegend){var h;if(h=c.GetHostingScene()){c.m_oLegend=VBI.Utilities.CreateLegend(t+"-"+c.m_ID,0,0,c.m_Caption,5,5);c.ApplyData();c.FillContent();c.m_Expanded=true;c.RegisterEvents();h.m_Div.appendChild(c.m_oLegend.m_Div);}}};c.getId=function(a,b){return c.m_oLegend.m_Table.id+'-'+b+'-'+a;};c.FillContent=function(){if(!c.m_Data.length)return;var h=c.GetHostingScene();for(var n=0;n<c.m_Data.length;++n){var r=c.m_oLegend.m_Table.insertRow(-1);var a=r.insertCell(0);var o=c.m_Data[n];if(o.type==2){var b=VBI.Utilities.CreateGeoSceneDivCSS(c.getId(n,'content-celldiv'),'vbi-legend-content-celldiv');b.style.backgroundColor=o.value;a.appendChild(b);}else if(o.type==1){var i;if(i=c.m_Ctx.GetResources().GetImage(o.value,null,null,c.invalidate.bind())){var d=i.cloneNode(true);d.className='vbi-legend-content-celldiv';a.appendChild(d);}}else{a.className="vbi-legend-content-celltext vbi-legend-content-celltext-group";a.colSpan=2;a.innerHTML=o.text;}if(o.type>0){var e=r.insertCell(1);e.className="vbi-legend-content-celltext";e.id=c.getId(n,'content-celltext');e.innerHTML=o.text;}}};c.processtouchend=function(e){document.removeEventListener('touchend',c.processtouchend,true);document.removeEventListener('touchmove',c.processtouchmove,true);};c.processmouseup=function(e){document.removeEventListener('mouseup',c.processmouseup,true);document.removeEventListener('mousemove',c.processmousemove,true);};c.movelegend=function(p){var n=p.slice(0);var h=c.GetHostingScene();if(n[0]<h.m_Div.clientLeft)n[0]=h.m_Div.clientLeft;if(n[0]+c.m_oLegend.m_Div.clientWidth>h.m_Div.clientLeft+h.m_Div.clientWidth)n[0]=h.m_Div.clientLeft+h.m_Div.clientWidth-c.m_oLegend.m_Div.clientWidth;if(n[1]<h.m_Div.clientTop)n[1]=h.m_Div.clientTop;if(n[1]+c.m_oLegend.m_Div.clientHeight>h.m_Div.clientTop+h.m_Div.clientHeight)n[1]=h.m_Div.clientTop+h.m_Div.clientHeight-c.m_oLegend.m_Div.clientHeight;jQuery(c.m_oLegend.m_Div).css('top',n[1]+'px');jQuery(c.m_oLegend.m_Div).css('left',n[0]+'px');jQuery(c.m_oLegend.m_Div).css('right','');};c.processtouchmove=function(e){var t=e.changedTouches[0];var x=parseInt(t.pageX);var y=parseInt(t.pageY);var n=[x-c.m_offset[0],y-c.m_offset[1]];c.movelegend(n);};c.processmousemove=function(e){if(e.which==1){var n=[e.pageX-c.m_offset[0],e.pageY-c.m_offset[1]];c.movelegend(n);}};c.processmousedragstart=function(e){if(e.which==1){c.m_offset=[e.pageX-c.m_oLegend.m_Div.offsetLeft,e.pageY-c.m_oLegend.m_Div.offsetTop];document.addEventListener('mouseup',c.processmouseup,true);document.addEventListener('mousemove',c.processmousemove,true);e.preventDefault();e.stopPropagation();}};c.processtouchdragstart=function(e){touchobj=e.changedTouches[0];var s=parseInt(touchobj.pageX);var a=parseInt(touchobj.pageY);c.m_offset=[s-c.m_oLegend.m_Div.offsetLeft,a-c.m_oLegend.m_Div.offsetTop];document.addEventListener('touchend',c.processtouchend,true);document.addEventListener('touchmove',c.processtouchmove,true);e.preventDefault();e.stopPropagation();};c.collapse=function(e){if(c.m_Expanded){c.m_oLegend.m_ButtonCol.style.visibility='hidden';c.m_oLegend.m_ButtonExp.style.visibility='';c.m_oLegend.m_Content.style.display='none';c.m_Expanded=false;}};c.expand=function(e){if(!c.m_Expanded){c.m_oLegend.m_ButtonCol.style.visibility='';c.m_oLegend.m_ButtonExp.style.visibility='hidden';c.m_oLegend.m_Content.style.display='';c.m_Expanded=true;}};c.RegisterEvents=function(){var f=c.processmousedragstart.bind(c);c.m_oLegend.m_Header.onmousedown=f;var a=c.processtouchdragstart.bind(c);c.m_oLegend.m_Header.ontouchstart=a;var b=c.collapse.bind(c);c.m_oLegend.m_ButtonCol.onclick=b;c.m_oLegend.m_ButtonCol.ontouchend=b;var d=c.expand.bind(c);c.m_oLegend.m_ButtonExp.onclick=d;c.m_oLegend.m_ButtonExp.ontouchend=d;c.m_oLegend.m_Header.style.cursor='pointer';};c.UnRegisterEvents=function(){if(!c.m_oLegend)return;if(c.m_oLegend.m_Header){c.m_oLegend.m_Header.onmousedown=null;c.m_oLegend.m_Header.ontouchstart=null;}if(c.m_oLegend.m_ButtonCol)c.m_oLegend.m_ButtonCol.onclick=c.m_oLegend.m_ButtonCol.ontouchend=null;if(c.m_oLegend.m_ButtonExp)c.m_oLegend.m_ButtonExp.onclick=c.m_oLegend.m_ButtonExp.ontouchend=null;};c.Remove=function(){var a=c.m_oLegend;if(!a||!a.m_Div)return;var b=a.m_Div;while(b.firstChild)b.removeChild(b.firstChild);if(b.parentElement)b.parentElement.removeChild(b);c.m_oLegend=null;};c.Awake=function(t){if(c.m_refParent)c.Create(t);var s=this.GetScene();if(s){s.Awake(t);}else VBI.m_bTrace&&VBI.Trace("Error: Awake no scene assigned to window");};return c;};
jQuery.sap.declare('sap.ui.vbm.library-all');jQuery.sap.declare('sap.ui.vbm.lib.sapactions');jQuery.sap.declare('sap.ui.vbm.lib.sapautomations');jQuery.sap.declare('sap.ui.vbm.lib.sapconfig');jQuery.sap.declare('sap.ui.vbm.lib.sapdataprovider');jQuery.sap.declare('sap.ui.vbm.lib.sapevents');jQuery.sap.declare('sap.ui.vbm.lib.sapgeolocation');jQuery.sap.declare('sap.ui.vbm.lib.sapgeomath');jQuery.sap.declare('sap.ui.vbm.lib.sapgeotool');jQuery.sap.declare('sap.ui.vbm.lib.sapheatmap');jQuery.sap.declare('sap.ui.vbm.lib.sapmaplayer');jQuery.sap.declare('sap.ui.vbm.lib.sapmapmanager');jQuery.sap.declare('sap.ui.vbm.lib.sapmapprovider');jQuery.sap.declare('sap.ui.vbm.lib.sapnavigation');jQuery.sap.declare('sap.ui.vbm.lib.sapparsing');jQuery.sap.declare('sap.ui.vbm.lib.sapprojection');jQuery.sap.declare('sap.ui.vbm.lib.sapresources');jQuery.sap.declare('sap.ui.vbm.lib.sapscale');jQuery.sap.declare('sap.ui.vbm.lib.sapscene');jQuery.sap.declare('sap.ui.vbm.lib.saputilities');jQuery.sap.declare('sap.ui.vbm.lib.sapvbcluster');jQuery.sap.declare('sap.ui.vbm.lib.sapvbi');jQuery.sap.declare('sap.ui.vbm.lib.sapvbicontext');jQuery.sap.declare('sap.ui.vbm.lib.sapvbmenu');jQuery.sap.declare('sap.ui.vbm.lib.sapvobase');jQuery.sap.declare('sap.ui.vbm.lib.sapwindow');if(!jQuery.sap.isDeclared('sap.ui.vbm.VBIRenderer')){
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.vbm.VBIRenderer");sap.ui.vbm.VBIRenderer={};sap.ui.vbm.VBIRenderer.render=function(r,c){r.write("<div align='center'");r.writeControlData(c);r.addClass("vbi-main");r.writeClasses();r.addStyle("width",c.getWidth());r.addStyle("height",c.getHeight());r.writeStyles();r.write(">");if(c.getPlugin()){var i=c.getId();if(c.$oldContent.length===0){if((navigator.appName=="Microsoft Internet Explorer")||/(trident)\/[\w.]+;.*rv:([\w.]+)/i.test(navigator.userAgent)){r.write("<object id='VBI"+i+"'"+" data-sap-ui-preserve='"+i+"' CLASSID='CLSID:00100000-2011-0070-2000-FC7214A1CD7B' "+"width='"+c.getWidth()+"' "+"height='"+c.getHeight()+"' "+">");r.write("<a href='http://scn.sap.com/community/visual-business' > Get the Visual Business PlugIn.</a>");r.write("</object>");}else{r.write("<embed id='VBI"+i+"'"+" data-sap-ui-preserve='"+i+"' type='application/x-visualbusiness' "+"width='"+c.getWidth()+"' "+"height='"+c.getHeight()+"' "+">");}}}r.write("</div>");};};if(!jQuery.sap.isDeclared('sap.ui.vbm.library')){jQuery.sap.declare("sap.ui.vbm.library");jQuery.sap.require('sap.ui.core.Core');jQuery.sap.require('sap.ui.core.library');jQuery.sap.require('sap.ui.commons.library');sap.ui.getCore().initLibrary({name:"sap.ui.vbm",dependencies:["sap.ui.core","sap.ui.commons"],types:[],interfaces:[],controls:["sap.ui.vbm.AnalyticMap","sap.ui.vbm.GeoMap","sap.ui.vbm.VBI"],elements:["sap.ui.vbm.Area","sap.ui.vbm.Areas","sap.ui.vbm.Box","sap.ui.vbm.Boxes","sap.ui.vbm.Circle","sap.ui.vbm.Circles","sap.ui.vbm.Container","sap.ui.vbm.Containers","sap.ui.vbm.DragSource","sap.ui.vbm.DropTarget","sap.ui.vbm.GeoCircle","sap.ui.vbm.GeoCircles","sap.ui.vbm.Legend","sap.ui.vbm.LegendItem","sap.ui.vbm.Pie","sap.ui.vbm.PieItem","sap.ui.vbm.Pies","sap.ui.vbm.Region","sap.ui.vbm.Resource","sap.ui.vbm.Route","sap.ui.vbm.Routes","sap.ui.vbm.Spot","sap.ui.vbm.Spots","sap.ui.vbm.VoAggregation","sap.ui.vbm.VoBase"],version:"1.28.0"});};if(!jQuery.sap.isDeclared('sap.ui.vbm.AnalyticMapRenderer')){jQuery.sap.declare("sap.ui.vbm.AnalyticMapRenderer");sap.ui.vbm.AnalyticMapRenderer={};sap.ui.vbm.AnalyticMapRenderer.render=function(r,c){sap.ui.vbm.VBIRenderer.render(r,c);var a;if(a=c.Update())c.load(a);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.DragSource')){jQuery.sap.declare("sap.ui.vbm.DragSource");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.DragSource",{metadata:{library:"sap.ui.vbm",properties:{"type":{type:"string",group:"Misc",defaultValue:null}}}});};if(!jQuery.sap.isDeclared('sap.ui.vbm.DropTarget')){jQuery.sap.declare("sap.ui.vbm.DropTarget");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.DropTarget",{metadata:{library:"sap.ui.vbm",properties:{"type":{type:"string",group:"Misc",defaultValue:null}}}});};if(!jQuery.sap.isDeclared('sap.ui.vbm.GeoMapRenderer')){jQuery.sap.declare("sap.ui.vbm.GeoMapRenderer");sap.ui.vbm.GeoMapRenderer={};sap.ui.vbm.GeoMapRenderer.render=function(r,c){sap.ui.vbm.VBIRenderer.render(r,c);var a;if(a=c.Update())c.load(a);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Legend')){jQuery.sap.declare("sap.ui.vbm.Legend");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.Legend",{metadata:{library:"sap.ui.vbm",properties:{"caption":{type:"string",group:"Misc",defaultValue:'Legend'}},defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.LegendItem",multiple:true,singularName:"item"}}}});sap.ui.vbm.Legend.prototype.init=function(){};sap.ui.vbm.Legend.prototype.getTemplateObject=function(){var i=this.getId();var w={};if(!this.oParent.getLegendVisible())w={"Remove":[{"name":i}]};else{w={"Set":[{"name":i,"Window":{"id":i,"type":"legend","caption":this.getCaption(),"type":"legend","refParent":"Main","refScene":"","modal":"true","datasource":i,"colors.bind":i+".C","images.bind":i+".I","texts.bind":i+".T","tooltips.bind":i+"TT"}}]};}return w;};sap.ui.vbm.Legend.prototype.getDataObject=function(){var i=this.getItems();var s=[];for(var n=0,l=i.length;n<l;++n){var I=i[n];var e={"C":I.getColor(),"I":I.getImage(),"T":I.getText(),"TT":I.getTooltip()};s.push(e);}return{"name":this.getId(),"E":s};};sap.ui.vbm.Legend.prototype.getTypeObject=function(){return{"A":[{"name":"C","alias":"C","type":"color"},{"name":"I","alias":"I","type":"string"},{"name":"T","alias":"T","type":"string"},{"name":"TT","alias":"TT","type":"string"}]};};};if(!jQuery.sap.isDeclared('sap.ui.vbm.LegendItem')){jQuery.sap.declare("sap.ui.vbm.LegendItem");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.LegendItem",{metadata:{library:"sap.ui.vbm",properties:{"color":{type:"string",group:"Misc",defaultValue:''},"image":{type:"string",group:"Misc",defaultValue:null},"text":{type:"string",group:"Misc",defaultValue:null}}}});};if(!jQuery.sap.isDeclared('sap.ui.vbm.PieItem')){jQuery.sap.declare("sap.ui.vbm.PieItem");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.PieItem",{metadata:{library:"sap.ui.vbm",properties:{"name":{type:"string",group:"Misc",defaultValue:''},"value":{type:"string",group:"Misc",defaultValue:null}},events:{"click":{}}}});sap.ui.vbm.PieItem.M_EVENTS={'click':'click'};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Region')){jQuery.sap.declare("sap.ui.vbm.Region");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.Region",{metadata:{library:"sap.ui.vbm",properties:{"color":{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:null},"code":{type:"string",group:"Misc",defaultValue:null}},events:{"click":{},"contextMenu":{}}}});sap.ui.vbm.Region.M_EVENTS={'click':'click','contextMenu':'contextMenu'};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Resource')){jQuery.sap.declare("sap.ui.vbm.Resource");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.Resource",{metadata:{library:"sap.ui.vbm",properties:{"value":{type:"string",group:"Misc",defaultValue:null},"src":{type:"string",group:"Misc",defaultValue:""},"name":{type:"string",group:"Misc",defaultValue:null}}}});};if(!jQuery.sap.isDeclared('sap.ui.vbm.VBI')){jQuery.sap.declare("sap.ui.vbm.VBI");jQuery.sap.require('sap.ui.core.Control');sap.ui.core.Control.extend("sap.ui.vbm.VBI",{metadata:{publicMethods:["load","zoomToGeoPosition"],library:"sap.ui.vbm",properties:{"width":{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'800px'},"height":{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'600px'},"config":{type:"object",group:"Misc",defaultValue:null},"plugin":{type:"boolean",group:"Misc",defaultValue:false}},events:{"submit":{},"render":{},"zoom":{},"move":{},"openWindow":{},"closeWindow":{}}}});sap.ui.vbm.VBI.M_EVENTS={'submit':'submit','render':'render','zoom':'zoom','move':'move','openWindow':'openWindow','closeWindow':'closeWindow'};jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-core');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-widget');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-mouse');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-draggable');jQuery.sap.require('sap.ui.core.IconPool');sap.ui.vbm.VBI.prototype.exit=function(){if(this.getPlugin()){var p=this.GetPlugInControl();if(p)p.OnSubmit=null;}else{if(this.m_VBIContext)this.m_VBIContext.clear();}if(this.resizeID!=""){sap.ui.core.ResizeHandler.deregister(this.resizeID);this.resizeID="";}};sap.ui.vbm.VBI.prototype.resize=function(e){var c=(this.oControl!=undefined)?this.oControl:this;var a=c.m_VBIContext;if(a){var s=a.GetMainScene();if(s)s.resizeCanvas(e);}};sap.ui.vbm.VBI.prototype.init=function(){this.m_aLoadQueue=null;if(this.getPlugin()){}else{this.m_VBIContext=new VBI.VBIContext(this);}this.resizeID="";};sap.ui.vbm.VBI.prototype.loadNative=function(d){var l=this.getId();var a=document.getElementById('VBI'+l);if(!a)return;var s=function(b){try{var D;if(D=JSON.parse(b)){var v=D.SAPVB;var t=JSON.stringify(v,null,'  ');this.fireSubmit({data:t});}}catch(e){VBI.m_bTrace&&VBI.Trace("Error submitting plugin event");}};if(jQuery.type(d)=='object'){var t=JSON.stringify(d,null,'  ');try{a.Load(t);a.OnSubmit=s.bind(this);}catch(e){}}else if(jQuery.type(d)=='string'){try{a.Load(d);a.OnSubmit=s.bind(this);}catch(e){}}};sap.ui.vbm.VBI.prototype.loadHtml=function(d){var l=this.getId();var a=null;if(typeof d=='string')a=JSON.parse(d.indexOf('{')?d.substr(d.indexOf('{')):d);else if(typeof d=='object')a=d;if(!a)return;if(!a["SAPVB"]){var m;if(this.m_VBIContext&&(m=(new VBI.Adaptor(this.m_VBIContext)).CreateLoadData(a)))return this.loadHtml(m);else return;}var M=false;var b=false;var c=false;var e=false;var f=false;var g=false;var h=false;var i=false;var j=false;var k=false;var n=false;if(jQuery.type(a)=='object'){if(a.SAPVB){if(a.SAPVB.Config){this.m_VBIContext.GetConfig().load(a.SAPVB.Config,this.m_VBIContext);}if(a.SAPVB.Resources){this.m_VBIContext.GetResources().load(a.SAPVB.Resources,this.m_VBIContext);i=true;}if(a.SAPVB.DataTypes){if(!this.m_VBIContext.m_DataTypeProvider)this.m_VBIContext.m_DataTypeProvider=new VBI.DataTypeProvider();this.m_VBIContext.m_DataTypeProvider.load(a.SAPVB.DataTypes,this.m_VBIContext);M=true;}if(a.SAPVB.Data){if(!this.m_VBIContext.m_DataProvider)this.m_VBIContext.m_DataProvider=new VBI.DataProvider();this.m_VBIContext.m_DataProvider.load(a.SAPVB.Data,this.m_VBIContext);b=true;}if(a.SAPVB.MapProviders){if(!this.m_VBIContext.m_MapProviders)this.m_VBIContext.m_MapProviders=new VBI.MapProviders();this.m_VBIContext.m_MapProviders.load(a.SAPVB.MapProviders,this.m_VBIContext);c=true;}if(a.SAPVB.MapLayerStacks){if(!this.m_VBIContext.m_MapLayerStackManager)this.m_VBIContext.m_MapLayerStackManager=new VBI.MapLayerStackManager(this.m_VBIContext);this.m_VBIContext.m_MapLayerStackManager.load(a.SAPVB.MapLayerStacks,this.m_VBIContext);e=true;}if(a.SAPVB.Windows){if(!this.m_VBIContext.m_Windows)this.m_VBIContext.m_Windows=new VBI.Windows();this.m_VBIContext.m_Windows.load(a.SAPVB.Windows,this.m_VBIContext);g=true;}if(a.SAPVB.Actions){if(!this.m_VBIContext.m_Actions)this.m_VBIContext.m_Actions=new VBI.Actions();this.m_VBIContext.m_Actions.load(a.SAPVB.Actions,this.m_VBIContext);h=true;}if(a.SAPVB.Automation){if(!this.m_VBIContext.m_Automations)this.m_VBIContext.m_Automations=new VBI.Automations();this.m_VBIContext.m_Automations.load(a.SAPVB.Automation,this.m_VBIContext);j=true;}if(a.SAPVB.Menus){if(!this.m_VBIContext.m_Menus)this.m_VBIContext.m_Menus=new VBI.Menus();this.m_VBIContext.m_Menus.load(a.SAPVB.Menus,this.m_VBIContext);k=true;}if(a.SAPVB.Clustering){if(!this.m_VBIContext.m_Clustering)this.m_VBIContext.m_Clustering=new VBI.Clustering();this.m_VBIContext.m_Clustering.load(a.SAPVB.Clustering,this.m_VBIContext);n=true;}if(a.SAPVB.Scenes){if(!this.m_VBIContext.m_SceneManager)this.m_VBIContext.m_SceneManager=new VBI.SceneManager();this.m_VBIContext.m_SceneManager.load(a.SAPVB.Scenes,this.m_VBIContext);f=true;}}if(b)if(this.m_VBIContext.m_Windows)this.m_VBIContext.m_Windows.NotifyDataChange();if(f||g){if(this.m_VBIContext.m_Windows)this.m_VBIContext.m_Windows.Awake(l);}if(f||b||n)if(this.m_VBIContext.m_Windows)this.m_VBIContext.m_Windows.RenderAsync();}};sap.ui.vbm.VBI.prototype.load=function(d){if(!this.IsRendered()){if(!this.m_aLoadQueue)this.m_aLoadQueue=[];this.m_aLoadQueue.push(d);return;}if(this.getPlugin())return this.loadNative(d);else return this.loadHtml(d);};sap.ui.vbm.VBI.prototype.zoomToGeoPosition=function(l,a,b){var s=null;if(s=this.m_VBIContext.GetMainScene()){if(jQuery.type(l)=='array'&&jQuery.type(a)=='array'){if(l.length>1&&a.length>1)s.ZoomToMultiplePositions(l,a);else s.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(l[0]),parseFloat(a[0])]),parseFloat(b));}else s.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(l),parseFloat(a)]),parseFloat(b));}};sap.ui.vbm.VBI.prototype.zoomToAreas=function(a,c){var s=null;if(s=this.m_VBIContext.GetMainScene()){s.ZoomToAreas(a,c);}};sap.ui.vbm.VBI.prototype.onAfterRendering=function(){if(this.$oldContent.length>0){this.$().append(this.$oldContent);}if(this.m_aLoadQueue){var n;for(n=0;n<this.m_aLoadQueue.length;++n)this.load(this.m_aLoadQueue[n]);this.m_aLoadQueue=null;}if(this.resizeID==""){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize);}var l=this.getId();if(this.m_VBIContext.m_Windows)this.m_VBIContext.m_Windows.Awake(l);};sap.ui.vbm.VBI.prototype.onBeforeRendering=function(){this.$oldContent=sap.ui.core.RenderManager.findPreservedContent(this.getId());};sap.ui.vbm.VBI.prototype.IsRendered=function(){return this.getDomRef()?true:false;};sap.ui.vbm.VBI.prototype.GetPlugInControl=function(){var l=this.getId();var e=document.getElementById('VBI'+l);return e?e:null;};sap.ui.vbm.VBI.prototype.setConfig=function(c){return this.load(c);};sap.ui.vbm.VBI.prototype.setWidth=function(v){if(typeof v==='number')this.setProperty("width",parseInt(v,10).toString()+"px");else this.setProperty("width",v);};sap.ui.vbm.VBI.prototype.setHeight=function(v){if(typeof v==='number')this.setProperty("height",parseInt(v,10).toString()+"px");else this.setProperty("height",v);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.VoAggregation')){jQuery.sap.declare("sap.ui.vbm.VoAggregation");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.VoAggregation",{metadata:{library:"sap.ui.vbm",events:{"handleMoved":{},"handleContextMenu":{},"handleClick":{}}}});sap.ui.vbm.VoAggregation.M_EVENTS={'handleMoved':'handleMoved','handleContextMenu':'handleContextMenu','handleClick':'handleClick'};sap.ui.vbm.VoAggregation.prototype.IsEventRegistered=function(n){var v=this.getItems();if(!v)return false;for(var a=0,l=v.length;a<l;++a){var i=v[a];if(i.mEventRegistry[n])return true;}return false;};sap.ui.vbm.VoAggregation.prototype.FindInstance=function(n){var v=this.getItems();if(!v)return false;var k=n.split(".")[1];for(var a=0,l=v.length;a<l;++a){if(v[a].sId==k)return v[a];}return null;};sap.ui.vbm.VoAggregation.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["handleMoved"]||this.IsEventRegistered("handleMoved"))a.push({"id":i+"4","name":"handleMoved","refScene":"MainScene","refVO":i,"refEvent":"HandleMoved"});if(this.mEventRegistry["handleContextMenu"]||this.IsEventRegistered("handleContextMenu"))a.push({"id":i+"5","name":"handleContextMenu","refScene":"MainScene","refVO":i,"refEvent":"HandleContextMenu"});if(this.mEventRegistry["handleClick"]||this.IsEventRegistered("handleClick"))a.push({"id":i+"6","name":"handleClick","refScene":"MainScene","refVO":i,"refEvent":"HandleClick"});return a;};};if(!jQuery.sap.isDeclared('sap.ui.vbm.VoBase')){jQuery.sap.declare("sap.ui.vbm.VoBase");jQuery.sap.require('sap.ui.core.Element');sap.ui.core.Element.extend("sap.ui.vbm.VoBase",{metadata:{library:"sap.ui.vbm",properties:{"hotScale":{type:"string",group:"Misc",defaultValue:'1.1;1.1;1.0'},"hotDeltaColor":{type:"string",group:"Misc",defaultValue:'RHLSA(0;1.0;1.0;1.0)'},"selectColor":{type:"string",group:"Misc",defaultValue:'RHLSA(0.0;1.0;1.0;1.0)'},"fxsize":{type:"string",group:"Misc",defaultValue:'true'},"fxdir":{type:"string",group:"Misc",defaultValue:'true'},"entity":{type:"string",group:"Misc",defaultValue:null},"labelText":{type:"string",group:"Misc",defaultValue:null},"labelBgColor":{type:"string",group:"Misc",defaultValue:'RGB(255;255;255)'},"labelPos":{type:"string",group:"Misc",defaultValue:null},"changable":{type:"boolean",group:"Misc",defaultValue:false},"dragData":{type:"string",group:"Misc",defaultValue:null}},events:{"click":{},"contextMenu":{},"handleMoved":{},"handleContextMenu":{},"handleClick":{}}}});sap.ui.vbm.VoBase.M_EVENTS={'click':'click','contextMenu':'contextMenu','handleMoved':'handleMoved','handleContextMenu':'handleContextMenu','handleClick':'handleClick'};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Area')){jQuery.sap.declare("sap.ui.vbm.Area");sap.ui.vbm.VoBase.extend("sap.ui.vbm.Area",{metadata:{publicMethods:["openDetailWindow","openContextMenu"],library:"sap.ui.vbm",properties:{"position":{type:"string",group:"Misc",defaultValue:null},"color":{type:"string",group:"Misc",defaultValue:null},"colorBorder":{type:"string",group:"Misc",defaultValue:null}},events:{"click":{},"contextMenu":{},"edgeClick":{},"edgeContextMenu":{},"drop":{}}}});sap.ui.vbm.Area.M_EVENTS={'click':'click','contextMenu':'contextMenu','edgeClick':'edgeClick','edgeContextMenu':'edgeContextMenu','drop':'drop'};sap.ui.vbm.Area.prototype.openDetailWindow=function(c,o,a){this.oParent.openDetailWindow(this,{caption:c,offsetX:o,offsetY:a});};sap.ui.vbm.Area.prototype.openContextMenu=function(m){this.oParent.openContextMenu(this,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Areas')){jQuery.sap.declare("sap.ui.vbm.Areas");sap.ui.vbm.VoAggregation.extend("sap.ui.vbm.Areas",{metadata:{library:"sap.ui.vbm",defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.Area",multiple:true,singularName:"item"}},events:{"click":{},"contextMenu":{},"edgeClick":{},"edgeContextMenu":{},"drop":{}}}});sap.ui.vbm.Areas.M_EVENTS={'click':'click','contextMenu':'contextMenu','edgeClick':'edgeClick','edgeContextMenu':'edgeContextMenu','drop':'drop'};sap.ui.vbm.Areas.prototype.getTemplateObject=function(){var i=this.getId();return{"type":"{00100000-2012-0004-B001-F311DE491C77}","posarray.bind":i+".P","color.bind":i+".C","colorBorder.bind":i+".CB"};};sap.ui.vbm.Areas.prototype.getDataObject=function(){var v=this.getItems();var s=[];for(var n=0,l=v.length;n<l;++n){var i=v[n];var e={"P":i.getPosition(),"C":i.getColor(),"CB":i.getColorBorder()};s.push(e);}return{"name":this.getId(),"E":s};};sap.ui.vbm.Areas.prototype.getTypeObject=function(){return{"A":[{"changeable":"true","name":"P","alias":"P","type":"vector"},{"name":"C","alias":"C","type":"color"},{"name":"CB","alias":"CB","type":"string"}]};};sap.ui.vbm.Areas.prototype.HandleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var A;if(A=this.FindInstance(e.Action.instance)){if(A.mEventRegistry[s]){if(s=="click"){A.mClickGeoPos=e.Action.AddActionProperties.AddActionProperty[0]['#'];}if(s=="contextMenu"){A.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];jQuery.sap.require("sap.ui.unified.Menu");if(this.oParent.m_VBIContext.m_Menus)this.oParent.m_VBIContext.m_Menus.deleteMenu("DynContextMenu");var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";A.fireContextMenu({data:e,menu:m});}else A[f]({data:e});A[f]({data:e});}}this[f]({data:e});};sap.ui.vbm.Areas.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["click"]||this.IsEventRegistered("click"))a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"]||this.IsEventRegistered("contextMenu"))a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});if(this.mEventRegistry["drop"]||this.IsEventRegistered("drop"))a.push({"id":i+"3","name":"drop","refScene":"MainScene","refVO":i,"refEvent":"Drop"});a=sap.ui.vbm.VoAggregation.prototype.getActionArray.apply(this,arguments);if(this.mEventRegistry["edgeClick"]||this.IsEventRegistered("edgeClick"))a.push({"id":i+"7","name":"edgeClick","refScene":"MainScene","refVO":i,"refEvent":"EdgeClick"});if(this.mEventRegistry["edgeContextMenu"]||this.IsEventRegistered("edgeContextMenu"))a.push({"id":i+"8","name":"edgeContextMenu","refScene":"MainScene","refVO":i,"refEvent":"EdgeContextMenu"});return a;};sap.ui.vbm.Areas.prototype.openDetailWindow=function(i,p){this.oParent.m_bUseClickPos=true;this.oParent.m_DTOpen=true;this.oParent.m_DTSrc=i;this.oParent.m_DTParams=p;this.oParent.m_bWindowsDirty=true;this.oParent.invalidate(this);};sap.ui.vbm.Areas.prototype.openContextMenu=function(i,m){this.oParent.openContextMenu("Area",i,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Box')){jQuery.sap.declare("sap.ui.vbm.Box");sap.ui.vbm.VoBase.extend("sap.ui.vbm.Box",{metadata:{publicMethods:["openDetailWindow","openContextMenu"],library:"sap.ui.vbm",properties:{"position":{type:"string",group:"Misc",defaultValue:'0;0;0'},"scale":{type:"string",group:"Misc",defaultValue:'1;1;1'},"color":{type:"string",group:"Misc",defaultValue:'RGB(255;0;0)'},"colorBorder":{type:"string",group:"Misc",defaultValue:'RGB(255;0;0)'}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Box.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Box.prototype.openDetailWindow=function(c,o,a){this.oParent.openDetailWindow(this,{caption:c,offsetX:o,offsetY:a});};sap.ui.vbm.Box.prototype.openContextMenu=function(m){this.oParent.openContextMenu(this,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Boxes')){jQuery.sap.declare("sap.ui.vbm.Boxes");sap.ui.vbm.VoAggregation.extend("sap.ui.vbm.Boxes",{metadata:{library:"sap.ui.vbm",defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.Box",multiple:true,singularName:"item"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Boxes.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Boxes.prototype.getTemplateObject=function(){var i=this.getId();return{"type":"{00100000-2012-0004-B001-BFED458C3076}","scale.bind":i+".S","pos.bind":i+".P","color.bind":i+".C","colorBorder.bind":i+".CB"};};sap.ui.vbm.Boxes.prototype.getDataObject=function(){var v=this.getItems();var s=[];for(var n=0,l=v.length;n<l;++n){var i=v[n];var e={"P":i.getPosition(),"S":i.getScale(),"C":i.getColor(),"CB":i.getColorBorder()};s.push(e);}return{"name":this.getId(),"E":s};};sap.ui.vbm.Boxes.prototype.getTypeObject=function(){return{"A":[{"changeable":"true","name":"P","alias":"P","type":"vector"},{"changeable":"true","name":"S","alias":"S","type":"vector"},{"name":"C","alias":"C","type":"color"},{"name":"CB","alias":"CB","type":"color"}]};};sap.ui.vbm.Boxes.prototype.HandleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var B;if(B=this.FindInstance(e.Action.instance)){if(B.mEventRegistry[s]){if(s=="click"){B.mClickGeoPos=e.Action.AddActionProperties.AddActionProperty[0]['#'];}if(s=="contextMenu"){B.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];jQuery.sap.require("sap.ui.unified.Menu");if(this.oParent.m_VBIContext.m_Menus)this.oParent.m_VBIContext.m_Menus.deleteMenu("DynContextMenu");var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";B.fireContextMenu({data:e,menu:m});}else B[f]({data:e});}}this[f]({data:e});};sap.ui.vbm.Boxes.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["click"]||this.IsEventRegistered("click"))a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"]||this.IsEventRegistered("contextMenu"))a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});if(this.mEventRegistry["drop"]||this.IsEventRegistered("drop"))a.push({"id":i+"3","name":"drop","refScene":"MainScene","refVO":i,"refEvent":"Drop"});a=sap.ui.vbm.VoAggregation.prototype.getActionArray.apply(this,arguments);return a;};sap.ui.vbm.Boxes.prototype.openDetailWindow=function(i,p){this.oParent.m_bUseClickPos=true;this.oParent.m_DTOpen=true;this.oParent.m_DTSrc=i;this.oParent.m_DTParams=p;this.oParent.m_bWindowsDirty=true;this.oParent.invalidate(this);};sap.ui.vbm.Boxes.prototype.openContextMenu=function(i,m){this.oParent.openContextMenu("Box",i,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Circle')){jQuery.sap.declare("sap.ui.vbm.Circle");sap.ui.vbm.VoBase.extend("sap.ui.vbm.Circle",{metadata:{publicMethods:["openDetailWindow","openContextMenu"],library:"sap.ui.vbm",properties:{"position":{type:"string",group:"Misc",defaultValue:'0;0;0'},"radius":{type:"string",group:"Misc",defaultValue:'20'},"color":{type:"string",group:"Misc",defaultValue:'RGBA(0,0,128,128)'},"colorBorder":{type:"string",group:"Misc",defaultValue:'RGB(0,0,0)'},"slices":{type:"string",group:"Misc",defaultValue:null}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Circle.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Circle.prototype.openDetailWindow=function(c,o,a){this.oParent.openDetailWindow(this,{caption:c,offsetX:o,offsetY:a});};sap.ui.vbm.Circle.prototype.openContextMenu=function(m){this.oParent.openContextMenu(this,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Circles')){jQuery.sap.declare("sap.ui.vbm.Circles");sap.ui.vbm.VoAggregation.extend("sap.ui.vbm.Circles",{metadata:{library:"sap.ui.vbm",defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.Circle",multiple:true,singularName:"item"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Circles.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Circles.prototype.HandleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var c;if(c=this.FindInstance(e.Action.instance)){if(c.mEventRegistry[s]){if(s=="contextMenu"){c.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];jQuery.sap.require("sap.ui.unified.Menu");if(this.oParent.m_VBIContext.m_Menus)this.oParent.m_VBIContext.m_Menus.deleteMenu("DynContextMenu");var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";c.fireContextMenu({data:e,menu:m});}else c[f]({data:e});}}this[f]({data:e});};sap.ui.vbm.Circles.prototype.getTemplateObject=function(){var i=this.getId();return{"id":i,"type":"{00100000-2013-0004-B001-7EB3CCC039C4}","datasource":i,"pos.bind":i+".P","tooltip.bind":i+".TT","radius.bind":i+".R","color.bind":i+".C","colorBorder.bind":i+".CB","slices.bind":i+".S"};};sap.ui.vbm.Circles.prototype.getDataObject=function(){var v=this.getItems();var s=[];for(var n=0,l=v.length;n<l;++n){var i=v[n];var e={"P":i.getPosition(),"TT":i.getTooltip(),"R":i.getRadius(),"C":i.getColor(),"CB":i.getColorBorder(),"S":i.getSlices()};s.push(e);}return{"E":s};};sap.ui.vbm.Circles.prototype.getTypeObject=function(){return{"A":[{"changeable":"true","name":"P","alias":"P","type":"vector"},{"name":"TT","alias":"TT","type":"string"},{"changeable":"true","name":"R","alias":"R","type":"double"},{"name":"C","alias":"C","type":"color"},{"name":"CB","alias":"CB","type":"color"},{"name":"S","alias":"S","type":"long"}]};};sap.ui.vbm.Circles.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["click"]||this.IsEventRegistered("click"))a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"]||this.IsEventRegistered("contextMenu"))a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});if(this.mEventRegistry["drop"]||this.IsEventRegistered("drop"))a.push({"id":i+"3","name":"drop","refScene":"MainScene","refVO":i,"refEvent":"Drop"});a=sap.ui.vbm.VoAggregation.prototype.getActionArray.apply(this,arguments);return a;};sap.ui.vbm.Circles.prototype.openDetailWindow=function(i,p){this.oParent.m_bUseClickPos=false;this.oParent.m_DTOpen=true;this.oParent.m_DTSrc=i;this.oParent.m_DTParams=p;this.oParent.m_bWindowsDirty=true;this.oParent.invalidate(this);};sap.ui.vbm.Circles.prototype.openContextMenu=function(i,m){this.oParent.openContextMenu("Circle",i,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Container')){jQuery.sap.declare("sap.ui.vbm.Container");sap.ui.vbm.VoBase.extend("sap.ui.vbm.Container",{metadata:{publicMethods:["propagateModels"],library:"sap.ui.vbm",properties:{"position":{type:"string",group:"Misc",defaultValue:null},"alignment":{type:"string",group:"Misc",defaultValue:'0'}},aggregations:{"item":{type:"sap.ui.core.Control",multiple:false}},events:{"click":{},"contextMenu":{}}}});sap.ui.vbm.Container.M_EVENTS={'click':'click','contextMenu':'contextMenu'};sap.ui.vbm.Container.prototype.init=function(){this._oItem=null;};sap.ui.vbm.Container.prototype.getItem=function(){return this._oItem;};sap.ui.vbm.Container.prototype.setItem=function(i){return this._oItem=i;};sap.ui.vbm.Container.prototype.clone=function(i){var c=sap.ui.core.Control.prototype.clone.apply(this,arguments);c.setItem(this.getItem().clone());return c;};sap.ui.vbm.Container.prototype.exit=function(i){if(this._oItem){this._oItem.destroy();}delete this._oItem;};sap.ui.vbm.Container.prototype.propagateModels=function(t){for(var n in this.oPropagatedProperties.oModels){(n==="undefined")?t.setModel(this.oPropagatedProperties.oModels[n]):t.setModel(this.oPropagatedProperties.oModels[n],n);}for(var n in this.oModels){(n==="undefined")?t.setModel(this.oModels[n]):t.setModel(this.oModels[n],n);}};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Containers')){jQuery.sap.declare("sap.ui.vbm.Containers");sap.ui.vbm.VoAggregation.extend("sap.ui.vbm.Containers",{metadata:{library:"sap.ui.vbm",defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.Container",multiple:true,singularName:"item"}},events:{"click":{},"contextMenu":{}}}});sap.ui.vbm.Containers.M_EVENTS={'click':'click','contextMenu':'contextMenu'};sap.ui.vbm.Containers.prototype.getTemplateObject=function(){var i=this.getId();return{"type":"{00100000-2012-0004-B001-2297943F0CE6}","pos.bind":i+".P","key.bind":i+".IK","alignment.bind":i+".AL",};};sap.ui.vbm.Containers.prototype.getDataObject=function(){var v=this.getItems();var s=[];for(var n=0,l=v.length;n<l;++n){var i=v[n];var e={"P":i.getPosition(),"IK":i.getId(),"AL":i.getAlignment(),};s.push(e);}return{"name":this.getId(),"E":s};};sap.ui.vbm.Containers.prototype.getTypeObject=function(){return{"A":[{"changeable":"true","name":"P","alias":"P","type":"vector"},{"name":"IK","alias":"IK","type":"key"},{"name":"AL","alias":"AL","type":"string"}]};};sap.ui.vbm.Containers.prototype.HandleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var C;if(C=this.FindInstance(e.Action.instance))if(C.mEventRegistry[s])C[f]({data:e});this[f]({data:e});};sap.ui.vbm.Containers.prototype.HandleOpenWindow=function(e){var c=this.FindInstance(e.mParameters.id);var i=c.getItem();if(i){var a=e.getParameter("contentarea").id;var C=sap.ui.getCore();var o=C.createUIArea(a);c.propagateModels(o);o.addContent(i);i.setBindingContext(c.getBindingContext());}};sap.ui.vbm.Containers.prototype.HandleCloseWindow=function(e){var i=this.FindInstance(e.mParameters.id);};sap.ui.vbm.Containers.prototype.FindInstance=function(k){var v=this.getItems();if(!v)return false;for(var n=0,l=v.length;n<l;++n){if(v[n].sId==k)return v[n];}return null;};sap.ui.vbm.Containers.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["click"]||this.IsEventRegistered("click"))a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"]||this.IsEventRegistered("contextMenu"))a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});a=sap.ui.vbm.VoAggregation.prototype.getActionArray.apply(this,arguments);return a;};};if(!jQuery.sap.isDeclared('sap.ui.vbm.GeoCircle')){jQuery.sap.declare("sap.ui.vbm.GeoCircle");sap.ui.vbm.VoBase.extend("sap.ui.vbm.GeoCircle",{metadata:{publicMethods:["openDetailWindow","openContextMenu"],library:"sap.ui.vbm",properties:{"position":{type:"string",group:"Misc",defaultValue:'0;0;0'},"colorBorder":{type:"string",group:"Misc",defaultValue:'RGB(0,0,0)'},"radius":{type:"string",group:"Misc",defaultValue:'10000'},"color":{type:"string",group:"Misc",defaultValue:'RGB(0,0,0)'},"slices":{type:"string",group:"Misc",defaultValue:'20'}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.GeoCircle.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.GeoCircle.prototype.openDetailWindow=function(c,o,a){this.oParent.openDetailWindow(this,{caption:c,offsetX:o,offsetY:a});};sap.ui.vbm.GeoCircle.prototype.openContextMenu=function(m){this.oParent.openContextMenu(this,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.GeoCircles')){jQuery.sap.declare("sap.ui.vbm.GeoCircles");sap.ui.vbm.VoAggregation.extend("sap.ui.vbm.GeoCircles",{metadata:{library:"sap.ui.vbm",defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.GeoCircle",multiple:true,singularName:"item"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.GeoCircles.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.GeoCircles.prototype.getTemplateObject=function(){var i=this.getId();return{"type":"{00100000-2013-0004-B001-686F01B57873}","midpoint.bind":i+".P","radius.bind":i+".R","color.bind":i+".C","slices.bind":i+".NS",};};sap.ui.vbm.GeoCircles.prototype.getDataObject=function(){var v=this.getItems();var s=[];for(var n=0,l=v.length;n<l;++n){var i=v[n];var e={"P":i.getPosition(),"R":i.getRadius(),"C":i.getColor(),"NS":i.getSlices()};s.push(e);}return{"name":this.getId(),"E":s};};sap.ui.vbm.GeoCircles.prototype.getTypeObject=function(){return{"A":[{"changeable":"true","name":"P","alias":"P","type":"vector"},{"changeable":"true","name":"R","alias":"R","type":"long"},{"name":"C","alias":"C","type":"string"},{"name":"NS","alias":"NS","type":"long"}]};};sap.ui.vbm.GeoCircles.prototype.HandleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var G;if(G=this.FindInstance(e.Action.instance)){if(G.mEventRegistry[s]){if(s=="click"){G.mClickGeoPos=e.Action.AddActionProperties.AddActionProperty[0]['#'];}if(s=="contextMenu"){G.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];jQuery.sap.require("sap.ui.unified.Menu");if(this.oParent.m_VBIContext.m_Menus)this.oParent.m_VBIContext.m_Menus.deleteMenu("DynContextMenu");var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";G.fireContextMenu({data:e,menu:m});}else G[f]({data:e});}}this[f]({data:e});};sap.ui.vbm.GeoCircles.prototype.openDetailWindow=function(i,p){this.oParent.m_bUseClickPos=true;this.oParent.m_DTOpen=true;this.oParent.m_DTSrc=i;this.oParent.m_DTParams=p;this.oParent.m_bWindowsDirty=true;this.oParent.invalidate(this);};sap.ui.vbm.GeoCircles.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["click"]||this.IsEventRegistered("click"))a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"]||this.IsEventRegistered("contextMenu"))a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});if(this.mEventRegistry["drop"]||this.IsEventRegistered("drop"))a.push({"id":i+"3","name":"drop","refScene":"MainScene","refVO":i,"refEvent":"Drop"});a=sap.ui.vbm.VoAggregation.prototype.getActionArray.apply(this,arguments);return a;};sap.ui.vbm.GeoCircles.prototype.openContextMenu=function(i,m){this.oParent.openContextMenu("GeoCircle",i,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.GeoMap')){jQuery.sap.declare("sap.ui.vbm.GeoMap");sap.ui.vbm.VBI.extend("sap.ui.vbm.GeoMap",{metadata:{library:"sap.ui.vbm",properties:{"mapConfiguration":{type:"object",group:"Misc",defaultValue:null},"legendVisible":{type:"boolean",group:"Misc",defaultValue:true}},defaultAggregation:"vos",aggregations:{"vos":{type:"sap.ui.vbm.VoAggregation",multiple:true,singularName:"vo"},"resources":{type:"sap.ui.vbm.Resource",multiple:true,singularName:"resource"},"legend":{type:"sap.ui.vbm.Legend",multiple:false}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.GeoMap.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.GeoMap.DefaultApplicationURL="media/geomap/geomap.json";sap.ui.vbm.GeoMap.prototype.exit=function(){sap.ui.vbm.VBI.prototype.exit.apply(this,arguments);this.detachEvent('submit',sap.ui.vbm.GeoMap.prototype.onGeoMapSubmit,this);this.detachEvent('openWindow',sap.ui.vbm.GeoMap.prototype.onGeoMapOpenWindow,this);this.detachEvent('closeWindow',sap.ui.vbm.GeoMap.prototype.onGeoMapCloseWindow,this);};sap.ui.vbm.GeoMap.prototype.resize=function(e){sap.ui.vbm.VBI.prototype.resize.apply(this,arguments);};sap.ui.vbm.GeoMap.prototype.onAfterRendering=function(){sap.ui.vbm.VBI.prototype.onAfterRendering.apply(this,arguments);};sap.ui.vbm.GeoMap.prototype.destroyResources=function(){this.m_bResourcesDirty=true;return this.destroyAggregation("resources");};sap.ui.vbm.GeoMap.prototype.addResource=function(o){this.m_bResourcesDirty=true;return this.addAggregation("resources",o);};sap.ui.vbm.GeoMap.prototype.removeResource=function(o){this.m_bResourcesDirty=true;return this.removeAggregation("resources",o);};sap.ui.vbm.GeoMap.prototype.removeAllResources=function(o){this.m_bResourcesDirty=true;return this.removeAllAggregation("resources");};sap.ui.vbm.GeoMap.prototype.destroyVos=function(){this.m_bVosDirty=true;return this.destroyAggregation("vos");};sap.ui.vbm.GeoMap.prototype.addVo=function(o){this.m_bVosDirty=true;return this.addAggregation("vos",o);};sap.ui.vbm.GeoMap.prototype.removeVo=function(o){this.m_bVosDirty=true;return this.removeAggregation("vos",o);};sap.ui.vbm.GeoMap.prototype.removeAllVos=function(o){this.m_bVosDirty=true;return this.removeAllAggregation("vos");};sap.ui.vbm.GeoMap.prototype.setMapConfiguration=function(o){this.m_bMapConfigurationDirty=true;this.setProperty("mapConfiguration",o);};sap.ui.vbm.GeoMap.prototype.onGeoMapSubmit=function(e){var d=JSON.parse(e.mParameters.data);var c;if(c=this.GetAggregatorContainer(d.Action.object))return c.HandleEvent(d);switch(d.Action.name){case"click":this.fireClick({pos:d.Action.AddActionProperties.AddActionProperty[0]['#']});break;case"contextMenu":this.fireContextMenu({clientX:d.Action.Params.Param[0]['#'],clientY:d.Action.Params.Param[1]['#'],pos:d.Action.AddActionProperties.AddActionProperty[0]['#']});break;case"drop":this.fireDrop({pos:d.Action.AddActionProperties.AddActionProperty[0]['#']});break;};};sap.ui.vbm.GeoMap.prototype.onGeoMapOpenWindow=function(e){var d=e.getParameter("contentarea");if(d.m_ID){var c;if(c=this.GetAggregatorContainer(d.m_ID))if(c.HandleOpenWindow)c.HandleOpenWindow(e);}};sap.ui.vbm.GeoMap.prototype.onGeoMapCloseWindow=function(e){var d=e.getParameter("contentarea");if(d.m_ID){var c;if(c=this.GetAggregatorContainer(d.m_ID))if(c.HandleCloseWindow)c.HandleCloseWindow(e);}if(this.m_DTOpen&&e.getParameter("id")=="Detail"){this.m_DTOpen=false;this.m_DTSrc=null;this.m_bWindowsDirty=true;}};sap.ui.vbm.GeoMap.prototype.init=function(){this.attachEvent('submit',sap.ui.vbm.GeoMap.prototype.onGeoMapSubmit,this);this.attachEvent('openWindow',sap.ui.vbm.GeoMap.prototype.onGeoMapOpenWindow,this);this.attachEvent('closeWindow',sap.ui.vbm.GeoMap.prototype.onGeoMapCloseWindow,this);this.m_bVosDirty=true;this.m_bMapConfigurationDirty=true;this.m_bResourcesDirty=true;this.m_bMapProvidersDirty=true;this.m_bMapLayerStacksDirty=true;this.m_bWindowsDirty=true;this.m_bMapconfigDirty=true;this.m_bLegendDirty=true;sap.ui.vbm.VBI.prototype.init.apply(this,arguments);};sap.ui.vbm.GeoMap.prototype.getWindowsObject=function(){var w={"Set":[{"name":"Main","Window":{"id":"Main","caption":"MainWindow","type":"geo","refParent":"","refScene":"MainScene","modal":"true"}}]};var l=this.getLegend();if(l){var L=l.getTemplateObject();if(L.Set)w.Set=w.Set.concat(L.Set);if(L.Remove){if(!w.Remove)w.Remove=L.Remove;else w.Set=w.Set.concat(L.Remove);}}if(this.m_DTSrc&&this.m_DTOpen){var d;if(this.m_bUseClickPos==true&&this.m_DTSrc.mClickGeoPos)d={"Set":[{"name":"Detail","Window":{"id":"Detail","type":"callout","refParent":"Main","refScene":"","modal":"true","caption":this.m_DTParams.caption?this.m_DTParams.caption:"","offsetX":this.m_DTParams.offsetX?this.m_DTParams.offsetX:"0","offsetY":this.m_DTParams.offsetY?this.m_DTParams.offsetY:"0","pos":this.m_DTSrc.mClickGeoPos}}]};else d={"Set":[{"name":"Detail","Window":{"id":"Detail","type":"callout","refParent":"Main","refScene":"","modal":"true","caption":this.m_DTParams.caption?this.m_DTParams.caption:"","offsetX":this.m_DTParams.offsetX?this.m_DTParams.offsetX:"0","offsetY":this.m_DTParams.offsetY?this.m_DTParams.offsetY:"0","pos.bind":this.m_DTSrc.oParent.sId+"."+this.m_DTSrc.sId+".P"}}]};w.Set=w.Set.concat(d.Set);var D={"Remove":[{"name":"Detail"}]};if(!w.Remove)w.Remove=D.Remove;else w.Set=w.Set.concat(D.Remove);}return w;};sap.ui.vbm.GeoMap.prototype.getTemplateObject=function(v){var t=v.getTemplateObject(),i=v.getId();t['id']=i;t['datasource']=i;t['hotScale.bind']=t.id+".HS";t['hotDeltaColor.bind']=t.id+".HDC";t['selectColor.bind']=t.id+".SC";t['fxsize.bind']=t.id+".FS";t['fxdir.bind']=t.id+".FD";t['entity.bind']=t.id+".ET";t['labelText.bind']=t.id+".LT";t['labelBgColor.bind']=t.id+".LBC";t['labelPos.bind']=t.id+".LP";t['tooltip.bind']=t.id+".TT";return t;};sap.ui.vbm.GeoMap.prototype.getDataObject=function(v,n){var t=v.getDataObject();t['name']=v.getId();if(n)return t;var s=t.E;var V=v.getItems();for(var a=0,l=V.length;a<l;++a){var b,i=s[a],o=V[a];i['K']=o.getId();i['VB:c']=o.getChangable();i['HS']=o.getHotScale();i['HDC']=o.getHotDeltaColor();i['SC']=o.getSelectColor();i['FS']=o.getFxsize();i['FD']=o.getFxdir();i['ET']=o.getEntity();i['LT']=o.getLabelText();i['LBC']=o.getLabelBgColor();i['LP']=o.getLabelPos();i['TT']=(b=o.getTooltip())?b:"";}return t;};sap.ui.vbm.GeoMap.prototype.getTypeObject=function(v,n){var t=v.getTypeObject();var i=v.getId();t['name']=i;if(n)return t;t['key']='K';var a=t.A;t.A=a.concat([{"name":"K","alias":"K","type":"string"},{"name":"HS","alias":"HS","type":"vector"},{"name":"HDC","alias":"HDC","type":"string"},{"name":"SC","alias":"SC","type":"string"},{"name":"FS","alias":"FS","type":"boolean"},{"name":"ET","alias":"ET","type":"string"},{"name":"LT","alias":"LT","type":"string"},{"name":"LBC","alias":"LBC","type":"color"},{"name":"LP","alias":"LP","type":"long"},{"name":"TT","alias":"TT","type":"string"}]);return t;};sap.ui.vbm.GeoMap.prototype.getActionArray=function(v,s){var t=(s)?s:[];if(v){t=v.getActionArray(s);}else{var i=this.getId();if(this.mEventRegistry["click"])t.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":"Map","refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"])t.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":"Map","refEvent":"ContextMenu","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["drop"])t.push({"id":i+"3","name":"drop","refScene":"MainScene","refVO":"Map","refEvent":"Drop","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["submit"])t.push({"id":i+"4","name":"zoomChanged","refScene":"MainScene","refVO":"Map","refEvent":"ZoomChanged","AddActionProperty":[{"name":"zoom"},{"name":"centerpoint"},{"name":"pos"}]});if(this.mEventRegistry["submit"])t.push({"id":i+"5","name":"centerChanged","refScene":"MainScene","refVO":"Map","refEvent":"CenterChanged","AddActionProperty":[{"name":"zoom"},{"name":"centerpoint"},{"name":"pos"}]});}return t;};sap.ui.vbm.GeoMap.prototype.MinimizeApp=function(a){var t,s;s=null;if(!this.m_bWindowsDirty)(t=a)&&(t=t.SAPVB)&&(t=t.Windows)&&(s=JSON.stringify(t))&&(s==this.m_curWindows)&&(delete a.SAPVB.Windows)||(this.m_curWindows=s?s:this.m_curWindows);else this.m_bWindowsDirty=false;s=null;(t=a)&&(t=t.SAPVB)&&(t=t.Scenes)&&(s=JSON.stringify(t))&&(s==this.m_curScenes)&&(delete a.SAPVB.Scenes)||(this.m_curScenes=s?s:this.m_curScenes);s=null;(t=a)&&(t=t.SAPVB)&&(t=t.Actions)&&(s=JSON.stringify(t))&&(s==this.m_curActions)&&(delete a.SAPVB.Actions)||(this.m_curActions=s?s:this.m_curActions);s=null;(t=a)&&(t=t.SAPVB)&&(t=t.DataTypes)&&(s=JSON.stringify(t))&&(s==this.m_curDataTypes)&&(delete a.SAPVB.DataTypes)||(this.m_curDataTypes=s?s:this.m_curDataTypes);s=null;(t=a)&&(t=t.SAPVB)&&(t=t.Data)&&(s=JSON.stringify(t))&&(s==this.m_curData)&&(delete a.SAPVB.Data)||(this.m_curData=s?s:this.m_curData);return a;};sap.ui.vbm.GeoMap.prototype.GetAggregatorContainer=function(i){var v=this.getVos();if(!v||!v.length)return;for(var n=0,l=v.length;n<l;++n){if(v[n].sId==i)return v[n];}return null;};sap.ui.vbm.GeoMap.prototype.Update=function(){var a=this.UpdateGeoMapData();return this.MinimizeApp(a);};sap.ui.vbm.GeoMap.prototype.UpdateGeoMapData=function(){var p=sap.ui.vbm.GeoMap.ApplicationURL?sap.ui.vbm.GeoMap.ApplicationURL:sap.ui.resource("sap.ui.vbm",sap.ui.vbm.GeoMap.DefaultApplicationURL);var j=jQuery.sap.syncGetJSON(p);var a=j.data;if(this.m_bResourcesDirty)this.UpdateResourceData(a);this.UpdateVOData(a);if(this.m_bMapConfigurationDirty)this.UpdateMapConfiguration(a);this.UpdateMapProviders(a);this.UpdateMapLayerStacks(a);this.UpdateWindows(a);if(a.SAPVB.Actions)this.getActionArray(null,a.SAPVB.Actions.Set.Action);return a;};sap.ui.vbm.GeoMap.prototype.UpdateMapProviders=function(a){if(!this.m_bMapProvidersDirty)delete a.SAPVB.MapProviders;this.m_bMapProvidersDirty=false;};sap.ui.vbm.GeoMap.prototype.UpdateMapLayerStacks=function(a){if(!this.m_bMapLayerStacksDirty)delete a.SAPVB.MapLayerStacks;this.m_bMapLayerStacksDirty=false;};sap.ui.vbm.GeoMap.prototype.UpdateWindows=function(a){a.SAPVB.Windows=this.getWindowsObject();};sap.ui.vbm.GeoMap.prototype.UpdateMapConfiguration=function(a){if(!this.m_bMapConfigurationDirty)return;this.m_bMapConfigurationDirty=false;var c=this.getMapConfiguration();if(c){a.SAPVB.MapProviders={Set:{MapProvider:c.MapProvider}};a.SAPVB.MapLayerStacks={Set:{MapLayerStack:c.MapLayerStacks}};}return;};sap.ui.vbm.GeoMap.prototype.UpdateResourceData=function(a){if(!this.m_bResourcesDirty)return;this.m_bResourcesDirty=false;var r=this.getResources();((a.SAPVB.Resources={}).Set={}).Resource=[];function R(){var a=this.Update();this.load(a);};for(var n=0,l=r.length;n<l;++n){var b=r[n];if(!b.mProperties.value&&b.mProperties.src){var c=document.createElement('myCanvas');var i=document.createElement('img');b.m_Img=i;var f=function(b){var c=document.createElement('canvas');c.width=b.m_Img.width;c.height=b.m_Img.height;var d=c.getContext('2d');d.drawImage(b.m_Img,0,0);b.mProperties.value=c.toDataURL();delete b.m_Img;this.m_bResourcesDirty=true;window.setTimeout(R.bind(this),10);};i.onload=f.bind(this,b);i.src=b.mProperties.src;}else a.SAPVB.Resources.Set.Resource.push({"name":(b.mProperties.name?b.mProperties.name:b.sId),"value":b.mProperties.value});}return;};sap.ui.vbm.GeoMap.prototype.UpdateVOData=function(a){this.m_bVosDirty=false;var v=this.getVos();var s=[];var b=[];var c=[];var d=[];for(var n=0,l=v.length;n<l;++n){var C=v[n];s.push(this.getTemplateObject(C));b.push(this.getDataObject(C));c.push(this.getTypeObject(C));d=this.getActionArray(C,d);}var L=this.getLegend();if(L){b.push(this.getDataObject(L,true));c.push(this.getTypeObject(L,true));}var m=(!this.m_saVO||!(JSON.stringify(this.m_saVO)===JSON.stringify(s)))?true:false;this.m_saVO=s;((a.SAPVB.Data={}).Set={}).N=b;m&&(((a.SAPVB.DataTypes={}).Set={}).N=c);m&&(((a.SAPVB.Actions={}).Set={}).Action=d);m&&((((a.SAPVB.Scenes={}).Set={}).SceneGeo={"id":"MainScene","refMapLayerStack":"Default","initialZoom":"2",}).VO=s);};sap.ui.vbm.GeoMap.prototype.invalidate=function(s){if(s instanceof sap.ui.vbm.Areas||s instanceof sap.ui.vbm.Boxes||s instanceof sap.ui.vbm.Circles||s instanceof sap.ui.vbm.Containers||s instanceof sap.ui.vbm.GeoCircles||s instanceof sap.ui.vbm.Pies||s instanceof sap.ui.vbm.Routes||s instanceof sap.ui.vbm.Spots){this.m_bLegendDirty=true;this.m_bVosDirty=true;}if(s instanceof sap.ui.vbm.Legend){this.m_bLegendDirty=true;this.m_bVosDirty=true;}sap.ui.core.Control.prototype.invalidate.apply(this,arguments);};sap.ui.vbm.GeoMap.prototype.openContextMenu=function(t,i,m){if(m&&m.vbi_data&&m.vbi_data.VBIName=="DynContextMenu"){if(!this.m_VBIContext.m_Menus)this.m_VBIContext.m_Menus=new window.VBI.Menus();this.m_VBIContext.m_Menus.m_menus.push(m);var a={"SAPVB":{"version":"2.0","Automation":{"Call":{"earliest":"0","handler":"CONTEXTMENUHANDLER","instance":i.sId,"name":"SHOW","object":t,"refID":"CTM","Param":[{"name":"x","#":i.mClickPos[0]},{"name":"y","#":i.mClickPos[1]},{"name":"scene","#":"MainScene"}]}}}};this.loadHtml(a);}};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Pie')){jQuery.sap.declare("sap.ui.vbm.Pie");sap.ui.vbm.VoBase.extend("sap.ui.vbm.Pie",{metadata:{publicMethods:["openDetailWindow","openContextMenu"],library:"sap.ui.vbm",properties:{"position":{type:"string",group:"Misc",defaultValue:null},"scale":{type:"string",group:"Misc",defaultValue:null}},defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.PieItem",multiple:true,singularName:"item"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Pie.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Pie.prototype.openDetailWindow=function(c,o,a){this.oParent.openDetailWindow(this,{caption:c,offsetX:o,offsetY:a});};sap.ui.vbm.Pie.prototype.openContextMenu=function(m){this.oParent.openContextMenu(this,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Pies')){jQuery.sap.declare("sap.ui.vbm.Pies");sap.ui.vbm.VoAggregation.extend("sap.ui.vbm.Pies",{metadata:{library:"sap.ui.vbm",defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.Pie",multiple:true,singularName:"item"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Pies.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Pies.prototype.getTemplateObject=function(){var i=this.getId();return{"type":"{00100000-2012-0004-B001-383477EA1DEB}","pos.bind":i+".P","tooltip.bind":i+".TT","scale.bind":i+".S","series.bind":i+".Series","text.bind":i+".Series.T","value.bind":i+".Series.V"};};sap.ui.vbm.Pies.prototype.getDataObject=function(){var v=this.getItems();var s=[];for(var n=0,l=v.length;n<l;++n){var i=v[n];var S=[];var p=i.getItems();for(var a=0,b=p.length;a<b;++a){var I=p[a];var e={"T":I.getName(),"V":I.getValue()};S.push(e);}var E={"P":i.getPosition(),"TT":i.getTooltip(),"S":i.getScale(),"N":{"name":"Series","E":S}};s.push(E);}return{"name":this.getId(),"E":s};};sap.ui.vbm.Pies.prototype.getTypeObject=function(){return{"A":[{"changeable":"true","name":"P","alias":"P","type":"vector"},{"name":"TT","alias":"TT","type":"string"},{"changeable":"true","name":"S","alias":"S","type":"string"}],"N":{"name":"Series","A":[{"name":"V","alias":"V","type":"float"},{"name":"T","alias":"T","type":"string"}]}};};sap.ui.vbm.Pies.prototype.HandleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var P;if(P=this.FindInstance(e.Action.instance)){if(P.mEventRegistry[s]){if(s=="contextMenu"){P.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];jQuery.sap.require("sap.ui.unified.Menu");if(this.oParent.m_VBIContext.m_Menus)this.oParent.m_VBIContext.m_Menus.deleteMenu("DynContextMenu");var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";P.fireContextMenu({data:e,menu:m});}else P[f]({data:e});}}this[f]({data:e});};sap.ui.vbm.Pies.prototype.openDetailWindow=function(i,p){this.oParent.m_bUseClickPos=false;this.oParent.m_DTOpen=true;this.oParent.m_DTSrc=i;this.oParent.m_DTParams=p;this.oParent.m_bWindowsDirty=true;this.oParent.invalidate(this);};sap.ui.vbm.Pies.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["click"]||this.IsEventRegistered("click"))a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"]||this.IsEventRegistered("contextMenu"))a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});if(this.mEventRegistry["drop"]||this.IsEventRegistered("drop"))a.push({"id":i+"3","name":"drop","refScene":"MainScene","refVO":i,"refEvent":"Drop"});a=sap.ui.vbm.VoAggregation.prototype.getActionArray.apply(this,arguments);return a;};sap.ui.vbm.Pies.prototype.openContextMenu=function(i,m){this.oParent.openContextMenu("Pie",i,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Route')){jQuery.sap.declare("sap.ui.vbm.Route");sap.ui.vbm.VoBase.extend("sap.ui.vbm.Route",{metadata:{publicMethods:["openDetailWindow","openContextMenu"],library:"sap.ui.vbm",properties:{"position":{type:"string",group:"Misc",defaultValue:null},"color":{type:"string",group:"Misc",defaultValue:'RGB(0;0;0)'},"start":{type:"string",group:"Misc",defaultValue:'0'},"end":{type:"string",group:"Misc",defaultValue:'0'},"linewidth":{type:"string",group:"Misc",defaultValue:'5'},"dotcolor":{type:"string",group:"Misc",defaultValue:'RGB(0;0;0)'},"dotbordercolor":{type:"string",group:"Misc",defaultValue:'RGB(0;0;0)'},"dotwidth":{type:"string",group:"Misc",defaultValue:'0'}},aggregations:{"dragSource":{type:"sap.ui.vbm.DragSource",multiple:true,singularName:"dragSource"},"dropTarget":{type:"sap.ui.vbm.DropTarget",multiple:true,singularName:"dropTarget"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Route.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Route.prototype.openDetailWindow=function(c,o,a){this.oParent.openDetailWindow(this,{caption:c,offsetX:o,offsetY:a});};sap.ui.vbm.Route.prototype.openContextMenu=function(m){this.oParent.openContextMenu(this,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Routes')){jQuery.sap.declare("sap.ui.vbm.Routes");sap.ui.vbm.VoAggregation.extend("sap.ui.vbm.Routes",{metadata:{library:"sap.ui.vbm",defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.Route",multiple:true,singularName:"item"},"dragSource":{type:"sap.ui.vbm.DragSource",multiple:true,singularName:"dragSource"},"dropTarget":{type:"sap.ui.vbm.DropTarget",multiple:true,singularName:"dropTarget"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Routes.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Routes.prototype.getTemplateObject=function(){var i=this.getId();var d=this.getDragSource();var D=[];for(var n=0,l=d.length;n<l;++n){var o=d[n];var e={"type":o.getType()};D.push(e);}D.push({"datasource":i+".DS","type.bind":i+".DS.DGT",});var a=this.getDropTarget();var s=[];for(var n=0,l=a.length;n<l;++n){var b=a[n];var e={"type":b.getType()};s.push(e);}s.push({"datasource":i+".DT","type.bind":i+".DT.DPT"});return{"type":"{00100000-2012-0004-B001-C46BD7336A1A}","posarray.bind":i+".P","color.bind":i+".C","start.bind":i+".ST","end.bind":i+".ED","linewidth.bind":i+".LW","dotcolor.bind":i+".DC","dotbordercolor.bind":i+".DBC","dotwidth.bind":i+".DW","dragdata.bind":i+".DD","DragSource":{"DragItem":D},"DropTarget":{"DropItem":s}};};sap.ui.vbm.Routes.prototype.getDataObject=function(){var v=this.getItems();var s=[];var d=[];var e,D,o;for(var n=0,l=v.length;n<l;++n){var i=v[n];d=[];var a=[];var b=0;var c=i.getDragSource();for(var f=0,g=c.length;f<g;++f){var I=c[f];var E={"VB:ix":b++,"A":I.getType()};a.push(E);}if(a.length>0){D={"name":"DS","E":a};d.push(D);}var h=[];var j=0;var k=i.getDropTarget();for(var f=0,m=k.length;f<m;++f){var p=k[f];var q={"VB:ix":j++,"A":p.getType()};h.push(q);}if(h.length>0){o={"name":"DT","E":h};d.push(o);}e={"P":i.getPosition(),"C":i.getColor(),"ST":i.getStart(),"ED":i.getEnd(),"LW":i.getLinewidth(),"DC":i.getDotcolor(),"DBC":i.getDotbordercolor(),"DW":i.getDotwidth(),"DD":i.getDragData(),"N":d};s.push(e);}return{"name":this.getId(),"E":s};};sap.ui.vbm.Routes.prototype.getTypeObject=function(){return{"A":[{"changeable":"true","name":"P","alias":"P","type":"vector"},{"name":"C","alias":"C","type":"color"},{"name":"ST","alias":"ST","type":"long"},{"name":"ED","alias":"ED","type":"long"},{"name":"LW","alias":"LW","type":"float"},{"name":"DC","alias":"DC","type":"color"},{"name":"DBC","alias":"DBC","type":"color"},{"name":"DW","alias":"DW","type":"float"},{"name":"DD","alias":"DD","type":"string"}],"N":[{"name":"DS","A":{"name":"DGT","alias":"A","type":"string"}},{"name":"DT","A":{"name":"DPT","alias":"A","type":"string"}}]};};sap.ui.vbm.Routes.prototype.HandleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var r;if(r=this.FindInstance(e.Action.instance)){if(r.mEventRegistry[s]){if(s=="contextMenu"){r.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];jQuery.sap.require("sap.ui.unified.Menu");if(this.oParent.m_VBIContext.m_Menus)this.oParent.m_VBIContext.m_Menus.deleteMenu("DynContextMenu");var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";r.fireContextMenu({data:e,menu:m});}else r[f]({data:e});}}this[f]({data:e});};sap.ui.vbm.Routes.prototype.openContextMenu=function(i,m){this.oParent.openContextMenu("Route",i,m);};sap.ui.vbm.Routes.prototype.openDetailWindow=function(i,p){this.oParent.m_bUseClickPos=false;this.oParent.m_DTOpen=true;this.oParent.m_DTSrc=i;this.oParent.m_DTParams=p;this.oParent.m_bWindowsDirty=true;this.oParent.invalidate(this);};sap.ui.vbm.Routes.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["click"]||this.IsEventRegistered("click"))a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"]||this.IsEventRegistered("contextMenu"))a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});if(this.mEventRegistry["drop"]||this.IsEventRegistered("drop"))a.push({"id":i+"3","name":"drop","refScene":"MainScene","refVO":i,"refEvent":"Drop"});a=sap.ui.vbm.VoAggregation.prototype.getActionArray.apply(this,arguments);return a;};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Spot')){jQuery.sap.declare("sap.ui.vbm.Spot");sap.ui.vbm.VoBase.extend("sap.ui.vbm.Spot",{metadata:{publicMethods:["openDetailWindow","openContextMenu"],library:"sap.ui.vbm",properties:{"position":{type:"string",group:"Misc",defaultValue:'0;0;0'},"text":{type:"string",group:"Misc",defaultValue:null},"image":{type:"string",group:"Misc",defaultValue:null},"alignment":{type:"string",group:"Misc",defaultValue:'5'},"scale":{type:"string",group:"Misc",defaultValue:'1;1;1'}},aggregations:{"dragSource":{type:"sap.ui.vbm.DragSource",multiple:true,singularName:"dragSource"},"dropTarget":{type:"sap.ui.vbm.DropTarget",multiple:true,singularName:"dropTarget"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Spot.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Spot.prototype.openDetailWindow=function(c,o,a){this.oParent.openDetailWindow(this,{caption:c,offsetX:o,offsetY:a});};sap.ui.vbm.Spot.prototype.openContextMenu=function(m){this.oParent.openContextMenu(this,m);};};if(!jQuery.sap.isDeclared('sap.ui.vbm.Spots')){jQuery.sap.declare("sap.ui.vbm.Spots");sap.ui.vbm.VoAggregation.extend("sap.ui.vbm.Spots",{metadata:{library:"sap.ui.vbm",defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.vbm.Spot",multiple:true,singularName:"item"},"dragSource":{type:"sap.ui.vbm.DragSource",multiple:true,singularName:"dragSource"},"dropTarget":{type:"sap.ui.vbm.DropTarget",multiple:true,singularName:"dropTarget"}},events:{"click":{},"contextMenu":{},"drop":{}}}});sap.ui.vbm.Spots.M_EVENTS={'click':'click','contextMenu':'contextMenu','drop':'drop'};sap.ui.vbm.Spots.prototype.getTemplateObject=function(){var i=this.getId();var d=this.getDragSource();var D=[];for(var n=0,l=d.length;n<l;++n){var o=d[n];var e={"type":o.getType()};D.push(e);}D.push({"datasource":i+".DS","type.bind":i+".DS.DGT",});var a=this.getDropTarget();var s=[];for(var n=0,l=a.length;n<l;++n){var b=a[n];var e={"type":b.getType()};s.push(e);}s.push({"datasource":i+".DT","type.bind":i+".DT.DPT"});return{"type":"{00100000-2012-0004-B001-64592B8DB964}","scale.bind":i+".S","image.bind":i+".I","pos.bind":i+".P","text.bind":i+".T","alignment.bind":i+".AL","dragdata.bind":i+".DD","DragSource":{"DragItem":D},"DropTarget":{"DropItem":s}};};sap.ui.vbm.Spots.prototype.getDataObject=function(){var v=this.getItems();var s=[];var d=[];var e,D,o;for(var n=0,l=v.length;n<l;++n){var i=v[n];d=[];var a=[];var b=0;var c=i.getDragSource();for(var f=0,g=c.length;f<g;++f){var I=c[f];var E={"VB:ix":b++,"A":I.getType()};a.push(E);}if(a.length>0){D={"name":"DS","E":a};d.push(D);}var h=[];var j=0;var k=i.getDropTarget();for(var f=0,m=k.length;f<m;++f){var p=k[f];var q={"VB:ix":j++,"A":p.getType()};h.push(q);}if(h.length>0){o={"name":"DT","E":h};d.push(o);}e={"P":i.getPosition(),"S":i.getScale(),"T":i.getText(),"I":i.getImage(),"AL":i.getAlignment(),"DD":i.getDragData(),"N":d};s.push(e);}return{"name":this.getId(),"E":s};};sap.ui.vbm.Spots.prototype.getTypeObject=function(){return{"A":[{"changeable":"true","name":"P","alias":"P","type":"vector"},{"changeable":"true","name":"S","alias":"S","type":"vector"},{"name":"T","alias":"T","type":"string"},{"name":"I","alias":"I","type":"string"},{"name":"AL","alias":"AL","type":"string"},{"name":"DD","alias":"DD","type":"string"}],"N":[{"name":"DS","A":{"name":"DGT","alias":"A","type":"string"}},{"name":"DT","A":{"name":"DPT","alias":"A","type":"string"}}]};};sap.ui.vbm.Spots.prototype.HandleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var a;if(a=this.FindInstance(e.Action.instance)){if(a.mEventRegistry[s]){if(s=="contextMenu"){a.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];jQuery.sap.require("sap.ui.unified.Menu");if(this.oParent.m_VBIContext.m_Menus)this.oParent.m_VBIContext.m_Menus.deleteMenu("DynContextMenu");var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";a.fireContextMenu({data:e,menu:m});}else a[f]({data:e});}}this[f]({data:e});};sap.ui.vbm.Spots.prototype.openDetailWindow=function(i,p){this.oParent.m_bUseClickPos=false;this.oParent.m_DTOpen=true;this.oParent.m_DTSrc=i;this.oParent.m_DTParams=p;this.oParent.m_bWindowsDirty=true;this.oParent.invalidate(this);};sap.ui.vbm.Spots.prototype.openContextMenu=function(i,m){this.oParent.openContextMenu("Spot",i,m);};sap.ui.vbm.Spots.prototype.getActionArray=function(a){var i=this.getId();if(this.mEventRegistry["click"]||this.IsEventRegistered("click"))a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});if(this.mEventRegistry["contextMenu"]||this.IsEventRegistered("contextMenu"))a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});if(this.mEventRegistry["drop"]||this.IsEventRegistered("drop"))a.push({"id":i+"3","name":"drop","refScene":"MainScene","refVO":i,"refEvent":"Drop"});a=sap.ui.vbm.VoAggregation.prototype.getActionArray.apply(this,arguments);return a;};};if(!jQuery.sap.isDeclared('sap.ui.vbm.AnalyticMap')){jQuery.sap.declare("sap.ui.vbm.AnalyticMap");sap.ui.vbm.GeoMap.extend("sap.ui.vbm.AnalyticMap",{metadata:{publicMethods:["zoomToRegions","getRegionsInfo"],library:"sap.ui.vbm",properties:{"legendVisible":{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{"regions":{type:"sap.ui.vbm.Region",multiple:true,singularName:"region"}},events:{"regionClick":{},"regionContextMenu":{}}}});sap.ui.vbm.AnalyticMap.M_EVENTS={'regionClick':'regionClick','regionContextMenu':'regionContextMenu'};sap.ui.vbm.AnalyticMap.DefaultABAPGeoJSONURL="/sap/bc/vbi/geojson/L0.json";sap.ui.vbm.AnalyticMap.DefaultGeoJSONURL="media/analyticmap/L0.json";sap.ui.vbm.AnalyticMap.DefaultRegionColor="RGB(213,218,221)";sap.ui.vbm.AnalyticMap.DefaultRegionColorBorder="RGB(255,255,255)";jQuery.sap.require('sap.ui.core.theming.Parameters');sap.ui.vbm.AnalyticMap.prototype.exit=function(){sap.ui.vbm.GeoMap.prototype.exit.apply(this,arguments);this.detachEvent('submit',sap.ui.vbm.AnalyticMap.prototype.onAnalyticsSubmit,this);};sap.ui.vbm.AnalyticMap.prototype.resize=function(e){sap.ui.vbm.GeoMap.prototype.resize.apply(this,arguments);};sap.ui.vbm.AnalyticMap.prototype.onAfterRendering=function(){sap.ui.vbm.VBI.prototype.onAfterRendering.apply(this,arguments);};sap.ui.vbm.AnalyticMap.prototype.destroyRegions=function(){this.m_bRegionsDirty=true;this.destroyAggregation("regions");};sap.ui.vbm.AnalyticMap.prototype.addRegion=function(o){this.m_bRegionsDirty=true;this.addAggregation("regions",o);};sap.ui.vbm.AnalyticMap.prototype.removeRegion=function(o){this.m_bRegionsDirty=true;this.removeAggregation("regions");};sap.ui.vbm.AnalyticMap.prototype.removeAllRegions=function(o){this.m_bRegionsDirty=true;this.removeAllAggregation("regions");};sap.ui.vbm.AnalyticMap.prototype.destroyLegend=function(){this.m_bLegendDirty=true;this.destroyAggregation("legend");};sap.ui.vbm.AnalyticMap.prototype.setLegend=function(o){this.m_bLegendDirty=true;this.setAggregation("legend",o);};sap.ui.vbm.AnalyticMap.prototype.onAnalyticsSubmit=function(e){var d=JSON.parse(e.mParameters.data);var p,o,c,l="Regions".length;switch(d.Action.name){case"RGN_CONTEXTMENU":c=d.Action.instance.slice(l+1,l+3);p={code:c};if(o=this.FindRegionInAggregation(c))o.fireContextMenu(p);this.fireRegionContextMenu(p);break;case"RGN_CLICK":c=d.Action.instance.slice(l+1,l+3);p={code:c};if(o=this.FindRegionInAggregation(c))o.fireClick(p);this.fireRegionClick(p);break;};};sap.ui.vbm.AnalyticMap.prototype.init=function(){sap.ui.vbm.GeoMap.prototype.init.apply(this,arguments);this.m_bRegionsDirty=false;this.m_bLegendDirty=false;this.m_bThemingDirty=true;this.attachEvent('submit',sap.ui.vbm.AnalyticMap.prototype.onAnalyticsSubmit,this);var a=this.CreateRegions();};sap.ui.vbm.AnalyticMap.prototype.CreateRegions=function(){var c=this.m_ColC=sap.ui.vbm.AnalyticMap.DefaultRegionColor;var a=this.m_ColCB=sap.ui.vbm.AnalyticMap.DefaultRegionColorBorder;this.m_oSetRegions={"SAPVB":{"Data":{"Set":[{"type":"N","name":"Regions","N":{"name":"Regions","E":[]}}]}}};function R(w,z,A,B,C,D,F){this.K=w;this.P="";this.T=D;this.C=B;this.CB=C;this.G=F;for(var n=0,G=z.length;n<G;++n){if(n)this.P+=";";this.P+=z[n];}};delete R.prototype.constructor;var d=null,p=null;p=sap.ui.vbm.AnalyticMap.GeoJSONURL;if(!d&&p)d=jQuery.sap.syncGetJSON(p).data;p=sap.ui.vbm.AnalyticMap.DefaultABAPGeoJSONURL;if(!d&&sap.ui.vbm.AnalyticMap.DefaultABAPGeoJSONURL){var u=URI(p);u.addQuery("sap-language",sap.ui.getCore().getConfiguration().getLanguage());d=jQuery.sap.syncGetJSON(p=u.toString()).data;}p=sap.ui.resource("sap.ui.vbm",sap.ui.vbm.AnalyticMap.DefaultGeoJSONURL);if(!d&&p)d=jQuery.sap.syncGetJSON(p).data;if(!d){alert("The path or the GeoJSON file at location "+p+" or "+sap.ui.vbm.AnalyticMap.DefaultABAPGeoJSONURL+" is invalid.\r\nPlease contact your Administrator.");return;}var E=this.m_oSetRegions.SAPVB.Data.Set[0].N.E=[];this.m_RegionApplicationTable=E;this.m_RegionBox=[];this.m_Names=[];this.m_Properties=[];var m,b,e,g;var v,h,i=d.features,t='';for(var n=0,j=i.length;n<j;++n){v=[];var f=i[n];if(f.id2=="AQ")continue;t=(f.properties&&f.properties.name)?f.properties.name:"";this.m_Names[f.id2]=t;this.m_Properties[f.id2]=f.properties;switch(f.geometry.type){case"Polygon":e=Number.MAX_VALUE;g=-Number.MAX_VALUE;m=Number.MAX_VALUE;b=-Number.MAX_VALUE;var k=f.geometry.coordinates[0];for(var l=0,o=k.length,q,x,y;l<o;++l){q=k[l];if((x=q[0])<m)m=x;if(x>b)b=x;if((y=q[1])<e)e=y;if(y>g)g=y;v.push(x,y,"0");}E.push(new R(f.id2,v,f.geometry.type,c,a,t,f.id2));this.m_RegionBox[f.id2]=[m,b,e,g];break;case"MultiPolygon":h=[];for(var r=0,s=f.geometry.coordinates.length,q;r<s;++r){e=Number.MAX_VALUE;g=-Number.MAX_VALUE;m=Number.MAX_VALUE;b=-Number.MAX_VALUE;var k=f.geometry.coordinates[r][0];v=[];for(var l=0,o=k.length,x,y;l<o;++l){q=k[l];q=k[l];if((x=q[0])<m)m=x;if(x>b)b=x;if((y=q[1])<e)e=y;if(y>g)g=y;v.push(x,y,"0");}h.push([m,b,e,g]);E.push(new R(f.id2+"_"+r,v,f.geometry.type,c,a,t,f.id2));}this.m_RegionBox[f.id2]=window.VBI.MathLib.GetSurroundingBox(h);break;case"Point":break;default:break;}}return this.m_oSetRegions;};sap.ui.vbm.AnalyticMap.prototype.getAnalyticTemplateObject=function(){return{"id":"Region","type":"{00100000-2012-0004-B001-F311DE491C77}","entity.bind":"Regions.Entity","datasource":"Regions","posarray.bind":"Regions.PosList","color.bind":"Regions.Color","colorBorder.bind":"Regions.BorderColor","tooltip.bind":"Regions.ToolTip","hotDeltaColor":"RGBA(240,171,0,128)"};};sap.ui.vbm.AnalyticMap.prototype.getAnalyticTypeObject=function(){return{"name":"Regions","key":"Key","A":[{"name":"Key","alias":"K","type":"string"},{"name":"PosList","alias":"P","type":"vectorarray"},{"name":"ToolTip","alias":"T","type":"string"},{"name":"Color","alias":"C","type":"color"},{"name":"BorderColor","alias":"CB","type":"color"},{"name":"Entity","alias":"G","type":"string"}]};};sap.ui.vbm.AnalyticMap.prototype.getAnalyticDataObject=function(){var a=[];jQuery.extend(true,a,this.m_RegionApplicationTable);if(!a)return;var p=[];var C=this.getRegions();for(var n=0,l=C?C.length:0,i;n<l;++n){i=C[n];p[i.mProperties.code]=i;}var L=false;for(var n=0,l=a.length,b,i,t;n<l;++n){i=a[n];if(L)if(i.P)delete i.P;if(b=p[i.K.slice(0,2)]){if(t=b.mProperties.color){var c;if(c=/^rgba\(([\d]+)[,;]([\d]+)[,;]([\d]+)[,;]([\d]+|[\d]*.[\d]+)\)/.exec(t))i.C="RGBA("+c[1]+","+c[2]+","+c[3]+","+parseInt(c[4]*255)+")";}if(t=b.getTooltip())i.T=t;}}return{"name":"Regions","type":"N","E":a};};sap.ui.vbm.AnalyticMap.prototype.getAnalyticActionArray=function(a){var i=this.getId();a.push({"id":i+"1","name":"RGN_CLICK","refScene":"MainScene","refVO":"Region","refEvent":"Click"});a.push({"id":i+"2","name":"RGN_CONTEXTMENU","refScene":"MainScene","refVO":"Region","refEvent":"ContextMenu"});return a;};sap.ui.vbm.AnalyticMap.prototype.FindRegionInAggregation=function(c){var C=this.getRegions();if(C){for(var n=0,l=C.length;n<l;++n)if(C[n].mProperties.code==c)return C[n];}return null;};sap.ui.vbm.AnalyticMap.prototype.Update=function(){var a=this.UpdateAnalyticMap();return this.MinimizeApp(a);};sap.ui.vbm.AnalyticMap.prototype.UpdateAnalyticMap=function(){var g=sap.ui.vbm.GeoMap.prototype.UpdateGeoMapData.apply(this,arguments);if(this.m_bThemingDirty)this.applyTheming(this.m_RegionApplicationTable);var o=this.getAnalyticTemplateObject();var a=this.getAnalyticTypeObject();var d=this.getAnalyticDataObject();var t;(t=g)&&(t=t.SAPVB)&&(t=t.Scenes)&&(t=t.Set)&&(t=t.SceneGeo)&&(t=t.VO)&&t.splice(0,0,o);(t=g)&&(t=t.SAPVB)&&(t=t.DataTypes)&&(t=t.Set)&&(t=t.N)&&t.splice(0,0,a);(t=g)&&(t=t.SAPVB)&&(t=t.Actions)&&(t=t.Set)&&(t=t.Action)&&this.getAnalyticActionArray(t);if(d)(t=g)&&(t=t.SAPVB)&&(t=t.Data||(t.Data={}))&&(t=t.Set||(t.Set={}))&&(t=t.N||(t.N=[]))&&t.splice(0,0,d);if(!this.getMapConfiguration())(t=g)&&(t=t.SAPVB)&&(t=t.Scenes)&&(t=t.Set)&&(t=t.SceneGeo)&&(t.refMapLayerStack)&&(t.refMapLayerStack="");return g;};sap.ui.vbm.AnalyticMap.prototype.invalidate=function(s){if(s instanceof sap.ui.vbm.Region)this.m_bRegionsDirty=true;sap.ui.vbm.GeoMap.prototype.invalidate.apply(this,arguments);};sap.ui.vbm.AnalyticMap.prototype.zoomToRegions=function(c,a){if(a==undefined)a=0.9999;var b=[];for(var n=0,l=c.length;n<l;++n){var r=this.m_RegionBox[c[n]];if(r!=undefined)b.push(r);}if(!b.length)return;var s=null;if(s=this.m_VBIContext.GetMainScene())s.ZoomToAreas(b,a);};sap.ui.vbm.AnalyticMap.prototype.getRegionsInfo=function(c){var r=[];var a,B;for(var n=0,l=c.length;n<l;++n){a=c[n];r[a]={};r[a].BBox=this.m_RegionBox[a];r[a].Midpoint=[(this.m_RegionBox[a][0]+this.m_RegionBox[a][1])/2,(this.m_RegionBox[a][2]+this.m_RegionBox[a][3])/2];r[a].Name=this.m_Names[a];r[a].Properties=this.m_Properties[a];}return r;};sap.ui.vbm.AnalyticMap.prototype.onThemeChanged=function(e){this.m_bThemingDirty=true;this.invalidate();};sap.ui.vbm.AnalyticMap.prototype.applyTheming=function(r){if(sap.ui.core.theming&&sap.ui.core.theming.Parameters){var c=sap.ui.vbm.AnalyticMap.DefaultRegionColor=sap.ui.core.theming.Parameters.get("sapUiChartPaletteSequentialNeutralLight3");var C=sap.ui.vbm.AnalyticMap.DefaultRegionColorBorder=sap.ui.core.theming.Parameters.get("sapUiChartBackgroundColor");if(this.getPlugin()){var a=window.VBI.Types.string2rgba(c);c=a[4]===1?"RGBA("+a[0]+";"+a[1]+";"+a[2]+";"+parseInt(a[3]*255)+")":"RGB("+a[0]+";"+a[1]+";"+a[2]+")";a=window.VBI.Types.string2rgba(C);C=a[4]===1?"RGBA("+a[0]+";"+a[1]+";"+a[2]+";"+parseInt(a[3]*255)+")":"RGB("+a[0]+";"+a[1]+";"+a[2]+")";}if(c!=this.m_ColC||C!=this.m_ColCB){for(var i=0;i<r.length;++i){if(r[i].C===this.m_ColC)r[i].C=c;if(r[i].CB===this.m_ColCB)r[i].CB=C;}this.m_ColC=c;this.m_ColCB=C;}this.m_bThemingDirty=false;}};};
